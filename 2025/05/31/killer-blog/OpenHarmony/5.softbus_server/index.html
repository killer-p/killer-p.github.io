<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="softbus_server程序我们已经知道如何使用软总线提供的接口了，接下来可以了解软总线服务是如何实现的。软总线服务对应的系统进程就是softbus_server，这个程序入口位于foundation\communication\dsoftbus\core\frame\small\init\src\softbus_server_main.c  这个程序负责软总线功能的具体实现，所以会比较复杂。">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2025/05/31/killer-blog/OpenHarmony/5.softbus_server/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="softbus_server程序我们已经知道如何使用软总线提供的接口了，接下来可以了解软总线服务是如何实现的。软总线服务对应的系统进程就是softbus_server，这个程序入口位于foundation\communication\dsoftbus\core\frame\small\init\src\softbus_server_main.c  这个程序负责软总线功能的具体实现，所以会比较复杂。">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-05-31T02:36:45.815Z">
<meta property="article:modified_time" content="2025-06-01T00:19:46.481Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-killer-blog/OpenHarmony/5.softbus_server" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/05/31/killer-blog/OpenHarmony/5.softbus_server/" class="article-date">
  <time class="dt-published" datetime="2025-05-31T02:36:45.815Z" itemprop="datePublished">2025-05-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="softbus-server程序"><a href="#softbus-server程序" class="headerlink" title="softbus_server程序"></a>softbus_server程序</h2><p>我们已经知道如何使用软总线提供的接口了，接下来可以了解软总线服务是如何实现的。软总线服务对应的系统进程就是softbus_server，这个程序入口位于foundation\communication\dsoftbus\core\frame\small\init\src\softbus_server_main.c </p>
<p>这个程序负责软总线功能的具体实现，所以会比较复杂。</p>
<h3 id="初始化软总线服务器"><a href="#初始化软总线服务器" class="headerlink" title="初始化软总线服务器"></a>初始化软总线服务器</h3><p>分析一下这个程序会执行什么，很明显这个程序会初始化软总线服务器。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    InitSoftBusServer();</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        pause();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>InitSoftBusServer()会依次初始化以下：</p>
<ol>
<li>启动bootstrap：会调用 softbus_server_stub.c 的 Init()函数注册softbus服务</li>
<li>创建default-looper：looper的作用见下文</li>
<li>连接server</li>
<li>传输server</li>
<li>设备认证server</li>
<li>发现server</li>
<li>软总线server</li>
</ol>
<p>初始化完成后，该进程具备什么样的功能？应用要具备软总线的所有的功能。下面是函数调用流程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line">SoftbusConfigInit()    <span class="comment">//设置g_configItems</span></span><br><span class="line">ServerStubInit()-&gt;       <span class="comment">//注册软总线服务到samgr</span></span><br><span class="line">SoftBusTimerInit()    <span class="comment">//使用定时器执行g_timerFunList</span></span><br><span class="line">LooperInit()    <span class="comment">//创建 Loop-default</span></span><br><span class="line">ConnServerInit()-&gt;    <span class="comment">// 初始化 ConnectFuncInterface 以及回调函数</span></span><br><span class="line">        g_connManagerCb.OnConnected = ConnManagerConnected;</span><br><span class="line">    	g_connManagerCb.OnDisconnected = ConnManagerDisconnected;</span><br><span class="line">    	g_connManagerCb.OnDataReceived = ConnManagerRecvData;</span><br><span class="line">        ConnInitTcp(&amp;g_connManagerCb)-&gt;  </span><br><span class="line">             g_tcpInterface.ConnectDevice = TcpConnectDevice;</span><br><span class="line">    	    g_tcpInterface.DisconnectDevice = TcpDisconnectDevice;</span><br><span class="line">    		g_tcpInterface.DisconnectDeviceNow = TcpDisconnectDeviceNow;</span><br><span class="line">    		g_tcpInterface.PostBytes = TcpPostBytes;</span><br><span class="line">    		g_tcpInterface.GetConnectionInfo = TcpGetConnectionInfo;</span><br><span class="line">    		g_tcpInterface.StartLocalListening = TcpStartListening;</span><br><span class="line">    		g_tcpInterface.StopLocalListening = TcpStopListening;</span><br><span class="line">    		g_tcpInterface.CheckActiveConnection = TcpCheckActiveConnection;</span><br><span class="line"></span><br><span class="line">TransServerInit()   <span class="comment">//传输</span></span><br><span class="line">    TransPermissionInit()    <span class="comment">//解析 /etc/softbus_trans_permission.json</span></span><br><span class="line">    TransSessionMgrInit()    <span class="comment">//创建 g_sessionServerList</span></span><br><span class="line">    TransChannelInit()    <span class="comment">//设置传输通道回调函数 g_channelCallBack</span></span><br><span class="line">        IServerChannelCallBack *cb = TransServerGetChannelCb();-&gt;    <span class="comment">//return &amp;g_channelCallBack;</span></span><br><span class="line">            g_channelCallBack.OnChannelOpened = TransServerOnChannelOpened;</span><br><span class="line">            g_channelCallBack.OnChannelClosed = TransServerOnChannelClosed;</span><br><span class="line">            g_channelCallBack.OnChannelOpenFailed = TransServerOnChannelOpenFailed;</span><br><span class="line">            g_channelCallBack.OnDataReceived = TransServerOnMsgReceived;</span><br><span class="line">            g_channelCallBack.OnQosEvent = TransServerOnQosEvent;</span><br><span class="line">            g_channelCallBack.GetPkgNameBySessionName = TransGetPkgNameBySessionName;</span><br><span class="line">            g_channelCallBack.GetUidAndPidBySessionName = TransGetUidAndPid;</span><br><span class="line">        TransLaneMgrInit()    <span class="comment">// 创建 g_channelLaneList</span></span><br><span class="line">        TransAuthInit(cb)-&gt;   <span class="comment">//设置认证通道回调函数</span></span><br><span class="line">            <span class="type">static</span> AuthTransCallback g_authTransCb = &#123;</span><br><span class="line">    			.onTransUdpDataRecv = AuthOnTransDataRecv,</span><br><span class="line">    			.onAuthChannelClose = AuthOnCloseChannel,</span><br><span class="line">		   &#125;;</span><br><span class="line">            AuthTransDataRegCallback(TRANS_AUTH_CHANNEL, &amp;g_authTransCb)</span><br><span class="line">        TransProxyManagerInit(cb)-&gt;</span><br><span class="line">            TransProxySetCallBack(cb)  </span><br><span class="line">            TransProxyTransInit()-&gt;</span><br><span class="line">                proxyCallback.OnConnected = TransProxyOnConnected;</span><br><span class="line">                proxyCallback.OnDisconnected = TransProxyOnDisConnect;</span><br><span class="line">                proxyCallback.OnDataReceived = TransProxyOnDataReceived;</span><br><span class="line">                ConnSetConnectCallback(MODULE_PROXY_CHANNEL, &amp;proxyCallback)</span><br><span class="line">                TransProxyLoopInit()-&gt;</span><br><span class="line">                    g_transLoophandler.looper = GetLooper(LOOP_TYPE_DEFAULT);</span><br><span class="line">                    g_transLoophandler.HandleMessage = TransProxyLoopMsgHandler;  <span class="comment">//设置transproxy的消息处理函数</span></span><br><span class="line">            RegisterTimeoutCallback(SOFTBUS_PROXYCHANNEL_TIMER_FUN, TransProxyTimerProc)  <span class="comment">// channel的超时处理</span></span><br><span class="line">        TransTcpDirectInit(cb)-&gt;    <span class="comment">//注册tdc回调</span></span><br><span class="line">            P2pDirectChannelInit()   <span class="comment">//not supported </span></span><br><span class="line">            TransTdcSetCallBack(cb)-&gt;   </span><br><span class="line">                IServerChannelCallBack g_channelCb = *cb;</span><br><span class="line">            RegisterTimeoutCallback(SOFTBUS_TCP_DIRECTCHANNEL_TIMER_FUN, TransTdcTimerProc)  </span><br><span class="line">        TransUdpChannelInit(cb)    <span class="comment">//udp通道初始化（udp主要是用于处理连接）</span></span><br><span class="line">            AuthTransDataRegCallback(TRANS_UDP_DATA, &amp;transUdpCb)    <span class="comment">//注册udp数据回调函数</span></span><br><span class="line">                </span><br><span class="line">AuthInit    <span class="comment">//设备认证</span></span><br><span class="line">    AuthGetAbility();   <span class="comment">//打印ability</span></span><br><span class="line">    RegisterConnCallback(&amp;g_connCallback, &amp;g_connResult)-&gt;    <span class="comment">//设置认证回调函数</span></span><br><span class="line">        connCb-&gt;OnConnected = AuthOnConnected;</span><br><span class="line">        connCb-&gt;OnDisconnected = AuthOnDisConnect;</span><br><span class="line">        connCb-&gt;OnDataReceived = AuthOnDataReceived;</span><br><span class="line">        ConnSetConnectCallback(MODULE_DEVICE_AUTH, connCb)</span><br><span class="line">        connResult-&gt;OnConnectSuccessed = AuthOnConnectSuccessful;</span><br><span class="line">        connResult-&gt;OnConnectFailed = AuthOnConnectFailed;</span><br><span class="line">    AuthP2pInit()-&gt;   <span class="comment">//p2p的认证回调</span></span><br><span class="line">        VerifyCallback p2pVerifyCb = &#123;</span><br><span class="line">        .onKeyGenerated = AuthP2pOnKeyGenerated,</span><br><span class="line">        .onRecvSyncDeviceInfo = AuthP2pOnRecvSyncDeviceInfo,</span><br><span class="line">        .onDeviceVerifyPass = AuthP2pOnDeviceVerifyPass,</span><br><span class="line">        .onDeviceVerifyFail = AuthP2pOnDeviceVerifyFail,</span><br><span class="line">        .onDisconnect = AuthP2pOnDisconnect,</span><br><span class="line">        .onDeviceNotTrusted = AuthP2pOnDeviceNotTrusted,</span><br><span class="line">        .onGroupCreated = AuthP2pOnGroupCreated,</span><br><span class="line">        .onGroupDeleted = AuthP2pOnGroupDeleted</span><br><span class="line">        &#125;;</span><br><span class="line">    AuthLooperInit()    </span><br><span class="line">        g_authHandler.HandleMessage = AuthHandler;</span><br><span class="line">        g_authHandler.looper = GetLooper(LOOP_TYPE_DEFAULT);</span><br><span class="line">    UniqueIdInit()    <span class="comment">//由时间生成id</span></span><br><span class="line">    HichainServiceInit()-&gt;    <span class="comment">//hichain是用于设备认证的一个安全子系统的,我们关注g_hichainCallback</span></span><br><span class="line">        InitDeviceAuthService()    <span class="comment">//base\security\deviceauth\frameworks\src\ipc_sdk.c 获取deviceauth server</span></span><br><span class="line">        g_hichainGaInstance = GetGaInstance();</span><br><span class="line">        g_hichainGmInstance = GetGmInstance();</span><br><span class="line">        g_hichainCallback.onTransmit = AuthOnTransmit;   <span class="comment">//设置设备认证回调函数</span></span><br><span class="line">        g_hichainCallback.onSessionKeyReturned = AuthOnSessionKeyReturned;</span><br><span class="line">        g_hichainCallback.onFinish = AuthOnFinish;</span><br><span class="line">        g_hichainCallback.onError = AuthOnError;</span><br><span class="line">        g_hichainCallback.onRequest = AuthOnRequest;</span><br><span class="line">        g_hichainListener.onGroupCreated = AuthOnGroupCreated;</span><br><span class="line">        g_hichainListener.onGroupDeleted = AuthOnGroupDeleted;</span><br><span class="line">        g_hichainListener.onDeviceNotTrusted = AuthOnDeviceNotTrusted;</span><br><span class="line"></span><br><span class="line">DiscServerInit()    <span class="comment">//发现</span></span><br><span class="line">    DiscMgrInit()-&gt;    </span><br><span class="line">            g_discMgrMediumCb.OnDeviceFound = DiscOnDeviceFound;</span><br><span class="line">            g_discCoapInterface = DiscCoapInit(&amp;g_discMgrMediumCb)-&gt; </span><br><span class="line">                DiscNstackxInit()</span><br><span class="line">                    InitLocalInfo()</span><br><span class="line">                    NSTACKX_Init(&amp;g_nstackxCallBack)   <span class="comment">//启动coap协议栈、设置epoll</span></span><br><span class="line">                        g_epollfd = CreateEpollDesc();  <span class="comment">//创建EpollSet 需要了解linux网络编程</span></span><br><span class="line">                        InternalInit(g_epollfd);</span><br><span class="line">                            EventModuleInit(&amp;g_eventNodeChain, g_epollfd); </span><br><span class="line">                            DeviceModuleInit(epollfd);   <span class="comment">//初始化数据库、超时处理函数</span></span><br><span class="line">                            P2pUsbTimerInit(epollfd);</span><br><span class="line">                            CoapServerInit(<span class="literal">NULL</span>)-&gt;     </span><br><span class="line">                                IsWifiApConnected()</span><br><span class="line">                                coap_startup();     <span class="comment">//启动libcoap</span></span><br><span class="line">                                g_ctx = CoapGetContext(<span class="string">&quot;0.0.0.0&quot;</span>, <span class="string">&quot;5684&quot;</span>, NSTACKX_TRUE, ip);   <span class="comment">//TODO </span></span><br><span class="line">                                CoapInitResources(g_ctx, SERVER_TYPE_WLANORETH);    <span class="comment">//TODO </span></span><br><span class="line">                                coap_register_response_handler(g_ctx, CoapMessageHandler);    <span class="comment">//TODO </span></span><br><span class="line">                            CoapDiscoverInit()   <span class="comment">//设置发现的定时器</span></span><br><span class="line">                                TimerStart(epollfd, COAP_RECV_COUNT_INTERVAL, NSTACKX_TRUE,CoapRecvRecountTimerHandle, <span class="literal">NULL</span>); <span class="comment">//没用</span></span><br><span class="line">                                TimerStart(epollfd, <span class="number">0</span>, NSTACKX_FALSE, CoapServiceDiscoverTimerHandle, <span class="literal">NULL</span>);  <span class="comment">//用于重复发送coap发现报文</span></span><br><span class="line">                        PthreadCreate(&amp;g_tid, &amp;attr, NstackMainLoop, <span class="literal">NULL</span>)-&gt;</span><br><span class="line">                            EpollLoop(EpollDesc epollfd, <span class="type">int32_t</span> timeout)-&gt;   <span class="comment">//epoll参考下文</span></span><br><span class="line">                                select(epollSetPtr-&gt;maxfd + <span class="number">1</span>, &amp;readfds, &amp;writefds, &amp;exceptfds, tvp);</span><br><span class="line">                                EpollSetTraverse(epollSetPtr, EpollSetFdHandle, &amp;param);   </span><br><span class="line"></span><br><span class="line">BusCenterServerInit()    <span class="comment">//软总线服务 </span></span><br><span class="line">    LnnInitNetLedger()-&gt;    <span class="comment">// Ledger 分类账</span></span><br><span class="line">        LnnInitLocalLedger()-&gt;   <span class="comment">//设置本地网络信息 todo</span></span><br><span class="line">            nodeInfo-&gt;netCapacity = LnnGetNetCapabilty();</span><br><span class="line">            InitLocalDeviceInfo(deviceInfo)</span><br><span class="line">            InitLocalVersionType(nodeInfo)</span><br><span class="line">            InitConnectInfo(&amp;nodeInfo-&gt;connectInfo)</span><br><span class="line">            LnnInitLocalP2pInfo(nodeInfo)</span><br><span class="line">        LnnInitDistributedLedger()-&gt;</span><br><span class="line">            InitDistributedInfo(&amp;g_distributedNetLedger.distributedInfo)</span><br><span class="line">            InitConnectionCode(&amp;g_distributedNetLedger.cnnCode)</span><br><span class="line">            InitLaneStatus();</span><br><span class="line">        LnnInitMetaNodeLedger()</span><br><span class="line">    LnnInitBusCenterEvent()-&gt;</span><br><span class="line">        looper = CreateNewLooper(<span class="string">&quot;NotifyLooper&quot;</span>);   <span class="comment">//创建一个NotifyLooper</span></span><br><span class="line">        g_notifyHandler.looper = looper;</span><br><span class="line">        g_notifyHandler.HandleMessage = HandleNotifyMessage;  <span class="comment">//消息处理函数</span></span><br><span class="line">    LnnInitEventMonitor()-&gt;</span><br><span class="line">        LnnInitNetlinkMonitorImpl()   <span class="comment">//创建NetlinkMonitorThread线程</span></span><br><span class="line">        LnnInitProductMonitorImpl()-&gt;    <span class="comment">//使用hisyslink_sevice驱动</span></span><br><span class="line">            g_serv = HdfIoServiceBind(<span class="string">&quot;hisyslink_sevice&quot;</span>);</span><br><span class="line">            HdfDeviceRegisterEventListener(g_serv, &amp;g_listener)</span><br><span class="line">        LnnInitLwipMonitorImpl()   <span class="comment">//不懂，没成功跑</span></span><br><span class="line">        LnnInitWifiServiceMonitorImpl()-&gt;    <span class="comment">//subscribe wifiservice conn and power state</span></span><br><span class="line">            looper = GetLooper(LOOP_TYPE_DEFAULT);</span><br><span class="line">            LnnAsyncCallbackDelayHelper(looper, LnnSubscribeWifiService, <span class="literal">NULL</span>, DELAY_LEN)-&gt; 跑LnnSubscribeWifiService</span><br><span class="line">        <span class="title function_">LnnInitDriverMonitorImpl</span><span class="params">()</span>-&gt;    <span class="comment">//订阅hdf_dsoftbus驱动服务，处理驱动消息</span></span><br><span class="line">            <span class="title function_">LnnAsyncCallbackDelayHelper</span><span class="params">(GetLooper(LOOP_TYPE_DEFAULT), DelayInitFunction, <span class="literal">NULL</span>, BIND_HDF_DELAY)</span>-&gt;</span><br><span class="line">            g_driverCtrl.softbusService = HdfIoServiceBind(<span class="string">&quot;hdf_dsoftbus&quot;</span>);</span><br><span class="line">            HdfDeviceRegisterEventListener(g_driverCtrl.softbusService, &amp;g_driverCtrl.eventListener); <span class="comment">//接收回调是OnReceiveDriverEvent</span></span><br><span class="line">                ProcessWlanEvent(data); <span class="comment">//todo</span></span><br><span class="line">                ProcessLwipEvent(data);</span><br><span class="line">    LnnInitDiscoveryManager()-&gt;   <span class="comment">//设置DeviceFound回调函数，构造一个msg，发送给looper-default</span></span><br><span class="line">        LnnInitCoapDiscovery()-&gt;  </span><br><span class="line">		   LnnNotifyDiscoveryDevice()-&gt;  </span><br><span class="line">                para = CreateConnectionAddrMsgPara(addr);</span><br><span class="line">                PostMessageToHandler(MSG_TYPE_DISCOVERY_DEVICE, para)</span><br><span class="line">                    SoftBusMessage *msg = CreateNetBuilderMessage(msgType, para);  <span class="comment">//handler.HandleMessage = NetBuilderMessageHandler;</span></span><br><span class="line">                    g_netBuilder.looper-&gt;PostMessage(g_netBuilder.looper, msg);</span><br><span class="line">    LnnInitNetworkManager()</span><br><span class="line">        LnnInitIpNetwork</span><br><span class="line">            <span class="title function_">LnnRegisterEventHandler</span><span class="params">(LNN_MONITOR_EVENT_IP_ADDR_CHANGED, IpAddrChangeEventHandler)</span> <span class="comment">//注册网络状态的回调函数</span></span><br><span class="line">            <span class="title function_">LnnRegisterEventHandler</span><span class="params">(LNN_MONITOR_EVENT_WIFI_STATE_CHANGED, WifiStateChangeEventHandler)</span></span><br><span class="line">            <span class="title function_">GetUpdateLocalIp</span><span class="params">(ipAddr, IP_LEN, ifName, NET_IF_NAME_LEN, <span class="literal">false</span>)</span>  <span class="comment">//更新ip</span></span><br><span class="line">            <span class="title function_">SetLocalIpInfo</span><span class="params">(ipAddr, ifName)</span></span><br><span class="line">            <span class="title function_">DiscLinkStatusChanged</span><span class="params">(LINK_STATUS_UP, COAP)</span>;   <span class="comment">//最终执行SetLocalDeviceInfo();</span></span><br><span class="line">            OpenIpLink()    <span class="comment">//设置认证相关函数</span></span><br><span class="line">                OpenAuthPort()-&gt;  <span class="comment">//设置认证端口回调函数</span></span><br><span class="line">                    port = OpenAuthServer()-&gt;     </span><br><span class="line">                        g_ethListener.onConnectEvent = AuthOnConnectEvent;</span><br><span class="line">    		           g_ethListener.onDataEvent = AuthOnDataEvent;</span><br><span class="line">                        SetSoftbusBaseListener(AUTH, &amp;g_ethListener)</span><br><span class="line">                        StartBaseListener(AUTH, localIp, <span class="number">0</span>, SERVER_MODE);</span><br><span class="line">                    LnnSetLocalNumInfo(NUM_KEY_AUTH_PORT, port);</span><br><span class="line">                OpenSessionPort()-&gt;    <span class="comment">//设置session端口回调函数</span></span><br><span class="line">                    TransTdcStartSessionListener()-&gt;</span><br><span class="line">                        g_sessionListener.onConnectEvent = OnConnectEventWifi;</span><br><span class="line">                        g_sessionListener.onDataEvent = OnDataEventWifi;</span><br><span class="line">                        SetSoftbusBaseListener(DIRECT_CHANNEL_SERVER_WIFI, &amp;g_sessionListener);</span><br><span class="line">                        StartBaseListener(DIRECT_CHANNEL_SERVER_WIFI, ip, port, SERVER_MODE);</span><br><span class="line">                    LnnSetLocalNumInfo(NUM_KEY_SESSION_PORT, port);</span><br><span class="line">            LnnStartDiscovery()-&gt;    <span class="comment">//通过DiscoveryFuncInterface来触发软总线发现</span></span><br><span class="line">                LnnStartCoapDiscovery()-&gt;</span><br><span class="line">                    SubscribeInfo subscribeInfo = &#123;</span><br><span class="line">                        .subscribeId = LNN_SUBSCRIBE_ID,</span><br><span class="line">                        .mode = DISCOVER_MODE_ACTIVE,</span><br><span class="line">                        .medium = COAP,</span><br><span class="line">                        .freq = HIGH,</span><br><span class="line">                        .isSameAccount = <span class="literal">false</span>,</span><br><span class="line">                        .isWakeRemote = <span class="literal">false</span>,</span><br><span class="line">                        .capability = LNN_DISC_CAPABILITY,</span><br><span class="line">                        .capabilityData = (<span class="type">unsigned</span> <span class="type">char</span> *)LNN_DISC_CAPABILITY,</span><br><span class="line">                        .dataLen = <span class="built_in">strlen</span>(LNN_DISC_CAPABILITY) + <span class="number">1</span>,</span><br><span class="line">                    &#125;;</span><br><span class="line">                    LnnStartDiscDevice(<span class="literal">NULL</span>, &amp;subscribeInfo, &amp;callback, <span class="literal">true</span>)-&gt;  <span class="comment">//callback 会更新ip信息然后执行g_callback.OnDeviceFound</span></span><br><span class="line">		               DiscSetDiscoverCallback(MODULE_LNN, &amp;cb-&gt;innerCb)</span><br><span class="line">                        DiscStartAdvertise(MODULE_LNN, info)   <span class="comment">//(DiscoveryFuncInterface)interface-&gt;Subscribe</span></span><br><span class="line">    LnnInitNetBuilder()-&gt;   <span class="comment">//创建一个handler：NetBuilderMessageHandler，传递给looper-default，处理各种软总线的消息g_messageProcessor</span></span><br><span class="line">        LnnInitSyncInfoManager()-&gt;     <span class="comment">//todo</span></span><br><span class="line">            <span class="type">static</span> INetworkingListener g_networkListener = &#123;</span><br><span class="line">                OnChannelOpened,</span><br><span class="line">                OnChannelOpenFailed,</span><br><span class="line">                OnChannelClosed,</span><br><span class="line">                OnMessageReceived,</span><br><span class="line">            &#125;;</span><br><span class="line">            g_netChanlistener = g_networkListener</span><br><span class="line">        LnnInitTopoManager()-&gt;    <span class="comment">//拓扑管理</span></span><br><span class="line">            LnnRegisterEventHandler(LNN_EVENT_RELATION_CHANGED, OnLnnRelationChanged)</span><br><span class="line">            LnnRegSyncInfoHandler(LNN_INFO_TYPE_TOPO_UPDATE, OnReceiveTopoUpdateMsg) </span><br><span class="line">        LnnInitP2p()-&gt;    <span class="comment">//p2p同步信息消息处理</span></span><br><span class="line">            LnnRegSyncInfoHandler(LNN_INFO_TYPE_P2P_INFO, OnReceiveP2pSyncInfoMsg)</span><br><span class="line">        NetBuilderConfigInit();		<span class="comment">//无用</span></span><br><span class="line">        RegisterAuthCallback()-&gt;</span><br><span class="line">            <span class="type">static</span> VerifyCallback g_verifyCb = &#123;</span><br><span class="line">                .onKeyGenerated = OnAuthKeyGenerated,</span><br><span class="line">                .onDeviceVerifyPass = OnAuthPassed,</span><br><span class="line">                .onDeviceVerifyFail = OnAuthFailed,</span><br><span class="line">                .onRecvSyncDeviceInfo = OnRecvPeerDeviceInfo,</span><br><span class="line">                .onDeviceNotTrusted = OnDeviceNotTrusted,</span><br><span class="line">                .onDisconnect = OnDisconnect,</span><br><span class="line">            &#125;;</span><br><span class="line">            AuthRegCallback(LNN, &amp;g_verifyCb)</span><br><span class="line">        LnnRegSyncInfoHandler(LNN_INFO_TYPE_MASTER_ELECT, OnReceiveMasterElectMsg)	<span class="comment">//选举master消息回调</span></span><br><span class="line">        ConifgLocalLedger()-&gt;    <span class="comment">//设置uuid和netid</span></span><br><span class="line">            LnnGenLocalNetworkId()    <span class="comment">//使用GenerateRandomStr()产生随机id</span></span><br><span class="line">            nnSetLocalStrInfo(STRING_KEY_UUID, uuid);</span><br><span class="line">		   LnnSetLocalStrInfo(STRING_KEY_NETWORKID, networkId);</span><br><span class="line">        g_netBuilder.looper = GetLooper(LOOP_TYPE_DEFAULT);</span><br><span class="line">        g_netBuilder.handler.name = <span class="string">&quot;NetBuilderHandler&quot;</span>;</span><br><span class="line">        g_netBuilder.handler.HandleMessage = NetBuilderMessageHandler;</span><br><span class="line">    LnnInitLaneHub()-&gt;</span><br><span class="line">        LnnInitLaneManager()-&gt;</span><br><span class="line">            LnnLanesInit()</span><br><span class="line">            LnnRegisterLaneMonitor(LaneMonitorCallback)  <span class="comment">//在回调中遍历g_laneQosObserver，执行notify </span></span><br><span class="line">            LnnLanePendingInit()  <span class="comment">//g_pendingList</span></span><br><span class="line">        LnnInitTimeSync()-&gt;</span><br><span class="line">            g_timeSyncCtrl.looper = GetLooper(LOOP_TYPE_DEFAULT);</span><br><span class="line">            g_timeSyncCtrl.handler.name = <span class="string">&quot;TimeSync&quot;</span>;</span><br><span class="line">            g_timeSyncCtrl.handler.HandleMessage = TimeSyncMessageHandler;</span><br><span class="line">            LnnTimeSyncImplInit()  <span class="comment">//todo代码没有实现，是一个虚函数</span></span><br><span class="line">        LnnInitHeartbeat-&gt;</span><br><span class="line">            LnnHbMgrInit()-&gt;</span><br><span class="line">                <span class="type">static</span> LnnHeartbeatImplCallback g_hbCallback = &#123;</span><br><span class="line">                    .onRelay = HbMgrRelayToMaster,</span><br><span class="line">                    .onRecvHigherWeight = HbMgrRecvHigherWeight,</span><br><span class="line">                    .onUpdateDev = HbMgrUpdateDevInfo,</span><br><span class="line">                &#125;;</span><br><span class="line">                LnnInitBleHeartbeat(&amp;g_hbCallback)</span><br><span class="line">            LnnHbFsmInit()-&gt;</span><br><span class="line">                g_beatHandler.name = <span class="string">&quot;heartbeat_handler&quot;</span>;</span><br><span class="line">                g_beatHandler.HandleMessage = HbMsgHandler;</span><br><span class="line">                g_beatHandler.looper = GetLooper(LOOP_TYPE_DEFAULT);</span><br><span class="line">            HbMonitorInit()	 <span class="comment">//设置心跳策略</span></span><br><span class="line">            LnnRegisterEventHandler(LNN_EVENT_NODE_MASTER_STATE_CHANGED, LnnHeartbeatMasterNodeChangeEventHandler)  <span class="comment">//master心跳改变回调</span></span><br><span class="line">    StartDelayInit()    </span><br><span class="line">        BusCenterServerDelayInit()-&gt;</span><br><span class="line">            LnnInitNetLedgerDelay()      <span class="comment">//get device uuid</span></span><br><span class="line">            LnnInitNetworkManagerDelay()  <span class="comment">//do nothing</span></span><br><span class="line">            LnnInitNetBuilderDelay()   <span class="comment">// set master weight and master udid</span></span><br><span class="line">            LnnInitLaneHubDelay()-&gt;</span><br><span class="line">                LnnRemoveHbFsmMsg(EVENT_HB_START, <span class="number">0</span>, <span class="literal">NULL</span>)</span><br><span class="line">                LnnRemoveHbFsmMsg(EVENT_HB_STOP, <span class="number">0</span>, <span class="literal">NULL</span>)</span><br><span class="line">                LnnHbFsmStart(STATE_HB_MASTER_NODE_INDEX, <span class="number">0</span>)</span><br><span class="line">                LnnHbFsmStop(delayMillis)</span><br></pre></td></tr></table></figure>



<p>通道module id</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    MODULE_TRUST_ENGINE = <span class="number">1</span>,</span><br><span class="line">    MODULE_HICHAIN = <span class="number">2</span>,</span><br><span class="line">    MODULE_AUTH_SDK = <span class="number">3</span>,</span><br><span class="line">    MODULE_AUTH_CONNECTION = <span class="number">5</span>,</span><br><span class="line">    MODULE_MESSAGE_SERVICE = <span class="number">8</span>,</span><br><span class="line">    MODULE_AUTH_CHANNEL = <span class="number">8</span>,</span><br><span class="line">    MODULE_AUTH_MSG = <span class="number">9</span>,</span><br><span class="line">    MODULE_BLUETOOTH_MANAGER = <span class="number">9</span>,</span><br><span class="line">    MODULE_CONNECTION = <span class="number">11</span>,</span><br><span class="line">    MODULE_DIRECT_CHANNEL = <span class="number">12</span>,</span><br><span class="line">    MODULE_PROXY_CHANNEL = <span class="number">13</span>,</span><br><span class="line">    MODULE_DEVICE_AUTH = <span class="number">14</span>,</span><br><span class="line">    MODULE_P2P_LINK = <span class="number">15</span>,</span><br><span class="line">    MODULE_P2P_LISTEN = <span class="number">16</span>,</span><br><span class="line">    MODULE_UDP_INFO = <span class="number">17</span>,</span><br><span class="line">    MODULE_TIME_SYNC = <span class="number">18</span>,</span><br><span class="line">    MODULE_PKG_VERIFY = <span class="number">20</span>,</span><br><span class="line">    MODULE_BLE_NET = <span class="number">100</span>,</span><br><span class="line">    MODULE_BLE_CONN = <span class="number">101</span></span><br><span class="line">&#125; ConnModule;</span><br></pre></td></tr></table></figure>



<p>looper的handler</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">TransProxyLoopMsgHandler</span><br><span class="line">AuthHandler</span><br><span class="line">HbMsgHandler</span><br><span class="line">TimeSyncMessageHandler</span><br><span class="line">NetBuilderMessageHandler</span><br><span class="line">HandleNotifyMessage</span><br></pre></td></tr></table></figure>







<p>我希望结合打印信息分析：</p>
<p>初始化looper、初始认证服务、初始化coap、初始buscenter</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br></pre></td><td class="code"><pre><span class="line">OHOS <span class="comment"># ./softbus_server</span></span><br><span class="line">001-01 00:03:21.469 13 76 I 015C0/dsoftbus_standard: [COMM]Init success softbus_service</span><br><span class="line">01-01 00:03:21.480 13 76 I 01800/Samgr: Bootstrap core services(count:1).</span><br><span class="line">01-01 00:03:21.480 13 76 I 01800/Samgr: Init service:softbus_service</span><br><span class="line">01-01 00:03:21.480 13 77 I 01800/Samgr: Initialize Client Registry!</span><br><span class="line">01-01 00:03:21.513 13 76 W 015C0/dsoftbus_standard: mutex is already init</span><br><span class="line">01-01 00:03:21.517 13 77 I 01800/Samgr: Init service softbus_service &lt;<span class="keyword">time</span>: 63ms&gt; success!</span><br><span class="line">01-01 00:03:21.517 13 77 I 01800/Samgr: Initialized all core system services!</span><br><span class="line">01-01 00:03:21.517 13 77 I 01800/Samgr: Goto next boot step <span class="built_in">return</span> code:-9</span><br><span class="line">01-01 00:03:21.517 13 76 I 015C0/dsoftbus_standard: [COMM]loop thread creating Loop-default <span class="built_in">id</span> 663272816</span><br><span class="line">01-01 00:03:21.518 13 76 I 015C0/dsoftbus_standard: [COMM][Loop-default]<span class="built_in">wait</span> looper start ok</span><br><span class="line">01-01 00:03:21.518 13 76 I 015C0/dsoftbus_standard: [COMM]init looper success.</span><br><span class="line">01-01 00:03:21.518 3 38 E 01500/Communication: [UnregisterDeathCallback : 984]Wrong cbId:4294967295.</span><br><span class="line">01-01 00:03:21.518 3 38 I 01800/Samgr: Register Endpoint&lt;13, 78, 0&gt;</span><br><span class="line">01-01 00:03:21.524 13 78 E 01500/Communication: [UnregisterDeathCallback : 984]Wrong cbId:4294967295.</span><br><span class="line">01-01 00:03:21.524 13 79 I 015C0/dsoftbus_standard: [COMM]LoopTask[Loop-default] running</span><br><span class="line">01-01 00:03:21.524 13 79 I 015C0/dsoftbus_standard: [COMM]LoopTask[Loop-default] <span class="built_in">wait</span> msg list empty</span><br><span class="line">01-01 00:03:21.524 3 38 D 01800/Samgr: Register Feature&lt;softbus_service, (null)&gt; pid&lt;13&gt;, <span class="built_in">id</span>&lt;78, 0&gt; ret:0</span><br><span class="line">01-01 00:03:21.524 13 78 D 01800/Samgr: RegisterRemoteFeatures&lt;softbus_service, (null)&gt; ret:0</span><br><span class="line">01-01 00:03:21.524 13 78 I 01800/Samgr: Register endpoint&lt;ipc client&gt; and iunknown finished! remain&lt;0&gt; iunknown!</span><br><span class="line">01-01 00:03:21.542 13 76 I 015C0/dsoftbus_standard: [CONN]tcp MaxConnNum is 30</span><br><span class="line">01-01 00:03:21.542 13 76 I 015C0/dsoftbus_standard: [CONN]tcp MaxLen is 3072</span><br><span class="line">01-01 00:03:21.546 13 76 I 015C0/dsoftbus_standard: [CONN]tcp TimeOut is 100</span><br><span class="line">01-01 00:03:21.546 13 76 I 015C0/dsoftbus_standard: [CONN]init tcp ok </span><br><span class="line"></span><br><span class="line">01-01 00:03:21.546 13 76 I 015C0/dsoftbus_standard: [CONN]connect manager init success. </span><br><span class="line"></span><br><span class="line">01-01 00:03:21.576 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [REGEXP]</span><br><span class="line">01-01 00:03:21.583 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [SEC_LEVEL]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [UID]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [SEC_LEVEL]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [PKG_NAME]</span><br><span class="line">01-01 00:03:21.584 13 76 I 015C0/dsoftbus_standard: [COMM]appInfo has no pkgname</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [UID]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [UID]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]5 nStackXEpoll: EpollEventPtrInit:[373] :epoll event init success</span><br><span class="line">Cannot find or invalid [SEC_LEVEL]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [UID]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [SEC_LEVEL]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [UID]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [REGEXP]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [SEC_LEVEL]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [UID]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [SEC_LEVEL]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [UID]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [UID]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [REGEXP]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [SEC_LEVEL]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [UID]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [REGEXP]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [SEC_LEVEL]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [REGEXP]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [SEC_LEVEL]</span><br><span class="line">01-01 00:03:21.584 13 76 E 015C0/dsoftbus_standard: [COMM]Cannot find or invalid [UID]</span><br><span class="line">01-01 00:03:21.594 13 76 I 015C0/dsoftbus_standard: [CONN]proxy auth byteSize[4096], messageSize[1024]</span><br><span class="line">01-01 00:03:21.594 13 76 I 015C0/dsoftbus_standard: [TRAN]proxy channel init ok</span><br><span class="line">01-01 00:03:21.594 13 76 I 015C0/dsoftbus_standard: [TRAN]p2p direct channel not support.</span><br><span class="line">01-01 00:03:21.594 13 76 I 015C0/dsoftbus_standard: [TRAN]server trans udp channel init success.</span><br><span class="line">01-01 00:03:21.594 13 76 I Jan 01 00:03:21 ALRT 015C0/dsoftbus_standard: [TRAN]InitQos virtual</span><br><span class="line">01-01 00:03:21.594 13 76 I 015C0/dsoftbus_standard: [TRAN]trans session server list init succ</span><br><span class="line">coap_socket_bind_udp: setsockopt IP_PKTINFO: Protocol not available</span><br><span class="line">4 nStackXDev: BindToDevice:[213] :device name: wlan0</span><br><span class="line">4 nStackXDev: BindToDeviceInner:[191] :binding interface wlan0 success</span><br><span class="line">01-01 00:03:21.598 13 76 I 015C0/dsoftbus_standard: [AUTH]auth ability is 1</span><br><span class="line">01-01 00:03:21.607 3 38 D 01800/Samgr: Judge Auth&lt;devauth_svc, (null)&gt; ret:0</span><br><span class="line">01-01 00:03:21.607 3 38 D 01800/Samgr: Find Feature&lt;devauth_svc, (null)&gt; <span class="built_in">id</span>&lt;37, 0&gt; ret:0</span><br><span class="line">01-01 00:03:21.607 13 76 I 01800/Samgr: Create remote sa proxy&lt;devauth_svc, (null)&gt;!</span><br><span class="line">01-01 00:03:21.607 13 76 I 00000/[DEVAUTH]: InitProxyAdapt: get proxy instance success</span><br><span class="line">01-01 00:03:21.607 13 76 I 00000/[DEVAUTH]: ShowIpcSvcInfo: svc information - handle(80), token(662135808), cookie(0)</span><br><span class="line">01-01 00:03:21.607 13 76 I 00000/[DEVAUTH]: InitProxyAdapt: register ipc cb success</span><br><span class="line">01-01 00:03:21.607 13 76 I 00000/[DEVAUTH]: GetGaInstance: Enter InitIpcMethods...</span><br><span class="line">01-01 00:03:21.607 13 76 I 00000/[DEVAUTH]: InitIpcGaMethods: entering...</span><br><span class="line">01-01 00:03:21.607 13 76 I 00000/[DEVAUTH]: InitIpcGaMethods: process <span class="keyword">done</span></span><br><span class="line">01-01 00:03:21.607 13 76 I 00000/[DEVAUTH]: GetGaInstance: InitIpcMethods <span class="keyword">done</span></span><br><span class="line">01-01 00:03:21.607 13 76 I 00000/[DEVAUTH]: GetGmInstance: Enter InitIpcMethods...</span><br><span class="line">01-01 00:03:21.607 13 76 I 00000/[DEVAUTH]: InitIpcGmMethods: starting ...</span><br><span class="line">01-01 00:03:21.607 13 76 I 00000/[DEVAUTH]: InitIpcGmMethods: process <span class="keyword">done</span></span><br><span class="line">01-01 00:03:21.607 13 76 I 00000/[DEVAUTH]: GetGmInstance: InitIpcMethods <span class="keyword">done</span></span><br><span class="line">01-01 00:03:21.608 13 76 I 00000/[DEVAUTH]: IpcGmRegDataChangeListener: starting ...</span><br><span class="line">01-01 00:03:21.608 13 76 I 00000/[DEVAUTH]: IsServiceRunning: service activity check</span><br><span class="line">01-01 00:03:21.608 13 76 I 00000/[DEVAUTH]: EncodeCallRequest: <span class="built_in">type</span> 1, paramSz 13</span><br><span class="line">01-01 00:03:21.608 13 76 I 00000/[DEVAUTH]: EncodeCallRequest: <span class="built_in">type</span> 3, paramSz 28</span><br><span class="line">01-01 00:03:21.608 13 76 I 00000/[DEVAUTH]: ShowIpcSvcInfo: svc information - handle(80), token(662135808), cookie(0)</span><br><span class="line">01-01 00:03:21.608 13 76 I 00000/[DEVAUTH]: DoBinderCall: proc method 3</span><br><span class="line">01-01 00:03:21.608 13 76 I 00000/[DEVAUTH]: FinalCallRequest: method <span class="built_in">id</span> 3, param num 2, data length 60, flag 1, io offset 0</span><br><span class="line">01-01 00:03:21.608 13 76 I 00000/[DEVAUTH]: ShowIpcSvcInfo: svc information - handle(80), token(662135808), cookie(0)</span><br><span class="line">01-01 00:03:21.608 13 76 I 00000/[DEVAUTH]: FinalCallRequest: ipc call with callback, data flag 1</span><br><span class="line">01-01 00:03:21.608 13 76 I 00000/[DEVAUTH]: ActCall: start to invoke ipc call...</span><br><span class="line">01-01 00:03:21.613 9 36 I 00000/[DEVAUTH]: OnRemoteRequest: request code 1</span><br><span class="line">01-01 00:03:21.613 9 36 I 00000/[DEVAUTH]: GetMethodId: GetMethodId, <span class="built_in">id</span> code 3</span><br><span class="line">01-01 00:03:21.614 9 36 I 00000/[DEVAUTH]: DevAuthRequestCall: request method <span class="built_in">id</span> 3</span><br><span class="line">01-01 00:03:21.614 9 36 I 00000/[DEVAUTH]: DecodeCallRequest: request data length(60), param number: 2</span><br><span class="line">01-01 00:03:21.617 9 36 I 00000/[DEVAUTH]: DecodeCallRequest: decode success, param <span class="built_in">type</span> 1, val size 13</span><br><span class="line">01-01 00:03:21.617 9 36 I 00000/[DEVAUTH]: DecodeCallRequest: decode success, param <span class="built_in">type</span> 3, val size 28</span><br><span class="line">01-01 00:03:21.617 9 36 I 00000/[DEVAUTH]: ShowIpcSvcInfo: svc information - handle(80), token(662135808), cookie(0)</span><br><span class="line">01-01 00:03:21.617 9 36 I 00000/[DEVAUTH]: SetRemoteObject: remote object cache index 0</span><br><span class="line">01-01 00:03:21.617 9 36 I 00000/[DEVAUTH]: ShowIpcSvcInfo: svc information - handle(80), token(662135808), cookie(0)</span><br><span class="line">01-01 00:03:21.617 9 36 I 00000/[DEVAUTH]: WithObject: object trans success, <span class="built_in">set</span> <span class="built_in">id</span> 0</span><br><span class="line">01-01 00:03:21.618 9 36 I 00000/[DEVAUTH]: IpcServiceGmRegDataChangeListener: starting ...</span><br><span class="line">01-01 00:03:21.618 9 36 I 00000/[DEVAUTH]: GetIpcRequestParamByType: <span class="built_in">type</span> 1, result 0x0</span><br><span class="line">01-01 00:03:21.618 9 36 I 00000/[DEVAUTH]: GetIpcRequestParamByType: <span class="built_in">type</span> 3, result 0x0</span><br><span class="line">01-01 00:03:21.619 9 36 I 00000/[DEVAUTH]: GetIpcCallBackByAppId: appid: softbus_auth</span><br><span class="line">01-01 00:03:21.619 9 36 I 00000/[DEVAUTH]: AddIpcCallBackByAppId: new callback to add, appid: softbus_auth</span><br><span class="line">01-01 00:03:21.619 9 36 I 00000/[DEVAUTH]: AddIpcCallBackByAppId: callback add success, appid: softbus_auth, <span class="built_in">type</span> 3</span><br><span class="line">01-01 00:03:21.619 9 36 I 00000/[DEVAUTH]: GetIpcRequestParamByType: <span class="built_in">type</span> 31, result 0x0</span><br><span class="line">01-01 00:03:21.619 9 36 I 00000/[DEVAUTH]: GetIpcCallBackByAppId: appid: softbus_auth</span><br><span class="line">01-01 00:03:21.619 9 36 I 00000/[DEVAUTH]: AddCbDeathRecipient: <span class="keyword">done</span>, ret 0, callback stub idx 0</span><br><span class="line">01-01 00:03:21.619 9 36 I 00000/[DEVAUTH]: AddIpcCbObjByAppId: ipc object add success, appid: softbus_auth, proxyId 0</span><br><span class="line">01-01 00:03:21.619 9 36 I 00000/[DEVAUTH]: IpcEncodeCallReplay: reply <span class="built_in">type</span> 23, success</span><br><span class="line">01-01 00:03:21.619 9 36 I 00000/[DEVAUTH]: IpcServiceGmRegDataChangeListener: process <span class="keyword">done</span>, call ret 0, ipc ret 0</span><br><span class="line">01-01 00:03:21.619 9 36 I 00000/[DEVAUTH]: OnRemoteRequest: form service result <span class="keyword">done</span>, result length(12)</span><br><span class="line">01-01 00:03:21.619 9 36 I 00000/[DEVAUTH]: OnRemoteRequest: <span class="keyword">done</span>, request code 1, call result 0</span><br><span class="line">01-01 00:03:21.619 13 76 I 00000/[DEVAUTH]: CliInvokeRetCallback: starting...</span><br><span class="line">01-01 00:03:21.619 13 76 I 00000/[DEVAUTH]: CliInvokeRetCallback: <span class="keyword">done</span>, reply data length 20</span><br><span class="line">01-01 00:03:21.619 13 76 I 00000/[DEVAUTH]: ActCall: invoke call <span class="keyword">done</span>, ipc result(0)</span><br><span class="line">01-01 00:03:21.619 13 76 I 00000/[DEVAUTH]: ActCall: service call result(0)</span><br><span class="line">01-01 00:03:21.623 13 76 I 00000/[DEVAUTH]: AddIpcCliCallbackCtx: starting ...</span><br><span class="line">01-01 00:03:21.623 13 76 I 00000/[DEVAUTH]: AddIpcCliCallbackCtx: success, appid: softbus_auth</span><br><span class="line">01-01 00:03:21.623 13 76 I 00000/[DEVAUTH]: IpcGmRegDataChangeListener: process <span class="keyword">done</span>, ret 0</span><br><span class="line">01-01 00:03:21.623 13 76 I 015C0/dsoftbus_standard: [AUTH]auth init succ!</span><br><span class="line">01-01 00:03:21.659 13 76 D 015C0/nStackXDFinder: 5 nStackXDFinder: NSTACKX_Init:[225] :nstack ctrl create epollfd 5</span><br><span class="line"></span><br><span class="line">01-01 00:03:21.661 13 76 D 015C0/nStackXDFinder: 5 nStackXCoAP: CoapServerInit:[262] :CoapServerInit is called</span><br><span class="line"></span><br><span class="line">01-01 00:03:21.662 13 76 D 015C0/nStackXDFinder: 5 nStackXCoAP: CoapServerInit:[268] :wifi not connected</span><br><span class="line"></span><br><span class="line">01-01 00:03:21.662 13 76 I 015C0/nStackXDFinder: 4 nStackXDFinder: NSTACKX_Init:[246] :DFinder init successfully</span><br><span class="line"></span><br><span class="line">01-01 00:03:21.662 13 76 I 015C0/dsoftbus_standard: [DISC]coap discovery init success.</span><br><span class="line">01-01 00:03:21.662 13 76 I 015C0/dsoftbus_standard: [DISC]init success</span><br><span class="line">01-01 00:03:21.671 13 76 I 015C0/dsoftbus_standard: [LNN]lnn capbility is 30</span><br><span class="line">01-01 00:03:21.671 13 76 E 015C0/dsoftbus_standard: [LNN]<span class="built_in">set</span> device <span class="built_in">type</span> error.</span><br><span class="line">01-01 00:03:21.671 13 76 E 015C0/dsoftbus_standard: [LNN]UpdateLocalDeviceType failed</span><br><span class="line">01-01 00:03:21.673 13 76 I 015C0/dsoftbus_standard: [LNN]meta node virtual init success</span><br><span class="line">01-01 00:03:21.673 13 76 I 015C0/dsoftbus_standard: [COMM]loop thread creating NotifyLooper <span class="built_in">id</span> 664296816</span><br><span class="line">01-01 00:03:21.673 13 76 I 015C0/dsoftbus_standard: [COMM][NotifyLooper]<span class="built_in">wait</span> looper start ok</span><br><span class="line">01-01 00:03:21.675 13 87 I 015C0/dsoftbus_standard: [COMM]LoopTask[NotifyLooper] running</span><br><span class="line">01-01 00:03:21.675 13 87 I 015C0/dsoftbus_standard: [COMM]LoopTask[NotifyLooper] <span class="built_in">wait</span> msg list empty</span><br><span class="line">01-01 00:03:21.676 13 76 E 02500/devmgr_service: device hisyslink_sevice not <span class="keyword">in</span> configed device list</span><br><span class="line">01-01 00:03:21.676 13 76 E 02500/hdf_syscall_adapter: Failed to dispatch serv call ioctl -202</span><br><span class="line">01-01 00:03:21.676 13 76 E 02500/HDF_LOG_TAG: failed to load khdf driver hisyslink_sevice</span><br><span class="line">01-01 00:03:21.676 13 76 E 02500/hdf_syscall_adapter: TrytoLoadIoService: load hisyslink_sevice driver failed</span><br><span class="line">01-01 00:03:21.679 13 76 W 015C0/dsoftbus_standard: fail to get service hisyslink_sevice</span><br><span class="line">01-01 00:03:21.679 13 76 E 015C0/dsoftbus_standard: [LNN]hdf driver monitor init enter</span><br><span class="line">01-01 00:03:21.679 13 76 D 015C0/dsoftbus_standard: [COMM][Loop-default]PostMessageAtTime what =0 <span class="keyword">time</span>=202679953 us</span><br><span class="line">01-01 00:03:21.680 13 76 D 015C0/dsoftbus_standard: [COMM][Loop-default]PostMessageAtTime. insert</span><br><span class="line">01-01 00:03:21.680 13 76 D 015C0/dsoftbus_standard: [COMM]DumpLooper. i=0,handler=LnnAsyncHandler,what =0,arg1=0 arg2=0, <span class="keyword">time</span>=202679953</span><br><span class="line">01-01 00:03:21.680 13 76 W 015C0/dsoftbus_standard: [LNN]Create netif mgr [0],[eth0]</span><br><span class="line">01-01 00:03:21.680 13 76 W 015C0/dsoftbus_standard: [LNN]Create netif mgr [1],[wlan0]</span><br><span class="line">01-01 00:03:21.688 13 76 I 015C0/nStackXDFinder: 4 nStackXDFinder: NSTACKX_RegisterDevice:[394] :begin to NSTACKX_RegisterDevice!</span><br><span class="line"></span><br><span class="line">01-01 00:03:21.689 13 81 W 015C0/nStackXDFinder: 3 nStackXDFinder: ConfigureLocalDeviceInfo:[897] :Invalid device name. Will use default name</span><br><span class="line"></span><br><span class="line">01-01 00:03:21.689 13 76 I 015C0/dsoftbus_standard: [LNN]IP protocol registed.</span><br><span class="line"></span><br><span class="line">01-01 00:03:21.703 13 76 I 015C0/dsoftbus_standard: [TRAN]register net listener ok</span><br><span class="line">01-01 00:03:21.705 13 76 I 015C0/dsoftbus_standard: [LNN]lnn config is 10,2</span><br><span class="line">01-01 00:03:21.707 13 76 I 015C0/dsoftbus_standard: [LNN]full path <span class="keyword">for</span> 0 is /usr/dsoftbus/uuid</span><br><span class="line">01-01 00:03:21.709 13 76 E 015C0/dsoftbus_standard: ReadFile open file fail</span><br><span class="line">01-01 00:03:21.723 13 76 I 015C0/dsoftbus_standard: [LNN]init net builder success</span><br><span class="line">01-01 00:03:21.728 13 76 E 015C0/dsoftbus_standard: [LNN]InitLaneManager success</span><br><span class="line">01-01 00:03:21.728 13 76 I 015C0/dsoftbus_standard: [LNN]init <span class="keyword">time</span> <span class="built_in">sync</span> success</span><br><span class="line">01-01 00:03:21.728 13 76 E 015C0/dsoftbus_standard: [LNN]<span class="keyword">time</span> <span class="built_in">sync</span> impl stub init success</span><br><span class="line">01-01 00:03:21.728 13 76 I 015C0/dsoftbus_standard: [LNN]heartbeat stub LnnInitHeartbeat</span><br><span class="line">01-01 00:03:21.728 13 76 I 015C0/dsoftbus_standard: [LNN]lnn delay init len is 0</span><br><span class="line">01-01 00:03:21.728 13 76 D 015C0/dsoftbus_standard: [COMM][Loop-default]PostMessageAtTime what =0 <span class="keyword">time</span>=201728478 us</span><br><span class="line">01-01 00:03:21.728 13 76 D 015C0/dsoftbus_standard: [COMM][Loop-default]PostMessageAtTime. insert</span><br><span class="line">01-01 00:03:21.728 13 76 D 015C0/dsoftbus_standard: [COMM]DumpLooper. i=0,handler=LnnAsyncHandler,what =0,arg1=0 arg2=0, <span class="keyword">time</span>=201728478</span><br><span class="line">01-01 00:03:21.728 13 76 D 015C0/dsoftbus_standard: [COMM]DumpLooper. i=1,handler=LnnAsyncHandler,what =0,arg1=0 arg2=0, <span class="keyword">time</span>=202679953</span><br><span class="line">01-01 00:03:21.728 13 76 I 015C0/dsoftbus_standard: [LNN]bus center server init ok</span><br><span class="line">01-01 00:03:21.728 13 76 I 015C0/dsoftbus_standard: [COMM]p2p <span class="built_in">link</span> not support</span><br><span class="line">01-01 00:03:21.728 13 76 I 015C0/dsoftbus_standard: [COMM]softbus framework init success.</span><br><span class="line">01-01 00:03:21.728 13 79 D 015C0/dsoftbus_standard: [COMM]LoopTask[Loop-default], get message. handle=LnnAsyncHandler,what=0,msgSize=1</span><br><span class="line">01-01 00:03:21.728 13 79 D 015C0/dsoftbus_standard: [COMM]LoopTask[Loop-default], HandleMessage message. handle=LnnAsyncHandler,what=0</span><br><span class="line">01-01 00:03:21.729 13 79 D 02500/mmc_if_c: MmcCntlrObjGetByNumber: success</span><br><span class="line">01-01 00:03:21.729 13 79 D 02500/emmc_if_c: EmmcServiceGetCid: success</span><br><span class="line">01-01 00:03:21.729 13 79 E 015C0/dsoftbus_standard: ioctl SIOCGIFFLAGS fail, errno = 19</span><br><span class="line">01-01 00:03:21.729 13 79 E 015C0/dsoftbus_standard: GetNetworkIfIp ifName:eth0 fail</span><br><span class="line">01-01 00:03:21.729 13 79 E 015C0/dsoftbus_standard: [LNN]GetAvailableIpAddr:get network IP by ifName failed!</span><br><span class="line">01-01 00:03:21.729 13 79 D 015C0/dsoftbus_standard: [LNN]subnet [eth0, 4] state change to 2</span><br><span class="line">01-01 00:03:21.729 13 79 I 015C0/dsoftbus_standard: [LNN]<span class="built_in">enable</span> protocol (0) <span class="keyword">for</span> netif eth0 success</span><br><span class="line"></span><br><span class="line">01-01 00:03:21.730 13 79 I 015C0/dsoftbus_standard: [LNN]open ip <span class="built_in">link</span> and start discovery</span><br><span class="line"></span><br><span class="line">01-01 00:03:21.732 13 79 I 015C0/dsoftbus_standard: [AUTH]auth open base listener</span><br><span class="line">01-01 00:03:21.737 13 79 E 015C0/dsoftbus_standard: setsockopt : Protocol not available</span><br><span class="line">01-01 00:03:21.737 13 79 E 015C0/dsoftbus_standard: [CONN]<span class="built_in">set</span> SO_REUSEPORT</span><br><span class="line">01-01 00:03:21.737 13 79 I 015C0/dsoftbus_standard: [CONN]create pthread now.</span><br><span class="line">01-01 00:03:21.738 13 79 I 015C0/dsoftbus_standard: [CONN]StartBaseListener success, fd = 58812, module = 1</span><br><span class="line">01-01 00:03:21.738 13 79 E 015C0/dsoftbus_standard: setsockopt : Protocol not available</span><br><span class="line">01-01 00:03:21.738 13 79 E 015C0/dsoftbus_standard: [CONN]<span class="built_in">set</span> SO_REUSEPORT</span><br><span class="line">01-01 00:03:21.738 13 79 I 015C0/dsoftbus_standard: [CONN]StartBaseListener success, fd = 58813, module = 5</span><br><span class="line">01-01 00:03:21.743 13 88 I 015C0/dsoftbus_standard: [CONN]ThreadPoolWorker Start</span><br><span class="line">01-01 00:03:21.743 13 79 E 015C0/dsoftbus_standard: setsockopt : Protocol not available</span><br><span class="line">01-01 00:03:21.744 13 79 E 015C0/dsoftbus_standard: [CONN]<span class="built_in">set</span> SO_REUSEPORT</span><br><span class="line">01-01 00:03:21.744 13 79 I 015C0/dsoftbus_standard: [CONN]StartBaseListener success, fd = 58814, module = 0</span><br><span class="line">01-01 00:03:21.744 13 79 I 015C0/nStackXDFinder: 4 nStackXDFinder: NSTACKX_RegisterDevice:[394] :begin to NSTACKX_RegisterDevice!</span><br><span class="line"></span><br><span class="line">01-01 00:03:21.744 13 81 D 015C0/nStackXDFinder: 5 nStackXCoAP: CoapServerInit:[262] :CoapServerInit is called</span><br><span class="line"></span><br><span class="line">01-01 00:03:21.758 13 79 I 015C0/dsoftbus_standard: [DISC]register input bitmap = [64].</span><br><span class="line">01-01 00:03:21.758 13 79 I 015C0/dsoftbus_standard: [DISC]register all <span class="built_in">cap</span> bitmap = [64].</span><br><span class="line">01-01 00:03:21.758 13 79 I 015C0/nStackXDFinder: 4 nStackXDFinder: NSTACKX_RegisterCapability:[517] :Register Capability</span><br><span class="line"></span><br><span class="line">01-01 00:03:21.758 13 79 I 015C0/dsoftbus_standard: [DISC]coap start passive publish.</span><br><span class="line">01-01 00:03:21.758 13 79 I 015C0/dsoftbus_standard: [DISC]register input bitmap = [64].</span><br><span class="line">01-01 00:03:21.758 13 79 I 015C0/dsoftbus_standard: [DISC]register all <span class="built_in">cap</span> bitmap = [64].</span><br><span class="line">01-01 00:03:21.758 13 79 I 015C0/nStackXDFinder: 4 nStackXDFinder: NSTACKX_SetFilterCapability:[523] :Set Filter Capability</span><br><span class="line"></span><br><span class="line">01-01 00:03:21.759 13 79 I 015C0/dsoftbus_standard: [DISC]coap start active discovery.</span><br><span class="line">01-01 00:03:21.759 13 79 D 015C0/dsoftbus_standard: [LNN]subnet [wlan0, 4] state change to 1</span><br><span class="line">01-01 00:03:21.759 13 79 I 015C0/dsoftbus_standard: [LNN]<span class="built_in">enable</span> protocol (0) <span class="keyword">for</span> netif wlan0 success</span><br><span class="line"></span><br><span class="line">01-01 00:03:21.772 13 79 I 015C0/dsoftbus_standard: [LNN]update <span class="built_in">local</span> role from 0 to 1</span><br><span class="line">01-01 00:03:21.772 13 79 I 015C0/dsoftbus_standard: [COMM]LoopTask[Loop-default], after HandleMessage message. handle=LnnAsyncHandler,what=0</span><br><span class="line">01-01 00:03:21.849 13 81 D 015C0/nStackXDFinder: 5 nStackXCoAP: CoapInitResources:[968] :CoapInitResources g_wlanOrEthContext update</span><br><span class="line"></span><br><span class="line">01-01 00:03:21.855 13 81 W 015C0/nStackXDFinder: 3 nStackXCoAP: CoapServiceDiscoverStop:[634] :clear device list backup</span><br><span class="line"></span><br><span class="line">01-01 00:03:21.855 13 81 I 015C0/nStackXDFinder: 4 nStackXCoAP: CoapServiceDiscoverStopInner:[785] :device discover stopped</span><br><span class="line"></span><br><span class="line">01-01 00:03:21.856 13 81 E 015C0/nStackXDFinder: 2 nStackXDFinder: BackupDeviceDB:[1182] :clear backupDB error</span><br><span class="line"></span><br><span class="line">01-01 00:03:21.856 13 81 W 015C0/nStackXDFinder: 3 nStackXCoAP: CoapServiceDiscoverInner:[727] :clear device list</span><br><span class="line"></span><br><span class="line">01-01 00:03:21.867 13 81 I 015C0/nStackXDFinder: 4 nStackXCoAP: CoapServiceDiscoverInner:[742] :the first <span class="keyword">time</span> <span class="keyword">for</span> device discover.</span><br><span class="line"></span><br><span class="line">01-01 00:03:21.969 13 81 I 015C0/nStackXDFinder: 4 nStackXCoAP: CoapServiceDiscoverTimerHandle:[655] :the 2 <span class="built_in">times</span> <span class="keyword">for</span> device discover.</span><br><span class="line"></span><br><span class="line">01-01 00:03:22.172 13 81 I 015C0/nStackXDFinder: 4 nStackXCoAP: CoapServiceDiscoverTimerHandle:[655] :the 3 <span class="built_in">times</span> <span class="keyword">for</span> device discover.</span><br><span class="line"></span><br><span class="line">01-01 00:03:22.375 13 81 I 015C0/nStackXDFinder: 4 nStackXCoAP: CoapServiceDiscoverTimerHandle:[655] :the 4 <span class="built_in">times</span> <span class="keyword">for</span> device discover.</span><br><span class="line"></span><br><span class="line">01-01 00:03:22.680 13 79 D 015C0/dsoftbus_standard: [COMM]LoopTask[Loop-default], get message. handle=LnnAsyncHandler,what=0,msgSize=0</span><br><span class="line">01-01 00:03:22.680 13 79 D 015C0/dsoftbus_standard: [COMM]LoopTask[Loop-default], HandleMessage message. handle=LnnAsyncHandler,what=0</span><br><span class="line">01-01 00:03:22.680 13 79 E 02500/devmgr_service: device hdf_dsoftbus not <span class="keyword">in</span> configed device list</span><br><span class="line">01-01 00:03:22.680 13 79 E 02500/hdf_syscall_adapter: Failed to dispatch serv call ioctl -202</span><br><span class="line">01-01 00:03:22.680 13 79 E 02500/HDF_LOG_TAG: failed to load khdf driver hdf_dsoftbus</span><br><span class="line">01-01 00:03:22.680 13 79 E 02500/hdf_syscall_adapter: TrytoLoadIoService: load hdf_dsoftbus driver failed</span><br><span class="line">01-01 00:03:22.680 13 79 E 015C0/dsoftbus_standard: [LNN]get hdf dsoftbus service fail(0)</span><br><span class="line">01-01 00:03:22.680 13 79 I 015C0/dsoftbus_standard: [COMM]LoopTask[Loop-default], after HandleMessage message. handle=LnnAsyncHandler,what=0</span><br><span class="line">01-01 00:03:22.680 13 79 I 015C0/dsoftbus_standard: [COMM]LoopTask[Loop-default] <span class="built_in">wait</span> msg list empty</span><br><span class="line">01-01 00:03:22.877 13 81 I 015C0/nStackXDFinder: 4 nStackXCoAP: CoapServiceDiscoverTimerHandle:[655] :the 5 <span class="built_in">times</span> <span class="keyword">for</span> device discover.</span><br><span class="line"></span><br><span class="line">[203380][W:556]hisi_customize_wifi::[ba buffer size:64]</span><br><span class="line">01-01 00:03:23.380 13 81 I 015C0/nStackXDFinder: 4 nStackXCoAP: CoapServiceDiscoverTimerHandle:[655] :the 6 <span class="built_in">times</span> <span class="keyword">for</span> device discover.</span><br><span class="line"></span><br><span class="line">[203880][W:861]&#123;hmac_mgmt_tx_delba:tid=0 ba_tx_info null&#125;</span><br><span class="line">[203882][W:556]hisi_customize_wifi::[ba buffer size:64]</span><br><span class="line">[203884][W:850]&#123;hmac_ba_reset_tx_handle::tx ba not <span class="built_in">set</span> yet.&#125;</span><br><span class="line">01-01 00:03:23.890 13 81 I 015C0/nStackXDFinder: 4 nStackXCoAP: CoapServiceDiscoverTimerHandle:[655] :the 7 <span class="built_in">times</span> <span class="keyword">for</span> device discover.</span><br><span class="line">[203895][W:1182]&#123;hmac_mgmt_rx_addba_rsp::tx ba info null.tid[0]&#125;</span><br><span class="line"></span><br><span class="line">[204390][W:861]&#123;hmac_mgmt_tx_delba:tid=0 ba_tx_info null&#125;</span><br><span class="line">[204392][W:556]hisi_customize_wifi::[ba buffer size:64]</span><br><span class="line">[204394][W:850]&#123;hmac_ba_reset_tx_handle::tx ba not <span class="built_in">set</span> yet.&#125;</span><br><span class="line">01-01 00:03:24.399 13 81 I 015C0/nStackXDFinder: 4 nStackXCoAP: CoapServiceDiscoverTimerHandle:[655] :the 8 <span class="built_in">times</span> <span class="keyword">for</span> device discover.</span><br><span class="line">[204405][W:1182]&#123;hmac_mgmt_rx_addba_rsp::tx ba info null.tid[0]&#125;</span><br><span class="line"></span><br><span class="line">[204900][W:861]&#123;hmac_mgmt_tx_delba:tid=0 ba_tx_info null&#125;</span><br><span class="line">[204902][W:556]hisi_customize_wifi::[ba buffer size:64]</span><br><span class="line">[204904][W:850]&#123;hmac_ba_reset_tx_handle::tx ba not <span class="built_in">set</span> yet.&#125;</span><br><span class="line">01-01 00:03:24.909 13 81 I 015C0/nStackXDFinder: 4 nStackXCoAP: CoapServiceDiscoverTimerHandle:[655] :the 9 <span class="built_in">times</span> <span class="keyword">for</span> device discover.</span><br><span class="line">[204914][W:1182]&#123;hmac_mgmt_rx_addba_rsp::tx ba info null.tid[0]&#125;</span><br><span class="line"></span><br><span class="line">01-01 00:03:25.411 13 81 I 015C0/nStackXDFinder: 4 nStackXCoAP: CoapServiceDiscoverTimerHandle:[655] :the 10 <span class="built_in">times</span> <span class="keyword">for</span> device discover.</span><br><span class="line"></span><br><span class="line">01-01 00:03:25.914 13 81 I 015C0/nStackXDFinder: 4 nStackXCoAP: CoapServiceDiscoverTimerHandle:[655] :the 11 <span class="built_in">times</span> <span class="keyword">for</span> device discover.</span><br><span class="line"></span><br><span class="line">01-01 00:03:26.416 13 81 I 015C0/nStackXDFinder: 4 nStackXCoAP: CoapServiceDiscoverTimerHandle:[655] :the 12 <span class="built_in">times</span> <span class="keyword">for</span> device discover.</span><br><span class="line"></span><br><span class="line">01-01 00:03:26.918 13 81 W 015C0/nStackXDFinder: 3 nStackXCoAP: CoapServiceDiscoverStop:[634] :clear device list backup</span><br><span class="line"></span><br></pre></td></tr></table></figure>











<h3 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h3><p>代码在sys_epoll.c中，是一种IO多路复用的机制，就是当系统中存在多个网络连接，只使用一个线程来阻塞等待这些连接的事件。然后通过回调函数来处理事件。</p>
<p>在 <code>EpollLoop</code>线程中，会阻塞等待 <code>epollSetPtr</code> ，然后调用task的响应的handler来处理网络数据。</p>
<p>所以，应该重点关注的是task的实现。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint32_t</span> <span class="title function_">GetTimeout</span><span class="params">(<span class="keyword">struct</span> <span class="type">coap_context_t</span> *ctx, <span class="type">uint32_t</span> *socketNum, EpollTask *taskList, EpollDesc epollfd)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> events;</span><br><span class="line">    <span class="type">coap_tick_t</span> now;</span><br><span class="line">    <span class="type">uint32_t</span> i;</span><br><span class="line">    <span class="type">uint32_t</span> timeout;</span><br><span class="line">    <span class="type">coap_socket_t</span> *sockets[MAX_COAP_SOCKET_NUM] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> DEFAULT_COAP_TIMEOUT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    coap_ticks(&amp;now);</span><br><span class="line">    timeout = coap_write(ctx, sockets,</span><br><span class="line">        (<span class="type">uint32_t</span>)(<span class="keyword">sizeof</span>(sockets) / <span class="keyword">sizeof</span>(sockets[<span class="number">0</span>])), socketNum, now);</span><br><span class="line">    <span class="keyword">if</span> (timeout == <span class="number">0</span> || timeout &gt; DEFAULT_COAP_TIMEOUT) &#123;</span><br><span class="line">        timeout = DEFAULT_COAP_TIMEOUT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (*socketNum &gt; MAX_COAP_SOCKET_NUM) &#123;</span><br><span class="line">        *socketNum = MAX_COAP_SOCKET_NUM;</span><br><span class="line">        DFINDER_LOGI(TAG, <span class="string">&quot;socketNum exccedd MAX_COAP_SOCKET_NUM, and set it to MAX_COAP_SOCKET_NUM&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; *socketNum; i++) &#123;</span><br><span class="line">        events = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ((sockets[i]-&gt;flags &amp; COAP_SOCKET_WANT_READ) || (sockets[i]-&gt;flags &amp; COAP_SOCKET_WANT_ACCEPT)) &#123;</span><br><span class="line">            events = EPOLLIN;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((sockets[i]-&gt;flags &amp; COAP_SOCKET_WANT_WRITE) || (sockets[i]-&gt;flags &amp; COAP_SOCKET_WANT_CONNECT)) &#123;</span><br><span class="line">            events = events | EPOLLOUT;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sockets[i]-&gt;flags &amp; COAP_SOCKET_WANT_CONNECT) &#123;</span><br><span class="line">            events = events | EPOLLHUP | EPOLLERR;</span><br><span class="line">        &#125;</span><br><span class="line">        taskList[i].taskfd = sockets[i]-&gt;fd;</span><br><span class="line">        taskList[i].epollfd = epollfd;</span><br><span class="line">        taskList[i].readHandle = CoAPEpollReadHandle;</span><br><span class="line">        taskList[i].writeHandle = CoAPEpollWriteHandle;</span><br><span class="line">        taskList[i].errorHandle = CoAPEpollErrorHandle;</span><br><span class="line">        taskList[i].ptr = sockets[i];</span><br><span class="line">        <span class="keyword">if</span> (taskList[i].taskfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        RegisterEpollTask(&amp;taskList[i], events);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> timeout;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="looper"><a href="#looper" class="headerlink" title="looper"></a>looper</h3><p>looper是一种循环处理消息队列中消息的办法。</p>
<p>创建一个looper变量，会有一个对应的线程，在这个线程中去处理消息，如下是创建了一个Looper</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">SoftBusLooper *<span class="title function_">CreateNewLooper</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name)</span></span><br><span class="line">&#123;</span><br><span class="line">    SoftBusLooper *looper = (SoftBusLooper *)SoftBusCalloc(<span class="keyword">sizeof</span>(SoftBusLooper));</span><br><span class="line">    SoftBusLooperContext *context = SoftBusCalloc(<span class="keyword">sizeof</span>(SoftBusLooperContext));</span><br><span class="line">    <span class="keyword">if</span> (memcpy_s(context-&gt;name, <span class="keyword">sizeof</span>(context-&gt;name), name, <span class="built_in">strlen</span>(name)) != EOK) &#123;</span><br><span class="line">        SoftBusFree(looper);</span><br><span class="line">        SoftBusFree(context);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ListInit(&amp;context-&gt;msgHead);</span><br><span class="line">    <span class="comment">// init context 非常重要</span></span><br><span class="line">    pthread_mutex_init(&amp;context-&gt;lock, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_cond_init(&amp;context-&gt;cond, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_cond_init(&amp;context-&gt;condRunning, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// init looper</span></span><br><span class="line">    looper-&gt;context = context;</span><br><span class="line">    looper-&gt;PostMessage = LooperPostMessage;</span><br><span class="line">    looper-&gt;PostMessageDelay = LooperPostMessageDelay;</span><br><span class="line">    looper-&gt;RemoveMessage = LooperRemoveMessage;</span><br><span class="line">    looper-&gt;RemoveMessageCustom = LoopRemoveMessageCustom;</span><br><span class="line">    <span class="type">int</span> ret = StartNewLooperThread(looper);</span><br><span class="line">    <span class="keyword">return</span> looper;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">StartNewLooperThread</span><span class="params">(SoftBusLooper *looper)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAINLOOP_STACK_SIZE 5120</span></span><br><span class="line">    <span class="type">pthread_t</span> tid;</span><br><span class="line">    <span class="type">pthread_attr_t</span> threadAttr;</span><br><span class="line"></span><br><span class="line">    pthread_attr_init(&amp;threadAttr);</span><br><span class="line">    pthread_attr_setstacksize(&amp;threadAttr, MAINLOOP_STACK_SIZE);</span><br><span class="line">    <span class="comment">//创建LoopTask线程</span></span><br><span class="line">    <span class="keyword">if</span> (pthread_create(&amp;tid, &amp;threadAttr, LoopTask线程, looper) != <span class="number">0</span>) &#123;</span><br><span class="line">        SoftBusLog(SOFTBUS_LOG_COMM, SOFTBUS_LOG_ERROR, <span class="string">&quot;create DeathProcTask failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>loopTask 的代码逻辑上就是 ：</p>
<ol>
<li>读取looper的上下文</li>
<li>从上下文中读取消息</li>
<li>调用消息的handler处理消息本身</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">LoopTask</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    SoftBusLooper *looper = arg;</span><br><span class="line">    <span class="comment">//获取上下文</span></span><br><span class="line">    SoftBusLooperContext *context = looper-&gt;context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pthread_mutex_lock(&amp;context-&gt;lock) != <span class="number">0</span>) &#123;</span><br><span class="line">        SoftBusLog(SOFTBUS_LOG_COMM, SOFTBUS_LOG_ERROR, <span class="string">&quot;lock failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    context-&gt;running = <span class="number">1</span>;</span><br><span class="line">    g_isThreadStarted = <span class="number">1</span>;</span><br><span class="line">    (<span class="type">void</span>)pthread_mutex_unlock(&amp;context-&gt;lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pthread_mutex_lock(&amp;context-&gt;lock) != <span class="number">0</span>) &#123;</span><br><span class="line">            SoftBusLog(SOFTBUS_LOG_COMM, SOFTBUS_LOG_ERROR, <span class="string">&quot;lock failed&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// wait 检查线程状态</span></span><br><span class="line">        <span class="keyword">if</span> (context-&gt;stop == <span class="number">1</span>) &#123;</span><br><span class="line">            SoftBusLog(SOFTBUS_LOG_COMM, SOFTBUS_LOG_INFO, <span class="string">&quot;LoopTask[%s], stop ==1&quot;</span>, context-&gt;name);</span><br><span class="line">            (<span class="type">void</span>)pthread_mutex_unlock(&amp;context-&gt;lock);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (g_isNeedDestroy == <span class="number">1</span>) &#123;</span><br><span class="line">            (<span class="type">void</span>)pthread_mutex_unlock(&amp;context-&gt;lock);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//上下文没有消息，进入等待</span></span><br><span class="line">        <span class="keyword">if</span> (IsListEmpty(&amp;context-&gt;msgHead)) &#123;</span><br><span class="line">            SoftBusLog(SOFTBUS_LOG_COMM, SOFTBUS_LOG_INFO, <span class="string">&quot;LoopTask[%s] wait msg list empty&quot;</span>, context-&gt;name);</span><br><span class="line">            pthread_cond_wait(&amp;context-&gt;cond, &amp;context-&gt;lock);</span><br><span class="line">            (<span class="type">void</span>)pthread_mutex_unlock(&amp;context-&gt;lock);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//有消息需要处理了</span></span><br><span class="line">        <span class="type">uint64_t</span> now = UptimeMicros();</span><br><span class="line">        ListNode *item = context-&gt;msgHead.next;</span><br><span class="line">        SoftBusMessage *msg = <span class="literal">NULL</span>;</span><br><span class="line">        SoftBusMessageNode *itemNode = CONTAINER_OF(item, SoftBusMessageNode, node);</span><br><span class="line">        <span class="type">uint64_t</span> time = itemNode-&gt;msg-&gt;time;</span><br><span class="line">        <span class="comment">//当前时间大于消息发送的时间</span></span><br><span class="line">        <span class="keyword">if</span> (now &gt;= time) &#123;</span><br><span class="line">            <span class="comment">//获取消息 </span></span><br><span class="line">            msg = itemNode-&gt;msg;</span><br><span class="line">            ListDelete(item);    <span class="comment">//移除链表</span></span><br><span class="line">            SoftBusFree(itemNode);</span><br><span class="line">            context-&gt;msgSize--;</span><br><span class="line">            SoftBusLog(SOFTBUS_LOG_COMM, SOFTBUS_LOG_INFO, <span class="string">&quot;LoopTask[%s], get message. handle=%s,what=%d,msgSize=%u&quot;</span>,</span><br><span class="line">                context-&gt;name, msg-&gt;handler-&gt;name, msg-&gt;what, context-&gt;msgSize);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">struct</span> timespec tv;</span><br><span class="line">            tv.tv_sec = time / TIME_THOUSANDS_MULTIPLIER / TIME_THOUSANDS_MULTIPLIER;</span><br><span class="line">            tv.tv_nsec = time % (TIME_THOUSANDS_MULTIPLIER * TIME_THOUSANDS_MULTIPLIER) * TIME_THOUSANDS_MULTIPLIER;</span><br><span class="line">            pthread_cond_timedwait(&amp;context-&gt;cond, &amp;context-&gt;lock, &amp;tv);</span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line">        context-&gt;currentMsg = msg;</span><br><span class="line">        (<span class="type">void</span>)pthread_mutex_unlock(&amp;context-&gt;lock);</span><br><span class="line">        SoftBusLog(SOFTBUS_LOG_COMM, SOFTBUS_LOG_INFO, <span class="string">&quot;LoopTask[%s], HandleMessage message. handle=%s,what=%d&quot;</span>,</span><br><span class="line">            context-&gt;name, msg-&gt;handler-&gt;name, msg-&gt;what);</span><br><span class="line">		<span class="comment">//使用消息的handler去处理消息本身</span></span><br><span class="line">        <span class="keyword">if</span> (msg-&gt;handler-&gt;HandleMessage != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            msg-&gt;handler-&gt;HandleMessage(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        SoftBusLog(SOFTBUS_LOG_COMM, SOFTBUS_LOG_INFO, <span class="string">&quot;LoopTask[%s], after HandleMessage message. handle=%s,what=%d&quot;</span>,</span><br><span class="line">            context-&gt;name, msg-&gt;handler-&gt;name, msg-&gt;what);</span><br><span class="line">        (<span class="type">void</span>)pthread_mutex_lock(&amp;context-&gt;lock);</span><br><span class="line">        FreeSoftBusMsg(msg);</span><br><span class="line">        context-&gt;currentMsg = <span class="literal">NULL</span>;</span><br><span class="line">        (<span class="type">void</span>)pthread_mutex_unlock(&amp;context-&gt;lock);</span><br><span class="line">    &#125;</span><br><span class="line">    (<span class="type">void</span>)pthread_mutex_lock(&amp;context-&gt;lock);</span><br><span class="line">    context-&gt;running = <span class="number">0</span>;</span><br><span class="line">    SoftBusLog(SOFTBUS_LOG_COMM, SOFTBUS_LOG_INFO, <span class="string">&quot;LoopTask[%s], running =0&quot;</span>, context-&gt;name);</span><br><span class="line">    pthread_cond_broadcast(&amp;context-&gt;cond);</span><br><span class="line">    pthread_cond_broadcast(&amp;context-&gt;condRunning);</span><br><span class="line">    (<span class="type">void</span>)pthread_mutex_unlock(&amp;context-&gt;lock);</span><br><span class="line">    <span class="keyword">if</span> (g_isNeedDestroy == <span class="number">1</span>) &#123;</span><br><span class="line">        LooperDeinit();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么looper上下文中的消息是怎么来的呢，看looper中定义了消息的发送和撤回。所以我们猜测looper的使用方法：</p>
<p>首先调用CreateNewLooper()创建一个looper结构体和一个线程，然后将一些数据和处理函数封装成一个消息，给looper发送消息，looper会在得到cpu时处理这些消息。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SoftBusLooper</span> &#123;</span></span><br><span class="line">    SoftBusLooperContext *context;</span><br><span class="line">    <span class="type">void</span> (*PostMessage)(<span class="type">const</span> SoftBusLooper *looper, SoftBusMessage *msg);   <span class="comment">//想looper发送消息</span></span><br><span class="line">    <span class="type">void</span> (*PostMessageDelay)(<span class="type">const</span> SoftBusLooper *looper, SoftBusMessage *msg, <span class="type">uint64_t</span> delayMillis);</span><br><span class="line">    <span class="type">void</span> (*RemoveMessage)(<span class="type">const</span> SoftBusLooper *looper, <span class="type">const</span> SoftBusHandler *handler, <span class="type">int32_t</span> what);    <span class="comment">//撤回消息</span></span><br><span class="line">    <span class="comment">// customFunc, when match, return 0</span></span><br><span class="line">    <span class="type">void</span> (*RemoveMessageCustom)(<span class="type">const</span> SoftBusLooper *looper, <span class="type">const</span> SoftBusHandler *handler,</span><br><span class="line">        <span class="type">int</span> (*)(<span class="type">const</span> SoftBusMessage*, <span class="type">void</span>*), <span class="type">void</span> *args);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/05/31/killer-blog/OpenHarmony/5.softbus_server/" data-id="cmbcy7rhk002bt8mt2xqa4yrt" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2025/05/31/killer-blog/OpenHarmony/3.dsoftbus_core_1/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2025/05/31/killer-blog/OpenHarmony/4.softbus_core_2/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">June 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">May 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/pwm/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/uart/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/worklife/2025%E6%B1%82%E8%81%8C%E5%87%86%E5%A4%87/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/other/tools/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/i2c_LSM303AGR/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>