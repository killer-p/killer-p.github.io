<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="uboot启动流程我将uboot分为两个部分：建立运行环境、执行uboot命令。 第一部分可分为四个阶段：  reset中断：关闭中断、进入SVC模式、设置CP15协处理器，为内存管理做准备。 board_init_f()：为重定位做准备，初始化日志、串口、i2c、spi、DRAM初始化、预留地址空间、确定重定位地址 uboot代码重定位 board_init_r():建立完善的uboot运行环境">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2025/05/31/killer-blog/Linux/uboot_1/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="uboot启动流程我将uboot分为两个部分：建立运行环境、执行uboot命令。 第一部分可分为四个阶段：  reset中断：关闭中断、进入SVC模式、设置CP15协处理器，为内存管理做准备。 board_init_f()：为重定位做准备，初始化日志、串口、i2c、spi、DRAM初始化、预留地址空间、确定重定位地址 uboot代码重定位 board_init_r():建立完善的uboot运行环境">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-05-31T17:16:20.236Z">
<meta property="article:modified_time" content="2025-06-01T00:19:46.365Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-killer-blog/Linux/uboot_1" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/05/31/killer-blog/Linux/uboot_1/" class="article-date">
  <time class="dt-published" datetime="2025-05-31T17:16:20.236Z" itemprop="datePublished">2025-05-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="uboot启动流程"><a href="#uboot启动流程" class="headerlink" title="uboot启动流程"></a>uboot启动流程</h3><p>我将uboot分为两个部分：建立运行环境、执行uboot命令。</p>
<p>第一部分可分为四个阶段：</p>
<ul>
<li>reset中断：关闭中断、进入SVC模式、设置CP15协处理器，为内存管理做准备。</li>
<li>board_init_f()：为重定位做准备，初始化日志、串口、i2c、spi、DRAM初始化、预留地址空间、确定重定位地址</li>
<li>uboot代码重定位</li>
<li>board_init_r():建立完善的uboot运行环境，能执行uboot命令</li>
</ul>
<p>编译uboot后再根目录出现了u-boot.lds,可见程序入口在arch&#x2F;arm&#x2F;cpu&#x2F;armv7&#x2F;start.o</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">OUTPUT_FORMAT(<span class="string">&quot;elf32-littlearm&quot;</span>, <span class="string">&quot;elf32-littlearm&quot;</span>, <span class="string">&quot;elf32-littlearm&quot;</span>)</span><br><span class="line">OUTPUT_ARCH(arm)</span><br><span class="line">ENTRY(_start)	<span class="comment">#程序入口地址</span></span><br><span class="line"><span class="comment">#输出文件组织结构</span></span><br><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line"> . = 0x4A000000;	<span class="comment"># .是一个定位变量，表示当前的地址，这里表示当前地址4a000000</span></span><br><span class="line"> . = ALIGN(4);		<span class="comment"># 四字节对齐</span></span><br><span class="line"> .<span class="built_in">head</span> :			<span class="comment"># 定义head段</span></span><br><span class="line"> &#123;</span><br><span class="line">  *(.__image_copy_start)	<span class="comment">#所有__image_copy_start段</span></span><br><span class="line">  <span class="built_in">arch</span>/arm/cpu/armv7/spare_head.o (.data*)	</span><br><span class="line"> &#125;</span><br><span class="line"> .text :			<span class="comment"># 定义text段，即代码段</span></span><br><span class="line"> &#123;</span><br><span class="line">  *(.vectors)		<span class="comment">#异常向量表段</span></span><br><span class="line">  <span class="built_in">arch</span>/arm/cpu/armv7/start.o (.text*)	<span class="comment">#起始的汇编代码</span></span><br><span class="line">  *(.text*)			<span class="comment">#所有其他代码段</span></span><br><span class="line"> &#125;</span><br><span class="line"> . = ALIGN(4);</span><br><span class="line"> .rodata : &#123; *(SORT_BY_ALIGNMENT(SORT_BY_NAME(.rodata*))) &#125;	<span class="comment">#所有只读数据段</span></span><br><span class="line"> . = ALIGN(4);</span><br><span class="line"> .data : &#123;			<span class="comment">#数据段 （全局变量）</span></span><br><span class="line">  *(.data*)</span><br><span class="line"> &#125;</span><br><span class="line"> . = ALIGN(4);</span><br><span class="line"> . = .;</span><br><span class="line"> . = ALIGN(4);</span><br><span class="line"> .u_boot_list : &#123;	<span class="comment">#uboot list段是干啥的</span></span><br><span class="line">  KEEP(*(SORT(.u_boot_list*)));</span><br><span class="line"> &#125;</span><br><span class="line"> . = ALIGN(4);</span><br><span class="line"> .__efi_runtime_start : &#123;	</span><br><span class="line">  *(.__efi_runtime_start)</span><br><span class="line"> &#125;</span><br><span class="line"> .efi_runtime : &#123;			<span class="comment">#efi_runtime是干啥</span></span><br><span class="line">  *(efi_runtime_text)</span><br><span class="line">  *(efi_runtime_data)</span><br><span class="line"> &#125;</span><br><span class="line"> .__efi_runtime_stop : &#123;	</span><br><span class="line">  *(.__efi_runtime_stop)</span><br><span class="line"> &#125;</span><br><span class="line"> .efi_runtime_rel_start :	</span><br><span class="line"> &#123;</span><br><span class="line">  *(.__efi_runtime_rel_start)</span><br><span class="line"> &#125;</span><br><span class="line"> .efi_runtime_rel : &#123;		<span class="comment">#efi_runtime_rel是干啥</span></span><br><span class="line">  *(.relefi_runtime_text)</span><br><span class="line">  *(.relefi_runtime_data)</span><br><span class="line"> &#125;</span><br><span class="line"> .efi_runtime_rel_stop :</span><br><span class="line"> &#123;</span><br><span class="line">  *(.__efi_runtime_rel_stop)</span><br><span class="line"> &#125;</span><br><span class="line"> . = ALIGN(4);</span><br><span class="line"> .image_copy_end :		<span class="comment">#image_copy_end是干啥</span></span><br><span class="line"> &#123;</span><br><span class="line">  *(.__image_copy_end)</span><br><span class="line"> &#125;</span><br><span class="line"> .rel_dyn_start :		<span class="comment">#rel_dyn是干啥</span></span><br><span class="line"> &#123;</span><br><span class="line">  *(.__rel_dyn_start)</span><br><span class="line"> &#125;</span><br><span class="line"> .rel.dyn : &#123;</span><br><span class="line">  *(.rel*)</span><br><span class="line"> &#125;</span><br><span class="line"> .rel_dyn_end :</span><br><span class="line"> &#123;</span><br><span class="line">  *(.__rel_dyn_end)</span><br><span class="line"> &#125;</span><br><span class="line"> .end :					<span class="comment">#end段</span></span><br><span class="line"> &#123;</span><br><span class="line">  *(.__end)</span><br><span class="line"> &#125;</span><br><span class="line"> _image_binary_end = .;</span><br><span class="line"> ASSERT(. &lt; 0x4A000000 + 0x100000, <span class="string">&quot;uboot size exceeds size limit&quot;</span>)	<span class="comment">#uboot大小超过限制</span></span><br><span class="line"> . = ALIGN(4096);</span><br><span class="line"> .mmutable : &#123;			<span class="comment">#mmu表格：页表</span></span><br><span class="line">  *(.mmutable)</span><br><span class="line"> &#125;</span><br><span class="line"> .bss_start __rel_dyn_start (OVERLAY) : &#123;	<span class="comment">#bss段？</span></span><br><span class="line">  KEEP(*(.__bss_start));</span><br><span class="line">  __bss_base = .;</span><br><span class="line"> &#125;</span><br><span class="line"> .bss __bss_base (OVERLAY) : &#123;</span><br><span class="line">  *(.bss*)</span><br><span class="line">   . = ALIGN(4);</span><br><span class="line">   __bss_limit = .;</span><br><span class="line"> &#125;</span><br><span class="line"> .bss_end __bss_limit (OVERLAY) : &#123;</span><br><span class="line">  KEEP(*(.__bss_end));</span><br><span class="line"> &#125;</span><br><span class="line"> .dynsym _image_binary_end : &#123; *(.dynsym) &#125;</span><br><span class="line"> .dynbss : &#123; *(.dynbss) &#125;</span><br><span class="line"> .dynstr : &#123; *(.dynstr*) &#125;</span><br><span class="line"> .dynamic : &#123; *(.dynamic*) &#125;</span><br><span class="line"> .plt : &#123; *(.plt*) &#125;</span><br><span class="line"> .interp : &#123; *(.interp*) &#125;</span><br><span class="line"> .gnu.hash : &#123; *(.gnu.hash) &#125;</span><br><span class="line"> .gnu : &#123; *(.gnu*) &#125;</span><br><span class="line"> .ARM.exidx : &#123; *(.ARM.exidx*) &#125;</span><br><span class="line"> .gnu.linkonce.armexidx : &#123; *(.gnu.linkonce.armexidx.*) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="vectors-S-定义中断向量表"><a href="#vectors-S-定义中断向量表" class="headerlink" title="vectors.S 定义中断向量表"></a>vectors.S 定义中断向量表</h4><p>通过全局查找找到_start的内容：arm&#x2F;lib&#x2F;vectors.S 主要的工作就是定义中断向量表的内容。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br></pre></td><td class="code"><pre><span class="line">panrunxins@AwExdroid100:~/longan/brandy/brandy<span class="number">-2.0</span>/u-boot<span class="number">-2018</span>/arch$ cat arm/lib/vectors.S</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;config.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * A macro to allow insertion of an ARM exception vector either</span></span><br><span class="line"><span class="comment"> * for the non-boot0 case or by a boot0-header.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        .macro ARM_VECTORS</span><br><span class="line">        b       reset</span><br><span class="line">        ldr     pc, _undefined_instruction</span><br><span class="line">        ldr     pc, _software_interrupt</span><br><span class="line">        ldr     pc, _prefetch_abort</span><br><span class="line">        ldr     pc, _data_abort</span><br><span class="line">        ldr     pc, _not_used</span><br><span class="line">        ldr     pc, _irq</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    aswcac</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        ldr     pc, _fiq</span><br><span class="line">        .endm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.globl _start	<span class="comment">//指定_start为全局变量，所以连接器才能使用他</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Vectors have their own section so linker script can map them easily</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">        .section <span class="string">&quot;.vectors&quot;</span>, <span class="string">&quot;ax&quot;</span>	<span class="comment">//_start位于.vectors段内</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_ENABLE_ARM_SOC_BOOT0_HOOK)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Various SoCs need something special and SoC-specific up front in</span></span><br><span class="line"><span class="comment"> * order to boot, allow them to set that in their boot0.h file and then</span></span><br><span class="line"><span class="comment"> * use it here.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * To allow a boot0 hook to insert a &#x27;special&#x27; sequence after the vector</span></span><br><span class="line"><span class="comment"> * table (e.g. for the socfpga), the presence of a boot0 hook supresses</span></span><br><span class="line"><span class="comment"> * the below vector table and assumes that the vector table is filled in</span></span><br><span class="line"><span class="comment"> * by the boot0 hook.  The requirements for a boot0 hook thus are:</span></span><br><span class="line"><span class="comment"> *   (1) defines &#x27;_start:&#x27; as appropriate</span></span><br><span class="line"><span class="comment"> *   (2) inserts the vector table using ARM_VECTORS as appropriate</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/arch/boot0.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Exception vectors as described in ARM reference manuals</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Uses indirect branch to allow reaching handlers anywhere in memory.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYS_DV_NOR_BOOT_CFG</span></span><br><span class="line">        .word   CONFIG_SYS_DV_NOR_BOOT_CFG</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        ARM_VECTORS	</span><br><span class="line">        <span class="comment">//ARM_VECTORS就是中断向量表，将宏展开如下：</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">  	    b       reset							#跳转到reset</span></span><br><span class="line"><span class="comment">        ldr     pc, _undefined_instruction		  #跳转向量表中的地址</span></span><br><span class="line"><span class="comment">        ldr     pc, _software_interrupt</span></span><br><span class="line"><span class="comment">        ldr     pc, _prefetch_abort</span></span><br><span class="line"><span class="comment">        ldr     pc, _data_abort</span></span><br><span class="line"><span class="comment">        ldr     pc, _not_used</span></span><br><span class="line"><span class="comment">        ldr     pc, _irq</span></span><br><span class="line"><span class="comment">        ldr     pc, _fiq</span></span><br><span class="line"><span class="comment">  		*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* !defined(CONFIG_ENABLE_ARM_SOC_BOOT0_HOOK) */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Indirect vectors table</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Symbols referenced here must be defined somewhere else</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">		<span class="comment">// 声明中断向量表中的地址为全局变量</span></span><br><span class="line">        .globl  _undefined_instruction</span><br><span class="line">        .globl  _software_interrupt</span><br><span class="line">        .globl  _prefetch_abort</span><br><span class="line">        .globl  _data_abort</span><br><span class="line">        .globl  _not_used</span><br><span class="line">        .globl  _irq</span><br><span class="line">        .globl  _fiq</span><br><span class="line"><span class="comment">// 声明了地址的大小</span></span><br><span class="line">_undefined_instruction: .word undefined_instruction</span><br><span class="line">_software_interrupt:    .word software_interrupt</span><br><span class="line">_prefetch_abort:        .word prefetch_abort</span><br><span class="line">_data_abort:            .word data_abort</span><br><span class="line">_not_used:              .word not_used</span><br><span class="line">_irq:                   .word irq</span><br><span class="line">_fiq:                   .word fiq</span><br><span class="line"></span><br><span class="line">        .balignl <span class="number">16</span>,<span class="number">0xdeadbeef</span>	<span class="comment">//地址对齐</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Interrupt handling</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* SPL interrupt handling: just hang */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SPL_BUILD</span></span><br><span class="line"></span><br><span class="line">        .align  <span class="number">5</span></span><br><span class="line">undefined_instruction:</span><br><span class="line">software_interrupt:</span><br><span class="line">prefetch_abort:</span><br><span class="line">data_abort:</span><br><span class="line">not_used:</span><br><span class="line">irq:</span><br><span class="line">fiq:</span><br><span class="line"><span class="number">1</span>:</span><br><span class="line">        bl      <span class="number">1b</span>                      <span class="comment">/* hang and never return */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span>   <span class="comment">/* !CONFIG_SPL_BUILD */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* IRQ stack memory (calculated at run-time) + 8 bytes */</span></span><br><span class="line">.globl IRQ_STACK_START_IN			<span class="comment">//指针，指向栈的起始地址 </span></span><br><span class="line">IRQ_STACK_START_IN:</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> IRAM_BASE_ADDR</span></span><br><span class="line">        .word   IRAM_BASE_ADDR + <span class="number">0x20</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        .word   <span class="number">0x0badc0de</span>			<span class="comment">//IRQ_STACK_START_IN的值是0x0badc0de</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* IRQ stack memory (calculated at run-time) */</span></span><br><span class="line">.globl IRQ_STACK_START				<span class="comment">//栈的起始地址</span></span><br><span class="line">IRQ_STACK_START:				</span><br><span class="line">        .word   <span class="number">0x0badc0de</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* IRQ stack memory (calculated at run-time) */</span></span><br><span class="line">.globl FIQ_STACK_START					</span><br><span class="line">FIQ_STACK_START:</span><br><span class="line">        .word <span class="number">0x0badc0de</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@</span><br><span class="line">@ IRQ <span class="built_in">stack</span> frame.</span><br><span class="line">@</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_FRAME_SIZE    72</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_OLD_R0        68</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_PSR           64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_PC            60</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_LR            56</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_SP            52</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_IP            48</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_FP            44</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R10           40</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R9            36</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R8            32</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R7            28</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R6            24</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R5            20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R4            16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R3            12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R2            8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R1            4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R0            0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODE_SVC 0x13</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> I_BIT    0x80</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * use bad_save_user_regs for abort/prefetch/undef/swi ...</span></span><br><span class="line"><span class="comment"> * use irq_save_user_regs / irq_restore_user_regs for IRQ/FIQ handling</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">        .macro  bad_save_user_regs	</span><br><span class="line">        @ carve out a frame on current user <span class="built_in">stack</span></span><br><span class="line">        sub     sp, sp, #S_FRAME_SIZE     <span class="comment">//sp = sp - 72</span></span><br><span class="line">        stmia   sp, &#123;r0 - r12&#125;  @ Save user <span class="title function_">registers</span> <span class="params">(now in svc mode)</span> r0-r12	<span class="comment">//将r0-r12入栈:13*4=52 bytes</span></span><br><span class="line">        ldr     r2, IRQ_STACK_START_IN	<span class="comment">//r2 = *(IRQ_STACK_START_IN) r2就是栈基地址</span></span><br><span class="line">        @ get values <span class="keyword">for</span> &quot;aborted&quot; pc and <span class="title function_">cpsr</span> <span class="params">(into parm regs)</span></span><br><span class="line">        ldmia   r2, &#123;r2 - r3&#125;			<span class="comment">//将数据(pc, cpsr)出栈到r2,r3</span></span><br><span class="line">        add     r0, sp, #S_FRAME_SIZE           @ grab pointer to old <span class="built_in">stack</span> <span class="comment">//r0 = sp + 72；将最初的sp_SVC保存到r0</span></span><br><span class="line">        add     r5, sp, #S_SP			<span class="comment">//r5 = sp + 52；更新sp，之前入栈了52 bytes</span></span><br><span class="line">        mov     r1, lr					<span class="comment">//r1 = lr</span></span><br><span class="line">        stmia   r5, &#123;r0 - r3&#125;   @ save sp_SVC, lr_SVC, pc, cpsr		<span class="comment">//将r0,r1,r2,r3入栈</span></span><br><span class="line">        mov     r0, sp          @ save current <span class="built_in">stack</span> into <span class="title function_">r0</span> <span class="params">(param <span class="keyword">register</span>)</span>	<span class="comment">//r0 = sp</span></span><br><span class="line">        .endm</span><br><span class="line"></span><br><span class="line">        .macro  irq_save_user_regs	<span class="comment">//保存寄存器到栈</span></span><br><span class="line">        sub     sp, sp, #S_FRAME_SIZE	<span class="comment">//sp = sp - 72</span></span><br><span class="line">        stmia   sp, &#123;r0 - r12&#125;                  @ Calling r0-r12	<span class="comment">//将r0-r12入栈:13*4=52 bytes</span></span><br><span class="line">        @ !!!! R8 NEEDS to be saved !!!! a reserved <span class="built_in">stack</span> spot would be good.</span><br><span class="line">        add     r8, sp, #S_PC			<span class="comment">//r8 = sp + 52</span></span><br><span class="line">        stmdb   r8, &#123;sp, lr&#125;^           @ Calling SP, LR	<span class="comment">//将sp、lr入栈</span></span><br><span class="line">        str     lr, [r8, #<span class="number">0</span>]            @ Save calling PC	<span class="comment">//*(r8) = lr</span></span><br><span class="line">        mrs     r6, spsr				<span class="comment">//r6 = spsr</span></span><br><span class="line">        str     r6, [r8, #<span class="number">4</span>]            @ Save CPSR		<span class="comment">//*(r8+4) = r6 = spsr</span></span><br><span class="line">        str     r0, [r8, #<span class="number">8</span>]            @ Save OLD_R0	<span class="comment">//*(r8+8) = r6</span></span><br><span class="line">        mov     r0, sp</span><br><span class="line">        .endm</span><br><span class="line"></span><br><span class="line">        .macro  irq_restore_user_regs</span><br><span class="line">        ldmia   sp, &#123;r0 - lr&#125;^                  @ Calling r0 - lr	               <span class="comment">//将栈中数据弹出到r0-lr</span></span><br><span class="line">        mov     r0, r0</span><br><span class="line">        ldr     lr, [sp, #S_PC]                 @ Get PC						 <span class="comment">//lr = *(sp+52)</span></span><br><span class="line">        add     sp, sp, #S_FRAME_SIZE										    <span class="comment">//sp += 72</span></span><br><span class="line">        subs    pc, lr, #<span class="number">4</span>              @ <span class="keyword">return</span> &amp; move spsr_svc into cpsr         <span class="comment">//pc = lr -4</span></span><br><span class="line">        .endm</span><br><span class="line"></span><br><span class="line">        .macro get_bad_stack	<span class="comment">//保存lr，spsr寄存器的值到IRQ栈、并切换模式</span></span><br><span class="line">        ldr     r13, IRQ_STACK_START_IN         @ setup our mode <span class="built_in">stack</span>	           <span class="comment">//r13 = *(IRQ_STACK_START_IN)</span></span><br><span class="line"></span><br><span class="line">        str     lr, [r13]       @ save caller lr in position <span class="number">0</span> of saved <span class="built_in">stack</span>	   <span class="comment">//*(r13) = lr</span></span><br><span class="line">        mrs     lr, spsr        @ get the spsr									<span class="comment">//lr = spsr</span></span><br><span class="line">        str     lr, [r13, #<span class="number">4</span>]   @ save spsr in position <span class="number">1</span> of saved <span class="built_in">stack</span>		  <span class="comment">//*(r13+4) = lr</span></span><br><span class="line">        mov     r13, #MODE_SVC  @ prepare SVC-Mode								<span class="comment">//r13 = 0x13</span></span><br><span class="line">        @ msr   spsr_c, r13</span><br><span class="line">        msr     spsr, r13       @ <span class="keyword">switch</span> modes, make sure moves will execute	  <span class="comment">//spsr = r13</span></span><br><span class="line">        mov     lr, pc          @ capture <span class="keyword">return</span> pc                               <span class="comment">//lr = pc</span></span><br><span class="line">        movs    pc, lr          @ jump to next instruction &amp; <span class="keyword">switch</span> modes.        <span class="comment">//pc = lr </span></span><br><span class="line">        .endm</span><br><span class="line"></span><br><span class="line">        .macro get_irq_stack                    @ setup IRQ <span class="built_in">stack</span></span><br><span class="line">        ldr     sp, IRQ_STACK_START			<span class="comment">//sp = *(IRQ_STACK_START)</span></span><br><span class="line">        .endm</span><br><span class="line"></span><br><span class="line">        .macro get_fiq_stack                    @ setup FIQ <span class="built_in">stack</span></span><br><span class="line">        ldr     sp, FIQ_STACK_START			<span class="comment">//sp = *(FIQ_STACK_START)</span></span><br><span class="line">        .endm</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * exception handlers</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">        .align  <span class="number">5</span></span><br><span class="line">undefined_instruction:		</span><br><span class="line">        get_bad_stack</span><br><span class="line">        bad_save_user_regs</span><br><span class="line">        bl      do_undefined_instruction</span><br><span class="line"></span><br><span class="line">        .align  <span class="number">5</span></span><br><span class="line">software_interrupt:</span><br><span class="line">        get_bad_stack</span><br><span class="line">        bad_save_user_regs</span><br><span class="line">        bl      do_software_interrupt	<span class="comment">//跳转处理软件中断</span></span><br><span class="line"></span><br><span class="line">        .align  <span class="number">5</span></span><br><span class="line">prefetch_abort:</span><br><span class="line">        get_bad_stack</span><br><span class="line">        bad_save_user_regs</span><br><span class="line">        bl      do_prefetch_abort</span><br><span class="line"></span><br><span class="line">        .align  <span class="number">5</span></span><br><span class="line">data_abort:</span><br><span class="line">        get_bad_stack</span><br><span class="line">        bad_save_user_regs</span><br><span class="line">        bl      do_data_abort</span><br><span class="line"></span><br><span class="line">        .align  <span class="number">5</span></span><br><span class="line">not_used:</span><br><span class="line">        get_bad_stack</span><br><span class="line">        bad_save_user_regs</span><br><span class="line">        bl      do_not_used</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARCH_SUNXI</span></span><br><span class="line"></span><br><span class="line">                .align  <span class="number">5</span></span><br><span class="line">        irq:</span><br><span class="line">                get_irq_stack</span><br><span class="line">                irq_save_user_regs</span><br><span class="line">                bl      do_irq</span><br><span class="line">                irq_restore_user_regs	<span class="comment">//为何需要多这一步</span></span><br><span class="line"></span><br><span class="line">                .align  <span class="number">5</span></span><br><span class="line">        fiq:</span><br><span class="line">                get_fiq_stack</span><br><span class="line">                <span class="comment">/* someone ought to write a more effiction fiq_save_user_regs */</span></span><br><span class="line">                irq_save_user_regs</span><br><span class="line">                bl      do_fiq</span><br><span class="line">                irq_restore_user_regs	<span class="comment">//为何需要多这一步</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        .align  <span class="number">5</span></span><br><span class="line">irq:</span><br><span class="line">        get_bad_stack</span><br><span class="line">        bad_save_user_regs</span><br><span class="line">        bl      do_irq</span><br><span class="line"></span><br><span class="line">        .align  <span class="number">5</span></span><br><span class="line">fiq:</span><br><span class="line">        get_bad_stack</span><br><span class="line">        bad_save_user_regs</span><br><span class="line">        bl      do_fiq</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  <span class="comment">/* CONFIG_SPL_BUILD */</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="start-S-设置中断向量表，进入reset中断"><a href="#start-S-设置中断向量表，进入reset中断" class="headerlink" title="start.S 设置中断向量表，进入reset中断"></a>start.S 设置中断向量表，进入reset中断</h4><p>_start函数就是直接跳转到reset函数执行，reset函数在：arch&#x2F;arm&#x2F;cpu&#x2F;armv7&#x2F;start.S</p>
<p>该模块的代码主要就是设置上文定义的中断向量表，并使处理器进入SVC模式，设置好ARM的协处理器，然后跳转到lowlevel_init。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line">panrunxins@AwExdroid100:~/longan/brandy/brandy<span class="number">-2.0</span>/u-boot<span class="number">-2018</span>/arch/arm/cpu/armv7$ cat start.S</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm-offsets.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;config.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/system.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/linkage.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/armv7.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Startup Code (reset vector)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Do important init only if we don&#x27;t start from memory!</span></span><br><span class="line"><span class="comment"> * Setup memory and board specific bits prior to relocation.</span></span><br><span class="line"><span class="comment"> * Relocate armboot to ram. Setup stack.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************/</span></span><br><span class="line"></span><br><span class="line">        .globl  reset							</span><br><span class="line">        .globl  save_boot_params_ret</span><br><span class="line">        .type   save_boot_params_ret,%function</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARMV7_LPAE</span></span><br><span class="line">        .global switch_to_hypervisor_ret</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">reset:</span><br><span class="line">        <span class="comment">/* Allow the board to save important registers */</span></span><br><span class="line">        b       save_boot_params</span><br><span class="line">save_boot_params_ret:</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARMV7_LPAE</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * check for Hypervisor support</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        mrc     p15, <span class="number">0</span>, r0, c0, c1, <span class="number">1</span>           @ read ID_PFR1</span><br><span class="line">        and     r0, r0, #CPUID_ARM_VIRT_MASK    @ mask virtualization bits</span><br><span class="line">        cmp     r0, #(<span class="number">1</span> &lt;&lt; CPUID_ARM_VIRT_SHIFT)</span><br><span class="line">        beq     switch_to_hypervisor</span><br><span class="line">switch_to_hypervisor_ret:</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * disable interrupts (FIQ and IRQ), also set the cpu to SVC32 mode,</span></span><br><span class="line"><span class="comment">         * except if in HYP mode already</span></span><br><span class="line"><span class="comment">         * bit4 bit3 bit2 bit1 bit0 is mode bit</span></span><br><span class="line"><span class="comment">         * bit6 bit7 is FRQ,IRQ enable bit</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mrs     r0, cpsr										<span class="comment">//r0 = cpsr</span></span><br><span class="line">        and     r1, r0, #<span class="number">0x1f</span>           @ mask mode bits            <span class="comment">//r1 = r0 &amp; 0x1f 提取bit4 bit3 bit2 bit1 bit0到r1</span></span><br><span class="line">        teq     r1, #<span class="number">0x1a</span>               @ test <span class="keyword">for</span> HYP mode	        <span class="comment">//r1 == 0x1a?	查看是否处于HYP模式</span></span><br><span class="line">        bicne   r0, r0, #<span class="number">0x1f</span>           @ clear all mode bits       <span class="comment">//清除r0的bit0-bit4</span></span><br><span class="line">        orrne   r0, r0, #<span class="number">0x13</span>           @ <span class="built_in">set</span> SVC mode			   <span class="comment">//设置r0为0b10011 SVC模式</span></span><br><span class="line">        orr     r0, r0, #<span class="number">0xc0</span>           @ disable FIQ and IRQ       <span class="comment">//设置r0的bit14 bit15 关闭中断</span></span><br><span class="line">        msr     cpsr,r0											<span class="comment">//cpsr = r0设置cpsr，使生效				</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Setup vector: 向量表的重定位似乎和SPL有关系</span></span><br><span class="line"><span class="comment"> * (OMAP4 spl TEXT_BASE is not 32 byte aligned.</span></span><br><span class="line"><span class="comment"> * Continue to use ROM code vector only in OMAP4 spl)</span></span><br><span class="line"><span class="comment"> * CP15是ARM的协处理器，负责内存管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !(defined(CONFIG_OMAP44XX) &amp;&amp; defined(CONFIG_SPL_BUILD))</span></span><br><span class="line">        <span class="comment">/* Set V=0 in CP15 SCTLR register - for VBAR to point to vector */</span></span><br><span class="line">        mrc     p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span>   @ Read CP15 SCTLR Register</span><br><span class="line">        bic     r0, #CR_V               @ V = <span class="number">0</span></span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span>   @ Write CP15 SCTLR Register</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Set vector address in CP15 VBAR register */</span></span><br><span class="line">        ldr     r0, =_start</span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c12, c0, <span class="number">0</span>  @Set VBAR</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* the mask ROM code should have PLL and others stable */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_SKIP_LOWLEVEL_INIT</span></span><br><span class="line">        bl      cpu_init_cp15</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_SKIP_LOWLEVEL_INIT_ONLY</span></span><br><span class="line">        bl      cpu_init_crit</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        bl      _main</span><br><span class="line"></span><br><span class="line"><span class="comment">/*------------------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line">ENTRY(c_runtime_cpu_setup)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If I-cache is enabled invalidate it</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !CONFIG_IS_ENABLED(SYS_ICACHE_OFF)</span></span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c7, c5, <span class="number">0</span>   @ invalidate icache</span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c7, c10, <span class="number">4</span>  @ DSB</span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c7, c5, <span class="number">4</span>   @ ISB</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        bx      lr</span><br><span class="line"></span><br><span class="line">ENDPROC(c_runtime_cpu_setup)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * void save_boot_params(u32 r0, u32 r1, u32 r2, u32 r3)</span></span><br><span class="line"><span class="comment"> *      __attribute__((weak));</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Stack pointer is not yet initialized at this moment</span></span><br><span class="line"><span class="comment"> * Don&#x27;t save anything to stack even if compiled with -O0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************/</span></span><br><span class="line">ENTRY(save_boot_params)</span><br><span class="line">        b       save_boot_params_ret            @ back to my caller</span><br><span class="line">ENDPROC(save_boot_params)</span><br><span class="line">        .weak   save_boot_params			<span class="comment">//save_boot_params定义为weak，是为了给用户留下接口</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARMV7_LPAE</span></span><br><span class="line">ENTRY(switch_to_hypervisor)</span><br><span class="line">        b       switch_to_hypervisor_ret</span><br><span class="line">ENDPROC(switch_to_hypervisor)</span><br><span class="line">        .weak   switch_to_hypervisor</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * cpu_init_cp15</span></span><br><span class="line"><span class="comment"> * CP15是ARM的存储协处理器，这里初始化CP15协处理器，用于设置MMU</span></span><br><span class="line"><span class="comment"> * Setup CP15 registers (cache, MMU, TLBs). The I-cache is turned on unless</span></span><br><span class="line"><span class="comment"> * CONFIG_SYS_ICACHE_OFF is defined.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************/</span></span><br><span class="line">ENTRY(cpu_init_cp15)</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Invalidate L1 I/D</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mov     r0, #<span class="number">0</span>                  @ <span class="built_in">set</span> up <span class="keyword">for</span> MCR</span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c8, c7, <span class="number">0</span>   @ invalidate TLBs</span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c7, c5, <span class="number">0</span>   @ invalidate icache</span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c7, c5, <span class="number">6</span>   @ invalidate BP <span class="built_in">array</span></span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c7, c10, <span class="number">4</span>  @ DSB</span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c7, c5, <span class="number">4</span>   @ ISB</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * disable MMU stuff and caches</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mrc     p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span></span><br><span class="line">        bic     r0, r0, #<span class="number">0x00002000</span>     @ clear bits <span class="number">13</span> (--V-)</span><br><span class="line">        bic     r0, r0, #<span class="number">0x00000007</span>     @ clear bits <span class="number">2</span>:<span class="number">0</span> (-CAM)</span><br><span class="line">        orr     r0, r0, #<span class="number">0x00000002</span>     @ <span class="built_in">set</span> bit <span class="number">1</span> (--A-) Align</span><br><span class="line">        orr     r0, r0, #<span class="number">0x00000800</span>     @ <span class="built_in">set</span> bit <span class="number">11</span> (Z---) BTB</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_IS_ENABLED(SYS_ICACHE_OFF)</span></span><br><span class="line">        bic     r0, r0, #<span class="number">0x00001000</span>     @ clear bit <span class="number">12</span> (I) I-cache</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        orr     r0, r0, #<span class="number">0x00001000</span>     @ <span class="built_in">set</span> bit <span class="number">12</span> (I) I-cache</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SUNXI_ARM_A53</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         *clear AFE,TRE bit in sctrl</span></span><br><span class="line"><span class="comment">         *non-secure: reset value is unknow</span></span><br><span class="line"><span class="comment">         *secure    : default value is 0</span></span><br><span class="line"><span class="comment">         *notice    : we must set the TRE bit to enable the memory</span></span><br><span class="line"><span class="comment">         *            arttribute configuration from the section table.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        MRC     p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span>   @Read SCTLR</span><br><span class="line">        BIC     r0, r0, #(<span class="number">1</span>&lt;&lt;<span class="number">28</span>)        @clr TRE bit</span><br><span class="line">        BIC     r0, r0, #(<span class="number">1</span>&lt;&lt;<span class="number">29</span>)        @clr AEF bit</span><br><span class="line">        MCR     p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span>   @Write SCTLR</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        mov     r5, lr                  @ Store my Caller</span><br><span class="line">        mrc     p15, <span class="number">0</span>, r1, c0, c0, <span class="number">0</span>   @ r1 has Read Main ID Register (MIDR)</span><br><span class="line">        mov     r3, r1, lsr #<span class="number">20</span>         @ get variant field</span><br><span class="line">        and     r3, r3, #<span class="number">0xf</span>            @ r3 has CPU variant</span><br><span class="line">        and     r4, r1, #<span class="number">0xf</span>            @ r4 has CPU revision</span><br><span class="line">        mov     r2, r3, lsl #<span class="number">4</span>          @ shift variant field <span class="keyword">for</span> combined value</span><br><span class="line">        orr     r2, r4, r2              @ r2 has combined CPU variant + revision</span><br><span class="line"></span><br><span class="line">        mov     pc, r5                  @ back to my caller</span><br><span class="line">ENDPROC(cpu_init_cp15)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_SKIP_LOWLEVEL_INIT) &amp;&amp; \</span></span><br><span class="line"><span class="meta">        !defined(CONFIG_SKIP_LOWLEVEL_INIT_ONLY)</span></span><br><span class="line"><span class="comment">/*************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * CPU_init_critical registers</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * setup important registers</span></span><br><span class="line"><span class="comment"> * setup memory timing</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************/</span></span><br><span class="line">ENTRY(cpu_init_crit)</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Jump to board specific initialization...</span></span><br><span class="line"><span class="comment">         * The Mask ROM will have already initialized</span></span><br><span class="line"><span class="comment">         * basic memory. Go here to bump up clock rate and handle</span></span><br><span class="line"><span class="comment">         * wake up conditions.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        b       lowlevel_init           @ go setup pll,mux,memory</span><br><span class="line">ENDPROC(cpu_init_crit)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="lowlevel-init-初始化C环境"><a href="#lowlevel-init-初始化C环境" class="headerlink" title="lowlevel_init() 初始化C环境"></a>lowlevel_init() 初始化C环境</h4><p>SPL与uboot的关系、SPL如何影响uboot呢？跳转到的s_init是在哪里？</p>
<p>lowlevel_init()中初始化SP寄存器，建立C语言临时使用的栈；</p>
<p>建立全局数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">panrunxins@AwExdroid100:~/longan/brandy/brandy<span class="number">-2.0</span>/u-boot<span class="number">-2018</span>/arch/arm/cpu/armv7$ cat lowlevel_init.S</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm-offsets.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;config.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/linkage.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">.pushsection .text.s_init, <span class="string">&quot;ax&quot;</span></span><br><span class="line">WEAK(s_init)</span><br><span class="line">        bx      lr</span><br><span class="line"><span class="title function_">ENDPROC</span><span class="params">(s_init)</span></span><br><span class="line">.popsection</span><br><span class="line"></span><br><span class="line">.pushsection .text.lowlevel_init, &quot;ax&quot;</span><br><span class="line"><span class="title function_">WEAK</span><span class="params">(lowlevel_init)</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Setup a temporary stack. Global data is not available yet.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SPL_BUILD) &amp;&amp; defined(CONFIG_SPL_STACK)</span></span><br><span class="line">        ldr     sp, =CONFIG_SPL_STACK</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        ldr     sp, =CONFIG_SYS_INIT_SP_ADDR	<span class="comment">//设置堆栈地址</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        bic     sp, sp, #<span class="number">7</span> <span class="comment">/* 8-byte alignment for ABI compliance */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SPL_DM</span></span><br><span class="line">        mov     r9, #<span class="number">0</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Set up global data for boards that still need it. This will be</span></span><br><span class="line"><span class="comment">         * removed soon.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SPL_BUILD</span></span><br><span class="line">        ldr     r9, =gdata</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        sub     sp, sp, #GD_SIZE	<span class="comment">//栈指针向下移动gd大小</span></span><br><span class="line">        bic     sp, sp, #<span class="number">7</span>			<span class="comment">//8字节对齐</span></span><br><span class="line">        mov     r9, sp				<span class="comment">//r9保存了gd的地址</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Save the old lr(passed in ip) and the current lr to stack</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        push    &#123;ip, lr&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Call the very early init function. This should do only the</span></span><br><span class="line"><span class="comment">         * absolute bare minimum to get started. It should not:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * - set up DRAM</span></span><br><span class="line"><span class="comment">         * - use global_data</span></span><br><span class="line"><span class="comment">         * - clear BSS</span></span><br><span class="line"><span class="comment">         * - try to start a console</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * For boards with SPL this should be empty since SPL can do all of</span></span><br><span class="line"><span class="comment">         * this init in the SPL board_init_f() function which is called</span></span><br><span class="line"><span class="comment">         * immediately after this.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        bl      s_init</span><br><span class="line">        pop     &#123;ip, pc&#125;</span><br><span class="line">ENDPROC(lowlevel_init)</span><br><span class="line">.popsection</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="globl-data"><a href="#globl-data" class="headerlink" title="globl data"></a>globl data</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">global_data</span> &#123;</span></span><br><span class="line">        <span class="type">bd_t</span> *bd;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> baudrate;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> cpu_clk;          <span class="comment">/* CPU clock in Hz!             */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> bus_clk;</span><br><span class="line">        <span class="comment">/* We cannot bracket this with CONFIG_PCI due to mpc5xxx */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> pci_clk;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> mem_clk;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_LCD) || defined(CONFIG_VIDEO)</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> fb_base;          <span class="comment">/* Base address of framebuffer mem */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_POST)</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> post_log_word;    <span class="comment">/* Record POST activities */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> post_log_res;     <span class="comment">/* success of POST test */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> post_init_f_time; <span class="comment">/* When post_init_f started */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BOARD_TYPES</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> board_type;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> have_console;     <span class="comment">/* serial_init() was called */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_IS_ENABLED(PRE_CONSOLE_BUFFER)</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> precon_buf_idx;   <span class="comment">/* Pre-Console buffer index */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> env_addr;         <span class="comment">/* Address  of Environment struct */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> env_valid;        <span class="comment">/* Environment valid? enum env_valid */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> env_has_init;     <span class="comment">/* Bitmask of boolean of struct env_location offsets */</span></span><br><span class="line">        <span class="type">int</span> env_load_location;</span><br><span class="line"></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> ram_base;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> ram_top;          <span class="comment">/* Top address of RAM used by U-Boot */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> relocaddr;        <span class="comment">/* Start address of U-Boot in RAM */</span></span><br><span class="line">        <span class="type">phys_size_t</span> ram_size;           <span class="comment">/* RAM size */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> mon_len;          <span class="comment">/* monitor len */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> irq_sp;           <span class="comment">/* irq stack pointer */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> start_addr_sp;    <span class="comment">/* start_addr_stackpointer */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> reloc_off;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">global_data</span> *<span class="title">new_gd</span>;</span>     <span class="comment">/* relocated global data */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DM</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">udevice</span>  *<span class="title">dm_root</span>;</span>       <span class="comment">/* Root instance for Driver Model */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">udevice</span>  *<span class="title">dm_root_f</span>;</span>     <span class="comment">/* Pre-relocation root instance */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">uclass_root</span>;</span>   <span class="comment">/* Head of core tree */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_TIMER</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">udevice</span>  *<span class="title">timer</span>;</span>         <span class="comment">/* Timer instance for Driver Model */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="type">const</span> <span class="type">void</span> *fdt_blob;           <span class="comment">/* Our device tree, NULL if none */</span></span><br><span class="line">        <span class="type">void</span> *new_fdt;                  <span class="comment">/* Relocated FDT */</span></span><br><span class="line">        <span class="type">void</span> *new_ext_fdt;              <span class="comment">/* Relocated EXTERNAL FDT */</span></span><br><span class="line">        <span class="type">void</span> *new_dtbo;                 <span class="comment">/*Relocated dtbo */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> fdt_size;         <span class="comment">/* Space reserved for relocated FDT */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> fdt_ext_size;     <span class="comment">/* Space reserved for relocated EXTERNAL FDT */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_OF_LIVE</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">of_root</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">jt_funcs</span> *<span class="title">jt</span>;</span>            <span class="comment">/* jump table */</span></span><br><span class="line">        <span class="type">char</span> env_buf[<span class="number">32</span>];               <span class="comment">/* buffer for env_get() before reloc. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_TRACE</span></span><br><span class="line">        <span class="type">void</span>            *trace_buff;    <span class="comment">/* The trace buffer */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SYS_I2C)</span></span><br><span class="line">        <span class="type">int</span>             cur_i2c_bus;    <span class="comment">/* current used i2c bus */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYS_I2C_MXC</span></span><br><span class="line">        <span class="type">void</span> *srdata[<span class="number">10</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> timebase_h;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> timebase_l;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_VAL(SYS_MALLOC_F_LEN)</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> malloc_base;      <span class="comment">/* base address of early malloc() */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> malloc_limit;     <span class="comment">/* limit address */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> malloc_ptr;       <span class="comment">/* current address */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PCI</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pci_controller</span> *<span class="title">hose</span>;</span>    <span class="comment">/* PCI hose for early use */</span></span><br><span class="line">        <span class="type">phys_addr_t</span> pci_ram_top;        <span class="comment">/* top of region accessible to PCI */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PCI_BOOTDELAY</span></span><br><span class="line">        <span class="type">int</span> pcidelay_done;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">udevice</span> *<span class="title">cur_serial_dev</span>;</span> <span class="comment">/* current serial device */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">arch_global_data</span> <span class="title">arch</span>;</span>   <span class="comment">/* architecture-specific data */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CONSOLE_RECORD</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">membuff</span> <span class="title">console_out</span>;</span>     <span class="comment">/* console output */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">membuff</span> <span class="title">console_in</span>;</span>      <span class="comment">/* console input */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DM_VIDEO</span></span><br><span class="line">        ulong video_top;                <span class="comment">/* Top of video frame buffer area */</span></span><br><span class="line">        ulong video_bottom;             <span class="comment">/* Bottom of video frame buffer area */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BOOTSTAGE</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">bootstage_data</span> *<span class="title">bootstage</span>;</span>       <span class="comment">/* Bootstage information */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">bootstage_data</span> *<span class="title">new_bootstage</span>;</span>   <span class="comment">/* Relocated bootstage info */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_LOG</span></span><br><span class="line">        <span class="type">int</span> log_drop_count;             <span class="comment">/* Number of dropped log messages */</span></span><br><span class="line">        <span class="type">int</span> default_log_level;          <span class="comment">/* For devices with no filters */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">log_head</span>;</span>      <span class="comment">/* List of struct log_device */</span></span><br><span class="line">        <span class="type">int</span> log_fmt;                    <span class="comment">/* Mask containing log format info */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARCH_SUNXI</span></span><br><span class="line">        <span class="type">long</span>           securemode;</span><br><span class="line">        <span class="type">void</span>          *parameter_mod_buf;</span><br><span class="line">        <span class="type">long</span>           boot_card_num;</span><br><span class="line">        ulong          lockflag;</span><br><span class="line">        ulong          chargemode;</span><br><span class="line"></span><br><span class="line">        ulong          parameter_reloc_buf;</span><br><span class="line">        ulong          parameter_reloc_size;</span><br><span class="line"></span><br><span class="line">        ulong          malloc_noncache_start;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span>           key_pressd_value;</span><br><span class="line">        <span class="type">long</span>           axp_power_soft_id;</span><br><span class="line">        <span class="type">long</span>           power_step_level;</span><br><span class="line">        <span class="type">long</span>           pmu_suspend_chgcur;</span><br><span class="line">        <span class="type">long</span>           pmu_runtime_chgcur;</span><br><span class="line">        <span class="type">long</span>           limit_vol;</span><br><span class="line">        <span class="type">long</span>           limit_cur;</span><br><span class="line">        <span class="type">long</span>           limit_pcvol;</span><br><span class="line">        <span class="type">long</span>           limit_pccur;</span><br><span class="line">        ulong          force_download_uboot;</span><br><span class="line">        ulong          vbus_status;<span class="comment">//0: unknow 1:exist 2:not exist</span></span><br><span class="line">        ulong          debug_mode;</span><br><span class="line">        <span class="type">long</span>           force_shell;</span><br><span class="line">        <span class="type">long</span>           user_debug_mode;</span><br><span class="line">        ulong          layer_para;</span><br><span class="line">        ulong          layer_hd;</span><br><span class="line">        ulong          bootfile_mode;</span><br><span class="line">        <span class="type">int</span>            pmu_saved_status;</span><br><span class="line">        <span class="type">int</span>                need_shutdown;</span><br><span class="line">        <span class="type">int</span>            logo_status_multiboot;</span><br><span class="line">        <span class="type">int</span>            ir_detect_status;</span><br><span class="line">        <span class="type">bool</span>                    uboot_shell;</span><br><span class="line">        ulong          boot_logo_addr;</span><br><span class="line">        <span class="type">bool</span>           force_32bit_os;<span class="comment">//1: run 32bit os at 64bit platform</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125; <span class="type">gd_t</span>;</span><br></pre></td></tr></table></figure>



<h4 id="s-init-初始化串口时钟"><a href="#s-init-初始化串口时钟" class="headerlink" title="s_init() 初始化串口时钟"></a>s_init() 初始化串口时钟</h4><p>lowlevel_init()最终调用s_init()，s_init()在&#x2F;arch&#x2F;arm&#x2F;mach-sunxi&#x2F;board.c中。由于在lowlevel_init（）中初始化了栈，所以在这里可以使用c语言。</p>
<p>这里就是初始化时钟、定时器、gpio，以太网。除了串口时钟初始化，其他的函数啥也没具体实现。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gpio_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">s_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_ARM_CORTEX_CPU_IS_UP) &amp;&amp; !defined(CONFIG_ARM64)</span></span><br><span class="line">        <span class="comment">/* Enable SMP mode for CPU0, by setting bit 6 of Auxiliary Ctl reg */</span></span><br><span class="line">        <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">                <span class="string">&quot;mrc p15, 0, r0, c1, c0, 1\n&quot;</span></span></span><br><span class="line"><span class="params">                <span class="string">&quot;orr r0, r0, #1 &lt;&lt; 6\n&quot;</span></span></span><br><span class="line"><span class="params">                <span class="string">&quot;mcr p15, 0, r0, c1, c0, 1\n&quot;</span></span></span><br><span class="line"><span class="params">                ::: <span class="string">&quot;r0&quot;</span>)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        clock_init();</span><br><span class="line">        timer_init();</span><br><span class="line">        gpio_init();</span><br><span class="line"></span><br><span class="line">        eth_init_board();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>&#x2F;arch&#x2F;arm&#x2F;mach-sunxi&#x2F;clock.c:clock_init()，假如不需要编译SPL，则初始化串口、秒</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">clock_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SPL_BUILD</span></span><br><span class="line">        clock_init_safe();</span><br><span class="line">        gtbus_init();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        clock_init_uart();</span><br><span class="line">        clock_init_sec();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>&#x2F;lib&#x2F;timer.c:timer_init()，是一个虚函数，可以被用户覆盖，但是从uboot.map来看它未被覆盖、所以可认为这里他啥也没干。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> __weak <span class="title function_">timer_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>arch&#x2F;arm&#x2F;include&#x2F;asm&#x2F;arch-sunxi&#x2F;sys_proto.h:eth_init_board()，似乎是一个啥也没干的函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* Board / SoC level designware gmac init */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined CONFIG_SPL_BUILD &amp;&amp; defined CONFIG_SUN7I_GMAC</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">eth_init_board</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">eth_init_board</span><span class="params">(<span class="type">void</span>)</span> &#123;&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>arch&#x2F;arm&#x2F;mach-sunxi&#x2F;clock_sunxxxxxx.c:clock_init_uart() 中实现了初始化串口时钟</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">clock_init_uart</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sunxi_ccm_reg</span> *<span class="title">const</span> <span class="title">ccm</span> =</span></span><br><span class="line">                (<span class="keyword">struct</span> sunxi_ccm_reg *)SUNXI_CCM_BASE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* uart clock source is apb2 */</span></span><br><span class="line">        writel(APB2_CLK_SRC_OSC24M|</span><br><span class="line">               APB2_CLK_RATE_N_1|</span><br><span class="line">               APB2_CLK_RATE_M(<span class="number">1</span>),</span><br><span class="line">               &amp;ccm-&gt;apb2_cfg);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* open the clock for uart */</span></span><br><span class="line">        setbits_le32(&amp;ccm-&gt;uart_gate_reset,</span><br><span class="line">                     <span class="number">1</span> &lt;&lt; (CONFIG_CONS_INDEX - <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* deassert uart reset */</span></span><br><span class="line">        setbits_le32(&amp;ccm-&gt;uart_gate_reset,</span><br><span class="line">                     <span class="number">1</span> &lt;&lt; (RESET_SHIFT + CONFIG_CONS_INDEX - <span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="main"><a href="#main" class="headerlink" title="_main"></a>_main</h3><p>初始化完成串口时钟后，s_init返回到lowlevel_init，再返回到cpu_init_crit，然后执行下一个函数_main。</p>
<p>貌似是个很重要的函数，认真看下说明:</p>
<p>网上找到一篇不错的博客：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1432827">https://cloud.tencent.com/developer/article/1432827</a></p>
<p>需要注意的有：</p>
<ul>
<li>在执行board_init_f()之前的uboot可能运行在ROM等不可写的存储器中，即程序无法进行写操作，无法使用栈，全局变量。解决办法是使用CPU内的SRAM作为栈，在栈前留一段内存作为global data来存放所需要的全局变量。这样就可以使用c函数调用</li>
<li>uboot需要重定位</li>
<li>通过函数指针数据的形式，提供API接口给用户，由用户具体实现功能</li>
<li>global data</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;config.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm-offsets.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/linkage.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CPU_V7M</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/armv7m.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This file handles the target-independent stages of the U-Boot</span></span><br><span class="line"><span class="comment"> * start-up where a C runtime environment is needed. Its entry point</span></span><br><span class="line"><span class="comment"> * is _main and is branched into from the target&#x27;s start.S file.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * _main execution sequence is:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * board_init_f() 的函数名含义是：board init front 前置板子初始化</span></span><br><span class="line"><span class="comment"> * 1. Set up initial environment for calling board_init_f().</span></span><br><span class="line"><span class="comment"> *    This environment only provides a stack and a place to store</span></span><br><span class="line"><span class="comment"> *    the GD (&#x27;global data&#x27;) structure, both located in some readily</span></span><br><span class="line"><span class="comment"> *    available RAM (SRAM, locked cache...). In this context, VARIABLE</span></span><br><span class="line"><span class="comment"> *    global data, initialized or not (BSS), are UNAVAILABLE; only</span></span><br><span class="line"><span class="comment"> *    CONSTANT initialized data are available. GD should be zeroed</span></span><br><span class="line"><span class="comment"> *    before board_init_f() is called.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 2. Call board_init_f(). This function prepares the hardware for</span></span><br><span class="line"><span class="comment"> *    execution from system RAM (DRAM, DDR...) As system RAM may not</span></span><br><span class="line"><span class="comment"> *    be available yet, , board_init_f() must use the current GD to</span></span><br><span class="line"><span class="comment"> *    store any data which must be passed on to later stages. These</span></span><br><span class="line"><span class="comment"> *    data include the relocation destination, the future stack, and</span></span><br><span class="line"><span class="comment"> *    the future GD location.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 3. Set up intermediate environment where the stack and GD are the</span></span><br><span class="line"><span class="comment"> *    ones allocated by board_init_f() in system RAM, but BSS and</span></span><br><span class="line"><span class="comment"> *    initialized non-const data are still not available.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 4a.For U-Boot proper (not SPL), call relocate_code(). This function</span></span><br><span class="line"><span class="comment"> *    relocates U-Boot from its current location into the relocation</span></span><br><span class="line"><span class="comment"> *    destination computed by board_init_f().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 4b.For SPL, board_init_f() just returns (to crt0). There is no</span></span><br><span class="line"><span class="comment"> *    code relocation in SPL.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * board_init_r() rear:后置</span></span><br><span class="line"><span class="comment"> * 5. Set up final environment for calling board_init_r(). This</span></span><br><span class="line"><span class="comment"> *    environment has BSS (initialized to 0), initialized non-const</span></span><br><span class="line"><span class="comment"> *    data (initialized to their intended value), and stack in system</span></span><br><span class="line"><span class="comment"> *    RAM (for SPL moving the stack and GD into RAM is optional - see</span></span><br><span class="line"><span class="comment"> *    CONFIG_SPL_STACK_R). GD has retained values set by board_init_f().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 6. For U-Boot proper (not SPL), some CPUs have some work left to do</span></span><br><span class="line"><span class="comment"> *    at this point regarding memory, so call c_runtime_cpu_setup.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 7. Branch to board_init_r().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * For more information see &#x27;Board Initialisation Flow in README.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ENTRY(_main)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Set up initial C runtime environment and call board_init_f(0).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SPL_BUILD) &amp;&amp; defined(CONFIG_SPL_STACK)</span></span><br><span class="line">        ldr     r0, =(CONFIG_SPL_STACK)</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        ldr     r0, =(CONFIG_SYS_INIT_SP_ADDR)									<span class="comment">//r0 = CONFIG_SYS_INIT_SP_ADDR</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        bic     r0, r0, #<span class="number">7</span>      <span class="comment">/* 8-byte alignment for ABI compliance */</span> 		  <span class="comment">//r0 &amp;= 0x80 8字节对齐</span></span><br><span class="line">        mov     sp, r0														 <span class="comment">//sp = r0		</span></span><br><span class="line">        bl      board_init_f_alloc_reserve									   <span class="comment">//为global data预留空间，函数返回值是空间地址，保存在r0中</span></span><br><span class="line">        mov     sp, r0														 <span class="comment">//sp = r0 更新栈指针</span></span><br><span class="line">        <span class="comment">/* set up gd here, outside any C code */</span></span><br><span class="line">        mov     r9, r0                                                            <span class="comment">//r9 = r0，r9指向预留的gd空间</span></span><br><span class="line">        bl       board_init_f_init_reserve									   <span class="comment">//初始化global data，就是清零</span></span><br><span class="line"></span><br><span class="line">        mov     r0, #<span class="number">0</span>														 <span class="comment">//r0 = 0 r9 = gd地址</span></span><br><span class="line">        bl      board_init_f												 <span class="comment">//跳转到board_init_f 见下文</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ! defined(CONFIG_SPL_BUILD)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Set up intermediate environment (new sp and gd) and call</span></span><br><span class="line"><span class="comment"> * relocate_code(addr_moni). Trick here is that we&#x27;ll return</span></span><br><span class="line"><span class="comment"> * &#x27;here&#x27; but relocated.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">	    <span class="comment">//r9 = gd</span></span><br><span class="line">        ldr     r0, [r9, #GD_START_ADDR_SP]     <span class="comment">/* sp = gd-&gt;start_addr_sp */</span></span><br><span class="line">        bic     r0, r0, #<span class="number">7</span>      <span class="comment">/* 8-byte alignment for ABI compliance */</span></span><br><span class="line">        mov     sp, r0			<span class="comment">//设置堆栈指针					</span></span><br><span class="line">        ldr     r9, [r9, #GD_BD]                <span class="comment">/* r9 = gd-&gt;bd */</span></span><br><span class="line">        sub     r9, r9, #GD_SIZE                <span class="comment">/* new GD is below bd */</span></span><br><span class="line"></span><br><span class="line">        adr     lr, here	<span class="comment">//把here复制到lr</span></span><br><span class="line">    </span><br><span class="line">        ldr     r0, [r9, #GD_RELOC_OFF]         <span class="comment">/* r0 = gd-&gt;reloc_off */</span></span><br><span class="line">        add     lr, lr, r0			<span class="comment">//lr+重定位的偏移地址 = 重定位后的here地址</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_CPU_V7M)</span></span><br><span class="line">        orr     lr, #<span class="number">1</span>                          <span class="comment">/* As required by Thumb-only */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        ldr     r0, [r9, #GD_RELOCADDR]         <span class="comment">/* r0 = gd-&gt;relocaddr */</span></span><br><span class="line">        b       relocate_code				  <span class="comment">//重定位uboot代码</span></span><br><span class="line">here:</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * uboot重定位完成</span></span><br><span class="line"><span class="comment"> * now relocate vectors</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">        bl      relocate_vectors			  <span class="comment">//重定位中断向量表</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Set up final (full) environment */</span></span><br><span class="line"></span><br><span class="line">        bl      c_runtime_cpu_setup     <span class="comment">/* we still call old routine here */</span> <span class="comment">//c_runtime_cpu_setup在start.S中定义，返回调用者</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_SPL_BUILD) || defined(CONFIG_SPL_FRAMEWORK)</span></span><br><span class="line"><span class="meta"># <span class="keyword">ifdef</span> CONFIG_SPL_BUILD</span></span><br><span class="line">        <span class="comment">/* Use a DRAM stack for the rest of SPL, if requested */</span></span><br><span class="line">        bl      spl_relocate_stack_gd</span><br><span class="line">        cmp     r0, #<span class="number">0</span></span><br><span class="line">        movne   sp, r0</span><br><span class="line">        movne   r9, r0</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line">        ldr     r0, =__bss_start        <span class="comment">/* this is auto-relocated! */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_USE_ARCH_MEMSET</span></span><br><span class="line">        ldr     r3, =__bss_end          <span class="comment">/* this is auto-relocated! */</span></span><br><span class="line">        mov     r1, #<span class="number">0x00000000</span>         <span class="comment">/* prepare zero to clear BSS */</span></span><br><span class="line"></span><br><span class="line">        subs    r2, r3, r0              <span class="comment">/* r2 = memset len */</span></span><br><span class="line">            </span><br><span class="line">        <span class="comment">//r0 = bss_start,r2 = len,r3 = bss_end</span></span><br><span class="line">        bl      <span class="built_in">memset</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        ldr     r1, =__bss_end          <span class="comment">/* this is auto-relocated! */</span></span><br><span class="line">        mov     r2, #<span class="number">0x00000000</span>         <span class="comment">/* prepare zero to clear BSS */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//初始化bss段</span></span><br><span class="line">clbss_l:cmp     r0, r1                  <span class="comment">/* while not at end of BSS */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_CPU_V7M)</span></span><br><span class="line">        itt     lo</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        strlo   r2, [r0]                <span class="comment">/* clear 32-bit BSS word */</span></span><br><span class="line">        addlo   r0, r0, #<span class="number">4</span>              <span class="comment">/* move to next */</span></span><br><span class="line">        blo     clbss_l</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ! defined(CONFIG_SPL_BUILD)</span></span><br><span class="line">        bl coloured_LED_init			<span class="comment">//这个是虚函数 需要由用户实现</span></span><br><span class="line">        bl red_led_on</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">/* call board_init_r(gd_t *id, ulong dest_addr) */</span></span><br><span class="line">        mov     r0, r9                  <span class="comment">/* r0 = gd_t */</span></span><br><span class="line">        ldr     r1, [r9, #GD_RELOCADDR] <span class="comment">/* r1 = dest_addr */</span></span><br><span class="line">        <span class="comment">/* call board_init_r */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_IS_ENABLED(SYS_THUMB_BUILD)</span></span><br><span class="line">    	<span class="comment">//r0 = gd_t ,r1 = dest_addr</span></span><br><span class="line">        ldr     lr, =board_init_r       <span class="comment">/* this is auto-relocated! */</span>	<span class="comment">//跳转到board_init_r</span></span><br><span class="line">        bx      lr</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        ldr     pc, =board_init_r       <span class="comment">/* this is auto-relocated! */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">/* we should not return here. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">ENDPROC(_main)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//top = r0，将r0向下移动一个gd大小，地址再以16取整</span></span><br><span class="line">ulong <span class="title function_">board_init_f_alloc_reserve</span><span class="params">(ulong top)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">/* Reserve early malloc arena */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_VAL(SYS_MALLOC_F_LEN)</span></span><br><span class="line">        top -= CONFIG_VAL(SYS_MALLOC_F_LEN);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">/* LAST : reserve GD (rounded up to a multiple of 16 bytes) */</span></span><br><span class="line">        top = rounddown(top-<span class="keyword">sizeof</span>(<span class="keyword">struct</span> global_data), <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> top;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">board_init_f_init_reserve</span><span class="params">(ulong base)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">global_data</span> *<span class="title">gd_ptr</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * clear GD entirely and set it up.</span></span><br><span class="line"><span class="comment">         * Use gd_ptr, as gd may not be properly set yet.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        gd_ptr = (<span class="keyword">struct</span> global_data *)base;</span><br><span class="line">        <span class="comment">/* zero the area */</span></span><br><span class="line">        <span class="built_in">memset</span>(gd_ptr, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(*gd));</span><br><span class="line">        <span class="comment">/* set GD unless architecture did it already */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_ARM)</span></span><br><span class="line">        arch_setup_gd(gd_ptr);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">/* next alloc will be higher by one GD plus 16-byte alignment */</span></span><br><span class="line">        base += roundup(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> global_data), <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * record early malloc arena start.</span></span><br><span class="line"><span class="comment">         * Use gd as it is now properly set for all architectures.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_VAL(SYS_MALLOC_F_LEN)</span></span><br><span class="line">        <span class="comment">/* go down one &#x27;early malloc arena&#x27; */</span></span><br><span class="line">        gd-&gt;malloc_base = base;</span><br><span class="line">        <span class="comment">/* next alloc will be higher by one &#x27;early malloc arena&#x27; size */</span></span><br><span class="line">        base += CONFIG_VAL(SYS_MALLOC_F_LEN);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="board-init-f"><a href="#board-init-f" class="headerlink" title="board_init_f()"></a>board_init_f()</h5><p>common&#x2F;board_f.c:board_init_f()</p>
<p>主要就是执行init_sequence_f里面的函数。初始化外设和全局变量gd</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">board_init_f</span><span class="params">(ulong boot_flags)</span></span><br><span class="line">&#123;</span><br><span class="line">        gd-&gt;flags = boot_flags;</span><br><span class="line">        gd-&gt;have_console = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (initcall_run_list(init_sequence_f))</span><br><span class="line">                hang();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//函数指针数组</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">init_fnc_t</span> init_sequence_f[] = &#123;</span><br><span class="line">        setup_mon_len,	<span class="comment">//gd-&gt;mon_len = (ulong)&amp;__bss_end - (ulong)__image_copy_start; 应该是uboot镜像的大小？</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_OF_CONTROL</span></span><br><span class="line">        fdtdec_setup,	<span class="comment">//gd-&gt;fdt_blob = __dtb_dt_begin;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_TRACE</span></span><br><span class="line">        trace_early_init,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        initf_malloc,			<span class="comment">//与SYS_MALLOC_F_LEN有关</span></span><br><span class="line">        log_init,				<span class="comment">//初始化日志驱动</span></span><br><span class="line">        initf_bootstage,        <span class="comment">/*??? uses its own timer, so does not need DM */</span></span><br><span class="line">        initf_console_record,   <span class="comment">//申请内存给控制台</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_HAVE_FSP)</span></span><br><span class="line">        arch_fsp_init,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        arch_cpu_init,          <span class="comment">//未实现</span></span><br><span class="line">        mach_cpu_init,          <span class="comment">//未实现</span></span><br><span class="line">        initf_dm,				<span class="comment">//初始化driver model</span></span><br><span class="line">        arch_cpu_init_dm,       <span class="comment">//未实现</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_BOARD_EARLY_INIT_F)</span></span><br><span class="line">        board_early_init_f,     <span class="comment">//未实现</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_PPC) || defined(CONFIG_SYS_FSL_CLK) || defined(CONFIG_M68K)</span></span><br><span class="line">        <span class="comment">/* get CPU and bus clocks according to the environment variable */</span></span><br><span class="line">        get_clocks,             <span class="comment">/* get CPU and bus clocks (etc.) */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_M68K)</span></span><br><span class="line">        timer_init,             <span class="comment">//关闭定时器中断</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_BOARD_POSTCLK_INIT)</span></span><br><span class="line">        board_postclk_init,     <span class="comment">//未实现</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        env_init,               <span class="comment">/* 环境变量初始化 initialize environment */</span></span><br><span class="line">        init_baud_rate,         <span class="comment">/* gd-&gt;baudrate = env_get_ulong(&quot;baudrate&quot;, 10, CONFIG_BAUDRATE) */</span></span><br><span class="line">        serial_init,            <span class="comment">/* 初始化默认串口，并设置gd的标志位 serial communications setup */</span></span><br><span class="line">        console_init_f,         <span class="comment">/* 控制台是否是debug模式、stage 1 init of console */</span></span><br><span class="line">        display_options,        <span class="comment">//打印&quot;U-Boot 2018.05-00014-g8bece42007 (Dec 27 2021 - 12:37:06 +0000) Allwinner Technology, Build: jenkins-autocreatejob_dailybuild_platform_s-254&quot;</span></span><br><span class="line">        display_text_info,      <span class="comment">//打印uboot代码段信息（开启debug）</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_PPC) || defined(CONFIG_SH) || defined(CONFIG_X86)</span></span><br><span class="line">        checkcpu,   <span class="comment">//未实现</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_DISPLAY_CPUINFO)</span></span><br><span class="line">        print_cpuinfo,          <span class="comment">//CPU:   Allwinner Family</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_DTB_RESELECT)</span></span><br><span class="line">        embedded_dtb_select,    <span class="comment">//未实现</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_DISPLAY_BOARDINFO)</span></span><br><span class="line">        show_board_info,	<span class="comment">//打印板子信息 ：Model: sun50iw9</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_INIT</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_MISC_INIT_F)</span></span><br><span class="line">        misc_init_f,		<span class="comment">//misc driver初始化</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SYS_I2C)</span></span><br><span class="line">        init_func_i2c,		<span class="comment">//调用i2c_init_all，i2c driver初始化</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_VID) &amp;&amp; !defined(CONFIG_SPL)</span></span><br><span class="line">        init_func_vid,	<span class="comment">//未实现</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_HARD_SPI)</span></span><br><span class="line">        init_func_spi,		<span class="comment">//spi driver初始化（未实现）</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_OPTEE25)</span></span><br><span class="line">        smc_init,   <span class="comment">//若有安全系统，获取sunxi_smc_call_offset</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        announce_dram_init,		<span class="comment">//打印要对dram初始化：DRAM:  </span></span><br><span class="line">        dram_init,              <span class="comment">/* 将dram信息保存在gd中 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_POST	<span class="comment">//CONFIG_POST不使用</span></span></span><br><span class="line">        post_init_f,	</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SYS_DRAM_TEST)</span></span><br><span class="line">        testdram,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_SYS_DRAM_TEST */</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_POST</span></span><br><span class="line">        init_post,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Now that we have DRAM mapped and working, we can</span></span><br><span class="line"><span class="comment">         * relocate the code and continue running from DRAM.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Reserve memory at end of RAM for (top down in that order):</span></span><br><span class="line"><span class="comment">         *  - area that won&#x27;t get touched by U-Boot and Linux (optional)</span></span><br><span class="line"><span class="comment">         *  - kernel log buffer</span></span><br><span class="line"><span class="comment">         *  - protected RAM</span></span><br><span class="line"><span class="comment">         *  - LCD framebuffer</span></span><br><span class="line"><span class="comment">         *  - monitor code</span></span><br><span class="line"><span class="comment">         *  - board info struct</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        setup_dest_addr,	<span class="comment">//获取uboot重定位地址</span></span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//在ddr高地址处留出空间</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PRAM</span></span><br><span class="line">        reserve_pram,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        reserve_round_4k,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARM</span></span><br><span class="line">        reserve_mmu,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        reserve_video,</span><br><span class="line">        reserve_trace,</span><br><span class="line">        reserve_uboot,</span><br><span class="line">        reserve_malloc,</span><br><span class="line">        reserve_board,</span><br><span class="line">        setup_machine,</span><br><span class="line">        reserve_global_data,</span><br><span class="line">        reserve_fdt,</span><br><span class="line">        reserve_bootstage,</span><br><span class="line">        reserve_arch,</span><br><span class="line">        reserve_stacks,</span><br><span class="line">        dram_init_banksize,</span><br><span class="line">        show_dram_config,	<span class="comment">//debug打印dram区信息</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_M68K) || defined(CONFIG_MIPS) || defined(CONFIG_PPC) || \</span></span><br><span class="line"><span class="meta">        defined(CONFIG_SH)</span></span><br><span class="line">        setup_board_part1,	<span class="comment">//保存DRAM的地址信息到gd-&gt;bd</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_PPC) || defined(CONFIG_M68K)</span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">        setup_board_part2,	<span class="comment">//保存时钟信息到gd-&gt;bd</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        display_new_sp,		<span class="comment">//打印sp</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_OF_BOARD_FIXUP</span></span><br><span class="line">        fix_fdt,	<span class="comment">//未实现</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">        reloc_fdt,		<span class="comment">//设备树重定位:把设备树复制到新地址</span></span><br><span class="line">        reloc_bootstage,	<span class="comment">//把bootstage复制到新地址</span></span><br><span class="line">        setup_reloc,	<span class="comment">//计算Relocation Offset, 把gd拷贝到新地址</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_ARM) &amp;&amp; !defined(CONFIG_SANDBOX) &amp;&amp; \</span></span><br><span class="line"><span class="meta">                !CONFIG_IS_ENABLED(X86_64)</span></span><br><span class="line">        jump_to_copy,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">board_init_f</span><span class="params">(ulong boot_flags)</span></span><br><span class="line">&#123;</span><br><span class="line">        gd-&gt;flags = boot_flags;</span><br><span class="line">        gd-&gt;have_console = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (initcall_run_list(init_sequence_f))</span><br><span class="line">                hang();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_ARM) &amp;&amp; !defined(CONFIG_SANDBOX) &amp;&amp; \</span></span><br><span class="line"><span class="meta">                !defined(CONFIG_EFI_APP) &amp;&amp; !CONFIG_IS_ENABLED(X86_64) &amp;&amp; \</span></span><br><span class="line"><span class="meta">                !defined(CONFIG_ARC)</span></span><br><span class="line">        <span class="comment">/* NOTREACHED - jump_to_copy() does not return */</span></span><br><span class="line">        hang();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>lib&#x2F;initcall.c:initcall_run_list</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">DECLARE_GLOBAL_DATA_PTR;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">initcall_run_list</span><span class="params">(<span class="type">const</span> <span class="type">init_fnc_t</span> init_sequence[])</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">init_fnc_t</span> *init_fnc_ptr;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (init_fnc_ptr = init_sequence; *init_fnc_ptr; ++init_fnc_ptr) &#123;</span><br><span class="line">                <span class="type">unsigned</span> <span class="type">long</span> reloc_ofs = <span class="number">0</span>;</span><br><span class="line">                <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (gd-&gt;flags &amp; GD_FLG_RELOC)</span><br><span class="line">                        reloc_ofs = gd-&gt;reloc_off;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_EFI_APP</span></span><br><span class="line">                reloc_ofs = (<span class="type">unsigned</span> <span class="type">long</span>)image_base;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                debug(<span class="string">&quot;initcall: %p&quot;</span>, (<span class="type">char</span> *)*init_fnc_ptr - reloc_ofs);</span><br><span class="line">                <span class="keyword">if</span> (gd-&gt;flags &amp; GD_FLG_RELOC)</span><br><span class="line">                        debug(<span class="string">&quot; (relocated to %p)\n&quot;</span>, (<span class="type">char</span> *)*init_fnc_ptr);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                        debug(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                ret = (*init_fnc_ptr)();	<span class="comment">//执行函数指针</span></span><br><span class="line">                <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">&quot;initcall sequence %p failed at call %p (err=%d)\n&quot;</span>,</span><br><span class="line">                               init_sequence,</span><br><span class="line">                               (<span class="type">char</span> *)*init_fnc_ptr - reloc_ofs, ret);</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="relocate-code-relocate-vectors"><a href="#relocate-code-relocate-vectors" class="headerlink" title="relocate_code &amp; relocate_vectors"></a>relocate_code &amp; relocate_vectors</h5><p>代码重定位，为啥需要重定位代码？为kernel让出位置；将flash上的代码移动到dram上</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">panrunxins@AwExdroid100:~/longan/brandy/brandy<span class="number">-2.0</span>/u-boot<span class="number">-2018</span>/arch/arm/lib$ cat relocate.S</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm-offsets.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;config.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;elf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/linkage.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CPU_V7M</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/armv7m.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Default/weak exception vectors relocation routine</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This routine covers the standard ARM cases: normal (0x00000000),</span></span><br><span class="line"><span class="comment"> * high (0xffff0000) and VBAR. SoCs which do not comply with any of</span></span><br><span class="line"><span class="comment"> * the standard cases must provide their own, strong, version.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">        .section        .text.relocate_vectors,<span class="string">&quot;ax&quot;</span>,%progbits</span><br><span class="line">        .weak           relocate_vectors</span><br><span class="line"></span><br><span class="line"><span class="title function_">ENTRY</span><span class="params">(relocate_vectors)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CPU_V7M</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * On ARMv7-M we only have to write the new vector address</span></span><br><span class="line"><span class="comment">         * to VTOR register.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ldr     r0, [r9, #GD_RELOCADDR] <span class="comment">/* r0 = gd-&gt;relocaddr */</span></span><br><span class="line">        ldr     r1, =V7M_SCB_BASE</span><br><span class="line">        str     r0, [r1, V7M_SCB_VTOR]</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_HAS_VBAR</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * If the ARM processor has the security extensions,</span></span><br><span class="line"><span class="comment">         * use VBAR to relocate the exception vectors.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARCH_SUNXI</span></span><br><span class="line">        ldr     r0, =_start</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        ldr     r0, [r9, #GD_RELOCADDR] <span class="comment">/* r0 = gd-&gt;relocaddr */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c12, c0, <span class="number">0</span>  <span class="comment">/* Set VBAR */</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Copy the relocated exception vectors to the</span></span><br><span class="line"><span class="comment">         * correct address</span></span><br><span class="line"><span class="comment">         * CP15 c1 V bit gives us the location of the vectors:</span></span><br><span class="line"><span class="comment">         * 0x00000000 or 0xFFFF0000.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ldr     r0, [r9, #GD_RELOCADDR] <span class="comment">/* r0 = gd-&gt;relocaddr */</span></span><br><span class="line">        mrc     p15, <span class="number">0</span>, r2, c1, c0, <span class="number">0</span>   <span class="comment">/* V bit (bit[13]) in CP15 c1 */</span></span><br><span class="line">        ands    r2, r2, #(<span class="number">1</span> &lt;&lt; <span class="number">13</span>)</span><br><span class="line">        ldreq   r1, =<span class="number">0x00000000</span>         <span class="comment">/* If V=0 */</span></span><br><span class="line">        ldrne   r1, =<span class="number">0xFFFF0000</span>         <span class="comment">/* If V=1 */</span></span><br><span class="line">        ldmia   r0!, &#123;r2-r8,r10&#125;</span><br><span class="line">        stmia   r1!, &#123;r2-r8,r10&#125;</span><br><span class="line">        ldmia   r0!, &#123;r2-r8,r10&#125;</span><br><span class="line">        stmia   r1!, &#123;r2-r8,r10&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        bx      lr</span><br><span class="line"></span><br><span class="line">ENDPROC(relocate_vectors)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * void relocate_code(addr_moni)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function relocates the monitor code.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span></span></span><br><span class="line"><span class="comment"> * To prevent the code below from containing references with an R_ARM_ABS32</span></span><br><span class="line"><span class="comment"> * relocation record type, we never refer to linker-defined symbols directly.</span></span><br><span class="line"><span class="comment"> * Instead, we declare literals which contain their relative location with</span></span><br><span class="line"><span class="comment"> * respect to relocate_code, and at run time, add relocate_code back to them.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">ENTRY(relocate_code)	<span class="comment">//__image_copy_start可能是uboot最初的起始地址，__image_copy_end是结束地址</span></span><br><span class="line">        ldr     r1, =__image_copy_start <span class="comment">/* r1 &lt;- SRC &amp;__image_copy_start */</span></span><br><span class="line">        subs    r4, r0, r1              <span class="comment">/* r4 &lt;- relocation offset */</span> <span class="comment">//计算重定位后的偏移</span></span><br><span class="line">        beq     relocate_done           <span class="comment">/* skip relocation */</span></span><br><span class="line">        ldr     r2, =__image_copy_end   <span class="comment">/* r2 &lt;- SRC &amp;__image_copy_end */</span></span><br><span class="line">		<span class="comment">//r1保存uboot复制的起始地址，r2保存复制的结束地址，r0是重定位地址</span></span><br><span class="line">copy_loop:</span><br><span class="line">        ldmia   r1!, &#123;r10-r11&#125;          <span class="comment">/* copy from source address [r1]    */</span></span><br><span class="line">        stmia   r0!, &#123;r10-r11&#125;          <span class="comment">/* copy to   target address [r0]    */</span></span><br><span class="line">        cmp     r1, r2                  <span class="comment">/* until source end address [r2]    */</span></span><br><span class="line">        blo     copy_loop</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * fix .rel.dyn relocations</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ldr     r2, =__rel_dyn_start    <span class="comment">/* r2 &lt;- SRC &amp;__rel_dyn_start */</span></span><br><span class="line">        ldr     r3, =__rel_dyn_end      <span class="comment">/* r3 &lt;- SRC &amp;__rel_dyn_end */</span></span><br><span class="line">fixloop:							<span class="comment">//r2指向重定位表地址，r0=r2</span></span><br><span class="line">        ldmia   r2!, &#123;r0-r1&#125;            <span class="comment">/* (r0,r1) &lt;- (SRC location,fixup) */</span></span><br><span class="line">        and     r1, r1, #<span class="number">0xff</span>			<span class="comment">//r1中的内容是什么，重定位入口类型和符号，参考：http://blog.chinaunix.net/uid-30546860-id-5589966.html</span></span><br><span class="line">        cmp     r1, #R_ARM_RELATIVE		<span class="comment">//判断重定位入口类型</span></span><br><span class="line">        bne     fixnext</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* relative fix: increase location by offset */</span></span><br><span class="line">        add     r0, r0, r4		<span class="comment">//r4 is offset，得到新的重定位表地址</span></span><br><span class="line">        ldr     r1, [r0]		<span class="comment">//[r0]是需要重定位的符号的地址，把该地址里的值写入r1(这个就是需要修改的绝对地址)</span></span><br><span class="line">        add     r1, r1, r4		<span class="comment">//r1+=r4，就是重定位的过程</span></span><br><span class="line">        str     r1, [r0]		<span class="comment">//再把r1写回 需要重定位的符号的地址</span></span><br><span class="line">fixnext:</span><br><span class="line">        cmp     r2, r3			<span class="comment">//判断重定位段是否结束</span></span><br><span class="line">        blo     fixloop</span><br><span class="line"></span><br><span class="line">relocate_done:</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __XSCALE__</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * On xscale, icache must be invalidated and write buffers drained,</span></span><br><span class="line"><span class="comment">         * even with cache disabled - 4.2.7 of xscale core developer&#x27;s manual</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c7, c7, <span class="number">0</span>   <span class="comment">/* invalidate icache */</span></span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c7, c10, <span class="number">4</span>  <span class="comment">/* drain write buffer */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* ARMv4- don&#x27;t know bx lr but the assembler fails to see that */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __ARM_ARCH_4__</span></span><br><span class="line">        mov     pc, lr</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        bx      lr</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">ENDPROC(relocate_code)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="board-init-r"><a href="#board-init-r" class="headerlink" title="board_init_r()"></a>board_init_r()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">board_init_r</span><span class="params">(<span class="type">gd_t</span> *new_gd, ulong dest_addr)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NEEDS_MANUAL_RELOC</span></span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        gd-&gt;flags &amp;= ~GD_FLG_LOG_READY;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NEEDS_MANUAL_RELOC</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(init_sequence_r); i++)</span><br><span class="line">                init_sequence_r[i] += gd-&gt;reloc_off;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (initcall_run_list(init_sequence_r))</span><br><span class="line">                hang();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* NOTREACHED - run_main_loop() does not return */</span></span><br><span class="line">        hang();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//init_sequence_r</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Over time we hope to remove these functions with code fragments and</span></span><br><span class="line"><span class="comment"> * stub functions, and instead call the relevant function directly.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * We also hope to remove most of the driver-related init and do it if/when</span></span><br><span class="line"><span class="comment"> * the driver is later used.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">TODO:</span> perhaps reset the watchdog in the initcall function after each call?</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">init_fnc_t</span> init_sequence_r[] = &#123;</span><br><span class="line">        initr_trace,</span><br><span class="line">        initr_reloc,	<span class="comment">//设置重定位完成的标志，设置设备树地址到环境变量fdtaddr</span></span><br><span class="line">        <span class="comment">/* <span class="doctag">TODO:</span> could x86/PPC have this also perhaps? */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARM</span></span><br><span class="line">        initr_caches,	<span class="comment">//初始化smp、使能caches</span></span><br><span class="line">        <span class="comment">/* Note: For Freescale LS2 SoCs, new MMU table is created in DDR.</span></span><br><span class="line"><span class="comment">         *       A temporary mapping of IFC high region is since removed,</span></span><br><span class="line"><span class="comment">         *       so environmental variables in NOR flash is not available</span></span><br><span class="line"><span class="comment">         *       until board_init() is called below to remap IFcd -C to high</span></span><br><span class="line"><span class="comment">         *       region.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        initr_reloc_global_data,	<span class="comment">// monitor_flash_len = _end - __image_copy_start;??</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SYS_INIT_RAM_LOCK) &amp;&amp; defined(CONFIG_E500)</span></span><br><span class="line">        initr_unlock_ram_in_cache,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        initr_barrier,	<span class="comment">//略</span></span><br><span class="line">        initr_malloc,	<span class="comment">//初始化堆?设置堆内存为0</span></span><br><span class="line">        log_init,</span><br><span class="line">        initr_bootstage,      <span class="comment">//bootstage是一个记录启动阶段的模块  /* Needs malloc() but has its own timer */</span></span><br><span class="line">        initr_console_record,	<span class="comment">//初始化一个收发的内存来处理控制台</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYS_NONCACHED_MEMORY</span></span><br><span class="line">        initr_noncached,	<span class="comment">//no used</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        bootstage_relocate,		<span class="comment">//bootstage_relocate重定位，看不懂代码</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_OF_LIVE</span></span><br><span class="line">        initr_of_live,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DM</span></span><br><span class="line">        initr_dm, 	<span class="comment">//NO USED</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_ARM) || defined(CONFIG_NDS32) || defined(CONFIG_RISCV)</span></span><br><span class="line">        board_init,    <span class="comment">//判断boot触发源，设置外设电源电压，设置corepll频率</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * <span class="doctag">TODO:</span> printing of the clock inforamtion of the board is now</span></span><br><span class="line"><span class="comment">         * implemented as part of bdinfo command. Currently only support for</span></span><br><span class="line"><span class="comment">         * davinci SOC&#x27;s is added. Remove this check once all the board</span></span><br><span class="line"><span class="comment">         * implement this.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CLOCKS</span></span><br><span class="line">        set_cpu_clk_info, <span class="comment">/* Setup clock information */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_EFI_LOADER</span></span><br><span class="line">        efi_memory_init,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        stdio_init_tables,	<span class="comment">//看不懂？初始化标准输出的表格</span></span><br><span class="line">        initr_serial,	<span class="comment">//注册所有串口驱动到serial core，并设置一个默认的驱动</span></span><br><span class="line">        initr_announce,		<span class="comment">//debug打印</span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET	<span class="comment">//看门狗复位？为什么需要看门狗复位</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NEEDS_MANUAL_RELOC</span></span><br><span class="line">        initr_manual_reloc_cmdtable,    </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_PPC) || defined(CONFIG_M68K) || defined(CONFIG_MIPS)</span></span><br><span class="line">        initr_trap,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ADDR_MAP</span></span><br><span class="line">        initr_addr_map,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_LEDC</span></span><br><span class="line">        initr_ledc,             <span class="comment">//通过设备树获取ledc的资源，然后初始化，设置亮度</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET        <span class="comment">//看门狗复位</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_POST</span></span><br><span class="line">        initr_post_backlog,    	<span class="comment">//未使用</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_PCI) &amp;&amp; defined(CONFIG_SYS_EARLY_PCI_INIT)</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Do early PCI configuration _before_ the flash gets initialised,</span></span><br><span class="line"><span class="comment">         * because PCU resources are crucial for flash access on some boards.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        initr_pci,      <span class="comment">//枚举pcie控制器？？</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARCH_EARLY_INIT_R</span></span><br><span class="line">        arch_early_init_r,      <span class="comment">//ARCH相关初始化（未使用到）</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        power_init_board,       <span class="comment">//板子电源初始化（返回0）</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MTD_NOR_FLASH</span></span><br><span class="line">        initr_flash,    <span class="comment">//初始化nor flash 好像没有使用? flash_init();</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_PPC) || defined(CONFIG_M68K) || defined(CONFIG_X86)</span></span><br><span class="line">        <span class="comment">/* initialize higher level parts of CPU like time base and timers */</span></span><br><span class="line">        cpu_init_r,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PPC</span></span><br><span class="line">        initr_spi,      <span class="comment">//初始化spi spi_init_r();未找到定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMD_NAND	<span class="comment">//（未使用）</span></span></span><br><span class="line">        initr_nand,     <span class="comment">//初始化nand flash nand_init();</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMD_ONENAND	<span class="comment">//（未使用）</span></span></span><br><span class="line">        initr_onenand,  <span class="comment">//onenand_init();？</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MMC</span></span><br><span class="line">        initr_mmc,      <span class="comment">//int mmc_initialize(bd_t *bis)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYS_BOOTPARAMS_LEN</span></span><br><span class="line">        initr_malloc_bootparams,        <span class="comment">//gd-&gt;bd-&gt;bi_boot_params = (ulong)malloc(CONFIG_SYS_BOOTPARAMS_LEN); 为boot参数申请动态内存</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">        initr_secondary_cpu,    <span class="comment">//啥也没干</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_ID_EEPROM) || defined(CONFIG_SYS_I2C_MAC_OFFSET)</span></span><br><span class="line">        mac_read_from_eeprom,   <span class="comment">//读取eeprom的mac地址（不支持）</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_PCI) &amp;&amp; !defined(CONFIG_SYS_EARLY_PCI_INIT)</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Do pci configuration</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        initr_pci,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        stdio_add_devices,      <span class="comment">//标准输入输出初始化：键盘、lcd、音频、视频等</span></span><br><span class="line">        initr_jumptable,        <span class="comment">//gd-&gt;jt = malloc(sizeof(struct jt_funcs)); 给jumptable分配动态内存</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_API</span></span><br><span class="line">        initr_api,      <span class="comment">//api_init() uboot的编程接口</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        console_init_r,         <span class="comment">//选择控制台的输入输出设备/* fully init console as a device */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DISPLAY_BOARDINFO_LATE</span></span><br><span class="line">        console_announce_r,</span><br><span class="line">        show_board_info,        <span class="comment">//打印平台信息（从设备树获取） Model: sun50iw9</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARCH_MISC_INIT</span></span><br><span class="line">        arch_misc_init,        <span class="comment">//未使用 /* miscellaneous arch-dependent init */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MISC_INIT_R	<span class="comment">//未使用</span></span></span><br><span class="line">        misc_init_r,           <span class="comment">//初始化usb以太网？ /* miscellaneous platform-dependent init */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMD_KGDB</span></span><br><span class="line">        initr_kgdb,     <span class="comment">//kernel gdb调试 主要是初始化串口和回调函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        interrupt_init, <span class="comment">//中断初始化 设置中断使用的栈。根据gd</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARM</span></span><br><span class="line">        initr_enable_interrupts,        <span class="comment">//使能中断</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_FAST_BURN_KEY</span></span><br><span class="line">        sunxi_fast_burn_key,    <span class="comment">//usb烧key</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARCH_SUNXI</span></span><br><span class="line">        initr_sunxi_plat,       <span class="comment">//ir初始化、读取按键值、flash初始化、pwm_led初始化、开机logo、gpt更新、烧写rotpk</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        initr_env,              <span class="comment">//load the environment 加载环境？？</span></span><br><span class="line">        board_env_late_init,    <span class="comment">//安全存储、keybox初始化</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_MICROBLAZE) || defined(CONFIG_M68K)</span></span><br><span class="line">        timer_init,             <span class="comment">/* initialize timer */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_LED_STATUS)</span></span><br><span class="line">        initr_status_led,       <span class="comment">//初始化led状态</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">/* PPC has a udelay(20) here dating from 2002. Why? */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMD_NET</span></span><br><span class="line">        initr_ethaddr,  <span class="comment">//从环境变量获取以太网地址？</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARCH_SUNXI</span></span><br><span class="line">        sunxi_burn_key, <span class="comment">//进入auto fel后并进入烧key</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BOARD_LATE_INIT</span></span><br><span class="line">        board_late_init,        <span class="comment">//板子初始化</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SCSI) &amp;&amp; !defined(CONFIG_DM_SCSI)</span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">        initr_scsi,     <span class="comment">//初始化小型计算机系统接口</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BITBANGMII</span></span><br><span class="line">        initr_bbmii,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMD_NET</span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">        initr_net,      <span class="comment">//调用eth_initialize();初始化所有以太网</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_POST</span></span><br><span class="line">        initr_post,     <span class="comment">//post_run(NULL, POST_RAM | post_bootmode_get(0));</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_CMD_PCMCIA) &amp;&amp; !defined(CONFIG_IDE)</span></span><br><span class="line">        initr_pcmcia,   <span class="comment">//??</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_IDE)</span></span><br><span class="line">        initr_ide,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_LAST_STAGE_INIT</span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Some parts can be only initialized if all others (like</span></span><br><span class="line"><span class="comment">         * Interrupts) are up and running (i.e. the PC-style ISA</span></span><br><span class="line"><span class="comment">         * keyboard).</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        last_stage_init,        <span class="comment">//未使用</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMD_BEDBUG</span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">        initr_bedbug,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_PRAM)</span></span><br><span class="line">        initr_mem,      <span class="comment">//更新mem环境变量的值（mem大小？）</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SOUND_SUNXI_BOOT_TONE</span></span><br><span class="line">        sunxi_boot_tone_play,   <span class="comment">//播放开机音乐</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        run_main_loop,  <span class="comment">//跳转到main loop</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* Record the board_init_f() bootstage (after arch_cpu_init()) */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">initf_bootstage</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">bool</span> from_spl = IS_ENABLED(CONFIG_SPL_BOOTSTAGE) &amp;&amp;</span><br><span class="line">                        IS_ENABLED(CONFIG_BOOTSTAGE_STASH);</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">        ret = bootstage_init(!from_spl);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">        <span class="keyword">if</span> (from_spl) &#123;</span><br><span class="line">                <span class="type">const</span> <span class="type">void</span> *stash = map_sysmem(CONFIG_BOOTSTAGE_STASH_ADDR,</span><br><span class="line">                                               CONFIG_BOOTSTAGE_STASH_SIZE);</span><br><span class="line"></span><br><span class="line">                ret = bootstage_unstash(stash, CONFIG_BOOTSTAGE_STASH_SIZE);</span><br><span class="line">                <span class="keyword">if</span> (ret &amp;&amp; ret != -ENOENT) &#123;</span><br><span class="line">                        debug(<span class="string">&quot;Failed to unstash bootstage: err=%d\n&quot;</span>, ret);</span><br><span class="line">                        <span class="keyword">return</span> ret;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        bootstage_mark_name(BOOTSTAGE_ID_START_UBOOT_F, <span class="string">&quot;board_init_f&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">initf_dm</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_DM) &amp;&amp; CONFIG_VAL(SYS_MALLOC_F_LEN)</span></span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">        bootstage_start(BOOTSTATE_ID_ACCUM_DM_F, <span class="string">&quot;dm_f&quot;</span>);</span><br><span class="line">        ret = dm_init_and_scan(<span class="literal">true</span>);</span><br><span class="line">        bootstage_accum(BOOTSTATE_ID_ACCUM_DM_F);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_TIMER_EARLY</span></span><br><span class="line">        ret = dm_timer_init();</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">env_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">env_driver</span> *<span class="title">drv</span>;</span></span><br><span class="line">        <span class="type">int</span> ret = -ENOENT;</span><br><span class="line">        <span class="type">int</span> prio;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (prio = <span class="number">0</span>; (drv = env_driver_lookup(ENVOP_INIT, prio)); prio++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!drv-&gt;init || !(ret = drv-&gt;init()))</span><br><span class="line">                        env_set_inited(drv-&gt;location);</span><br><span class="line"></span><br><span class="line">                debug(<span class="string">&quot;%s: Environment %s init done (ret=%d)\n&quot;</span>, __func__,</span><br><span class="line">                      drv-&gt;name, ret);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!prio)</span><br><span class="line">                <span class="keyword">return</span> -ENODEV;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ret == -ENOENT) &#123;</span><br><span class="line">                gd-&gt;env_addr = (ulong)&amp;default_environment[<span class="number">0</span>];</span><br><span class="line">                gd-&gt;env_valid = ENV_VALID;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* Called before relocation - use serial functions */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">console_init_f</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        gd-&gt;have_console = <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> debug_mode;</span><br><span class="line">        console_update_silent();</span><br><span class="line">        <span class="keyword">if</span> (get_boot_work_mode() == WORK_MODE_BOOT)</span><br><span class="line">                <span class="keyword">if</span> (uboot_spare_head.boot_data.debug_mode &amp; <span class="number">0x80</span>) <span class="comment">/* bit7 is one, means boot0 want to set debug_mode */</span></span><br><span class="line">                        debug_mode = uboot_spare_head.boot_data.debug_mode &amp; <span class="number">0x7F</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="comment">/* dts */</span></span><br><span class="line">                        script_parser_fetch(<span class="string">&quot;/soc/platform&quot;</span>, <span class="string">&quot;debug_mode&quot;</span>, &amp;debug_mode, <span class="number">4</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                debug_mode = <span class="number">8</span>;</span><br><span class="line">        gd-&gt;debug_mode = debug_mode;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_IS_ENABLED(PRE_CONSOLE_BUFFER)</span></span><br><span class="line">        <span class="built_in">memset</span>((<span class="type">char</span> *)(CONFIG_PRE_CON_BUF_ADDR + gd-&gt;precon_buf_idx), <span class="number">0</span>, CONFIG_PRE_CON_BUF_SZ - gd-&gt;precon_buf_idx);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        print_pre_console_buffer(PRE_CONSOLE_FLUSHPOINT1_SERIAL);	<span class="comment">//打印一些什么信息？</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">dram_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        uint dram_size = <span class="number">0</span>;</span><br><span class="line">        dram_size = uboot_spare_head.boot_data.dram_scan_size;</span><br><span class="line"></span><br><span class="line">        dram_size = dram_size &gt; <span class="number">2048</span> ? <span class="number">2048</span> : dram_size;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(dram_size)</span><br><span class="line">                gd-&gt;ram_size = dram_size * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                gd-&gt;ram_size = get_ram_size((<span class="type">long</span> *)PHYS_SDRAM_0, PHYS_SDRAM_0_SIZE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">setup_dest_addr</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        debug(<span class="string">&quot;Monitor len: %08lX\n&quot;</span>, gd-&gt;mon_len);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Ram is setup, size stored in gd !!</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        debug(<span class="string">&quot;Ram size: %08lX\n&quot;</span>, (ulong)gd-&gt;ram_size);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SYS_MEM_TOP_HIDE)</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Subtract specified amount of memory to hide so that it won&#x27;t</span></span><br><span class="line"><span class="comment">         * get &quot;touched&quot; at all by U-Boot. By fixing up gd-&gt;ram_size</span></span><br><span class="line"><span class="comment">         * the Linux kernel should now get passed the now &quot;corrected&quot;</span></span><br><span class="line"><span class="comment">         * memory size and won&#x27;t touch it either. This should work</span></span><br><span class="line"><span class="comment">         * for arch/ppc and arch/powerpc. Only Linux board ports in</span></span><br><span class="line"><span class="comment">         * arch/powerpc with bootwrapper support, that recalculate the</span></span><br><span class="line"><span class="comment">         * memory size from the SDRAM controller setup will have to</span></span><br><span class="line"><span class="comment">         * get fixed.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        gd-&gt;ram_size -= CONFIG_SYS_MEM_TOP_HIDE;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYS_SDRAM_BASE</span></span><br><span class="line">        gd-&gt;ram_top = CONFIG_SYS_SDRAM_BASE;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        gd-&gt;ram_top += get_effective_memsize();</span><br><span class="line">        gd-&gt;ram_top = board_get_usable_ram_top(gd-&gt;mon_len);</span><br><span class="line">        gd-&gt;relocaddr = gd-&gt;ram_top;</span><br><span class="line">        debug(<span class="string">&quot;Ram top: %08lX\n&quot;</span>, (ulong)gd-&gt;ram_top);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_MP) &amp;&amp; (defined(CONFIG_MPC86xx) || defined(CONFIG_E500))</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * We need to make sure the location we intend to put secondary core</span></span><br><span class="line"><span class="comment">         * boot code is reserved and not used by any part of u-boot</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (gd-&gt;relocaddr &gt; determine_mp_bootpg(<span class="literal">NULL</span>)) &#123;</span><br><span class="line">                gd-&gt;relocaddr = determine_mp_bootpg(<span class="literal">NULL</span>);</span><br><span class="line">                debug(<span class="string">&quot;Reserving MP boot page to %08lx\n&quot;</span>, gd-&gt;relocaddr);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">reloc_fdt</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_OF_EMBED</span></span><br><span class="line">        <span class="keyword">if</span> (gd-&gt;flags &amp; GD_FLG_SKIP_RELOC)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (gd-&gt;new_fdt) &#123;</span><br><span class="line">                <span class="built_in">memcpy</span>(gd-&gt;new_fdt, gd-&gt;fdt_blob, gd-&gt;fdt_size);</span><br><span class="line">                gd-&gt;fdt_blob = gd-&gt;new_fdt;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">setup_reloc</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (gd-&gt;flags &amp; GD_FLG_SKIP_RELOC) &#123;</span><br><span class="line">                debug(<span class="string">&quot;Skipping relocation due to flag\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYS_TEXT_BASE</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_ARM) || defined(CONFIG_RISCV)</span></span><br><span class="line">        gd-&gt;reloc_off = gd-&gt;relocaddr - (<span class="type">unsigned</span> <span class="type">long</span>)__image_copy_start;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(CONFIG_M68K)</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * On all ColdFire arch cpu, monitor code starts always</span></span><br><span class="line"><span class="comment">         * just after the default vector table location, so at 0x400</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        gd-&gt;reloc_off = gd-&gt;relocaddr - (CONFIG_SYS_TEXT_BASE + <span class="number">0x400</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        gd-&gt;reloc_off = gd-&gt;relocaddr - CONFIG_SYS_TEXT_BASE;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="built_in">memcpy</span>(gd-&gt;new_gd, (<span class="type">char</span> *)gd, <span class="keyword">sizeof</span>(<span class="type">gd_t</span>));</span><br><span class="line"></span><br><span class="line">        tick_printf(<span class="string">&quot;Relocation Offset is: %08lx\n&quot;</span>, gd-&gt;reloc_off);</span><br><span class="line">        debug(<span class="string">&quot;Relocating to %08lx, new gd at %08lx, sp at %08lx\n&quot;</span>,</span><br><span class="line">              gd-&gt;relocaddr, (ulong)map_to_sysmem(gd-&gt;new_gd),</span><br><span class="line">              gd-&gt;start_addr_sp);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">axp_gpio_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">udevice</span> *<span class="title">dev</span>;</span></span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">        ret = pmic_bus_init();</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* There is no devicetree support for the axp yet, so bind directly */</span></span><br><span class="line">        ret = device_bind_driver(dm_root(), <span class="string">&quot;gpio_axp&quot;</span>, <span class="string">&quot;AXP-gpio&quot;</span>, &amp;dev);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sunxi_plat_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        sunxi_probe_securemode();	<span class="comment">//检查安全模式</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_DMA</span></span><br><span class="line">        sunxi_dma_init();	<span class="comment">//dma初始化</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARM</span></span><br><span class="line">    	<span class="comment">//安全相关的</span></span><br><span class="line">        <span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">secure_os_memory_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (sunxi_probe_secure_os()) &#123;</span><br><span class="line">                smc_tee_inform_fdt((<span class="type">uint64_t</span>)(<span class="type">unsigned</span> <span class="type">long</span>)working_fdt, gd-&gt;fdt_size);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SUNXI_EXTERN_SECURE_MM_LAYOUT)</span></span><br><span class="line">                secure_os_memory_init();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* add board specific code here */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">board_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        __maybe_unused <span class="type">int</span> id_pfr1, ret, satapwr_pin, macpwr_pin;</span><br><span class="line"></span><br><span class="line">        gd-&gt;bd-&gt;bi_boot_params = (PHYS_SDRAM_0 + <span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">        sunxi_plat_init();	<span class="comment">//检测secure os</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> work_mode = get_boot_work_mode();	<span class="comment">//通过uboot首部数据获取uboot工作模式</span></span><br><span class="line"></span><br><span class="line">        ret = axp_gpio_init();	<span class="comment">//axp驱动加载 AXP是电源管理的芯片</span></span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_POWER</span></span><br><span class="line">        <span class="keyword">if</span> (!axp_probe()) &#123;</span><br><span class="line">            	<span class="comment">//检查到电源保护芯片</span></span><br><span class="line">                axp_set_dcdc_mode();	<span class="comment">//设置dcdc pwm模式</span></span><br><span class="line">                axp_set_power_supply_output();	<span class="comment">//通过pmu设置设备树其他外设的电压</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined CONFIG_SUNXI_BMU &amp;&amp; !defined CONFIG_AXP_LATE_INFO</span></span><br><span class="line">            	<span class="comment">//获取boot的触发源（按键、还是插电），通过读取bmu芯片的寄存器。</span></span><br><span class="line">                gd-&gt;pmu_saved_status = bmu_get_poweron_source();	</span><br><span class="line">                gd-&gt;pmu_runtime_chgcur = axp_get_battery_status();	<span class="comment">//通过bmu获取电池电压</span></span><br><span class="line">				</span><br><span class="line">            	<span class="comment">//WORK_MODE_BOOT就是正常的boot启动</span></span><br><span class="line">                <span class="keyword">if</span> (work_mode != WORK_MODE_BOOT) &#123;</span><br><span class="line">                        ret = axp_reset_capacity();	<span class="comment">//通过bmu设置电池容量为0？</span></span><br><span class="line">                        <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">                                pr_msg(<span class="string">&quot;axp reset capacity fail!\n&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">                gd-&gt;pmu_saved_status = <span class="number">-1</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        rtc_set_dcxo_off();	<span class="comment">//关闭wifi</span></span><br><span class="line"></span><br><span class="line">    	<span class="comment">//正常启动、卡量产、卡启动</span></span><br><span class="line">        <span class="keyword">if</span> ((work_mode == WORK_MODE_BOOT) ||</span><br><span class="line">                (work_mode == WORK_MODE_CARD_PRODUCT) ||</span><br><span class="line">                (work_mode == WORK_MODE_CARD_UPDATE))</span><br><span class="line">                sunxi_set_sramc_mode();		<span class="comment">//看不懂？和平台相关</span></span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//获取设备树文件中boot_clock的值</span></span><br><span class="line">        <span class="type">int</span> boot_clock;	</span><br><span class="line">        script_parser_fetch(FDT_PATH_TARGET, <span class="string">&quot;boot_clock&quot;</span>, &amp;boot_clock, uboot_spare_head.boot_data.run_clock);</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//设置core pll频率</span></span><br><span class="line">        clock_set_corepll(boot_clock);</span><br><span class="line">        tick_printf(<span class="string">&quot;CPU=%d MHz,PLL6=%d Mhz,AHB=%d Mhz, APB1=%dMhz  MBus=%dMhz\n&quot;</span>,</span><br><span class="line">                clock_get_corepll(),</span><br><span class="line">                clock_get_pll6(), clock_get_ahb(),</span><br><span class="line">                clock_get_apb1(),clock_get_mbus());</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_OVERLAY</span></span><br><span class="line">        <span class="keyword">if</span> (get_boot_work_mode() != WORK_MODE_BOOT) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    	<span class="comment">//好像是设备树相关的？</span></span><br><span class="line">        <span class="keyword">if</span> (!sunxi_overlay_apply_merged(working_fdt, gd-&gt;new_dtbo)) &#123;</span><br><span class="line">                pr_err(<span class="string">&quot;sunxi overlay merged %sqv\n&quot;</span>,</span><br><span class="line">                        (fdt_overlay_apply_verbose(working_fdt, gd-&gt;new_dtbo) ? <span class="string">&quot;fail&quot;</span>:<span class="string">&quot;ok&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                pr_msg(<span class="string">&quot;not need merged sunxi overlay\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">mmc_initialize</span><span class="params">(<span class="type">bd_t</span> *bis)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !CONFIG_IS_ENABLED(BLK)</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !CONFIG_IS_ENABLED(MMC_TINY)</span></span><br><span class="line">        <span class="type">static</span> <span class="type">int</span> initialized;</span><br><span class="line">        <span class="keyword">if</span> (!initialized)       <span class="comment">/* Avoid initializing mmc multiple times */</span></span><br><span class="line">                mmc_list_init();        <span class="comment">//初始化mmc设备列表（设备描述符）</span></span><br><span class="line">        initialized = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        ret = mmc_probe(bis);   <span class="comment">//probe mmc设备</span></span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_SPL_BUILD</span></span><br><span class="line">        print_mmc_devices(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        mmc_do_preinit();       <span class="comment">//int mmc_start_init(struct mmc *mmc) 使用驱动程序初始化mmc</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">nand_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">uint32_t</span> val;</span><br><span class="line"></span><br><span class="line">        board_nand_init();      <span class="comment">//找不到</span></span><br><span class="line"></span><br><span class="line">        val = readl(SUNXI_NFC_BASE + NFC_CTL);</span><br><span class="line">        <span class="comment">/* enable and reset CTL */</span></span><br><span class="line">        writel(val | NFC_CTL_EN | NFC_CTL_RESET,</span><br><span class="line">               SUNXI_NFC_BASE + NFC_CTL);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!check_value_negated(SUNXI_NFC_BASE + NFC_CTL,</span><br><span class="line">                                 NFC_CTL_RESET, DEFAULT_TIMEOUT_US)) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Couldn&#x27;t initialize nand\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* reset NAND */</span></span><br><span class="line">        nand_exec_cmd(NFC_SEND_CMD1 | NFC_WAIT_FLAG | NAND_CMD_RESET);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">onenand_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> err = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;onenand_mtd, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> mtd_info));</span><br><span class="line">        <span class="built_in">memset</span>(&amp;onenand_chip, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> onenand_chip));</span><br><span class="line"></span><br><span class="line">        onenand_mtd.priv = &amp;onenand_chip;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_USE_ONENAND_BOARD_INIT</span></span><br><span class="line">        <span class="comment">/* It&#x27;s used for some board init required */</span></span><br><span class="line">        err = onenand_board_init(&amp;onenand_mtd);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        onenand_chip.base = (<span class="type">void</span> *) CONFIG_SYS_ONENAND_BASE;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!err &amp;&amp; !(onenand_scan(&amp;onenand_mtd, <span class="number">1</span>))) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (onenand_chip.device_id &amp; DEVICE_IS_FLEXONENAND)</span><br><span class="line">                        <span class="built_in">puts</span>(<span class="string">&quot;Flex-&quot;</span>);</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;OneNAND: &quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MTD_DEVICE</span></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * Add MTD device so that we can reference it later</span></span><br><span class="line"><span class="comment">                 * via the mtdcore infrastructure (e.g. ubi).</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                onenand_mtd.name = dev_name;</span><br><span class="line">                add_mtd_device(&amp;onenand_mtd);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        print_size(onenand_chip.chipsize, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//初始化一切的输入输出设备，主要是终端</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">stdio_add_devices</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DM_KEYBOARD</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">udevice</span> *<span class="title">dev</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">uclass</span> *<span class="title">uc</span>;</span></span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * For now we probe all the devices here. At some point this should be</span></span><br><span class="line"><span class="comment">         * done only when the devices are required - e.g. we have a list of</span></span><br><span class="line"><span class="comment">         * input devices to start up in the stdin environment variable. That</span></span><br><span class="line"><span class="comment">         * work probably makes more sense when stdio itself is converted to</span></span><br><span class="line"><span class="comment">         * driver model.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * TODO(sjg@chromium.org): Convert changing uclass_first_device() etc.</span></span><br><span class="line"><span class="comment">         * to return the device even on error. Then we could use that here.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ret = uclass_get(UCLASS_KEYBOARD, &amp;uc);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Don&#x27;t report errors to the caller - assume that they are non-fatal */</span></span><br><span class="line">        uclass_foreach_dev(dev, uc) &#123;</span><br><span class="line">                ret = device_probe(dev);</span><br><span class="line">                <span class="keyword">if</span> (ret)</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">&quot;Failed to probe keyboard &#x27;%s&#x27;\n&quot;</span>, dev-&gt;name);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DM_VIDEO</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * If the console setting is not in environment variables then</span></span><br><span class="line"><span class="comment">         * console_init_r() will not be calling iomux_doenv() (which calls</span></span><br><span class="line"><span class="comment">         * search_device()). So we will not dynamically add devices by</span></span><br><span class="line"><span class="comment">         * calling stdio_probe_device().</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * So just probe all video devices now so that whichever one is</span></span><br><span class="line"><span class="comment">         * required will be available.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_SYS_CONSOLE_IS_IN_ENV</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">udevice</span> *<span class="title">vdev</span>;</span></span><br><span class="line"><span class="meta"># <span class="keyword">ifndef</span> CONFIG_DM_KEYBOARD</span></span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ret = uclass_first_device(UCLASS_VIDEO, &amp;vdev);</span><br><span class="line">             vdev;</span><br><span class="line">             ret = uclass_next_device(&amp;vdev))</span><br><span class="line">                ;</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%s: Video device failed (ret=%d)\n&quot;</span>, __func__, ret);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* !CONFIG_SYS_CONSOLE_IS_IN_ENV */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">if</span> defined(CONFIG_LCD)</span></span><br><span class="line">        drv_lcd_init ();</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">if</span> defined(CONFIG_VIDEO) || defined(CONFIG_CFB_CONSOLE)</span></span><br><span class="line">        drv_video_init ();      <span class="comment">//好像未实现？</span></span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_DM_VIDEO */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_KEYBOARD) &amp;&amp; !defined(CONFIG_DM_KEYBOARD)</span></span><br><span class="line">        drv_keyboard_init ();   <span class="comment">//也没有实现？</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        drv_system_init ();     <span class="comment">//初始化串口</span></span><br><span class="line">        serial_stdio_init ();   <span class="comment">//注册串口到sdtio core</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_USB_TTY</span></span><br><span class="line">        drv_usbtty_init ();     <span class="comment">//usb终端初始化</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NETCONSOLE</span></span><br><span class="line">        drv_nc_init ();         <span class="comment">//注册网络终端结构体</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_JTAG_CONSOLE</span></span><br><span class="line">        drv_jtag_console_init ();       <span class="comment">//未使用</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CBMEM_CONSOLE</span></span><br><span class="line">        cbmemc_init();          <span class="comment">//注册CBMEM结构体</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">lcd_init</span><span class="params">(<span class="type">void</span> *lcdbase)</span></span><br><span class="line">&#123;</span><br><span class="line">        debug(<span class="string">&quot;[LCD] Initializing LCD frambuffer at %p\n&quot;</span>, lcdbase);</span><br><span class="line">        lcd_ctrl_init(lcdbase); <span class="comment">//为何找不到实现的源码 控制器初始化</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * lcd_ctrl_init() of some drivers (i.e. bcm2835 on rpi) ignores</span></span><br><span class="line"><span class="comment">         * the &#x27;lcdbase&#x27; argument and uses custom lcd base address</span></span><br><span class="line"><span class="comment">         * by setting up gd-&gt;fb_base. Check for this condition and fixup</span></span><br><span class="line"><span class="comment">         * &#x27;lcd_base&#x27; address.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (map_to_sysmem(lcdbase) != gd-&gt;fb_base)</span><br><span class="line">                lcd_base = map_sysmem(gd-&gt;fb_base, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        debug(<span class="string">&quot;[LCD] Using LCD frambuffer at %p\n&quot;</span>, lcd_base);</span><br><span class="line"></span><br><span class="line">        lcd_get_size(&amp;lcd_line_length);</span><br><span class="line">        lcd_is_enabled = <span class="number">1</span>;</span><br><span class="line">        lcd_clear();</span><br><span class="line">        lcd_enable();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Initialize the console */</span></span><br><span class="line">        lcd_set_col(<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_LCD_INFO_BELOW_LOGO</span></span><br><span class="line">        lcd_set_row(<span class="number">7</span> + BMP_LOGO_HEIGHT / VIDEO_FONT_HEIGHT);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        lcd_set_row(<span class="number">1</span>); <span class="comment">/* leave 1 blank line below logo */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">drv_lcd_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">stdio_dev</span> <span class="title">lcddev</span>;</span></span><br><span class="line">        <span class="type">int</span> rc;</span><br><span class="line"></span><br><span class="line">        lcd_base = map_sysmem(gd-&gt;fb_base, <span class="number">0</span>);  <span class="comment">//lcd framebuff地址</span></span><br><span class="line"></span><br><span class="line">        lcd_init(lcd_base);     <span class="comment">//lcd</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Device initialization lcd结构体对象初始化*/</span></span><br><span class="line">        <span class="built_in">memset</span>(&amp;lcddev, <span class="number">0</span>, <span class="keyword">sizeof</span>(lcddev));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">strcpy</span>(lcddev.name, <span class="string">&quot;lcd&quot;</span>);</span><br><span class="line">        lcddev.ext   = <span class="number">0</span>;                       <span class="comment">/* No extensions */</span></span><br><span class="line">        lcddev.flags = DEV_FLAGS_OUTPUT;        <span class="comment">/* Output only */</span></span><br><span class="line">        lcddev.putc  = lcd_stub_putc;           <span class="comment">/* &#x27;putc&#x27; function */</span></span><br><span class="line">        lcddev.<span class="built_in">puts</span>  = lcd_stub_puts;           <span class="comment">/* &#x27;puts&#x27; function */</span></span><br><span class="line"></span><br><span class="line">        rc = stdio_register(&amp;lcddev);   <span class="comment">//将lcd注册到标准输入输出</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (rc == <span class="number">0</span>) ? <span class="number">1</span> : rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Initialize the usb client port.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">drv_usbtty_init</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> rc;</span><br><span class="line">        <span class="type">char</span> * sn;</span><br><span class="line">        <span class="type">char</span> * tt;</span><br><span class="line">        <span class="type">int</span> snlen;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Get serial number */</span></span><br><span class="line">        sn = env_get(<span class="string">&quot;serial#&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!sn)</span><br><span class="line">                sn = <span class="string">&quot;000000000000&quot;</span>;</span><br><span class="line">        snlen = <span class="built_in">strlen</span>(sn);</span><br><span class="line">        <span class="keyword">if</span> (snlen &gt; <span class="keyword">sizeof</span>(serial_number) - <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span> (<span class="string">&quot;Warning: serial number %s is too long (%d &gt; %lu)\n&quot;</span>,</span><br><span class="line">                        sn, snlen, (ulong)(<span class="keyword">sizeof</span>(serial_number) - <span class="number">1</span>));</span><br><span class="line">                snlen = <span class="keyword">sizeof</span>(serial_number) - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memcpy</span> (serial_number, sn, snlen);</span><br><span class="line">        serial_number[snlen] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Decide on which type of UDC device to be.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        tt = env_get(<span class="string">&quot;usbtty&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!tt)</span><br><span class="line">                tt = <span class="string">&quot;generic&quot;</span>;</span><br><span class="line">        usbtty_init_terminal_type(<span class="built_in">strcmp</span>(tt,<span class="string">&quot;cdc_acm&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* prepare buffers... */</span></span><br><span class="line">        buf_init (&amp;usbtty_input, USBTTY_BUFFER_SIZE);</span><br><span class="line">        buf_init (&amp;usbtty_output, USBTTY_BUFFER_SIZE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Now, set up USB controller and infrastructure */</span></span><br><span class="line">        udc_init ();            <span class="comment">/* Basic USB initialization */</span></span><br><span class="line"></span><br><span class="line">        usbtty_init_strings ();</span><br><span class="line">        usbtty_init_instances ();</span><br><span class="line"></span><br><span class="line">        usbtty_init_endpoints ();</span><br><span class="line"></span><br><span class="line">        udc_startup_events (device_instance);<span class="comment">/* Enable dev, init udc pointers */</span></span><br><span class="line">        udc_connect ();         <span class="comment">/* Enable pullup for host detection */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Device initialization */</span></span><br><span class="line">        <span class="built_in">memset</span> (&amp;usbttydev, <span class="number">0</span>, <span class="keyword">sizeof</span> (usbttydev));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">strcpy</span> (usbttydev.name, <span class="string">&quot;usbtty&quot;</span>);</span><br><span class="line">        usbttydev.ext = <span class="number">0</span>;      <span class="comment">/* No extensions */</span></span><br><span class="line">        usbttydev.flags = DEV_FLAGS_INPUT | DEV_FLAGS_OUTPUT;</span><br><span class="line">        usbttydev.tstc = usbtty_tstc;   <span class="comment">/* &#x27;tstc&#x27; function */</span></span><br><span class="line">        usbttydev.getc = usbtty_getc;   <span class="comment">/* &#x27;getc&#x27; function */</span></span><br><span class="line">        usbttydev.putc = usbtty_putc;   <span class="comment">/* &#x27;putc&#x27; function */</span></span><br><span class="line">        usbttydev.<span class="built_in">puts</span> = usbtty_puts;   <span class="comment">/* &#x27;puts&#x27; function */</span></span><br><span class="line"></span><br><span class="line">        rc = stdio_register (&amp;usbttydev);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (rc == <span class="number">0</span>) ? <span class="number">1</span> : rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">drv_nc_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">stdio_dev</span> <span class="title">dev</span>;</span></span><br><span class="line">        <span class="type">int</span> rc;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(&amp;dev, <span class="number">0</span>, <span class="keyword">sizeof</span>(dev));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">strcpy</span>(dev.name, <span class="string">&quot;nc&quot;</span>);</span><br><span class="line">        dev.flags = DEV_FLAGS_OUTPUT | DEV_FLAGS_INPUT;</span><br><span class="line">        dev.start = nc_stdio_start;</span><br><span class="line">        dev.putc = nc_stdio_putc;</span><br><span class="line">        dev.<span class="built_in">puts</span> = nc_stdio_puts;</span><br><span class="line">        dev.getc = nc_stdio_getc;</span><br><span class="line">        dev.tstc = nc_stdio_tstc;</span><br><span class="line"></span><br><span class="line">        rc = stdio_register(&amp;dev);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (rc == <span class="number">0</span>) ? <span class="number">1</span> : rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化api表、并留下地址给开发者</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">api_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">api_signature</span> *<span class="title">sig</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* TODO put this into linker set one day... */</span></span><br><span class="line">        calls_table[API_RSVD] = <span class="literal">NULL</span>;</span><br><span class="line">        calls_table[API_GETC] = &amp;API_getc;</span><br><span class="line">        calls_table[API_PUTC] = &amp;API_putc;</span><br><span class="line">        calls_table[API_TSTC] = &amp;API_tstc;</span><br><span class="line">        calls_table[API_PUTS] = &amp;API_puts;</span><br><span class="line">        calls_table[API_RESET] = &amp;API_reset;</span><br><span class="line">        calls_table[API_GET_SYS_INFO] = &amp;API_get_sys_info;</span><br><span class="line">        calls_table[API_UDELAY] = &amp;API_udelay;</span><br><span class="line">        calls_table[API_GET_TIMER] = &amp;API_get_timer;</span><br><span class="line">        calls_table[API_DEV_ENUM] = &amp;API_dev_enum;</span><br><span class="line">        calls_table[API_DEV_OPEN] = &amp;API_dev_open;</span><br><span class="line">        calls_table[API_DEV_CLOSE] = &amp;API_dev_close;</span><br><span class="line">        calls_table[API_DEV_READ] = &amp;API_dev_read;</span><br><span class="line">        calls_table[API_DEV_WRITE] = &amp;API_dev_write;</span><br><span class="line">        calls_table[API_ENV_GET] = &amp;API_env_get;</span><br><span class="line">        calls_table[API_ENV_SET] = &amp;API_env_set;</span><br><span class="line">        calls_table[API_ENV_ENUM] = &amp;API_env_enum;</span><br><span class="line">        calls_table[API_DISPLAY_GET_INFO] = &amp;API_display_get_info;</span><br><span class="line">        calls_table[API_DISPLAY_DRAW_BITMAP] = &amp;API_display_draw_bitmap;</span><br><span class="line">        calls_table[API_DISPLAY_CLEAR] = &amp;API_display_clear;</span><br><span class="line">        calls_no = API_MAXCALL;</span><br><span class="line"></span><br><span class="line">        debugf(<span class="string">&quot;API initialized with %d calls\n&quot;</span>, calls_no);</span><br><span class="line"></span><br><span class="line">        dev_stor_init();        <span class="comment">//可能是存储设备初始化？</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Produce the signature so the API consumers can find it</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        sig = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> api_signature));</span><br><span class="line">        <span class="keyword">if</span> (sig == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;API: could not allocate memory for the signature!\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        env_set_hex(<span class="string">&quot;api_address&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>)sig); <span class="comment">//把地址保存到环境变量</span></span><br><span class="line">        debugf(<span class="string">&quot;API sig @ 0x%lX\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>)sig);</span><br><span class="line">        <span class="built_in">memcpy</span>(sig-&gt;magic, API_SIG_MAGIC, <span class="number">8</span>);</span><br><span class="line">        sig-&gt;version = API_SIG_VERSION;</span><br><span class="line">        sig-&gt;syscall = &amp;syscall;</span><br><span class="line">        sig-&gt;checksum = <span class="number">0</span>;</span><br><span class="line">        sig-&gt;checksum = crc32(<span class="number">0</span>, (<span class="type">unsigned</span> <span class="type">char</span> *)sig,</span><br><span class="line">                              <span class="keyword">sizeof</span>(<span class="keyword">struct</span> api_signature));</span><br><span class="line">        debugf(<span class="string">&quot;syscall entry: 0x%lX\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>)sig-&gt;syscall);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * kgdb_init must be called *after* the</span></span><br><span class="line"><span class="comment"> * monitor is relocated into ram</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">kgdb_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        kgdb_serial_init();</span><br><span class="line">        debugger_exception_handler = handle_exception;</span><br><span class="line">        initialized = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        putDebugStr(<span class="string">&quot;kgdb ready\n&quot;</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;ready\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">interrupt_init</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * setup up stacks if necessary</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        IRQ_STACK_START = gd-&gt;irq_sp - <span class="number">4</span>;</span><br><span class="line">        IRQ_STACK_START_IN = gd-&gt;irq_sp + <span class="number">8</span>;</span><br><span class="line">        FIQ_STACK_START = IRQ_STACK_START - SUNXI_STACKSIZE_IRQ;</span><br><span class="line"></span><br><span class="line">        debug(<span class="string">&quot;IRQ_STACK_START=0x%x\n&quot;</span>, (<span class="type">uint32_t</span>)IRQ_STACK_START);</span><br><span class="line">        <span class="comment">/*cpu0_set_irq_stack(IRQ_STACK_START);*/</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> arch_interrupt_init();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">enable_interrupts</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> temp;</span><br><span class="line">        __asm__ __volatile__(<span class="string">&quot;mrs %0, cpsr\n&quot;</span></span><br><span class="line">                             <span class="string">&quot;bic %0, %0, #0x80\n&quot;</span></span><br><span class="line">                             <span class="string">&quot;msr cpsr_c, %0&quot;</span></span><br><span class="line">                             : <span class="string">&quot;=r&quot;</span> (temp)</span><br><span class="line">                             :</span><br><span class="line">                             : <span class="string">&quot;memory&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">sunxi_fast_burn_key</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> storage_type = get_boot_storage_type_ext();</span><br><span class="line">        <span class="type">int</span> ret          = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        sunxi_burn_key_processed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!sunxi_flash_is_support_fast_write(storage_type)) &#123;</span><br><span class="line">                pr_msg(<span class="string">&quot;sunxi flash type@%d not support fast burn key\n&quot;</span>,</span><br><span class="line">                       storage_type);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">                ret = sunxi_flash_hook_init();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                pr_msg(<span class="string">&quot;sunxi flash hook init fail\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pr_msg(<span class="string">&quot;try fast burn key\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!sunxi_burn_key_processed) &#123;</span><br><span class="line">                sunxi_burn_key_processed = <span class="number">1</span>;</span><br><span class="line">                sunxi_keydata_burn_by_usb();    <span class="comment">//board/sunxi/key_burn.c</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="initr-sunxi-plat"><a href="#initr-sunxi-plat" class="headerlink" title="initr_sunxi_plat"></a>initr_sunxi_plat</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ir模块初始化、flash初始化、pwm_led初始化、开机logo、gpt更新、烧写rotpk</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">initr_sunxi_plat</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        __maybe_unused <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        __maybe_unused <span class="type">int</span> workmode = get_boot_work_mode();</span><br><span class="line"></span><br><span class="line">        check_ir_boot_recovery();       <span class="comment">//初始化ir模块</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SUNXI_HOMLET)        <span class="comment">//哈姆雷特？？？</span></span></span><br><span class="line">        sunxi_boot_init_gpio();         <span class="comment">//gpio初始化</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        check_recovery_key();           <span class="comment">//检查recovery 按键（无按下、短按、长按）</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!gd-&gt;boot_logo_addr) &#123;</span><br><span class="line">                tick_printf(<span class="string">&quot;flash init start\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">                ret = sunxi_flash_init_ext();   <span class="comment">//初始化flash相关描述符 调用对应flash的初始化函数</span></span><br><span class="line">                <span class="keyword">if</span> (ret)</span><br><span class="line">                        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_BOARD_EARLY_INIT_R)</span></span><br><span class="line">        board_early_init_r();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        pwm_led_init();         <span class="comment">//PWM led</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BOOT_GUI</span></span><br><span class="line">        sunxi_early_logo_display();     <span class="comment">//显示logo</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_BOX_STANDBY</span></span><br><span class="line">        do_box_standby();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ATF_BOX_STANDBY</span></span><br><span class="line">        atf_box_standby();     </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">//gd-&gt;boot_logo_addr</span></span><br><span class="line">        <span class="keyword">if</span> (gd-&gt;boot_logo_addr) &#123;</span><br><span class="line">                tick_printf(<span class="string">&quot;flash init start\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">                ret = sunxi_flash_init_ext();	<span class="comment">//初始化flash描述符 调用对应flash的初始化函数</span></span><br><span class="line">                <span class="keyword">if</span> (ret)</span><br><span class="line">                        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (workmode == WORK_MODE_BOOT) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_UPDATE_GPT</span></span><br><span class="line">                <span class="type">int</span> <span class="title function_">sunxi_update_gpt</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">                sunxi_update_gpt();             <span class="comment">//更新GPT</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BOOT_GUI</span></span><br><span class="line">            </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * logo display priority:</span></span><br><span class="line"><span class="comment"> * advert picture &gt; bootlogo in boot package &gt; bootlogo in boot-resources/bootloader</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * when /soc/target/advert_enable=1, display advert picture in Reserve0 partition</span></span><br><span class="line"><span class="comment"> * gd-&gt;boot_logo_addr is used to  indicate whether bootlogo in boot package exist/used</span></span><br><span class="line"><span class="comment"> * when no advert picture and gd-&gt;boot_logo_addr, bootlogo in boot-resouce is used as</span></span><br><span class="line"><span class="comment"> * default</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">        sunxi_early_logo_display();	<span class="comment">//若有广告图片、则gd-&gt;boot_logo_addr被设置为0，表示不使用。</span></span><br><span class="line">            						<span class="comment">//若无广告图片，从bootpackge读取logo，若无，则gd-&gt;boot_logo_addr被设置为0，表示不使用</span></span><br><span class="line">								</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_BOX_STANDBY</span></span><br><span class="line">        do_box_standby();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ATF_BOX_STANDBY</span></span><br><span class="line">        atf_box_standby();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (gd-&gt;boot_logo_addr) &#123;</span><br><span class="line">                tick_printf(<span class="string">&quot;flash init start\n&quot;</span>);</span><br><span class="line">                ret = sunxi_flash_init_ext();	<span class="comment">//初始化flash</span></span><br><span class="line">                <span class="keyword">if</span> (ret)</span><br><span class="line">                        <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (workmode == WORK_MODE_BOOT) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_UPDATE_GPT</span></span><br><span class="line">                <span class="type">int</span> <span class="title function_">sunxi_update_gpt</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">                sunxi_update_gpt();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BOOT_GUI</span></span><br><span class="line">                <span class="type">void</span> <span class="title function_">board_bootlogo_display</span><span class="params">(<span class="type">void</span>)</span>;	<span class="comment">//显示logo</span></span><br><span class="line">                board_bootlogo_display();</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_SPINOR_JPEG</span></span><br><span class="line">                <span class="type">int</span> <span class="title function_">sunxi_jpeg_display</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *filename)</span>;</span><br><span class="line">                sunxi_jpeg_display(<span class="string">&quot;bootlogo&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                sunxi_probe_partition_map();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_ROTPK_BURN_ENABLE_BY_TOOL</span></span><br><span class="line">        <span class="keyword">if</span> (get_boot_work_mode() == WORK_MODE_BOOT) &#123;</span><br><span class="line">                ret = sunxi_burn_rotpk();</span><br><span class="line">                <span class="keyword">if</span> (ret)</span><br><span class="line">                        <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sunxi-flash-init-ext"><a href="#sunxi-flash-init-ext" class="headerlink" title="sunxi_flash_init_ext"></a>sunxi_flash_init_ext</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sunxi_flash_init_ext</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> workmode     = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> storage_type = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> state       = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        workmode     = get_boot_work_mode();</span><br><span class="line">        storage_type = get_boot_storage_type();</span><br><span class="line"></span><br><span class="line">        tick_printf(<span class="string">&quot;workmode = %d,storage type = %d\n&quot;</span>, workmode, storage_type);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (workmode == WORK_MODE_BOOT ||</span><br><span class="line">            workmode == WORK_MODE_SPRITE_RECOVERY) &#123;</span><br><span class="line">                state = sunxi_flash_boot_init(storage_type, workmode);	<span class="comment">//注册flash驱动、并调用驱动初始化flash</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((workmode &amp; WORK_MODE_PRODUCT) || (workmode == <span class="number">0x30</span>)) &#123;</span><br><span class="line">                state = sunxi_flash_probe();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (workmode &amp; WORK_MODE_UPDATE) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//init blk dev</span></span><br><span class="line">        sunxi_flash_init_blk();	<span class="comment">//初始化块设备描述符</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">board_env_late_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (get_boot_work_mode() == WORK_MODE_BOOT) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_KEYBOX</span></span><br><span class="line">                sunxi_keybox_init();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_SPINOR_BMP</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_CMD_FAT)</span></span><br><span class="line">                fat_read_logo_to_kernel(<span class="string">&quot;bootlogo.bmp&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">                read_bmp_to_kernel(<span class="string">&quot;bootlogo&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">sunxi_burn_key</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMD_SUNXI_AUTO_FEL</span></span><br><span class="line">        sunxi_auto_fel_by_usb();        <span class="comment">//进入auto_fel</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_BURN</span></span><br><span class="line"><span class="meta">#  <span class="keyword">ifdef</span> CONFIG_SUNXI_FAST_BURN_KEY</span></span><br><span class="line">        <span class="keyword">if</span> (!sunxi_burn_key_processed)</span><br><span class="line"><span class="meta">#  <span class="keyword">endif</span></span></span><br><span class="line">        &#123;</span><br><span class="line">                pr_msg(<span class="string">&quot;try to burn key\n&quot;</span>);</span><br><span class="line">                sunxi_keydata_burn_by_usb();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h5 id="board-late-init"><a href="#board-late-init" class="headerlink" title="board_late_init"></a>board_late_init</h5><p>fastlogo、AB系统切换、配置lradc按键、读取flash中私有&#x2F;安全分区的数据到环境变量、验证cpu型号、限制cpu频率</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">board_late_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> work_mode = get_boot_work_mode();</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_TV_FASTLOGO</span></span><br><span class="line">        <span class="comment">//若是电视产品需要快速显示logo</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">fastlogo_t</span> *<span class="title">p_fastlogo</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (work_mode == WORK_MODE_BOOT || work_mode == WORK_MODE_CARD_UPDATE ||</span><br><span class="line">            work_mode == WORK_MODE_CARD_PRODUCT) &#123;</span><br><span class="line">                p_fastlogo =</span><br><span class="line">                        create_fastlogo_inst(<span class="string">&quot;bootlogo.bmp&quot;</span>, <span class="string">&quot;bootloader&quot;</span>,</span><br><span class="line">                                             <span class="string">&quot;LogoRegData.bin&quot;</span>, <span class="string">&quot;bootloader&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (p_fastlogo) &#123;</span><br><span class="line">                        p_fastlogo-&gt;display_fastlogo(p_fastlogo);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (work_mode == WORK_MODE_BOOT) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_SWITCH_SYSTEM</span></span><br><span class="line">                sunxi_auto_switch_system();     <span class="comment">//自动切换到A或B系统 The system will switch according to systemab_next</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PMIC_TPS65185</span></span><br><span class="line">                tps65185_modules_init();               <span class="comment">//一个电源相关的芯片。在电子阅读器产品</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_LRADC_VOL</span></span><br><span class="line"><span class="comment">/* Note: lradc should be initialized 30ms before</span></span><br><span class="line"><span class="comment"> * sunxi_read_lradc_vol() which lradc-sample-rate</span></span><br><span class="line"><span class="comment"> * is 500Hz.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">                lradc_reg_init();              <span class="comment">//lradc初始化、应该是按键的功能。通过设备树配置</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_EINK200_SUNXI</span></span><br><span class="line">                sunxi_eink_fresh_image(<span class="string">&quot;bootlogo.bmp&quot;</span>, <span class="number">0x04</span>);   <span class="comment">//水墨屏显示logo</span></span><br><span class="line">                __udelay(<span class="number">3000</span>); <span class="comment">//这个延时应该就是等待水墨屏的反应</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_ARISC_EXIST</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_ARISC_DEASSERT_BEFORE_KERNEL</span></span><br><span class="line">                sunxi_arisc_probe();    <span class="comment">//没用的</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_OTA_TURNNING</span></span><br><span class="line">                update_boot0_head_for_ota();    <span class="comment">//根据卡类型决定如何更新boot0首部数据</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_ANDROID_BOOT</span></span><br><span class="line">                sunxi_fastboot_status_read();   <span class="comment">//设值gd-&gt;lockflag  用来使能fastboot?</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_USER_KEY</span></span><br><span class="line">                <span class="comment">/* update mac/wifi serial info in env */</span></span><br><span class="line">                <span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">update_user_data</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">                update_user_data();     <span class="comment">//读取flash中私有/安全分区的数据到环境变量</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_CHECK_LIMIT_VERIFY</span></span><br><span class="line">                <span class="type">int</span> <span class="title function_">sunxi_check_cpu_gpu_verify</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">                sunxi_check_cpu_gpu_verify();   <span class="comment">//验证cpu型号、限制cpu频率</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_CHECK_CUSTOMER_RESERVED_ID</span></span><br><span class="line">                <span class="type">int</span> <span class="title function_">sunxi_check_customer_reserved_id</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">                sunxi_check_customer_reserved_id();     <span class="comment">//检查客户的加密id</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_UBIFS       <span class="comment">//用于nand flash的一种文件系统</span></span></span><br><span class="line">                <span class="keyword">if</span> ((get_boot_storage_type() == STORAGE_NAND) &amp;&amp; nand_use_ubi())</span><br><span class="line">                        ubi_nand_update_ubi_env();</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                sunxi_update_partinfo();        <span class="comment">//更新分区信息到环境变量</span></span><br><span class="line">                <span class="keyword">if</span> (sunxi_update_rotpk_info()) &#123;        <span class="comment">//检查efuse的rotpk数据</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_POWER</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_BMU</span></span><br><span class="line">                axp_battery_status_handle();    <span class="comment">//根据电池状态、是否接入电源充电、显示充电图标，电压太低会关机</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                sunxi_respond_ir_key_action();  <span class="comment">//响应红外遥控（处理gd-&gt;keyvalue）</span></span><br><span class="line">                sunxi_update_bootcmd();         <span class="comment">//根据启动介质设置bootcmd环境变量</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_SERIAL</span></span><br><span class="line">                sunxi_set_serial_num(); <span class="comment">//根据芯片设置串口数量到环境变量</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_LRADC_VOL</span></span><br><span class="line">                sunxi_read_lradc_vol();         <span class="comment">//读取lradc的值、判断按键状态，并保存到环境变量</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_OF_SEPARATE)</span></span><br><span class="line">                sunxi_update_fdt_para_for_kernel();     <span class="comment">//使用kernel的设备树</span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(CONFIG_SUNXI_NECESSARY_REPLACE_FDT)</span></span><br><span class="line">                sunxi_replace_fdt_v2();         <span class="comment">//替换设备树</span></span><br><span class="line">                sunxi_update_fdt_para_for_kernel();</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(CONFIG_SUNXI_REPLACE_FDT_FROM_PARTITION)</span></span><br><span class="line">                sunxi_replace_fdt();            </span><br><span class="line">                sunxi_update_fdt_para_for_kernel();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_TV_FASTLOGO</span></span><br><span class="line">                <span class="keyword">if</span> (p_fastlogo) &#123;</span><br><span class="line">                        p_fastlogo-&gt;reserve_memory(p_fastlogo); <span class="comment">//给fastlogo保留内存</span></span><br><span class="line">                &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_OTA_TURNNING</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">update_boot0_head_for_ota</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> FPGA_PLATFORM</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MMC_SUNXI</span></span><br><span class="line">        <span class="type">int</span> storage_type = get_boot_storage_type();</span><br><span class="line">        <span class="type">int</span> card_num = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (storage_type == STORAGE_EMMC3) &#123;</span><br><span class="line">                card_num = <span class="number">3</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (storage_type == STORAGE_SD) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;       <span class="comment">//sd不能进行ota？</span></span><br><span class="line">        &#125;</span><br><span class="line">        ret = mmc_request_update_boot0(card_num);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_TURNNING_DRAM</span></span><br><span class="line">        <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">                ret = get_boot_dram_update_flag();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                pr_debug(<span class="string">&quot;begin to update boot0 atfer ota\n&quot;</span>);</span><br><span class="line">                ret = sunxi_flash_update_boot0();</span><br><span class="line">                pr_msg(<span class="string">&quot;update boot0 %s\n&quot;</span>, ret == <span class="number">0</span> ? <span class="string">&quot;success&quot;</span> : <span class="string">&quot;fail&quot;</span>);</span><br><span class="line">                <span class="comment">/* if update fail, should reset the system */</span></span><br><span class="line">                <span class="comment">/* if(ret) */</span></span><br><span class="line">                <span class="comment">/* &#123; */</span></span><br><span class="line">                <span class="comment">/* do_reset(NULL, 0, 0,NULL); */</span></span><br><span class="line">                <span class="comment">/* &#125; */</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sunxi_fastboot_status_read</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">char</span> d_buffer[<span class="number">32</span>];</span><br><span class="line">        <span class="type">char</span> buffer[<span class="number">512</span>];</span><br><span class="line">        <span class="type">int</span> d_data_len;</span><br><span class="line">        <span class="type">int</span> data_len;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* read locked or unlocked flag in secure storage */</span></span><br><span class="line">        <span class="built_in">memset</span>(buffer, <span class="number">0x00</span>, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">        <span class="built_in">memset</span>(d_buffer, <span class="number">0x00</span>, <span class="keyword">sizeof</span>(d_buffer));</span><br><span class="line">        <span class="keyword">if</span> (sunxi_secure_storage_init()) &#123;      <span class="comment">//安全储存</span></span><br><span class="line">                pr_err(<span class="string">&quot;secure storage init fail\n&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ret = sunxi_secure_object_read(<span class="string">&quot;device_unlock&quot;</span>, d_buffer, <span class="number">32</span>,   <span class="comment">//读取安全存储的对象</span></span><br><span class="line">                                               &amp;d_data_len);</span><br><span class="line">                ret = sunxi_secure_object_read(<span class="string">&quot;fastboot_status_flag&quot;</span>, buffer,</span><br><span class="line">                                               <span class="number">512</span>, &amp;data_len);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((!ret) &amp;&amp; (!<span class="built_in">strcmp</span>(buffer, <span class="string">&quot;locked&quot;</span>)) &amp;&amp;</span><br><span class="line">                    (!<span class="built_in">strcmp</span>(d_buffer, <span class="string">&quot;unlock&quot;</span>))) &#123;</span><br><span class="line">                        env_set(<span class="string">&quot;verifiedbootstate&quot;</span>, <span class="string">&quot;yellow&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//根据存储的信息。初始lockflag</span></span><br><span class="line">                <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                        pr_msg(<span class="string">&quot;sunxi secure storage has no flag\n&quot;</span>);</span><br><span class="line">                        gd-&gt;lockflag = SUNXI_LOCKED;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(buffer, <span class="string">&quot;unlocked&quot;</span>)) &#123;</span><br><span class="line">                                pr_force(<span class="string">&quot;find fastboot unlock flag\n&quot;</span>);</span><br><span class="line">                                gd-&gt;lockflag = SUNXI_UNLOCKED;</span><br><span class="line">                                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(buffer, <span class="string">&quot;locked&quot;</span>)) &#123;</span><br><span class="line">                                pr_force(<span class="string">&quot;find fastboot locked flag\n&quot;</span>);</span><br><span class="line">                                gd-&gt;lockflag = SUNXI_LOCKED;</span><br><span class="line">                                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        pr_force(<span class="string">&quot;do not find fastboot status flag\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">axp_battery_status_handle</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> battery_status;</span><br><span class="line">        <span class="type">int</span> ret = <span class="number">0</span>, bat_exist = <span class="number">0</span>, ntc_status = <span class="number">-1</span>, charge_mode;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取一些设备树中电池的信息</span></span><br><span class="line">        ret = script_parser_fetch(FDT_PATH_POWER_SPLY, <span class="string">&quot;battery_exist&quot;</span>, &amp;bat_exist, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                bat_exist = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!bat_exist)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        ret = bmu_get_battery_probe();</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        ret = script_parser_fetch(FDT_PATH_POWER_SPLY, <span class="string">&quot;ntc_status&quot;</span>, &amp;ntc_status, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                ntc_status = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        bmu_set_ntc_onoff(ntc_status);</span><br><span class="line"></span><br><span class="line">        ret = script_parser_fetch(FDT_PATH_POWER_SPLY, <span class="string">&quot;charge_mode&quot;</span>, &amp;charge_mode, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                charge_mode = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取电池状态</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_AXP_LATE_INFO</span></span><br><span class="line">        battery_status = axp_get_battery_status();</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        battery_status = gd-&gt;pmu_runtime_chgcur;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">//获取充电模式</span></span><br><span class="line">        <span class="keyword">if</span> (gd-&gt;chargemode == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((battery_status == BATTERY_RATIO_TOO_LOW_WITH_DCIN)</span><br><span class="line">                        || (battery_status == BATTERY_RATIO_TOO_LOW_WITHOUT_DCIN)</span><br><span class="line">                        || (battery_status == BATTERY_VOL_TOO_LOW)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_EINK200_SUNXI</span></span><br><span class="line">                        sunxi_eink_fresh_image(<span class="string">&quot;bat\\bat0.bmp&quot;</span>, <span class="number">0x04</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> CONFIG_CMD_SUNXI_BMP</span></span><br><span class="line">                        sunxi_bmp_display(<span class="string">&quot;bat\\bat0.bmp&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">                        tick_printf(<span class="string">&quot;battery ratio is low with dcin,to be shutdown\n&quot;</span>);</span><br><span class="line">                        mdelay(<span class="number">3000</span>);</span><br><span class="line">                        sunxi_board_shutdown();</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">                <span class="comment">//低电压处理</span></span><br><span class="line">                sunxi_bat_low_vol_handle();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (charge_mode == <span class="number">2</span>) &#123;</span><br><span class="line">                        tick_printf(<span class="string">&quot;press power_on to start up\n&quot;</span>);</span><br><span class="line">                        sunxi_bat_key_handle();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_EINK200_SUNXI</span></span><br><span class="line">                        <span class="comment">//显示充电图标</span></span><br><span class="line">                        sunxi_eink_fresh_image(<span class="string">&quot;bat\\battery_charge.bmp&quot;</span>, <span class="number">0x04</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> CONFIG_CMD_SUNXI_BMP</span></span><br><span class="line">                        sunxi_bmp_display(<span class="string">&quot;bat\\battery_charge.bmp&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((battery_status == BATTERY_RATIO_TOO_LOW_WITHOUT_DCIN) || (battery_status == BATTERY_VOL_TOO_LOW)) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_EINK200_SUNXI</span></span><br><span class="line">                sunxi_eink_fresh_image(<span class="string">&quot;bat\\low_pwr.bmp&quot;</span>, <span class="number">0x04</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> CONFIG_CMD_SUNXI_BMP</span></span><br><span class="line">                sunxi_bmp_display(<span class="string">&quot;bat\\low_pwr.bmp&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                tick_printf(<span class="string">&quot;battery ratio or vol is low ,to be shutdown\n&quot;</span>);</span><br><span class="line">                mdelay(<span class="number">3000</span>);</span><br><span class="line">                <span class="comment">//电池电压低又无接入电源、关机</span></span><br><span class="line">                sunxi_board_shutdown();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (charge_mode == <span class="number">2</span> || charge_mode == <span class="number">0</span>)</span><br><span class="line">                gd-&gt;chargemode = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//响应红外遥控</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">sunxi_respond_ir_key_action</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> key_value;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_IR_BOOT_RECOVERY</span></span><br><span class="line">        <span class="type">int</span> ir_time_out = get_timer_masked();</span><br><span class="line">        <span class="keyword">while</span> (get_timer_masked() - ir_time_out &lt; <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (gd-&gt;ir_detect_status != IR_DETECT_NULL)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ir_disable();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        key_value = gd-&gt;key_pressd_value;</span><br><span class="line">        <span class="comment">/* //ir factory or key factory */</span></span><br><span class="line">        <span class="keyword">if</span> (key_value == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key_value == BOOT_FACTORY_VALUE) &#123;   <span class="comment">//恢复出厂、擦除数据</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[boot factory] set misc : boot factory and wipe data\n&quot;</span>);</span><br><span class="line">                write_recovery_msg_to_misc(<span class="string">&quot;ir-factory&quot;</span>);       <span class="comment">//将命令写入flash</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key_value == EFEX_VALUE) &#123;</span><br><span class="line">                <span class="comment">/* //ir efex or key efex */</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[boot efex] set misc : boot efex\n&quot;</span>);</span><br><span class="line">                write_recovery_msg_to_misc(<span class="string">&quot;ir-efex&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key_value == SPRITE_RECOVERY_VALUE) &#123;</span><br><span class="line">                <span class="comment">/* //ir sprite recovery */</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[ir sysrecovery] set misc : boot recovery and sysrecovery \n&quot;</span>);</span><br><span class="line">                write_recovery_msg_to_misc(<span class="string">&quot;sysrecovery&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key_value == BOOT_RECOVERY_VALUE) &#123;</span><br><span class="line">                <span class="comment">/* //ir recovery or key recovery */</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[boot recovery] set misc : boot recovery\n&quot;</span>);</span><br><span class="line">                write_recovery_msg_to_misc(<span class="string">&quot;ir-or-key-recovery&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">eth_initialize</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> num_devices = <span class="number">0</span>;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">udevice</span> *<span class="title">dev</span>;</span></span><br><span class="line"></span><br><span class="line">        eth_common_init();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Devices need to write the hwaddr even if not started so that Linux</span></span><br><span class="line"><span class="comment">         * will have access to the hwaddr that u-boot stored for the device.</span></span><br><span class="line"><span class="comment">         * This is accomplished by attempting to probe each device and calling</span></span><br><span class="line"><span class="comment">         * their write_hwaddr() operation.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        uclass_first_device(UCLASS_ETH, &amp;dev);</span><br><span class="line">        <span class="keyword">if</span> (!dev) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;No ethernet found.\n&quot;</span>);</span><br><span class="line">                bootstage_error(BOOTSTAGE_ID_NET_ETH_START);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">char</span> *ethprime = env_get(<span class="string">&quot;ethprime&quot;</span>);</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">udevice</span> *<span class="title">prime_dev</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ethprime)</span><br><span class="line">                        prime_dev = eth_get_dev_by_name(ethprime);</span><br><span class="line">                <span class="keyword">if</span> (prime_dev) &#123;</span><br><span class="line">                        eth_set_dev(prime_dev);</span><br><span class="line">                        eth_current_changed();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        eth_set_dev(<span class="literal">NULL</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                bootstage_mark(BOOTSTAGE_ID_NET_ETH_INIT);</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (num_devices)</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">&quot;, &quot;</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">&quot;eth%d: %s&quot;</span>, dev-&gt;seq, dev-&gt;name);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (ethprime &amp;&amp; dev == prime_dev)</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">&quot; [PRIME]&quot;</span>);</span><br><span class="line"></span><br><span class="line">                        eth_write_hwaddr(dev);</span><br><span class="line"></span><br><span class="line">                        uclass_next_device(&amp;dev);</span><br><span class="line">                        num_devices++;</span><br><span class="line">                &#125; <span class="keyword">while</span> (dev);</span><br><span class="line"></span><br><span class="line">                putc(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> num_devices;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * i2c_init_all():</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * not longer needed, will deleted. Actual init the SPD_BUS</span></span><br><span class="line"><span class="comment"> * for compatibility.</span></span><br><span class="line"><span class="comment"> * i2c_adap[] must be initialized beforehead with function pointers and</span></span><br><span class="line"><span class="comment"> * data, including speed and slaveaddr.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">i2c_init_all</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        i2c_init_board();	<span class="comment">//无实现</span></span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  Change the active I2C bus. Subsequent read/write calls will</span></span><br><span class="line"><span class="comment"> *  go to this one. Sets all of the muxes in a proper condition</span></span><br><span class="line"><span class="comment"> *  if that bus is behind muxes.</span></span><br><span class="line"><span class="comment"> *  If previously selected bus is behind the muxes turns off all the</span></span><br><span class="line"><span class="comment"> *  muxes along the path to that bus.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        i2c_set_bus_num(CONFIG_SYS_SPD_BUS_NUM);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sunxi_flash_init_ext</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> workmode     = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> storage_type = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> state       = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        workmode     = get_boot_work_mode();</span><br><span class="line">        storage_type = get_boot_storage_type();</span><br><span class="line"></span><br><span class="line">        tick_printf(<span class="string">&quot;workmode = %d,storage type = %d\n&quot;</span>, workmode, storage_type);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (workmode == WORK_MODE_USB_DEBUG) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (workmode == WORK_MODE_BOOT ||</span><br><span class="line">                   workmode == WORK_MODE_SPRITE_RECOVERY) &#123;</span><br><span class="line">                state = sunxi_flash_boot_init(storage_type, workmode);	<span class="comment">//调用不同的接口初始化不同的flash</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((workmode &amp; WORK_MODE_PRODUCT) || (workmode == <span class="number">0x30</span>)) &#123;</span><br><span class="line">                state = sunxi_flash_probe();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (workmode &amp; WORK_MODE_UPDATE) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//init blk dev</span></span><br><span class="line">        sunxi_flash_init_blk();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br><span class="line">	</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_UPDATE_GPT</span></span><br><span class="line"><span class="comment">//更新GPT给uboot、内核使用</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sunxi_update_gpt</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_UBIFS</span></span><br><span class="line">        <span class="keyword">if</span> (((STORAGE_SPI_NAND == get_boot_storage_type_ext()) ||</span><br><span class="line">                        (STORAGE_NAND == get_boot_storage_type_ext())) &amp;&amp; nand_use_ubi()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(*FLASH_WIRTE)</span><span class="params">(uint start_block, uint nblock, <span class="type">void</span> *buffer)</span>;</span><br><span class="line">        FLASH_WIRTE flash_write_pt = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="type">char</span> *buf;</span><br><span class="line">        <span class="type">int</span>   data_len = GPT_UPDATE_BUF_SIZE;</span><br><span class="line">        <span class="type">int</span>   ret = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> storage_type = get_boot_storage_type();</span><br><span class="line">        <span class="type">int</span> i, j;</span><br><span class="line"></span><br><span class="line">        <span class="type">char</span> char8_name[PARTNAME_SZ] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        buf = (<span class="type">char</span> *)memalign(CONFIG_SYS_CACHELINE_SIZE, GPT_UPDATE_BUF_SIZE);</span><br><span class="line">        <span class="keyword">if</span> (buf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                pr_err(<span class="string">&quot;malloc fail\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">char</span>  *gpt_buf = buf;</span><br><span class="line">        gpt_header *gpt_head     = (gpt_header *)(buf + GPT_HEAD_OFFSET);</span><br><span class="line">        gpt_entry *entry             = (gpt_entry *)(buf + GPT_ENTRY_OFFSET);</span><br><span class="line">        <span class="keyword">if</span> ((storage_type == STORAGE_SD) || (storage_type == STORAGE_EMMC)</span><br><span class="line">                || (storage_type == STORAGE_EMMC0))</span><br><span class="line">                sunxi_flash_phyread(<span class="number">0</span>, GPT_BUFF_SIZE/<span class="number">512</span>, buf);	<span class="comment">//读取flash中的gpt</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">                sunxi_flash_read(<span class="number">0</span>, GPT_BUFF_SIZE/<span class="number">512</span>, buf);</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//解析gpt</span></span><br><span class="line">        <span class="keyword">if</span> (gpt_head-&gt;reserved1 != <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (gpt_head-&gt;signature == GPT_HEADER_SIGNATURE) &#123;</span><br><span class="line">                        u32 calc_crc32   = <span class="number">0</span>;</span><br><span class="line">                        u32 backup_crc32 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                        backup_crc32       = gpt_head-&gt;header_crc32;</span><br><span class="line">                        gpt_head-&gt;header_crc32 = <span class="number">0</span>;</span><br><span class="line">                        calc_crc32 = crc32(<span class="number">0</span>, (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *)gpt_head,</span><br><span class="line">                                           <span class="keyword">sizeof</span>(gpt_header));</span><br><span class="line">                        gpt_head-&gt;header_crc32 = backup_crc32;</span><br><span class="line">                        <span class="keyword">if</span> (calc_crc32 != backup_crc32) &#123;</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">&quot;the GPT table is bad\n&quot;</span>);</span><br><span class="line">                                <span class="keyword">goto</span> __err_end;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">/* gpt_show_partition_info(buffer); */</span></span><br><span class="line">                &#125;</span><br><span class="line">            	<span class="comment">//读取分区名称</span></span><br><span class="line">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; gpt_head-&gt;num_partition_entries; i++) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; PARTNAME_SZ; j++) &#123;</span><br><span class="line">                                char8_name[j] = (<span class="type">char</span>)(entry[i].partition_name[j]);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> ((get_boot_work_mode() == WORK_MODE_BOOT) &amp;&amp; (!<span class="built_in">strncmp</span>(char8_name, <span class="string">&quot;UDISK&quot;</span>, <span class="keyword">sizeof</span>(<span class="string">&quot;UDISK&quot;</span>)))) &#123;</span><br><span class="line">                                <span class="type">char</span> temp_partition_name[<span class="number">16</span>] = &#123;CONFIG_LAST_PARTITION_NAME&#125;;</span><br><span class="line">                                <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="built_in">strlen</span>((<span class="type">const</span> <span class="type">char</span> *)temp_partition_name); j++) &#123;</span><br><span class="line">                                        entry[i].partition_name[j] = (<span class="type">efi_char16_t</span>)temp_partition_name[j];</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="comment">/* update last partiton name ok set gpt_head-&gt;reserved1 = 0x1 */</span></span><br><span class="line">                                gpt_head-&gt;reserved1 = <span class="number">0x1</span>;</span><br><span class="line">                                <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; PARTNAME_SZ; j++) &#123;</span><br><span class="line">                                        char8_name[j] = (<span class="type">char</span>)(entry[i].partition_name[j]);</span><br><span class="line">                                &#125;</span><br><span class="line">                                pr_msg(<span class="string">&quot;GPT:%-12s: %-12llx  %-12llx\n&quot;</span>, char8_name,</span><br><span class="line">                                                entry[i].starting_lba, entry[i].ending_lba);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        pr_msg(<span class="string">&quot;GPT:%-12s: %-12llx  %-12llx\n&quot;</span>, char8_name,</span><br><span class="line">                                        entry[i].starting_lba, entry[i].ending_lba);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                gpt_head-&gt;partition_entry_array_crc32 = <span class="number">0</span>;</span><br><span class="line">                gpt_head-&gt;partition_entry_array_crc32 = crc32(<span class="number">0</span>, (<span class="type">unsigned</span> <span class="type">char</span> <span class="type">const</span> *)entry,</span><br><span class="line">                        (gpt_head-&gt;num_partition_entries)*(gpt_head-&gt;sizeof_partition_entry));</span><br><span class="line"></span><br><span class="line">                <span class="comment">//gpt crc32</span></span><br><span class="line">                gpt_head-&gt;header_crc32 = <span class="number">0</span>;</span><br><span class="line">                gpt_head-&gt;header_crc32 = crc32(<span class="number">0</span>, (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *)gpt_head, gpt_head-&gt;header_size);</span><br><span class="line">                <span class="comment">/*write GPT for u-boot use*/</span></span><br><span class="line">                ret = sunxi_sprite_write(<span class="number">0</span>, (data_len+<span class="number">511</span>)&gt;&gt;<span class="number">9</span>, gpt_buf);</span><br><span class="line">                <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">                        debug(<span class="string">&quot;%s:write gpt sectors fail\n&quot;</span>, __func__);</span><br><span class="line">                        <span class="keyword">goto</span> __err_end;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/*write GPT for kenerl use if sdmmc*/</span></span><br><span class="line">                <span class="keyword">if</span> (STORAGE_EMMC == storage_type || STORAGE_EMMC3 == storage_type</span><br><span class="line">                                || storage_type == STORAGE_EMMC0 || storage_type == STORAGE_SD) &#123;</span><br><span class="line">                        ret = sunxi_sprite_phywrite(<span class="number">0</span>, (data_len + <span class="number">511</span>) &gt;&gt; <span class="number">9</span>, gpt_buf);</span><br><span class="line">                        <span class="keyword">if</span> (!ret)</span><br><span class="line">                                <span class="keyword">goto</span> __err_end;</span><br><span class="line">                &#125;</span><br><span class="line">                pr_msg(<span class="string">&quot;write primary GPT success\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">                prepare_backup_gpt_header(gpt_head);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (STORAGE_NOR == storage_type) &#123;</span><br><span class="line">                        pr_msg(<span class="string">&quot;spinor: skip backup GPT\n&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (STORAGE_EMMC == storage_type ||</span><br><span class="line">                                STORAGE_EMMC3 == storage_type ||</span><br><span class="line">                                storage_type == STORAGE_EMMC0 ||</span><br><span class="line">                                storage_type == STORAGE_SD)</span><br><span class="line">                                flash_write_pt = sunxi_sprite_phywrite;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                                flash_write_pt = sunxi_sprite_write;</span><br><span class="line"></span><br><span class="line">                        ret = flash_write_pt((u32)(gpt_head-&gt;last_usable_lba + <span class="number">1</span>),</span><br><span class="line">                                        (GPT_BUFF_SIZE - GPT_ENTRY_OFFSET) / <span class="number">512</span>,</span><br><span class="line">                                        gpt_buf + GPT_ENTRY_OFFSET);</span><br><span class="line">                        <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">                                <span class="keyword">goto</span> __err_end;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">/* write back-up gpt HEAD */</span></span><br><span class="line">                        ret = flash_write_pt((u32)gpt_head-&gt;my_lba, <span class="number">1</span>,</span><br><span class="line">                                gpt_buf + GPT_HEAD_OFFSET);</span><br><span class="line">                        <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">                                <span class="keyword">goto</span> __err_end;</span><br><span class="line">                        &#125;</span><br><span class="line">                        pr_msg(<span class="string">&quot;write Backup GPT success\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">free</span>(buf);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">__err_end:</span><br><span class="line">        <span class="built_in">free</span>(buf);</span><br><span class="line">        pr_err(<span class="string">&quot;update gpt fail\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//keybox初始化</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sunxi_keybox_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line">        <span class="type">int</span> workmode;</span><br><span class="line">        workmode = get_boot_work_mode();</span><br><span class="line">        <span class="keyword">if</span> (workmode != WORK_MODE_BOOT)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sunxi_probe_secure_os() == <span class="number">0</span>) &#123;</span><br><span class="line">                pr_msg(<span class="string">&quot;no secure os for keybox operation\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ret = sunxi_keybox_init_key_list_from_env();</span><br><span class="line">        <span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">                pr_err(<span class="string">&quot;sunxi keybox read env failed with:%d&quot;</span>, ret);</span><br><span class="line">        sunxi_secure_storage_init();</span><br><span class="line">        ret = sunxi_keybox_install_keys();</span><br><span class="line">        <span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">                pr_err(<span class="string">&quot;sunxi keybox install failed with:%d&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>初始化ir功能</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">check_ir_boot_recovery</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (ir_sys_cfg())	<span class="comment">//从设备树中获取ir_code，code_num,code_value</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ir_setup())		<span class="comment">//设置ir时钟、寄存器、buff、注册中断服务函数</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        gd-&gt;ir_detect_status  = IR_DETECT_NULL;</span><br><span class="line">        ir_boot_recovery_mode = <span class="number">1</span>;</span><br><span class="line">        <span class="type">ir_timer_t</span>.data       = (<span class="type">unsigned</span> <span class="type">long</span>)&amp;<span class="type">ir_timer_t</span>;</span><br><span class="line">        <span class="type">ir_timer_t</span>.expires    = ir_detect_time;</span><br><span class="line">        <span class="type">ir_timer_t</span>.function   = ir_detect_overtime;</span><br><span class="line">        init_timer(&amp;<span class="type">ir_timer_t</span>);</span><br><span class="line">        add_timer(&amp;<span class="type">ir_timer_t</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>recovery按键检测(有无按下、长按or短按)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">check_recovery_key</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">user_gpio_set_t</span> gpio_recovery;</span><br><span class="line">        __u32 gpio_hd;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line">        <span class="type">int</span> gpio_value = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> used = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> mode = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> press_mode = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> press_time = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (get_boot_work_mode() == WORK_MODE_BOOT) &#123;</span><br><span class="line">                <span class="comment">/*check physical gpio pin*/</span></span><br><span class="line">                ret = script_parser_fetch(KEY_BOOT_RECOVERY, <span class="string">&quot;recovery_key_used&quot;</span>,</span><br><span class="line">                                (<span class="type">int</span> *)&amp;used, <span class="keyword">sizeof</span>(<span class="type">int</span>) / <span class="number">4</span>);</span><br><span class="line">                <span class="keyword">if</span> (ret || !used) &#123;</span><br><span class="line">                        key_info(<span class="string">&quot;[key recovery] no use\n&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ret = fdt_get_one_gpio(KEY_BOOT_RECOVERY, <span class="string">&quot;recovery_key&quot;</span>, &amp;gpio_recovery);</span><br><span class="line">                <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                        key_info(<span class="string">&quot;[key recovery] can&#x27;t find recovery_key config.\n&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                gpio_recovery.mul_sel = <span class="number">0</span>;              <span class="comment">/*forced to input*/</span></span><br><span class="line">                gpio_hd = sunxi_gpio_request(&amp;gpio_recovery, <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (!gpio_hd) &#123;</span><br><span class="line">                        pr_error(<span class="string">&quot;[key recovery] gpio request fail!\n&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                        <span class="comment">/*gpio request fail,just return.*/</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> time;</span><br><span class="line">                gpio_value = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">//连续读取按键值</span></span><br><span class="line">                <span class="keyword">for</span> (time = <span class="number">0</span>; time &lt; <span class="number">5</span>; time++) &#123;</span><br><span class="line">                        gpio_value += gpio_read_one_pin_value(gpio_hd, <span class="number">0</span>);</span><br><span class="line">                        mdelay(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (gpio_value) &#123;</span><br><span class="line">                        key_info(<span class="string">&quot;[key recovery] no key press.\n&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                        <span class="comment">/*no recovery key was pressed, just return.*/</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                key_info(<span class="string">&quot;[key recovery] find the key\n&quot;</span>);</span><br><span class="line">                script_parser_fetch(KEY_BOOT_RECOVERY, <span class="string">&quot;press_mode_enable&quot;</span>,</span><br><span class="line">                        (<span class="type">int</span> *)&amp;press_mode, <span class="keyword">sizeof</span>(<span class="type">int</span>) / <span class="number">4</span>);</span><br><span class="line">                <span class="keyword">if</span> (press_mode == KEY_PRESS_MODE_DISABLE) &#123;</span><br><span class="line">                        script_parser_fetch(KEY_BOOT_RECOVERY, <span class="string">&quot;key_work_mode&quot;</span>,</span><br><span class="line">                                (<span class="type">int</span> *)&amp;mode, <span class="keyword">sizeof</span>(<span class="type">int</span>) / <span class="number">4</span>);</span><br><span class="line">                        key_info(<span class="string">&quot;[key recovery] do not use prese mode, \</span></span><br><span class="line"><span class="string">                                        key_work_mode = %d\n&quot;</span>, mode);</span><br><span class="line">                    <span class="comment">//设备树使能recovery按键</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (press_mode == KEY_PRESS_MODE_ENABLE) &#123;</span><br><span class="line">                        script_parser_fetch(KEY_BOOT_RECOVERY, <span class="string">&quot;key_press_time&quot;</span>,</span><br><span class="line">                                (<span class="type">int</span> *)&amp;press_time, <span class="keyword">sizeof</span>(<span class="type">int</span>) / <span class="number">4</span>);</span><br><span class="line">                        key_info(<span class="string">&quot;[key recovery] use prese mode, \</span></span><br><span class="line"><span class="string">                                and key_press_time = %d ms\n&quot;</span>, press_time);                        </span><br><span class="line">					  gpio_value = <span class="number">0</span>;</span><br><span class="line">                    <span class="comment">//在一段时间内循环读取按键的值</span></span><br><span class="line">                        <span class="keyword">for</span> (time = press_time; time &gt; <span class="number">0</span>; time -= <span class="number">100</span>) &#123;</span><br><span class="line">                                mdelay(<span class="number">100</span>); <span class="comment">/*detect key value per 100ms*/</span></span><br><span class="line">                                gpio_value += gpio_read_one_pin_value(gpio_hd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                                <span class="comment">/*key was loosed during press time,will not detect key value any more*/</span></span><br><span class="line">                                <span class="keyword">if</span> (gpio_value)</span><br><span class="line">                                        <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">/*key was lossed during press time, so use short_press_mode*/</span></span><br><span class="line">                        <span class="keyword">if</span> (gpio_value) &#123;</span><br><span class="line">                                script_parser_fetch(KEY_BOOT_RECOVERY, <span class="string">&quot;short_press_mode&quot;</span>,</span><br><span class="line">                                        (<span class="type">int</span> *)&amp;mode, <span class="keyword">sizeof</span>(<span class="type">int</span>) / <span class="number">4</span>);</span><br><span class="line">                                key_info(<span class="string">&quot;[key recovery] key short press, short_press_mode = %d\n&quot;</span>, mode);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">/*key was always pressed in key_press_time, so use long_press_mode*/</span></span><br><span class="line">                                script_parser_fetch(KEY_BOOT_RECOVERY, <span class="string">&quot;long_press_mode&quot;</span>,</span><br><span class="line">                                        (<span class="type">int</span> *)&amp;mode, <span class="keyword">sizeof</span>(<span class="type">int</span>) / <span class="number">4</span>);</span><br><span class="line">                                key_info(<span class="string">&quot;[key recovery] key long press, long_press_mode = %d\n&quot;</span>, mode);</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">switch</span> (mode) &#123;</span><br><span class="line">                <span class="keyword">case</span> RECOVERY_KEY_EFEX_MODE:</span><br><span class="line">                        gd-&gt;key_pressd_value = RECOVERY_KEY_EFEX_VALUE;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RECOVERY_KEY_ONEKEY_SPRITE_RECOVERY_MODE:</span><br><span class="line">                        gd-&gt;key_pressd_value = RECOVERY_KEY_SPRITE_RECOVERY_VALUE;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RECOVERY_KEY_RECOVERY_MODE:</span><br><span class="line">                        gd-&gt;key_pressd_value = RECOVERY_KEY_BOOT_RECOVERY_VALUE;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RECOVERY_KEY_FACTORY_MODE:</span><br><span class="line">                        gd-&gt;key_pressd_value = RECOVERY_KEY_BOOT_FACTORY_VALUE;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                        gd-&gt;key_pressd_value = RECOVERY_KEY_BOOT_RECOVERY_VALUE;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sunxi_flash_boot_init</span><span class="params">(<span class="type">int</span> storage_type, <span class="type">int</span> workmode)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> state;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (storage_type) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_NAND</span></span><br><span class="line">        <span class="keyword">case</span> STORAGE_NAND:</span><br><span class="line">        <span class="keyword">case</span> STORAGE_SPI_NAND: &#123;</span><br><span class="line">                <span class="type">int</span> boot_mode = workmode == WORK_MODE_SPRITE_RECOVERY ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">                current_flash = &amp;sunxi_nand_desc;</span><br><span class="line">                state    = current_flash-&gt;init(boot_mode, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_SDMMC</span></span><br><span class="line">        <span class="keyword">case</span> STORAGE_SD:</span><br><span class="line">        <span class="keyword">case</span> STORAGE_EMMC:</span><br><span class="line">        <span class="keyword">case</span> STORAGE_EMMC3: &#123;</span><br><span class="line">                <span class="type">int</span> card_no;</span><br><span class="line">                <span class="comment">//sdmmc handle init</span></span><br><span class="line">                <span class="keyword">if</span> (storage_type == STORAGE_SD)</span><br><span class="line">                        card_no = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (storage_type == STORAGE_EMMC)</span><br><span class="line">                        card_no = <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                        card_no = <span class="number">3</span>;</span><br><span class="line">                <span class="keyword">if</span> (workmode == WORK_MODE_CARD_PRODUCT)</span><br><span class="line">                        current_flash = &amp;sunxi_sdmmcs_desc;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                        current_flash = &amp;sunxi_sdmmc_desc;</span><br><span class="line">                state                 = current_flash-&gt;init(workmode, card_no);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_SPINOR</span></span><br><span class="line">        <span class="keyword">case</span> STORAGE_NOR: &#123;</span><br><span class="line">                current_flash = &amp;sunxi_spinor_desc;</span><br><span class="line">                state    = current_flash-&gt;init(workmode, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">                pr_err(<span class="string">&quot;not support\n&quot;</span>);</span><br><span class="line">                state = <span class="number">-1</span>;</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (state != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        sprite_flash = current_flash;</span><br><span class="line">        tick_printf(<span class="string">&quot;sunxi flash init ok\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/05/31/killer-blog/Linux/uboot_1/" data-id="cmbcy7rhj0028t8mtg816fngh" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2025/05/31/killer-blog/Linux/systemd_WIFI_auto_reconnect/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2025/05/31/killer-blog/C_CPP/understand_c/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">June 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">May 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/pwm/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/uart/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/worklife/2025%E6%B1%82%E8%81%8C%E5%87%86%E5%A4%87/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/other/tools/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/i2c_LSM303AGR/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>