<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="dsoftbus core（上）好，现在压力给到了core目录，这里是服务端的实现，代码应该会复杂很多，我门应该从哪里入手？softbus服务必须向samgr注册，那么就从这个入手。 了解一下samgr这个是如何使用的。 samgr这个samgr的使用还有复杂，建议直接看readme：https:&#x2F;&#x2F;gitee.com&#x2F;openharmony&#x2F;distributedschedule_samgr_l">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2025/06/01/killer-blog/OpenHarmony/dsoftbus_core/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="dsoftbus core（上）好，现在压力给到了core目录，这里是服务端的实现，代码应该会复杂很多，我门应该从哪里入手？softbus服务必须向samgr注册，那么就从这个入手。 了解一下samgr这个是如何使用的。 samgr这个samgr的使用还有复杂，建议直接看readme：https:&#x2F;&#x2F;gitee.com&#x2F;openharmony&#x2F;distributedschedule_samgr_l">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-06-01T00:23:34.670Z">
<meta property="article:modified_time" content="2025-06-01T00:23:34.670Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-killer-blog/OpenHarmony/dsoftbus_core" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/06/01/killer-blog/OpenHarmony/dsoftbus_core/" class="article-date">
  <time class="dt-published" datetime="2025-06-01T00:23:34.670Z" itemprop="datePublished">2025-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="dsoftbus-core（上）"><a href="#dsoftbus-core（上）" class="headerlink" title="dsoftbus core（上）"></a>dsoftbus core（上）</h2><p>好，现在压力给到了core目录，这里是服务端的实现，代码应该会复杂很多，我门应该从哪里入手？softbus服务必须向samgr注册，那么就从这个入手。</p>
<p>了解一下samgr这个是如何使用的。</p>
<h3 id="samgr"><a href="#samgr" class="headerlink" title="samgr"></a>samgr</h3><p>这个samgr的使用还有复杂，建议直接看readme：<a target="_blank" rel="noopener" href="https://gitee.com/openharmony/distributedschedule_samgr_lite">https://gitee.com/openharmony/distributedschedule_samgr_lite</a></p>
<h4 id="开发服务"><a href="#开发服务" class="headerlink" title="开发服务"></a>开发服务</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义服务</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ExampleService</span> &#123;</span></span><br><span class="line">    INHERIT_SERVICE;</span><br><span class="line">    INHERIT_IUNKNOWNENTRY(DefaultFeatureApi);</span><br><span class="line">    Identity identity;</span><br><span class="line">&#125; ExampleService;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建服务对象</span></span><br><span class="line"><span class="type">static</span> ExampleService g_example = &#123;</span><br><span class="line">    .GetName = GetName,</span><br><span class="line">    .Initialize = Initialize,</span><br><span class="line">    .MessageHandle = MessageHandle,</span><br><span class="line">    .GetTaskConfig = GetTaskConfig,</span><br><span class="line">    SERVER_IPROXY_IMPL_BEGIN,</span><br><span class="line">        .Invoke = <span class="literal">NULL</span>,</span><br><span class="line">        .SyncCall = SyncCall,</span><br><span class="line">    IPROXY_END,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//向samgr注册接口</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    SAMGR_GetInstance()-&gt;RegisterService((Service *)&amp;g_example);</span><br><span class="line">    SAMGR_GetInstance()-&gt;RegisterDefaultFeatureApi(EXAMPLE_SERVICE, GET_IUNKNOWN(g_example));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//定义服务初始化入口</span></span><br><span class="line">SYSEX_SERVICE_INIT(Init);</span><br></pre></td></tr></table></figure>

<h4 id="开发服务子功能"><a href="#开发服务子功能" class="headerlink" title="开发服务子功能"></a>开发服务子功能</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义功能</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">DemoFeature</span> &#123;</span></span><br><span class="line">    INHERIT_FEATURE;</span><br><span class="line">    INHERIT_IUNKNOWNENTRY(DemoApi);</span><br><span class="line">    Identity identity;</span><br><span class="line">    Service *parent;</span><br><span class="line">&#125; DemoFeature;</span><br><span class="line"><span class="comment">//功能对象</span></span><br><span class="line"><span class="type">static</span> DemoFeature g_example = &#123;</span><br><span class="line">    .GetName = FEATURE_GetName,</span><br><span class="line">    .OnInitialize = FEATURE_OnInitialize,</span><br><span class="line">    .OnStop = FEATURE_OnStop,</span><br><span class="line">    .OnMessage = FEATURE_OnMessage,</span><br><span class="line">    DEFAULT_IUNKNOWN_ENTRY_BEGIN,</span><br><span class="line">        .AsyncCall = AsyncCall,</span><br><span class="line">        .AsyncTimeCall = AsyncTimeCall,</span><br><span class="line">        .SyncCall = SyncCall,</span><br><span class="line">        .AsyncCallBack = AsyncCallBack,</span><br><span class="line">    DEFAULT_IUNKNOWN_ENTRY_END,</span><br><span class="line">    .identity = &#123;<span class="number">-1</span>, <span class="number">-1</span>, <span class="literal">NULL</span>&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//向samgr注册功能接口</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">Init</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    SAMGR_GetInstance()-&gt;RegisterFeature(EXAMPLE_SERVICE, (Feature *)&amp;g_example);</span><br><span class="line">    SAMGR_GetInstance()-&gt;RegisterFeatureApi(EXAMPLE_SERVICE, EXAMPLE_FEATURE, GET_IUNKNOWN(g_example));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//定义功能初始化入口</span></span><br><span class="line">SYSEX_FEATURE_INIT(Init);</span><br></pre></td></tr></table></figure>

<h3 id="softbus-server"><a href="#softbus-server" class="headerlink" title="softbus server"></a>softbus server</h3><p>好，让我来看看软总线服务是如何定义的</p>
<p>在<code>core/frame/small/init/src/softbus_server_stub.c</code>中，有softbus的注册服务的实现</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    sleep(WAIT_FOR_SERVER);</span><br><span class="line">    SAMGR_GetInstance()-&gt;RegisterService((Service *)&amp;g_samgrService);</span><br><span class="line">    SAMGR_GetInstance()-&gt;RegisterDefaultFeatureApi(SOFTBUS_SERVICE, GET_IUNKNOWN(g_samgrService));</span><br><span class="line">    SoftBusLog(SOFTBUS_LOG_COMM, SOFTBUS_LOG_INFO, <span class="string">&quot;Init success %s&quot;</span>, SOFTBUS_SERVICE);</span><br><span class="line">&#125;</span><br><span class="line">SYSEX_SERVICE_INIT(Init);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下来是softbus服务的定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> SoftbusSamgrService g_samgrService = &#123;</span><br><span class="line">    .GetName = GetName,</span><br><span class="line">    .Initialize = Initialize,</span><br><span class="line">    .MessageHandle = MessageHandle, </span><br><span class="line">    .GetTaskConfig = GetTaskConfig,</span><br><span class="line">    SERVER_IPROXY_IMPL_BEGIN,</span><br><span class="line">    .Invoke = Invoke,   <span class="comment">//重要：其他进程调用的IPC，会调用这个函数</span></span><br><span class="line">    IPROXY_END,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我门来关注一下Invoke：不难理解，通过funcId来索引找到对应的处理函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int32_t</span> <span class="title function_">Invoke</span><span class="params">(IServerProxy *iProxy, <span class="type">int</span> funcId, <span class="type">void</span> *origin, IpcIo *req, IpcIo *reply)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> tblSize = <span class="keyword">sizeof</span>(g_serverInvokeCmdTbl) / <span class="keyword">sizeof</span>(ServerInvokeCmd);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; tblSize; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (funcId == g_serverInvokeCmdTbl[i].id) &#123;</span><br><span class="line">            <span class="keyword">return</span> g_serverInvokeCmdTbl[i].func(origin, req, reply);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> SOFTBUS_ERR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可以找到softbus提供的全部IPC接口拉，应该可以和sdk目录下的函数相对应的，接下来我们就从这些函数入手，来了解整个core层中的发现，连接、组网，传输是如何实现的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">ServerInvokeCmd g_serverInvokeCmdTbl[] = &#123;</span><br><span class="line">    &#123; MANAGE_REGISTER_SERVICE, ServerRegisterService &#125;,</span><br><span class="line">    &#123; SERVER_PUBLISH_SERVICE, ServerPublishService &#125;,</span><br><span class="line">    &#123; SERVER_UNPUBLISH_SERVICE, ServerUnPublishService &#125;,</span><br><span class="line">    &#123; SERVER_START_DISCOVERY, ServerStartDiscovery &#125;,</span><br><span class="line">    &#123; SERVER_STOP_DISCOVERY, ServerStopDiscovery &#125;,</span><br><span class="line">    &#123; SERVER_JOIN_LNN, ServerJoinLNN &#125;,</span><br><span class="line">    &#123; SERVER_LEAVE_LNN, ServerLeaveLNN &#125;,</span><br><span class="line">    &#123; SERVER_GET_ALL_ONLINE_NODE_INFO, ServerGetAllOnlineNodeInfo &#125;,</span><br><span class="line">    &#123; SERVER_GET_LOCAL_DEVICE_INFO, ServerGetLocalDeviceInfo &#125;,</span><br><span class="line">    &#123; SERVER_GET_NODE_KEY_INFO, ServerGetNodeKeyInfo &#125;,</span><br><span class="line">    &#123; SERVER_START_TIME_SYNC, ServerStartTimeSync &#125;,</span><br><span class="line">    &#123; SERVER_STOP_TIME_SYNC, ServerStopTimeSync &#125;,</span><br><span class="line">    &#123; SERVER_PUBLISH_LNN, ServerPublishLNN &#125;,</span><br><span class="line">    &#123; SERVER_STOP_PUBLISH_LNN, ServerStopPublishLNN &#125;,</span><br><span class="line">    &#123; SERVER_REFRESH_LNN, ServerRefreshLNN &#125;,</span><br><span class="line">    &#123; SERVER_STOP_REFRESH_LNN, ServerStopRefreshLNN &#125;,</span><br><span class="line">    &#123; SERVER_ACTIVE_META_NODE, ServerActiveMetaNode&#125;,</span><br><span class="line">    &#123; SERVER_DEACTIVE_META_NODE, ServerDeactiveMetaNode &#125;,</span><br><span class="line">    &#123; SERVER_GET_ALL_META_NODE_INFO, ServerGetAllMetaNodeInfo &#125;,</span><br><span class="line">    &#123; SERVER_CREATE_SESSION_SERVER, ServerCreateSessionServer &#125;,</span><br><span class="line">    &#123; SERVER_REMOVE_SESSION_SERVER, ServerRemoveSessionServer &#125;,</span><br><span class="line">    &#123; SERVER_OPEN_SESSION, ServerOpenSession &#125;,</span><br><span class="line">    &#123; SERVER_OPEN_AUTH_SESSION, ServerOpenAuthSession&#125;,</span><br><span class="line">    &#123; SERVER_NOTIFY_AUTH_SUCCESS, ServerNotifyAuthSuccess&#125;,</span><br><span class="line">    &#123; SERVER_CLOSE_CHANNEL, ServerCloseChannel &#125;,</span><br><span class="line">    &#123; SERVER_SESSION_SENDMSG, ServerSendSessionMsg &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="发现：ServerStartDiscovery"><a href="#发现：ServerStartDiscovery" class="headerlink" title="发现：ServerStartDiscovery"></a>发现：ServerStartDiscovery</h3><p>我门就以ServerStartDiscovery来看看</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pkgName = (<span class="type">const</span> <span class="type">char</span> *)IpcIoPopString(req, &amp;len);</span><br><span class="line">SubscribeSerializer *info = (SubscribeSerializer *)IpcIoPopFlatObj(req, &amp;size);</span><br><span class="line"><span class="type">char</span> *capability = (<span class="type">char</span> *)IpcIoPopString(req, &amp;len);</span><br><span class="line">callingUid = GetCallingUid(origin);</span><br><span class="line">DiscIpcStartDiscovery(pkgName, &amp;subscribeInfo);</span><br><span class="line">    SetCallLnnStatus(<span class="literal">false</span>);    <span class="comment">//g_isCallLnn = flag;</span></span><br><span class="line">    DiscStartDiscovery(packageName, info, &amp;g_discInnerCb);</span><br><span class="line">        DiscInfo *infoNode = CreateNewSubscribeInfoNode(info);</span><br><span class="line">        InnerStartDiscovery(packageName, infoNode, cb, SUBSCRIBE_SERVICE);</span><br><span class="line">            AddInfoToList(g_discoveryInfoList, packageName, &amp;callback, info, type);</span><br><span class="line">            DiscInterfaceByMedium(info, STARTDISCOVERTY_FUNC);</span><br><span class="line">                DiscInterfaceProcess(&amp;(info-&gt;option), g_discCoapInterface, info-&gt;mode, type);</span><br><span class="line">                    interface-&gt;StartAdvertise(&amp;(option-&gt;subscribeOption))</span><br><span class="line">                    interface-&gt;Subscribe(&amp;(option-&gt;subscribeOption))</span><br><span class="line">    ClientIpcDiscoverySuccess(packageName, info-&gt;subscribeId);</span><br></pre></td></tr></table></figure>

<p>好吧，最后是使用interface的StartAdvertise和Subscribe方法，来看看g_discCoapInterface是在哪里定义的：</p>
<p>其实例化的地方是在：disc_manager.c中的DiscMgrInit()，主要还是初始化一些结构体,在DiscCoapInit中实例化的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">g_discMgrMediumCb.OnDeviceFound = DiscOnDeviceFound;</span><br><span class="line">g_discCoapInterface = DiscCoapInit(&amp;g_discMgrMediumCb);</span><br><span class="line">g_discBleInterface = DiscBleInit(&amp;g_discMgrMediumCb);</span><br><span class="line">g_publishInfoList = CreateSoftBusList();</span><br><span class="line">g_discoveryInfoList = CreateSoftBusList();    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>来看看DiscCoapInit()做了什么，这一部分和我门的softbus_lite很相似，coap的东西我就不去深究，大伙知道他的协议大概是啥就行。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">InitCoapManager()</span><br><span class="line">DiscNstackxInit()</span><br><span class="line">DiscCoapRegisterCb(discInnerCb)</span><br><span class="line"><span class="keyword">return</span> &amp;g_discCoapFuncInterface;</span><br></pre></td></tr></table></figure>

<p>下面就是g_discCoapInterface的实例化</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> DiscoveryFuncInterface g_discCoapFuncInterface = &#123;</span><br><span class="line">    .Publish = CoapPublish,</span><br><span class="line">    .StartScan = CoapStartScan,</span><br><span class="line">    .Unpublish = CoapUnPublish,</span><br><span class="line">    .StopScan = CoapStopScan,</span><br><span class="line">    .StartAdvertise = CoapStartAdvertise,</span><br><span class="line">    .Subscribe = CoapSubscribe,</span><br><span class="line">    .StopAdvertise = CoapStopAdvertise,</span><br><span class="line">    .Unsubscribe = CoapUnsubscribe,</span><br><span class="line">    .LinkStatusChanged = CoapUpdateLocalIp</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>先看看CoapStartAdvertise：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">RegisterAllCapBitmap</span><br><span class="line">DiscCoapSetFilterCapability</span><br><span class="line">DiscCoapStopDiscovery</span><br><span class="line">DiscCoapStartDiscovery</span><br><span class="line">    NSTACKX_StartDeviceFind</span><br><span class="line">        <span class="title function_">PostEvent</span><span class="params">(&amp;g_eventNodeChain, g_epollfd, DeviceDiscoverInner, <span class="literal">NULL</span>)</span></span><br><span class="line">            DeviceDiscoverInner</span><br><span class="line">               <span class="title function_">CoapServiceDiscoverInner</span><span class="params">(INNER_DISCOVERY)</span>;</span><br><span class="line">                   SetModeInfo</span><br><span class="line">                   CoapPostServiceDiscover</span><br><span class="line">                       PrepareServiceDiscover</span><br><span class="line">                       CoapSendRequest</span><br><span class="line">                           FillCoapRequest</span><br><span class="line">                           CoapResolveAddress</span><br><span class="line">                           CoapGetSessionOnTargetServer</span><br><span class="line">                           CoapPackToPdu</span><br><span class="line">                           coap_send</span><br><span class="line">                           coap_session_release</span><br><span class="line">                   TimerSetTimeout</span><br><span class="line">               <span class="title function_">NotifyDeviceFound</span><span class="params">(<span class="literal">NULL</span>, <span class="number">0</span>)</span>;    <span class="comment">//g_parameter.onDeviceFound(deviceList, deviceCount);</span></span><br></pre></td></tr></table></figure>

<p>note：PostEvent可以简单的理解为调用DeviceDiscoverInner():</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">CoapServiceDiscoverInner</span><span class="params">(<span class="type">uint8_t</span> userRequest)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> discoverInterval;</span><br><span class="line">    <span class="comment">//检查wifi连接</span></span><br><span class="line">    <span class="keyword">if</span> (!IsWifiApConnected() || g_context == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//用户请求开启发现</span></span><br><span class="line">    <span class="keyword">if</span> (userRequest) &#123;</span><br><span class="line">        <span class="comment">//强制进行发现</span></span><br><span class="line">        g_userRequest = NSTACKX_TRUE;</span><br><span class="line">        g_forceUpdate = NSTACKX_TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">if</span> (g_coapDiscoverTargetCount &gt; <span class="number">0</span> &amp;&amp; g_discoverCount &gt;= g_coapDiscoverTargetCount) &#123;</span><br><span class="line">        g_discoverCount = <span class="number">0</span>;</span><br><span class="line">        SetModeInfo(DISCOVER_MODE);</span><br><span class="line">        ClearDevices(GetDeviceDBBackup());</span><br><span class="line">        LOGW(TAG, <span class="string">&quot;clear device list backup&quot;</span>);</span><br><span class="line">        TimerSetTimeout(g_discoverTimer, <span class="number">0</span>, NSTACKX_FALSE);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//g_discoverCount &gt; 0说明正在发现</span></span><br><span class="line">    <span class="keyword">if</span> (g_discoverCount) &#123;</span><br><span class="line">        <span class="comment">/* Service discover is ongoing, return. */</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* First discover */</span></span><br><span class="line">        <span class="comment">//备份设备数据</span></span><br><span class="line">        <span class="keyword">if</span> (BackupDeviceDB() != NSTACKX_EOK) &#123;</span><br><span class="line">            LOGE(TAG, <span class="string">&quot;backup device list fail&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//清除设备</span></span><br><span class="line">        ClearDevices(GetDeviceDB());</span><br><span class="line">        LOGW(TAG, <span class="string">&quot;clear device list&quot;</span>);</span><br><span class="line">        <span class="comment">//设置最大的发现数量</span></span><br><span class="line">        g_coapDiscoverTargetCount = g_coapMaxDiscoverCount;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SetModeInfo(DISCOVER_MODE);</span><br><span class="line">    <span class="comment">//开始发现</span></span><br><span class="line">    <span class="keyword">if</span> (CoapPostServiceDiscover() != NSTACKX_EOK) &#123;</span><br><span class="line">        LOGE(TAG, <span class="string">&quot;failed to post service discover request&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//设置一些超时检查</span></span><br><span class="line">    discoverInterval = GetDiscoverInterval(g_discoverCount);</span><br><span class="line">    <span class="keyword">if</span> (TimerSetTimeout(g_discoverTimer, discoverInterval, NSTACKX_FALSE) != NSTACKX_EOK) &#123;</span><br><span class="line">        LOGE(TAG, <span class="string">&quot;failed to set timer for service discover&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++g_discoverCount;</span><br><span class="line">    LOGI(TAG, <span class="string">&quot;the first time for device discover.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CoapServiceDiscoverInner</span><br><span class="line">    GetLocalInterfaceName</span><br><span class="line">    GetIfBroadcastIp</span><br><span class="line">    <span class="title function_">sprintf_s</span><span class="params">(discoverUri, <span class="keyword">sizeof</span>(discoverUri), <span class="string">&quot;coap://%s/%s&quot;</span>, ipString, <span class="string">&quot;device_discover&quot;</span>)</span></span><br><span class="line">    <span class="title function_">PrepareServiceDiscover</span><span class="params">(NSTACKX_TRUE)</span>;</span><br><span class="line">    CoapSendRequest(COAP_MESSAGE_NON, discoverUri, data, <span class="built_in">strlen</span>(data) + <span class="number">1</span>, SERVER_TYPE_WLANORETH);</span><br><span class="line">        FillCoapRequest(&amp;coapRequest, coapType, url, data, dataLen);</span><br><span class="line">        CoapUriParse(coapRequest.remoteUrl, &amp;coapUri)</span><br><span class="line">        CoapResolveAddress(&amp;remote, &amp;dst.addr.sa);</span><br><span class="line">        CoapGetSessionOnTargetServer(serverType, &amp;coapServerParameter);</span><br><span class="line">        CoapPackToPdu(&amp;coapRequest, &amp;coapUri, session);</span><br><span class="line">        coap_send(session, pdu);</span><br></pre></td></tr></table></figure>

<p>哥哥们，最终是调用coap_send函数发送报文的.</p>
<h3 id="组网：ServerJoinLNN"><a href="#组网：ServerJoinLNN" class="headerlink" title="组网：ServerJoinLNN"></a>组网：ServerJoinLNN</h3><p>继续我门再core目录的探险，发现设备后要组网，就在ServerJoinLNN的实现</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pkgName = IpcIoPopString</span><br><span class="line">addrTypeLen=IpcIoPopUint32</span><br><span class="line">*addr = (<span class="type">void</span>*)IpcIoPopFlatObj(req, &amp;size);</span><br><span class="line">callingUid = GetCallingUid(origin);</span><br><span class="line">LnnIpcServerJoin(pkgName, addr, addrTypeLen);</span><br><span class="line">    LnnServerJoin(connAddr);</span><br><span class="line">        CreateConnectionAddrMsgPara(addr);</span><br><span class="line">        PostMessageToHandler(MSG_TYPE_JOIN_LNN, para)</span><br><span class="line">            CreateNetBuilderMessage(msgType, para);</span><br><span class="line">                msg-&gt;handler = &amp;g_timeSyncCtrl.handler;</span><br><span class="line">            g_netBuilder.looper-&gt;PostMessage(g_netBuilder.looper,msg);<span class="comment">//==PostMessageAtTime()</span></span><br><span class="line">                SoftBusMessageNode *newNode;<span class="comment">//设置一个SoftBusMessageNode</span></span><br><span class="line">                SoftBusCondBroadcast(&amp;context-&gt;cond);</span><br><span class="line">                    pthread_cond_broadcast((<span class="type">pthread_cond_t</span> *)*cond);    <span class="comment">//解锁指定的线程</span></span><br><span class="line">    AddJoinLNNInfo(pkgName, connAddr);     <span class="comment">//创建一个JoinLnnRequestInfo，然后加入链表</span></span><br></pre></td></tr></table></figure>

<p>好的，g_netBuilder.looper如何初始化？找了一下，发现在这里</p>
<p>looper声明：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SoftBusLooper</span> &#123;</span></span><br><span class="line">    SoftBusLooperContext *context;</span><br><span class="line">    <span class="type">bool</span> dumpable;</span><br><span class="line">    <span class="type">void</span> (*PostMessage)(<span class="type">const</span> SoftBusLooper *looper, SoftBusMessage *msg);</span><br><span class="line">    <span class="type">void</span> (*PostMessageDelay)(<span class="type">const</span> SoftBusLooper *looper, SoftBusMessage *msg, <span class="type">uint64_t</span> delayMillis);</span><br><span class="line">    <span class="type">void</span> (*RemoveMessage)(<span class="type">const</span> SoftBusLooper *looper, <span class="type">const</span> SoftBusHandler *handler, <span class="type">int32_t</span> what);</span><br><span class="line">    <span class="comment">// customFunc, when match, return 0</span></span><br><span class="line">    <span class="type">void</span> (*RemoveMessageCustom)(<span class="type">const</span> SoftBusLooper *looper, <span class="type">const</span> SoftBusHandler *handler,</span><br><span class="line">        <span class="type">int</span> (*)(<span class="type">const</span> SoftBusMessage*, <span class="type">void</span>*), <span class="type">void</span> *args);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LooperInit</span><br><span class="line">    <span class="title function_">CreateNewLooper</span><span class="params">(<span class="string">&quot;Loop-default&quot;</span>)</span>;</span><br><span class="line">        looper-&gt;PostMessage = LooperPostMessage;</span><br><span class="line">        looper-&gt;PostMessageDelay = LooperPostMessageDelay;</span><br><span class="line">        looper-&gt;RemoveMessage = LooperRemoveMessage;</span><br><span class="line">        looper-&gt;RemoveMessageCustom = LoopRemoveMessageCustom;</span><br><span class="line">    SetLooper(LOOP_TYPE_DEFAULT, looper);</span><br></pre></td></tr></table></figure>

<p>LooperPostMessage如何把消息发送出去？</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LooperPostMessage</span><br><span class="line">    msg-&gt;time = UptimeMicros();</span><br><span class="line">    PostMessageAtTime(looper, msg);</span><br><span class="line">        SoftBusMessageNode *newNode;</span><br><span class="line">        ListTailInsert(item, &amp;(newNode-&gt;node));</span><br><span class="line">        SoftBusCondBroadcast(&amp;context-&gt;cond);</span><br><span class="line">            pthread_cond_broadcast((<span class="type">pthread_cond_t</span> *)*cond);</span><br></pre></td></tr></table></figure>



<p>最后是使用pthread_cond_broadcast唤醒一些线程，那是什么条件，什么线程？找到了：线程就是LoopTask，再message_handler.c：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SoftBusCondWait(&amp;context-&gt;cond, &amp;context-&gt;lock, &amp;tv);</span><br><span class="line">ListNode *item = context-&gt;msgHead.next;</span><br><span class="line">SoftBusMessageNode *itemNode = CONTAINER_OF(item, SoftBusMessageNode, node);</span><br><span class="line">msg = itemNode-&gt;msg;</span><br><span class="line">msg-&gt;handler-&gt;HandleMessage(msg);</span><br></pre></td></tr></table></figure>

<p>看来这个线程也不是重点，重点是msg的handler，要回溯一下msg，应该是在msg-&gt;handler &#x3D; &amp;g_timeSyncCtrl.handler，而且由handler.HandleMessage &#x3D; TimeSyncMessageHandler：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ProcessStartTimeSyncRequest((<span class="type">const</span> StartTimeSyncReqMsgPara *)msg-&gt;obj);</span><br><span class="line">    FindTimeSyncReqInfo(para-&gt;targetNetworkId);</span><br><span class="line">    isUpdateTimeSyncReq = TryUpdateTimeSyncReqInfo(existInfo, para-&gt;accuracy, para-&gt;period);</span><br><span class="line">    TryUpdateStartTimeSyncReq(existInfo, para)</span><br><span class="line">    LnnStartTimeSyncImpl(existInfo-&gt;targetNetworkId, existInfo-&gt;curAccuracy,existInfo-&gt;curPeriod, &amp;g_timeSyncImplCb)</span><br><span class="line">    ListAdd(&amp;g_timeSyncCtrl.reqList, &amp;existInfo-&gt;node);</span><br></pre></td></tr></table></figure>

<p>看样子应该是构建了一个请求，然后把他放到g_timeSyncCtrl.reqList，应该有一个函数来处理这个列表。。。。。所谓的组网就是时钟同步，只是如何实现的？这部分好像没有实现的代码，在core&#x2F;bus_center&#x2F;lnn&#x2F;lane_hub&#x2F;time_sync没有定义。组网的部分暂时到这。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/06/01/killer-blog/OpenHarmony/dsoftbus_core/" data-id="cmbcy7rho002nt8mtfy3ngqf5" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2025/06/01/killer-blog/README/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2025/06/01/killer-blog/OpenHarmony/softbus%20core%EF%BC%88%E4%B8%AD%EF%BC%89/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">June 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">May 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/pwm/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/uart/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/worklife/2025%E6%B1%82%E8%81%8C%E5%87%86%E5%A4%87/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/other/tools/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/i2c_LSM303AGR/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>