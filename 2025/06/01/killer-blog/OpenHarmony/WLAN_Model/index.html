<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="WIFI Core在WLAN HDI 的那篇文章中，命令最终被发送到HDF WIFI驱动模块，该驱动的实现就在hdf_wifi_core.c中： 12345678struct HdfDriverEntry g_hdfWifiEntry &#x3D; &#123;    .moduleVersion &#x3D; 1,    .Bind &#x3D; HdfWifiDriverBind,    .Init &#x3D; HdfWlanMa">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2025/06/01/killer-blog/OpenHarmony/WLAN_Model/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="WIFI Core在WLAN HDI 的那篇文章中，命令最终被发送到HDF WIFI驱动模块，该驱动的实现就在hdf_wifi_core.c中： 12345678struct HdfDriverEntry g_hdfWifiEntry &#x3D; &#123;    .moduleVersion &#x3D; 1,    .Bind &#x3D; HdfWifiDriverBind,    .Init &#x3D; HdfWlanMa">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/OpenHarmony/WLAN_Model/AIveunOXKjpPF2L.jpg">
<meta property="article:published_time" content="2025-06-01T00:24:26.645Z">
<meta property="article:modified_time" content="2025-06-01T00:26:27.108Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2025/05/30/hello-world/OpenHarmony/WLAN_Model/AIveunOXKjpPF2L.jpg">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-killer-blog/OpenHarmony/WLAN_Model" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/06/01/killer-blog/OpenHarmony/WLAN_Model/" class="article-date">
  <time class="dt-published" datetime="2025-06-01T00:24:26.645Z" itemprop="datePublished">2025-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="WIFI-Core"><a href="#WIFI-Core" class="headerlink" title="WIFI Core"></a>WIFI Core</h2><p>在WLAN HDI 的那篇文章中，命令最终被发送到HDF WIFI驱动模块，该驱动的实现就在hdf_wifi_core.c中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">HdfDriverEntry</span> <span class="title">g_hdfWifiEntry</span> =</span> &#123;</span><br><span class="line">    .moduleVersion = <span class="number">1</span>,</span><br><span class="line">    .Bind = HdfWifiDriverBind,</span><br><span class="line">    .Init = HdfWlanMainInit,</span><br><span class="line">    .Release = HdfWlanDriverRelease,</span><br><span class="line">    .moduleName = <span class="string">&quot;HDF_WIFI&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line">HDF_INIT(g_hdfWifiEntry);</span><br></pre></td></tr></table></figure>

<p>WIFI Core 驱动对消息的处理流程如图：</p>
<p><img src="/2025/05/30/hello-world/OpenHarmony/WLAN_Model/AIveunOXKjpPF2L.jpg" alt="core.png"></p>
<p>由于WIFI Core所涉及的对象多且复杂，最好先来了解这些对象是如何生成的，再看他们是如何使用。</p>
<h3 id="一、LocalNodeService"><a href="#一、LocalNodeService" class="headerlink" title="一、LocalNodeService"></a>一、LocalNodeService</h3><p>展开宏定义后的LocalNodeService，根据上图可了解到LocalNodeService有三个，分别用于响应base、sta、ap消息，于是就有三个文件对应实现。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">LocalNodeService</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">MessageEngineStatus</span> <span class="title">status</span>;</span>                </span><br><span class="line">    OsalAtomic refCount;                            </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">RemoteService</span> *(*<span class="title">Ref</span>)(<span class="keyword">struct</span> <span class="title">RemoteService</span> * <span class="title">obj</span>);</span> </span><br><span class="line">    <span class="type">void</span> (*Disref)(<span class="keyword">struct</span> RemoteService * obj);          </span><br><span class="line">    <span class="type">void</span> (*Destroy)(<span class="keyword">struct</span> RemoteService * obj);</span><br><span class="line">    <span class="comment">//发送请求消息</span></span><br><span class="line">    <span class="type">void</span> (*ExecRequestMsg)(<span class="type">const</span> <span class="keyword">struct</span> RemoteService *service, MessageContext *context);  </span><br><span class="line">    <span class="comment">//发送响应消息</span></span><br><span class="line">    <span class="type">void</span> (*ExecResponseMsg)(<span class="type">const</span> <span class="keyword">struct</span> RemoteService *service, MessageContext *context);  </span><br><span class="line">    <span class="comment">//发送消息</span></span><br><span class="line">    ErrorCode (*SendMessage)(<span class="type">const</span> <span class="keyword">struct</span> RemoteService *service, MessageContext *context); </span><br><span class="line">    <span class="type">void</span> (*Shutdown)(<span class="keyword">struct</span> RemoteService * service);   </span><br><span class="line">    <span class="comment">//service类型：base、ap、sta</span></span><br><span class="line">    ServiceId serviceId;    </span><br><span class="line">    <span class="comment">//dispatch用于缓存消息</span></span><br><span class="line">    MessageDispatcher *dispatcher;</span><br><span class="line">    <span class="comment">//响应消息的服务</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ServiceDef</span> *<span class="title">mapper</span>;</span></span><br><span class="line">&#125; LocalNodeService;</span><br></pre></td></tr></table></figure>

<p>以sta.c为例子，学习LocalNodeService是如何被创建的：</p>
<p>sta.c中定义了三个MessageDef数组，分别用于处理三种类型的HDI message。例如sta.c中定义了5个成员的数组，用于处理5个具体的sta命令，例如WifiCmdAssoc()是用于响应wifi连接命令的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">MessageDef</span> <span class="title">g_wifiStaFeatureCmds</span>[] =</span> &#123;</span><br><span class="line">    DUEMessage(CMD_STA_CONNECT, WifiCmdAssoc, <span class="number">0</span>),</span><br><span class="line">    DUEMessage(CMD_STA_DISCONNECT, WifiCmdDisconnect, <span class="number">0</span>),</span><br><span class="line">    DUEMessage(CMD_STA_SCAN, WifiCmdScan, <span class="number">0</span>),</span><br><span class="line">    DUEMessage(CMD_STA_ABORT_SCAN, WifiCmdAbortScan, <span class="number">0</span>),</span><br><span class="line">    DUEMessage(CMD_STA_SET_SCAN_MAC_ADDR, WifiCmdSetScanningMacAddress, <span class="number">0</span>)</span><br><span class="line">&#125;; 	</span><br></pre></td></tr></table></figure>

<p>同时还要注意到g_wifiStaFeatureCmds下方有一句宏定义：将该宏定义展开，可得到函数CreateServiceSTAService()，该函数创建了一个ServiceDef结构体，并调用InitService()函数.同时在StaInit()在调用该函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">ServiceDefine(STAService, STA_SERVICE_ID, g_wifiStaFeatureCmds);</span><br><span class="line"><span class="comment">/**               </span></span><br><span class="line"><span class="comment">    Service *CreateServiceSTAService(const ServiceCfg *cfg)                </span></span><br><span class="line"><span class="comment">    &#123;                                                                         </span></span><br><span class="line"><span class="comment">        static struct ServiceDef serviceDef = &#123;                               </span></span><br><span class="line"><span class="comment">            .serviceId = STA_SERVICE_ID,                                          </span></span><br><span class="line"><span class="comment">            .messagesLength = sizeof(g_wifiStaFeatureCmds) / sizeof(struct MessageDef), </span></span><br><span class="line"><span class="comment">            .messages = g_wifiStaFeatureCmds                                            </span></span><br><span class="line"><span class="comment">        &#125;;                                                                    </span></span><br><span class="line"><span class="comment">        return InitService(&amp;serviceDef, cfg);                                 </span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int32_t</span> <span class="title function_">StaInit</span><span class="params">(<span class="keyword">struct</span> WifiFeature *feature)</span></span><br><span class="line">&#123;</span><br><span class="line">    (<span class="type">void</span>)feature;</span><br><span class="line">    <span class="keyword">if</span> (g_staService == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ServiceCfg cfg = &#123;</span><br><span class="line">            .dispatcherId = DEFAULT_DISPATCHER_ID</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//g_staService = CreateServiceSTAService(&amp;cfg);</span></span><br><span class="line">        g_staService = CreateService(STAService, &amp;cfg);</span><br><span class="line">        <span class="keyword">if</span> (g_staService == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> HDF_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>InitService()函数在sidecar.c中，其最重要的部分是调用RegistLocalService()，而RegistLocalService简单的调用RegistServiceInner():</p>
<p>该函数的目的是创建LocalNodeService，但创建LocalNodeServic需要使用到MessageNode，这里先暂时不管。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//主要是创建LocalNodeServic</span></span><br><span class="line"><span class="type">static</span> ErrorCode <span class="title function_">RegistServiceInner</span><span class="params">(<span class="type">const</span> NodeId nodeId, <span class="type">const</span> DispatcherId dispatcherId, <span class="keyword">struct</span> ServiceDef *mapper)</span></span><br><span class="line">&#123;</span><br><span class="line">    HDF_STATUS status = OsalMutexTimedLock(&amp;g_routerMutex, HDF_WAIT_FOREVER);</span><br><span class="line">    <span class="comment">//获取default node（非重点）</span></span><br><span class="line">    MessageNode *node = RefMessageNode(nodeId, <span class="literal">false</span>);</span><br><span class="line">    </span><br><span class="line">    RemoteService *remoteService = <span class="literal">NULL</span>;</span><br><span class="line">    MessageDispatcher *dispatcher = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//获取default dispatcher</span></span><br><span class="line">        dispatcher = RefDispatcherInner(dispatcherId, <span class="literal">false</span>);</span><br><span class="line">		<span class="comment">//重要：调用CreateLocalNodeService(node,dispatcher, mapper)</span></span><br><span class="line">        remoteService = node-&gt;CreateRemoteService(node, dispatcher, mapper);</span><br><span class="line">        errCode = NotifyAllNodesServiceAdd(nodeId, mapper);</span><br><span class="line">		<span class="comment">//把remoteService添加到g_servicesIndex[]</span></span><br><span class="line">        errCode = DoRegistService(nodeId, dispatcherId, remoteService);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">return</span> errCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CreateLocalNodeService() 创建了LocalNodeService对象。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">RemoteService *<span class="title function_">CreateLocalNodeService</span><span class="params">(MessageNode *node, MessageDispatcher *dispatcher, <span class="keyword">struct</span> ServiceDef *mapper)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//create local node service</span></span><br><span class="line">    LocalNodeService *service = (LocalNodeService *)OsalMemCalloc(<span class="keyword">sizeof</span>(LocalNodeService));</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        service-&gt;status = ME_STATUS_RUNNING;</span><br><span class="line">        <span class="comment">//填充函数：处理请求消息</span></span><br><span class="line">        service-&gt;ExecRequestMsg = HandleRequestMessage;</span><br><span class="line">        service-&gt;ExecResponseMsg = HandleResponseMessage;</span><br><span class="line">        service-&gt;SendMessage = SendMessageLocalNode;</span><br><span class="line">        service-&gt;Shutdown = ShutdownLocalService;</span><br><span class="line">        service-&gt;serviceId = mapper-&gt;serviceId;</span><br><span class="line">        <span class="comment">//把sta.c中定义的ServiceDef 赋值给 LocalNodeService</span></span><br><span class="line">        service-&gt;mapper = mapper;</span><br><span class="line">        service-&gt;dispatcher = dispatcher-&gt;Ref(dispatcher);</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">return</span> (RemoteService *)service;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>总结一下，调用sta.c，ap.c，wifi_base.c中的初始化函数，就能创建上图所示的LocalNodeService。</strong></p>
<h3 id="二、消息传递流程"><a href="#二、消息传递流程" class="headerlink" title="二、消息传递流程"></a>二、消息传递流程</h3><p>了解了LocalNodeService是如何创建的，我们就能轻松的了解消息的传递流程。</p>
<p>在hdf_wifi_core.c中的HdfWifiDriverBind函数定义了HDF_WIFI驱动所提供的服务,并启动MessageRouter来创建MessageNode，创建dispatch，MessageNode和Dispatch正是我们前面创建LocalNodeService所需要的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int32_t</span> <span class="title function_">HdfWifiDriverBind</span><span class="params">(<span class="keyword">struct</span> HdfDeviceObject *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">IDeviceIoService</span> <span class="title">wifiService</span> =</span> &#123;</span><br><span class="line">        .object.objectId = <span class="number">1</span>,</span><br><span class="line">        .Dispatch = DispatchToMessage,</span><br><span class="line">    &#125;;</span><br><span class="line">    errCode = StartMessageRouter(MESSAGE_NODE_CONFIG_DEFAULT);</span><br><span class="line">    errCode = EnableDefaultDispatcher();</span><br><span class="line">    dev-&gt;service = &amp;wifiService;</span><br><span class="line">    <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们重点关注DispatchToMessage():</p>
<p>该函数定义在sidecar.c中。sidecar.c封装了LocalNodeService，提供接口给HDF_WIFI驱动使用，起到中介的作用。要注意到，驱动的命令是以id+HdfSBuf的形式传递进来的，需要转换成messagecontext。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int32_t</span> <span class="title function_">DispatchToMessage</span><span class="params">(<span class="keyword">struct</span> HdfDeviceIoClient *client, <span class="type">int</span> id, <span class="keyword">struct</span> HdfSBuf *reqData, <span class="keyword">struct</span> HdfSBuf *rspData)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//create message</span></span><br><span class="line">    context = CreateMessageContext(RESERVED_SERVICE_ID, serviceId, cmd, reqData);</span><br><span class="line">    context-&gt;rspData = rspData;</span><br><span class="line">    <span class="comment">//从HDI发送过来的是REQ</span></span><br><span class="line">    context-&gt;requestType = MESSAGE_TYPE_SYNC_REQ;</span><br><span class="line">    context-&gt;client = client;</span><br><span class="line">    RemoteService *targetService = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//获取特定的 LocalNodeService</span></span><br><span class="line">        targetService = RefRemoteService(serviceId);</span><br><span class="line">        <span class="comment">//SendMessage就是在LocalNodeService创建时设置的 SendMessageLocalNode()</span></span><br><span class="line">        errCode = targetService-&gt;SendMessage(targetService, context);</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SendMessage()根据message类型作不同的处理：</p>
<ul>
<li>sync：同步类消息需要马上处理</li>
<li>async：异步类消息由RunDispatcher线程稍后处理</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ErrorCode <span class="title function_">SendMessageLocalNode</span><span class="params">(<span class="type">const</span> RemoteService *service, MessageContext *context)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//MESSAGE_TYPE_SYNC_REQ 来自HDI的同步请求，马上处理并回复</span></span><br><span class="line">    <span class="keyword">if</span> (!context-&gt;crossNode &amp;&amp; context-&gt;requestType == MESSAGE_TYPE_SYNC_REQ) &#123;</span><br><span class="line">        <span class="comment">//处理请求</span></span><br><span class="line">        HandleRequestMessage(service, context);</span><br><span class="line">        <span class="comment">//回复</span></span><br><span class="line">        SetToResponse(context);</span><br><span class="line">        <span class="keyword">return</span> context-&gt;responseStatus;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (context-&gt;requestType == MESSAGE_TYPE_SYNC_RSP) &#123;</span><br><span class="line">        <span class="comment">//同步响应，释放信号量？</span></span><br><span class="line">        (<span class="type">void</span>)OsalSemPost(&amp;context-&gt;rspSemaphore);</span><br><span class="line">        <span class="keyword">return</span> ME_SUCCESS;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//异步请求，交给dispatch缓存处理</span></span><br><span class="line">        <span class="keyword">return</span> localService-&gt;dispatcher-&gt;AppendMessage(localService-&gt;dispatcher, pri, context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HandleRequestMessage()获取定义在sta.c、wifi_base.c、ap.c的messageDef，然后指定handler函数，例如：WifiCmdAssoc()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">HandleRequestMessage</span><span class="params">(<span class="type">const</span> RemoteService *service, MessageContext *context)</span></span><br><span class="line">&#123;</span><br><span class="line">    LocalNodeService *localNodeService = (LocalNodeService *)service;</span><br><span class="line">	<span class="comment">//根据commandID获取请求对应的messageDef</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">MessageDef</span> <span class="title">messageDef</span> =</span> &#123; <span class="literal">NULL</span>, <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">if</span> (localNodeService-&gt;mapper != <span class="literal">NULL</span> &amp;&amp; context-&gt;commandId &lt; localNodeService-&gt;mapper-&gt;messagesLength) &#123;</span><br><span class="line">        messageDef = localNodeService-&gt;mapper-&gt;messages[context-&gt;commandId];</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//调用messageDef的函数处理请求</span></span><br><span class="line">    context-&gt;responseStatus = messageDef.handler((RequestContext *)context, context-&gt;reqData, context-&gt;rspData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>让我们重新回到sta.c中，看看messageDef[]中的handler函数是如何处理消息的。还是以WifiCmdAssoc()为线索：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int32_t</span> <span class="title function_">WifiCmdAssoc</span><span class="params">(<span class="type">const</span> RequestContext *context, <span class="keyword">struct</span> HdfSBuf *reqData, <span class="keyword">struct</span> HdfSBuf *rspData)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">WlanConnectParams</span> <span class="title">params</span> =</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    WifiAssociateParams assoc = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">NetDevice</span> *<span class="title">netdev</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    ifName = HdfSbufReadString(reqData);</span><br><span class="line">    <span class="comment">//设置连接参数</span></span><br><span class="line">    <span class="keyword">if</span> (WifiFillAssocParams(&amp;assoc, reqData) != HDF_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">return</span> HDF_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//获取netdev</span></span><br><span class="line">    <span class="keyword">if</span> ((netdev = NetDeviceGetInstByName(ifName)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        HDF_LOGE(<span class="string">&quot;%s:netdev not found!ifName=%s&quot;</span>, __func__, ifName);</span><br><span class="line">        <span class="keyword">return</span> HDF_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//设置连接参数</span></span><br><span class="line">    <span class="keyword">if</span> (WifiSetAssocParams(&amp;assoc, netdev, &amp;params) != HDF_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">return</span> HDF_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        params.centerFreq = assoc.freq;</span><br><span class="line">		<span class="comment">//开始连接wifi</span></span><br><span class="line">        ret = Connect(netdev, &amp;params);</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Connect()使用 chipDriver 对象提供的接口进行连接：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="type">static</span> <span class="type">int32_t</span> <span class="title function_">Connect</span><span class="params">(<span class="keyword">struct</span> NetDevice *netDev, <span class="keyword">struct</span> WlanConnectParams *param)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//获取chip driver</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">HdfChipDriver</span> *<span class="title">chipDriver</span> =</span> GetChipDriver(netDev);</span><br><span class="line">    RETURN_IF_CHIPOPS_NOT_IMPLEMENT(chipDriver-&gt;staOps, Connect);</span><br><span class="line">    <span class="comment">//chip driver 开始连接</span></span><br><span class="line">    <span class="keyword">return</span> chipDriver-&gt;staOps-&gt;Connect(netDev, param);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此 WIFI Core 的任务就完成了。</p>
<h3 id="三、HDF-WIFI-初始化"><a href="#三、HDF-WIFI-初始化" class="headerlink" title="三、HDF WIFI 初始化"></a>三、HDF WIFI 初始化</h3><p>首先来看HdfWlanMainInit函数，这是驱动的初始化函数，负责生成上图所用到的所有对象。</p>
<p>HDF_WIFI的初始化分为三个部分：</p>
<ul>
<li>HdfWlanGetConfig是获取配置文件的配置信息，暂不分析。</li>
<li>HdfWlanInitProduct：调用InitWifiModule 初始化wifi module（本质是初始化三个LocalNodeService）</li>
<li>HdfWlanScanAndInitThread：初始化硬件</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* main init process including config, powers, load the factory, and chip init */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int32_t</span> <span class="title function_">HdfWlanMainInit</span><span class="params">(<span class="keyword">struct</span> HdfDeviceObject *device)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//获取配置文件的配置信息</span></span><br><span class="line">    <span class="keyword">if</span> (HdfWlanGetConfig(device) != HDF_SUCCESS) &#123;</span><br><span class="line">        HDF_LOGE(<span class="string">&quot;%s:HdfWlanGetConfig get wlan config failed!&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span> HDF_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    rootConfig = HdfWlanGetModuleConfigRoot();</span><br><span class="line">    moduleConfig = &amp;rootConfig-&gt;wlanConfig.moduleConfig;</span><br><span class="line">    <span class="comment">//初始化Modules</span></span><br><span class="line">    <span class="keyword">if</span> (HdfWlanInitProduct(device, moduleConfig) != HDF_SUCCESS) &#123;</span><br><span class="line">        HDF_LOGE(<span class="string">&quot;%s:HdfWlanInitProduct failed!&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span> HDF_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//初始化硬件</span></span><br><span class="line">    <span class="keyword">if</span> (HdfWlanScanAndInitThread(device) != HDF_SUCCESS) &#123;</span><br><span class="line">        HDF_LOGE(<span class="string">&quot;%s: LoadChipFactoryThread failed, the load process failed!&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span> HDF_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">HdfWlanInitProduct</span><span class="params">(<span class="keyword">struct</span> HdfDeviceObject *device, <span class="type">const</span> <span class="keyword">struct</span> HdfConfigWlanModuleConfig *config)</span></span><br><span class="line">&#123;</span><br><span class="line">    g_hdfWlanProductData = OsalMemCalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> HdfWifiProductData));</span><br><span class="line">    ret = InitWifiModule(&amp;(g_hdfWlanProductData-&gt;module), config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-1、HdfWlanInitProduct"><a href="#3-1、HdfWlanInitProduct" class="headerlink" title="3.1、HdfWlanInitProduct"></a>3.1、HdfWlanInitProduct</h4><p>初始化WIFI Module，其根本目的是为了创建三个LocalNodeService，分别是：BASE、STA、AP LocalNodeService</p>
<p>函数调用流程是：InitWifiModule()-&gt;InitFeatures()，其中分别调用BaseInit()、StaInit()、ApInit()来创建LocalNodeService</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int32_t</span> <span class="title function_">InitFeatures</span><span class="params">(<span class="keyword">struct</span> WifiModule *module)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//初始化 BASE LocalNodeService</span></span><br><span class="line">    ret = BaseInit();</span><br><span class="line">    <span class="comment">//获取 ApFeature、staFeature</span></span><br><span class="line">    module-&gt;feList.fe[HDF_WIFI_FEATURE_AP] = GetWifiApFeature();</span><br><span class="line">    module-&gt;feList.fe[HDF_WIFI_FEATURE_STA] = GetWifiStaFeature();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; HDF_WIFI_FEATURE_NUM; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((module-&gt;moduleConfig.hslConfig-&gt;featureMap &amp; (<span class="number">1</span> &lt;&lt; i)) &amp;&amp; module-&gt;feList.fe[i] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">//调用StaInit() ApInit()</span></span><br><span class="line">            module-&gt;feList.fe[i]-&gt;init(module-&gt;feList.fe[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-2、HdfWlanScanAndInitThread"><a href="#3-2、HdfWlanScanAndInitThread" class="headerlink" title="3.2、HdfWlanScanAndInitThread"></a>3.2、HdfWlanScanAndInitThread</h4><p>HdfWlanScanAndInitThread会回调HdfWlanInitThread函数，在其中初始化硬件，如sdio控制器，芯片电源引脚，复位引脚，驱动程序。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int32_t</span> <span class="title function_">HdfWlanInitThread</span><span class="params">(<span class="type">void</span> *para)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">HdfDeviceObject</span> *<span class="title">device</span> =</span> (<span class="keyword">struct</span> HdfDeviceObject *)para;</span><br><span class="line">    OsalSleep(initDelaySec);</span><br><span class="line">    devList = HdfWlanGetDeviceList();</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; devList-&gt;deviceListSize; i++) &#123;</span><br><span class="line">        <span class="comment">//sdio config</span></span><br><span class="line">        ret = HdfWlanConfigSDIO(devList-&gt;deviceInst[i].bus.busIdx);</span><br><span class="line">        <span class="comment">// init hardware</span></span><br><span class="line">        wlanDevice = ProbeDevice(&amp;(devList-&gt;deviceInst[i]));</span><br><span class="line">        ret = HdfWlanAddDevice(wlanDevice);</span><br><span class="line">        <span class="comment">// Load chip driver</span></span><br><span class="line">        (<span class="type">void</span>)DevSvcManagerClntSubscribeService(wlanDevice-&gt;driverName, callback);</span><br><span class="line">        (<span class="type">void</span>)HdfWifiInitDevice(wlanDevice);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HdfWlanInitThread也分为三个部分：</p>
<ul>
<li>HdfWlanConfigSDIO：由驱动开发者实现，配置sdio控制器外设</li>
<li>ProbeDevice：初始化硬件</li>
<li>HdfWifiInitDevice：初始化硬件驱动程序</li>
</ul>
<h5 id="3-2-1、HdfWlanConfigSDIO"><a href="#3-2-1、HdfWlanConfigSDIO" class="headerlink" title="3.2.1、HdfWlanConfigSDIO"></a><strong>3.2.1、HdfWlanConfigSDIO</strong></h5><p>由驱动开发者实现，配置sdio控制器外设，以海思的芯片为例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int32_t</span> <span class="title function_">HdfWlanConfigSDIO</span><span class="params">(<span class="type">uint8_t</span> busId)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">HdfConfigWlanRoot</span> *<span class="title">config</span> =</span> HdfWlanGetModuleConfigRoot();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(<span class="string">&quot;hi3516dv300&quot;</span>, config-&gt;wlanConfig.hostChipName) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ConfigHi3516DV300SDIO(busId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(<span class="string">&quot;hi3518ev300&quot;</span>, config-&gt;wlanConfig.hostChipName) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ConfigHi3518EV300SDIO(busId);</span><br><span class="line">    &#125;</span><br><span class="line">    HDF_LOGE(<span class="string">&quot;%s: platform chip not supported!&quot;</span>, __func__);</span><br><span class="line">    <span class="keyword">return</span> HDF_FAILURE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int32_t</span> <span class="title function_">ConfigHi3516DV300SDIO</span><span class="params">(<span class="type">uint8_t</span> busId)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (busId == <span class="number">2</span>) &#123;</span><br><span class="line">        HDF_LOGE(<span class="string">&quot;%s: Config Hi3516DV300 SDIO bus %d&quot;</span>, __func__, busId);</span><br><span class="line">        <span class="type">const</span> <span class="type">uint32_t</span> PMC_REG_ADDR_REG0 = <span class="number">0x12090000</span>;</span><br><span class="line">        <span class="type">const</span> <span class="type">uint32_t</span> PIN_REG_ADDR_CLK = <span class="number">0x112F0008</span>;</span><br><span class="line">        <span class="type">const</span> <span class="type">uint32_t</span> PIN_REG_ADDR_CMD = <span class="number">0x112F000C</span>;</span><br><span class="line">        <span class="type">const</span> <span class="type">uint32_t</span> PIN_REG_ADDR_DATA0 = <span class="number">0x112F0010</span>;</span><br><span class="line">        <span class="type">const</span> <span class="type">uint32_t</span> PIN_REG_ADDR_DATA1 = <span class="number">0x112F0014</span>;</span><br><span class="line">        <span class="type">const</span> <span class="type">uint32_t</span> PIN_REG_ADDR_DATA2 = <span class="number">0x112F0018</span>;</span><br><span class="line">        <span class="type">const</span> <span class="type">uint32_t</span> PIN_REG_ADDR_DATA3 = <span class="number">0x112F001C</span>;</span><br><span class="line"></span><br><span class="line">        REG_SET_BITS(PMC_REG_ADDR_REG0, <span class="number">0x0080</span>);</span><br><span class="line">        REG_WRITE(PIN_REG_ADDR_CLK, <span class="number">0x601</span>);</span><br><span class="line">        REG_WRITE(PIN_REG_ADDR_CMD, <span class="number">0x501</span>);</span><br><span class="line">        REG_WRITE(PIN_REG_ADDR_DATA0, <span class="number">0x501</span>);</span><br><span class="line">        REG_WRITE(PIN_REG_ADDR_DATA1, <span class="number">0x501</span>);</span><br><span class="line">        REG_WRITE(PIN_REG_ADDR_DATA2, <span class="number">0x501</span>);</span><br><span class="line">        REG_WRITE(PIN_REG_ADDR_DATA3, <span class="number">0x501</span>);</span><br><span class="line">        <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    HDF_LOGE(<span class="string">&quot;%s: SDIO bus ID %d not supportted!&quot;</span>, __func__, busId);</span><br><span class="line">    <span class="keyword">return</span> HDF_FAILURE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-2-2、ProbeDevice"><a href="#3-2-2、ProbeDevice" class="headerlink" title="3.2.2、ProbeDevice()"></a><strong>3.2.2、ProbeDevice()</strong></h5><p>初始化 HdfWlanDevice结构体，并调用HdfWlanDevice的方法初始化 硬件wifi芯片，如上电、复位、连接总线。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> HdfWlanDevice *<span class="title function_">ProbeDevice</span><span class="params">(<span class="keyword">struct</span> HdfConfigWlanDevInst *deviceConfig)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">HdfWlanDevice</span> *<span class="title">device</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    device = (<span class="keyword">struct</span> HdfWlanDevice *)OsalMemCalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> HdfWlanDevice));</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//create PowerManage and ResetManage </span></span><br><span class="line">        device-&gt;powers = HdfWlanCreatePowerManager(&amp;deviceConfig-&gt;powers);</span><br><span class="line">        device-&gt;reset = HdfWlanCreateResetManager(&amp;deviceConfig-&gt;reset, deviceConfig-&gt;bootUpTimeOut);</span><br><span class="line">		<span class="comment">//上电</span></span><br><span class="line">        ret = HdfWlanPowerOnProcess(device-&gt;powers);</span><br><span class="line">		<span class="comment">//复位 </span></span><br><span class="line">        ret = HdfWlanResetProcess(device-&gt;reset);</span><br><span class="line">		<span class="comment">//init sdio bus </span></span><br><span class="line">        ret = HdfWlanBusInit(device, &amp;deviceConfig-&gt;bus);</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HdfWlanDevice 是来描述所有wlan设备的硬件属性：例如驱动名称，芯片名称、电源、复位、连接到主控的总线</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">HdfWlanDevice</span> &#123;</span></span><br><span class="line">    <span class="type">uint8_t</span> id;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *driverName;                     <span class="comment">/**&lt; Driver name */</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *chipName;                       <span class="comment">/**&lt; Chip name */</span></span><br><span class="line">    <span class="type">uint32_t</span> netIfMap;                          <span class="comment">/**&lt; WLAN device bitmap */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">HdfWlanManufacturer</span> <span class="title">manufacturer</span>;</span>    <span class="comment">/**&lt; WLAN device manufacturer */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ResetManager</span> *<span class="title">reset</span>;</span>                 <span class="comment">/**&lt; Chip reset management API */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">PowerManager</span> *<span class="title">powers</span>;</span>                <span class="comment">/**&lt; Chip power management APIs */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BusDev</span> *<span class="title">bus</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ResetManager</span> &#123;</span></span><br><span class="line">    <span class="type">int32_t</span> (*Reset)(<span class="keyword">struct</span> ResetManager *resetManager);<span class="comment">//Resets the WLAN module using a specified reset manager</span></span><br><span class="line">    <span class="type">int32_t</span> (*Release)(<span class="keyword">struct</span> ResetManager *resetMgr);    <span class="comment">//Releases a specified reset manager.</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PowerManager</span> &#123;</span></span><br><span class="line">    <span class="type">int32_t</span> (*On)(<span class="keyword">struct</span> PowerManager *powerMgr);	<span class="comment">//Powers on the device using a specified power manager.</span></span><br><span class="line">    <span class="type">int32_t</span> (*Off)(<span class="keyword">struct</span> PowerManager *powerMgr);	<span class="comment">//Powers off the device using a specified power manager.</span></span><br><span class="line">    <span class="type">int32_t</span> (*Release)(<span class="keyword">struct</span> PowerManager *powerMgr);	<span class="comment">//Releases power using a specified power manager.</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BusDev</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> *devBase;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">DevOps</span> <span class="title">ops</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">PrivateData</span> <span class="title">priData</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>调用HdfWlanCreatePowerManager()会初始化PowerManager，HdfWlanPowerOnProcess 会调用PowerManager-&gt;on()，即HdfWlanChipPowerOn()，通过设置gpio引脚来使能wlan芯片。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int32_t</span> <span class="title function_">HdfWlanChipPowerOn</span><span class="params">(<span class="keyword">struct</span> PowerManager* powerMgr)</span></span><br><span class="line">&#123;</span><br><span class="line">    powerMgrimpl = (<span class="keyword">struct</span> PowerManagerImpl*)powerMgr;</span><br><span class="line">    ret = HdfWlanSinglePowerActive(&amp;powerMgrimpl-&gt;powerDatas.power0);</span><br><span class="line">    ret = HdfWlanSinglePowerActive((<span class="keyword">struct</span> HdfConfigWlanPower*)&amp;powerMgrimpl-&gt;powerDatas.power1);</span><br><span class="line">    <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int32_t</span> <span class="title function_">HdfWlanSinglePowerActive</span><span class="params">(<span class="keyword">struct</span> HdfConfigWlanPower* powerDate)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//set gpio pin</span></span><br><span class="line">    ret = GpioSetDir(powerDate-&gt;gpioId, <span class="number">1</span>);</span><br><span class="line">    OsalMSleep(powerDate-&gt;powerSeqDelay);</span><br><span class="line">    ret = GpioWrite(powerDate-&gt;gpioId, powerDate-&gt;activeLevel);</span><br><span class="line">    <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ResetManager的实现也是类似的</p>
<h5 id="3-2-3、HdfWifiInitDevice"><a href="#3-2-3、HdfWifiInitDevice" class="headerlink" title="3.2.3、HdfWifiInitDevice()"></a><strong>3.2.3、HdfWifiInitDevice()</strong></h5><p>获取 HdfChipDriverFactory，并调用其InitChip()方法来初始化芯片硬件，调用HdfWlanInitInterfaces()初始化HdfChipDriver ；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int32_t</span> <span class="title function_">HdfWifiInitDevice</span><span class="params">(<span class="keyword">struct</span> HdfWlanDevice *device)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span>  <span class="title">HdfChipDriverFactory</span> *<span class="title">chipDriverFact</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">//获取 HdfChipDriverFactory 管理所有驱动程序</span></span><br><span class="line">    chipDriverFact = HdfWlanGetDriverFactory(device-&gt;driverName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (chipDriverFact-&gt;InitChip != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">//初始化芯片</span></span><br><span class="line">        ret = chipDriverFact-&gt;InitChip(device);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建wifi芯片的接口</span></span><br><span class="line">    ret = HdfWlanInitInterfaces(device, chipDriverFact);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HdfChipDriverFactory结构体由硬件厂商实现，其最终目的是为了创建chip driver.</p>
<p><strong>chip driver</strong></p>
<p>HdfWlanInitInterfaces 创建对应芯片的HdfChipDriver ，创建netdevice，调用chipDriver-&gt;init()初始化芯片驱动程序（即由驱动开发者根据具体芯片实现的）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int32_t</span> <span class="title function_">HdfWlanInitInterface</span><span class="params">(<span class="keyword">struct</span> HdfWlanDevice *device, <span class="keyword">struct</span> HdfChipDriverFactory *factory, <span class="type">uint8_t</span> index)</span></span><br><span class="line">&#123;</span><br><span class="line">    NetDevice *netDev = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">HdfChipDriver</span> *<span class="title">chipDriver</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//创建 chip driver</span></span><br><span class="line">        chipDriver = factory-&gt;Build(device, index);</span><br><span class="line">        <span class="comment">//创建 NetDev </span></span><br><span class="line">        netDev = AllocPlatformNetDevice(device);</span><br><span class="line">        data = GetPlatformData(netDev);</span><br><span class="line">        data-&gt;device = device;</span><br><span class="line">        <span class="comment">//call chipdriver to init the chip</span></span><br><span class="line">        ret = chipDriver-&gt;init(chipDriver, netDev);</span><br><span class="line">        <span class="comment">//将netdev和chip driver 绑定</span></span><br><span class="line">        data-&gt;chipDriver = chipDriver;</span><br><span class="line">        chipDriver = <span class="literal">NULL</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>HdfChipDriver 是直接操作wifi 芯片硬件的驱动，也必须由驱动厂商实现，其中HdfMac80211BaseOps、HdfMac80211STAOps、HdfMac80211STAOps都需要实现具体的硬件操作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">HdfChipDriver</span> &#123;</span></span><br><span class="line">    <span class="type">uint16_t</span> type;                          <span class="comment">/**&lt; Chip type */</span></span><br><span class="line">    <span class="type">char</span> name[MAX_WIFI_COMPONENT_NAME_LEN]; <span class="comment">/**&lt; Chip name */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">HdfMac80211BaseOps</span> *<span class="title">ops</span>;</span>         </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">HdfMac80211STAOps</span> *<span class="title">staOps</span>;</span>       </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">HdfMac80211STAOps</span> *<span class="title">apOps</span>;</span>        </span><br><span class="line">    <span class="type">void</span> *priv;                             </span><br><span class="line">	<span class="comment">//Initializes a chip driver.</span></span><br><span class="line">    <span class="type">int32_t</span> (*init)(<span class="keyword">struct</span> HdfChipDriver *chipDriver, NetDevice *netDev);</span><br><span class="line">	<span class="comment">//Deinitializes a chip driver.</span></span><br><span class="line">    <span class="type">int32_t</span> (*deinit)(<span class="keyword">struct</span> HdfChipDriver *chipDriver, NetDevice *netDev);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">HdfMac80211BaseOps</span> &#123;</span></span><br><span class="line">	<span class="comment">//设置wifi模式</span></span><br><span class="line">    <span class="type">int32_t</span> (*SetMode)(NetDevice *netDev, <span class="keyword">enum</span> WlanWorkMode mode);</span><br><span class="line">	<span class="comment">//添加key</span></span><br><span class="line">    <span class="type">int32_t</span> (*AddKey)(<span class="keyword">struct</span> NetDevice *netDev, <span class="type">uint8_t</span> keyIndex, <span class="type">bool</span> pairwise, <span class="type">const</span> <span class="type">uint8_t</span> *macAddr,</span><br><span class="line">        <span class="keyword">struct</span> KeyParams *params);</span><br><span class="line">    <span class="type">int32_t</span> (*DelKey)(<span class="keyword">struct</span> NetDevice *netDev, <span class="type">uint8_t</span> keyIndex, <span class="type">bool</span> pairwise, <span class="type">const</span> <span class="type">uint8_t</span> *macAddr);</span><br><span class="line"></span><br><span class="line">    <span class="type">int32_t</span> (*SetDefaultKey)(<span class="keyword">struct</span> NetDevice *netDev, <span class="type">uint8_t</span> keyIndex, <span class="type">bool</span> unicast, <span class="type">bool</span> multicas);</span><br><span class="line"></span><br><span class="line">    <span class="type">int32_t</span> (*GetDeviceMacAddr)(NetDevice *netDev, <span class="type">int32_t</span> type, <span class="type">uint8_t</span> *mac, <span class="type">uint8_t</span> len);</span><br><span class="line">    <span class="type">int32_t</span> (*SetMacAddr)(NetDevice *netDev, <span class="type">uint8_t</span> *mac, <span class="type">uint8_t</span> len);</span><br><span class="line">    <span class="type">int32_t</span> (*SetTxPower)(NetDevice *netDev, <span class="type">int32_t</span> power);</span><br><span class="line">	<span class="comment">//获取芯片支持的带宽</span></span><br><span class="line">    <span class="type">int32_t</span> (*GetValidFreqsWithBand)(NetDevice *netDev, <span class="type">int32_t</span> band, <span class="type">int32_t</span> *freqs, <span class="type">uint32_t</span> *num);</span><br><span class="line">	<span class="comment">//获取芯片的能力</span></span><br><span class="line">    <span class="type">int32_t</span> (*GetHwCapability)(NetDevice *netDev, <span class="keyword">struct</span> WlanHwCapability **capability);</span><br><span class="line"></span><br><span class="line">    <span class="type">int32_t</span> (*RemainOnChannel)(NetDevice *netDev, WifiOnChannel *onChannel);</span><br><span class="line"></span><br><span class="line">    <span class="type">int32_t</span> (*CancelRemainOnChannel)(NetDevice *netDev);</span><br><span class="line"></span><br><span class="line">    <span class="type">int32_t</span> (*ProbeReqReport)(NetDevice *netDev, <span class="type">int32_t</span> report);</span><br><span class="line"></span><br><span class="line">    <span class="type">int32_t</span> (*AddIf)(NetDevice *netDev, WifiIfAdd *ifAdd);</span><br><span class="line"></span><br><span class="line">    <span class="type">int32_t</span> (*RemoveIf)(NetDevice *netDev, WifiIfRemove *ifRemove);</span><br><span class="line"></span><br><span class="line">    <span class="type">int32_t</span> (*SetApWpsP2pIe)(NetDevice *netDev, WifiAppIe *appIe);</span><br><span class="line"></span><br><span class="line">    <span class="type">int32_t</span> (*GetDriverFlag)(<span class="keyword">struct</span> NetDevice *netDev, WifiGetDrvFlags **params);</span><br><span class="line"></span><br><span class="line">    <span class="type">int32_t</span> (*SendAction)(<span class="keyword">struct</span> NetDevice *netDev, WifiActionData *actionData);</span><br><span class="line"></span><br><span class="line">    <span class="type">int32_t</span> (*GetIftype)(<span class="keyword">struct</span> NetDevice *netDev, <span class="type">uint8_t</span> *iftype);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>








      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/06/01/killer-blog/OpenHarmony/WLAN_Model/" data-id="cmbcy7rhn002kt8mt9sbr5oet" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2025/06/01/killer-blog/OpenHarmony/wlan_hdi/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2025/06/01/killer-blog/OpenHarmony/bearpi_pwm_driver/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">June 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">May 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/pwm/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/uart/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/worklife/2025%E6%B1%82%E8%81%8C%E5%87%86%E5%A4%87/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/other/tools/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/i2c_LSM303AGR/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>