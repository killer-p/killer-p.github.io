<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="pinctrl子系统pinctrl子系统是用于控制io引脚的复用和电气属性的，代码主要在设备树中体现。 硬件 IOMUXC在IMX6UL中，有一个IOMUXC控制器，这个控制器负责完成IO端口的复用和电气属性的设置。 如图所示，最右边是IO PAD，就是芯片的引脚。最左边的是PAD Setting Register 可以设置IO的电气属性，中间的是IOMUX可以设置IO的复用功能。  设备树iom">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2025/06/01/killer-blog/IMX6/pinctrl/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="pinctrl子系统pinctrl子系统是用于控制io引脚的复用和电气属性的，代码主要在设备树中体现。 硬件 IOMUXC在IMX6UL中，有一个IOMUXC控制器，这个控制器负责完成IO端口的复用和电气属性的设置。 如图所示，最右边是IO PAD，就是芯片的引脚。最左边的是PAD Setting Register 可以设置IO的电气属性，中间的是IOMUX可以设置IO的复用功能。  设备树iom">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/IMX6/pinctrl/1.png">
<meta property="article:published_time" content="2025-06-01T00:24:26.640Z">
<meta property="article:modified_time" content="2025-06-01T00:26:26.992Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2025/05/30/hello-world/IMX6/pinctrl/1.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-killer-blog/IMX6/pinctrl" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/06/01/killer-blog/IMX6/pinctrl/" class="article-date">
  <time class="dt-published" datetime="2025-06-01T00:24:26.640Z" itemprop="datePublished">2025-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="pinctrl子系统"><a href="#pinctrl子系统" class="headerlink" title="pinctrl子系统"></a>pinctrl子系统</h2><p>pinctrl子系统是用于控制io引脚的复用和电气属性的，代码主要在设备树中体现。</p>
<h3 id="硬件-IOMUXC"><a href="#硬件-IOMUXC" class="headerlink" title="硬件 IOMUXC"></a>硬件 IOMUXC</h3><p>在IMX6UL中，有一个IOMUXC控制器，这个控制器负责完成IO端口的复用和电气属性的设置。</p>
<p>如图所示，最右边是IO PAD，就是芯片的引脚。最左边的是PAD Setting Register 可以设置IO的电气属性，中间的是IOMUX可以设置IO的复用功能。</p>
<p><img src="/2025/05/30/hello-world/IMX6/pinctrl/1.png" alt="image-20220612130929250"></p>
<h3 id="设备树"><a href="#设备树" class="headerlink" title="设备树"></a>设备树</h3><p>iomuxc控制器节点如下 ：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iomuxc: iomuxc@<span class="number">020e0000</span> &#123;</span><br><span class="line">	compatible = <span class="string">&quot;fsl,imx6ul-iomuxc&quot;</span>;</span><br><span class="line">	reg = &lt;<span class="number">0x020e0000</span> <span class="number">0x4000</span>&gt;;  <span class="comment">//寄存器地址</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>子节点</p>
<p>iomucx节点下的每一个子节点，称为functions，例如imx6ul-evk就是一个function，function的每一个子节点是一个外设使用所有pin脚，这些pin脚的集合称为group。要弄清楚这些概念，因为后面的初始化就是围绕设备树里的配置来展开。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&amp;iomuxc</span><br><span class="line">	pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">	pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_hog_1&gt;;</span><br><span class="line">	imx6ul-evk &#123;</span><br><span class="line">		pinctrl_hog_1: hoggrp<span class="number">-1</span> &#123;</span><br><span class="line">			fsl,pins = &lt;</span><br><span class="line">				MX6UL_PAD_UART1_RTS_B__GPIO1_IO19	<span class="number">0x17059</span> <span class="comment">/* SD1 CD */</span></span><br><span class="line">				MX6UL_PAD_GPIO1_IO05__USDHC1_VSELECT	<span class="number">0x17059</span> <span class="comment">/* SD1 VSELECT */</span></span><br><span class="line">				<span class="comment">/* MX6UL_PAD_GPIO1_IO09__GPIO1_IO09        0x17059 SD1 RESET */</span></span><br><span class="line">				MX6UL_PAD_GPIO1_IO00__ANATOP_OTG1_ID	<span class="number">0x13058</span>	<span class="comment">/* USB_OTG1_ID */</span></span><br><span class="line">			&gt;;</span><br><span class="line">		&#125;;</span><br><span class="line">        <span class="comment">/* zuozhongkai LED */</span></span><br><span class="line">        pinctrl_led: ledgrp &#123;</span><br><span class="line">            fsl,pins = &lt;</span><br><span class="line">            	MX6UL_PAD_GPIO1_IO03__GPIO1_IO03        <span class="number">0x10B0</span> <span class="comment">/* LED0 */</span></span><br><span class="line">            &gt;;</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure>

<p>group中的<code>fsl,pins</code> 代表什么意思？</p>
<blockquote>
<p> Each pin represented in fsl,pins consists of 5 u32 PIN_FUNC_ID and 1 u32 CONFIG, so 24 types in total for each pin.</p>
</blockquote>
<p>每一个fsl,pins 表示5个32bit的PIN_FUNC_ID 和1个CONFIG，PIN_FUNC_ID 定义在imx6ul-pinfunc.h 中，具体是什么意思，以MX6UL_PAD_GPIO1_IO03__GPIO1_IO03 为例看看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MX6UL_PAD_GPIO1_IO03__GPIO1_IO03                          0x0068 0x02F4 0x0000 0x5 0x0</span></span><br><span class="line">			<span class="comment">//展开MX6UL_PAD_GPIO1_IO03__GPIO1_IO03 </span></span><br><span class="line">            fsl,pins = &lt;</span><br><span class="line">            	<span class="number">0x0068</span> <span class="number">0x02F4</span> <span class="number">0x0000</span> <span class="number">0x5</span> <span class="number">0x0</span>        <span class="number">0x10B0</span> <span class="comment">/* LED0 */</span></span><br><span class="line">            &gt;;</span><br></pre></td></tr></table></figure>

<ul>
<li>0x0068 表示复用寄存器的偏移，该寄存器设置pin脚的复用功能</li>
<li>0x5 表示 复用寄存器的值，这里是MUX_MODE &#x3D; 5，表示复用为gpio引脚</li>
<li>0x02F4 表示配置寄存器的偏移，这个寄存器设置pin脚的电气属性</li>
<li>0x10B0 表示该寄存器的值，二进制1 0000 1011 0000 ，内容是：低转换率，驱动强度r0&#x2F;6，100mhz速率，使能电荷保持器，关闭开漏输出，100k下拉电阻</li>
</ul>
<h3 id="驱动程序"><a href="#驱动程序" class="headerlink" title="驱动程序"></a>驱动程序</h3><p>一般来说，引脚的复用功能和电气属性在系统的运行过程中是不会改变的，所以在linux启动的过程中，所有io的初始化都是自动完成，且不会再改变。这一点应该是在pinctrl子系统完成的。</p>
<p>在drivers中搜索 <code>fsl,imx6ul-iomuxc</code>，找到位于pinctrl-imx6ul.c的驱动程序，可以发现这个是典型的platform_drivers，这个驱动支持<code>&quot;fsl,imx6ull-iomuxc-snvs&quot;</code>和<code>fsl,imx6ul-iomuxc</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">imx6ul_pinctrl_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> *<span class="title">match</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">imx_pinctrl_soc_info</span> *<span class="title">pinctrl_info</span>;</span></span><br><span class="line">	</span><br><span class="line">	match = of_match_device(imx6ul_pinctrl_of_match, &amp;pdev-&gt;dev);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!match)</span><br><span class="line">		<span class="keyword">return</span> -ENODEV;</span><br><span class="line">	<span class="comment">//拿到指定芯片的引脚信息</span></span><br><span class="line">	pinctrl_info = (<span class="keyword">struct</span> imx_pinctrl_soc_info *) match-&gt;data;</span><br><span class="line">	<span class="comment">//初始所有的引脚</span></span><br><span class="line">	<span class="keyword">return</span> imx_pinctrl_probe(pdev, pinctrl_info);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">imx6ul_pinctrl_driver</span> =</span> &#123;</span><br><span class="line">	.driver = &#123;</span><br><span class="line">		.name = <span class="string">&quot;imx6ul-pinctrl&quot;</span>,</span><br><span class="line">		.owner = THIS_MODULE,</span><br><span class="line">		.of_match_table = of_match_ptr(imx6ul_pinctrl_of_match),</span><br><span class="line">	&#125;,</span><br><span class="line">	.probe = imx6ul_pinctrl_probe,</span><br><span class="line">	.remove = imx_pinctrl_remove,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这个程序本质上是调用 imx_pinctrl_probe(pdev, pinctrl_info); 来完成具体的初始化，该函数位于 pinctrl-imx.c.</p>
<p>在这里，需要注意imx_pinctrl_soc_info ，这个对象其实就是保存group节点中的所有pin的寄存器信息，这个对象是imx的芯片需要的，并非是linux系统的。linux要求驱动需要实现pinctrl_desc 对象，并将其添加到pinctrl子系统。</p>
<p>在 imx_pinctrl_probe(pdev, pinctrl_info)中有：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_desc</span> *<span class="title">imx_pinctrl_desc</span>;</span> </span><br><span class="line">   <span class="comment">//初始化imx_pinctrl_desc</span></span><br><span class="line">imx_pinctrl_desc-&gt;name = dev_name(&amp;pdev-&gt;dev);</span><br><span class="line">imx_pinctrl_desc-&gt;pins = info-&gt;pins;</span><br><span class="line">imx_pinctrl_desc-&gt;npins = info-&gt;npins;</span><br><span class="line">imx_pinctrl_desc-&gt;pctlops = &amp;imx_pctrl_ops;</span><br><span class="line">imx_pinctrl_desc-&gt;pmxops = &amp;imx_pmx_ops;</span><br><span class="line">imx_pinctrl_desc-&gt;confops = &amp;imx_pinconf_ops;</span><br><span class="line">imx_pinctrl_desc-&gt;owner = THIS_MODULE;</span><br><span class="line"><span class="comment">//初始化iomucx节点下的字节点，完成imx_pinctrl_soc_info 对象的填充</span></span><br><span class="line">ret = imx_pinctrl_probe_dt(pdev, info);</span><br><span class="line"></span><br><span class="line">ipctl-&gt;info = info;</span><br><span class="line">ipctl-&gt;dev = info-&gt;dev;</span><br><span class="line">platform_set_drvdata(pdev, ipctl);</span><br><span class="line"><span class="comment">//注册imx_pinctrl_desc 到pinctrl子系统，同时会设置iomuxc的寄存器</span></span><br><span class="line">ipctl-&gt;pctl = pinctrl_register(imx_pinctrl_desc, &amp;pdev-&gt;dev, ipctl);</span><br></pre></td></tr></table></figure>

<h4 id="pinctrl-desc"><a href="#pinctrl-desc" class="headerlink" title="pinctrl_desc"></a>pinctrl_desc</h4><p>pinctrl驱动开发的重点就是实现pinctrl_desc对象，其中需要关注的是pmxops和confops，这两个分别实现设置io的复用和电气属性配置。</p>
<p>其本质就是使用imx_pinctrl_soc_info 的信息，读写iomuxc的寄存器：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_desc</span> &#123;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *name;  <span class="comment">//iomuxc名称</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_pin_desc</span> <span class="title">const</span> *<span class="title">pins</span>;</span>  <span class="comment">//芯片的引脚描述符数组</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> npins;  <span class="comment">//引脚数量</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_ops</span> *<span class="title">pctlops</span>;</span>  <span class="comment">//用于分组（可选）</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinmux_ops</span> *<span class="title">pmxops</span>;</span>  <span class="comment">//引脚复用的函数集</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinconf_ops</span> *<span class="title">confops</span>;</span>  <span class="comment">//引脚配置的函数集</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinmux_ops</span> <span class="title">imx_pmx_ops</span> =</span> &#123;</span><br><span class="line">	.set_mux = imx_pmx_set,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">imx_pmx_set</span><span class="params">(<span class="keyword">struct</span> pinctrl_dev *pctldev, <span class="type">unsigned</span> selector,</span></span><br><span class="line"><span class="params">		       <span class="type">unsigned</span> group)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">	writel(pin-&gt;mux_mode, ipctl-&gt;base + pin_reg-&gt;mux_reg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="imx-pinctrl-probe-dt"><a href="#imx-pinctrl-probe-dt" class="headerlink" title="imx_pinctrl_probe_dt"></a>imx_pinctrl_probe_dt</h4><p>imx_pinctrl_probe_dt 就是根据设备树完成imx_pinctrl_soc_info内所有成员的实现，具体的实际工作就是解析每一个外设节点的pin配置信息，这个在 <code>imx_pinctrl_parse_groups()</code>中实现</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">imx_pinctrl_soc_info</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span>  </span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_pin_desc</span> *<span class="title">pins</span>;</span> <span class="comment">//soc上的所有pin脚编号</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> npins;  <span class="comment">//pin脚的数量</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">imx_pin_reg</span> *<span class="title">pin_regs</span>;</span>  <span class="comment">//复用寄存器和配置寄存器的偏移地址</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">imx_pin_group</span> *<span class="title">groups</span>;</span>  <span class="comment">//该soc上的所有group</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> ngroups;  <span class="comment">//group的数量</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">imx_pmx_func</span> *<span class="title">functions</span>;</span>  <span class="comment">//一个soc可以有多个function，例如imx6ul-evk</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> nfunctions;  <span class="comment">//function的数量，这里是1</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">	u32 grp_index;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//描述一组pin脚的配置和复用</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">imx_pin_group</span> &#123;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">	<span class="type">unsigned</span> npins;  <span class="comment">//该组pin的数量</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> *pin_ids;  <span class="comment">//该组pin的所有引脚序号</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">imx_pin</span> *<span class="title">pins</span>;</span>  <span class="comment">//该组包含的pin数组</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//描述一个pin</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">imx_pin</span> &#123;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> pin;  <span class="comment">//引脚序号</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> mux_mode;  <span class="comment">//复用模式</span></span><br><span class="line">	u16 input_reg;  <span class="comment">//输入寄存器偏移</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> input_val;  <span class="comment">//输入寄存器的值</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> config;  <span class="comment">//引脚的电气配置</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//我不知道要怎么描述，反正就是代表imx6ul-evk节点</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">imx_pmx_func</span> &#123;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *name;  <span class="comment">//名称</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> **groups;  <span class="comment">//所有的组</span></span><br><span class="line">	<span class="type">unsigned</span> num_groups;  <span class="comment">//组的数量</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//解析一组pin</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">imx_pinctrl_parse_groups</span><span class="params">(<span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params">				    <span class="keyword">struct</span> imx_pin_group *grp,</span></span><br><span class="line"><span class="params">				    <span class="keyword">struct</span> imx_pinctrl_soc_info *info,</span></span><br><span class="line"><span class="params">				    u32 index)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> size, pin_size;</span><br><span class="line">	<span class="type">const</span> __be32 *<span class="built_in">list</span>;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	u32 config;</span><br><span class="line"></span><br><span class="line">	dev_dbg(info-&gt;dev, <span class="string">&quot;group(%d): %s\n&quot;</span>, index, np-&gt;name);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//确定pin_size，一般是 5*32bits=20个字节</span></span><br><span class="line">	<span class="keyword">if</span> (info-&gt;flags &amp; SHARE_MUX_CONF_REG)</span><br><span class="line">		pin_size = SHARE_FSL_PIN_SIZE;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		pin_size = FSL_PIN_SIZE;</span><br><span class="line">	<span class="comment">/* Initialise group */</span></span><br><span class="line">	grp-&gt;name = np-&gt;name;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * the binding format is fsl,pins = &lt;PIN_FUNC_ID CONFIG ...&gt;,</span></span><br><span class="line"><span class="comment">	 * do sanity check and calculate pins number</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">//list是一个u32的数组，是pin脚的配置信息</span></span><br><span class="line">	<span class="built_in">list</span> = of_get_property(np, <span class="string">&quot;fsl,pins&quot;</span>, &amp;size);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">list</span>) &#123;</span><br><span class="line">		dev_err(info-&gt;dev, <span class="string">&quot;no fsl,pins property in node %s\n&quot;</span>, np-&gt;full_name);</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* we do not check return since it&#x27;s safe node passed down */</span></span><br><span class="line">	<span class="keyword">if</span> (!size || size % pin_size) &#123;</span><br><span class="line">		dev_err(info-&gt;dev, <span class="string">&quot;Invalid fsl,pins property in node %s\n&quot;</span>, np-&gt;full_name);</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//计算pin数量</span></span><br><span class="line">	grp-&gt;npins = size / pin_size;</span><br><span class="line">	<span class="comment">//初始化pins</span></span><br><span class="line">	grp-&gt;pins = devm_kzalloc(info-&gt;dev, grp-&gt;npins * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> imx_pin),</span><br><span class="line">				GFP_KERNEL);</span><br><span class="line">	grp-&gt;pin_ids = devm_kzalloc(info-&gt;dev, grp-&gt;npins * <span class="keyword">sizeof</span>(<span class="type">unsigned</span> <span class="type">int</span>),</span><br><span class="line">				GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!grp-&gt;pins || ! grp-&gt;pin_ids)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; grp-&gt;npins; i++) &#123;</span><br><span class="line">		<span class="comment">//第一个u32是复用寄存器</span></span><br><span class="line">		u32 mux_reg = be32_to_cpu(*<span class="built_in">list</span>++);</span><br><span class="line">		u32 conf_reg;</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">int</span> pin_id;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">imx_pin_reg</span> *<span class="title">pin_reg</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">imx_pin</span> *<span class="title">pin</span> =</span> &amp;grp-&gt;pins[i];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!(info-&gt;flags &amp; ZERO_OFFSET_VALID) &amp;&amp; !mux_reg)</span><br><span class="line">			mux_reg = <span class="number">-1</span>;</span><br><span class="line">		<span class="comment">//是否复用和配置是同一个寄存器</span></span><br><span class="line">		<span class="keyword">if</span> (info-&gt;flags &amp; SHARE_MUX_CONF_REG) &#123;</span><br><span class="line">			conf_reg = mux_reg;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">//获取第二个u32，是配置寄存器</span></span><br><span class="line">			conf_reg = be32_to_cpu(*<span class="built_in">list</span>++);</span><br><span class="line">			<span class="keyword">if</span> (!(info-&gt;flags &amp; ZERO_OFFSET_VALID) &amp;&amp; !conf_reg)</span><br><span class="line">				conf_reg = <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//计算引脚编号</span></span><br><span class="line">		pin_id = (mux_reg != <span class="number">-1</span>) ? mux_reg / <span class="number">4</span> : conf_reg / <span class="number">4</span>;</span><br><span class="line">		pin_reg = &amp;info-&gt;pin_regs[pin_id];</span><br><span class="line">		pin-&gt;pin = pin_id;</span><br><span class="line">		grp-&gt;pin_ids[i] = pin_id;</span><br><span class="line">		<span class="comment">//保存寄存器偏移</span></span><br><span class="line">		pin_reg-&gt;mux_reg = mux_reg;</span><br><span class="line">		pin_reg-&gt;conf_reg = conf_reg;</span><br><span class="line">		pin-&gt;input_reg = be32_to_cpu(*<span class="built_in">list</span>++);</span><br><span class="line">		<span class="comment">//保存复用模式</span></span><br><span class="line">		pin-&gt;mux_mode = be32_to_cpu(*<span class="built_in">list</span>++);</span><br><span class="line">		pin-&gt;input_val = be32_to_cpu(*<span class="built_in">list</span>++);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* SION bit is in mux register */</span></span><br><span class="line">		<span class="comment">//保存配置信息</span></span><br><span class="line">		config = be32_to_cpu(*<span class="built_in">list</span>++);</span><br><span class="line">		<span class="keyword">if</span> (config &amp; IMX_PAD_SION)</span><br><span class="line">			pin-&gt;mux_mode |= IOMUXC_CONFIG_SION;</span><br><span class="line">		pin-&gt;config = config &amp; ~IMX_PAD_SION;</span><br><span class="line"></span><br><span class="line">		dev_dbg(info-&gt;dev, <span class="string">&quot;%s: 0x%x 0x%08lx&quot;</span>, info-&gt;pins[pin_id].name,</span><br><span class="line">				pin-&gt;mux_mode, pin-&gt;config);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="pinctrl-register"><a href="#pinctrl-register" class="headerlink" title="pinctrl_register"></a>pinctrl_register</h4><p>pinctrl_register 会将 pinctrl_desc 注册到pinctrl子系统，并调用pinctrl_desc 中的函数成员，完成对iomuxc寄存器的读写，从而设置好所有外设的pin复用和电气属性。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/06/01/killer-blog/IMX6/pinctrl/" data-id="cmbcy7rhd001xt8mtcpbfh2xq" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2025/06/01/killer-blog/IMX6/i2c/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2025/06/01/killer-blog/Git/git_help/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">June 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">May 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/pwm/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/uart/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/worklife/2025%E6%B1%82%E8%81%8C%E5%87%86%E5%A4%87/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/other/tools/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/i2c_LSM303AGR/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>