<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="@[toc] 一、简介1、vpn概念vpn即虚拟专有网络。是一种对局域网的模拟。 将互联网上网络主机使用加密的隧道连接成一个私网，私网内的主机之间通信具有加密性，私网中的主机会获得一个在该私网中的虚拟ip地址，通过该虚拟ip地址就能与私网内的主机安全通信。 2、vpn应用场景vpn经常用于员工远程访问公司内网，公司内网中有服务器，只有在内网中的主机能够访问该服务器，出差的员工想通过远程访问服务器">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2025/06/01/killer-blog/other/openvpn/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="@[toc] 一、简介1、vpn概念vpn即虚拟专有网络。是一种对局域网的模拟。 将互联网上网络主机使用加密的隧道连接成一个私网，私网内的主机之间通信具有加密性，私网中的主机会获得一个在该私网中的虚拟ip地址，通过该虚拟ip地址就能与私网内的主机安全通信。 2、vpn应用场景vpn经常用于员工远程访问公司内网，公司内网中有服务器，只有在内网中的主机能够访问该服务器，出差的员工想通过远程访问服务器">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/other/openvpn/5b3cd956bcc4485ebeec7d07a54eef78.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/other/openvpn/eb64e6b7781846c4b6554d6d426e7721.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/other/openvpn/0569abb14cc84a6abb8e1ba440c34ec5.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/other/openvpn/aec06cc7442940c1b9bfb367580efb64.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/other/openvpn/4804d95d7de64ebf9d377eb1a8138901.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/other/openvpn/04ae536c65134e6281237b2cf9cbf4a4.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/other/openvpn/a88b059a22ee40a09dd92e29293ac30f.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/other/openvpn/3ed89d4c4d5148d7b67a139eff9d7ea4.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/other/openvpn/85cb14a5b8ac451fb4ef09ada068eacf.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/other/openvpn/ebe8beafc83e4698a1d9c198ea335432.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/other/openvpn/37c027247ed642f09e418da9684d0119.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/other/openvpn/1b80a6bb204846c083a5a6a91a1c0e75.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/other/openvpn/a8670adb212046d8a94436f8ca770b70.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/other/openvpn/0d85ce44ce454c139f58fbc2e85c55c7.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/other/openvpn/7073bccd8311428f82cebf554571576d.png">
<meta property="article:published_time" content="2025-06-01T00:24:26.657Z">
<meta property="article:modified_time" content="2025-06-01T00:26:26.851Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2025/05/30/hello-world/other/openvpn/5b3cd956bcc4485ebeec7d07a54eef78.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-killer-blog/other/openvpn" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/06/01/killer-blog/other/openvpn/" class="article-date">
  <time class="dt-published" datetime="2025-06-01T00:24:26.657Z" itemprop="datePublished">2025-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <!--
 * @Author: your name
 * @Date: 2021-11-02 23:39:34
 * @LastEditTime: 2021-11-02 23:39:34
 * @LastEditors: your name
 * @Description: In User Settings Edit
 * @FilePath: \smart_controlc:\Users\prx\Desktop\openvpn介绍.md
-->
<p>@[toc]</p>
<h1 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h1><h2 id="1、vpn概念"><a href="#1、vpn概念" class="headerlink" title="1、vpn概念"></a>1、vpn概念</h2><p>vpn即虚拟专有网络。是一种对局域网的模拟。</p>
<p>将互联网上网络主机使用加密的隧道连接成一个私网，私网内的主机之间通信具有加密性，私网中的主机会获得一个在该私网中的虚拟ip地址，通过该虚拟ip地址就能与私网内的主机安全通信。</p>
<h2 id="2、vpn应用场景"><a href="#2、vpn应用场景" class="headerlink" title="2、vpn应用场景"></a>2、vpn应用场景</h2><p>vpn经常用于员工远程访问公司内网，公司内网中有服务器，只有在内网中的主机能够访问该服务器，出差的员工想通过远程访问服务器，就需要将笔记本电脑与公司服务器组成一个私网，由于这个私网是跨越在互联网之上的，所以使用vpn来组织私网。任何员工只要接入该vpn，就能远程访问公司服务器。</p>
<h2 id="3、openvpn概述"><a href="#3、openvpn概述" class="headerlink" title="3、openvpn概述"></a>3、openvpn概述</h2><p>openvpn2.x是使用OpenSSL实现虚拟专用网络的软件，因此他具备了OpenSSL提供的所有安全服务（身份认证，数据加密，数据完整性校验），并可以运行在不同主流的操作系统中。</p>
<p>openvpn 工作于 服务器&#x2F;客户端 模式，服务器的作用类似于局域网内的网关，负责在各个客户端之间转发数据消息。</p>
<h2 id="4、openvpn工作原理"><a href="#4、openvpn工作原理" class="headerlink" title="4、openvpn工作原理"></a>4、openvpn工作原理</h2><p>openvpn进程运行在用户空间，负责对数据进行加密封装&#x2F;解密解封等，不需要修改系统内核，通过在系统中创建的一个虚拟网卡，字符驱动程序来与系统内核进行通信。</p>
<p>虚拟网卡是openvpn实现功能的一个重要设备，用户空间的openvpn进程通过字符驱动来与虚拟网卡通信，虚拟网卡则通过路由转发与操作系统的协议栈通信。虚拟网卡在此作为openvpn进程与系统协议栈通信的媒介。</p>
<p>如图是Openvpn通信原理图：<br><img src="/2025/05/30/hello-world/other/openvpn/5b3cd956bcc4485ebeec7d07a54eef78.png"></p>
<p>每个步骤的详细内容：</p>
<p>​     由客户端APP发送数据为例</p>
<ol>
<li>APP发送目的地址为虚拟ip的UDP&#x2F;TCP 报文到socket接口</li>
<li>socket将报文传递到ip层</li>
<li>ip层将数据转发到虚拟网卡</li>
<li>虚拟网卡将报文传递给设备驱动</li>
<li>Openvpn进程对报文加密，生成数字签名，并将原始报文封装到一个新的UDP&#x2F;TCP报文中。远程IP即服务器公网IP，端口号默认1194</li>
<li>Openvpn将新报文通过socket发送</li>
<li>socket将新报文传递到ip层路由</li>
<li>ip层将新报文转发到物理网卡</li>
<li>物理网卡将新报文发送到服务器网卡<br>以下是服务器主机：</li>
<li>物理网卡将新报文传递到ip层</li>
<li>ip层将新报文传递给socket</li>
<li>socket根据端口号（1194）将新报文传递给Openvpn进程</li>
<li>Openvpn进程使用密钥对数据进行解密，校验，提取原始报文，并写入设备驱动</li>
<li>设备驱动将原始报文传递给虚拟网卡</li>
<li>虚拟网卡将原始报文发送到ip层</li>
<li>ip层将原始报文传递给socket</li>
<li>socket根据原始报文中的端口号，传递给对应的APP</li>
</ol>
<h2 id="5、虚拟网卡"><a href="#5、虚拟网卡" class="headerlink" title="5、虚拟网卡"></a>5、虚拟网卡</h2><p>用户程序通过字符设备驱动向虚拟网卡读取&#x2F;写入数据，虚拟网卡调用网卡驱动将数据读取&#x2F;写入tcp&#x2F;ip协议栈中。虚拟网和物理网卡一样，拥有自己的ip地址和网关。</p>
<p>openvpn的虚拟网卡支持tun和tap两种模式</p>
<ul>
<li>tun：一个虚拟的点对点的ip连接，通过字符设备驱动读取到的数据为ip数据包</li>
<li>tap：一个以太网适配器，通过字符设备驱动读取到的数据包含物理帧头，该模式可以传输以太网帧。</li>
</ul>
<p><img src="/2025/05/30/hello-world/other/openvpn/eb64e6b7781846c4b6554d6d426e7721.png" alt="在这里插入图片描述"></p>
<h2 id="6、虚拟地址"><a href="#6、虚拟地址" class="headerlink" title="6、虚拟地址"></a>6、虚拟地址</h2><p>openvpn服务端配置一个虚拟的ip池，如10.8.0.0&#x2F;24，每一个连接的客户端都会被分配一个虚拟的ip地址，服务端成为客户端在虚拟网络10.8.0.0&#x2F;24上的网关，这样客户端与服务端就构成了一个星型的网络。</p>
<p>客户端在虚拟网络10.8.0.0&#x2F;24上的通信都需要经过服务端来进行路由转发。可通过修改子网掩码，使ip地址池可用ip增加。</p>
<p>openvpn为了兼容tap-win32，windows系统，会为每一个客户端分配四个ip地址；故当使用10.8.0.0&#x2F;24网段时，虽然有256个可用的ip地址，但由于每个vpn占用4个ip地址，故仅能同时给64个vpn分配ip；</p>
<p>若在vpn中不存在windows系统，则可修改ip的分配方式。每个vpn只占用一个ip，可为客户端提供：10.8.0.2-→10.8.0.253的连续ip地址。</p>
<p>在server配置文件中，加入命令，开启此功能</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">topology subnet</span><br></pre></td></tr></table></figure>



<h1 id="二、安装openvpn"><a href="#二、安装openvpn" class="headerlink" title="二、安装openvpn"></a>二、安装openvpn</h1><p>硬件环境：虚拟机 Ubuntu18</p>
<p>软件环境：openvpn</p>
<h2 id="1、安装openvpn"><a href="#1、安装openvpn" class="headerlink" title="1、安装openvpn"></a>1、安装openvpn</h2><p>在Ubuntu命令行中执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install openvpn</span><br></pre></td></tr></table></figure>



<p>完成openvpn的安装，安装完成的openvpn可执行程序在 &#x2F;usr&#x2F;sbin&#x2F;openvpn，程序工作目录在&#x2F;etc&#x2F;openvpn</p>
<h2 id="2、安装easy-rsa"><a href="#2、安装easy-rsa" class="headerlink" title="2、安装easy-rsa"></a>2、安装easy-rsa</h2><p>证书的生成需要使用easy-rsa。从github中下载easy-rsa2.0：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/OpenVPN/easy-rsa-old/archive/refs/heads/master.zip</span><br></pre></td></tr></table></figure>





<p>解压文件到目录&#x2F;etc&#x2F;openvpn下</p>
<h1 id="三、配置证书"><a href="#三、配置证书" class="headerlink" title="三、配置证书"></a>三、配置证书</h1><p>证书的生成是用easy-rsa来实现的。</p>
<h2 id="1、CA证书"><a href="#1、CA证书" class="headerlink" title="1、CA证书"></a>1、CA证书</h2><p>OpenVPN支持双向认证。客户端和服务端的证书需要有ca机构签名。ca机构用ca证书给其他证书签名，ca证书是根本的。</p>
<p>修改&#x2F;etc&#x2F;openvpn&#x2F;easy-rsa&#x2F;vars文件里的 KEY_COUNTRY, KEY_PROVINCE, KEY_CITY, KEY_ORG, and KEY_EMAIL参数 并将当前目录下的openssl-1.0.0.cnf 重命名为openssl.cnf 并执行下列命令生成CA文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">. ./vars ./clean-all ./build-ca</span><br></pre></td></tr></table></figure>


<p>输入相应的参数：</p>
<p><img src="/2025/05/30/hello-world/other/openvpn/0569abb14cc84a6abb8e1ba440c34ec5.png"></p>
<h2 id="2、服务端证书和私钥"><a href="#2、服务端证书和私钥" class="headerlink" title="2、服务端证书和私钥"></a>2、服务端证书和私钥</h2><p>执行 .&#x2F;build-key-server server 签发服务端证书和私钥：</p>
<p><img src="/2025/05/30/hello-world/other/openvpn/aec06cc7442940c1b9bfb367580efb64.png"></p>
<h2 id="3、客户端证书和私钥"><a href="#3、客户端证书和私钥" class="headerlink" title="3、客户端证书和私钥"></a>3、客户端证书和私钥</h2><p>生成3个客户端证书密钥：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./build-key client_1 ./build-key client_2 ./build-key client_3</span><br></pre></td></tr></table></figure>

<p>下图提示是否对证书进行签名，输入y确认签名，即可生成可使用的客户端证书</p>
<p><img src="/2025/05/30/hello-world/other/openvpn/4804d95d7de64ebf9d377eb1a8138901.png" alt="在这里插入图片描述"></p>
<h2 id="4、Diffie-Hellman-参数文件"><a href="#4、Diffie-Hellman-参数文件" class="headerlink" title="4、Diffie Hellman 参数文件"></a>4、Diffie Hellman 参数文件</h2><p>diffie hellman参数文件用于在安全的情况下，协商密钥，执行以下语句生成</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./build-dh</span><br></pre></td></tr></table></figure>



<h2 id="5、生成ta-key"><a href="#5、生成ta-key" class="headerlink" title="5、生成ta.key"></a>5、生成ta.key</h2><p>使用tls-auth加密udp数据包，需要一个共享密钥来校验SSL握手报文，执行以下命令生成该密钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openvpn --genkey --secret ta.key</span><br></pre></td></tr></table></figure>





<p>至此，所需的证书和密钥就生成完毕了。生成的证书文件放在keys文件夹下。如图</p>
<p>将client1.crt,client.key,ca.crt,ta.key通过安全的途径复制到客户端1主机中。</p>
<p><img src="/2025/05/30/hello-world/other/openvpn/04ae536c65134e6281237b2cf9cbf4a4.png" alt="在这里插入图片描述"></p>
<h1 id="四、配置openvpn"><a href="#四、配置openvpn" class="headerlink" title="四、配置openvpn"></a>四、配置openvpn</h1><p>openvpn的配置信息主要是由配置文件中的命令来设置的，可从github中下载实例配置文件client.conf，server.conf</p>
<p><strong><a target="_blank" rel="noopener" href="https://github.com/OpenVPN/openvpn">https://github.com/OpenVPN/openvpn</a></strong></p>
<h2 id="1、桥接或路由"><a href="#1、桥接或路由" class="headerlink" title="1、桥接或路由"></a>1、桥接或路由</h2><p>一般的vpn都会选择工作在路由模式，只需要经过简单的设置就能实现vpn的功能。路由模式下，客户端之间处于同一虚拟私网中，接受发送的数据包都是ip数据包；虚拟网卡使用tun</p>
<p>openvpn还支持桥接模式，该模式下，接入vpn的客户端之间不仅处于同一局域网中，还处于同一以太网中，此时的客户端接收发送的数据包是以太网数据包。该模式下配置较复杂。虚拟网卡使用tap</p>
<h2 id="2、确定虚拟子网"><a href="#2、确定虚拟子网" class="headerlink" title="2、确定虚拟子网"></a>2、确定虚拟子网</h2><p>确定虚拟网络的网段地址，需要注意子网的网段最好不要与客户端或服务端本地的网段重叠，局域网网段如下图，推荐使用10.8.0.0&#x2F;24网段。</p>
<p><img src="/2025/05/30/hello-world/other/openvpn/a88b059a22ee40a09dd92e29293ac30f.png" alt="在这里插入图片描述"></p>
<h2 id="3、快速搭建vpn"><a href="#3、快速搭建vpn" class="headerlink" title="3、快速搭建vpn"></a>3、快速搭建vpn</h2><p>为了快速建立一个vpn，只需要修改服务端和客户端配置文件中的以下几项：</p>
<h3 id="server"><a href="#server" class="headerlink" title="server"></a>server</h3><p>在server.conf中修改ca证书，server证书和私钥，dh的路径如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ca /etc/openvpn/easy-rsa-old/2.0/keys/ca.crt </span><br><span class="line">cert  /etc/openvpn/easy-rsa-old/2.0/keys/server.crt </span><br><span class="line">key  /etc/openvpn/easy-rsa-old/2.0/keys/server.key    </span><br><span class="line">dh  /etc/openvpn/easy-rsa-old/2.0/keys/dh2048.pem</span><br></pre></td></tr></table></figure>



<p>确定VPN的虚拟网段，服务端主机的VPN ip为10.8.0.1</p>
<p>修改ta.key证书的地址 在服务端需要设置参数为0</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server 10.8.0.0 255.255.255.0  tls-auth /etc/openvpn/ta.key 0 </span><br></pre></td></tr></table></figure>

<h3 id="client"><a href="#client" class="headerlink" title="client"></a>client</h3><p>类似于服务端，在client.conf修改ca证书，server证书和密钥，dh路径如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ca /etc/openvpn/easy-rsa-old/2.0/keys/ca.crt </span><br><span class="line">cert  /etc/openvpn/easy-rsa-old/2.0/keys/server.crt </span><br><span class="line">key  /etc/openvpn/easy-rsa-old/2.0/keys/server.key</span><br></pre></td></tr></table></figure>



<p>修改ta.key证书的地址 在客户端需要设置参数为1，指定remote 中的服务端的公网ip地址：（例如服务端的公网ip为192.168.3.1）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tls-auth /etc/openvpn/ta.key 1  remote 192.168.3.1 1194</span><br></pre></td></tr></table></figure>



<p>至此，配置文件编写完成。</p>
<h1 id="五、启动openvpn"><a href="#五、启动openvpn" class="headerlink" title="五、启动openvpn"></a>五、启动openvpn</h1><h2 id="1、启动openvpn-server"><a href="#1、启动openvpn-server" class="headerlink" title="1、启动openvpn server"></a>1、启动openvpn server</h2><p>在server.conf 目录下执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openvpn server.conf</span><br></pre></td></tr></table></figure>


<p>打印信息如下：表示server建立成功</p>
<p><img src="/2025/05/30/hello-world/other/openvpn/3ed89d4c4d5148d7b67a139eff9d7ea4.png" alt="在这里插入图片描述"></p>
<h2 id="2、启动openvpn-client"><a href="#2、启动openvpn-client" class="headerlink" title="2、启动openvpn client"></a>2、启动openvpn client</h2><p>在server.conf 目录下执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openvpn client.conf</span><br></pre></td></tr></table></figure>

<p>客户端验证成功，打印信息如下：</p>
<p><img src="/2025/05/30/hello-world/other/openvpn/85cb14a5b8ac451fb4ef09ada068eacf.png" alt="在这里插入图片描述"></p>
<p><img src="/2025/05/30/hello-world/other/openvpn/ebe8beafc83e4698a1d9c198ea335432.png" alt="在这里插入图片描述"></p>
<h2 id="3、server-和-client-在vpn中互ping"><a href="#3、server-和-client-在vpn中互ping" class="headerlink" title="3、server 和 client 在vpn中互ping"></a>3、server 和 client 在vpn中互ping</h2><p>从上面可知client在vpn中的ip为10.8.0.14，在server中启动新的命令行，ping 10.8.0.14 成功收到反馈</p>
<p>在客户端机器中ping 10.8.0.1 服务端主机，成功反馈。</p>
<p><img src="/2025/05/30/hello-world/other/openvpn/37c027247ed642f09e418da9684d0119.png" alt="在这里插入图片描述"></p>
<p><img src="/2025/05/30/hello-world/other/openvpn/1b80a6bb204846c083a5a6a91a1c0e75.png" alt="在这里插入图片描述"></p>
<h1 id="六、其他配置"><a href="#六、其他配置" class="headerlink" title="六、其他配置"></a>六、其他配置</h1><h2 id="1、设置开机自动启动"><a href="#1、设置开机自动启动" class="headerlink" title="1、设置开机自动启动"></a>1、设置开机自动启动</h2><p>要开启此功能，必须使用rpm或deb包安装openvpn，用这种方式安装openvpn会生成一个初始化脚本，该脚本会扫面&#x2F;etc&#x2F;openvpn&#x2F;下的所有.conf文件，并启动对应的vpn进程。</p>
<h2 id="2、控制openvpn进程的方式"><a href="#2、控制openvpn进程的方式" class="headerlink" title="2、控制openvpn进程的方式"></a>2、控制openvpn进程的方式</h2><h3 id="a、使用信号量"><a href="#a、使用信号量" class="headerlink" title="a、使用信号量"></a>a、使用信号量</h3><p>使用writepid命令将openvpn经常的pid写入一个文件中，用户程序就能根据pid发送信号量来控制openvpn进程。</p>
<h3 id="b、在运行中修改配置文件"><a href="#b、在运行中修改配置文件" class="headerlink" title="b、在运行中修改配置文件"></a>b、在运行中修改配置文件</h3><p>openvpn支持在进程运行时修改部分配置文件：</p>
<ul>
<li>client-config-dir – 命令指出客户端配置文件的路径，每次客户端连接时，openvpn会扫描该目录并找对应的配置文件。在openvpn运行时，修改该目录的配置文件，旧的客户端连接不会被影响，若要更新某个特定的客户端连接，就要让客户端先断开再重新连接。</li>
<li>crl-verify – 指定一个证书撤销文件，用于撤销客户端的证书，修改他不会影响已经建立连接的客户端。</li>
</ul>
<h3 id="c、输出日志文件"><a href="#c、输出日志文件" class="headerlink" title="c、输出日志文件"></a>c、输出日志文件</h3><p>openvpn server中一行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">status openvpn-status.log</span><br></pre></td></tr></table></figure>


<p>表示vpn每一分钟会将已连接的客户端列表打印到文件openvpn-status.log中。</p>
<h3 id="d、用户管理接口"><a href="#d、用户管理接口" class="headerlink" title="d、用户管理接口"></a>d、用户管理接口</h3><p>openvpn提供一个强大的管理接口来管理openvpn客户端或服务端进程。</p>
<p>openvpn通过监听一个ip和端口上的tcp连接来开启该接口，开发者通过一个telnet来连接该接口，由于这个tcp连接过程是没有经过任何加密的，所以建议将监听建立在localhost或者在vpn网段，以增加安全性</p>
<p>在openvpn sever配置文件中使用命令：管理接口监听在本地7505端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">management localhost 7505  <span class="comment"># 若要支持vpn客户端连接上管理接口后输入密码认证，则需要添加命令 --management-client-auth</span></span><br></pre></td></tr></table></figure>


<p>该接口支持的命令文档：<a target="_blank" rel="noopener" href="https://openvpn.net/community-resources/management-interface/">https://openvpn.net/community-resources/management-interface/</a></p>
<p>常用命令：</p>
<ul>
<li>bytecount -n：当n&gt;0，管理接口每隔n秒打印带宽使用情况。n&#x3D;0关闭功能</li>
<li>exit&#x2F;quit：推出会话</li>
<li>killer：杀死一个client对象，命令后面跟着客户端的ip地址和端口，或common name</li>
<li>log：开启或关闭日志输出</li>
<li>pid：显示vpn进程pid</li>
<li>status：显示已连接 的客户端列表</li>
</ul>
<h2 id="3、扩展服务端的子网"><a href="#3、扩展服务端的子网" class="headerlink" title="3、扩展服务端的子网"></a>3、扩展服务端的子网</h2><p>场景：客户端除了与服务端本身通信外，还希望与服务端所在子网的主机通信。假设服务端所在的子网为192.168.137.0&#x2F;24，vpn虚拟子网为10.8.0.0&#x2F;24.</p>
<p>client发送数据，到达server，再由server将数据包在子网192.168.137.0&#x2F;24内转发到App_server主机。</p>
<p>App_server以正常方式处理该数据包，发送到路由器，路由器根据路由表（需要设置）转发到达openvpn server，openvpn server对数据包进行检查并重新封装，通过vpn隧道发送到client。</p>
<p>note：在网关路由中添加一条路由规则，将目的ip为10.8.0.0&#x2F;24的数据路由到openvpn server。</p>
<p><img src="/2025/05/30/hello-world/other/openvpn/a8670adb212046d8a94436f8ca770b70.png" alt="在这里插入图片描述"></p>
<h2 id="4、扩展客户端的子网"><a href="#4、扩展客户端的子网" class="headerlink" title="4、扩展客户端的子网"></a>4、扩展客户端的子网</h2><p>类似的，假设客户端client2是一个网关，其子网为192.168.137.0&#x2F;24，vpn网络为10.8.0.0&#x2F;24，客户端子网中的主机要与服务端或服务端所在子网的主机通信。</p>
<p>首先确保192.168.137.0&#x2F;24没有与接入vpn的其他网络网段冲突。</p>
<p>在server的配置文件中指定客户端配置文件的路径：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client-config-dir ccd</span><br></pre></td></tr></table></figure>



<p>在ccd路径下创建client2文件，输入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iroute 192.168.137.0 255.255.255.0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个操作告诉vpn server ：发往192.168.137.0&#x2F;24的数据包 需要转发到client2.</p>
<p>在server.conf中添加命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route 192.168.137.0 255.255.255.0</span><br></pre></td></tr></table></figure>




<p>这个操作告诉虚拟网卡将 发往192.168.137.0&#x2F;24的数据包 传递给openvpn进程，由openvpn对数据包重新封装发送到client_2。</p>
<p><strong>同时在server 网关中添加路由规则，路由192.168.137.0&#x2F;24的数据包到server</strong></p>
<p><img src="/2025/05/30/hello-world/other/openvpn/0d85ce44ce454c139f58fbc2e85c55c7.png" alt="在这里插入图片描述"></p>
<p>若想要192.168.137.0&#x2F;24子网内的主机能与vpn中其他客户端通信，则在server.conf中添加：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client-to-client push <span class="string">&quot;route 192.168.137.0 255.255.255.0&quot;</span></span><br></pre></td></tr></table></figure>


<p>这个命令向所有客户端广播192.168.137.0&#x2F;24这个子网，表示该子网连接到vpn网络中。</p>
<h2 id="5、推送DNS服务器地址"><a href="#5、推送DNS服务器地址" class="headerlink" title="5、推送DNS服务器地址"></a>5、推送DNS服务器地址</h2><p>openvpn server 能给所有客户端推送DHCP选项，比如DNS服务器的地址。</p>
<p>假设DNS服务器的地址是10.8.0.3 ，在server.conf中添加：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">push <span class="string">&quot;dhcp-option DNS 10.8.0.3&quot;</span></span><br></pre></td></tr></table></figure>

<p>当客户端运行在linux系统中，需要设置脚本来将server 推送的dns保存到配置文件&#x2F;etc&#x2F;resolv.conf 中。</p>
<p>在客户端主机上创建&#x2F;etc&#x2F;openvpn&#x2F;client.up脚本文件，该文件内容可由仓库例程&#x2F;contrib&#x2F;pull-resolv-conf&#x2F;client.up参考。然后给与脚本执行权限：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> a+x /etc/openvpn/client.up</span><br></pre></td></tr></table></figure>



<p>在客户端配置文件client.conf中添加该脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">up /etc/openvpn/client.up</span><br></pre></td></tr></table></figure>

<p>当客户端连接到服务端时，会收到服务端推送的选项，openvpn client进程会将这些选项保存在环境变量foreign_option_{n}中，然后在客户端执行&#x2F;etc&#x2F;openvpn&#x2F;client.up脚本，脚本会提取环境变量foreign_option_{n}并在&#x2F;etc&#x2F;resolv.conf中添加：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nameserver 10.8.0.3</span><br></pre></td></tr></table></figure>

<p>流程图如下：</p>
<p><img src="/2025/05/30/hello-world/other/openvpn/7073bccd8311428f82cebf554571576d.png" alt="在这里插入图片描述"></p>
<h2 id="6、客户端访问控制"><a href="#6、客户端访问控制" class="headerlink" title="6、客户端访问控制"></a>6、客户端访问控制</h2><p>应用场景：限制客户端A只能与vpn server通信，而不能跟其他客户端B,C,D通信。而超级客户端Y则能跟任何vpn内主机通信。</p>
<p>分为两个部分：</p>
<p>a，区分客户端。</p>
<p>b，设置服务端的防火墙规则。</p>
<h3 id="a、区分客户端"><a href="#a、区分客户端" class="headerlink" title="a、区分客户端"></a>a、区分客户端</h3><p>假设超级客户端的虚拟ip网段为10.8.2.0&#x2F;24，其他客户端的虚拟ip为10.8.0.0&#x2F;24网段。</p>
<p>在server.conf中设置vpn的虚拟ip网段为10.8.0.0&#x2F;24，并支持路由到10.8.2.0&#x2F;24</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server 10.8.0.0 255.255.255.0 <span class="comment"># server接受来自10.8.2.0/24的数据包 route 10.8.2.0 255.255.255.0</span></span><br></pre></td></tr></table></figure>

<p>修改ccd目录下的客户端配置文件，给特定的超级客户端分配特定的ip地址:</p>
<p>ip地址的设置有一定的要求，具体见文档<a target="_blank" rel="noopener" href="https://openvpn.net/community-resources/how-to/">https://openvpn.net/community-resources/how-to/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># determining-whether-to-use-a-routed-or-bridged-vpn </span></span><br><span class="line">ifconfig-push 10.8.2.1 10.8.2.2</span><br></pre></td></tr></table></figure>

<p>超级客户端连接上vpn后，其虚拟ip地址是10.8.2.1.其他客户端的虚拟ip为10.8.0.0&#x2F;24网段。</p>
<h3 id="b、设置防火墙"><a href="#b、设置防火墙" class="headerlink" title="b、设置防火墙"></a>b、设置防火墙</h3><p>设置openvpn server所在机器的防火墙的转发规则，使普通客户端的报文只能输入到server，超级客户端的报文能正常转发给普通客户端。</p>
<p>首先修改server.conf中虚拟网卡的编号为dev tun0，以便在防火墙规则中引用他</p>
<p>修改linux防火墙规则</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 仅允许其他客户端访问server 10.8.0.1(源地址是10.8.0.0/24,目的地址不是10.8.0.1的数据包，会被防火墙丢弃) </span></span><br><span class="line">iptables -A FORWARD -i tun0 -s 10.8.0.0/24 -d !10.8.0.1 -j DROP  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许超级客户端访问10.8.0.0/24所有主机(源地址是10.8.0.0/24,目的地址是10.8.0.0/24的数据包，会被转发) </span></span><br><span class="line">iptables -A FORWARD -i tun0 -s 10.8.2.1 -d 10.8.0.0/24 -j ACCEPT</span><br></pre></td></tr></table></figure>

<h2 id="7、通过http代理连接openvpn"><a href="#7、通过http代理连接openvpn" class="headerlink" title="7、通过http代理连接openvpn"></a>7、通过http代理连接openvpn</h2><p>由于http代理使用tcp协议，所以在客户端和服务端的配置文件中都需要将proto命令设置为tcp。</p>
<p>openvpn支持三个代理认证方式：</p>
<ul>
<li>无代理认证</li>
<li>用户名&#x2F;密码代理认证</li>
<li>NTLM代理认证</li>
</ul>
<p>在客户端配置文件中添加代理服务器的地址及认证方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在命令行输入用户名密码 </span></span><br><span class="line">http-proxy 192.168.4.1 1080 stdin basic</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在passfile文件存放用户名/密码 </span></span><br><span class="line">http-proxy 192.168.4.1 1080 passfile</span><br></pre></td></tr></table></figure>






<h2 id="8、负载均衡"><a href="#8、负载均衡" class="headerlink" title="8、负载均衡"></a>8、负载均衡</h2><p>负载均衡是在高并发的情况下，将请求合理的分配到不同的服务器进程中。这就要求运行多个openvpn server进程，无论是在一个主机上还是在多个不同主机上。</p>
<h3 id="a、客户端配置"><a href="#a、客户端配置" class="headerlink" title="a、客户端配置"></a>a、客户端配置</h3><p>客户端只需要在remote指令中指出多个服务器的地址和端口即可。</p>
<h3 id="b、服务端"><a href="#b、服务端" class="headerlink" title="b、服务端"></a>b、服务端</h3><p>当多个服务端运行在同一台机器时，使用同一份配置文件，只需要修改端口号。</p>
<p>当多个服务端运行在不同机器时，要确保每个机器上有相同的客户端证书和认证方式。</p>
<p>多个openvpn服务器必须各自拥有唯一的虚拟ip地址。</p>
<h2 id="9、撤销客户端证书"><a href="#9、撤销客户端证书" class="headerlink" title="9、撤销客户端证书"></a>9、撤销客户端证书</h2><p>撤销客户端证书意味着客户端不能使用该证书完成客户端认证。</p>
<p>首先，在easy-rsa路径下，执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">. ./vars ./revoke-full client</span><br></pre></td></tr></table></figure>

<p>该命令会在keys目录下生成一个crl.pem文件，需要将该文件放到openvpn server可访问的路径，并在server配置文件中加入命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crl-verify crl.pem</span><br></pre></td></tr></table></figure>

<p>当有新的连接进入vpn时，所有客户端会与该文件比较，匹配的客户端将会被强制断开连接。</p>
<h2 id="10、使用脚本和环境变量二次开发"><a href="#10、使用脚本和环境变量二次开发" class="headerlink" title="10、使用脚本和环境变量二次开发"></a>10、使用脚本和环境变量二次开发</h2><h3 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h3><p>openvpn支持用户自定义脚本，以在openvpn运行过程中执行脚本。在openvpn配置文件中加入以下命令以注册脚本，当相应条件满足时，openvpn就会执行对应脚本。</p>
<ul>
<li>up：在TCP&#x2F;UDP套接字绑定后并打开tun之后执行、</li>
<li>tls-verify：有一个不信任的远程对端时执行</li>
<li>ipchange：在连接后或服务器ip发生改变后执行</li>
<li>client-connect：在服务器端，一个客户端认证后执行</li>
<li>route-up：在连接完成后执行</li>
<li>client-disconnect：客户端断开连接后执行</li>
<li>down：tcp&#x2F;udp，tun&#x2F;tap关闭后执行</li>
<li>learn-address：ipv4地址或mac地址被添加到openvpn server路由表时执行</li>
<li>auth-user-pass-verify：客户端连接并还未认证时执行</li>
</ul>
<h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h3><p>openvpn运行过程会设置环境变量，传递给脚本使用。环境变量一旦被设置，会一直保持直到被覆盖或重启。环境变量是以一个客户端为对象的，每个客户端都有各自独立的环境变量。</p>
<h2 id="11、全局vpn"><a href="#11、全局vpn" class="headerlink" title="11、全局vpn"></a>11、全局vpn</h2><p>若想让客户端的所有ip报文都通过vpn通道传输，则可以在客户端中设置命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">push <span class="string">&quot;redirect-gateway def1&quot;</span></span><br></pre></td></tr></table></figure>

<p>客户端会将所有ip报文发送到服务端，服务端需要把报文转发到互联网，可使用NAT或http代理：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用防火墙对源地址为10.8.0.0/24的报文转发到eth0网口 </span></span><br><span class="line">iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE</span><br></pre></td></tr></table></figure>

<p>客户端发送的DNS请求也会经过服务端，服务端需要接受请求，并把DNS服务器的地址推送给客户端，来替换他们原本的DNS服务器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">push <span class="string">&quot;dhcp-option DNS 10.8.0.1&quot;</span></span><br></pre></td></tr></table></figure>

<p>注意：客户端需要周期性与DHCP服务器通信以获取ip地址，redirect-gateway命令可能使客户端长度无法与DHCP正常通信而丢失ip</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/06/01/killer-blog/other/openvpn/" data-id="cmbcy7rhz003mt8mt4p0lfbx4" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2025/06/01/killer-blog/other/Fourier_Transform/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2025/06/01/killer-blog/lwip/lwip_mm_heap/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">June 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">May 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/pwm/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/uart/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/worklife/2025%E6%B1%82%E8%81%8C%E5%87%86%E5%A4%87/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/other/tools/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/i2c_LSM303AGR/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>