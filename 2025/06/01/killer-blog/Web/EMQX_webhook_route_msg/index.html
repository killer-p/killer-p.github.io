<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="@[toc] 修改记录  2021.5.19 修改文章格式，在第三节添加了服务器的压缩文件 myweb.war. 添加项目仓库。  一，前言 之前写过一篇关于EMQX数据持久化到MySQL数据库，但由于这个功能需要EMQX企业版才能实现，而企业版的费用对于我这种学生党而言实在难以负担。于是，我在EMQX官方发现另一种方法也可以实现保存数据。官网对于webhook的示例   预备知识：http协议与">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2025/06/01/killer-blog/Web/EMQX_webhook_route_msg/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="@[toc] 修改记录  2021.5.19 修改文章格式，在第三节添加了服务器的压缩文件 myweb.war. 添加项目仓库。  一，前言 之前写过一篇关于EMQX数据持久化到MySQL数据库，但由于这个功能需要EMQX企业版才能实现，而企业版的费用对于我这种学生党而言实在难以负担。于是，我在EMQX官方发现另一种方法也可以实现保存数据。官网对于webhook的示例   预备知识：http协议与">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20191124225507345.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/2019092521434592.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925214452499.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925214728645.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925214939528.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925215235282.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925215443641.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925215550210.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925223226631.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925223348324.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925223940966.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925224223760.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925230352836.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925230438153.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925230623970.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925230844728.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925231413679.png">
<meta property="og:image" content="http://example.com/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20200614084955388.png">
<meta property="article:published_time" content="2025-06-01T00:24:26.649Z">
<meta property="article:modified_time" content="2025-06-01T00:26:26.912Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20191124225507345.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-killer-blog/Web/EMQX_webhook_route_msg" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/06/01/killer-blog/Web/EMQX_webhook_route_msg/" class="article-date">
  <time class="dt-published" datetime="2025-06-01T00:24:26.649Z" itemprop="datePublished">2025-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>@[toc]</p>
<p>修改记录</p>
<ul>
<li>2021.5.19 修改文章格式，在第三节添加了服务器的压缩文件 myweb.war. 添加项目仓库。</li>
</ul>
<h2 id="一，前言"><a href="#一，前言" class="headerlink" title="一，前言"></a>一，前言</h2><blockquote>
<p>之前写过一篇关于EMQX数据持久化到MySQL数据库，但由于这个功能需要EMQX企业版才能实现，而企业版的费用对于我这种学生党而言实在难以负担。于是，我在EMQX官方发现另一种方法也可以实现保存数据。<a target="_blank" rel="noopener" href="https://docs.emqx.io/tutorial/v3/cn/rule_engine/example.html">官网对于webhook的示例</a></p>
</blockquote>
<blockquote>
<p>预备知识：<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/breka/articles/9791664.html">http协议与格式</a><br>web服务器：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42857603/article/details/82857443">web项目基本结构</a><br>java语言<br>tomcat的安装：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/yocichen/p/10478431.html">window系统安装tomcat</a>，<a target="_blank" rel="noopener" href="https://www.cnblogs.com/xdp-gacl/p/4097608.html">linux系统安装tomcat</a><br>开发环境：<a target="_blank" rel="noopener" href="https://www.eclipse.org/downloads/">eclipse官网下载</a></p>
</blockquote>
<p><strong>思路：设备的数据上传到emqx服务器，我们需要一个web服务器来接收EMQX服务器post过来数据，然后再将数据保存到数据库。</strong><br><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20191124225507345.png"></p>
<h2 id="二，搭建基于tomcat的web服务器"><a href="#二，搭建基于tomcat的web服务器" class="headerlink" title="二，搭建基于tomcat的web服务器"></a>二，搭建基于tomcat的web服务器</h2><p>首先在主机安装tomcat和java jdk，这是搭建web服务器必须的环境。</p>
<p>具体的安装方法网上很多，找到适合自己的。这里只介绍搭建web服务器。</p>
<p><strong>已经搭建好环境的同学请跳过此步骤</strong></p>
<p>假设你已经完成以上的环境部署，还需要安装开发环境<code>eclipse</code>，再安装程序中选择安装eclipse ee，这是专门为web开发而设计的开发软件。</p>
<p>项目仓库地址：<a target="_blank" rel="noopener" href="https://gitee.com/killerp/emqx-web">https://gitee.com/killerp/emqx-web</a></p>
<blockquote>
<p><strong>打开eclipse，新建工程，选择Dynamic Web Project</strong></p>
<p><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/2019092521434592.png" alt="在这里插入图片描述"><br><strong>给项目取个名称，target runtime选择你主机安装的tomcat的版本，如果你是在云主机安装tomcat，建议在本地电脑也安装同一版本的tomcat，方便调试</strong></p>
<p><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925214452499.png" alt="在这里插入图片描述"><br><strong>接下来就一路next，最后这个页面记得勾选generate</strong></p>
</blockquote>
<p><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925214728645.png" alt="在这里插入图片描述"><br><strong>web.xml是配置web服务器的文件，java resources是放java文件的</strong><br><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925214939528.png" alt="在这里插入图片描述"><br>在下图lib文件夹下添加需要用到的库文件，然后把库文件真正导入项目<br>库文件百度网盘：</p>
<p><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1mK4Yyp6_DqBjxiW-pr0BhA">jsonobjectjar.zip下载</a> 提取码：l3rh</p>
<p><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1XPcJdrnDlmyXkKP5psF95Q">mysql-connector-java-5.1.28.jar下载</a> 提取码：nq3d </p>
<p><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925215235282.png" alt="在这里插入图片描述"></p>
<blockquote>
<p><strong>右击项目，选择properties，选择java build path ，点击add jars 找到你的项目lib里的库文件，全部添加进去，最后apply and close，导入库文件完成！</strong></p>
<p><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925215443641.png" alt="在这里插入图片描述"><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925215550210.png" alt="在这里插入图片描述"><br><strong>接下来编写一个Java 类，myhttpservlet，它继承自HttpServlet ，用来接收EMQX post过来的数据；</strong></p>
</blockquote>
<blockquote>
<p><strong>HttpServlet 是一个实现http协议的最重要的java类可以参考这篇博客 <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41007534/article/details/99696559">httpservlet详解</a></strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> myweb;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.Reader;</span><br><span class="line"><span class="keyword">import</span> java.io.StringWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.Writer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.http.fileupload.IOUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mysql.jdbc.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.oracle.webservices.internal.api.message.ContentType;</span><br><span class="line"><span class="keyword">import</span> com.sun.xml.internal.bind.CycleRecoverable.Context;</span><br><span class="line"><span class="keyword">import</span> com.sun.xml.internal.ws.wsdl.writer.document.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> net.sf.json.JSONArray;</span><br><span class="line"><span class="keyword">import</span> net.sf.json.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FirstServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">	<span class="comment">//用来读取post过来的json的缓存区的数据长度</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">BUFFER_SIZE</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">8</span>;</span><br><span class="line">	<span class="comment">//一些emqx post过来的数据</span></span><br><span class="line">	<span class="keyword">private</span> String app_id,device_id,remark,time,state,type;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 不知道是什么，反正是必须的</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//用来处理get消息</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">		<span class="comment">//doPost(request,response);</span></span><br><span class="line">		<span class="comment">//get请求用来获取数据库的数据</span></span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">		<span class="comment">//用来处理post消息</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">		<span class="comment">//获取post过来的输入流</span></span><br><span class="line">		InputStream in=request.getInputStream();</span><br><span class="line">		<span class="comment">//创建一个缓存读取器来暂时存贮输入流里的数据</span></span><br><span class="line">		<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(in));</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//body是json字符串，要解析字符串，拿到对应的值插入数据库</span></span><br><span class="line">		<span class="comment">//读取缓存读取器里的body数据并转为字符串格式，这里的body数据为json字符串格式</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> read(reader);</span><br><span class="line">		<span class="comment">//从json字符串里获取json对象</span></span><br><span class="line">		JSONObject J=JSONObject.fromObject(body);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//通过键值对的形式，获取json里的值并赋值给变量</span></span><br><span class="line">			app_id= J.getString(<span class="string">&quot;app_id&quot;</span>);</span><br><span class="line">		    </span><br><span class="line">			device_id=J.getString(<span class="string">&quot;device_id&quot;</span>);</span><br><span class="line">			time=J.getString(<span class="string">&quot;mytime&quot;</span>);</span><br><span class="line">			state=J.getString(<span class="string">&quot;state&quot;</span>);</span><br><span class="line">			type=J.getString(<span class="string">&quot;device_type&quot;</span>);</span><br><span class="line">			remark=J.getString(<span class="string">&quot;remark&quot;</span>);</span><br><span class="line">			</span><br><span class="line">		<span class="comment">//把变量的值保存到数据库</span></span><br><span class="line">		DBUutil.update(app_id,device_id,remark,time,state,type);</span><br><span class="line">		</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">read</span><span class="params">(Reader reader)</span> <span class="keyword">throws</span> IOException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">StringWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>();</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            write(reader, writer);</span><br><span class="line">            <span class="keyword">return</span> writer.getBuffer().toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span>&#123; writer.close(); &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">write</span><span class="params">(Reader reader, Writer writer)</span> <span class="keyword">throws</span> IOException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> write(reader, writer, BUFFER_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//把缓存器的json数据写入缓存区</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">write</span><span class="params">(Reader reader, Writer writer, <span class="type">int</span> bufferSize)</span> <span class="keyword">throws</span> IOException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> read;</span><br><span class="line">        <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">char</span>[] buf = <span class="keyword">new</span> <span class="title class_">char</span>[BUFFER_SIZE];</span><br><span class="line">        <span class="keyword">while</span>( ( read = reader.read(buf) ) != -<span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            writer.write(buf, <span class="number">0</span>, read);</span><br><span class="line">            total += read;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> total;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>再新建一个java 类，dbutil，这个类的作用是对数据库进行操作，这里只写了对数据库进行插入数据的操作，其他操作如更新，删除，查询都可实现</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> myweb;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mysql.jdbc.Connection;</span><br><span class="line"><span class="keyword">import</span> com.mysql.jdbc.log.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DBUutil</span> &#123;</span><br><span class="line">	<span class="keyword">static</span> List&lt;ESP8266&gt; ESPlist=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();<span class="comment">//����豸������</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ESP8266 Device=<span class="keyword">new</span> <span class="title class_">ESP8266</span>();<span class="comment">//��ʼ������</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">driver</span> <span class="operator">=</span> <span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>;<span class="comment">// MySql驱动</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> <span class="string">&quot;app&quot;</span>;<span class="comment">// MySQL的用户名和密码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">//连接数据库的方法</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Connection <span class="title function_">getConn</span><span class="params">(String dbName)</span>&#123;</span><br><span class="line">        Connection connection;</span><br><span class="line">         connection = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Class.forName(driver);<span class="comment">//加载驱动，需要驱动才能对数据库进行操作</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> <span class="string">&quot;118.31.20.121&quot;</span>;<span class="comment">//数据库的ip地址ַ</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//连接数据库，驱动+ip地址+端口号+用户名+密码，端口号默认是3306</span></span><br><span class="line">            connection = (Connection) DriverManager.getConnection(<span class="string">&quot;jdbc:mysql://&quot;</span> + ip + <span class="string">&quot;:3306/&quot;</span> + dbName,</span><br><span class="line">                    user, password);</span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        </span><br><span class="line">        &#125;</span><br><span class="line">        	<span class="comment">//返回一个connection对象</span></span><br><span class="line">        <span class="keyword">return</span> connection;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//这个是添加设备到数据库，不用看</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  <span class="keyword">void</span> <span class="title function_">bind_id</span><span class="params">(String app_id,String device_id)</span>&#123;</span><br><span class="line">    	</span><br><span class="line">             Connection connection=getConn(<span class="string">&quot;MQTTDATA&quot;</span>);</span><br><span class="line">        String sql=<span class="string">&quot;INSERT INTO user_bind_devices (app_id,device_id) VALUES (?,?)&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (connection!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                PreparedStatement ps=connection.prepareStatement(sql);</span><br><span class="line">                <span class="keyword">if</span> (ps!=<span class="literal">null</span>)&#123;</span><br><span class="line">                    ps.setString(<span class="number">1</span>,app_id);</span><br><span class="line">                    ps.setString(<span class="number">2</span>,device_id);</span><br><span class="line">                    <span class="comment">//执行语句,注意！！！如果你的SQL 语句是诸如update,insert的更新语句，应该用statement的execute()方法</span></span><br><span class="line">                    <span class="comment">// select用的是statement的executeQuery()</span></span><br><span class="line">                    ps.execute();</span><br><span class="line">                    </span><br><span class="line">                    connection.close();</span><br><span class="line">                    ps.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//这个是把数据保存到MQTTDATA库的 current表格</span></span><br><span class="line">    <span class="comment">//我需要插入app_id，device_id。。。。。。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(String app_id,String device_id,String remark,String time,String state,String device_type)</span> &#123;</span><br><span class="line">    	<span class="comment">//先跟MySQL数据库里的MQTTDATA库建立连接</span></span><br><span class="line">    	Connection connection=getConn(<span class="string">&quot;MQTTDATA&quot;</span>);</span><br><span class="line">    	<span class="comment">//定义一个语句，这个语句的功能是对current表格的app_id,device_id,remark,mytime,state,device_type列分别插入我们的参数的值</span></span><br><span class="line">    	<span class="comment">//这里的？可以看成一个傀儡，用ps.setString()方法可以将？替换成我们的参数的值</span></span><br><span class="line">    	String sql=<span class="string">&quot;INSERT INTO current (app_id,device_id,remark,mytime,state,device_type) VALUES (?,?,?,?,?,?)&quot;</span>;</span><br><span class="line">    	<span class="keyword">if</span>	(connection!=<span class="literal">null</span>) &#123;</span><br><span class="line">    		<span class="keyword">try</span> &#123;</span><br><span class="line">    			<span class="comment">//准备我们的mysql操作语句</span></span><br><span class="line">				PreparedStatement ps=connection.prepareStatement(sql);</span><br><span class="line">				<span class="comment">//把第一个？替换成参数里的app_id,第二个？替换成device_id........</span></span><br><span class="line">				<span class="keyword">if</span>(ps!=<span class="literal">null</span>) &#123;</span><br><span class="line">					ps.setString(<span class="number">1</span>, app_id);</span><br><span class="line">					ps.setString(<span class="number">2</span>, device_id);</span><br><span class="line">					ps.setString(<span class="number">3</span>, remark);</span><br><span class="line">					ps.setString(<span class="number">4</span>, time);</span><br><span class="line">					ps.setString(<span class="number">5</span>, state);</span><br><span class="line">					ps.setString(<span class="number">6</span>, device_type);</span><br><span class="line">					ps.execute();</span><br><span class="line">					connection.close();</span><br><span class="line">					ps.close();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>前面说了web.xml是web服务器的配置文件，这里我们需要在web.xml里对myhttpservlet进行配置</strong></p>
<p>在web.xml添加<servlet>内容如下: (这里需要注意一下，<servlet-name>app</servlet-name>，名称可以随便取，主要是为了程序员方便查找。)</p>
<p>&lt; servlet-class &gt;myweb.myhttpservlet&lt;&#x2F; servlet-class &gt; 前面是你的项目名称   .后面是我们刚刚写的myhttpservlet类。</p>
<p>&lt; servlet-mapping &gt;是把名称为app的httpservlet类映射到url的一个路径，<url-pattern>&#x2F;first</url-pattern>的意思就是当你在浏览器输入: </p>
<blockquote>
<p><strong>http:&#x2F;&#x2F;你的web服务器ip地址:端口号&#x2F;first   就会执行myhttpservlet类里的内容。</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;web-app xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> xmlns=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span> xsi:schemaLocation=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&quot;</span> id=<span class="string">&quot;WebApp_ID&quot;</span> version=<span class="string">&quot;3.1&quot;</span>&gt;</span><br><span class="line">  &lt;display-name&gt;myweb1&lt;/display-name&gt;</span><br><span class="line">  &lt;welcome-file-list&gt;</span><br><span class="line">    &lt;welcome-file&gt;index.html&lt;/welcome-file&gt;</span><br><span class="line">    &lt;welcome-file&gt;index.htm&lt;/welcome-file&gt;</span><br><span class="line">    &lt;welcome-file&gt;index.jsp&lt;/welcome-file&gt;</span><br><span class="line">    &lt;welcome-file&gt;<span class="keyword">default</span>.html&lt;/welcome-file&gt;</span><br><span class="line">    &lt;welcome-file&gt;<span class="keyword">default</span>.htm&lt;/welcome-file&gt;</span><br><span class="line">    &lt;welcome-file&gt;<span class="keyword">default</span>.jsp&lt;/welcome-file&gt;</span><br><span class="line">  &lt;/welcome-file-list&gt;</span><br><span class="line">  &lt;servlet&gt;</span><br><span class="line">        &lt;servlet-name&gt;app&lt;/servlet-name&gt;</span><br><span class="line">        &lt;servlet-class&gt;myweb.myhttpservlet&lt;/servlet-class&gt;</span><br><span class="line">&lt;/servlet&gt;</span><br><span class="line">	</span><br><span class="line">&lt;servlet-mapping&gt;</span><br><span class="line">        &lt;servlet-name&gt;app&lt;/servlet-name&gt;</span><br><span class="line">        &lt;url-pattern&gt;/first&lt;/url-pattern&gt;</span><br><span class="line">&lt;/servlet-mapping&gt;</span><br><span class="line">&lt;/web-app&gt;</span><br></pre></td></tr></table></figure>

<h2 id="三，部署web服务器到主机上"><a href="#三，部署web服务器到主机上" class="headerlink" title="三，部署web服务器到主机上"></a>三，部署web服务器到主机上</h2><p><strong>至此，我们一个简陋的web服务器差不多搭建好了，这时候我们就需要把web程序部署到主机的tomcat上。</strong></p>
<p>本地部署：右击项目，选择export &gt; war file browse保存到你想保存的位置，系统会生成一个.war文件，我们把这个文件放进 apache-tomcat-8.5.45(你的tomcat文件夹)下的webapps文件夹下。</p>
<p><strong>压缩文件已上传百度云，仅供参考</strong><br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1Klr_gDvmyFwwtqq3zUowww">https://pan.baidu.com/s/1Klr_gDvmyFwwtqq3zUowww</a><br>提取码：spf3 </p>
<p><strong>远程云主机部署：用xftp将war文件放入同样的路径下，然后重新启动tomcat。</strong></p>
<p>tomcat在运行时会自动解压war文件生成web程序并开始执行<br><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925223226631.png" alt="在这里插入图片描述"><br><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925223348324.png" alt="在这里插入图片描述"></p>
<h2 id="四，配置EMQX服务器"><a href="#四，配置EMQX服务器" class="headerlink" title="四，配置EMQX服务器"></a>四，配置EMQX服务器</h2><p><strong>配置的目的：让 EMQX 服务器post数据 给web服务器；</strong></p>
<h3 id="4-1-设置规则引擎"><a href="#4-1-设置规则引擎" class="headerlink" title="4.1 设置规则引擎"></a>4.1 设置规则引擎</h3><p><strong>登录emqx远程控制台，在规则引擎新建规则，规则引擎会对mqtt消息进行筛选，具体的筛选规则由我们来定义，下图是一些规则示例</strong><br><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925223940966.png" alt="在这里插入图片描述"><br>以下图的例子分析：</p>
<p><code>SELECT</code> 下方的语句含义是 ：<strong>在mqtt消息的数据段（payload）中提取出remark，app_id，device_id变量的值 复制 到本地的remark，app_id，device_id变量中。</strong></p>
<p><code>WHERE</code> 语句表示 从发往主题为<code>csdn</code>的mqtt消息中筛选。</p>
<p>随后我们用post把数据发送给web服务器时，数据的格式设置为<strong>json格式{“remark”:”杀手”,”app_id”:”37264726374”}</strong><br><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925224223760.png" alt="在这里插入图片描述"></p>
<h3 id="4-2-测试规则引擎"><a href="#4-2-测试规则引擎" class="headerlink" title="4.2 测试规则引擎"></a>4.2 测试规则引擎</h3><p>我们还可以进行在线测试，测试输出的json数据是不是我们需要的内容。</p>
<p><strong>下图配置mqtt消息：topic设置为csdn，payload字段设置变量及其取值。</strong><br><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925230352836.png" alt="在这里插入图片描述"></p>
<p><strong>点击测试，输出如图的json数据：</strong><br><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925230438153.png" alt="在这里插入图片描述"></p>
<h3 id="4-3-设置响应动作"><a href="#4-3-设置响应动作" class="headerlink" title="4.3 设置响应动作"></a>4.3 设置响应动作</h3><p><strong>当规则引擎筛选出指定的mqtt消息并提取出json数据后，还需要将数据post到我们的web服务器，这需要设置响应动作来完成这最后一步。</strong></p>
<blockquote>
<p>点击添加，动作选择发送数据到web服务,点击新建资源</p>
<p><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925230623970.png" alt="在这里插入图片描述"><br>在资源管理中设置 请求url 为web服务器地址，端口号（tomcat默认端口为8888，这里我改成8090），加上前面我们web.xml里设置的&#x2F;first ; http请求就会发送到我们的web程序。</p>
</blockquote>
<p><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925230844728.png" alt="在这里插入图片描述"><br>最后，我们需要进行测试，进入websocket，连接，发布消息到指定主题<br><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925231413679.png" alt="在这里插入图片描述"><br>然后到你的数据库查看是否存贮到数据。</p>
<p>有疑问的同学可以留言评论。<br><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20200614084955388.png" alt="在这里插入图片描述"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/06/01/killer-blog/Web/EMQX_webhook_route_msg/" data-id="cmbcy7rhe0022t8mt2pl89rzr" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2025/06/01/killer-blog/Web/EMQX_rule_engine/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2025/06/01/killer-blog/Web/Java_web_server_connect_mySQL/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">June 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">May 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/pwm/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/uart/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/worklife/2025%E6%B1%82%E8%81%8C%E5%87%86%E5%A4%87/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/other/tools/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/i2c_LSM303AGR/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>