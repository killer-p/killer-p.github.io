<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/12/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-killer-blog/Linux/systemd_WIFI_auto_reconnect" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/05/31/killer-blog/Linux/systemd_WIFI_auto_reconnect/" class="article-date">
  <time class="dt-published" datetime="2025-05-31T17:16:20.236Z" itemprop="datePublished">2025-05-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>@[toc]</p>
<blockquote>
<p>本文在<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44821644/article/details/121095406">systemd简介</a>基础上，利用systemd提供的服务实现WIFI连接的管理</p>
</blockquote>
<h2 id="1、编辑wifi重连服务"><a href="#1、编辑wifi重连服务" class="headerlink" title="1、编辑wifi重连服务"></a>1、编辑wifi重连服务</h2><p>在&#x2F;etc&#x2F;systemd&#x2F;system目录下，创建wifi_relink.service，并在文件中输入以下内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Unit] </span><br><span class="line">Description=Wifi relink service </span><br><span class="line">After=storage-gadget-init.service </span><br><span class="line"></span><br><span class="line">[Service] Type=simple </span><br><span class="line">RemainAfterExit=<span class="built_in">yes</span> </span><br><span class="line">ExecStart=/usr/bin/relink3220.sh </span><br><span class="line"></span><br><span class="line">[Install] </span><br><span class="line">WantedBy=basic.target</span><br></pre></td></tr></table></figure>

<p>wifi重连服务在系统的存储服务启动后启动，执行脚本为&#x2F;usr&#x2F;bin&#x2F;relink3220.sh，并被添加到basic.target目标下，说明开机自启动。</p>
<h2 id="2、编辑wifi重连脚本"><a href="#2、编辑wifi重连脚本" class="headerlink" title="2、编辑wifi重连脚本"></a>2、编辑wifi重连脚本</h2><p>创建&#x2F;usr&#x2F;bin&#x2F;relink3220.sh文件，内容如下：</p>
<ol>
<li>首先检测wifi模块是否插入到板卡上，并查看wifi模块的型号，根据型号（WIFI5-&gt;2b42; WIFI6→2b43）加载对应的驱动。</li>
<li>检查网口是否使能（up）</li>
<li>检查wpa配置文件是否存在</li>
<li>读取wifi连接状态，ip地址信息；</li>
<li>进入状态机，若wifi已连接，则判断是否拿到ip，调用udhcpc获取ip；若wifi正在扫描，则跳过；若wifi断开，则调用wpa进行连接。</li>
</ol>
<p>该脚本每5秒执行一次。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh 	 </span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span> <span class="built_in">sleep</span> 5  </span><br><span class="line">	<span class="comment">#check wifi module type and load the driver </span></span><br><span class="line">	wifi_module_type=`lspci | grep <span class="string">&quot;01:00.0 Ethernet controller: Marvell Technology Group Ltd.&quot;</span> | awk &#123;<span class="string">&#x27;print $9&#x27;</span>&#125;`  </span><br><span class="line">	</span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$wifi_module_type</span> <span class="keyword">in</span> </span><br><span class="line">	2b42)  </span><br><span class="line">        mlan=`lsmod | grep mlan` </span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">&quot;x<span class="variable">$mlan</span>&quot;</span>==<span class="string">&quot;x&quot;</span> ];<span class="keyword">then</span> 	</span><br><span class="line">	        modprobe mlan 	</span><br><span class="line">	        <span class="built_in">sleep</span> 1 	</span><br><span class="line">	        modprobe moal drv_mode=1 ps_mode=2 auto_ds=2 cfg80211_wext=0xf cal_data_cfg=none fw_name=nxp/pcieuart8997_combo_v4.bin 	</span><br><span class="line">	        <span class="built_in">sleep</span> 5 </span><br><span class="line">	    <span class="keyword">fi</span> </span><br><span class="line">    ;;  </span><br><span class="line">    2b43)  </span><br><span class="line">        mlan_wifi6=`lsmod | grep mlan_wifi6` </span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">&quot;x<span class="variable">$mlan_wifi6</span>&quot;</span>==<span class="string">&quot;x&quot;</span> ];<span class="keyword">then</span> 	</span><br><span class="line">            modprobe mlan_wifi6 	</span><br><span class="line">            <span class="built_in">sleep</span> 1 	</span><br><span class="line">            modprobe moal_wifi6 drv_mode=1 ps_mode=2 auto_ds=2 cfg80211_wext=0xf cal_data_cfg=none fw_name=nxp/pcieuart9098_combo_v1.bin 	</span><br><span class="line">            <span class="built_in">sleep</span> 5 </span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">    ;;  </span><br><span class="line">    *) </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;relink3220.sh:error undefined module types&quot;</span> </span><br><span class="line">    ;;  </span><br><span class="line">    <span class="keyword">esac</span>  </span><br><span class="line">    <span class="comment">#check mlan0 is ON </span></span><br><span class="line">    mlan_status=`ifconfig |grep mlan0 | awk &#123;<span class="string">&#x27;print $1&#x27;</span>&#125;` </span><br><span class="line">    <span class="comment">#echo &quot;[ADV] $mlan_status&quot; </span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;x<span class="variable">$mlan_status</span>&quot;</span> == <span class="string">&quot;x&quot;</span> ];<span class="keyword">then</span> 	</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;please waiting for mlan0 up...&quot;</span> 	</span><br><span class="line">        ifconfig mlan0 up </span><br><span class="line">    <span class="keyword">fi</span>   </span><br><span class="line">    <span class="comment">#check wifi is configured (if file wpa.conf exist) </span></span><br><span class="line">    <span class="keyword">if</span> [ ! -f <span class="string">&quot;/etc/wpa_supplicant.conf&quot;</span> ];<span class="keyword">then</span> 	</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Not find wifi config file&quot;</span> 	</span><br><span class="line">        <span class="built_in">continue</span> </span><br><span class="line">    <span class="keyword">fi</span>  </span><br><span class="line">    <span class="comment">#check wifi is connect </span></span><br><span class="line">    wifi_status=`wpa_cli -i mlan0 status |grep wpa_state |<span class="built_in">cut</span> -d <span class="string">&quot;=&quot;</span> -f2` </span><br><span class="line">    ip_address=`wpa_cli -i mlan0 status  |grep ip_address |<span class="built_in">cut</span> -d <span class="string">&quot;=&quot;</span> -f2`  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$wifi_status</span> <span class="keyword">in</span> </span><br><span class="line">    COMPLETED) </span><br><span class="line">        <span class="comment">#check if get ip  </span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">&quot;x<span class="variable">$ip_address</span>&quot;</span>==<span class="string">&quot;x&quot;</span> ];<span class="keyword">then</span> 	</span><br><span class="line">            udhcpc_pid_list=`ps -aux | grep udhcpc |grep mlan0 | awk &#123;<span class="string">&#x27;print $2&#x27;</span>&#125;` 	</span><br><span class="line">            <span class="keyword">if</span> [ <span class="string">&quot;x<span class="variable">$udhcpc_pid_list</span>&quot;</span> == <span class="string">&quot;x&quot;</span> ];<span class="keyword">then</span> 		</span><br><span class="line">                <span class="keyword">for</span>(( i=<span class="number">0</span>;i&lt;<span class="variable">$&#123;#udhcpc_pid_list[@]&#125;</span>;i++)) <span class="keyword">do</span> 			</span><br><span class="line">                    <span class="built_in">kill</span> <span class="variable">$&#123;udhcpc_pid_list[i]&#125;</span>; 			</span><br><span class="line">                    <span class="built_in">echo</span>  <span class="string">&quot;[ADV] kill <span class="variable">$&#123;udhcpc_pid_list[i]&#125;</span>&quot;</span> 		</span><br><span class="line">                <span class="keyword">done</span> 	</span><br><span class="line">            <span class="keyword">fi</span> 	</span><br><span class="line">            udhcpc -i mlan0 	</span><br><span class="line">            <span class="built_in">sleep</span> 10 </span><br><span class="line">        <span class="keyword">else</span> 	</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;getip:<span class="variable">$&#123;ip_address&#125;</span>&quot;</span> </span><br><span class="line">        <span class="keyword">fi</span>  </span><br><span class="line">    ;; </span><br><span class="line">        </span><br><span class="line">    SCANNING) </span><br><span class="line">    ;; </span><br><span class="line">    </span><br><span class="line">    *) </span><br><span class="line">        killall wpa_supplicant </span><br><span class="line">        wpa_supplicant -d -B -i mlan0 -c /etc/wpa_supplicant.conf -Dnl80211 </span><br><span class="line">    ;;        </span><br><span class="line">    <span class="keyword">esac</span> </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>



<h2 id="3、修改wifi配置"><a href="#3、修改wifi配置" class="headerlink" title="3、修改wifi配置"></a>3、修改wifi配置</h2><p>系统运行中若需要修改wifi连接信息，可直接修改&#x2F;etc&#x2F;wpa_supplicant.conf文件，并重新启动wifi重连服务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@imx8mprsb3720a1:/usr/bin# <span class="built_in">cat</span> /etc/wpa_supplicant.conf  </span><br><span class="line">ctrl_interface=/var/run/wpa_supplicant </span><br><span class="line">ctrl_interface_group=0 </span><br><span class="line">update_config=1 </span><br><span class="line">network=&#123; ssid=<span class="string">&quot;Advantecher&quot;</span> psk=<span class="string">&quot;Advantech@1983&quot;</span>&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart wifi_relink.sh</span><br></pre></td></tr></table></figure>

<h3 id="network设置"><a href="#network设置" class="headerlink" title="network设置"></a>network设置</h3><p><strong>systemd-networkd.service</strong> 是用于管理网络的系统服务。</p>
<p> 它能够检测并配置网络连接，&#x2F;etc&#x2F;systemd&#x2F;network目录下存放了网口的配置文件。网络设备的Network文件必须以 <code>.network</code> 作为后缀名，否则将被忽略。 一旦与Network文件匹配的网卡出现，对应的Network文件就会立即生效。</p>
<p>本文使用network分别配置eth0、eh1、mlan0的ip信息，并通过路由跳数设置网口的优先级。跳数越少，优先级越高。以下例子中eth0优先级最高、其次是eth1、最后是mlan0.</p>
<p><strong>若要修改网口的优先级，只需要修改下面的配置文件中的metric的数值，并重启systemd-networkd服务：（要设置PPP拨号最高优先级，可将其他网口的优先级调低）</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart systemd-networkd</span><br></pre></td></tr></table></figure>





<p>eth0：配置为静态网口，固定ip地址为192.168.0.1，所在网络为192.168.0.0&#x2F;24，路由条数为150</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Match]    </span><br><span class="line">Name=eth0        </span><br><span class="line">KernelCommandLine=!root=/dev/nfs </span><br><span class="line"></span><br><span class="line">[Link] </span><br><span class="line">RequiredForOnline=no </span><br><span class="line"></span><br><span class="line">[Network]    </span><br><span class="line">DHCP=no    </span><br><span class="line">Address=192.168.0.1/24    </span><br><span class="line">DNS=8.8.8.8    </span><br><span class="line">DNS=114.114.114.114    </span><br><span class="line"></span><br><span class="line">[Route]        </span><br><span class="line">Gateway=192.168.0.254        </span><br><span class="line">Metric=150</span><br></pre></td></tr></table></figure>



<p>eth1：配置为动态网口，ip地址通过dhcp协议获取，并设置dns服务器地址，路由跳数为200</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Match]    </span><br><span class="line">Name=eth1        </span><br><span class="line">KernelCommandLine=!root=/dev/nfs </span><br><span class="line"></span><br><span class="line">[Link] </span><br><span class="line">RequiredForOnline=no </span><br><span class="line"></span><br><span class="line">[Network]    </span><br><span class="line">DHCP=<span class="built_in">yes</span>    </span><br><span class="line">DNS=8.8.8.8    </span><br><span class="line">DNS=114.114.114.114     </span><br><span class="line"></span><br><span class="line">[DHCP]        </span><br><span class="line">RouteMetric=200</span><br></pre></td></tr></table></figure>



<p>mlan0：wifi连接后生成的网口，同样使用DHCPC获取动态ip地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Match]    </span><br><span class="line">Name=mlan0        </span><br><span class="line">KernelCommandLine=!root=/dev/nfs </span><br><span class="line">[Link] RequiredForOnline=no </span><br><span class="line">[Network]    </span><br><span class="line">DHCP=<span class="built_in">yes</span>    </span><br><span class="line">DNS=8.8.8.8    </span><br><span class="line">DNS=114.114.114.114     </span><br><span class="line"></span><br><span class="line">[DHCP]        </span><br><span class="line">RouteMetric=300</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/05/31/killer-blog/Linux/systemd_WIFI_auto_reconnect/" data-id="cmbcy7rh8001it8mt1pqe8orc" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-killer-blog/Linux/uboot_1" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/05/31/killer-blog/Linux/uboot_1/" class="article-date">
  <time class="dt-published" datetime="2025-05-31T17:16:20.236Z" itemprop="datePublished">2025-05-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="uboot启动流程"><a href="#uboot启动流程" class="headerlink" title="uboot启动流程"></a>uboot启动流程</h3><p>我将uboot分为两个部分：建立运行环境、执行uboot命令。</p>
<p>第一部分可分为四个阶段：</p>
<ul>
<li>reset中断：关闭中断、进入SVC模式、设置CP15协处理器，为内存管理做准备。</li>
<li>board_init_f()：为重定位做准备，初始化日志、串口、i2c、spi、DRAM初始化、预留地址空间、确定重定位地址</li>
<li>uboot代码重定位</li>
<li>board_init_r():建立完善的uboot运行环境，能执行uboot命令</li>
</ul>
<p>编译uboot后再根目录出现了u-boot.lds,可见程序入口在arch&#x2F;arm&#x2F;cpu&#x2F;armv7&#x2F;start.o</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">OUTPUT_FORMAT(<span class="string">&quot;elf32-littlearm&quot;</span>, <span class="string">&quot;elf32-littlearm&quot;</span>, <span class="string">&quot;elf32-littlearm&quot;</span>)</span><br><span class="line">OUTPUT_ARCH(arm)</span><br><span class="line">ENTRY(_start)	<span class="comment">#程序入口地址</span></span><br><span class="line"><span class="comment">#输出文件组织结构</span></span><br><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line"> . = 0x4A000000;	<span class="comment"># .是一个定位变量，表示当前的地址，这里表示当前地址4a000000</span></span><br><span class="line"> . = ALIGN(4);		<span class="comment"># 四字节对齐</span></span><br><span class="line"> .<span class="built_in">head</span> :			<span class="comment"># 定义head段</span></span><br><span class="line"> &#123;</span><br><span class="line">  *(.__image_copy_start)	<span class="comment">#所有__image_copy_start段</span></span><br><span class="line">  <span class="built_in">arch</span>/arm/cpu/armv7/spare_head.o (.data*)	</span><br><span class="line"> &#125;</span><br><span class="line"> .text :			<span class="comment"># 定义text段，即代码段</span></span><br><span class="line"> &#123;</span><br><span class="line">  *(.vectors)		<span class="comment">#异常向量表段</span></span><br><span class="line">  <span class="built_in">arch</span>/arm/cpu/armv7/start.o (.text*)	<span class="comment">#起始的汇编代码</span></span><br><span class="line">  *(.text*)			<span class="comment">#所有其他代码段</span></span><br><span class="line"> &#125;</span><br><span class="line"> . = ALIGN(4);</span><br><span class="line"> .rodata : &#123; *(SORT_BY_ALIGNMENT(SORT_BY_NAME(.rodata*))) &#125;	<span class="comment">#所有只读数据段</span></span><br><span class="line"> . = ALIGN(4);</span><br><span class="line"> .data : &#123;			<span class="comment">#数据段 （全局变量）</span></span><br><span class="line">  *(.data*)</span><br><span class="line"> &#125;</span><br><span class="line"> . = ALIGN(4);</span><br><span class="line"> . = .;</span><br><span class="line"> . = ALIGN(4);</span><br><span class="line"> .u_boot_list : &#123;	<span class="comment">#uboot list段是干啥的</span></span><br><span class="line">  KEEP(*(SORT(.u_boot_list*)));</span><br><span class="line"> &#125;</span><br><span class="line"> . = ALIGN(4);</span><br><span class="line"> .__efi_runtime_start : &#123;	</span><br><span class="line">  *(.__efi_runtime_start)</span><br><span class="line"> &#125;</span><br><span class="line"> .efi_runtime : &#123;			<span class="comment">#efi_runtime是干啥</span></span><br><span class="line">  *(efi_runtime_text)</span><br><span class="line">  *(efi_runtime_data)</span><br><span class="line"> &#125;</span><br><span class="line"> .__efi_runtime_stop : &#123;	</span><br><span class="line">  *(.__efi_runtime_stop)</span><br><span class="line"> &#125;</span><br><span class="line"> .efi_runtime_rel_start :	</span><br><span class="line"> &#123;</span><br><span class="line">  *(.__efi_runtime_rel_start)</span><br><span class="line"> &#125;</span><br><span class="line"> .efi_runtime_rel : &#123;		<span class="comment">#efi_runtime_rel是干啥</span></span><br><span class="line">  *(.relefi_runtime_text)</span><br><span class="line">  *(.relefi_runtime_data)</span><br><span class="line"> &#125;</span><br><span class="line"> .efi_runtime_rel_stop :</span><br><span class="line"> &#123;</span><br><span class="line">  *(.__efi_runtime_rel_stop)</span><br><span class="line"> &#125;</span><br><span class="line"> . = ALIGN(4);</span><br><span class="line"> .image_copy_end :		<span class="comment">#image_copy_end是干啥</span></span><br><span class="line"> &#123;</span><br><span class="line">  *(.__image_copy_end)</span><br><span class="line"> &#125;</span><br><span class="line"> .rel_dyn_start :		<span class="comment">#rel_dyn是干啥</span></span><br><span class="line"> &#123;</span><br><span class="line">  *(.__rel_dyn_start)</span><br><span class="line"> &#125;</span><br><span class="line"> .rel.dyn : &#123;</span><br><span class="line">  *(.rel*)</span><br><span class="line"> &#125;</span><br><span class="line"> .rel_dyn_end :</span><br><span class="line"> &#123;</span><br><span class="line">  *(.__rel_dyn_end)</span><br><span class="line"> &#125;</span><br><span class="line"> .end :					<span class="comment">#end段</span></span><br><span class="line"> &#123;</span><br><span class="line">  *(.__end)</span><br><span class="line"> &#125;</span><br><span class="line"> _image_binary_end = .;</span><br><span class="line"> ASSERT(. &lt; 0x4A000000 + 0x100000, <span class="string">&quot;uboot size exceeds size limit&quot;</span>)	<span class="comment">#uboot大小超过限制</span></span><br><span class="line"> . = ALIGN(4096);</span><br><span class="line"> .mmutable : &#123;			<span class="comment">#mmu表格：页表</span></span><br><span class="line">  *(.mmutable)</span><br><span class="line"> &#125;</span><br><span class="line"> .bss_start __rel_dyn_start (OVERLAY) : &#123;	<span class="comment">#bss段？</span></span><br><span class="line">  KEEP(*(.__bss_start));</span><br><span class="line">  __bss_base = .;</span><br><span class="line"> &#125;</span><br><span class="line"> .bss __bss_base (OVERLAY) : &#123;</span><br><span class="line">  *(.bss*)</span><br><span class="line">   . = ALIGN(4);</span><br><span class="line">   __bss_limit = .;</span><br><span class="line"> &#125;</span><br><span class="line"> .bss_end __bss_limit (OVERLAY) : &#123;</span><br><span class="line">  KEEP(*(.__bss_end));</span><br><span class="line"> &#125;</span><br><span class="line"> .dynsym _image_binary_end : &#123; *(.dynsym) &#125;</span><br><span class="line"> .dynbss : &#123; *(.dynbss) &#125;</span><br><span class="line"> .dynstr : &#123; *(.dynstr*) &#125;</span><br><span class="line"> .dynamic : &#123; *(.dynamic*) &#125;</span><br><span class="line"> .plt : &#123; *(.plt*) &#125;</span><br><span class="line"> .interp : &#123; *(.interp*) &#125;</span><br><span class="line"> .gnu.hash : &#123; *(.gnu.hash) &#125;</span><br><span class="line"> .gnu : &#123; *(.gnu*) &#125;</span><br><span class="line"> .ARM.exidx : &#123; *(.ARM.exidx*) &#125;</span><br><span class="line"> .gnu.linkonce.armexidx : &#123; *(.gnu.linkonce.armexidx.*) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="vectors-S-定义中断向量表"><a href="#vectors-S-定义中断向量表" class="headerlink" title="vectors.S 定义中断向量表"></a>vectors.S 定义中断向量表</h4><p>通过全局查找找到_start的内容：arm&#x2F;lib&#x2F;vectors.S 主要的工作就是定义中断向量表的内容。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br></pre></td><td class="code"><pre><span class="line">panrunxins@AwExdroid100:~/longan/brandy/brandy<span class="number">-2.0</span>/u-boot<span class="number">-2018</span>/arch$ cat arm/lib/vectors.S</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;config.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * A macro to allow insertion of an ARM exception vector either</span></span><br><span class="line"><span class="comment"> * for the non-boot0 case or by a boot0-header.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        .macro ARM_VECTORS</span><br><span class="line">        b       reset</span><br><span class="line">        ldr     pc, _undefined_instruction</span><br><span class="line">        ldr     pc, _software_interrupt</span><br><span class="line">        ldr     pc, _prefetch_abort</span><br><span class="line">        ldr     pc, _data_abort</span><br><span class="line">        ldr     pc, _not_used</span><br><span class="line">        ldr     pc, _irq</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    aswcac</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        ldr     pc, _fiq</span><br><span class="line">        .endm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.globl _start	<span class="comment">//指定_start为全局变量，所以连接器才能使用他</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Vectors have their own section so linker script can map them easily</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">        .section <span class="string">&quot;.vectors&quot;</span>, <span class="string">&quot;ax&quot;</span>	<span class="comment">//_start位于.vectors段内</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_ENABLE_ARM_SOC_BOOT0_HOOK)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Various SoCs need something special and SoC-specific up front in</span></span><br><span class="line"><span class="comment"> * order to boot, allow them to set that in their boot0.h file and then</span></span><br><span class="line"><span class="comment"> * use it here.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * To allow a boot0 hook to insert a &#x27;special&#x27; sequence after the vector</span></span><br><span class="line"><span class="comment"> * table (e.g. for the socfpga), the presence of a boot0 hook supresses</span></span><br><span class="line"><span class="comment"> * the below vector table and assumes that the vector table is filled in</span></span><br><span class="line"><span class="comment"> * by the boot0 hook.  The requirements for a boot0 hook thus are:</span></span><br><span class="line"><span class="comment"> *   (1) defines &#x27;_start:&#x27; as appropriate</span></span><br><span class="line"><span class="comment"> *   (2) inserts the vector table using ARM_VECTORS as appropriate</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/arch/boot0.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Exception vectors as described in ARM reference manuals</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Uses indirect branch to allow reaching handlers anywhere in memory.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYS_DV_NOR_BOOT_CFG</span></span><br><span class="line">        .word   CONFIG_SYS_DV_NOR_BOOT_CFG</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        ARM_VECTORS	</span><br><span class="line">        <span class="comment">//ARM_VECTORS就是中断向量表，将宏展开如下：</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">  	    b       reset							#跳转到reset</span></span><br><span class="line"><span class="comment">        ldr     pc, _undefined_instruction		  #跳转向量表中的地址</span></span><br><span class="line"><span class="comment">        ldr     pc, _software_interrupt</span></span><br><span class="line"><span class="comment">        ldr     pc, _prefetch_abort</span></span><br><span class="line"><span class="comment">        ldr     pc, _data_abort</span></span><br><span class="line"><span class="comment">        ldr     pc, _not_used</span></span><br><span class="line"><span class="comment">        ldr     pc, _irq</span></span><br><span class="line"><span class="comment">        ldr     pc, _fiq</span></span><br><span class="line"><span class="comment">  		*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* !defined(CONFIG_ENABLE_ARM_SOC_BOOT0_HOOK) */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Indirect vectors table</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Symbols referenced here must be defined somewhere else</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">		<span class="comment">// 声明中断向量表中的地址为全局变量</span></span><br><span class="line">        .globl  _undefined_instruction</span><br><span class="line">        .globl  _software_interrupt</span><br><span class="line">        .globl  _prefetch_abort</span><br><span class="line">        .globl  _data_abort</span><br><span class="line">        .globl  _not_used</span><br><span class="line">        .globl  _irq</span><br><span class="line">        .globl  _fiq</span><br><span class="line"><span class="comment">// 声明了地址的大小</span></span><br><span class="line">_undefined_instruction: .word undefined_instruction</span><br><span class="line">_software_interrupt:    .word software_interrupt</span><br><span class="line">_prefetch_abort:        .word prefetch_abort</span><br><span class="line">_data_abort:            .word data_abort</span><br><span class="line">_not_used:              .word not_used</span><br><span class="line">_irq:                   .word irq</span><br><span class="line">_fiq:                   .word fiq</span><br><span class="line"></span><br><span class="line">        .balignl <span class="number">16</span>,<span class="number">0xdeadbeef</span>	<span class="comment">//地址对齐</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Interrupt handling</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* SPL interrupt handling: just hang */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SPL_BUILD</span></span><br><span class="line"></span><br><span class="line">        .align  <span class="number">5</span></span><br><span class="line">undefined_instruction:</span><br><span class="line">software_interrupt:</span><br><span class="line">prefetch_abort:</span><br><span class="line">data_abort:</span><br><span class="line">not_used:</span><br><span class="line">irq:</span><br><span class="line">fiq:</span><br><span class="line"><span class="number">1</span>:</span><br><span class="line">        bl      <span class="number">1b</span>                      <span class="comment">/* hang and never return */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span>   <span class="comment">/* !CONFIG_SPL_BUILD */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* IRQ stack memory (calculated at run-time) + 8 bytes */</span></span><br><span class="line">.globl IRQ_STACK_START_IN			<span class="comment">//指针，指向栈的起始地址 </span></span><br><span class="line">IRQ_STACK_START_IN:</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> IRAM_BASE_ADDR</span></span><br><span class="line">        .word   IRAM_BASE_ADDR + <span class="number">0x20</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        .word   <span class="number">0x0badc0de</span>			<span class="comment">//IRQ_STACK_START_IN的值是0x0badc0de</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* IRQ stack memory (calculated at run-time) */</span></span><br><span class="line">.globl IRQ_STACK_START				<span class="comment">//栈的起始地址</span></span><br><span class="line">IRQ_STACK_START:				</span><br><span class="line">        .word   <span class="number">0x0badc0de</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* IRQ stack memory (calculated at run-time) */</span></span><br><span class="line">.globl FIQ_STACK_START					</span><br><span class="line">FIQ_STACK_START:</span><br><span class="line">        .word <span class="number">0x0badc0de</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@</span><br><span class="line">@ IRQ <span class="built_in">stack</span> frame.</span><br><span class="line">@</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_FRAME_SIZE    72</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_OLD_R0        68</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_PSR           64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_PC            60</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_LR            56</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_SP            52</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_IP            48</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_FP            44</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R10           40</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R9            36</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R8            32</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R7            28</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R6            24</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R5            20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R4            16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R3            12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R2            8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R1            4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_R0            0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODE_SVC 0x13</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> I_BIT    0x80</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * use bad_save_user_regs for abort/prefetch/undef/swi ...</span></span><br><span class="line"><span class="comment"> * use irq_save_user_regs / irq_restore_user_regs for IRQ/FIQ handling</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">        .macro  bad_save_user_regs	</span><br><span class="line">        @ carve out a frame on current user <span class="built_in">stack</span></span><br><span class="line">        sub     sp, sp, #S_FRAME_SIZE     <span class="comment">//sp = sp - 72</span></span><br><span class="line">        stmia   sp, &#123;r0 - r12&#125;  @ Save user <span class="title function_">registers</span> <span class="params">(now in svc mode)</span> r0-r12	<span class="comment">//将r0-r12入栈:13*4=52 bytes</span></span><br><span class="line">        ldr     r2, IRQ_STACK_START_IN	<span class="comment">//r2 = *(IRQ_STACK_START_IN) r2就是栈基地址</span></span><br><span class="line">        @ get values <span class="keyword">for</span> &quot;aborted&quot; pc and <span class="title function_">cpsr</span> <span class="params">(into parm regs)</span></span><br><span class="line">        ldmia   r2, &#123;r2 - r3&#125;			<span class="comment">//将数据(pc, cpsr)出栈到r2,r3</span></span><br><span class="line">        add     r0, sp, #S_FRAME_SIZE           @ grab pointer to old <span class="built_in">stack</span> <span class="comment">//r0 = sp + 72；将最初的sp_SVC保存到r0</span></span><br><span class="line">        add     r5, sp, #S_SP			<span class="comment">//r5 = sp + 52；更新sp，之前入栈了52 bytes</span></span><br><span class="line">        mov     r1, lr					<span class="comment">//r1 = lr</span></span><br><span class="line">        stmia   r5, &#123;r0 - r3&#125;   @ save sp_SVC, lr_SVC, pc, cpsr		<span class="comment">//将r0,r1,r2,r3入栈</span></span><br><span class="line">        mov     r0, sp          @ save current <span class="built_in">stack</span> into <span class="title function_">r0</span> <span class="params">(param <span class="keyword">register</span>)</span>	<span class="comment">//r0 = sp</span></span><br><span class="line">        .endm</span><br><span class="line"></span><br><span class="line">        .macro  irq_save_user_regs	<span class="comment">//保存寄存器到栈</span></span><br><span class="line">        sub     sp, sp, #S_FRAME_SIZE	<span class="comment">//sp = sp - 72</span></span><br><span class="line">        stmia   sp, &#123;r0 - r12&#125;                  @ Calling r0-r12	<span class="comment">//将r0-r12入栈:13*4=52 bytes</span></span><br><span class="line">        @ !!!! R8 NEEDS to be saved !!!! a reserved <span class="built_in">stack</span> spot would be good.</span><br><span class="line">        add     r8, sp, #S_PC			<span class="comment">//r8 = sp + 52</span></span><br><span class="line">        stmdb   r8, &#123;sp, lr&#125;^           @ Calling SP, LR	<span class="comment">//将sp、lr入栈</span></span><br><span class="line">        str     lr, [r8, #<span class="number">0</span>]            @ Save calling PC	<span class="comment">//*(r8) = lr</span></span><br><span class="line">        mrs     r6, spsr				<span class="comment">//r6 = spsr</span></span><br><span class="line">        str     r6, [r8, #<span class="number">4</span>]            @ Save CPSR		<span class="comment">//*(r8+4) = r6 = spsr</span></span><br><span class="line">        str     r0, [r8, #<span class="number">8</span>]            @ Save OLD_R0	<span class="comment">//*(r8+8) = r6</span></span><br><span class="line">        mov     r0, sp</span><br><span class="line">        .endm</span><br><span class="line"></span><br><span class="line">        .macro  irq_restore_user_regs</span><br><span class="line">        ldmia   sp, &#123;r0 - lr&#125;^                  @ Calling r0 - lr	               <span class="comment">//将栈中数据弹出到r0-lr</span></span><br><span class="line">        mov     r0, r0</span><br><span class="line">        ldr     lr, [sp, #S_PC]                 @ Get PC						 <span class="comment">//lr = *(sp+52)</span></span><br><span class="line">        add     sp, sp, #S_FRAME_SIZE										    <span class="comment">//sp += 72</span></span><br><span class="line">        subs    pc, lr, #<span class="number">4</span>              @ <span class="keyword">return</span> &amp; move spsr_svc into cpsr         <span class="comment">//pc = lr -4</span></span><br><span class="line">        .endm</span><br><span class="line"></span><br><span class="line">        .macro get_bad_stack	<span class="comment">//保存lr，spsr寄存器的值到IRQ栈、并切换模式</span></span><br><span class="line">        ldr     r13, IRQ_STACK_START_IN         @ setup our mode <span class="built_in">stack</span>	           <span class="comment">//r13 = *(IRQ_STACK_START_IN)</span></span><br><span class="line"></span><br><span class="line">        str     lr, [r13]       @ save caller lr in position <span class="number">0</span> of saved <span class="built_in">stack</span>	   <span class="comment">//*(r13) = lr</span></span><br><span class="line">        mrs     lr, spsr        @ get the spsr									<span class="comment">//lr = spsr</span></span><br><span class="line">        str     lr, [r13, #<span class="number">4</span>]   @ save spsr in position <span class="number">1</span> of saved <span class="built_in">stack</span>		  <span class="comment">//*(r13+4) = lr</span></span><br><span class="line">        mov     r13, #MODE_SVC  @ prepare SVC-Mode								<span class="comment">//r13 = 0x13</span></span><br><span class="line">        @ msr   spsr_c, r13</span><br><span class="line">        msr     spsr, r13       @ <span class="keyword">switch</span> modes, make sure moves will execute	  <span class="comment">//spsr = r13</span></span><br><span class="line">        mov     lr, pc          @ capture <span class="keyword">return</span> pc                               <span class="comment">//lr = pc</span></span><br><span class="line">        movs    pc, lr          @ jump to next instruction &amp; <span class="keyword">switch</span> modes.        <span class="comment">//pc = lr </span></span><br><span class="line">        .endm</span><br><span class="line"></span><br><span class="line">        .macro get_irq_stack                    @ setup IRQ <span class="built_in">stack</span></span><br><span class="line">        ldr     sp, IRQ_STACK_START			<span class="comment">//sp = *(IRQ_STACK_START)</span></span><br><span class="line">        .endm</span><br><span class="line"></span><br><span class="line">        .macro get_fiq_stack                    @ setup FIQ <span class="built_in">stack</span></span><br><span class="line">        ldr     sp, FIQ_STACK_START			<span class="comment">//sp = *(FIQ_STACK_START)</span></span><br><span class="line">        .endm</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * exception handlers</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">        .align  <span class="number">5</span></span><br><span class="line">undefined_instruction:		</span><br><span class="line">        get_bad_stack</span><br><span class="line">        bad_save_user_regs</span><br><span class="line">        bl      do_undefined_instruction</span><br><span class="line"></span><br><span class="line">        .align  <span class="number">5</span></span><br><span class="line">software_interrupt:</span><br><span class="line">        get_bad_stack</span><br><span class="line">        bad_save_user_regs</span><br><span class="line">        bl      do_software_interrupt	<span class="comment">//跳转处理软件中断</span></span><br><span class="line"></span><br><span class="line">        .align  <span class="number">5</span></span><br><span class="line">prefetch_abort:</span><br><span class="line">        get_bad_stack</span><br><span class="line">        bad_save_user_regs</span><br><span class="line">        bl      do_prefetch_abort</span><br><span class="line"></span><br><span class="line">        .align  <span class="number">5</span></span><br><span class="line">data_abort:</span><br><span class="line">        get_bad_stack</span><br><span class="line">        bad_save_user_regs</span><br><span class="line">        bl      do_data_abort</span><br><span class="line"></span><br><span class="line">        .align  <span class="number">5</span></span><br><span class="line">not_used:</span><br><span class="line">        get_bad_stack</span><br><span class="line">        bad_save_user_regs</span><br><span class="line">        bl      do_not_used</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARCH_SUNXI</span></span><br><span class="line"></span><br><span class="line">                .align  <span class="number">5</span></span><br><span class="line">        irq:</span><br><span class="line">                get_irq_stack</span><br><span class="line">                irq_save_user_regs</span><br><span class="line">                bl      do_irq</span><br><span class="line">                irq_restore_user_regs	<span class="comment">//为何需要多这一步</span></span><br><span class="line"></span><br><span class="line">                .align  <span class="number">5</span></span><br><span class="line">        fiq:</span><br><span class="line">                get_fiq_stack</span><br><span class="line">                <span class="comment">/* someone ought to write a more effiction fiq_save_user_regs */</span></span><br><span class="line">                irq_save_user_regs</span><br><span class="line">                bl      do_fiq</span><br><span class="line">                irq_restore_user_regs	<span class="comment">//为何需要多这一步</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        .align  <span class="number">5</span></span><br><span class="line">irq:</span><br><span class="line">        get_bad_stack</span><br><span class="line">        bad_save_user_regs</span><br><span class="line">        bl      do_irq</span><br><span class="line"></span><br><span class="line">        .align  <span class="number">5</span></span><br><span class="line">fiq:</span><br><span class="line">        get_bad_stack</span><br><span class="line">        bad_save_user_regs</span><br><span class="line">        bl      do_fiq</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  <span class="comment">/* CONFIG_SPL_BUILD */</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="start-S-设置中断向量表，进入reset中断"><a href="#start-S-设置中断向量表，进入reset中断" class="headerlink" title="start.S 设置中断向量表，进入reset中断"></a>start.S 设置中断向量表，进入reset中断</h4><p>_start函数就是直接跳转到reset函数执行，reset函数在：arch&#x2F;arm&#x2F;cpu&#x2F;armv7&#x2F;start.S</p>
<p>该模块的代码主要就是设置上文定义的中断向量表，并使处理器进入SVC模式，设置好ARM的协处理器，然后跳转到lowlevel_init。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line">panrunxins@AwExdroid100:~/longan/brandy/brandy<span class="number">-2.0</span>/u-boot<span class="number">-2018</span>/arch/arm/cpu/armv7$ cat start.S</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm-offsets.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;config.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/system.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/linkage.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/armv7.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Startup Code (reset vector)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Do important init only if we don&#x27;t start from memory!</span></span><br><span class="line"><span class="comment"> * Setup memory and board specific bits prior to relocation.</span></span><br><span class="line"><span class="comment"> * Relocate armboot to ram. Setup stack.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************/</span></span><br><span class="line"></span><br><span class="line">        .globl  reset							</span><br><span class="line">        .globl  save_boot_params_ret</span><br><span class="line">        .type   save_boot_params_ret,%function</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARMV7_LPAE</span></span><br><span class="line">        .global switch_to_hypervisor_ret</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">reset:</span><br><span class="line">        <span class="comment">/* Allow the board to save important registers */</span></span><br><span class="line">        b       save_boot_params</span><br><span class="line">save_boot_params_ret:</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARMV7_LPAE</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * check for Hypervisor support</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        mrc     p15, <span class="number">0</span>, r0, c0, c1, <span class="number">1</span>           @ read ID_PFR1</span><br><span class="line">        and     r0, r0, #CPUID_ARM_VIRT_MASK    @ mask virtualization bits</span><br><span class="line">        cmp     r0, #(<span class="number">1</span> &lt;&lt; CPUID_ARM_VIRT_SHIFT)</span><br><span class="line">        beq     switch_to_hypervisor</span><br><span class="line">switch_to_hypervisor_ret:</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * disable interrupts (FIQ and IRQ), also set the cpu to SVC32 mode,</span></span><br><span class="line"><span class="comment">         * except if in HYP mode already</span></span><br><span class="line"><span class="comment">         * bit4 bit3 bit2 bit1 bit0 is mode bit</span></span><br><span class="line"><span class="comment">         * bit6 bit7 is FRQ,IRQ enable bit</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mrs     r0, cpsr										<span class="comment">//r0 = cpsr</span></span><br><span class="line">        and     r1, r0, #<span class="number">0x1f</span>           @ mask mode bits            <span class="comment">//r1 = r0 &amp; 0x1f 提取bit4 bit3 bit2 bit1 bit0到r1</span></span><br><span class="line">        teq     r1, #<span class="number">0x1a</span>               @ test <span class="keyword">for</span> HYP mode	        <span class="comment">//r1 == 0x1a?	查看是否处于HYP模式</span></span><br><span class="line">        bicne   r0, r0, #<span class="number">0x1f</span>           @ clear all mode bits       <span class="comment">//清除r0的bit0-bit4</span></span><br><span class="line">        orrne   r0, r0, #<span class="number">0x13</span>           @ <span class="built_in">set</span> SVC mode			   <span class="comment">//设置r0为0b10011 SVC模式</span></span><br><span class="line">        orr     r0, r0, #<span class="number">0xc0</span>           @ disable FIQ and IRQ       <span class="comment">//设置r0的bit14 bit15 关闭中断</span></span><br><span class="line">        msr     cpsr,r0											<span class="comment">//cpsr = r0设置cpsr，使生效				</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Setup vector: 向量表的重定位似乎和SPL有关系</span></span><br><span class="line"><span class="comment"> * (OMAP4 spl TEXT_BASE is not 32 byte aligned.</span></span><br><span class="line"><span class="comment"> * Continue to use ROM code vector only in OMAP4 spl)</span></span><br><span class="line"><span class="comment"> * CP15是ARM的协处理器，负责内存管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !(defined(CONFIG_OMAP44XX) &amp;&amp; defined(CONFIG_SPL_BUILD))</span></span><br><span class="line">        <span class="comment">/* Set V=0 in CP15 SCTLR register - for VBAR to point to vector */</span></span><br><span class="line">        mrc     p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span>   @ Read CP15 SCTLR Register</span><br><span class="line">        bic     r0, #CR_V               @ V = <span class="number">0</span></span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span>   @ Write CP15 SCTLR Register</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Set vector address in CP15 VBAR register */</span></span><br><span class="line">        ldr     r0, =_start</span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c12, c0, <span class="number">0</span>  @Set VBAR</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* the mask ROM code should have PLL and others stable */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_SKIP_LOWLEVEL_INIT</span></span><br><span class="line">        bl      cpu_init_cp15</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_SKIP_LOWLEVEL_INIT_ONLY</span></span><br><span class="line">        bl      cpu_init_crit</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        bl      _main</span><br><span class="line"></span><br><span class="line"><span class="comment">/*------------------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line">ENTRY(c_runtime_cpu_setup)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If I-cache is enabled invalidate it</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !CONFIG_IS_ENABLED(SYS_ICACHE_OFF)</span></span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c7, c5, <span class="number">0</span>   @ invalidate icache</span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c7, c10, <span class="number">4</span>  @ DSB</span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c7, c5, <span class="number">4</span>   @ ISB</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        bx      lr</span><br><span class="line"></span><br><span class="line">ENDPROC(c_runtime_cpu_setup)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * void save_boot_params(u32 r0, u32 r1, u32 r2, u32 r3)</span></span><br><span class="line"><span class="comment"> *      __attribute__((weak));</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Stack pointer is not yet initialized at this moment</span></span><br><span class="line"><span class="comment"> * Don&#x27;t save anything to stack even if compiled with -O0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************/</span></span><br><span class="line">ENTRY(save_boot_params)</span><br><span class="line">        b       save_boot_params_ret            @ back to my caller</span><br><span class="line">ENDPROC(save_boot_params)</span><br><span class="line">        .weak   save_boot_params			<span class="comment">//save_boot_params定义为weak，是为了给用户留下接口</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARMV7_LPAE</span></span><br><span class="line">ENTRY(switch_to_hypervisor)</span><br><span class="line">        b       switch_to_hypervisor_ret</span><br><span class="line">ENDPROC(switch_to_hypervisor)</span><br><span class="line">        .weak   switch_to_hypervisor</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * cpu_init_cp15</span></span><br><span class="line"><span class="comment"> * CP15是ARM的存储协处理器，这里初始化CP15协处理器，用于设置MMU</span></span><br><span class="line"><span class="comment"> * Setup CP15 registers (cache, MMU, TLBs). The I-cache is turned on unless</span></span><br><span class="line"><span class="comment"> * CONFIG_SYS_ICACHE_OFF is defined.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************/</span></span><br><span class="line">ENTRY(cpu_init_cp15)</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Invalidate L1 I/D</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mov     r0, #<span class="number">0</span>                  @ <span class="built_in">set</span> up <span class="keyword">for</span> MCR</span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c8, c7, <span class="number">0</span>   @ invalidate TLBs</span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c7, c5, <span class="number">0</span>   @ invalidate icache</span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c7, c5, <span class="number">6</span>   @ invalidate BP <span class="built_in">array</span></span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c7, c10, <span class="number">4</span>  @ DSB</span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c7, c5, <span class="number">4</span>   @ ISB</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * disable MMU stuff and caches</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mrc     p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span></span><br><span class="line">        bic     r0, r0, #<span class="number">0x00002000</span>     @ clear bits <span class="number">13</span> (--V-)</span><br><span class="line">        bic     r0, r0, #<span class="number">0x00000007</span>     @ clear bits <span class="number">2</span>:<span class="number">0</span> (-CAM)</span><br><span class="line">        orr     r0, r0, #<span class="number">0x00000002</span>     @ <span class="built_in">set</span> bit <span class="number">1</span> (--A-) Align</span><br><span class="line">        orr     r0, r0, #<span class="number">0x00000800</span>     @ <span class="built_in">set</span> bit <span class="number">11</span> (Z---) BTB</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_IS_ENABLED(SYS_ICACHE_OFF)</span></span><br><span class="line">        bic     r0, r0, #<span class="number">0x00001000</span>     @ clear bit <span class="number">12</span> (I) I-cache</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        orr     r0, r0, #<span class="number">0x00001000</span>     @ <span class="built_in">set</span> bit <span class="number">12</span> (I) I-cache</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SUNXI_ARM_A53</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         *clear AFE,TRE bit in sctrl</span></span><br><span class="line"><span class="comment">         *non-secure: reset value is unknow</span></span><br><span class="line"><span class="comment">         *secure    : default value is 0</span></span><br><span class="line"><span class="comment">         *notice    : we must set the TRE bit to enable the memory</span></span><br><span class="line"><span class="comment">         *            arttribute configuration from the section table.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        MRC     p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span>   @Read SCTLR</span><br><span class="line">        BIC     r0, r0, #(<span class="number">1</span>&lt;&lt;<span class="number">28</span>)        @clr TRE bit</span><br><span class="line">        BIC     r0, r0, #(<span class="number">1</span>&lt;&lt;<span class="number">29</span>)        @clr AEF bit</span><br><span class="line">        MCR     p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span>   @Write SCTLR</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        mov     r5, lr                  @ Store my Caller</span><br><span class="line">        mrc     p15, <span class="number">0</span>, r1, c0, c0, <span class="number">0</span>   @ r1 has Read Main ID Register (MIDR)</span><br><span class="line">        mov     r3, r1, lsr #<span class="number">20</span>         @ get variant field</span><br><span class="line">        and     r3, r3, #<span class="number">0xf</span>            @ r3 has CPU variant</span><br><span class="line">        and     r4, r1, #<span class="number">0xf</span>            @ r4 has CPU revision</span><br><span class="line">        mov     r2, r3, lsl #<span class="number">4</span>          @ shift variant field <span class="keyword">for</span> combined value</span><br><span class="line">        orr     r2, r4, r2              @ r2 has combined CPU variant + revision</span><br><span class="line"></span><br><span class="line">        mov     pc, r5                  @ back to my caller</span><br><span class="line">ENDPROC(cpu_init_cp15)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_SKIP_LOWLEVEL_INIT) &amp;&amp; \</span></span><br><span class="line"><span class="meta">        !defined(CONFIG_SKIP_LOWLEVEL_INIT_ONLY)</span></span><br><span class="line"><span class="comment">/*************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * CPU_init_critical registers</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * setup important registers</span></span><br><span class="line"><span class="comment"> * setup memory timing</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************/</span></span><br><span class="line">ENTRY(cpu_init_crit)</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Jump to board specific initialization...</span></span><br><span class="line"><span class="comment">         * The Mask ROM will have already initialized</span></span><br><span class="line"><span class="comment">         * basic memory. Go here to bump up clock rate and handle</span></span><br><span class="line"><span class="comment">         * wake up conditions.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        b       lowlevel_init           @ go setup pll,mux,memory</span><br><span class="line">ENDPROC(cpu_init_crit)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="lowlevel-init-初始化C环境"><a href="#lowlevel-init-初始化C环境" class="headerlink" title="lowlevel_init() 初始化C环境"></a>lowlevel_init() 初始化C环境</h4><p>SPL与uboot的关系、SPL如何影响uboot呢？跳转到的s_init是在哪里？</p>
<p>lowlevel_init()中初始化SP寄存器，建立C语言临时使用的栈；</p>
<p>建立全局数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">panrunxins@AwExdroid100:~/longan/brandy/brandy<span class="number">-2.0</span>/u-boot<span class="number">-2018</span>/arch/arm/cpu/armv7$ cat lowlevel_init.S</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm-offsets.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;config.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/linkage.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">.pushsection .text.s_init, <span class="string">&quot;ax&quot;</span></span><br><span class="line">WEAK(s_init)</span><br><span class="line">        bx      lr</span><br><span class="line"><span class="title function_">ENDPROC</span><span class="params">(s_init)</span></span><br><span class="line">.popsection</span><br><span class="line"></span><br><span class="line">.pushsection .text.lowlevel_init, &quot;ax&quot;</span><br><span class="line"><span class="title function_">WEAK</span><span class="params">(lowlevel_init)</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Setup a temporary stack. Global data is not available yet.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SPL_BUILD) &amp;&amp; defined(CONFIG_SPL_STACK)</span></span><br><span class="line">        ldr     sp, =CONFIG_SPL_STACK</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        ldr     sp, =CONFIG_SYS_INIT_SP_ADDR	<span class="comment">//设置堆栈地址</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        bic     sp, sp, #<span class="number">7</span> <span class="comment">/* 8-byte alignment for ABI compliance */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SPL_DM</span></span><br><span class="line">        mov     r9, #<span class="number">0</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Set up global data for boards that still need it. This will be</span></span><br><span class="line"><span class="comment">         * removed soon.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SPL_BUILD</span></span><br><span class="line">        ldr     r9, =gdata</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        sub     sp, sp, #GD_SIZE	<span class="comment">//栈指针向下移动gd大小</span></span><br><span class="line">        bic     sp, sp, #<span class="number">7</span>			<span class="comment">//8字节对齐</span></span><br><span class="line">        mov     r9, sp				<span class="comment">//r9保存了gd的地址</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Save the old lr(passed in ip) and the current lr to stack</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        push    &#123;ip, lr&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Call the very early init function. This should do only the</span></span><br><span class="line"><span class="comment">         * absolute bare minimum to get started. It should not:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * - set up DRAM</span></span><br><span class="line"><span class="comment">         * - use global_data</span></span><br><span class="line"><span class="comment">         * - clear BSS</span></span><br><span class="line"><span class="comment">         * - try to start a console</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * For boards with SPL this should be empty since SPL can do all of</span></span><br><span class="line"><span class="comment">         * this init in the SPL board_init_f() function which is called</span></span><br><span class="line"><span class="comment">         * immediately after this.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        bl      s_init</span><br><span class="line">        pop     &#123;ip, pc&#125;</span><br><span class="line">ENDPROC(lowlevel_init)</span><br><span class="line">.popsection</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="globl-data"><a href="#globl-data" class="headerlink" title="globl data"></a>globl data</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">global_data</span> &#123;</span></span><br><span class="line">        <span class="type">bd_t</span> *bd;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> baudrate;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> cpu_clk;          <span class="comment">/* CPU clock in Hz!             */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> bus_clk;</span><br><span class="line">        <span class="comment">/* We cannot bracket this with CONFIG_PCI due to mpc5xxx */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> pci_clk;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> mem_clk;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_LCD) || defined(CONFIG_VIDEO)</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> fb_base;          <span class="comment">/* Base address of framebuffer mem */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_POST)</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> post_log_word;    <span class="comment">/* Record POST activities */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> post_log_res;     <span class="comment">/* success of POST test */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> post_init_f_time; <span class="comment">/* When post_init_f started */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BOARD_TYPES</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> board_type;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> have_console;     <span class="comment">/* serial_init() was called */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_IS_ENABLED(PRE_CONSOLE_BUFFER)</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> precon_buf_idx;   <span class="comment">/* Pre-Console buffer index */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> env_addr;         <span class="comment">/* Address  of Environment struct */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> env_valid;        <span class="comment">/* Environment valid? enum env_valid */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> env_has_init;     <span class="comment">/* Bitmask of boolean of struct env_location offsets */</span></span><br><span class="line">        <span class="type">int</span> env_load_location;</span><br><span class="line"></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> ram_base;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> ram_top;          <span class="comment">/* Top address of RAM used by U-Boot */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> relocaddr;        <span class="comment">/* Start address of U-Boot in RAM */</span></span><br><span class="line">        <span class="type">phys_size_t</span> ram_size;           <span class="comment">/* RAM size */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> mon_len;          <span class="comment">/* monitor len */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> irq_sp;           <span class="comment">/* irq stack pointer */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> start_addr_sp;    <span class="comment">/* start_addr_stackpointer */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> reloc_off;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">global_data</span> *<span class="title">new_gd</span>;</span>     <span class="comment">/* relocated global data */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DM</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">udevice</span>  *<span class="title">dm_root</span>;</span>       <span class="comment">/* Root instance for Driver Model */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">udevice</span>  *<span class="title">dm_root_f</span>;</span>     <span class="comment">/* Pre-relocation root instance */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">uclass_root</span>;</span>   <span class="comment">/* Head of core tree */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_TIMER</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">udevice</span>  *<span class="title">timer</span>;</span>         <span class="comment">/* Timer instance for Driver Model */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="type">const</span> <span class="type">void</span> *fdt_blob;           <span class="comment">/* Our device tree, NULL if none */</span></span><br><span class="line">        <span class="type">void</span> *new_fdt;                  <span class="comment">/* Relocated FDT */</span></span><br><span class="line">        <span class="type">void</span> *new_ext_fdt;              <span class="comment">/* Relocated EXTERNAL FDT */</span></span><br><span class="line">        <span class="type">void</span> *new_dtbo;                 <span class="comment">/*Relocated dtbo */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> fdt_size;         <span class="comment">/* Space reserved for relocated FDT */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> fdt_ext_size;     <span class="comment">/* Space reserved for relocated EXTERNAL FDT */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_OF_LIVE</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">of_root</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">jt_funcs</span> *<span class="title">jt</span>;</span>            <span class="comment">/* jump table */</span></span><br><span class="line">        <span class="type">char</span> env_buf[<span class="number">32</span>];               <span class="comment">/* buffer for env_get() before reloc. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_TRACE</span></span><br><span class="line">        <span class="type">void</span>            *trace_buff;    <span class="comment">/* The trace buffer */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SYS_I2C)</span></span><br><span class="line">        <span class="type">int</span>             cur_i2c_bus;    <span class="comment">/* current used i2c bus */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYS_I2C_MXC</span></span><br><span class="line">        <span class="type">void</span> *srdata[<span class="number">10</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> timebase_h;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> timebase_l;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_VAL(SYS_MALLOC_F_LEN)</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> malloc_base;      <span class="comment">/* base address of early malloc() */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> malloc_limit;     <span class="comment">/* limit address */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> malloc_ptr;       <span class="comment">/* current address */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PCI</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pci_controller</span> *<span class="title">hose</span>;</span>    <span class="comment">/* PCI hose for early use */</span></span><br><span class="line">        <span class="type">phys_addr_t</span> pci_ram_top;        <span class="comment">/* top of region accessible to PCI */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PCI_BOOTDELAY</span></span><br><span class="line">        <span class="type">int</span> pcidelay_done;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">udevice</span> *<span class="title">cur_serial_dev</span>;</span> <span class="comment">/* current serial device */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">arch_global_data</span> <span class="title">arch</span>;</span>   <span class="comment">/* architecture-specific data */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CONSOLE_RECORD</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">membuff</span> <span class="title">console_out</span>;</span>     <span class="comment">/* console output */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">membuff</span> <span class="title">console_in</span>;</span>      <span class="comment">/* console input */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DM_VIDEO</span></span><br><span class="line">        ulong video_top;                <span class="comment">/* Top of video frame buffer area */</span></span><br><span class="line">        ulong video_bottom;             <span class="comment">/* Bottom of video frame buffer area */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BOOTSTAGE</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">bootstage_data</span> *<span class="title">bootstage</span>;</span>       <span class="comment">/* Bootstage information */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">bootstage_data</span> *<span class="title">new_bootstage</span>;</span>   <span class="comment">/* Relocated bootstage info */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_LOG</span></span><br><span class="line">        <span class="type">int</span> log_drop_count;             <span class="comment">/* Number of dropped log messages */</span></span><br><span class="line">        <span class="type">int</span> default_log_level;          <span class="comment">/* For devices with no filters */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">log_head</span>;</span>      <span class="comment">/* List of struct log_device */</span></span><br><span class="line">        <span class="type">int</span> log_fmt;                    <span class="comment">/* Mask containing log format info */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARCH_SUNXI</span></span><br><span class="line">        <span class="type">long</span>           securemode;</span><br><span class="line">        <span class="type">void</span>          *parameter_mod_buf;</span><br><span class="line">        <span class="type">long</span>           boot_card_num;</span><br><span class="line">        ulong          lockflag;</span><br><span class="line">        ulong          chargemode;</span><br><span class="line"></span><br><span class="line">        ulong          parameter_reloc_buf;</span><br><span class="line">        ulong          parameter_reloc_size;</span><br><span class="line"></span><br><span class="line">        ulong          malloc_noncache_start;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span>           key_pressd_value;</span><br><span class="line">        <span class="type">long</span>           axp_power_soft_id;</span><br><span class="line">        <span class="type">long</span>           power_step_level;</span><br><span class="line">        <span class="type">long</span>           pmu_suspend_chgcur;</span><br><span class="line">        <span class="type">long</span>           pmu_runtime_chgcur;</span><br><span class="line">        <span class="type">long</span>           limit_vol;</span><br><span class="line">        <span class="type">long</span>           limit_cur;</span><br><span class="line">        <span class="type">long</span>           limit_pcvol;</span><br><span class="line">        <span class="type">long</span>           limit_pccur;</span><br><span class="line">        ulong          force_download_uboot;</span><br><span class="line">        ulong          vbus_status;<span class="comment">//0: unknow 1:exist 2:not exist</span></span><br><span class="line">        ulong          debug_mode;</span><br><span class="line">        <span class="type">long</span>           force_shell;</span><br><span class="line">        <span class="type">long</span>           user_debug_mode;</span><br><span class="line">        ulong          layer_para;</span><br><span class="line">        ulong          layer_hd;</span><br><span class="line">        ulong          bootfile_mode;</span><br><span class="line">        <span class="type">int</span>            pmu_saved_status;</span><br><span class="line">        <span class="type">int</span>                need_shutdown;</span><br><span class="line">        <span class="type">int</span>            logo_status_multiboot;</span><br><span class="line">        <span class="type">int</span>            ir_detect_status;</span><br><span class="line">        <span class="type">bool</span>                    uboot_shell;</span><br><span class="line">        ulong          boot_logo_addr;</span><br><span class="line">        <span class="type">bool</span>           force_32bit_os;<span class="comment">//1: run 32bit os at 64bit platform</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125; <span class="type">gd_t</span>;</span><br></pre></td></tr></table></figure>



<h4 id="s-init-初始化串口时钟"><a href="#s-init-初始化串口时钟" class="headerlink" title="s_init() 初始化串口时钟"></a>s_init() 初始化串口时钟</h4><p>lowlevel_init()最终调用s_init()，s_init()在&#x2F;arch&#x2F;arm&#x2F;mach-sunxi&#x2F;board.c中。由于在lowlevel_init（）中初始化了栈，所以在这里可以使用c语言。</p>
<p>这里就是初始化时钟、定时器、gpio，以太网。除了串口时钟初始化，其他的函数啥也没具体实现。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gpio_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">s_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_ARM_CORTEX_CPU_IS_UP) &amp;&amp; !defined(CONFIG_ARM64)</span></span><br><span class="line">        <span class="comment">/* Enable SMP mode for CPU0, by setting bit 6 of Auxiliary Ctl reg */</span></span><br><span class="line">        <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">                <span class="string">&quot;mrc p15, 0, r0, c1, c0, 1\n&quot;</span></span></span><br><span class="line"><span class="params">                <span class="string">&quot;orr r0, r0, #1 &lt;&lt; 6\n&quot;</span></span></span><br><span class="line"><span class="params">                <span class="string">&quot;mcr p15, 0, r0, c1, c0, 1\n&quot;</span></span></span><br><span class="line"><span class="params">                ::: <span class="string">&quot;r0&quot;</span>)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        clock_init();</span><br><span class="line">        timer_init();</span><br><span class="line">        gpio_init();</span><br><span class="line"></span><br><span class="line">        eth_init_board();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>&#x2F;arch&#x2F;arm&#x2F;mach-sunxi&#x2F;clock.c:clock_init()，假如不需要编译SPL，则初始化串口、秒</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">clock_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SPL_BUILD</span></span><br><span class="line">        clock_init_safe();</span><br><span class="line">        gtbus_init();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        clock_init_uart();</span><br><span class="line">        clock_init_sec();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>&#x2F;lib&#x2F;timer.c:timer_init()，是一个虚函数，可以被用户覆盖，但是从uboot.map来看它未被覆盖、所以可认为这里他啥也没干。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> __weak <span class="title function_">timer_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>arch&#x2F;arm&#x2F;include&#x2F;asm&#x2F;arch-sunxi&#x2F;sys_proto.h:eth_init_board()，似乎是一个啥也没干的函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* Board / SoC level designware gmac init */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined CONFIG_SPL_BUILD &amp;&amp; defined CONFIG_SUN7I_GMAC</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">eth_init_board</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">eth_init_board</span><span class="params">(<span class="type">void</span>)</span> &#123;&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>arch&#x2F;arm&#x2F;mach-sunxi&#x2F;clock_sunxxxxxx.c:clock_init_uart() 中实现了初始化串口时钟</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">clock_init_uart</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sunxi_ccm_reg</span> *<span class="title">const</span> <span class="title">ccm</span> =</span></span><br><span class="line">                (<span class="keyword">struct</span> sunxi_ccm_reg *)SUNXI_CCM_BASE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* uart clock source is apb2 */</span></span><br><span class="line">        writel(APB2_CLK_SRC_OSC24M|</span><br><span class="line">               APB2_CLK_RATE_N_1|</span><br><span class="line">               APB2_CLK_RATE_M(<span class="number">1</span>),</span><br><span class="line">               &amp;ccm-&gt;apb2_cfg);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* open the clock for uart */</span></span><br><span class="line">        setbits_le32(&amp;ccm-&gt;uart_gate_reset,</span><br><span class="line">                     <span class="number">1</span> &lt;&lt; (CONFIG_CONS_INDEX - <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* deassert uart reset */</span></span><br><span class="line">        setbits_le32(&amp;ccm-&gt;uart_gate_reset,</span><br><span class="line">                     <span class="number">1</span> &lt;&lt; (RESET_SHIFT + CONFIG_CONS_INDEX - <span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="main"><a href="#main" class="headerlink" title="_main"></a>_main</h3><p>初始化完成串口时钟后，s_init返回到lowlevel_init，再返回到cpu_init_crit，然后执行下一个函数_main。</p>
<p>貌似是个很重要的函数，认真看下说明:</p>
<p>网上找到一篇不错的博客：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1432827">https://cloud.tencent.com/developer/article/1432827</a></p>
<p>需要注意的有：</p>
<ul>
<li>在执行board_init_f()之前的uboot可能运行在ROM等不可写的存储器中，即程序无法进行写操作，无法使用栈，全局变量。解决办法是使用CPU内的SRAM作为栈，在栈前留一段内存作为global data来存放所需要的全局变量。这样就可以使用c函数调用</li>
<li>uboot需要重定位</li>
<li>通过函数指针数据的形式，提供API接口给用户，由用户具体实现功能</li>
<li>global data</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;config.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm-offsets.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/linkage.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CPU_V7M</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/armv7m.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This file handles the target-independent stages of the U-Boot</span></span><br><span class="line"><span class="comment"> * start-up where a C runtime environment is needed. Its entry point</span></span><br><span class="line"><span class="comment"> * is _main and is branched into from the target&#x27;s start.S file.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * _main execution sequence is:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * board_init_f() 的函数名含义是：board init front 前置板子初始化</span></span><br><span class="line"><span class="comment"> * 1. Set up initial environment for calling board_init_f().</span></span><br><span class="line"><span class="comment"> *    This environment only provides a stack and a place to store</span></span><br><span class="line"><span class="comment"> *    the GD (&#x27;global data&#x27;) structure, both located in some readily</span></span><br><span class="line"><span class="comment"> *    available RAM (SRAM, locked cache...). In this context, VARIABLE</span></span><br><span class="line"><span class="comment"> *    global data, initialized or not (BSS), are UNAVAILABLE; only</span></span><br><span class="line"><span class="comment"> *    CONSTANT initialized data are available. GD should be zeroed</span></span><br><span class="line"><span class="comment"> *    before board_init_f() is called.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 2. Call board_init_f(). This function prepares the hardware for</span></span><br><span class="line"><span class="comment"> *    execution from system RAM (DRAM, DDR...) As system RAM may not</span></span><br><span class="line"><span class="comment"> *    be available yet, , board_init_f() must use the current GD to</span></span><br><span class="line"><span class="comment"> *    store any data which must be passed on to later stages. These</span></span><br><span class="line"><span class="comment"> *    data include the relocation destination, the future stack, and</span></span><br><span class="line"><span class="comment"> *    the future GD location.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 3. Set up intermediate environment where the stack and GD are the</span></span><br><span class="line"><span class="comment"> *    ones allocated by board_init_f() in system RAM, but BSS and</span></span><br><span class="line"><span class="comment"> *    initialized non-const data are still not available.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 4a.For U-Boot proper (not SPL), call relocate_code(). This function</span></span><br><span class="line"><span class="comment"> *    relocates U-Boot from its current location into the relocation</span></span><br><span class="line"><span class="comment"> *    destination computed by board_init_f().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 4b.For SPL, board_init_f() just returns (to crt0). There is no</span></span><br><span class="line"><span class="comment"> *    code relocation in SPL.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * board_init_r() rear:后置</span></span><br><span class="line"><span class="comment"> * 5. Set up final environment for calling board_init_r(). This</span></span><br><span class="line"><span class="comment"> *    environment has BSS (initialized to 0), initialized non-const</span></span><br><span class="line"><span class="comment"> *    data (initialized to their intended value), and stack in system</span></span><br><span class="line"><span class="comment"> *    RAM (for SPL moving the stack and GD into RAM is optional - see</span></span><br><span class="line"><span class="comment"> *    CONFIG_SPL_STACK_R). GD has retained values set by board_init_f().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 6. For U-Boot proper (not SPL), some CPUs have some work left to do</span></span><br><span class="line"><span class="comment"> *    at this point regarding memory, so call c_runtime_cpu_setup.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 7. Branch to board_init_r().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * For more information see &#x27;Board Initialisation Flow in README.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ENTRY(_main)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Set up initial C runtime environment and call board_init_f(0).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SPL_BUILD) &amp;&amp; defined(CONFIG_SPL_STACK)</span></span><br><span class="line">        ldr     r0, =(CONFIG_SPL_STACK)</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        ldr     r0, =(CONFIG_SYS_INIT_SP_ADDR)									<span class="comment">//r0 = CONFIG_SYS_INIT_SP_ADDR</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        bic     r0, r0, #<span class="number">7</span>      <span class="comment">/* 8-byte alignment for ABI compliance */</span> 		  <span class="comment">//r0 &amp;= 0x80 8字节对齐</span></span><br><span class="line">        mov     sp, r0														 <span class="comment">//sp = r0		</span></span><br><span class="line">        bl      board_init_f_alloc_reserve									   <span class="comment">//为global data预留空间，函数返回值是空间地址，保存在r0中</span></span><br><span class="line">        mov     sp, r0														 <span class="comment">//sp = r0 更新栈指针</span></span><br><span class="line">        <span class="comment">/* set up gd here, outside any C code */</span></span><br><span class="line">        mov     r9, r0                                                            <span class="comment">//r9 = r0，r9指向预留的gd空间</span></span><br><span class="line">        bl       board_init_f_init_reserve									   <span class="comment">//初始化global data，就是清零</span></span><br><span class="line"></span><br><span class="line">        mov     r0, #<span class="number">0</span>														 <span class="comment">//r0 = 0 r9 = gd地址</span></span><br><span class="line">        bl      board_init_f												 <span class="comment">//跳转到board_init_f 见下文</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ! defined(CONFIG_SPL_BUILD)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Set up intermediate environment (new sp and gd) and call</span></span><br><span class="line"><span class="comment"> * relocate_code(addr_moni). Trick here is that we&#x27;ll return</span></span><br><span class="line"><span class="comment"> * &#x27;here&#x27; but relocated.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">	    <span class="comment">//r9 = gd</span></span><br><span class="line">        ldr     r0, [r9, #GD_START_ADDR_SP]     <span class="comment">/* sp = gd-&gt;start_addr_sp */</span></span><br><span class="line">        bic     r0, r0, #<span class="number">7</span>      <span class="comment">/* 8-byte alignment for ABI compliance */</span></span><br><span class="line">        mov     sp, r0			<span class="comment">//设置堆栈指针					</span></span><br><span class="line">        ldr     r9, [r9, #GD_BD]                <span class="comment">/* r9 = gd-&gt;bd */</span></span><br><span class="line">        sub     r9, r9, #GD_SIZE                <span class="comment">/* new GD is below bd */</span></span><br><span class="line"></span><br><span class="line">        adr     lr, here	<span class="comment">//把here复制到lr</span></span><br><span class="line">    </span><br><span class="line">        ldr     r0, [r9, #GD_RELOC_OFF]         <span class="comment">/* r0 = gd-&gt;reloc_off */</span></span><br><span class="line">        add     lr, lr, r0			<span class="comment">//lr+重定位的偏移地址 = 重定位后的here地址</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_CPU_V7M)</span></span><br><span class="line">        orr     lr, #<span class="number">1</span>                          <span class="comment">/* As required by Thumb-only */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        ldr     r0, [r9, #GD_RELOCADDR]         <span class="comment">/* r0 = gd-&gt;relocaddr */</span></span><br><span class="line">        b       relocate_code				  <span class="comment">//重定位uboot代码</span></span><br><span class="line">here:</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * uboot重定位完成</span></span><br><span class="line"><span class="comment"> * now relocate vectors</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">        bl      relocate_vectors			  <span class="comment">//重定位中断向量表</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Set up final (full) environment */</span></span><br><span class="line"></span><br><span class="line">        bl      c_runtime_cpu_setup     <span class="comment">/* we still call old routine here */</span> <span class="comment">//c_runtime_cpu_setup在start.S中定义，返回调用者</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_SPL_BUILD) || defined(CONFIG_SPL_FRAMEWORK)</span></span><br><span class="line"><span class="meta"># <span class="keyword">ifdef</span> CONFIG_SPL_BUILD</span></span><br><span class="line">        <span class="comment">/* Use a DRAM stack for the rest of SPL, if requested */</span></span><br><span class="line">        bl      spl_relocate_stack_gd</span><br><span class="line">        cmp     r0, #<span class="number">0</span></span><br><span class="line">        movne   sp, r0</span><br><span class="line">        movne   r9, r0</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line">        ldr     r0, =__bss_start        <span class="comment">/* this is auto-relocated! */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_USE_ARCH_MEMSET</span></span><br><span class="line">        ldr     r3, =__bss_end          <span class="comment">/* this is auto-relocated! */</span></span><br><span class="line">        mov     r1, #<span class="number">0x00000000</span>         <span class="comment">/* prepare zero to clear BSS */</span></span><br><span class="line"></span><br><span class="line">        subs    r2, r3, r0              <span class="comment">/* r2 = memset len */</span></span><br><span class="line">            </span><br><span class="line">        <span class="comment">//r0 = bss_start,r2 = len,r3 = bss_end</span></span><br><span class="line">        bl      <span class="built_in">memset</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        ldr     r1, =__bss_end          <span class="comment">/* this is auto-relocated! */</span></span><br><span class="line">        mov     r2, #<span class="number">0x00000000</span>         <span class="comment">/* prepare zero to clear BSS */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//初始化bss段</span></span><br><span class="line">clbss_l:cmp     r0, r1                  <span class="comment">/* while not at end of BSS */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_CPU_V7M)</span></span><br><span class="line">        itt     lo</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        strlo   r2, [r0]                <span class="comment">/* clear 32-bit BSS word */</span></span><br><span class="line">        addlo   r0, r0, #<span class="number">4</span>              <span class="comment">/* move to next */</span></span><br><span class="line">        blo     clbss_l</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ! defined(CONFIG_SPL_BUILD)</span></span><br><span class="line">        bl coloured_LED_init			<span class="comment">//这个是虚函数 需要由用户实现</span></span><br><span class="line">        bl red_led_on</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">/* call board_init_r(gd_t *id, ulong dest_addr) */</span></span><br><span class="line">        mov     r0, r9                  <span class="comment">/* r0 = gd_t */</span></span><br><span class="line">        ldr     r1, [r9, #GD_RELOCADDR] <span class="comment">/* r1 = dest_addr */</span></span><br><span class="line">        <span class="comment">/* call board_init_r */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_IS_ENABLED(SYS_THUMB_BUILD)</span></span><br><span class="line">    	<span class="comment">//r0 = gd_t ,r1 = dest_addr</span></span><br><span class="line">        ldr     lr, =board_init_r       <span class="comment">/* this is auto-relocated! */</span>	<span class="comment">//跳转到board_init_r</span></span><br><span class="line">        bx      lr</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        ldr     pc, =board_init_r       <span class="comment">/* this is auto-relocated! */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">/* we should not return here. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">ENDPROC(_main)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//top = r0，将r0向下移动一个gd大小，地址再以16取整</span></span><br><span class="line">ulong <span class="title function_">board_init_f_alloc_reserve</span><span class="params">(ulong top)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">/* Reserve early malloc arena */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_VAL(SYS_MALLOC_F_LEN)</span></span><br><span class="line">        top -= CONFIG_VAL(SYS_MALLOC_F_LEN);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">/* LAST : reserve GD (rounded up to a multiple of 16 bytes) */</span></span><br><span class="line">        top = rounddown(top-<span class="keyword">sizeof</span>(<span class="keyword">struct</span> global_data), <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> top;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">board_init_f_init_reserve</span><span class="params">(ulong base)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">global_data</span> *<span class="title">gd_ptr</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * clear GD entirely and set it up.</span></span><br><span class="line"><span class="comment">         * Use gd_ptr, as gd may not be properly set yet.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        gd_ptr = (<span class="keyword">struct</span> global_data *)base;</span><br><span class="line">        <span class="comment">/* zero the area */</span></span><br><span class="line">        <span class="built_in">memset</span>(gd_ptr, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(*gd));</span><br><span class="line">        <span class="comment">/* set GD unless architecture did it already */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_ARM)</span></span><br><span class="line">        arch_setup_gd(gd_ptr);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">/* next alloc will be higher by one GD plus 16-byte alignment */</span></span><br><span class="line">        base += roundup(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> global_data), <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * record early malloc arena start.</span></span><br><span class="line"><span class="comment">         * Use gd as it is now properly set for all architectures.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_VAL(SYS_MALLOC_F_LEN)</span></span><br><span class="line">        <span class="comment">/* go down one &#x27;early malloc arena&#x27; */</span></span><br><span class="line">        gd-&gt;malloc_base = base;</span><br><span class="line">        <span class="comment">/* next alloc will be higher by one &#x27;early malloc arena&#x27; size */</span></span><br><span class="line">        base += CONFIG_VAL(SYS_MALLOC_F_LEN);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="board-init-f"><a href="#board-init-f" class="headerlink" title="board_init_f()"></a>board_init_f()</h5><p>common&#x2F;board_f.c:board_init_f()</p>
<p>主要就是执行init_sequence_f里面的函数。初始化外设和全局变量gd</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">board_init_f</span><span class="params">(ulong boot_flags)</span></span><br><span class="line">&#123;</span><br><span class="line">        gd-&gt;flags = boot_flags;</span><br><span class="line">        gd-&gt;have_console = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (initcall_run_list(init_sequence_f))</span><br><span class="line">                hang();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//函数指针数组</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">init_fnc_t</span> init_sequence_f[] = &#123;</span><br><span class="line">        setup_mon_len,	<span class="comment">//gd-&gt;mon_len = (ulong)&amp;__bss_end - (ulong)__image_copy_start; 应该是uboot镜像的大小？</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_OF_CONTROL</span></span><br><span class="line">        fdtdec_setup,	<span class="comment">//gd-&gt;fdt_blob = __dtb_dt_begin;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_TRACE</span></span><br><span class="line">        trace_early_init,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        initf_malloc,			<span class="comment">//与SYS_MALLOC_F_LEN有关</span></span><br><span class="line">        log_init,				<span class="comment">//初始化日志驱动</span></span><br><span class="line">        initf_bootstage,        <span class="comment">/*??? uses its own timer, so does not need DM */</span></span><br><span class="line">        initf_console_record,   <span class="comment">//申请内存给控制台</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_HAVE_FSP)</span></span><br><span class="line">        arch_fsp_init,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        arch_cpu_init,          <span class="comment">//未实现</span></span><br><span class="line">        mach_cpu_init,          <span class="comment">//未实现</span></span><br><span class="line">        initf_dm,				<span class="comment">//初始化driver model</span></span><br><span class="line">        arch_cpu_init_dm,       <span class="comment">//未实现</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_BOARD_EARLY_INIT_F)</span></span><br><span class="line">        board_early_init_f,     <span class="comment">//未实现</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_PPC) || defined(CONFIG_SYS_FSL_CLK) || defined(CONFIG_M68K)</span></span><br><span class="line">        <span class="comment">/* get CPU and bus clocks according to the environment variable */</span></span><br><span class="line">        get_clocks,             <span class="comment">/* get CPU and bus clocks (etc.) */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_M68K)</span></span><br><span class="line">        timer_init,             <span class="comment">//关闭定时器中断</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_BOARD_POSTCLK_INIT)</span></span><br><span class="line">        board_postclk_init,     <span class="comment">//未实现</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        env_init,               <span class="comment">/* 环境变量初始化 initialize environment */</span></span><br><span class="line">        init_baud_rate,         <span class="comment">/* gd-&gt;baudrate = env_get_ulong(&quot;baudrate&quot;, 10, CONFIG_BAUDRATE) */</span></span><br><span class="line">        serial_init,            <span class="comment">/* 初始化默认串口，并设置gd的标志位 serial communications setup */</span></span><br><span class="line">        console_init_f,         <span class="comment">/* 控制台是否是debug模式、stage 1 init of console */</span></span><br><span class="line">        display_options,        <span class="comment">//打印&quot;U-Boot 2018.05-00014-g8bece42007 (Dec 27 2021 - 12:37:06 +0000) Allwinner Technology, Build: jenkins-autocreatejob_dailybuild_platform_s-254&quot;</span></span><br><span class="line">        display_text_info,      <span class="comment">//打印uboot代码段信息（开启debug）</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_PPC) || defined(CONFIG_SH) || defined(CONFIG_X86)</span></span><br><span class="line">        checkcpu,   <span class="comment">//未实现</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_DISPLAY_CPUINFO)</span></span><br><span class="line">        print_cpuinfo,          <span class="comment">//CPU:   Allwinner Family</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_DTB_RESELECT)</span></span><br><span class="line">        embedded_dtb_select,    <span class="comment">//未实现</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_DISPLAY_BOARDINFO)</span></span><br><span class="line">        show_board_info,	<span class="comment">//打印板子信息 ：Model: sun50iw9</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_INIT</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_MISC_INIT_F)</span></span><br><span class="line">        misc_init_f,		<span class="comment">//misc driver初始化</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SYS_I2C)</span></span><br><span class="line">        init_func_i2c,		<span class="comment">//调用i2c_init_all，i2c driver初始化</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_VID) &amp;&amp; !defined(CONFIG_SPL)</span></span><br><span class="line">        init_func_vid,	<span class="comment">//未实现</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_HARD_SPI)</span></span><br><span class="line">        init_func_spi,		<span class="comment">//spi driver初始化（未实现）</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_OPTEE25)</span></span><br><span class="line">        smc_init,   <span class="comment">//若有安全系统，获取sunxi_smc_call_offset</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        announce_dram_init,		<span class="comment">//打印要对dram初始化：DRAM:  </span></span><br><span class="line">        dram_init,              <span class="comment">/* 将dram信息保存在gd中 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_POST	<span class="comment">//CONFIG_POST不使用</span></span></span><br><span class="line">        post_init_f,	</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SYS_DRAM_TEST)</span></span><br><span class="line">        testdram,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_SYS_DRAM_TEST */</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_POST</span></span><br><span class="line">        init_post,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Now that we have DRAM mapped and working, we can</span></span><br><span class="line"><span class="comment">         * relocate the code and continue running from DRAM.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Reserve memory at end of RAM for (top down in that order):</span></span><br><span class="line"><span class="comment">         *  - area that won&#x27;t get touched by U-Boot and Linux (optional)</span></span><br><span class="line"><span class="comment">         *  - kernel log buffer</span></span><br><span class="line"><span class="comment">         *  - protected RAM</span></span><br><span class="line"><span class="comment">         *  - LCD framebuffer</span></span><br><span class="line"><span class="comment">         *  - monitor code</span></span><br><span class="line"><span class="comment">         *  - board info struct</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        setup_dest_addr,	<span class="comment">//获取uboot重定位地址</span></span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//在ddr高地址处留出空间</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PRAM</span></span><br><span class="line">        reserve_pram,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        reserve_round_4k,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARM</span></span><br><span class="line">        reserve_mmu,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        reserve_video,</span><br><span class="line">        reserve_trace,</span><br><span class="line">        reserve_uboot,</span><br><span class="line">        reserve_malloc,</span><br><span class="line">        reserve_board,</span><br><span class="line">        setup_machine,</span><br><span class="line">        reserve_global_data,</span><br><span class="line">        reserve_fdt,</span><br><span class="line">        reserve_bootstage,</span><br><span class="line">        reserve_arch,</span><br><span class="line">        reserve_stacks,</span><br><span class="line">        dram_init_banksize,</span><br><span class="line">        show_dram_config,	<span class="comment">//debug打印dram区信息</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_M68K) || defined(CONFIG_MIPS) || defined(CONFIG_PPC) || \</span></span><br><span class="line"><span class="meta">        defined(CONFIG_SH)</span></span><br><span class="line">        setup_board_part1,	<span class="comment">//保存DRAM的地址信息到gd-&gt;bd</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_PPC) || defined(CONFIG_M68K)</span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">        setup_board_part2,	<span class="comment">//保存时钟信息到gd-&gt;bd</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        display_new_sp,		<span class="comment">//打印sp</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_OF_BOARD_FIXUP</span></span><br><span class="line">        fix_fdt,	<span class="comment">//未实现</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">        reloc_fdt,		<span class="comment">//设备树重定位:把设备树复制到新地址</span></span><br><span class="line">        reloc_bootstage,	<span class="comment">//把bootstage复制到新地址</span></span><br><span class="line">        setup_reloc,	<span class="comment">//计算Relocation Offset, 把gd拷贝到新地址</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_ARM) &amp;&amp; !defined(CONFIG_SANDBOX) &amp;&amp; \</span></span><br><span class="line"><span class="meta">                !CONFIG_IS_ENABLED(X86_64)</span></span><br><span class="line">        jump_to_copy,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">board_init_f</span><span class="params">(ulong boot_flags)</span></span><br><span class="line">&#123;</span><br><span class="line">        gd-&gt;flags = boot_flags;</span><br><span class="line">        gd-&gt;have_console = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (initcall_run_list(init_sequence_f))</span><br><span class="line">                hang();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_ARM) &amp;&amp; !defined(CONFIG_SANDBOX) &amp;&amp; \</span></span><br><span class="line"><span class="meta">                !defined(CONFIG_EFI_APP) &amp;&amp; !CONFIG_IS_ENABLED(X86_64) &amp;&amp; \</span></span><br><span class="line"><span class="meta">                !defined(CONFIG_ARC)</span></span><br><span class="line">        <span class="comment">/* NOTREACHED - jump_to_copy() does not return */</span></span><br><span class="line">        hang();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>lib&#x2F;initcall.c:initcall_run_list</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">DECLARE_GLOBAL_DATA_PTR;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">initcall_run_list</span><span class="params">(<span class="type">const</span> <span class="type">init_fnc_t</span> init_sequence[])</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">init_fnc_t</span> *init_fnc_ptr;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (init_fnc_ptr = init_sequence; *init_fnc_ptr; ++init_fnc_ptr) &#123;</span><br><span class="line">                <span class="type">unsigned</span> <span class="type">long</span> reloc_ofs = <span class="number">0</span>;</span><br><span class="line">                <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (gd-&gt;flags &amp; GD_FLG_RELOC)</span><br><span class="line">                        reloc_ofs = gd-&gt;reloc_off;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_EFI_APP</span></span><br><span class="line">                reloc_ofs = (<span class="type">unsigned</span> <span class="type">long</span>)image_base;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                debug(<span class="string">&quot;initcall: %p&quot;</span>, (<span class="type">char</span> *)*init_fnc_ptr - reloc_ofs);</span><br><span class="line">                <span class="keyword">if</span> (gd-&gt;flags &amp; GD_FLG_RELOC)</span><br><span class="line">                        debug(<span class="string">&quot; (relocated to %p)\n&quot;</span>, (<span class="type">char</span> *)*init_fnc_ptr);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                        debug(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                ret = (*init_fnc_ptr)();	<span class="comment">//执行函数指针</span></span><br><span class="line">                <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">&quot;initcall sequence %p failed at call %p (err=%d)\n&quot;</span>,</span><br><span class="line">                               init_sequence,</span><br><span class="line">                               (<span class="type">char</span> *)*init_fnc_ptr - reloc_ofs, ret);</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="relocate-code-relocate-vectors"><a href="#relocate-code-relocate-vectors" class="headerlink" title="relocate_code &amp; relocate_vectors"></a>relocate_code &amp; relocate_vectors</h5><p>代码重定位，为啥需要重定位代码？为kernel让出位置；将flash上的代码移动到dram上</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">panrunxins@AwExdroid100:~/longan/brandy/brandy<span class="number">-2.0</span>/u-boot<span class="number">-2018</span>/arch/arm/lib$ cat relocate.S</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm-offsets.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;config.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;elf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/linkage.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CPU_V7M</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/armv7m.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Default/weak exception vectors relocation routine</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This routine covers the standard ARM cases: normal (0x00000000),</span></span><br><span class="line"><span class="comment"> * high (0xffff0000) and VBAR. SoCs which do not comply with any of</span></span><br><span class="line"><span class="comment"> * the standard cases must provide their own, strong, version.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">        .section        .text.relocate_vectors,<span class="string">&quot;ax&quot;</span>,%progbits</span><br><span class="line">        .weak           relocate_vectors</span><br><span class="line"></span><br><span class="line"><span class="title function_">ENTRY</span><span class="params">(relocate_vectors)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CPU_V7M</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * On ARMv7-M we only have to write the new vector address</span></span><br><span class="line"><span class="comment">         * to VTOR register.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ldr     r0, [r9, #GD_RELOCADDR] <span class="comment">/* r0 = gd-&gt;relocaddr */</span></span><br><span class="line">        ldr     r1, =V7M_SCB_BASE</span><br><span class="line">        str     r0, [r1, V7M_SCB_VTOR]</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_HAS_VBAR</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * If the ARM processor has the security extensions,</span></span><br><span class="line"><span class="comment">         * use VBAR to relocate the exception vectors.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARCH_SUNXI</span></span><br><span class="line">        ldr     r0, =_start</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        ldr     r0, [r9, #GD_RELOCADDR] <span class="comment">/* r0 = gd-&gt;relocaddr */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c12, c0, <span class="number">0</span>  <span class="comment">/* Set VBAR */</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Copy the relocated exception vectors to the</span></span><br><span class="line"><span class="comment">         * correct address</span></span><br><span class="line"><span class="comment">         * CP15 c1 V bit gives us the location of the vectors:</span></span><br><span class="line"><span class="comment">         * 0x00000000 or 0xFFFF0000.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ldr     r0, [r9, #GD_RELOCADDR] <span class="comment">/* r0 = gd-&gt;relocaddr */</span></span><br><span class="line">        mrc     p15, <span class="number">0</span>, r2, c1, c0, <span class="number">0</span>   <span class="comment">/* V bit (bit[13]) in CP15 c1 */</span></span><br><span class="line">        ands    r2, r2, #(<span class="number">1</span> &lt;&lt; <span class="number">13</span>)</span><br><span class="line">        ldreq   r1, =<span class="number">0x00000000</span>         <span class="comment">/* If V=0 */</span></span><br><span class="line">        ldrne   r1, =<span class="number">0xFFFF0000</span>         <span class="comment">/* If V=1 */</span></span><br><span class="line">        ldmia   r0!, &#123;r2-r8,r10&#125;</span><br><span class="line">        stmia   r1!, &#123;r2-r8,r10&#125;</span><br><span class="line">        ldmia   r0!, &#123;r2-r8,r10&#125;</span><br><span class="line">        stmia   r1!, &#123;r2-r8,r10&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        bx      lr</span><br><span class="line"></span><br><span class="line">ENDPROC(relocate_vectors)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * void relocate_code(addr_moni)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function relocates the monitor code.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span></span></span><br><span class="line"><span class="comment"> * To prevent the code below from containing references with an R_ARM_ABS32</span></span><br><span class="line"><span class="comment"> * relocation record type, we never refer to linker-defined symbols directly.</span></span><br><span class="line"><span class="comment"> * Instead, we declare literals which contain their relative location with</span></span><br><span class="line"><span class="comment"> * respect to relocate_code, and at run time, add relocate_code back to them.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">ENTRY(relocate_code)	<span class="comment">//__image_copy_start可能是uboot最初的起始地址，__image_copy_end是结束地址</span></span><br><span class="line">        ldr     r1, =__image_copy_start <span class="comment">/* r1 &lt;- SRC &amp;__image_copy_start */</span></span><br><span class="line">        subs    r4, r0, r1              <span class="comment">/* r4 &lt;- relocation offset */</span> <span class="comment">//计算重定位后的偏移</span></span><br><span class="line">        beq     relocate_done           <span class="comment">/* skip relocation */</span></span><br><span class="line">        ldr     r2, =__image_copy_end   <span class="comment">/* r2 &lt;- SRC &amp;__image_copy_end */</span></span><br><span class="line">		<span class="comment">//r1保存uboot复制的起始地址，r2保存复制的结束地址，r0是重定位地址</span></span><br><span class="line">copy_loop:</span><br><span class="line">        ldmia   r1!, &#123;r10-r11&#125;          <span class="comment">/* copy from source address [r1]    */</span></span><br><span class="line">        stmia   r0!, &#123;r10-r11&#125;          <span class="comment">/* copy to   target address [r0]    */</span></span><br><span class="line">        cmp     r1, r2                  <span class="comment">/* until source end address [r2]    */</span></span><br><span class="line">        blo     copy_loop</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * fix .rel.dyn relocations</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ldr     r2, =__rel_dyn_start    <span class="comment">/* r2 &lt;- SRC &amp;__rel_dyn_start */</span></span><br><span class="line">        ldr     r3, =__rel_dyn_end      <span class="comment">/* r3 &lt;- SRC &amp;__rel_dyn_end */</span></span><br><span class="line">fixloop:							<span class="comment">//r2指向重定位表地址，r0=r2</span></span><br><span class="line">        ldmia   r2!, &#123;r0-r1&#125;            <span class="comment">/* (r0,r1) &lt;- (SRC location,fixup) */</span></span><br><span class="line">        and     r1, r1, #<span class="number">0xff</span>			<span class="comment">//r1中的内容是什么，重定位入口类型和符号，参考：http://blog.chinaunix.net/uid-30546860-id-5589966.html</span></span><br><span class="line">        cmp     r1, #R_ARM_RELATIVE		<span class="comment">//判断重定位入口类型</span></span><br><span class="line">        bne     fixnext</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* relative fix: increase location by offset */</span></span><br><span class="line">        add     r0, r0, r4		<span class="comment">//r4 is offset，得到新的重定位表地址</span></span><br><span class="line">        ldr     r1, [r0]		<span class="comment">//[r0]是需要重定位的符号的地址，把该地址里的值写入r1(这个就是需要修改的绝对地址)</span></span><br><span class="line">        add     r1, r1, r4		<span class="comment">//r1+=r4，就是重定位的过程</span></span><br><span class="line">        str     r1, [r0]		<span class="comment">//再把r1写回 需要重定位的符号的地址</span></span><br><span class="line">fixnext:</span><br><span class="line">        cmp     r2, r3			<span class="comment">//判断重定位段是否结束</span></span><br><span class="line">        blo     fixloop</span><br><span class="line"></span><br><span class="line">relocate_done:</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __XSCALE__</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * On xscale, icache must be invalidated and write buffers drained,</span></span><br><span class="line"><span class="comment">         * even with cache disabled - 4.2.7 of xscale core developer&#x27;s manual</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c7, c7, <span class="number">0</span>   <span class="comment">/* invalidate icache */</span></span><br><span class="line">        mcr     p15, <span class="number">0</span>, r0, c7, c10, <span class="number">4</span>  <span class="comment">/* drain write buffer */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* ARMv4- don&#x27;t know bx lr but the assembler fails to see that */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __ARM_ARCH_4__</span></span><br><span class="line">        mov     pc, lr</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        bx      lr</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">ENDPROC(relocate_code)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="board-init-r"><a href="#board-init-r" class="headerlink" title="board_init_r()"></a>board_init_r()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">board_init_r</span><span class="params">(<span class="type">gd_t</span> *new_gd, ulong dest_addr)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NEEDS_MANUAL_RELOC</span></span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        gd-&gt;flags &amp;= ~GD_FLG_LOG_READY;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NEEDS_MANUAL_RELOC</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(init_sequence_r); i++)</span><br><span class="line">                init_sequence_r[i] += gd-&gt;reloc_off;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (initcall_run_list(init_sequence_r))</span><br><span class="line">                hang();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* NOTREACHED - run_main_loop() does not return */</span></span><br><span class="line">        hang();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//init_sequence_r</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Over time we hope to remove these functions with code fragments and</span></span><br><span class="line"><span class="comment"> * stub functions, and instead call the relevant function directly.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * We also hope to remove most of the driver-related init and do it if/when</span></span><br><span class="line"><span class="comment"> * the driver is later used.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">TODO:</span> perhaps reset the watchdog in the initcall function after each call?</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">init_fnc_t</span> init_sequence_r[] = &#123;</span><br><span class="line">        initr_trace,</span><br><span class="line">        initr_reloc,	<span class="comment">//设置重定位完成的标志，设置设备树地址到环境变量fdtaddr</span></span><br><span class="line">        <span class="comment">/* <span class="doctag">TODO:</span> could x86/PPC have this also perhaps? */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARM</span></span><br><span class="line">        initr_caches,	<span class="comment">//初始化smp、使能caches</span></span><br><span class="line">        <span class="comment">/* Note: For Freescale LS2 SoCs, new MMU table is created in DDR.</span></span><br><span class="line"><span class="comment">         *       A temporary mapping of IFC high region is since removed,</span></span><br><span class="line"><span class="comment">         *       so environmental variables in NOR flash is not available</span></span><br><span class="line"><span class="comment">         *       until board_init() is called below to remap IFcd -C to high</span></span><br><span class="line"><span class="comment">         *       region.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        initr_reloc_global_data,	<span class="comment">// monitor_flash_len = _end - __image_copy_start;??</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SYS_INIT_RAM_LOCK) &amp;&amp; defined(CONFIG_E500)</span></span><br><span class="line">        initr_unlock_ram_in_cache,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        initr_barrier,	<span class="comment">//略</span></span><br><span class="line">        initr_malloc,	<span class="comment">//初始化堆?设置堆内存为0</span></span><br><span class="line">        log_init,</span><br><span class="line">        initr_bootstage,      <span class="comment">//bootstage是一个记录启动阶段的模块  /* Needs malloc() but has its own timer */</span></span><br><span class="line">        initr_console_record,	<span class="comment">//初始化一个收发的内存来处理控制台</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYS_NONCACHED_MEMORY</span></span><br><span class="line">        initr_noncached,	<span class="comment">//no used</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        bootstage_relocate,		<span class="comment">//bootstage_relocate重定位，看不懂代码</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_OF_LIVE</span></span><br><span class="line">        initr_of_live,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DM</span></span><br><span class="line">        initr_dm, 	<span class="comment">//NO USED</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_ARM) || defined(CONFIG_NDS32) || defined(CONFIG_RISCV)</span></span><br><span class="line">        board_init,    <span class="comment">//判断boot触发源，设置外设电源电压，设置corepll频率</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * <span class="doctag">TODO:</span> printing of the clock inforamtion of the board is now</span></span><br><span class="line"><span class="comment">         * implemented as part of bdinfo command. Currently only support for</span></span><br><span class="line"><span class="comment">         * davinci SOC&#x27;s is added. Remove this check once all the board</span></span><br><span class="line"><span class="comment">         * implement this.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CLOCKS</span></span><br><span class="line">        set_cpu_clk_info, <span class="comment">/* Setup clock information */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_EFI_LOADER</span></span><br><span class="line">        efi_memory_init,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        stdio_init_tables,	<span class="comment">//看不懂？初始化标准输出的表格</span></span><br><span class="line">        initr_serial,	<span class="comment">//注册所有串口驱动到serial core，并设置一个默认的驱动</span></span><br><span class="line">        initr_announce,		<span class="comment">//debug打印</span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET	<span class="comment">//看门狗复位？为什么需要看门狗复位</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NEEDS_MANUAL_RELOC</span></span><br><span class="line">        initr_manual_reloc_cmdtable,    </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_PPC) || defined(CONFIG_M68K) || defined(CONFIG_MIPS)</span></span><br><span class="line">        initr_trap,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ADDR_MAP</span></span><br><span class="line">        initr_addr_map,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_LEDC</span></span><br><span class="line">        initr_ledc,             <span class="comment">//通过设备树获取ledc的资源，然后初始化，设置亮度</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET        <span class="comment">//看门狗复位</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_POST</span></span><br><span class="line">        initr_post_backlog,    	<span class="comment">//未使用</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_PCI) &amp;&amp; defined(CONFIG_SYS_EARLY_PCI_INIT)</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Do early PCI configuration _before_ the flash gets initialised,</span></span><br><span class="line"><span class="comment">         * because PCU resources are crucial for flash access on some boards.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        initr_pci,      <span class="comment">//枚举pcie控制器？？</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARCH_EARLY_INIT_R</span></span><br><span class="line">        arch_early_init_r,      <span class="comment">//ARCH相关初始化（未使用到）</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        power_init_board,       <span class="comment">//板子电源初始化（返回0）</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MTD_NOR_FLASH</span></span><br><span class="line">        initr_flash,    <span class="comment">//初始化nor flash 好像没有使用? flash_init();</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_PPC) || defined(CONFIG_M68K) || defined(CONFIG_X86)</span></span><br><span class="line">        <span class="comment">/* initialize higher level parts of CPU like time base and timers */</span></span><br><span class="line">        cpu_init_r,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PPC</span></span><br><span class="line">        initr_spi,      <span class="comment">//初始化spi spi_init_r();未找到定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMD_NAND	<span class="comment">//（未使用）</span></span></span><br><span class="line">        initr_nand,     <span class="comment">//初始化nand flash nand_init();</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMD_ONENAND	<span class="comment">//（未使用）</span></span></span><br><span class="line">        initr_onenand,  <span class="comment">//onenand_init();？</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MMC</span></span><br><span class="line">        initr_mmc,      <span class="comment">//int mmc_initialize(bd_t *bis)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYS_BOOTPARAMS_LEN</span></span><br><span class="line">        initr_malloc_bootparams,        <span class="comment">//gd-&gt;bd-&gt;bi_boot_params = (ulong)malloc(CONFIG_SYS_BOOTPARAMS_LEN); 为boot参数申请动态内存</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">        initr_secondary_cpu,    <span class="comment">//啥也没干</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_ID_EEPROM) || defined(CONFIG_SYS_I2C_MAC_OFFSET)</span></span><br><span class="line">        mac_read_from_eeprom,   <span class="comment">//读取eeprom的mac地址（不支持）</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_PCI) &amp;&amp; !defined(CONFIG_SYS_EARLY_PCI_INIT)</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Do pci configuration</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        initr_pci,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        stdio_add_devices,      <span class="comment">//标准输入输出初始化：键盘、lcd、音频、视频等</span></span><br><span class="line">        initr_jumptable,        <span class="comment">//gd-&gt;jt = malloc(sizeof(struct jt_funcs)); 给jumptable分配动态内存</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_API</span></span><br><span class="line">        initr_api,      <span class="comment">//api_init() uboot的编程接口</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        console_init_r,         <span class="comment">//选择控制台的输入输出设备/* fully init console as a device */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DISPLAY_BOARDINFO_LATE</span></span><br><span class="line">        console_announce_r,</span><br><span class="line">        show_board_info,        <span class="comment">//打印平台信息（从设备树获取） Model: sun50iw9</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARCH_MISC_INIT</span></span><br><span class="line">        arch_misc_init,        <span class="comment">//未使用 /* miscellaneous arch-dependent init */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MISC_INIT_R	<span class="comment">//未使用</span></span></span><br><span class="line">        misc_init_r,           <span class="comment">//初始化usb以太网？ /* miscellaneous platform-dependent init */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMD_KGDB</span></span><br><span class="line">        initr_kgdb,     <span class="comment">//kernel gdb调试 主要是初始化串口和回调函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        interrupt_init, <span class="comment">//中断初始化 设置中断使用的栈。根据gd</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARM</span></span><br><span class="line">        initr_enable_interrupts,        <span class="comment">//使能中断</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_FAST_BURN_KEY</span></span><br><span class="line">        sunxi_fast_burn_key,    <span class="comment">//usb烧key</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARCH_SUNXI</span></span><br><span class="line">        initr_sunxi_plat,       <span class="comment">//ir初始化、读取按键值、flash初始化、pwm_led初始化、开机logo、gpt更新、烧写rotpk</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        initr_env,              <span class="comment">//load the environment 加载环境？？</span></span><br><span class="line">        board_env_late_init,    <span class="comment">//安全存储、keybox初始化</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_MICROBLAZE) || defined(CONFIG_M68K)</span></span><br><span class="line">        timer_init,             <span class="comment">/* initialize timer */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_LED_STATUS)</span></span><br><span class="line">        initr_status_led,       <span class="comment">//初始化led状态</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">/* PPC has a udelay(20) here dating from 2002. Why? */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMD_NET</span></span><br><span class="line">        initr_ethaddr,  <span class="comment">//从环境变量获取以太网地址？</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARCH_SUNXI</span></span><br><span class="line">        sunxi_burn_key, <span class="comment">//进入auto fel后并进入烧key</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BOARD_LATE_INIT</span></span><br><span class="line">        board_late_init,        <span class="comment">//板子初始化</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SCSI) &amp;&amp; !defined(CONFIG_DM_SCSI)</span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">        initr_scsi,     <span class="comment">//初始化小型计算机系统接口</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BITBANGMII</span></span><br><span class="line">        initr_bbmii,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMD_NET</span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">        initr_net,      <span class="comment">//调用eth_initialize();初始化所有以太网</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_POST</span></span><br><span class="line">        initr_post,     <span class="comment">//post_run(NULL, POST_RAM | post_bootmode_get(0));</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_CMD_PCMCIA) &amp;&amp; !defined(CONFIG_IDE)</span></span><br><span class="line">        initr_pcmcia,   <span class="comment">//??</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_IDE)</span></span><br><span class="line">        initr_ide,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_LAST_STAGE_INIT</span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Some parts can be only initialized if all others (like</span></span><br><span class="line"><span class="comment">         * Interrupts) are up and running (i.e. the PC-style ISA</span></span><br><span class="line"><span class="comment">         * keyboard).</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        last_stage_init,        <span class="comment">//未使用</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMD_BEDBUG</span></span><br><span class="line">        INIT_FUNC_WATCHDOG_RESET</span><br><span class="line">        initr_bedbug,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_PRAM)</span></span><br><span class="line">        initr_mem,      <span class="comment">//更新mem环境变量的值（mem大小？）</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SOUND_SUNXI_BOOT_TONE</span></span><br><span class="line">        sunxi_boot_tone_play,   <span class="comment">//播放开机音乐</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        run_main_loop,  <span class="comment">//跳转到main loop</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* Record the board_init_f() bootstage (after arch_cpu_init()) */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">initf_bootstage</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">bool</span> from_spl = IS_ENABLED(CONFIG_SPL_BOOTSTAGE) &amp;&amp;</span><br><span class="line">                        IS_ENABLED(CONFIG_BOOTSTAGE_STASH);</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">        ret = bootstage_init(!from_spl);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">        <span class="keyword">if</span> (from_spl) &#123;</span><br><span class="line">                <span class="type">const</span> <span class="type">void</span> *stash = map_sysmem(CONFIG_BOOTSTAGE_STASH_ADDR,</span><br><span class="line">                                               CONFIG_BOOTSTAGE_STASH_SIZE);</span><br><span class="line"></span><br><span class="line">                ret = bootstage_unstash(stash, CONFIG_BOOTSTAGE_STASH_SIZE);</span><br><span class="line">                <span class="keyword">if</span> (ret &amp;&amp; ret != -ENOENT) &#123;</span><br><span class="line">                        debug(<span class="string">&quot;Failed to unstash bootstage: err=%d\n&quot;</span>, ret);</span><br><span class="line">                        <span class="keyword">return</span> ret;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        bootstage_mark_name(BOOTSTAGE_ID_START_UBOOT_F, <span class="string">&quot;board_init_f&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">initf_dm</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_DM) &amp;&amp; CONFIG_VAL(SYS_MALLOC_F_LEN)</span></span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">        bootstage_start(BOOTSTATE_ID_ACCUM_DM_F, <span class="string">&quot;dm_f&quot;</span>);</span><br><span class="line">        ret = dm_init_and_scan(<span class="literal">true</span>);</span><br><span class="line">        bootstage_accum(BOOTSTATE_ID_ACCUM_DM_F);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_TIMER_EARLY</span></span><br><span class="line">        ret = dm_timer_init();</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">env_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">env_driver</span> *<span class="title">drv</span>;</span></span><br><span class="line">        <span class="type">int</span> ret = -ENOENT;</span><br><span class="line">        <span class="type">int</span> prio;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (prio = <span class="number">0</span>; (drv = env_driver_lookup(ENVOP_INIT, prio)); prio++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!drv-&gt;init || !(ret = drv-&gt;init()))</span><br><span class="line">                        env_set_inited(drv-&gt;location);</span><br><span class="line"></span><br><span class="line">                debug(<span class="string">&quot;%s: Environment %s init done (ret=%d)\n&quot;</span>, __func__,</span><br><span class="line">                      drv-&gt;name, ret);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!prio)</span><br><span class="line">                <span class="keyword">return</span> -ENODEV;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ret == -ENOENT) &#123;</span><br><span class="line">                gd-&gt;env_addr = (ulong)&amp;default_environment[<span class="number">0</span>];</span><br><span class="line">                gd-&gt;env_valid = ENV_VALID;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* Called before relocation - use serial functions */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">console_init_f</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        gd-&gt;have_console = <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> debug_mode;</span><br><span class="line">        console_update_silent();</span><br><span class="line">        <span class="keyword">if</span> (get_boot_work_mode() == WORK_MODE_BOOT)</span><br><span class="line">                <span class="keyword">if</span> (uboot_spare_head.boot_data.debug_mode &amp; <span class="number">0x80</span>) <span class="comment">/* bit7 is one, means boot0 want to set debug_mode */</span></span><br><span class="line">                        debug_mode = uboot_spare_head.boot_data.debug_mode &amp; <span class="number">0x7F</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="comment">/* dts */</span></span><br><span class="line">                        script_parser_fetch(<span class="string">&quot;/soc/platform&quot;</span>, <span class="string">&quot;debug_mode&quot;</span>, &amp;debug_mode, <span class="number">4</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                debug_mode = <span class="number">8</span>;</span><br><span class="line">        gd-&gt;debug_mode = debug_mode;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_IS_ENABLED(PRE_CONSOLE_BUFFER)</span></span><br><span class="line">        <span class="built_in">memset</span>((<span class="type">char</span> *)(CONFIG_PRE_CON_BUF_ADDR + gd-&gt;precon_buf_idx), <span class="number">0</span>, CONFIG_PRE_CON_BUF_SZ - gd-&gt;precon_buf_idx);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        print_pre_console_buffer(PRE_CONSOLE_FLUSHPOINT1_SERIAL);	<span class="comment">//打印一些什么信息？</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">dram_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        uint dram_size = <span class="number">0</span>;</span><br><span class="line">        dram_size = uboot_spare_head.boot_data.dram_scan_size;</span><br><span class="line"></span><br><span class="line">        dram_size = dram_size &gt; <span class="number">2048</span> ? <span class="number">2048</span> : dram_size;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(dram_size)</span><br><span class="line">                gd-&gt;ram_size = dram_size * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                gd-&gt;ram_size = get_ram_size((<span class="type">long</span> *)PHYS_SDRAM_0, PHYS_SDRAM_0_SIZE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">setup_dest_addr</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        debug(<span class="string">&quot;Monitor len: %08lX\n&quot;</span>, gd-&gt;mon_len);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Ram is setup, size stored in gd !!</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        debug(<span class="string">&quot;Ram size: %08lX\n&quot;</span>, (ulong)gd-&gt;ram_size);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SYS_MEM_TOP_HIDE)</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Subtract specified amount of memory to hide so that it won&#x27;t</span></span><br><span class="line"><span class="comment">         * get &quot;touched&quot; at all by U-Boot. By fixing up gd-&gt;ram_size</span></span><br><span class="line"><span class="comment">         * the Linux kernel should now get passed the now &quot;corrected&quot;</span></span><br><span class="line"><span class="comment">         * memory size and won&#x27;t touch it either. This should work</span></span><br><span class="line"><span class="comment">         * for arch/ppc and arch/powerpc. Only Linux board ports in</span></span><br><span class="line"><span class="comment">         * arch/powerpc with bootwrapper support, that recalculate the</span></span><br><span class="line"><span class="comment">         * memory size from the SDRAM controller setup will have to</span></span><br><span class="line"><span class="comment">         * get fixed.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        gd-&gt;ram_size -= CONFIG_SYS_MEM_TOP_HIDE;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYS_SDRAM_BASE</span></span><br><span class="line">        gd-&gt;ram_top = CONFIG_SYS_SDRAM_BASE;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        gd-&gt;ram_top += get_effective_memsize();</span><br><span class="line">        gd-&gt;ram_top = board_get_usable_ram_top(gd-&gt;mon_len);</span><br><span class="line">        gd-&gt;relocaddr = gd-&gt;ram_top;</span><br><span class="line">        debug(<span class="string">&quot;Ram top: %08lX\n&quot;</span>, (ulong)gd-&gt;ram_top);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_MP) &amp;&amp; (defined(CONFIG_MPC86xx) || defined(CONFIG_E500))</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * We need to make sure the location we intend to put secondary core</span></span><br><span class="line"><span class="comment">         * boot code is reserved and not used by any part of u-boot</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (gd-&gt;relocaddr &gt; determine_mp_bootpg(<span class="literal">NULL</span>)) &#123;</span><br><span class="line">                gd-&gt;relocaddr = determine_mp_bootpg(<span class="literal">NULL</span>);</span><br><span class="line">                debug(<span class="string">&quot;Reserving MP boot page to %08lx\n&quot;</span>, gd-&gt;relocaddr);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">reloc_fdt</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_OF_EMBED</span></span><br><span class="line">        <span class="keyword">if</span> (gd-&gt;flags &amp; GD_FLG_SKIP_RELOC)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (gd-&gt;new_fdt) &#123;</span><br><span class="line">                <span class="built_in">memcpy</span>(gd-&gt;new_fdt, gd-&gt;fdt_blob, gd-&gt;fdt_size);</span><br><span class="line">                gd-&gt;fdt_blob = gd-&gt;new_fdt;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">setup_reloc</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (gd-&gt;flags &amp; GD_FLG_SKIP_RELOC) &#123;</span><br><span class="line">                debug(<span class="string">&quot;Skipping relocation due to flag\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYS_TEXT_BASE</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_ARM) || defined(CONFIG_RISCV)</span></span><br><span class="line">        gd-&gt;reloc_off = gd-&gt;relocaddr - (<span class="type">unsigned</span> <span class="type">long</span>)__image_copy_start;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(CONFIG_M68K)</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * On all ColdFire arch cpu, monitor code starts always</span></span><br><span class="line"><span class="comment">         * just after the default vector table location, so at 0x400</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        gd-&gt;reloc_off = gd-&gt;relocaddr - (CONFIG_SYS_TEXT_BASE + <span class="number">0x400</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        gd-&gt;reloc_off = gd-&gt;relocaddr - CONFIG_SYS_TEXT_BASE;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="built_in">memcpy</span>(gd-&gt;new_gd, (<span class="type">char</span> *)gd, <span class="keyword">sizeof</span>(<span class="type">gd_t</span>));</span><br><span class="line"></span><br><span class="line">        tick_printf(<span class="string">&quot;Relocation Offset is: %08lx\n&quot;</span>, gd-&gt;reloc_off);</span><br><span class="line">        debug(<span class="string">&quot;Relocating to %08lx, new gd at %08lx, sp at %08lx\n&quot;</span>,</span><br><span class="line">              gd-&gt;relocaddr, (ulong)map_to_sysmem(gd-&gt;new_gd),</span><br><span class="line">              gd-&gt;start_addr_sp);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">axp_gpio_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">udevice</span> *<span class="title">dev</span>;</span></span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">        ret = pmic_bus_init();</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* There is no devicetree support for the axp yet, so bind directly */</span></span><br><span class="line">        ret = device_bind_driver(dm_root(), <span class="string">&quot;gpio_axp&quot;</span>, <span class="string">&quot;AXP-gpio&quot;</span>, &amp;dev);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sunxi_plat_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        sunxi_probe_securemode();	<span class="comment">//检查安全模式</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_DMA</span></span><br><span class="line">        sunxi_dma_init();	<span class="comment">//dma初始化</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARM</span></span><br><span class="line">    	<span class="comment">//安全相关的</span></span><br><span class="line">        <span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">secure_os_memory_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (sunxi_probe_secure_os()) &#123;</span><br><span class="line">                smc_tee_inform_fdt((<span class="type">uint64_t</span>)(<span class="type">unsigned</span> <span class="type">long</span>)working_fdt, gd-&gt;fdt_size);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SUNXI_EXTERN_SECURE_MM_LAYOUT)</span></span><br><span class="line">                secure_os_memory_init();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* add board specific code here */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">board_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        __maybe_unused <span class="type">int</span> id_pfr1, ret, satapwr_pin, macpwr_pin;</span><br><span class="line"></span><br><span class="line">        gd-&gt;bd-&gt;bi_boot_params = (PHYS_SDRAM_0 + <span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">        sunxi_plat_init();	<span class="comment">//检测secure os</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> work_mode = get_boot_work_mode();	<span class="comment">//通过uboot首部数据获取uboot工作模式</span></span><br><span class="line"></span><br><span class="line">        ret = axp_gpio_init();	<span class="comment">//axp驱动加载 AXP是电源管理的芯片</span></span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_POWER</span></span><br><span class="line">        <span class="keyword">if</span> (!axp_probe()) &#123;</span><br><span class="line">            	<span class="comment">//检查到电源保护芯片</span></span><br><span class="line">                axp_set_dcdc_mode();	<span class="comment">//设置dcdc pwm模式</span></span><br><span class="line">                axp_set_power_supply_output();	<span class="comment">//通过pmu设置设备树其他外设的电压</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined CONFIG_SUNXI_BMU &amp;&amp; !defined CONFIG_AXP_LATE_INFO</span></span><br><span class="line">            	<span class="comment">//获取boot的触发源（按键、还是插电），通过读取bmu芯片的寄存器。</span></span><br><span class="line">                gd-&gt;pmu_saved_status = bmu_get_poweron_source();	</span><br><span class="line">                gd-&gt;pmu_runtime_chgcur = axp_get_battery_status();	<span class="comment">//通过bmu获取电池电压</span></span><br><span class="line">				</span><br><span class="line">            	<span class="comment">//WORK_MODE_BOOT就是正常的boot启动</span></span><br><span class="line">                <span class="keyword">if</span> (work_mode != WORK_MODE_BOOT) &#123;</span><br><span class="line">                        ret = axp_reset_capacity();	<span class="comment">//通过bmu设置电池容量为0？</span></span><br><span class="line">                        <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">                                pr_msg(<span class="string">&quot;axp reset capacity fail!\n&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">                gd-&gt;pmu_saved_status = <span class="number">-1</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        rtc_set_dcxo_off();	<span class="comment">//关闭wifi</span></span><br><span class="line"></span><br><span class="line">    	<span class="comment">//正常启动、卡量产、卡启动</span></span><br><span class="line">        <span class="keyword">if</span> ((work_mode == WORK_MODE_BOOT) ||</span><br><span class="line">                (work_mode == WORK_MODE_CARD_PRODUCT) ||</span><br><span class="line">                (work_mode == WORK_MODE_CARD_UPDATE))</span><br><span class="line">                sunxi_set_sramc_mode();		<span class="comment">//看不懂？和平台相关</span></span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//获取设备树文件中boot_clock的值</span></span><br><span class="line">        <span class="type">int</span> boot_clock;	</span><br><span class="line">        script_parser_fetch(FDT_PATH_TARGET, <span class="string">&quot;boot_clock&quot;</span>, &amp;boot_clock, uboot_spare_head.boot_data.run_clock);</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//设置core pll频率</span></span><br><span class="line">        clock_set_corepll(boot_clock);</span><br><span class="line">        tick_printf(<span class="string">&quot;CPU=%d MHz,PLL6=%d Mhz,AHB=%d Mhz, APB1=%dMhz  MBus=%dMhz\n&quot;</span>,</span><br><span class="line">                clock_get_corepll(),</span><br><span class="line">                clock_get_pll6(), clock_get_ahb(),</span><br><span class="line">                clock_get_apb1(),clock_get_mbus());</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_OVERLAY</span></span><br><span class="line">        <span class="keyword">if</span> (get_boot_work_mode() != WORK_MODE_BOOT) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    	<span class="comment">//好像是设备树相关的？</span></span><br><span class="line">        <span class="keyword">if</span> (!sunxi_overlay_apply_merged(working_fdt, gd-&gt;new_dtbo)) &#123;</span><br><span class="line">                pr_err(<span class="string">&quot;sunxi overlay merged %sqv\n&quot;</span>,</span><br><span class="line">                        (fdt_overlay_apply_verbose(working_fdt, gd-&gt;new_dtbo) ? <span class="string">&quot;fail&quot;</span>:<span class="string">&quot;ok&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                pr_msg(<span class="string">&quot;not need merged sunxi overlay\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">mmc_initialize</span><span class="params">(<span class="type">bd_t</span> *bis)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !CONFIG_IS_ENABLED(BLK)</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !CONFIG_IS_ENABLED(MMC_TINY)</span></span><br><span class="line">        <span class="type">static</span> <span class="type">int</span> initialized;</span><br><span class="line">        <span class="keyword">if</span> (!initialized)       <span class="comment">/* Avoid initializing mmc multiple times */</span></span><br><span class="line">                mmc_list_init();        <span class="comment">//初始化mmc设备列表（设备描述符）</span></span><br><span class="line">        initialized = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        ret = mmc_probe(bis);   <span class="comment">//probe mmc设备</span></span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_SPL_BUILD</span></span><br><span class="line">        print_mmc_devices(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        mmc_do_preinit();       <span class="comment">//int mmc_start_init(struct mmc *mmc) 使用驱动程序初始化mmc</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">nand_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">uint32_t</span> val;</span><br><span class="line"></span><br><span class="line">        board_nand_init();      <span class="comment">//找不到</span></span><br><span class="line"></span><br><span class="line">        val = readl(SUNXI_NFC_BASE + NFC_CTL);</span><br><span class="line">        <span class="comment">/* enable and reset CTL */</span></span><br><span class="line">        writel(val | NFC_CTL_EN | NFC_CTL_RESET,</span><br><span class="line">               SUNXI_NFC_BASE + NFC_CTL);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!check_value_negated(SUNXI_NFC_BASE + NFC_CTL,</span><br><span class="line">                                 NFC_CTL_RESET, DEFAULT_TIMEOUT_US)) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Couldn&#x27;t initialize nand\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* reset NAND */</span></span><br><span class="line">        nand_exec_cmd(NFC_SEND_CMD1 | NFC_WAIT_FLAG | NAND_CMD_RESET);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">onenand_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> err = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;onenand_mtd, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> mtd_info));</span><br><span class="line">        <span class="built_in">memset</span>(&amp;onenand_chip, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> onenand_chip));</span><br><span class="line"></span><br><span class="line">        onenand_mtd.priv = &amp;onenand_chip;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_USE_ONENAND_BOARD_INIT</span></span><br><span class="line">        <span class="comment">/* It&#x27;s used for some board init required */</span></span><br><span class="line">        err = onenand_board_init(&amp;onenand_mtd);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        onenand_chip.base = (<span class="type">void</span> *) CONFIG_SYS_ONENAND_BASE;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!err &amp;&amp; !(onenand_scan(&amp;onenand_mtd, <span class="number">1</span>))) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (onenand_chip.device_id &amp; DEVICE_IS_FLEXONENAND)</span><br><span class="line">                        <span class="built_in">puts</span>(<span class="string">&quot;Flex-&quot;</span>);</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;OneNAND: &quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MTD_DEVICE</span></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * Add MTD device so that we can reference it later</span></span><br><span class="line"><span class="comment">                 * via the mtdcore infrastructure (e.g. ubi).</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                onenand_mtd.name = dev_name;</span><br><span class="line">                add_mtd_device(&amp;onenand_mtd);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        print_size(onenand_chip.chipsize, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//初始化一切的输入输出设备，主要是终端</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">stdio_add_devices</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DM_KEYBOARD</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">udevice</span> *<span class="title">dev</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">uclass</span> *<span class="title">uc</span>;</span></span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * For now we probe all the devices here. At some point this should be</span></span><br><span class="line"><span class="comment">         * done only when the devices are required - e.g. we have a list of</span></span><br><span class="line"><span class="comment">         * input devices to start up in the stdin environment variable. That</span></span><br><span class="line"><span class="comment">         * work probably makes more sense when stdio itself is converted to</span></span><br><span class="line"><span class="comment">         * driver model.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * TODO(sjg@chromium.org): Convert changing uclass_first_device() etc.</span></span><br><span class="line"><span class="comment">         * to return the device even on error. Then we could use that here.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ret = uclass_get(UCLASS_KEYBOARD, &amp;uc);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Don&#x27;t report errors to the caller - assume that they are non-fatal */</span></span><br><span class="line">        uclass_foreach_dev(dev, uc) &#123;</span><br><span class="line">                ret = device_probe(dev);</span><br><span class="line">                <span class="keyword">if</span> (ret)</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">&quot;Failed to probe keyboard &#x27;%s&#x27;\n&quot;</span>, dev-&gt;name);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DM_VIDEO</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * If the console setting is not in environment variables then</span></span><br><span class="line"><span class="comment">         * console_init_r() will not be calling iomux_doenv() (which calls</span></span><br><span class="line"><span class="comment">         * search_device()). So we will not dynamically add devices by</span></span><br><span class="line"><span class="comment">         * calling stdio_probe_device().</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * So just probe all video devices now so that whichever one is</span></span><br><span class="line"><span class="comment">         * required will be available.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_SYS_CONSOLE_IS_IN_ENV</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">udevice</span> *<span class="title">vdev</span>;</span></span><br><span class="line"><span class="meta"># <span class="keyword">ifndef</span> CONFIG_DM_KEYBOARD</span></span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ret = uclass_first_device(UCLASS_VIDEO, &amp;vdev);</span><br><span class="line">             vdev;</span><br><span class="line">             ret = uclass_next_device(&amp;vdev))</span><br><span class="line">                ;</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%s: Video device failed (ret=%d)\n&quot;</span>, __func__, ret);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* !CONFIG_SYS_CONSOLE_IS_IN_ENV */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">if</span> defined(CONFIG_LCD)</span></span><br><span class="line">        drv_lcd_init ();</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">if</span> defined(CONFIG_VIDEO) || defined(CONFIG_CFB_CONSOLE)</span></span><br><span class="line">        drv_video_init ();      <span class="comment">//好像未实现？</span></span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_DM_VIDEO */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_KEYBOARD) &amp;&amp; !defined(CONFIG_DM_KEYBOARD)</span></span><br><span class="line">        drv_keyboard_init ();   <span class="comment">//也没有实现？</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        drv_system_init ();     <span class="comment">//初始化串口</span></span><br><span class="line">        serial_stdio_init ();   <span class="comment">//注册串口到sdtio core</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_USB_TTY</span></span><br><span class="line">        drv_usbtty_init ();     <span class="comment">//usb终端初始化</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NETCONSOLE</span></span><br><span class="line">        drv_nc_init ();         <span class="comment">//注册网络终端结构体</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_JTAG_CONSOLE</span></span><br><span class="line">        drv_jtag_console_init ();       <span class="comment">//未使用</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CBMEM_CONSOLE</span></span><br><span class="line">        cbmemc_init();          <span class="comment">//注册CBMEM结构体</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">lcd_init</span><span class="params">(<span class="type">void</span> *lcdbase)</span></span><br><span class="line">&#123;</span><br><span class="line">        debug(<span class="string">&quot;[LCD] Initializing LCD frambuffer at %p\n&quot;</span>, lcdbase);</span><br><span class="line">        lcd_ctrl_init(lcdbase); <span class="comment">//为何找不到实现的源码 控制器初始化</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * lcd_ctrl_init() of some drivers (i.e. bcm2835 on rpi) ignores</span></span><br><span class="line"><span class="comment">         * the &#x27;lcdbase&#x27; argument and uses custom lcd base address</span></span><br><span class="line"><span class="comment">         * by setting up gd-&gt;fb_base. Check for this condition and fixup</span></span><br><span class="line"><span class="comment">         * &#x27;lcd_base&#x27; address.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (map_to_sysmem(lcdbase) != gd-&gt;fb_base)</span><br><span class="line">                lcd_base = map_sysmem(gd-&gt;fb_base, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        debug(<span class="string">&quot;[LCD] Using LCD frambuffer at %p\n&quot;</span>, lcd_base);</span><br><span class="line"></span><br><span class="line">        lcd_get_size(&amp;lcd_line_length);</span><br><span class="line">        lcd_is_enabled = <span class="number">1</span>;</span><br><span class="line">        lcd_clear();</span><br><span class="line">        lcd_enable();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Initialize the console */</span></span><br><span class="line">        lcd_set_col(<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_LCD_INFO_BELOW_LOGO</span></span><br><span class="line">        lcd_set_row(<span class="number">7</span> + BMP_LOGO_HEIGHT / VIDEO_FONT_HEIGHT);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        lcd_set_row(<span class="number">1</span>); <span class="comment">/* leave 1 blank line below logo */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">drv_lcd_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">stdio_dev</span> <span class="title">lcddev</span>;</span></span><br><span class="line">        <span class="type">int</span> rc;</span><br><span class="line"></span><br><span class="line">        lcd_base = map_sysmem(gd-&gt;fb_base, <span class="number">0</span>);  <span class="comment">//lcd framebuff地址</span></span><br><span class="line"></span><br><span class="line">        lcd_init(lcd_base);     <span class="comment">//lcd</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Device initialization lcd结构体对象初始化*/</span></span><br><span class="line">        <span class="built_in">memset</span>(&amp;lcddev, <span class="number">0</span>, <span class="keyword">sizeof</span>(lcddev));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">strcpy</span>(lcddev.name, <span class="string">&quot;lcd&quot;</span>);</span><br><span class="line">        lcddev.ext   = <span class="number">0</span>;                       <span class="comment">/* No extensions */</span></span><br><span class="line">        lcddev.flags = DEV_FLAGS_OUTPUT;        <span class="comment">/* Output only */</span></span><br><span class="line">        lcddev.putc  = lcd_stub_putc;           <span class="comment">/* &#x27;putc&#x27; function */</span></span><br><span class="line">        lcddev.<span class="built_in">puts</span>  = lcd_stub_puts;           <span class="comment">/* &#x27;puts&#x27; function */</span></span><br><span class="line"></span><br><span class="line">        rc = stdio_register(&amp;lcddev);   <span class="comment">//将lcd注册到标准输入输出</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (rc == <span class="number">0</span>) ? <span class="number">1</span> : rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Initialize the usb client port.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">drv_usbtty_init</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> rc;</span><br><span class="line">        <span class="type">char</span> * sn;</span><br><span class="line">        <span class="type">char</span> * tt;</span><br><span class="line">        <span class="type">int</span> snlen;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Get serial number */</span></span><br><span class="line">        sn = env_get(<span class="string">&quot;serial#&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!sn)</span><br><span class="line">                sn = <span class="string">&quot;000000000000&quot;</span>;</span><br><span class="line">        snlen = <span class="built_in">strlen</span>(sn);</span><br><span class="line">        <span class="keyword">if</span> (snlen &gt; <span class="keyword">sizeof</span>(serial_number) - <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span> (<span class="string">&quot;Warning: serial number %s is too long (%d &gt; %lu)\n&quot;</span>,</span><br><span class="line">                        sn, snlen, (ulong)(<span class="keyword">sizeof</span>(serial_number) - <span class="number">1</span>));</span><br><span class="line">                snlen = <span class="keyword">sizeof</span>(serial_number) - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memcpy</span> (serial_number, sn, snlen);</span><br><span class="line">        serial_number[snlen] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Decide on which type of UDC device to be.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        tt = env_get(<span class="string">&quot;usbtty&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!tt)</span><br><span class="line">                tt = <span class="string">&quot;generic&quot;</span>;</span><br><span class="line">        usbtty_init_terminal_type(<span class="built_in">strcmp</span>(tt,<span class="string">&quot;cdc_acm&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* prepare buffers... */</span></span><br><span class="line">        buf_init (&amp;usbtty_input, USBTTY_BUFFER_SIZE);</span><br><span class="line">        buf_init (&amp;usbtty_output, USBTTY_BUFFER_SIZE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Now, set up USB controller and infrastructure */</span></span><br><span class="line">        udc_init ();            <span class="comment">/* Basic USB initialization */</span></span><br><span class="line"></span><br><span class="line">        usbtty_init_strings ();</span><br><span class="line">        usbtty_init_instances ();</span><br><span class="line"></span><br><span class="line">        usbtty_init_endpoints ();</span><br><span class="line"></span><br><span class="line">        udc_startup_events (device_instance);<span class="comment">/* Enable dev, init udc pointers */</span></span><br><span class="line">        udc_connect ();         <span class="comment">/* Enable pullup for host detection */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Device initialization */</span></span><br><span class="line">        <span class="built_in">memset</span> (&amp;usbttydev, <span class="number">0</span>, <span class="keyword">sizeof</span> (usbttydev));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">strcpy</span> (usbttydev.name, <span class="string">&quot;usbtty&quot;</span>);</span><br><span class="line">        usbttydev.ext = <span class="number">0</span>;      <span class="comment">/* No extensions */</span></span><br><span class="line">        usbttydev.flags = DEV_FLAGS_INPUT | DEV_FLAGS_OUTPUT;</span><br><span class="line">        usbttydev.tstc = usbtty_tstc;   <span class="comment">/* &#x27;tstc&#x27; function */</span></span><br><span class="line">        usbttydev.getc = usbtty_getc;   <span class="comment">/* &#x27;getc&#x27; function */</span></span><br><span class="line">        usbttydev.putc = usbtty_putc;   <span class="comment">/* &#x27;putc&#x27; function */</span></span><br><span class="line">        usbttydev.<span class="built_in">puts</span> = usbtty_puts;   <span class="comment">/* &#x27;puts&#x27; function */</span></span><br><span class="line"></span><br><span class="line">        rc = stdio_register (&amp;usbttydev);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (rc == <span class="number">0</span>) ? <span class="number">1</span> : rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">drv_nc_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">stdio_dev</span> <span class="title">dev</span>;</span></span><br><span class="line">        <span class="type">int</span> rc;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(&amp;dev, <span class="number">0</span>, <span class="keyword">sizeof</span>(dev));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">strcpy</span>(dev.name, <span class="string">&quot;nc&quot;</span>);</span><br><span class="line">        dev.flags = DEV_FLAGS_OUTPUT | DEV_FLAGS_INPUT;</span><br><span class="line">        dev.start = nc_stdio_start;</span><br><span class="line">        dev.putc = nc_stdio_putc;</span><br><span class="line">        dev.<span class="built_in">puts</span> = nc_stdio_puts;</span><br><span class="line">        dev.getc = nc_stdio_getc;</span><br><span class="line">        dev.tstc = nc_stdio_tstc;</span><br><span class="line"></span><br><span class="line">        rc = stdio_register(&amp;dev);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (rc == <span class="number">0</span>) ? <span class="number">1</span> : rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化api表、并留下地址给开发者</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">api_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">api_signature</span> *<span class="title">sig</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* TODO put this into linker set one day... */</span></span><br><span class="line">        calls_table[API_RSVD] = <span class="literal">NULL</span>;</span><br><span class="line">        calls_table[API_GETC] = &amp;API_getc;</span><br><span class="line">        calls_table[API_PUTC] = &amp;API_putc;</span><br><span class="line">        calls_table[API_TSTC] = &amp;API_tstc;</span><br><span class="line">        calls_table[API_PUTS] = &amp;API_puts;</span><br><span class="line">        calls_table[API_RESET] = &amp;API_reset;</span><br><span class="line">        calls_table[API_GET_SYS_INFO] = &amp;API_get_sys_info;</span><br><span class="line">        calls_table[API_UDELAY] = &amp;API_udelay;</span><br><span class="line">        calls_table[API_GET_TIMER] = &amp;API_get_timer;</span><br><span class="line">        calls_table[API_DEV_ENUM] = &amp;API_dev_enum;</span><br><span class="line">        calls_table[API_DEV_OPEN] = &amp;API_dev_open;</span><br><span class="line">        calls_table[API_DEV_CLOSE] = &amp;API_dev_close;</span><br><span class="line">        calls_table[API_DEV_READ] = &amp;API_dev_read;</span><br><span class="line">        calls_table[API_DEV_WRITE] = &amp;API_dev_write;</span><br><span class="line">        calls_table[API_ENV_GET] = &amp;API_env_get;</span><br><span class="line">        calls_table[API_ENV_SET] = &amp;API_env_set;</span><br><span class="line">        calls_table[API_ENV_ENUM] = &amp;API_env_enum;</span><br><span class="line">        calls_table[API_DISPLAY_GET_INFO] = &amp;API_display_get_info;</span><br><span class="line">        calls_table[API_DISPLAY_DRAW_BITMAP] = &amp;API_display_draw_bitmap;</span><br><span class="line">        calls_table[API_DISPLAY_CLEAR] = &amp;API_display_clear;</span><br><span class="line">        calls_no = API_MAXCALL;</span><br><span class="line"></span><br><span class="line">        debugf(<span class="string">&quot;API initialized with %d calls\n&quot;</span>, calls_no);</span><br><span class="line"></span><br><span class="line">        dev_stor_init();        <span class="comment">//可能是存储设备初始化？</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Produce the signature so the API consumers can find it</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        sig = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> api_signature));</span><br><span class="line">        <span class="keyword">if</span> (sig == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;API: could not allocate memory for the signature!\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        env_set_hex(<span class="string">&quot;api_address&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>)sig); <span class="comment">//把地址保存到环境变量</span></span><br><span class="line">        debugf(<span class="string">&quot;API sig @ 0x%lX\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>)sig);</span><br><span class="line">        <span class="built_in">memcpy</span>(sig-&gt;magic, API_SIG_MAGIC, <span class="number">8</span>);</span><br><span class="line">        sig-&gt;version = API_SIG_VERSION;</span><br><span class="line">        sig-&gt;syscall = &amp;syscall;</span><br><span class="line">        sig-&gt;checksum = <span class="number">0</span>;</span><br><span class="line">        sig-&gt;checksum = crc32(<span class="number">0</span>, (<span class="type">unsigned</span> <span class="type">char</span> *)sig,</span><br><span class="line">                              <span class="keyword">sizeof</span>(<span class="keyword">struct</span> api_signature));</span><br><span class="line">        debugf(<span class="string">&quot;syscall entry: 0x%lX\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>)sig-&gt;syscall);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * kgdb_init must be called *after* the</span></span><br><span class="line"><span class="comment"> * monitor is relocated into ram</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">kgdb_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        kgdb_serial_init();</span><br><span class="line">        debugger_exception_handler = handle_exception;</span><br><span class="line">        initialized = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        putDebugStr(<span class="string">&quot;kgdb ready\n&quot;</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;ready\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">interrupt_init</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * setup up stacks if necessary</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        IRQ_STACK_START = gd-&gt;irq_sp - <span class="number">4</span>;</span><br><span class="line">        IRQ_STACK_START_IN = gd-&gt;irq_sp + <span class="number">8</span>;</span><br><span class="line">        FIQ_STACK_START = IRQ_STACK_START - SUNXI_STACKSIZE_IRQ;</span><br><span class="line"></span><br><span class="line">        debug(<span class="string">&quot;IRQ_STACK_START=0x%x\n&quot;</span>, (<span class="type">uint32_t</span>)IRQ_STACK_START);</span><br><span class="line">        <span class="comment">/*cpu0_set_irq_stack(IRQ_STACK_START);*/</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> arch_interrupt_init();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">enable_interrupts</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> temp;</span><br><span class="line">        __asm__ __volatile__(<span class="string">&quot;mrs %0, cpsr\n&quot;</span></span><br><span class="line">                             <span class="string">&quot;bic %0, %0, #0x80\n&quot;</span></span><br><span class="line">                             <span class="string">&quot;msr cpsr_c, %0&quot;</span></span><br><span class="line">                             : <span class="string">&quot;=r&quot;</span> (temp)</span><br><span class="line">                             :</span><br><span class="line">                             : <span class="string">&quot;memory&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">sunxi_fast_burn_key</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> storage_type = get_boot_storage_type_ext();</span><br><span class="line">        <span class="type">int</span> ret          = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        sunxi_burn_key_processed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!sunxi_flash_is_support_fast_write(storage_type)) &#123;</span><br><span class="line">                pr_msg(<span class="string">&quot;sunxi flash type@%d not support fast burn key\n&quot;</span>,</span><br><span class="line">                       storage_type);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">                ret = sunxi_flash_hook_init();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                pr_msg(<span class="string">&quot;sunxi flash hook init fail\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pr_msg(<span class="string">&quot;try fast burn key\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!sunxi_burn_key_processed) &#123;</span><br><span class="line">                sunxi_burn_key_processed = <span class="number">1</span>;</span><br><span class="line">                sunxi_keydata_burn_by_usb();    <span class="comment">//board/sunxi/key_burn.c</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="initr-sunxi-plat"><a href="#initr-sunxi-plat" class="headerlink" title="initr_sunxi_plat"></a>initr_sunxi_plat</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ir模块初始化、flash初始化、pwm_led初始化、开机logo、gpt更新、烧写rotpk</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">initr_sunxi_plat</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        __maybe_unused <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        __maybe_unused <span class="type">int</span> workmode = get_boot_work_mode();</span><br><span class="line"></span><br><span class="line">        check_ir_boot_recovery();       <span class="comment">//初始化ir模块</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SUNXI_HOMLET)        <span class="comment">//哈姆雷特？？？</span></span></span><br><span class="line">        sunxi_boot_init_gpio();         <span class="comment">//gpio初始化</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        check_recovery_key();           <span class="comment">//检查recovery 按键（无按下、短按、长按）</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!gd-&gt;boot_logo_addr) &#123;</span><br><span class="line">                tick_printf(<span class="string">&quot;flash init start\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">                ret = sunxi_flash_init_ext();   <span class="comment">//初始化flash相关描述符 调用对应flash的初始化函数</span></span><br><span class="line">                <span class="keyword">if</span> (ret)</span><br><span class="line">                        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_BOARD_EARLY_INIT_R)</span></span><br><span class="line">        board_early_init_r();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        pwm_led_init();         <span class="comment">//PWM led</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BOOT_GUI</span></span><br><span class="line">        sunxi_early_logo_display();     <span class="comment">//显示logo</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_BOX_STANDBY</span></span><br><span class="line">        do_box_standby();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ATF_BOX_STANDBY</span></span><br><span class="line">        atf_box_standby();     </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">//gd-&gt;boot_logo_addr</span></span><br><span class="line">        <span class="keyword">if</span> (gd-&gt;boot_logo_addr) &#123;</span><br><span class="line">                tick_printf(<span class="string">&quot;flash init start\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">                ret = sunxi_flash_init_ext();	<span class="comment">//初始化flash描述符 调用对应flash的初始化函数</span></span><br><span class="line">                <span class="keyword">if</span> (ret)</span><br><span class="line">                        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (workmode == WORK_MODE_BOOT) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_UPDATE_GPT</span></span><br><span class="line">                <span class="type">int</span> <span class="title function_">sunxi_update_gpt</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">                sunxi_update_gpt();             <span class="comment">//更新GPT</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BOOT_GUI</span></span><br><span class="line">            </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * logo display priority:</span></span><br><span class="line"><span class="comment"> * advert picture &gt; bootlogo in boot package &gt; bootlogo in boot-resources/bootloader</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * when /soc/target/advert_enable=1, display advert picture in Reserve0 partition</span></span><br><span class="line"><span class="comment"> * gd-&gt;boot_logo_addr is used to  indicate whether bootlogo in boot package exist/used</span></span><br><span class="line"><span class="comment"> * when no advert picture and gd-&gt;boot_logo_addr, bootlogo in boot-resouce is used as</span></span><br><span class="line"><span class="comment"> * default</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">        sunxi_early_logo_display();	<span class="comment">//若有广告图片、则gd-&gt;boot_logo_addr被设置为0，表示不使用。</span></span><br><span class="line">            						<span class="comment">//若无广告图片，从bootpackge读取logo，若无，则gd-&gt;boot_logo_addr被设置为0，表示不使用</span></span><br><span class="line">								</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_BOX_STANDBY</span></span><br><span class="line">        do_box_standby();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ATF_BOX_STANDBY</span></span><br><span class="line">        atf_box_standby();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (gd-&gt;boot_logo_addr) &#123;</span><br><span class="line">                tick_printf(<span class="string">&quot;flash init start\n&quot;</span>);</span><br><span class="line">                ret = sunxi_flash_init_ext();	<span class="comment">//初始化flash</span></span><br><span class="line">                <span class="keyword">if</span> (ret)</span><br><span class="line">                        <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (workmode == WORK_MODE_BOOT) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_UPDATE_GPT</span></span><br><span class="line">                <span class="type">int</span> <span class="title function_">sunxi_update_gpt</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">                sunxi_update_gpt();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BOOT_GUI</span></span><br><span class="line">                <span class="type">void</span> <span class="title function_">board_bootlogo_display</span><span class="params">(<span class="type">void</span>)</span>;	<span class="comment">//显示logo</span></span><br><span class="line">                board_bootlogo_display();</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_SPINOR_JPEG</span></span><br><span class="line">                <span class="type">int</span> <span class="title function_">sunxi_jpeg_display</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *filename)</span>;</span><br><span class="line">                sunxi_jpeg_display(<span class="string">&quot;bootlogo&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                sunxi_probe_partition_map();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_ROTPK_BURN_ENABLE_BY_TOOL</span></span><br><span class="line">        <span class="keyword">if</span> (get_boot_work_mode() == WORK_MODE_BOOT) &#123;</span><br><span class="line">                ret = sunxi_burn_rotpk();</span><br><span class="line">                <span class="keyword">if</span> (ret)</span><br><span class="line">                        <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sunxi-flash-init-ext"><a href="#sunxi-flash-init-ext" class="headerlink" title="sunxi_flash_init_ext"></a>sunxi_flash_init_ext</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sunxi_flash_init_ext</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> workmode     = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> storage_type = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> state       = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        workmode     = get_boot_work_mode();</span><br><span class="line">        storage_type = get_boot_storage_type();</span><br><span class="line"></span><br><span class="line">        tick_printf(<span class="string">&quot;workmode = %d,storage type = %d\n&quot;</span>, workmode, storage_type);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (workmode == WORK_MODE_BOOT ||</span><br><span class="line">            workmode == WORK_MODE_SPRITE_RECOVERY) &#123;</span><br><span class="line">                state = sunxi_flash_boot_init(storage_type, workmode);	<span class="comment">//注册flash驱动、并调用驱动初始化flash</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((workmode &amp; WORK_MODE_PRODUCT) || (workmode == <span class="number">0x30</span>)) &#123;</span><br><span class="line">                state = sunxi_flash_probe();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (workmode &amp; WORK_MODE_UPDATE) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//init blk dev</span></span><br><span class="line">        sunxi_flash_init_blk();	<span class="comment">//初始化块设备描述符</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">board_env_late_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (get_boot_work_mode() == WORK_MODE_BOOT) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_KEYBOX</span></span><br><span class="line">                sunxi_keybox_init();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_SPINOR_BMP</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_CMD_FAT)</span></span><br><span class="line">                fat_read_logo_to_kernel(<span class="string">&quot;bootlogo.bmp&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">                read_bmp_to_kernel(<span class="string">&quot;bootlogo&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">sunxi_burn_key</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMD_SUNXI_AUTO_FEL</span></span><br><span class="line">        sunxi_auto_fel_by_usb();        <span class="comment">//进入auto_fel</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_BURN</span></span><br><span class="line"><span class="meta">#  <span class="keyword">ifdef</span> CONFIG_SUNXI_FAST_BURN_KEY</span></span><br><span class="line">        <span class="keyword">if</span> (!sunxi_burn_key_processed)</span><br><span class="line"><span class="meta">#  <span class="keyword">endif</span></span></span><br><span class="line">        &#123;</span><br><span class="line">                pr_msg(<span class="string">&quot;try to burn key\n&quot;</span>);</span><br><span class="line">                sunxi_keydata_burn_by_usb();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h5 id="board-late-init"><a href="#board-late-init" class="headerlink" title="board_late_init"></a>board_late_init</h5><p>fastlogo、AB系统切换、配置lradc按键、读取flash中私有&#x2F;安全分区的数据到环境变量、验证cpu型号、限制cpu频率</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">board_late_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> work_mode = get_boot_work_mode();</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_TV_FASTLOGO</span></span><br><span class="line">        <span class="comment">//若是电视产品需要快速显示logo</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">fastlogo_t</span> *<span class="title">p_fastlogo</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (work_mode == WORK_MODE_BOOT || work_mode == WORK_MODE_CARD_UPDATE ||</span><br><span class="line">            work_mode == WORK_MODE_CARD_PRODUCT) &#123;</span><br><span class="line">                p_fastlogo =</span><br><span class="line">                        create_fastlogo_inst(<span class="string">&quot;bootlogo.bmp&quot;</span>, <span class="string">&quot;bootloader&quot;</span>,</span><br><span class="line">                                             <span class="string">&quot;LogoRegData.bin&quot;</span>, <span class="string">&quot;bootloader&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (p_fastlogo) &#123;</span><br><span class="line">                        p_fastlogo-&gt;display_fastlogo(p_fastlogo);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (work_mode == WORK_MODE_BOOT) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_SWITCH_SYSTEM</span></span><br><span class="line">                sunxi_auto_switch_system();     <span class="comment">//自动切换到A或B系统 The system will switch according to systemab_next</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PMIC_TPS65185</span></span><br><span class="line">                tps65185_modules_init();               <span class="comment">//一个电源相关的芯片。在电子阅读器产品</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_LRADC_VOL</span></span><br><span class="line"><span class="comment">/* Note: lradc should be initialized 30ms before</span></span><br><span class="line"><span class="comment"> * sunxi_read_lradc_vol() which lradc-sample-rate</span></span><br><span class="line"><span class="comment"> * is 500Hz.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">                lradc_reg_init();              <span class="comment">//lradc初始化、应该是按键的功能。通过设备树配置</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_EINK200_SUNXI</span></span><br><span class="line">                sunxi_eink_fresh_image(<span class="string">&quot;bootlogo.bmp&quot;</span>, <span class="number">0x04</span>);   <span class="comment">//水墨屏显示logo</span></span><br><span class="line">                __udelay(<span class="number">3000</span>); <span class="comment">//这个延时应该就是等待水墨屏的反应</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_ARISC_EXIST</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_ARISC_DEASSERT_BEFORE_KERNEL</span></span><br><span class="line">                sunxi_arisc_probe();    <span class="comment">//没用的</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_OTA_TURNNING</span></span><br><span class="line">                update_boot0_head_for_ota();    <span class="comment">//根据卡类型决定如何更新boot0首部数据</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_ANDROID_BOOT</span></span><br><span class="line">                sunxi_fastboot_status_read();   <span class="comment">//设值gd-&gt;lockflag  用来使能fastboot?</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_USER_KEY</span></span><br><span class="line">                <span class="comment">/* update mac/wifi serial info in env */</span></span><br><span class="line">                <span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">update_user_data</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">                update_user_data();     <span class="comment">//读取flash中私有/安全分区的数据到环境变量</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_CHECK_LIMIT_VERIFY</span></span><br><span class="line">                <span class="type">int</span> <span class="title function_">sunxi_check_cpu_gpu_verify</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">                sunxi_check_cpu_gpu_verify();   <span class="comment">//验证cpu型号、限制cpu频率</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_CHECK_CUSTOMER_RESERVED_ID</span></span><br><span class="line">                <span class="type">int</span> <span class="title function_">sunxi_check_customer_reserved_id</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">                sunxi_check_customer_reserved_id();     <span class="comment">//检查客户的加密id</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_UBIFS       <span class="comment">//用于nand flash的一种文件系统</span></span></span><br><span class="line">                <span class="keyword">if</span> ((get_boot_storage_type() == STORAGE_NAND) &amp;&amp; nand_use_ubi())</span><br><span class="line">                        ubi_nand_update_ubi_env();</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                sunxi_update_partinfo();        <span class="comment">//更新分区信息到环境变量</span></span><br><span class="line">                <span class="keyword">if</span> (sunxi_update_rotpk_info()) &#123;        <span class="comment">//检查efuse的rotpk数据</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_POWER</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_BMU</span></span><br><span class="line">                axp_battery_status_handle();    <span class="comment">//根据电池状态、是否接入电源充电、显示充电图标，电压太低会关机</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                sunxi_respond_ir_key_action();  <span class="comment">//响应红外遥控（处理gd-&gt;keyvalue）</span></span><br><span class="line">                sunxi_update_bootcmd();         <span class="comment">//根据启动介质设置bootcmd环境变量</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_SERIAL</span></span><br><span class="line">                sunxi_set_serial_num(); <span class="comment">//根据芯片设置串口数量到环境变量</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_LRADC_VOL</span></span><br><span class="line">                sunxi_read_lradc_vol();         <span class="comment">//读取lradc的值、判断按键状态，并保存到环境变量</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_OF_SEPARATE)</span></span><br><span class="line">                sunxi_update_fdt_para_for_kernel();     <span class="comment">//使用kernel的设备树</span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(CONFIG_SUNXI_NECESSARY_REPLACE_FDT)</span></span><br><span class="line">                sunxi_replace_fdt_v2();         <span class="comment">//替换设备树</span></span><br><span class="line">                sunxi_update_fdt_para_for_kernel();</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(CONFIG_SUNXI_REPLACE_FDT_FROM_PARTITION)</span></span><br><span class="line">                sunxi_replace_fdt();            </span><br><span class="line">                sunxi_update_fdt_para_for_kernel();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_TV_FASTLOGO</span></span><br><span class="line">                <span class="keyword">if</span> (p_fastlogo) &#123;</span><br><span class="line">                        p_fastlogo-&gt;reserve_memory(p_fastlogo); <span class="comment">//给fastlogo保留内存</span></span><br><span class="line">                &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_OTA_TURNNING</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">update_boot0_head_for_ota</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> FPGA_PLATFORM</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MMC_SUNXI</span></span><br><span class="line">        <span class="type">int</span> storage_type = get_boot_storage_type();</span><br><span class="line">        <span class="type">int</span> card_num = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (storage_type == STORAGE_EMMC3) &#123;</span><br><span class="line">                card_num = <span class="number">3</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (storage_type == STORAGE_SD) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;       <span class="comment">//sd不能进行ota？</span></span><br><span class="line">        &#125;</span><br><span class="line">        ret = mmc_request_update_boot0(card_num);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_TURNNING_DRAM</span></span><br><span class="line">        <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">                ret = get_boot_dram_update_flag();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                pr_debug(<span class="string">&quot;begin to update boot0 atfer ota\n&quot;</span>);</span><br><span class="line">                ret = sunxi_flash_update_boot0();</span><br><span class="line">                pr_msg(<span class="string">&quot;update boot0 %s\n&quot;</span>, ret == <span class="number">0</span> ? <span class="string">&quot;success&quot;</span> : <span class="string">&quot;fail&quot;</span>);</span><br><span class="line">                <span class="comment">/* if update fail, should reset the system */</span></span><br><span class="line">                <span class="comment">/* if(ret) */</span></span><br><span class="line">                <span class="comment">/* &#123; */</span></span><br><span class="line">                <span class="comment">/* do_reset(NULL, 0, 0,NULL); */</span></span><br><span class="line">                <span class="comment">/* &#125; */</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sunxi_fastboot_status_read</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">char</span> d_buffer[<span class="number">32</span>];</span><br><span class="line">        <span class="type">char</span> buffer[<span class="number">512</span>];</span><br><span class="line">        <span class="type">int</span> d_data_len;</span><br><span class="line">        <span class="type">int</span> data_len;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* read locked or unlocked flag in secure storage */</span></span><br><span class="line">        <span class="built_in">memset</span>(buffer, <span class="number">0x00</span>, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">        <span class="built_in">memset</span>(d_buffer, <span class="number">0x00</span>, <span class="keyword">sizeof</span>(d_buffer));</span><br><span class="line">        <span class="keyword">if</span> (sunxi_secure_storage_init()) &#123;      <span class="comment">//安全储存</span></span><br><span class="line">                pr_err(<span class="string">&quot;secure storage init fail\n&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ret = sunxi_secure_object_read(<span class="string">&quot;device_unlock&quot;</span>, d_buffer, <span class="number">32</span>,   <span class="comment">//读取安全存储的对象</span></span><br><span class="line">                                               &amp;d_data_len);</span><br><span class="line">                ret = sunxi_secure_object_read(<span class="string">&quot;fastboot_status_flag&quot;</span>, buffer,</span><br><span class="line">                                               <span class="number">512</span>, &amp;data_len);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((!ret) &amp;&amp; (!<span class="built_in">strcmp</span>(buffer, <span class="string">&quot;locked&quot;</span>)) &amp;&amp;</span><br><span class="line">                    (!<span class="built_in">strcmp</span>(d_buffer, <span class="string">&quot;unlock&quot;</span>))) &#123;</span><br><span class="line">                        env_set(<span class="string">&quot;verifiedbootstate&quot;</span>, <span class="string">&quot;yellow&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//根据存储的信息。初始lockflag</span></span><br><span class="line">                <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                        pr_msg(<span class="string">&quot;sunxi secure storage has no flag\n&quot;</span>);</span><br><span class="line">                        gd-&gt;lockflag = SUNXI_LOCKED;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(buffer, <span class="string">&quot;unlocked&quot;</span>)) &#123;</span><br><span class="line">                                pr_force(<span class="string">&quot;find fastboot unlock flag\n&quot;</span>);</span><br><span class="line">                                gd-&gt;lockflag = SUNXI_UNLOCKED;</span><br><span class="line">                                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(buffer, <span class="string">&quot;locked&quot;</span>)) &#123;</span><br><span class="line">                                pr_force(<span class="string">&quot;find fastboot locked flag\n&quot;</span>);</span><br><span class="line">                                gd-&gt;lockflag = SUNXI_LOCKED;</span><br><span class="line">                                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        pr_force(<span class="string">&quot;do not find fastboot status flag\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">axp_battery_status_handle</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> battery_status;</span><br><span class="line">        <span class="type">int</span> ret = <span class="number">0</span>, bat_exist = <span class="number">0</span>, ntc_status = <span class="number">-1</span>, charge_mode;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取一些设备树中电池的信息</span></span><br><span class="line">        ret = script_parser_fetch(FDT_PATH_POWER_SPLY, <span class="string">&quot;battery_exist&quot;</span>, &amp;bat_exist, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                bat_exist = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!bat_exist)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        ret = bmu_get_battery_probe();</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        ret = script_parser_fetch(FDT_PATH_POWER_SPLY, <span class="string">&quot;ntc_status&quot;</span>, &amp;ntc_status, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                ntc_status = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        bmu_set_ntc_onoff(ntc_status);</span><br><span class="line"></span><br><span class="line">        ret = script_parser_fetch(FDT_PATH_POWER_SPLY, <span class="string">&quot;charge_mode&quot;</span>, &amp;charge_mode, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                charge_mode = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取电池状态</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_AXP_LATE_INFO</span></span><br><span class="line">        battery_status = axp_get_battery_status();</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        battery_status = gd-&gt;pmu_runtime_chgcur;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">//获取充电模式</span></span><br><span class="line">        <span class="keyword">if</span> (gd-&gt;chargemode == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((battery_status == BATTERY_RATIO_TOO_LOW_WITH_DCIN)</span><br><span class="line">                        || (battery_status == BATTERY_RATIO_TOO_LOW_WITHOUT_DCIN)</span><br><span class="line">                        || (battery_status == BATTERY_VOL_TOO_LOW)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_EINK200_SUNXI</span></span><br><span class="line">                        sunxi_eink_fresh_image(<span class="string">&quot;bat\\bat0.bmp&quot;</span>, <span class="number">0x04</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> CONFIG_CMD_SUNXI_BMP</span></span><br><span class="line">                        sunxi_bmp_display(<span class="string">&quot;bat\\bat0.bmp&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">                        tick_printf(<span class="string">&quot;battery ratio is low with dcin,to be shutdown\n&quot;</span>);</span><br><span class="line">                        mdelay(<span class="number">3000</span>);</span><br><span class="line">                        sunxi_board_shutdown();</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">                <span class="comment">//低电压处理</span></span><br><span class="line">                sunxi_bat_low_vol_handle();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (charge_mode == <span class="number">2</span>) &#123;</span><br><span class="line">                        tick_printf(<span class="string">&quot;press power_on to start up\n&quot;</span>);</span><br><span class="line">                        sunxi_bat_key_handle();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_EINK200_SUNXI</span></span><br><span class="line">                        <span class="comment">//显示充电图标</span></span><br><span class="line">                        sunxi_eink_fresh_image(<span class="string">&quot;bat\\battery_charge.bmp&quot;</span>, <span class="number">0x04</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> CONFIG_CMD_SUNXI_BMP</span></span><br><span class="line">                        sunxi_bmp_display(<span class="string">&quot;bat\\battery_charge.bmp&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((battery_status == BATTERY_RATIO_TOO_LOW_WITHOUT_DCIN) || (battery_status == BATTERY_VOL_TOO_LOW)) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_EINK200_SUNXI</span></span><br><span class="line">                sunxi_eink_fresh_image(<span class="string">&quot;bat\\low_pwr.bmp&quot;</span>, <span class="number">0x04</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> CONFIG_CMD_SUNXI_BMP</span></span><br><span class="line">                sunxi_bmp_display(<span class="string">&quot;bat\\low_pwr.bmp&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                tick_printf(<span class="string">&quot;battery ratio or vol is low ,to be shutdown\n&quot;</span>);</span><br><span class="line">                mdelay(<span class="number">3000</span>);</span><br><span class="line">                <span class="comment">//电池电压低又无接入电源、关机</span></span><br><span class="line">                sunxi_board_shutdown();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (charge_mode == <span class="number">2</span> || charge_mode == <span class="number">0</span>)</span><br><span class="line">                gd-&gt;chargemode = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//响应红外遥控</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">sunxi_respond_ir_key_action</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> key_value;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_IR_BOOT_RECOVERY</span></span><br><span class="line">        <span class="type">int</span> ir_time_out = get_timer_masked();</span><br><span class="line">        <span class="keyword">while</span> (get_timer_masked() - ir_time_out &lt; <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (gd-&gt;ir_detect_status != IR_DETECT_NULL)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ir_disable();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        key_value = gd-&gt;key_pressd_value;</span><br><span class="line">        <span class="comment">/* //ir factory or key factory */</span></span><br><span class="line">        <span class="keyword">if</span> (key_value == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key_value == BOOT_FACTORY_VALUE) &#123;   <span class="comment">//恢复出厂、擦除数据</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[boot factory] set misc : boot factory and wipe data\n&quot;</span>);</span><br><span class="line">                write_recovery_msg_to_misc(<span class="string">&quot;ir-factory&quot;</span>);       <span class="comment">//将命令写入flash</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key_value == EFEX_VALUE) &#123;</span><br><span class="line">                <span class="comment">/* //ir efex or key efex */</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[boot efex] set misc : boot efex\n&quot;</span>);</span><br><span class="line">                write_recovery_msg_to_misc(<span class="string">&quot;ir-efex&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key_value == SPRITE_RECOVERY_VALUE) &#123;</span><br><span class="line">                <span class="comment">/* //ir sprite recovery */</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[ir sysrecovery] set misc : boot recovery and sysrecovery \n&quot;</span>);</span><br><span class="line">                write_recovery_msg_to_misc(<span class="string">&quot;sysrecovery&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key_value == BOOT_RECOVERY_VALUE) &#123;</span><br><span class="line">                <span class="comment">/* //ir recovery or key recovery */</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[boot recovery] set misc : boot recovery\n&quot;</span>);</span><br><span class="line">                write_recovery_msg_to_misc(<span class="string">&quot;ir-or-key-recovery&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">eth_initialize</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> num_devices = <span class="number">0</span>;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">udevice</span> *<span class="title">dev</span>;</span></span><br><span class="line"></span><br><span class="line">        eth_common_init();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Devices need to write the hwaddr even if not started so that Linux</span></span><br><span class="line"><span class="comment">         * will have access to the hwaddr that u-boot stored for the device.</span></span><br><span class="line"><span class="comment">         * This is accomplished by attempting to probe each device and calling</span></span><br><span class="line"><span class="comment">         * their write_hwaddr() operation.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        uclass_first_device(UCLASS_ETH, &amp;dev);</span><br><span class="line">        <span class="keyword">if</span> (!dev) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;No ethernet found.\n&quot;</span>);</span><br><span class="line">                bootstage_error(BOOTSTAGE_ID_NET_ETH_START);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">char</span> *ethprime = env_get(<span class="string">&quot;ethprime&quot;</span>);</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">udevice</span> *<span class="title">prime_dev</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ethprime)</span><br><span class="line">                        prime_dev = eth_get_dev_by_name(ethprime);</span><br><span class="line">                <span class="keyword">if</span> (prime_dev) &#123;</span><br><span class="line">                        eth_set_dev(prime_dev);</span><br><span class="line">                        eth_current_changed();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        eth_set_dev(<span class="literal">NULL</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                bootstage_mark(BOOTSTAGE_ID_NET_ETH_INIT);</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (num_devices)</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">&quot;, &quot;</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">&quot;eth%d: %s&quot;</span>, dev-&gt;seq, dev-&gt;name);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (ethprime &amp;&amp; dev == prime_dev)</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">&quot; [PRIME]&quot;</span>);</span><br><span class="line"></span><br><span class="line">                        eth_write_hwaddr(dev);</span><br><span class="line"></span><br><span class="line">                        uclass_next_device(&amp;dev);</span><br><span class="line">                        num_devices++;</span><br><span class="line">                &#125; <span class="keyword">while</span> (dev);</span><br><span class="line"></span><br><span class="line">                putc(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> num_devices;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * i2c_init_all():</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * not longer needed, will deleted. Actual init the SPD_BUS</span></span><br><span class="line"><span class="comment"> * for compatibility.</span></span><br><span class="line"><span class="comment"> * i2c_adap[] must be initialized beforehead with function pointers and</span></span><br><span class="line"><span class="comment"> * data, including speed and slaveaddr.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">i2c_init_all</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        i2c_init_board();	<span class="comment">//无实现</span></span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  Change the active I2C bus. Subsequent read/write calls will</span></span><br><span class="line"><span class="comment"> *  go to this one. Sets all of the muxes in a proper condition</span></span><br><span class="line"><span class="comment"> *  if that bus is behind muxes.</span></span><br><span class="line"><span class="comment"> *  If previously selected bus is behind the muxes turns off all the</span></span><br><span class="line"><span class="comment"> *  muxes along the path to that bus.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        i2c_set_bus_num(CONFIG_SYS_SPD_BUS_NUM);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sunxi_flash_init_ext</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> workmode     = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> storage_type = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> state       = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        workmode     = get_boot_work_mode();</span><br><span class="line">        storage_type = get_boot_storage_type();</span><br><span class="line"></span><br><span class="line">        tick_printf(<span class="string">&quot;workmode = %d,storage type = %d\n&quot;</span>, workmode, storage_type);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (workmode == WORK_MODE_USB_DEBUG) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (workmode == WORK_MODE_BOOT ||</span><br><span class="line">                   workmode == WORK_MODE_SPRITE_RECOVERY) &#123;</span><br><span class="line">                state = sunxi_flash_boot_init(storage_type, workmode);	<span class="comment">//调用不同的接口初始化不同的flash</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((workmode &amp; WORK_MODE_PRODUCT) || (workmode == <span class="number">0x30</span>)) &#123;</span><br><span class="line">                state = sunxi_flash_probe();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (workmode &amp; WORK_MODE_UPDATE) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//init blk dev</span></span><br><span class="line">        sunxi_flash_init_blk();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br><span class="line">	</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_UPDATE_GPT</span></span><br><span class="line"><span class="comment">//更新GPT给uboot、内核使用</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sunxi_update_gpt</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_UBIFS</span></span><br><span class="line">        <span class="keyword">if</span> (((STORAGE_SPI_NAND == get_boot_storage_type_ext()) ||</span><br><span class="line">                        (STORAGE_NAND == get_boot_storage_type_ext())) &amp;&amp; nand_use_ubi()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(*FLASH_WIRTE)</span><span class="params">(uint start_block, uint nblock, <span class="type">void</span> *buffer)</span>;</span><br><span class="line">        FLASH_WIRTE flash_write_pt = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="type">char</span> *buf;</span><br><span class="line">        <span class="type">int</span>   data_len = GPT_UPDATE_BUF_SIZE;</span><br><span class="line">        <span class="type">int</span>   ret = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> storage_type = get_boot_storage_type();</span><br><span class="line">        <span class="type">int</span> i, j;</span><br><span class="line"></span><br><span class="line">        <span class="type">char</span> char8_name[PARTNAME_SZ] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        buf = (<span class="type">char</span> *)memalign(CONFIG_SYS_CACHELINE_SIZE, GPT_UPDATE_BUF_SIZE);</span><br><span class="line">        <span class="keyword">if</span> (buf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                pr_err(<span class="string">&quot;malloc fail\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">char</span>  *gpt_buf = buf;</span><br><span class="line">        gpt_header *gpt_head     = (gpt_header *)(buf + GPT_HEAD_OFFSET);</span><br><span class="line">        gpt_entry *entry             = (gpt_entry *)(buf + GPT_ENTRY_OFFSET);</span><br><span class="line">        <span class="keyword">if</span> ((storage_type == STORAGE_SD) || (storage_type == STORAGE_EMMC)</span><br><span class="line">                || (storage_type == STORAGE_EMMC0))</span><br><span class="line">                sunxi_flash_phyread(<span class="number">0</span>, GPT_BUFF_SIZE/<span class="number">512</span>, buf);	<span class="comment">//读取flash中的gpt</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">                sunxi_flash_read(<span class="number">0</span>, GPT_BUFF_SIZE/<span class="number">512</span>, buf);</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//解析gpt</span></span><br><span class="line">        <span class="keyword">if</span> (gpt_head-&gt;reserved1 != <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (gpt_head-&gt;signature == GPT_HEADER_SIGNATURE) &#123;</span><br><span class="line">                        u32 calc_crc32   = <span class="number">0</span>;</span><br><span class="line">                        u32 backup_crc32 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                        backup_crc32       = gpt_head-&gt;header_crc32;</span><br><span class="line">                        gpt_head-&gt;header_crc32 = <span class="number">0</span>;</span><br><span class="line">                        calc_crc32 = crc32(<span class="number">0</span>, (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *)gpt_head,</span><br><span class="line">                                           <span class="keyword">sizeof</span>(gpt_header));</span><br><span class="line">                        gpt_head-&gt;header_crc32 = backup_crc32;</span><br><span class="line">                        <span class="keyword">if</span> (calc_crc32 != backup_crc32) &#123;</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">&quot;the GPT table is bad\n&quot;</span>);</span><br><span class="line">                                <span class="keyword">goto</span> __err_end;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">/* gpt_show_partition_info(buffer); */</span></span><br><span class="line">                &#125;</span><br><span class="line">            	<span class="comment">//读取分区名称</span></span><br><span class="line">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; gpt_head-&gt;num_partition_entries; i++) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; PARTNAME_SZ; j++) &#123;</span><br><span class="line">                                char8_name[j] = (<span class="type">char</span>)(entry[i].partition_name[j]);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> ((get_boot_work_mode() == WORK_MODE_BOOT) &amp;&amp; (!<span class="built_in">strncmp</span>(char8_name, <span class="string">&quot;UDISK&quot;</span>, <span class="keyword">sizeof</span>(<span class="string">&quot;UDISK&quot;</span>)))) &#123;</span><br><span class="line">                                <span class="type">char</span> temp_partition_name[<span class="number">16</span>] = &#123;CONFIG_LAST_PARTITION_NAME&#125;;</span><br><span class="line">                                <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="built_in">strlen</span>((<span class="type">const</span> <span class="type">char</span> *)temp_partition_name); j++) &#123;</span><br><span class="line">                                        entry[i].partition_name[j] = (<span class="type">efi_char16_t</span>)temp_partition_name[j];</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="comment">/* update last partiton name ok set gpt_head-&gt;reserved1 = 0x1 */</span></span><br><span class="line">                                gpt_head-&gt;reserved1 = <span class="number">0x1</span>;</span><br><span class="line">                                <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; PARTNAME_SZ; j++) &#123;</span><br><span class="line">                                        char8_name[j] = (<span class="type">char</span>)(entry[i].partition_name[j]);</span><br><span class="line">                                &#125;</span><br><span class="line">                                pr_msg(<span class="string">&quot;GPT:%-12s: %-12llx  %-12llx\n&quot;</span>, char8_name,</span><br><span class="line">                                                entry[i].starting_lba, entry[i].ending_lba);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        pr_msg(<span class="string">&quot;GPT:%-12s: %-12llx  %-12llx\n&quot;</span>, char8_name,</span><br><span class="line">                                        entry[i].starting_lba, entry[i].ending_lba);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                gpt_head-&gt;partition_entry_array_crc32 = <span class="number">0</span>;</span><br><span class="line">                gpt_head-&gt;partition_entry_array_crc32 = crc32(<span class="number">0</span>, (<span class="type">unsigned</span> <span class="type">char</span> <span class="type">const</span> *)entry,</span><br><span class="line">                        (gpt_head-&gt;num_partition_entries)*(gpt_head-&gt;sizeof_partition_entry));</span><br><span class="line"></span><br><span class="line">                <span class="comment">//gpt crc32</span></span><br><span class="line">                gpt_head-&gt;header_crc32 = <span class="number">0</span>;</span><br><span class="line">                gpt_head-&gt;header_crc32 = crc32(<span class="number">0</span>, (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *)gpt_head, gpt_head-&gt;header_size);</span><br><span class="line">                <span class="comment">/*write GPT for u-boot use*/</span></span><br><span class="line">                ret = sunxi_sprite_write(<span class="number">0</span>, (data_len+<span class="number">511</span>)&gt;&gt;<span class="number">9</span>, gpt_buf);</span><br><span class="line">                <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">                        debug(<span class="string">&quot;%s:write gpt sectors fail\n&quot;</span>, __func__);</span><br><span class="line">                        <span class="keyword">goto</span> __err_end;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/*write GPT for kenerl use if sdmmc*/</span></span><br><span class="line">                <span class="keyword">if</span> (STORAGE_EMMC == storage_type || STORAGE_EMMC3 == storage_type</span><br><span class="line">                                || storage_type == STORAGE_EMMC0 || storage_type == STORAGE_SD) &#123;</span><br><span class="line">                        ret = sunxi_sprite_phywrite(<span class="number">0</span>, (data_len + <span class="number">511</span>) &gt;&gt; <span class="number">9</span>, gpt_buf);</span><br><span class="line">                        <span class="keyword">if</span> (!ret)</span><br><span class="line">                                <span class="keyword">goto</span> __err_end;</span><br><span class="line">                &#125;</span><br><span class="line">                pr_msg(<span class="string">&quot;write primary GPT success\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">                prepare_backup_gpt_header(gpt_head);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (STORAGE_NOR == storage_type) &#123;</span><br><span class="line">                        pr_msg(<span class="string">&quot;spinor: skip backup GPT\n&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (STORAGE_EMMC == storage_type ||</span><br><span class="line">                                STORAGE_EMMC3 == storage_type ||</span><br><span class="line">                                storage_type == STORAGE_EMMC0 ||</span><br><span class="line">                                storage_type == STORAGE_SD)</span><br><span class="line">                                flash_write_pt = sunxi_sprite_phywrite;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                                flash_write_pt = sunxi_sprite_write;</span><br><span class="line"></span><br><span class="line">                        ret = flash_write_pt((u32)(gpt_head-&gt;last_usable_lba + <span class="number">1</span>),</span><br><span class="line">                                        (GPT_BUFF_SIZE - GPT_ENTRY_OFFSET) / <span class="number">512</span>,</span><br><span class="line">                                        gpt_buf + GPT_ENTRY_OFFSET);</span><br><span class="line">                        <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">                                <span class="keyword">goto</span> __err_end;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">/* write back-up gpt HEAD */</span></span><br><span class="line">                        ret = flash_write_pt((u32)gpt_head-&gt;my_lba, <span class="number">1</span>,</span><br><span class="line">                                gpt_buf + GPT_HEAD_OFFSET);</span><br><span class="line">                        <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">                                <span class="keyword">goto</span> __err_end;</span><br><span class="line">                        &#125;</span><br><span class="line">                        pr_msg(<span class="string">&quot;write Backup GPT success\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">free</span>(buf);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">__err_end:</span><br><span class="line">        <span class="built_in">free</span>(buf);</span><br><span class="line">        pr_err(<span class="string">&quot;update gpt fail\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//keybox初始化</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sunxi_keybox_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line">        <span class="type">int</span> workmode;</span><br><span class="line">        workmode = get_boot_work_mode();</span><br><span class="line">        <span class="keyword">if</span> (workmode != WORK_MODE_BOOT)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sunxi_probe_secure_os() == <span class="number">0</span>) &#123;</span><br><span class="line">                pr_msg(<span class="string">&quot;no secure os for keybox operation\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ret = sunxi_keybox_init_key_list_from_env();</span><br><span class="line">        <span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">                pr_err(<span class="string">&quot;sunxi keybox read env failed with:%d&quot;</span>, ret);</span><br><span class="line">        sunxi_secure_storage_init();</span><br><span class="line">        ret = sunxi_keybox_install_keys();</span><br><span class="line">        <span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">                pr_err(<span class="string">&quot;sunxi keybox install failed with:%d&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>初始化ir功能</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">check_ir_boot_recovery</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (ir_sys_cfg())	<span class="comment">//从设备树中获取ir_code，code_num,code_value</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ir_setup())		<span class="comment">//设置ir时钟、寄存器、buff、注册中断服务函数</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        gd-&gt;ir_detect_status  = IR_DETECT_NULL;</span><br><span class="line">        ir_boot_recovery_mode = <span class="number">1</span>;</span><br><span class="line">        <span class="type">ir_timer_t</span>.data       = (<span class="type">unsigned</span> <span class="type">long</span>)&amp;<span class="type">ir_timer_t</span>;</span><br><span class="line">        <span class="type">ir_timer_t</span>.expires    = ir_detect_time;</span><br><span class="line">        <span class="type">ir_timer_t</span>.function   = ir_detect_overtime;</span><br><span class="line">        init_timer(&amp;<span class="type">ir_timer_t</span>);</span><br><span class="line">        add_timer(&amp;<span class="type">ir_timer_t</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>recovery按键检测(有无按下、长按or短按)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">check_recovery_key</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">user_gpio_set_t</span> gpio_recovery;</span><br><span class="line">        __u32 gpio_hd;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line">        <span class="type">int</span> gpio_value = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> used = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> mode = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> press_mode = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> press_time = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (get_boot_work_mode() == WORK_MODE_BOOT) &#123;</span><br><span class="line">                <span class="comment">/*check physical gpio pin*/</span></span><br><span class="line">                ret = script_parser_fetch(KEY_BOOT_RECOVERY, <span class="string">&quot;recovery_key_used&quot;</span>,</span><br><span class="line">                                (<span class="type">int</span> *)&amp;used, <span class="keyword">sizeof</span>(<span class="type">int</span>) / <span class="number">4</span>);</span><br><span class="line">                <span class="keyword">if</span> (ret || !used) &#123;</span><br><span class="line">                        key_info(<span class="string">&quot;[key recovery] no use\n&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ret = fdt_get_one_gpio(KEY_BOOT_RECOVERY, <span class="string">&quot;recovery_key&quot;</span>, &amp;gpio_recovery);</span><br><span class="line">                <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                        key_info(<span class="string">&quot;[key recovery] can&#x27;t find recovery_key config.\n&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                gpio_recovery.mul_sel = <span class="number">0</span>;              <span class="comment">/*forced to input*/</span></span><br><span class="line">                gpio_hd = sunxi_gpio_request(&amp;gpio_recovery, <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (!gpio_hd) &#123;</span><br><span class="line">                        pr_error(<span class="string">&quot;[key recovery] gpio request fail!\n&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                        <span class="comment">/*gpio request fail,just return.*/</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> time;</span><br><span class="line">                gpio_value = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">//连续读取按键值</span></span><br><span class="line">                <span class="keyword">for</span> (time = <span class="number">0</span>; time &lt; <span class="number">5</span>; time++) &#123;</span><br><span class="line">                        gpio_value += gpio_read_one_pin_value(gpio_hd, <span class="number">0</span>);</span><br><span class="line">                        mdelay(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (gpio_value) &#123;</span><br><span class="line">                        key_info(<span class="string">&quot;[key recovery] no key press.\n&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                        <span class="comment">/*no recovery key was pressed, just return.*/</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                key_info(<span class="string">&quot;[key recovery] find the key\n&quot;</span>);</span><br><span class="line">                script_parser_fetch(KEY_BOOT_RECOVERY, <span class="string">&quot;press_mode_enable&quot;</span>,</span><br><span class="line">                        (<span class="type">int</span> *)&amp;press_mode, <span class="keyword">sizeof</span>(<span class="type">int</span>) / <span class="number">4</span>);</span><br><span class="line">                <span class="keyword">if</span> (press_mode == KEY_PRESS_MODE_DISABLE) &#123;</span><br><span class="line">                        script_parser_fetch(KEY_BOOT_RECOVERY, <span class="string">&quot;key_work_mode&quot;</span>,</span><br><span class="line">                                (<span class="type">int</span> *)&amp;mode, <span class="keyword">sizeof</span>(<span class="type">int</span>) / <span class="number">4</span>);</span><br><span class="line">                        key_info(<span class="string">&quot;[key recovery] do not use prese mode, \</span></span><br><span class="line"><span class="string">                                        key_work_mode = %d\n&quot;</span>, mode);</span><br><span class="line">                    <span class="comment">//设备树使能recovery按键</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (press_mode == KEY_PRESS_MODE_ENABLE) &#123;</span><br><span class="line">                        script_parser_fetch(KEY_BOOT_RECOVERY, <span class="string">&quot;key_press_time&quot;</span>,</span><br><span class="line">                                (<span class="type">int</span> *)&amp;press_time, <span class="keyword">sizeof</span>(<span class="type">int</span>) / <span class="number">4</span>);</span><br><span class="line">                        key_info(<span class="string">&quot;[key recovery] use prese mode, \</span></span><br><span class="line"><span class="string">                                and key_press_time = %d ms\n&quot;</span>, press_time);                        </span><br><span class="line">					  gpio_value = <span class="number">0</span>;</span><br><span class="line">                    <span class="comment">//在一段时间内循环读取按键的值</span></span><br><span class="line">                        <span class="keyword">for</span> (time = press_time; time &gt; <span class="number">0</span>; time -= <span class="number">100</span>) &#123;</span><br><span class="line">                                mdelay(<span class="number">100</span>); <span class="comment">/*detect key value per 100ms*/</span></span><br><span class="line">                                gpio_value += gpio_read_one_pin_value(gpio_hd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                                <span class="comment">/*key was loosed during press time,will not detect key value any more*/</span></span><br><span class="line">                                <span class="keyword">if</span> (gpio_value)</span><br><span class="line">                                        <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">/*key was lossed during press time, so use short_press_mode*/</span></span><br><span class="line">                        <span class="keyword">if</span> (gpio_value) &#123;</span><br><span class="line">                                script_parser_fetch(KEY_BOOT_RECOVERY, <span class="string">&quot;short_press_mode&quot;</span>,</span><br><span class="line">                                        (<span class="type">int</span> *)&amp;mode, <span class="keyword">sizeof</span>(<span class="type">int</span>) / <span class="number">4</span>);</span><br><span class="line">                                key_info(<span class="string">&quot;[key recovery] key short press, short_press_mode = %d\n&quot;</span>, mode);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">/*key was always pressed in key_press_time, so use long_press_mode*/</span></span><br><span class="line">                                script_parser_fetch(KEY_BOOT_RECOVERY, <span class="string">&quot;long_press_mode&quot;</span>,</span><br><span class="line">                                        (<span class="type">int</span> *)&amp;mode, <span class="keyword">sizeof</span>(<span class="type">int</span>) / <span class="number">4</span>);</span><br><span class="line">                                key_info(<span class="string">&quot;[key recovery] key long press, long_press_mode = %d\n&quot;</span>, mode);</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">switch</span> (mode) &#123;</span><br><span class="line">                <span class="keyword">case</span> RECOVERY_KEY_EFEX_MODE:</span><br><span class="line">                        gd-&gt;key_pressd_value = RECOVERY_KEY_EFEX_VALUE;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RECOVERY_KEY_ONEKEY_SPRITE_RECOVERY_MODE:</span><br><span class="line">                        gd-&gt;key_pressd_value = RECOVERY_KEY_SPRITE_RECOVERY_VALUE;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RECOVERY_KEY_RECOVERY_MODE:</span><br><span class="line">                        gd-&gt;key_pressd_value = RECOVERY_KEY_BOOT_RECOVERY_VALUE;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RECOVERY_KEY_FACTORY_MODE:</span><br><span class="line">                        gd-&gt;key_pressd_value = RECOVERY_KEY_BOOT_FACTORY_VALUE;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                        gd-&gt;key_pressd_value = RECOVERY_KEY_BOOT_RECOVERY_VALUE;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sunxi_flash_boot_init</span><span class="params">(<span class="type">int</span> storage_type, <span class="type">int</span> workmode)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> state;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (storage_type) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_NAND</span></span><br><span class="line">        <span class="keyword">case</span> STORAGE_NAND:</span><br><span class="line">        <span class="keyword">case</span> STORAGE_SPI_NAND: &#123;</span><br><span class="line">                <span class="type">int</span> boot_mode = workmode == WORK_MODE_SPRITE_RECOVERY ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">                current_flash = &amp;sunxi_nand_desc;</span><br><span class="line">                state    = current_flash-&gt;init(boot_mode, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_SDMMC</span></span><br><span class="line">        <span class="keyword">case</span> STORAGE_SD:</span><br><span class="line">        <span class="keyword">case</span> STORAGE_EMMC:</span><br><span class="line">        <span class="keyword">case</span> STORAGE_EMMC3: &#123;</span><br><span class="line">                <span class="type">int</span> card_no;</span><br><span class="line">                <span class="comment">//sdmmc handle init</span></span><br><span class="line">                <span class="keyword">if</span> (storage_type == STORAGE_SD)</span><br><span class="line">                        card_no = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (storage_type == STORAGE_EMMC)</span><br><span class="line">                        card_no = <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                        card_no = <span class="number">3</span>;</span><br><span class="line">                <span class="keyword">if</span> (workmode == WORK_MODE_CARD_PRODUCT)</span><br><span class="line">                        current_flash = &amp;sunxi_sdmmcs_desc;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                        current_flash = &amp;sunxi_sdmmc_desc;</span><br><span class="line">                state                 = current_flash-&gt;init(workmode, card_no);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SUNXI_SPINOR</span></span><br><span class="line">        <span class="keyword">case</span> STORAGE_NOR: &#123;</span><br><span class="line">                current_flash = &amp;sunxi_spinor_desc;</span><br><span class="line">                state    = current_flash-&gt;init(workmode, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">                pr_err(<span class="string">&quot;not support\n&quot;</span>);</span><br><span class="line">                state = <span class="number">-1</span>;</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (state != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        sprite_flash = current_flash;</span><br><span class="line">        tick_printf(<span class="string">&quot;sunxi flash init ok\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/05/31/killer-blog/Linux/uboot_1/" data-id="cmbcy7rhj0028t8mtg816fngh" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-killer-blog/C_CPP/understand_c" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/05/31/killer-blog/C_CPP/understand_c/" class="article-date">
  <time class="dt-published" datetime="2025-05-31T17:16:20.235Z" itemprop="datePublished">2025-05-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="一、编译器"><a href="#一、编译器" class="headerlink" title="一、编译器"></a>一、编译器</h2><p>定义一门编程语言的是他的编译器</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/05/31/killer-blog/C_CPP/understand_c/" data-id="cmbcy7rgq0002t8mt9cci70s7" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-killer-blog/Linux/KProbeLabs" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/05/31/killer-blog/Linux/KProbeLabs/" class="article-date">
  <time class="dt-published" datetime="2025-05-31T17:16:20.235Z" itemprop="datePublished">2025-05-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/05/31/killer-blog/Linux/KProbeLabs/" data-id="cmbcy7rh3000zt8mtcw9xfvar" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-killer-blog/Linux/Linux_source_setup_env" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/05/31/killer-blog/Linux/Linux_source_setup_env/" class="article-date">
  <time class="dt-published" datetime="2025-05-31T17:16:20.235Z" itemprop="datePublished">2025-05-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Linux内核源码学习（一）环境搭建"><a href="#Linux内核源码学习（一）环境搭建" class="headerlink" title="Linux内核源码学习（一）环境搭建"></a>Linux内核源码学习（一）环境搭建</h1><h2 id="一、Ubuntu虚拟机"><a href="#一、Ubuntu虚拟机" class="headerlink" title="一、Ubuntu虚拟机"></a>一、Ubuntu虚拟机</h2><p>网络使用桥接模式连接，首先准备一个ubuntu 虚拟机，不推荐WSL2了，坑太多了。我这里使用的是ubuntu20.04 lts</p>
<h2 id="二、QEMU-环境搭建"><a href="#二、QEMU-环境搭建" class="headerlink" title="二、QEMU 环境搭建"></a>二、QEMU 环境搭建</h2><p>使用QEMU模拟一个arm 开发板，在这个虚拟的arm板子上可以对内核进行debug。参考<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/681323420">手把手教你搭建ARM32 QEMU环境 - 知乎 (zhihu.com)</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装一些必须的工具</span></span><br><span class="line">apt install gcc make flex bison qemu qemu-utils gcc-arm-linux-gnueabi qemu-system-arm gdb-multiarch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载linux-5.10</span></span><br><span class="line">git <span class="built_in">clone</span> https://gitee.com/mirrors/linux_old1.git --depth 1</span><br><span class="line"><span class="comment"># 编译kernel</span></span><br><span class="line">make CROSS_COMPILE=arm-linux-gnueabi- ARCH=arm vexpress_defconfig</span><br><span class="line">make CROSS_COMPILE=arm-linux-gnueabi- ARCH=arm -j8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载busybox</span></span><br><span class="line"><span class="built_in">sudo</span> wget https://www.busybox.net/downloads/busybox-1.36.1.tar.bz2</span><br><span class="line"><span class="built_in">sudo</span> tar -xjf busybox-1.36.1.tar.bz2</span><br><span class="line"><span class="comment"># 编译busybox</span></span><br><span class="line">make defconfig CROSS_COMPILE=arm-linux-gnueabi- ARCH=arm</span><br><span class="line">make -j8 CROSS_COMPILE=arm-linux-gnueabi- ARCH=arm</span><br><span class="line"><span class="comment"># 在_install目录生成根文件系统所需的内容</span></span><br><span class="line">make install</span><br><span class="line">~/busybox-1.36.1/_install$ <span class="built_in">ls</span></span><br><span class="line">bin  linuxrc  sbin  usr</span><br><span class="line"></span><br><span class="line"><span class="comment">#现在开始制作根文件系统</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> roootfs</span><br><span class="line"><span class="built_in">mkdir</span> -p rootfs/lib</span><br><span class="line"><span class="built_in">cp</span> -r /usr/arm-linux-gnueabi/lib/ rootfs/lib/</span><br><span class="line"><span class="built_in">cp</span> -r _install/* rootfs</span><br><span class="line"><span class="built_in">mkdir</span> -p rootfs/dev/</span><br><span class="line"><span class="built_in">mkdir</span> -p  etc/init.d</span><br><span class="line">vim rootfs/etc/init.d/rcS</span><br><span class="line"><span class="comment"># 在rcS填入以下内容</span></span><br><span class="line"><span class="comment">#!/bin/sh </span></span><br><span class="line">/bin/mount -a</span><br><span class="line"><span class="built_in">echo</span> /sbin/mdev &gt; /proc/sys/kernel/hotplug </span><br><span class="line">/sbin/mdev -s  </span><br><span class="line"></span><br><span class="line">vim etc/fatab</span><br><span class="line"><span class="comment"># 在fstab填入以下内容</span></span><br><span class="line"><span class="comment">#device mount-point type options dump fsck orde</span></span><br><span class="line">proc   /proc  proc  defaults  0  0</span><br><span class="line">tpfs  /tmp   tmpfs defaults  0  0</span><br><span class="line">sysfs  /sys   sysfs defaults  0  0</span><br><span class="line">tmpfs  /dev   tmpfs defaults  0  0 </span><br><span class="line"></span><br><span class="line">vim etc/inittab</span><br><span class="line"><span class="comment"># 在inittab填入以下内容</span></span><br><span class="line">::sysinit:/etc/init.d/rcS </span><br><span class="line">::askfirst:-/bin/sh</span><br><span class="line">::restart:/sbin/init </span><br><span class="line">::ctrlaltdel:/sbin/reboot </span><br><span class="line"></span><br><span class="line">vim etc/profile</span><br><span class="line"><span class="comment"># 在profile填入以下内容</span></span><br><span class="line"><span class="built_in">export</span> HOSTNAME=HQYJ</span><br><span class="line"><span class="built_in">export</span> USER=root</span><br><span class="line"><span class="built_in">export</span> HOME=ot</span><br><span class="line"><span class="comment">#export PS1=&quot;\[\u@\h \W\ ]\$ &quot;</span></span><br><span class="line"><span class="comment">#cd root</span></span><br><span class="line"><span class="built_in">export</span> PS1=<span class="string">&quot;[<span class="variable">$USER</span>@<span class="variable">$HOSTNAME</span> \W]\# &quot;</span></span><br><span class="line">PATH=/bin:/sbin:/usr/bin:/usr/sbin</span><br><span class="line">LD_LIBRARY_PATH=/lib:/usr/lib:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line"><span class="built_in">export</span> PATH LD_LIBRARY_PATH</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建其他目录</span></span><br><span class="line"><span class="built_in">mkdir</span> lib mnt proc root sys tmp var</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mknod</span> -m 666 tty1 c 4 1 </span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mknod</span> -m 666 tty2 c 4 2</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mknod</span> -m 666 tty3 c 4 3</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mknod</span> -m 666 tty4 c 4 4</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mknod</span> -m 666 console c 5 1</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mknod</span> -m 666 null c 1 3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 制作根文件系统镜像rootfs.ext4</span></span><br><span class="line"><span class="built_in">sudo</span> mount -t ext4 rootfs.ext4 /mnt -o loop</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> -r rootfs/* /mnt</span><br><span class="line"><span class="built_in">sudo</span> umount /mnt</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> rootfs.ext4 ../linux-5.10/</span><br></pre></td></tr></table></figure>

<h3 id="开始GDB调试"><a href="#开始GDB调试" class="headerlink" title="开始GDB调试"></a>开始GDB调试</h3><p>启动qemu，模拟vexpress-a9开发板，-gdb tcp::8899表示开启gdb server 在8899端口监听，-S表示等待gdb 连接ok后再运行kernel</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> qemu-system-arm -M vexpress-a9 -m 512M -kernel ./arch/arm/boot/zImage -dtb ./arch/arm/boot/dts/arm/vexpress-v2p-ca9.dtb -nographic -append <span class="string">&quot;root=/dev/mmcblk0 rw console=ttyAMA0 rootwait rootfstype=ext4&quot;</span> -sd rootfs.ext4 -gdb tcp::8899 -S</span><br></pre></td></tr></table></figure>



<p>重新开启一个终端，运行gdb：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb-multiarch vmlinux</span><br><span class="line"><span class="comment"># 在gdb中输入下面命令连接到qemu的gdb server</span></span><br><span class="line">target remote localhost:8899</span><br></pre></td></tr></table></figure>

<h2 id="三、rk1103"><a href="#三、rk1103" class="headerlink" title="三、rk1103"></a>三、rk1103</h2><p>这里我们以luckfox-pico min B 开发版作为我们实际学习的硬件平台。这是因为我们实际工作中都是在ARM平台的，使用真实的硬件平台对于我们来说，还可以进一步了解其flash 以及uboot启动流程，以及后续可以使用该平台做一些有趣的项目。</p>
<blockquote>
<p>为什么使用这个平台？<br>首先是价格，50块的价格可以买到一个ARM开发版，功能全面，开发文档也较丰富。开发版本身是一块核心板，可以嵌入到很多产品中。</p>
</blockquote>
<h3 id="官网资料"><a href="#官网资料" class="headerlink" title="官网资料"></a>官网资料</h3><p>官网的资料做的就非常不错，<a target="_blank" rel="noopener" href="https://wiki.luckfox.com/zh/Luckfox-Pico/Luckfox-Pico-RV1103/Luckfox-Pico-Plus-Mini/Luckfox-Pico-quick-start">上手教程 | LUCKFOX WIKI</a><br>我基本上就是参考上面的设置来做的。建议学习顺序：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://wiki.luckfox.com/zh/Luckfox-Pico/Luckfox-Pico-RV1103/Luckfox-Pico-Plus-Mini/Luckfox-Pico-prepare">准备事项 | LUCKFOX WIKI</a>安装驱动以及image，先试试能否正常烧录</li>
<li><a target="_blank" rel="noopener" href="https://wiki.luckfox.com/zh/Luckfox-Pico/Luckfox-Pico-RV1103/Luckfox-Pico-Plus-Mini/Luckfox-Pico-Flash-burn-image">SPI NAND Flash 镜像烧录 | LUCKFOX WIKI</a>使用tool烧录到nand里</li>
<li><a target="_blank" rel="noopener" href="https://wiki.luckfox.com/zh/Luckfox-Pico/Luckfox-Pico-RV1103/Luckfox-Pico-Plus-Mini/Linux-MacOS-Burn-Image">Linux&#x2F;MacOS 镜像烧录 | LUCKFOX WIKI</a>若可以的话，建议在虚拟机里进行烧录、调试，不要经过windows。我们设置vmware station，在插入usb时，将usb直接连接到虚拟机。</li>
<li><a target="_blank" rel="noopener" href="https://wiki.luckfox.com/zh/Luckfox-Pico/Luckfox-Pico-RV1103/Luckfox-Pico-Plus-Mini/SSH-Telnet-Login">SSH&#x2F;Telnet 登录 | LUCKFOX WIKI</a>在虚拟机内使用ssh进行登陆板子。虽然 板子没有网口，但是可以使用USB模拟网口，使板子拥有网络。官网的wiki是在windows下配置的，我这里出了一个在Linux下的wiki：[[操作备忘录#在虚拟机中连接板子]]</li>
<li><a target="_blank" rel="noopener" href="https://wiki.luckfox.com/zh/Luckfox-Pico/Luckfox-Pico-RV1103/Luckfox-Pico-Plus-Mini/Luckfox-Pico-File-Transfer">文件传输 | LUCKFOX WIKI</a>推荐使用scp进行文件传输，主要是将我们编译的驱动、app传输到板子进行调试</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/05/31/killer-blog/Linux/Linux_source_setup_env/" data-id="cmbcy7rh40012t8mta1n874ji" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-killer-blog/Linux/Linux_isr_3" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/05/31/killer-blog/Linux/Linux_isr_3/" class="article-date">
  <time class="dt-published" datetime="2025-05-31T17:16:20.235Z" itemprop="datePublished">2025-05-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Linux中断系统（三）中断控制器"><a href="#Linux中断系统（三）中断控制器" class="headerlink" title="Linux中断系统（三）中断控制器"></a>Linux中断系统（三）中断控制器</h1><h2 id="一、irq-chip-generic"><a href="#一、irq-chip-generic" class="headerlink" title="一、irq_chip_generic"></a>一、irq_chip_generic</h2><p>在中断系统的软硬件实现中，中断控制器是最核心的部分。多个中断信号输入到控制器，控制器管理这些中断信号的优先级、开关、触发方式，并输出一个中断信号给下一级处理。<br>例如通用中断控制器GIC，在芯片中负责管理所有的外设中断，并将中断信号传递给CPU。按键按下，GPIO1控制器产生中断信号到GIC中断控制器，条件合理时，GIC将产生中断信号给CPU。CPU需要通过一层层的读取中断控制器，来确定最终的中断源，也就是GPIO1_2对应的按键中断。</p>
<p>另外像GPIO控制器、IIC控制器、UART控制器等，这些控制器也能实现中断的控制功能，都可以设置、使能、产生中断信号，这些也是中断控制器，在linux中用<code>srruct irq_chip_generic</code>来抽象描述有类似功能的中断控制器。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">irq_chip_generic</span> &#123;</span></span><br><span class="line">	<span class="type">raw_spinlock_t</span>		lock;</span><br><span class="line">	<span class="type">void</span> __iomem		*reg_base;  <span class="comment">//中断芯片虚拟基地址</span></span><br><span class="line">	u32			(*reg_readl)(<span class="type">void</span> __iomem *addr);  <span class="comment">//读写寄存器的函数</span></span><br><span class="line">	<span class="type">void</span>			(*reg_writel)(u32 val, <span class="type">void</span> __iomem *addr);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		irq_base;  <span class="comment">//中断起始号</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		irq_cnt;  <span class="comment">//中断数量</span></span><br><span class="line">	u32			mask_cache;  <span class="comment">//一些寄存器的缓存</span></span><br><span class="line">	u32			type_cache;</span><br><span class="line">	u32			polarity_cache;</span><br><span class="line">	u32			wake_enabled;</span><br><span class="line">	u32			wake_active;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		num_ct;  <span class="comment">//chip_types的数量</span></span><br><span class="line">	<span class="type">void</span>			*private;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		installed;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		unused;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_domain</span>	*<span class="title">domain</span>;</span>  <span class="comment">//管理硬件中断号到软件中断号的映射</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_chip_type</span>	<span class="title">chip_types</span>[0];</span>  <span class="comment">//保存中断寄存器、中断处理函数等</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>使用中断芯片就是需要去读写其寄存器来配置中断，这可以用两个结构体来描述。<br><code>struct irq_chip_type</code> 和 <code>struct irq_chip</code></p>
<p>一般来说，一个<code>irq_chip_generic</code> 就有一个<code> irq_chip_type</code>，描述了中断芯片的功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">irq_chip_type</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_chip</span>		<span class="title">chip</span>;</span>  <span class="comment">//控制器的回调函数</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_chip_regs</span>	<span class="title">regs</span>;</span>  <span class="comment">//寄存器的偏移地址</span></span><br><span class="line">	<span class="type">irq_flow_handler_t</span>	handler;  <span class="comment">//中断流处理函数</span></span><br><span class="line">	u32			type;</span><br><span class="line">	u32			mask_cache_priv;</span><br><span class="line">	u32			*mask_cache;  <span class="comment">//指向cached mask register</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>当初始化一个通用中断控制器时，我们设置了寄存器信息，回调函数，中断流处理函数。当中断产生时，中断流处理函数会执行，获取具体外设的中断号，去执行对应的irqaction。并调用中断芯片提供的api接口，去设置寄存器的ack位，响应中断。</p>
<p>这里的芯片api接口，就是由<code>irq_chip</code>结构体来描述的，这个结构体定义了许多接口函数，驱动需要根据实际情况，按需实现函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct irq_chip - hardware interrupt chip descriptor</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @name:		name for /proc/interrupts</span></span><br><span class="line"><span class="comment"> * @irq_startup:	start up the interrupt (defaults to -&gt;enable if NULL)</span></span><br><span class="line"><span class="comment"> * @irq_shutdown:	shut down the interrupt (defaults to -&gt;disable if NULL)</span></span><br><span class="line"><span class="comment"> * @irq_enable:		enable the interrupt (defaults to chip-&gt;unmask if NULL)</span></span><br><span class="line"><span class="comment"> * @irq_disable:	disable the interrupt</span></span><br><span class="line"><span class="comment"> * @irq_ack:		start of a new interrupt</span></span><br><span class="line"><span class="comment"> * @irq_mask:		mask an interrupt source</span></span><br><span class="line"><span class="comment"> * @irq_mask_ack:	ack and mask an interrupt source</span></span><br><span class="line"><span class="comment"> * @irq_unmask:		unmask an interrupt source</span></span><br><span class="line"><span class="comment"> * @irq_eoi:		end of interrupt</span></span><br><span class="line"><span class="comment"> * @irq_set_affinity:	set the CPU affinity on SMP machines</span></span><br><span class="line"><span class="comment"> * @irq_retrigger:	resend an IRQ to the CPU</span></span><br><span class="line"><span class="comment"> * @irq_set_type:	set the flow type (IRQ_TYPE_LEVEL/etc.) of an IRQ</span></span><br><span class="line"><span class="comment"> * @irq_set_wake:	enable/disable power-management wake-on of an IRQ</span></span><br><span class="line"><span class="comment"> * @irq_bus_lock:	function to lock access to slow bus (i2c) chips</span></span><br><span class="line"><span class="comment"> * @irq_bus_sync_unlock:function to sync and unlock slow bus (i2c) chips</span></span><br><span class="line"><span class="comment"> * @irq_cpu_online:	configure an interrupt source for a secondary CPU</span></span><br><span class="line"><span class="comment"> * @irq_cpu_offline:	un-configure an interrupt source for a secondary CPU</span></span><br><span class="line"><span class="comment"> * @irq_suspend:	function called from core code on suspend once per chip</span></span><br><span class="line"><span class="comment"> * @irq_resume:		function called from core code on resume once per chip</span></span><br><span class="line"><span class="comment"> * @irq_pm_shutdown:	function called from core code on shutdown once per chip</span></span><br><span class="line"><span class="comment"> * @irq_calc_mask:	Optional function to set irq_data.mask for special cases</span></span><br><span class="line"><span class="comment"> * @irq_print_chip:	optional to print special chip info in show_interrupts</span></span><br><span class="line"><span class="comment"> * @irq_request_resources:	optional to request resources before calling</span></span><br><span class="line"><span class="comment"> *				any other callback related to this irq</span></span><br><span class="line"><span class="comment"> * @irq_release_resources:	optional to release resources acquired with</span></span><br><span class="line"><span class="comment"> *				irq_request_resources</span></span><br><span class="line"><span class="comment"> * @irq_compose_msi_msg:	optional to compose message content for MSI</span></span><br><span class="line"><span class="comment"> * @irq_write_msi_msg:	optional to write message content for MSI</span></span><br><span class="line"><span class="comment"> * @irq_get_irqchip_state:	return the internal state of an interrupt</span></span><br><span class="line"><span class="comment"> * @irq_set_irqchip_state:	set the internal state of a interrupt</span></span><br><span class="line"><span class="comment"> * @flags:		chip specific flags</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">irq_chip</span> &#123;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span>	*name;</span><br><span class="line">	<span class="type">unsigned</span> <span class="title function_">int</span>	<span class="params">(*irq_startup)</span><span class="params">(<span class="keyword">struct</span> irq_data *data)</span>;  </span><br><span class="line">	<span class="type">void</span>		(*irq_shutdown)(<span class="keyword">struct</span> irq_data *data);</span><br><span class="line">	<span class="type">void</span>		(*irq_enable)(<span class="keyword">struct</span> irq_data *data);</span><br><span class="line">	<span class="type">void</span>		(*irq_disable)(<span class="keyword">struct</span> irq_data *data);</span><br><span class="line"></span><br><span class="line">	<span class="type">void</span>		(*irq_ack)(<span class="keyword">struct</span> irq_data *data);</span><br><span class="line">	<span class="type">void</span>		(*irq_mask)(<span class="keyword">struct</span> irq_data *data);</span><br><span class="line">	<span class="type">void</span>		(*irq_mask_ack)(<span class="keyword">struct</span> irq_data *data);</span><br><span class="line">	<span class="type">void</span>		(*irq_unmask)(<span class="keyword">struct</span> irq_data *data);</span><br><span class="line">	<span class="type">void</span>		(*irq_eoi)(<span class="keyword">struct</span> irq_data *data);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span>		(*irq_set_affinity)(<span class="keyword">struct</span> irq_data *data, <span class="type">const</span> <span class="keyword">struct</span> cpumask *dest, <span class="type">bool</span> force);</span><br><span class="line">	<span class="type">int</span>		(*irq_retrigger)(<span class="keyword">struct</span> irq_data *data);</span><br><span class="line">	<span class="type">int</span>		(*irq_set_type)(<span class="keyword">struct</span> irq_data *data, <span class="type">unsigned</span> <span class="type">int</span> flow_type);</span><br><span class="line">	<span class="type">int</span>		(*irq_set_wake)(<span class="keyword">struct</span> irq_data *data, <span class="type">unsigned</span> <span class="type">int</span> on);</span><br><span class="line"></span><br><span class="line">	<span class="type">void</span>		(*irq_bus_lock)(<span class="keyword">struct</span> irq_data *data);</span><br><span class="line">	<span class="type">void</span>		(*irq_bus_sync_unlock)(<span class="keyword">struct</span> irq_data *data);</span><br><span class="line"></span><br><span class="line">	<span class="type">void</span>		(*irq_cpu_online)(<span class="keyword">struct</span> irq_data *data);</span><br><span class="line">	<span class="type">void</span>		(*irq_cpu_offline)(<span class="keyword">struct</span> irq_data *data);</span><br><span class="line"></span><br><span class="line">	<span class="type">void</span>		(*irq_suspend)(<span class="keyword">struct</span> irq_data *data);</span><br><span class="line">	<span class="type">void</span>		(*irq_resume)(<span class="keyword">struct</span> irq_data *data);</span><br><span class="line">	<span class="type">void</span>		(*irq_pm_shutdown)(<span class="keyword">struct</span> irq_data *data);</span><br><span class="line"></span><br><span class="line">	<span class="type">void</span>		(*irq_calc_mask)(<span class="keyword">struct</span> irq_data *data);</span><br><span class="line"></span><br><span class="line">	<span class="type">void</span>		(*irq_print_chip)(<span class="keyword">struct</span> irq_data *data, <span class="keyword">struct</span> seq_file *p);</span><br><span class="line">	<span class="type">int</span>		(*irq_request_resources)(<span class="keyword">struct</span> irq_data *data);</span><br><span class="line">	<span class="type">void</span>		(*irq_release_resources)(<span class="keyword">struct</span> irq_data *data);</span><br><span class="line"></span><br><span class="line">	<span class="type">void</span>		(*irq_compose_msi_msg)(<span class="keyword">struct</span> irq_data *data, <span class="keyword">struct</span> msi_msg *msg);</span><br><span class="line">	<span class="type">void</span>		(*irq_write_msi_msg)(<span class="keyword">struct</span> irq_data *data, <span class="keyword">struct</span> msi_msg *msg);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span>		(*irq_get_irqchip_state)(<span class="keyword">struct</span> irq_data *data, <span class="keyword">enum</span> irqchip_irq_state which, <span class="type">bool</span> *state);</span><br><span class="line">	<span class="type">int</span>		(*irq_set_irqchip_state)(<span class="keyword">struct</span> irq_data *data, <span class="keyword">enum</span> irqchip_irq_state which, <span class="type">bool</span> state);</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	flags;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>对于<code>irq_chip</code>这些接口函数，可以利用linux中提供的一些实现：<br>例如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"> &#123;</span><br><span class="line"> 	<span class="class"><span class="keyword">struct</span> <span class="title">irq_chip</span>		<span class="title">chip</span></span></span><br><span class="line"><span class="class"> 	<span class="title">chip</span>.<span class="title">irq_ack</span> =</span> irq_gc_ack_set_bit;</span><br><span class="line">	chip.irq_mask = irq_gc_mask_clr_bit;</span><br><span class="line">	chip.irq_unmask = irq_gc_mask_set_bit;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//ack指定中断</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">irq_gc_ack_set_bit</span><span class="params">(<span class="keyword">struct</span> irq_data *d)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//通过irq_data获取中断芯片对象</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_chip_generic</span> *<span class="title">gc</span> =</span> irq_data_get_irq_chip_data(d);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_chip_type</span> *<span class="title">ct</span> =</span> irq_data_get_chip_type(d);</span><br><span class="line">	u32 mask = d-&gt;mask;</span><br><span class="line"></span><br><span class="line">	irq_gc_lock(gc);</span><br><span class="line">	<span class="comment">//将mask的值写入寄存器regs.ack</span></span><br><span class="line">	irq_reg_writel(gc, mask, ct-&gt;regs.ack);</span><br><span class="line">	irq_gc_unlock(gc);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(irq_gc_ack_set_bit);</span><br><span class="line"></span><br><span class="line"> <span class="comment">//清除mask寄存器的某个位</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">irq_gc_mask_clr_bit</span><span class="params">(<span class="keyword">struct</span> irq_data *d)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_chip_generic</span> *<span class="title">gc</span> =</span> irq_data_get_irq_chip_data(d);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_chip_type</span> *<span class="title">ct</span> =</span> irq_data_get_chip_type(d);</span><br><span class="line">	u32 mask = d-&gt;mask;</span><br><span class="line"></span><br><span class="line">	irq_gc_lock(gc);</span><br><span class="line">	*ct-&gt;mask_cache &amp;= ~mask;</span><br><span class="line">	irq_reg_writel(gc, *ct-&gt;mask_cache, ct-&gt;regs.mask);</span><br><span class="line">	irq_gc_unlock(gc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//设置mask寄存器的某个位</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">irq_gc_mask_set_bit</span><span class="params">(<span class="keyword">struct</span> irq_data *d)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_chip_generic</span> *<span class="title">gc</span> =</span> irq_data_get_irq_chip_data(d);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_chip_type</span> *<span class="title">ct</span> =</span> irq_data_get_chip_type(d);</span><br><span class="line">	u32 mask = d-&gt;mask;</span><br><span class="line"></span><br><span class="line">	irq_gc_lock(gc);</span><br><span class="line">	*ct-&gt;mask_cache |= mask;</span><br><span class="line">	irq_reg_writel(gc, *ct-&gt;mask_cache, ct-&gt;regs.mask);</span><br><span class="line">	irq_gc_unlock(gc);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(irq_gc_mask_set_bit);</span><br></pre></td></tr></table></figure>

<h3 id="api"><a href="#api" class="headerlink" title="api"></a>api</h3><p>linux提供 <code>irq_alloc_generic_chip</code> 和 <code>irq_setup_generic_chip</code> 来初始化generic_chip：</p>
<p>irq_alloc_generic_chip，初始化需要提供参数：</p>
<ol>
<li>name：irq_chip的名称</li>
<li>num_cnt：chip_type的数量，一般是1</li>
<li>irq_base：中断号</li>
<li>reg_base：寄存器基地址</li>
<li>handler：中断流处理函数，即中断控制器响应自身中断的逻辑<br>该函数主要实现了初始化 irq_chip_generic 对象，设置成员变量</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> irq_chip_generic *<span class="title function_">irq_alloc_generic_chip</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name, <span class="type">int</span> num_ct, <span class="type">unsigned</span> <span class="type">int</span> irq_base,<span class="type">void</span> __iomem *reg_base, <span class="type">irq_flow_handler_t</span> handler)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_chip_generic</span> *<span class="title">gc</span>;</span></span><br><span class="line">	<span class="comment">//计算需要的内存 irq_chip_type 的影响</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> sz = <span class="keyword">sizeof</span>(*gc) + num_ct * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> irq_chip_type);</span><br><span class="line">	<span class="comment">//申请内存</span></span><br><span class="line">	gc = kzalloc(sz, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (gc) &#123;</span><br><span class="line">		<span class="comment">//初始化结构体</span></span><br><span class="line">		irq_init_generic_chip(gc, name, num_ct, irq_base, reg_base,</span><br><span class="line">				      handler);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> gc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//很简单，设置generic_chip结构体</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">irq_init_generic_chip</span><span class="params">(<span class="keyword">struct</span> irq_chip_generic *gc, <span class="type">const</span> <span class="type">char</span> *name,</span></span><br><span class="line"><span class="params">		      <span class="type">int</span> num_ct, <span class="type">unsigned</span> <span class="type">int</span> irq_base,</span></span><br><span class="line"><span class="params">		      <span class="type">void</span> __iomem *reg_base, <span class="type">irq_flow_handler_t</span> handler)</span></span><br><span class="line">&#123;</span><br><span class="line">	raw_spin_lock_init(&amp;gc-&gt;lock);</span><br><span class="line">	gc-&gt;num_ct = num_ct;</span><br><span class="line">	gc-&gt;irq_base = irq_base;</span><br><span class="line">	gc-&gt;reg_base = reg_base;</span><br><span class="line">	gc-&gt;chip_types-&gt;chip.name = name;</span><br><span class="line">	gc-&gt;chip_types-&gt;handler = handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>irq_setup_generic_chip</code>用于建立&#x2F;使能控制器中的中断信号。msk参数以位掩码的形式表示哪些中断被使能。例如0b1100，表示 irq为gc-&gt;irq_base+3，gc-&gt;irq_base+4 的中断信号被使能。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据配置设置中断芯片下所有的irqdesc</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">irq_setup_generic_chip</span><span class="params">(<span class="keyword">struct</span> irq_chip_generic *gc, u32 msk,</span></span><br><span class="line"><span class="params">			    <span class="keyword">enum</span> irq_gc_flags flags, <span class="type">unsigned</span> <span class="type">int</span> clr,</span></span><br><span class="line"><span class="params">			    <span class="type">unsigned</span> <span class="type">int</span> <span class="built_in">set</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_chip_type</span> *<span class="title">ct</span> =</span> gc-&gt;chip_types;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_chip</span> *<span class="title">chip</span> =</span> &amp;ct-&gt;chip;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> i;</span><br><span class="line">	<span class="comment">//把gc添加到全局的gc链表</span></span><br><span class="line">	raw_spin_lock(&amp;gc_lock);</span><br><span class="line">	list_add_tail(&amp;gc-&gt;<span class="built_in">list</span>, &amp;gc_list);</span><br><span class="line">	raw_spin_unlock(&amp;gc_lock);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//根据flags初始化mask_cache</span></span><br><span class="line">	irq_gc_init_mask_cache(gc, flags);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//遍历整个mask的bits，i表示的是irq number虚拟中断号</span></span><br><span class="line">	<span class="keyword">for</span> (i = gc-&gt;irq_base; msk; msk &gt;&gt;= <span class="number">1</span>, i++) &#123;</span><br><span class="line">		<span class="comment">//若mask上的bit未使能，则跳过</span></span><br><span class="line">		<span class="keyword">if</span> (!(msk &amp; <span class="number">0x01</span>))</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (flags &amp; IRQ_GC_INIT_NESTED_LOCK)</span><br><span class="line">			irq_set_lockdep_class(i, &amp;irq_nested_lock_class);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!(flags &amp; IRQ_GC_NO_MASK)) &#123;</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">irq_data</span> *<span class="title">d</span> =</span> irq_get_irq_data(i);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (chip-&gt;irq_calc_mask)</span><br><span class="line">				chip-&gt;irq_calc_mask(d);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				d-&gt;mask = <span class="number">1</span> &lt;&lt; (i - gc-&gt;irq_base);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//设置对应irqdesc的irq_chip和中断处理函数、chip_data</span></span><br><span class="line">		irq_set_chip_and_handler(i, chip, ct-&gt;handler);</span><br><span class="line">		irq_set_chip_data(i, gc);</span><br><span class="line">		irq_modify_status(i, clr, <span class="built_in">set</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//计算实际使用的irq数量</span></span><br><span class="line">	gc-&gt;irq_cnt = i - gc-&gt;irq_base;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其他API</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//设置mask寄存器的某个位</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">irq_gc_mask_set_bit</span><span class="params">(<span class="keyword">struct</span> irq_data *d)</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//清除mask寄存器的某个位</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">irq_gc_mask_clr_bit</span><span class="params">(<span class="keyword">struct</span> irq_data *d)</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//ack指定中断</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">irq_gc_ack_set_bit</span><span class="params">(<span class="keyword">struct</span> irq_data *d)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h2 id="二、irq-domain"><a href="#二、irq-domain" class="headerlink" title="二、irq_domain"></a>二、irq_domain</h2><blockquote>
<p>中断控制器是负责输入多个中断信号，管理这些中断信号的优先级、开关、触发方式，并输出一个中断信号给下一级处理。<br>例如通用中断控制器GIC，在芯片中负责管理所有的外设中断，并将中断信号传递给CPU。按键按下，GPIO1控制器产生中断信号到GIC中断控制器，条件合理时，GIC将产生中断信号给CPU。CPU需要通过一层层的读取中断控制器，来确定最终的中断源，也就是GPIO1_2对应的按键中断。</p>
</blockquote>
<p>中断信号一般由这样的过程构成：</p>
<ol>
<li>中断源，比如按键</li>
<li>外设控制器，比如GPIO控制器</li>
<li>GIC，通用中断控制器</li>
<li>CPU</li>
</ol>
<p>对应在软件上，中断的一般处理流程如下：</p>
<ol>
<li>CPU产生IRQ中断，跳转到IRQ_Handler</li>
<li>IRQ_Handler中读取GIC状态寄存器，判断是哪个具体的外设产生的中断，跳转到GPIOx_handler</li>
<li>GPIOx_handler：读取该GPIO控制器的寄存器，判断哪个IO产生的中断，拿到对应的irqdesc</li>
<li>执行irqdesc中驱动设置的中断回调函数irqaction</li>
</ol>
<p>软件的中断处理就是硬件中断信号的逆过程。软件需要通过一层层地读取中断控制器的寄存器来确定具体的中断源。<br>这里有一个问题：在确定中断源是GPIO1_2后，如何找到我们之前注册的按键中断处理函数？</p>
<p>答案就是中断号。我们可以通过中断号来找到irqdesc，irqdesc对象中就有中断处理函数。</p>
<p>但是还有一个问题，就是在一个系统中，hw_irq（硬件中断号）并不是唯一的（因为GIC支持从0-1020的中断号，而GPIO1控制器支持0-31的中断号，GPIO2控制器也支持0-31的中断号），而在linux内核中，每一个irqdesc都必须由唯一的irq来区别。</p>
<p><strong>linux的解决方法是：将一个中断控制器管理的所有中断的集合称为domain（领域、范围），一个中断控制器有一个domain，领域内的每个中断号唯一。domain的作用是将hw_irq转换成linux内核中唯一的irq，这个irq称为虚拟中断号。转换的方法由开发者实现。</strong></p>
<p>这样，在同一个domain下，他们的hw_irq肯定不同；hw_irq相同时，所属的domain不同，转换的方法也不同，得到的irq也就不一样，这样就能保证irq是唯一的。</p>
<p>linux中使用<code>irq_domain</code>抽象上述的场景：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct irq_domain - Hardware interrupt number translation object</span></span><br><span class="line"><span class="comment"> * @link: Element in global irq_domain list.</span></span><br><span class="line"><span class="comment"> * @name: Name of interrupt domain</span></span><br><span class="line"><span class="comment"> * @ops: pointer to irq_domain methods</span></span><br><span class="line"><span class="comment"> * @host_data: private data pointer for use by owner.  Not touched by irq_domain</span></span><br><span class="line"><span class="comment"> *             core code.</span></span><br><span class="line"><span class="comment"> * @flags: host per irq_domain flags</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Optional elements</span></span><br><span class="line"><span class="comment"> * @of_node: Pointer to device tree nodes associated with the irq_domain. Used</span></span><br><span class="line"><span class="comment"> *           when decoding device tree interrupt specifiers.</span></span><br><span class="line"><span class="comment"> * @gc: Pointer to a list of generic chips. There is a helper function for</span></span><br><span class="line"><span class="comment"> *      setting up one or more generic chips for interrupt controllers</span></span><br><span class="line"><span class="comment"> *      drivers using the generic chip library which uses this pointer.</span></span><br><span class="line"><span class="comment"> * @parent: Pointer to parent irq_domain to support hierarchy irq_domains</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Revmap data, used internally by irq_domain</span></span><br><span class="line"><span class="comment"> * @revmap_direct_max_irq: The largest hwirq that can be set for controllers that</span></span><br><span class="line"><span class="comment"> *                         support direct mapping</span></span><br><span class="line"><span class="comment"> * @revmap_size: Size of the linear map table @linear_revmap[]</span></span><br><span class="line"><span class="comment"> * @revmap_tree: Radix map tree for hwirqs that don&#x27;t fit in the linear map</span></span><br><span class="line"><span class="comment"> * @linear_revmap: Linear table of hwirq-&gt;virq reverse mappings</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">irq_domain</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">link</span>;</span>    <span class="comment">//连接到全局domain表</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">irq_domain_ops</span> *<span class="title">ops</span>;</span>    <span class="comment">//domain的操作接口</span></span><br><span class="line">	<span class="type">void</span> *host_data;	<span class="comment">//私有数据</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Optional data */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">of_node</span>;</span>	<span class="comment">//对应的设备树节点</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_domain_chip_generic</span> *<span class="title">gc</span>;</span>	<span class="comment">//对中断控制器的抽象</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span>	CONFIG_IRQ_DOMAIN_HIERARCHY</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_domain</span> *<span class="title">parent</span>;</span>	<span class="comment">//上一级的中断控制器</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* reverse map data. The linear map gets appended to the irq_domain */</span></span><br><span class="line">	<span class="type">irq_hw_number_t</span> hwirq_max;			<span class="comment">//domain下的中断信号数量</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> revmap_direct_max_irq;	<span class="comment">//数组的最大中断号</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> revmap_size;	<span class="comment">//linear_revmap[]的长度</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">radix_tree_root</span> <span class="title">revmap_tree</span>;</span>	<span class="comment">//存放映射关系的树</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> linear_revmap[];	<span class="comment">//存放映射关系的数组</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>需要关注的成员有：</p>
<ul>
<li>const struct irq_domain_ops* ops：domain的操作接口</li>
<li>irq_hw_number_t hwirq_max：domain下的中断信号数量</li>
<li>struct radix_tree_root revmap_tree：存放映射关系的树</li>
<li>unsigned int linear_revmap[]：存放映射关系的数组</li>
</ul>
<p>domain的主要功能是hw_irq到irq的转换，就需要有数据结构存放映射关系。有radix_tree 和数组两种存储方法。比较重点的是irq_domain_ops：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//irq_domain的所有功能在此实现，每个函数需要根据中断控制器具体实现</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">irq_domain_ops</span> &#123;</span></span><br><span class="line">	<span class="type">int</span> (*match)(<span class="keyword">struct</span> irq_domain *d, <span class="keyword">struct</span> device_node *node);  <span class="comment">//匹配一个中断控制器到irq_domain</span></span><br><span class="line">	<span class="type">int</span> (*<span class="built_in">map</span>)(<span class="keyword">struct</span> irq_domain *d, <span class="type">unsigned</span> <span class="type">int</span> virq, <span class="type">irq_hw_number_t</span> hw);  <span class="comment">//创建或更新硬件中断号和虚拟中断号的映射</span></span><br><span class="line">	<span class="type">void</span> (*unmap)(<span class="keyword">struct</span> irq_domain *d, <span class="type">unsigned</span> <span class="type">int</span> virq);  <span class="comment">//取消映射</span></span><br><span class="line">	<span class="comment">//解析出设备树中的硬件中断号和中断类型</span></span><br><span class="line">	<span class="type">int</span> (*xlate)(<span class="keyword">struct</span> irq_domain *d, <span class="keyword">struct</span> device_node *node,  </span><br><span class="line">		     <span class="type">const</span> u32 *intspec, <span class="type">unsigned</span> <span class="type">int</span> intsize,</span><br><span class="line">		     <span class="type">unsigned</span> <span class="type">long</span> *out_hwirq, <span class="type">unsigned</span> <span class="type">int</span> *out_type);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span>	CONFIG_IRQ_DOMAIN_HIERARCHY</span></span><br><span class="line">	<span class="comment">/* 支持中断控制器级联 */</span></span><br><span class="line">	<span class="comment">//在当前irqdomain下分配一个新的子domain</span></span><br><span class="line">	<span class="type">int</span> (*alloc)(<span class="keyword">struct</span> irq_domain *d, <span class="type">unsigned</span> <span class="type">int</span> virq,</span><br><span class="line">		     <span class="type">unsigned</span> <span class="type">int</span> nr_irqs, <span class="type">void</span> *arg);</span><br><span class="line">	<span class="type">void</span> (*<span class="built_in">free</span>)(<span class="keyword">struct</span> irq_domain *d, <span class="type">unsigned</span> <span class="type">int</span> virq,</span><br><span class="line">		     <span class="type">unsigned</span> <span class="type">int</span> nr_irqs);</span><br><span class="line">	<span class="comment">//使能domain</span></span><br><span class="line">	<span class="type">void</span> (*activate)(<span class="keyword">struct</span> irq_domain *d, <span class="keyword">struct</span> irq_data *irq_data);</span><br><span class="line">	<span class="type">void</span> (*deactivate)(<span class="keyword">struct</span> irq_domain *d, <span class="keyword">struct</span> irq_data *irq_data);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="api-1"><a href="#api-1" class="headerlink" title="api"></a>api</h5><p>irq_domain.c 中提供函数 <code>__irq_domain_add</code> 实现创建和添加irq_domain的功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * __irq_domain_add() - Allocate a new irq_domain data structure</span></span><br><span class="line"><span class="comment"> * @of_node: optional device-tree node of the interrupt controller</span></span><br><span class="line"><span class="comment"> * @size: Size of linear map; 0 for radix mapping only</span></span><br><span class="line"><span class="comment"> * @hwirq_max: Maximum number of interrupts supported by controller</span></span><br><span class="line"><span class="comment"> * @direct_max: Maximum value of direct maps; Use ~0 for no limit; 0 for no</span></span><br><span class="line"><span class="comment"> *              direct mapping</span></span><br><span class="line"><span class="comment"> * @ops: domain callbacks</span></span><br><span class="line"><span class="comment"> * @host_data: Controller private data pointer</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Allocates and initialize and irq_domain structure.</span></span><br><span class="line"><span class="comment"> * Returns pointer to IRQ domain, or NULL on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">irq_domain</span> *__<span class="title">irq_domain_add</span>(<span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">of_node</span>, <span class="title">int</span> <span class="title">size</span>,</span></span><br><span class="line"><span class="class">				    <span class="title">irq_hw_number_t</span> <span class="title">hwirq_max</span>, <span class="title">int</span> <span class="title">direct_max</span>,</span></span><br><span class="line"><span class="class">				    <span class="title">const</span> <span class="keyword">struct</span> <span class="title">irq_domain_ops</span> *<span class="title">ops</span>,</span></span><br><span class="line"><span class="class">				    <span class="title">void</span> *<span class="title">host_data</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_domain</span> *<span class="title">domain</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//因为irq_domain的linear_revmap[]数组大小和size一样，所以需要额外的size </span></span><br><span class="line">	domain = kzalloc_node(<span class="keyword">sizeof</span>(*domain) + (<span class="keyword">sizeof</span>(<span class="type">unsigned</span> <span class="type">int</span>) * size),</span><br><span class="line">			      GFP_KERNEL, of_node_to_nid(of_node));</span><br><span class="line">	<span class="keyword">if</span> (WARN_ON(!domain))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Fill structure 填充对象*/</span></span><br><span class="line">	INIT_RADIX_TREE(&amp;domain-&gt;revmap_tree, GFP_KERNEL);</span><br><span class="line">	domain-&gt;ops = ops;</span><br><span class="line">	domain-&gt;host_data = host_data;</span><br><span class="line">	domain-&gt;of_node = of_node_get(of_node);</span><br><span class="line">	domain-&gt;hwirq_max = hwirq_max;  <span class="comment">//该domain下的中断信号数量</span></span><br><span class="line">	domain-&gt;revmap_size = size;  <span class="comment">//数组的大小</span></span><br><span class="line">	domain-&gt;revmap_direct_max_irq = direct_max;</span><br><span class="line">	irq_domain_check_hierarchy(domain);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//所住全局链表irq_domain_list</span></span><br><span class="line">	mutex_lock(&amp;irq_domain_mutex);</span><br><span class="line">	<span class="comment">//将domain插入链表</span></span><br><span class="line">	list_add(&amp;domain-&gt;link, &amp;irq_domain_list);</span><br><span class="line">	mutex_unlock(&amp;irq_domain_mutex);</span><br><span class="line"></span><br><span class="line">	pr_debug(<span class="string">&quot;Added domain %s\n&quot;</span>, domain-&gt;name);</span><br><span class="line">	<span class="keyword">return</span> domain;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(__irq_domain_add);</span><br></pre></td></tr></table></figure>


<p>irq_domain.c 中提供函数 <code>irq_domain_associate</code> 实现建立irq和hw_irq的映射关系：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//建立irq和hw_irq的映射关系</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">irq_domain_associate</span><span class="params">(<span class="keyword">struct</span> irq_domain *domain, <span class="type">unsigned</span> <span class="type">int</span> virq,</span></span><br><span class="line"><span class="params">			 <span class="type">irq_hw_number_t</span> hwirq)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//由irq_data来代表irq进行映射</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_data</span> *<span class="title">irq_data</span> =</span> irq_get_irq_data(virq);</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (WARN(hwirq &gt;= domain-&gt;hwirq_max,</span><br><span class="line">		 <span class="string">&quot;error: hwirq 0x%x is too large for %s\n&quot;</span>, (<span class="type">int</span>)hwirq, domain-&gt;name))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	<span class="keyword">if</span> (WARN(!irq_data, <span class="string">&quot;error: virq%i is not allocated&quot;</span>, virq))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	<span class="keyword">if</span> (WARN(irq_data-&gt;domain, <span class="string">&quot;error: virq%i is already associated&quot;</span>, virq))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	mutex_lock(&amp;irq_domain_mutex);</span><br><span class="line">	<span class="comment">//初始化irq_data</span></span><br><span class="line">	irq_data-&gt;hwirq = hwirq;</span><br><span class="line">	irq_data-&gt;domain = domain;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (domain-&gt;ops-&gt;<span class="built_in">map</span>) &#123;</span><br><span class="line">		<span class="comment">//建立映射关系</span></span><br><span class="line">		ret = domain-&gt;ops-&gt;<span class="built_in">map</span>(domain, virq, hwirq);</span><br><span class="line">		<span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * If map() returns -EPERM, this interrupt is protected</span></span><br><span class="line"><span class="comment">			 * by the firmware or some other service and shall not</span></span><br><span class="line"><span class="comment">			 * be mapped. Don&#x27;t bother telling the user about it.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (ret != -EPERM) &#123;</span><br><span class="line">				pr_info(<span class="string">&quot;%s didn&#x27;t like hwirq-0x%lx to VIRQ%i mapping (rc=%d)\n&quot;</span>,</span><br><span class="line">				       domain-&gt;name, hwirq, virq, ret);</span><br><span class="line">			&#125;</span><br><span class="line">			irq_data-&gt;domain = <span class="literal">NULL</span>;</span><br><span class="line">			irq_data-&gt;hwirq = <span class="number">0</span>;</span><br><span class="line">			mutex_unlock(&amp;irq_domain_mutex);</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* If not already assigned, give the domain the chip&#x27;s name */</span></span><br><span class="line">		<span class="keyword">if</span> (!domain-&gt;name &amp;&amp; irq_data-&gt;chip)</span><br><span class="line">			domain-&gt;name = irq_data-&gt;chip-&gt;name;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//保存映射关系</span></span><br><span class="line">	<span class="comment">//线性映射时hwirq&lt;revmap_size</span></span><br><span class="line">	<span class="keyword">if</span> (hwirq &lt; domain-&gt;revmap_size) &#123;</span><br><span class="line">		<span class="comment">//保存到linear_revmap数组</span></span><br><span class="line">		domain-&gt;linear_revmap[hwirq] = virq;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//树映射时，revmap_size==0，保存到树</span></span><br><span class="line">		mutex_lock(&amp;revmap_trees_mutex);</span><br><span class="line">		radix_tree_insert(&amp;domain-&gt;revmap_tree, hwirq, irq_data);</span><br><span class="line">		mutex_unlock(&amp;revmap_trees_mutex);</span><br><span class="line">	&#125;</span><br><span class="line">	mutex_unlock(&amp;irq_domain_mutex);</span><br><span class="line">	<span class="comment">//设置irqdesc的状态</span></span><br><span class="line">	irq_clear_status_flags(virq, IRQ_NOREQUEST);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(irq_domain_associate);</span><br></pre></td></tr></table></figure>

<p>另一种方法是使用设备树中的信息来建立映射关系：</p>
<p>驱动程序使用 <code>irq_of_parse_and_map</code> 解析和映射中断时，该函数实际是调用<code>irq_create_of_mapping</code>，用于建立hw_irq和irq映射关系。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用设备树创建映射</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">irq_create_of_mapping</span><span class="params">(<span class="keyword">struct</span> of_phandle_args *irq_data)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_domain</span> *<span class="title">domain</span>;</span></span><br><span class="line">	<span class="type">irq_hw_number_t</span> hwirq;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> type = IRQ_TYPE_NONE;</span><br><span class="line">	<span class="type">int</span> virq;</span><br><span class="line">	<span class="comment">//找到domain</span></span><br><span class="line">	domain = irq_data-&gt;np ? irq_find_host(irq_data-&gt;np) : irq_default_domain;</span><br><span class="line">	<span class="keyword">if</span> (!domain) &#123;</span><br><span class="line">		pr_warn(<span class="string">&quot;no irq domain found for %s !\n&quot;</span>,</span><br><span class="line">			of_node_full_name(irq_data-&gt;np));</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* If domain has no translation, then we assume interrupt line */</span></span><br><span class="line">	<span class="keyword">if</span> (domain-&gt;ops-&gt;xlate == <span class="literal">NULL</span>)</span><br><span class="line">		hwirq = irq_data-&gt;args[<span class="number">0</span>];</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//xlate负责从设备树中获取hw中断号</span></span><br><span class="line">		<span class="keyword">if</span> (domain-&gt;ops-&gt;xlate(domain, irq_data-&gt;np, irq_data-&gt;args,</span><br><span class="line">					irq_data-&gt;args_count, &amp;hwirq, &amp;type))</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//domain是否支持级联</span></span><br><span class="line">	<span class="keyword">if</span> (irq_domain_is_hierarchy(domain)) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * If we&#x27;ve already configured this interrupt,</span></span><br><span class="line"><span class="comment">		 * don&#x27;t do it again, or hell will break loose.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		 <span class="comment">//根据domain和hw_irq找到irq</span></span><br><span class="line">		virq = irq_find_mapping(domain, hwirq);</span><br><span class="line">		<span class="comment">//如果非0，说明映射关系已经建立，直接返回</span></span><br><span class="line">		<span class="keyword">if</span> (virq)</span><br><span class="line">			<span class="keyword">return</span> virq;</span><br><span class="line">		<span class="comment">//结果为0，说明映射关系未建立</span></span><br><span class="line">		<span class="comment">//分配一个新的irqdesc，并添加到domain下</span></span><br><span class="line">		virq = irq_domain_alloc_irqs(domain, <span class="number">1</span>, NUMA_NO_NODE, irq_data);</span><br><span class="line">		<span class="keyword">if</span> (virq &lt;= <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/* Create mapping */</span></span><br><span class="line">		virq = irq_create_mapping(domain, hwirq);</span><br><span class="line">		<span class="keyword">if</span> (!virq)</span><br><span class="line">			<span class="keyword">return</span> virq;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Set type if specified and different than the current one */</span></span><br><span class="line">	<span class="keyword">if</span> (type != IRQ_TYPE_NONE &amp;&amp;</span><br><span class="line">	    type != irq_get_trigger_type(virq))</span><br><span class="line">		irq_set_irq_type(virq, type);</span><br><span class="line">	<span class="keyword">return</span> virq;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(irq_create_of_mapping);</span><br></pre></td></tr></table></figure>

<p>其他API</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//移除domain</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">irq_domain_remove</span><span class="params">(<span class="keyword">struct</span> irq_domain *domain)</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//给domain中的中断信号分配irqdesc</span></span><br><span class="line"><span class="type">int</span> __irq_domain_alloc_irqs(<span class="keyword">struct</span> irq_domain *domain, <span class="type">int</span> irq_base,</span><br><span class="line">			    <span class="type">unsigned</span> <span class="type">int</span> nr_irqs, <span class="type">int</span> node, <span class="type">void</span> *arg,</span><br><span class="line">			    <span class="type">bool</span> <span class="built_in">realloc</span>);</span><br><span class="line">			</span><br></pre></td></tr></table></figure>




<h2 id="四、-中断系统初始化"><a href="#四、-中断系统初始化" class="headerlink" title="四、 中断系统初始化"></a>四、 中断系统初始化</h2><p>以上我们了解了中断的处理流程以及使用的主要结构体，那么接下来就来了解这些对象是如何初始化的。</p>
<p>中断子系统涉及到的重要的结构体有:</p>
<ol>
<li>irqdesc</li>
<li>irqdomain</li>
<li>irqaction</li>
<li>genneric_chip</li>
</ol>
<p>合理的猜测,linux启动过程初始化中断时，势必会初始化这些对象,才能使用整个中断子系统.</p>
<p>我们从内核启动函数 <code>start_kernel</code> 开始追踪,可以发现其调用了两个中断相关的函数:</p>
<ol>
<li>early_irq_init</li>
<li>init_IRQ</li>
</ol>
<p><code>early_irq_init</code>函数在前文irqdesc中已经分析过,他的作用就是初始化好irqdesc对象.</p>
<p><code>init_IRQ</code>则与芯片架构相关,ARM架构下该函数定义在 arch&#x2F;arm&#x2F;kernel&#x2F;irq.c </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ARM初始化IRQ</span></span><br><span class="line"><span class="type">void</span> __init <span class="title function_">init_IRQ</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line">	<span class="comment">//是否使用设备树 </span></span><br><span class="line">	<span class="keyword">if</span> (IS_ENABLED(CONFIG_OF) &amp;&amp; !machine_desc-&gt;init_irq)</span><br><span class="line">		<span class="comment">//初始化中断控制器</span></span><br><span class="line">		irqchip_init();</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		machine_desc-&gt;init_irq();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (IS_ENABLED(CONFIG_OF) &amp;&amp; IS_ENABLED(CONFIG_CACHE_L2X0) &amp;&amp;</span><br><span class="line">	    (machine_desc-&gt;l2c_aux_mask || machine_desc-&gt;l2c_aux_val)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!outer_cache.write_sec)</span><br><span class="line">			outer_cache.write_sec = machine_desc-&gt;l2c_write_sec;</span><br><span class="line">		ret = l2x0_of_init(machine_desc-&gt;l2c_aux_val,</span><br><span class="line">				   machine_desc-&gt;l2c_aux_mask);</span><br><span class="line">		<span class="keyword">if</span> (ret)</span><br><span class="line">			pr_err(<span class="string">&quot;L2C: failed to init: %d\n&quot;</span>, ret);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>irqchip_init 函数的目的就是初始化中断控制器,而soc上有多少的中断控制器,可以从设备树中确定.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化中断控制器</span></span><br><span class="line"><span class="type">void</span> __init <span class="title function_">irqchip_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//初始化设备树中的中断控制器，__irqchip_of_table是一个程序段</span></span><br><span class="line">	of_irq_init(__irqchip_of_table);</span><br><span class="line"></span><br><span class="line">	acpi_irq_init(); <span class="comment">//应该没有用到</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么问题是__irqchip_of_table 是什么东西呢?这里直接给出答案,在irq-gic.c中,有这样的定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IRQCHIP_DECLARE(cortex_a7_gic, <span class="string">&quot;arm,cortex-a7-gic&quot;</span>, gic_of_init);</span><br></pre></td></tr></table></figure>

<p>IRQCHIP_DECLARE宏展开后,最终可以得到:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> __<span class="title">of_table_cortex_a7_gic</span> __<span class="title">used__section</span>(__<span class="title">irqchip_of_table</span>) =</span> 		</span><br><span class="line">&#123; </span><br><span class="line">    .compatible = <span class="string">&quot;arm,cortex-a7-gic&quot;</span>,		<span class="comment">//匹配字符串名称,与设备树中compatible相同		</span></span><br><span class="line">	.data = gic_of_init,    <span class="comment">//gic初始化函数(设备树版)</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>__irqchip_of_table 中存放的就是 of_device_id 数组</p>
<p>在GIC驱动程序中,使用了多个IRQCHIP_DECLARE,__irqchip_of_table中就有很多的of_device_id</p>
<p>有了这个了解,我们就可以继续学习 <code>of_irq_init</code>,这个函数逻辑有点乱,但我们只需要明白:</p>
<p><strong>这个函数扫描设备树中的中断控制器节点，并从最上层的控制器开始调用注册的初始化函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * of_irq_init - Scan and init matching interrupt controllers in DT</span></span><br><span class="line"><span class="comment"> * @matches: 0 terminated array of nodes to match and init function to call</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function scans the device tree for matching interrupt controller nodes,</span></span><br><span class="line"><span class="comment"> * and calls their initialization functions in order with parents first.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="comment">//扫描设备树中的中断控制器节点，并从最上层的控制器开始初始化</span></span><br><span class="line"> <span class="comment">//match是一个数组，其成员包含了初始化函数</span></span><br><span class="line"><span class="type">void</span> __init <span class="title function_">of_irq_init</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> of_device_id *matches)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">np</span>, *<span class="title">parent</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">intc_desc</span> *<span class="title">desc</span>, *<span class="title">temp_desc</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">intc_desc_list</span>, <span class="title">intc_parent_list</span>;</span></span><br><span class="line">	<span class="comment">//中断控制器链表</span></span><br><span class="line">	INIT_LIST_HEAD(&amp;intc_desc_list);</span><br><span class="line">	INIT_LIST_HEAD(&amp;intc_parent_list);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//寻找设备树中定义的中断控制器，将他加入intc_desc_list</span></span><br><span class="line">	for_each_matching_node(np, matches) &#123;</span><br><span class="line">		<span class="comment">//寻找设备树节点中有&quot;interrupt-controller&quot;属性的节点，保存到np</span></span><br><span class="line">		<span class="keyword">if</span> (!of_find_property(np, <span class="string">&quot;interrupt-controller&quot;</span>, <span class="literal">NULL</span>) ||</span><br><span class="line">				!of_device_is_available(np))</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Here, we allocate and populate an intc_desc with the node</span></span><br><span class="line"><span class="comment">		 * pointer, interrupt-parent device_node etc.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		 <span class="comment">//分配一个irqdesc给中断控制器，并绑定设备树节点</span></span><br><span class="line">		desc = kzalloc(<span class="keyword">sizeof</span>(*desc), GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (WARN_ON(!desc))</span><br><span class="line">			<span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">		desc-&gt;dev = np;</span><br><span class="line">		desc-&gt;interrupt_parent = of_irq_find_parent(np);</span><br><span class="line">		<span class="keyword">if</span> (desc-&gt;interrupt_parent == np)</span><br><span class="line">			desc-&gt;interrupt_parent = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="comment">//插入链表</span></span><br><span class="line">		list_add_tail(&amp;desc-&gt;<span class="built_in">list</span>, &amp;intc_desc_list);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The root irq controller is the one without an interrupt-parent.</span></span><br><span class="line"><span class="comment">	 * That one goes first, followed by the controllers that reference it,</span></span><br><span class="line"><span class="comment">	 * followed by the ones that reference the 2nd level controllers, etc.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	 <span class="comment">//从root中断控制器开始初始化</span></span><br><span class="line">	<span class="keyword">while</span> (!list_empty(&amp;intc_desc_list)) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Process all controllers with the current &#x27;parent&#x27;.</span></span><br><span class="line"><span class="comment">		 * First pass will be looking for NULL as the parent.</span></span><br><span class="line"><span class="comment">		 * The assumption is that NULL parent means a root controller.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		list_for_each_entry_safe(desc, temp_desc, &amp;intc_desc_list, <span class="built_in">list</span>) &#123;</span><br><span class="line">			<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> *<span class="title">match</span>;</span>		<span class="comment">//当前控制器对应的of_device_id</span></span><br><span class="line">			<span class="type">int</span> ret;</span><br><span class="line">			<span class="type">of_irq_init_cb_t</span> irq_init_cb;	<span class="comment">//中断控制器的初始化函数</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">//desc是不是孤儿，直到找到一个孤儿，也就是root intr</span></span><br><span class="line">			<span class="keyword">if</span> (desc-&gt;interrupt_parent != parent)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="comment">//从intc_desc_list删除</span></span><br><span class="line">			list_del(&amp;desc-&gt;<span class="built_in">list</span>);</span><br><span class="line">			<span class="comment">//匹配节点，获取对应的of_device_id</span></span><br><span class="line">			match = of_match_node(matches, desc-&gt;dev);</span><br><span class="line">			<span class="keyword">if</span> (WARN(!match-&gt;data,</span><br><span class="line">			    <span class="string">&quot;of_irq_init: no init function for %s\n&quot;</span>,</span><br><span class="line">			    match-&gt;compatible)) &#123;</span><br><span class="line">				kfree(desc);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			pr_debug(<span class="string">&quot;of_irq_init: init %s @ %p, parent %p\n&quot;</span>,</span><br><span class="line">				 match-&gt;compatible,</span><br><span class="line">				 desc-&gt;dev, desc-&gt;interrupt_parent);</span><br><span class="line">			<span class="comment">//获取初始化函数 gic_of_init</span></span><br><span class="line">			irq_init_cb = (<span class="type">of_irq_init_cb_t</span>)match-&gt;data;</span><br><span class="line">			<span class="comment">//调用中断控制器的初始化函数 gic_of_init(desc-&gt;dev, desc-&gt;interrupt_parent)</span></span><br><span class="line">			ret = irq_init_cb(desc-&gt;dev, desc-&gt;interrupt_parent);</span><br><span class="line">			<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">				kfree(desc);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * This one is now set up; add it to the parent list so</span></span><br><span class="line"><span class="comment">			 * its children can get processed in a subsequent pass.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			 <span class="comment">//将root intr插入intc_parent_list</span></span><br><span class="line">			list_add_tail(&amp;desc-&gt;<span class="built_in">list</span>, &amp;intc_parent_list);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Get the next pending parent that might have children */</span></span><br><span class="line">		desc = list_first_entry_or_null(&amp;intc_parent_list,</span><br><span class="line">						<span class="keyword">typeof</span>(*desc), <span class="built_in">list</span>);</span><br><span class="line">		<span class="keyword">if</span> (!desc) &#123;</span><br><span class="line">			pr_err(<span class="string">&quot;of_irq_init: children remain, but no parents\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		list_del(&amp;desc-&gt;<span class="built_in">list</span>);</span><br><span class="line">		parent = desc-&gt;dev;</span><br><span class="line">		kfree(desc);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	list_for_each_entry_safe(desc, temp_desc, &amp;intc_parent_list, <span class="built_in">list</span>) &#123;</span><br><span class="line">		list_del(&amp;desc-&gt;<span class="built_in">list</span>);</span><br><span class="line">		kfree(desc);</span><br><span class="line">	&#125;</span><br><span class="line">err:</span><br><span class="line">	list_for_each_entry_safe(desc, temp_desc, &amp;intc_desc_list, <span class="built_in">list</span>) &#123;</span><br><span class="line">		list_del(&amp;desc-&gt;<span class="built_in">list</span>);</span><br><span class="line">		kfree(desc);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我使用的设备树如下,那么对应初始化函数就是<code>gic_of_init</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">intc: interrupt-controller@<span class="number">00</span>a01000 &#123;</span><br><span class="line">	compatible = <span class="string">&quot;arm,cortex-a7-gic&quot;</span>;</span><br><span class="line">	<span class="meta">#interrupt-cells = <span class="string">&lt;3&gt;</span>;</span></span><br><span class="line">	interrupt-controller;</span><br><span class="line">	reg = &lt;<span class="number">0x00a01000</span> <span class="number">0x1000</span>&gt;,</span><br><span class="line">	      &lt;<span class="number">0x00a02000</span> <span class="number">0x100</span>&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>gic_of_init 会根据设备树的配置信息,去初始化GIC.这里需要对GIC的编程方法有一定了解.就是对GIC的地址进行映射,然后调用gic_init_bases,以及处理多核和父节点存在的情况.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//gic初始化函数</span></span><br><span class="line"><span class="comment">//node：中断控制器节点</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">gic_of_init</span><span class="params">(<span class="keyword">struct</span> device_node *node, <span class="keyword">struct</span> device_node *parent)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">void</span> __iomem *cpu_base;</span><br><span class="line">	<span class="type">void</span> __iomem *dist_base;</span><br><span class="line">	u32 percpu_offset;</span><br><span class="line">	<span class="type">int</span> irq;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (WARN_ON(!node))</span><br><span class="line">		<span class="keyword">return</span> -ENODEV;</span><br><span class="line">	<span class="comment">//对distribute的地址进行映射</span></span><br><span class="line">	dist_base = of_iomap(node, <span class="number">0</span>);</span><br><span class="line">	WARN(!dist_base, <span class="string">&quot;unable to map gic dist registers\n&quot;</span>);</span><br><span class="line">	<span class="comment">//对cpu interface的地址进行映射</span></span><br><span class="line">	cpu_base = of_iomap(node, <span class="number">1</span>);</span><br><span class="line">	WARN(!cpu_base, <span class="string">&quot;unable to map gic cpu registers\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (of_property_read_u32(node, <span class="string">&quot;cpu-offset&quot;</span>, &amp;percpu_offset))</span><br><span class="line">		percpu_offset = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//初始化gic</span></span><br><span class="line">	gic_init_bases(gic_cnt, <span class="number">-1</span>, dist_base, cpu_base, percpu_offset, node);</span><br><span class="line">	<span class="keyword">if</span> (!gic_cnt)</span><br><span class="line">		gic_init_physaddr(node);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//有父节点的情况</span></span><br><span class="line">	<span class="keyword">if</span> (parent) &#123;</span><br><span class="line">		irq = irq_of_parse_and_map(node, <span class="number">0</span>);</span><br><span class="line">		gic_cascade_irq(gic_cnt, irq);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//不考虑了</span></span><br><span class="line">	<span class="keyword">if</span> (IS_ENABLED(CONFIG_ARM_GIC_V2M))</span><br><span class="line">		gicv2m_of_init(node, gic_data[gic_cnt].domain);</span><br><span class="line"></span><br><span class="line">	gic_cnt++;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>gic_init_bases 实现了irq_domain的创建,这个domain对应GIC，是整个系统中的根domain。另外函数还使用向GIC CPU interface的寄存器写入初始值，使能GIC。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __init <span class="title function_">gic_init_bases</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> gic_nr, <span class="type">int</span> irq_start,</span></span><br><span class="line"><span class="params">			   <span class="type">void</span> __iomem *dist_base, <span class="type">void</span> __iomem *cpu_base,</span></span><br><span class="line"><span class="params">			   u32 percpu_offset, <span class="keyword">struct</span> device_node *node)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">irq_hw_number_t</span> hwirq_base;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gic_chip_data</span> *<span class="title">gic</span>;</span></span><br><span class="line">	<span class="type">int</span> gic_irqs, irq_base, i;</span><br><span class="line"></span><br><span class="line">	BUG_ON(gic_nr &gt;= MAX_GIC_NR);</span><br><span class="line"></span><br><span class="line">	gic = &amp;gic_data[gic_nr];</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_GIC_NON_BANKED</span></span><br><span class="line">	<span class="keyword">if</span> (percpu_offset) &#123; <span class="comment">/* Frankein-GIC without banked registers... */</span></span><br><span class="line">		<span class="type">unsigned</span> <span class="type">int</span> cpu;</span><br><span class="line"></span><br><span class="line">		gic-&gt;dist_base.percpu_base = alloc_percpu(<span class="type">void</span> __iomem *);</span><br><span class="line">		gic-&gt;cpu_base.percpu_base = alloc_percpu(<span class="type">void</span> __iomem *);</span><br><span class="line">		<span class="keyword">if</span> (WARN_ON(!gic-&gt;dist_base.percpu_base ||</span><br><span class="line">			    !gic-&gt;cpu_base.percpu_base)) &#123;</span><br><span class="line">			free_percpu(gic-&gt;dist_base.percpu_base);</span><br><span class="line">			free_percpu(gic-&gt;cpu_base.percpu_base);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		for_each_possible_cpu(cpu) &#123;</span><br><span class="line">			u32 mpidr = cpu_logical_map(cpu);</span><br><span class="line">			u32 core_id = MPIDR_AFFINITY_LEVEL(mpidr, <span class="number">0</span>);</span><br><span class="line">			<span class="type">unsigned</span> <span class="type">long</span> offset = percpu_offset * core_id;</span><br><span class="line">			*per_cpu_ptr(gic-&gt;dist_base.percpu_base, cpu) = dist_base + offset;</span><br><span class="line">			*per_cpu_ptr(gic-&gt;cpu_base.percpu_base, cpu) = cpu_base + offset;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		gic_set_base_accessor(gic, gic_get_percpu_base);</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	&#123;			<span class="comment">/* Normal, sane GIC... */</span></span><br><span class="line">		WARN(percpu_offset,</span><br><span class="line">		     <span class="string">&quot;GIC_NON_BANKED not enabled, ignoring %08x offset!&quot;</span>,</span><br><span class="line">		     percpu_offset);</span><br><span class="line">		<span class="comment">//保存地址到gic对象</span></span><br><span class="line">		gic-&gt;dist_base.common_base = dist_base;</span><br><span class="line">		gic-&gt;cpu_base.common_base = cpu_base;</span><br><span class="line">		<span class="comment">//设置访问gic的方法</span></span><br><span class="line">		gic_set_base_accessor(gic, gic_get_common_base);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Initialize the CPU interface map to all CPUs.</span></span><br><span class="line"><span class="comment">	 * It will be refined as each CPU probes its ID.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	 <span class="comment">//多核相关的</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NR_GIC_CPU_IF; i++)</span><br><span class="line">		gic_cpu_map[i] = <span class="number">0xff</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Find out how many interrupts are supported.</span></span><br><span class="line"><span class="comment">	 * The GIC only supports up to 1020 interrupt sources.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	 <span class="comment">//获取gic支持的中断数量</span></span><br><span class="line">	gic_irqs = readl_relaxed(gic_data_dist_base(gic) + GIC_DIST_CTR) &amp; <span class="number">0x1f</span>;</span><br><span class="line">	gic_irqs = (gic_irqs + <span class="number">1</span>) * <span class="number">32</span>;</span><br><span class="line">	<span class="keyword">if</span> (gic_irqs &gt; <span class="number">1020</span>)</span><br><span class="line">		gic_irqs = <span class="number">1020</span>;</span><br><span class="line">	gic-&gt;gic_irqs = gic_irqs;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化irqdesc</span></span><br><span class="line">	<span class="keyword">if</span> (node) &#123;		</span><br><span class="line">		<span class="comment">//使用设备树时，只需要创建irq_domain</span></span><br><span class="line">		<span class="comment">//使用线性映射,重要的是gic_irq_domain_hierarchy_ops</span></span><br><span class="line">		gic-&gt;domain = irq_domain_add_linear(node, gic_irqs,</span><br><span class="line">						    &amp;gic_irq_domain_hierarchy_ops,</span><br><span class="line">						    gic);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;		</span><br><span class="line">		<span class="comment">//不带设备树的方法，不分析了</span></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * For primary GICs, skip over SGIs.</span></span><br><span class="line"><span class="comment">		 * For secondary GICs, skip over PPIs, too.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (gic_nr == <span class="number">0</span> &amp;&amp; (irq_start &amp; <span class="number">31</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			hwirq_base = <span class="number">16</span>;</span><br><span class="line">			<span class="keyword">if</span> (irq_start != <span class="number">-1</span>)</span><br><span class="line">				irq_start = (irq_start &amp; ~<span class="number">31</span>) + <span class="number">16</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			hwirq_base = <span class="number">32</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		gic_irqs -= hwirq_base; <span class="comment">/* calculate # of irqs to allocate */</span></span><br><span class="line"></span><br><span class="line">		irq_base = irq_alloc_descs(irq_start, <span class="number">16</span>, gic_irqs,</span><br><span class="line">					   numa_node_id());</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR_VALUE(irq_base)) &#123;</span><br><span class="line">			WARN(<span class="number">1</span>, <span class="string">&quot;Cannot allocate irq_descs @ IRQ%d, assuming pre-allocated\n&quot;</span>,</span><br><span class="line">			     irq_start);</span><br><span class="line">			irq_base = irq_start;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		gic-&gt;domain = irq_domain_add_legacy(node, gic_irqs, irq_base,</span><br><span class="line">					hwirq_base, &amp;gic_irq_domain_ops, gic);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (WARN_ON(!gic-&gt;domain))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (gic_nr == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SMP</span></span><br><span class="line">		set_smp_cross_call(gic_raise_softirq);</span><br><span class="line">		register_cpu_notifier(&amp;gic_cpu_notifier);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">		set_handle_irq(gic_handle_irq);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//对gic的distributor，cpu interface pm的初始化，写寄存器</span></span><br><span class="line">	gic_dist_init(gic);</span><br><span class="line">	gic_cpu_init(gic);</span><br><span class="line">	gic_pm_init(gic);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>domain分为使用设备树和不使用设备树的情况，当使用设备树时，domain的接口是<code>gic_irq_domain_hierarchy_ops</code>.目前他提供的以下三个接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//irq_domain的方法</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">irq_domain_ops</span> <span class="title">gic_irq_domain_hierarchy_ops</span> =</span> &#123;</span><br><span class="line">	.xlate = gic_irq_domain_xlate,  <span class="comment">//获取设备树节点的中断信息</span></span><br><span class="line">	.alloc = gic_irq_domain_alloc,	<span class="comment">//设置domain下irq_desc的成员</span></span><br><span class="line">	.<span class="built_in">free</span> = irq_domain_free_irqs_top,  <span class="comment">//清除domain下irqdesc的成员</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>首先是 <code>gic_irq_domain_xlate</code>可以获取domain节点下中断的hw_irq,例如:interrupts &#x3D; &lt;GIC_SPI 86 IRQ_TYPE_LEVEL_HIGH&gt;;是gic的子节点.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//intspec[]=&#123;GIC_SPI,86,IRQ_TYPE_LEVEL_HIGH&#125;;</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gic_irq_domain_xlate</span><span class="params">(<span class="keyword">struct</span> irq_domain *d,</span></span><br><span class="line"><span class="params">				<span class="keyword">struct</span> device_node *controller,</span></span><br><span class="line"><span class="params">				<span class="type">const</span> u32 *intspec, <span class="type">unsigned</span> <span class="type">int</span> intsize,</span></span><br><span class="line"><span class="params">				<span class="type">unsigned</span> <span class="type">long</span> *out_hwirq, <span class="type">unsigned</span> <span class="type">int</span> *out_type)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (d-&gt;of_node != controller)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	<span class="keyword">if</span> (intsize &lt; <span class="number">3</span>)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Get the interrupt number and add 16 to skip over SGIs */</span></span><br><span class="line">	<span class="comment">//获取中断号，加16跳过sgis</span></span><br><span class="line">	*out_hwirq = intspec[<span class="number">1</span>] + <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* For SPIs, we need to add 16 more to get the GIC irq ID number */</span></span><br><span class="line">	<span class="comment">//gic_spi类型还要再跳过16</span></span><br><span class="line">	<span class="keyword">if</span> (!intspec[<span class="number">0</span>])</span><br><span class="line">		*out_hwirq += <span class="number">16</span>;</span><br><span class="line">	<span class="comment">//获取类型</span></span><br><span class="line">	*out_type = intspec[<span class="number">2</span>] &amp; IRQ_TYPE_SENSE_MASK;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>gic_irq_domain_alloc</code>是初始化domain下的irqdesc,主要是设置中断流处理函数<code>desc-&gt;handle_irq = handle_fasteoi_irq</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置中断信息</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gic_irq_domain_alloc</span><span class="params">(<span class="keyword">struct</span> irq_domain *domain, <span class="type">unsigned</span> <span class="type">int</span> virq,</span></span><br><span class="line"><span class="params">				<span class="type">unsigned</span> <span class="type">int</span> nr_irqs, <span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> i, ret;</span><br><span class="line">	<span class="type">irq_hw_number_t</span> hwirq;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> type = IRQ_TYPE_NONE;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">of_phandle_args</span> *<span class="title">irq_data</span> =</span> arg;</span><br><span class="line">	<span class="comment">//获取硬件中断号</span></span><br><span class="line">	ret = gic_irq_domain_xlate(domain, irq_data-&gt;np, irq_data-&gt;args,</span><br><span class="line">				   irq_data-&gt;args_count, &amp;hwirq, &amp;type);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	<span class="comment">//设置对应中断信息</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nr_irqs; i++)</span><br><span class="line">		gic_irq_domain_map(domain, virq + i, hwirq + i);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="五、参考博客"><a href="#五、参考博客" class="headerlink" title="五、参考博客"></a>五、参考博客</h2><p><a target="_blank" rel="noopener" href="https://www.twblogs.net/a/5cca2fa2bd9eee1ac2edaf2a">Linux中斷子系統框架流程詳解（基於Kernel 3.16，arm，設備樹） - 台部落 (twblogs.net)</a></p>
<p><a target="_blank" rel="noopener" href="http://www.wowotech.net/sort/irq_subsystem">中断子系统 - 蜗窝科技 (wowotech.net)</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/05/31/killer-blog/Linux/Linux_isr_3/" data-id="cmbcy7rh40013t8mtdy948uf6" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-killer-blog/picture/weixin.png" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/05/31/killer-blog/picture/weixin.png/" class="article-date">
  <time class="dt-published" datetime="2025-05-31T02:36:46.053Z" itemprop="datePublished">2025-05-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/05/31/killer-blog/picture/weixin.png/" data-id="cmbcy7rhz003ot8mtdz9j2t35" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-killer-blog/OpenHarmony/tmp/netdev" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/05/31/killer-blog/OpenHarmony/tmp/netdev/" class="article-date">
  <time class="dt-published" datetime="2025-05-31T02:36:45.833Z" itemprop="datePublished">2025-05-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="net框架"><a href="#net框架" class="headerlink" title="net框架"></a>net框架</h2><p>openharmony使用netdev来描述所有的网络设备。源码在&#x2F;drivers&#x2F;framework&#x2F;model&#x2F;network&#x2F;common&#x2F;</p>
<h3 id="NetDevice"><a href="#NetDevice" class="headerlink" title="NetDevice"></a>NetDevice</h3><p>抽象的描述网络设备：Defines a network device, including the network interface category and name, and network port type.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">NetDevice</span> &#123;</span></span><br><span class="line">    NetIfCategory netifCateg;                 <span class="comment">/**&lt; LITE_OS or FULL_OS */</span></span><br><span class="line">    <span class="type">char</span> name[IFNAMSIZ];                      <span class="comment">/**&lt; Network device name &#123;@link IFNAMSIZ&#125; */</span></span><br><span class="line">    NetLinkType LinkLayerType;                <span class="comment">/**&lt; Data link layer type：ETHERNET_LINK or WIFI_LINK */</span></span><br><span class="line">    IfType funType;                           <span class="comment">/**&lt; Network port type */</span></span><br><span class="line">    <span class="type">uint8_t</span> macAddr[MAC_ADDR_SIZE];           <span class="comment">/**&lt; MAC address &#123;@link MAC_ADDR_SIZE&#125; */</span></span><br><span class="line">    ....</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">NetDeviceInterFace</span> *<span class="title">netDeviceIf</span>;</span>   <span class="comment">/**&lt; Network device interface */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">NetDevice</span> *<span class="title">owner</span>;</span>                  <span class="comment">/**&lt; Network device */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">NetDevStats</span> <span class="title">stats</span>;</span>                 <span class="comment">/**&lt; Network statistics */</span></span><br><span class="line">&#125; NetDevice;</span><br></pre></td></tr></table></figure>

<h3 id="NetDeviceInterFace"><a href="#NetDeviceInterFace" class="headerlink" title="NetDeviceInterFace"></a>NetDeviceInterFace</h3><p>NetDeviceInterFace是负责对接 wifi芯片驱动程序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief Defines interfaces that need to be implemented externally by network devices, including initializing,</span></span><br><span class="line"><span class="comment"> * opening, and closing a network device.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NetDeviceInterFace</span> &#123;</span></span><br><span class="line">    <span class="type">int32_t</span> (*init)(<span class="keyword">struct</span> NetDevice *netDev);  <span class="comment">/**&lt; Initializes a network device to be added. */</span></span><br><span class="line">    <span class="type">void</span> (*deInit)(<span class="keyword">struct</span> NetDevice *netDev);   <span class="comment">/**&lt; Deinitializes a network device to be delete. */</span></span><br><span class="line">    <span class="type">int32_t</span> (*open)(<span class="keyword">struct</span> NetDevice *netDev);  <span class="comment">/**&lt; Opens the data link layer. */</span></span><br><span class="line">    <span class="type">int32_t</span> (*stop)(<span class="keyword">struct</span> NetDevice *netDev);  <span class="comment">/**&lt; Closes the data link layer. */</span></span><br><span class="line">    NetDevTxResult (*xmit)(<span class="keyword">struct</span> NetDevice *netDev, NetBuf *netBuff);        <span class="comment">/**&lt; Sends data. */</span></span><br><span class="line">    <span class="type">int32_t</span> (*ioctl)(<span class="keyword">struct</span> NetDevice *netDev, IfReq *req, <span class="type">int32_t</span> cmd);      <span class="comment">/**&lt; Used for the control command word. */</span></span><br><span class="line">    <span class="type">int32_t</span> (*setMacAddr)(<span class="keyword">struct</span> NetDevice *netDev, <span class="type">void</span> *addr);              <span class="comment">/**&lt; Sets the MAC address. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">NetDevStats</span> *(*<span class="title">getStats</span>)(<span class="keyword">struct</span> <span class="title">NetDevice</span> *<span class="title">netDev</span>);</span>                <span class="comment">/**&lt; Obtains the statistics. */</span></span><br><span class="line">    <span class="type">void</span> (*setNetIfStatus)(<span class="keyword">struct</span> NetDevice *netDev, NetIfStatus status);     <span class="comment">/**&lt; Sets the network port status. */</span></span><br><span class="line">    <span class="type">uint16_t</span> (*selectQueue)(<span class="keyword">struct</span> NetDevice *netDev, NetBuf *netBuff);       <span class="comment">/**&lt; Selects a priority queue. */</span></span><br><span class="line">    <span class="type">uint32_t</span> (*netifNotify)(<span class="keyword">struct</span> NetDevice *netDev, NetDevNotify *notify);  <span class="comment">/**&lt; Notifies the network port status. */</span></span><br><span class="line">    <span class="type">int32_t</span> (*changeMtu)(<span class="keyword">struct</span> NetDevice *netDev, <span class="type">int32_t</span> newMtu);           <span class="comment">/**&lt; Changes the maximum number of</span></span><br><span class="line"><span class="comment">                                                                               * transmission units.</span></span><br><span class="line"><span class="comment">                                                                               */</span></span><br><span class="line">    <span class="type">void</span> (*linkStatusChanged)(<span class="keyword">struct</span> NetDevice *netDev);    <span class="comment">/**&lt; Detects the change of</span></span><br><span class="line"><span class="comment">                                                             * the Ethernet port connection status.</span></span><br><span class="line"><span class="comment">                                                             */</span></span><br><span class="line">    ProcessingResult (*specialEtherTypeProcess)(<span class="type">const</span> <span class="keyword">struct</span> NetDevice *netDev, NetBuf *buff);</span><br><span class="line">                                                                              <span class="comment">/**&lt; Performs private processing without</span></span><br><span class="line"><span class="comment">                                                                               * involving network-layer data.</span></span><br><span class="line"><span class="comment">                                                                               */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h3 id="NetDeviceImpl"><a href="#NetDeviceImpl" class="headerlink" title="NetDeviceImpl"></a>NetDeviceImpl</h3><p>NetDeviceImpl 包括 NetDevice，以及 NetDeviceImplOp ，NetDeviceImplOp的作用是对接lwip协议栈。</p>
<p>所以NetDeviceImpl 就是芯片驱动程序 和 lwip协议栈沟通的中介。</p>
<p>为什么需要这个东西呢？因为lwip处理的数据类型是pbuf，而在opneharmony中处理网络数据的类型netbuf，lwip对网口的定义是netif，而openharmony对网口的定义是netdev,所以这中间需要有一个互相转换，NetDeviceImpl就是干这事。</p>
<p>该部分的代码在bearpi_micro&#x2F;drivers&#x2F;adapter&#x2F;khdf&#x2F;liteos&#x2F;network&#x2F;src&#x2F;net_device_adapter.c，net_device_adapter顾名思义就是把net_device的适配器，适配到lwip。同理netbuf_adapter.c实现的就是把netbuf转换成pbuf。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NetDeviceImpl</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">NetDevice</span> *<span class="title">netDevice</span>;</span>	<span class="comment">//netDevice-&gt;NetDeviceInterFace 调用芯片驱动程序接口</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">NetDeviceImplOp</span> *<span class="title">interFace</span>;</span>	<span class="comment">//调用lwip的接口</span></span><br><span class="line">    <span class="type">void</span> *osPrivate;	<span class="comment">//指向 lwip的netif对象</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NetDeviceImplOp</span> &#123;</span></span><br><span class="line">    <span class="type">int32_t</span> (*init)(<span class="keyword">struct</span> NetDeviceImpl *netDevice);</span><br><span class="line">    <span class="type">int32_t</span> (*deInit)(<span class="keyword">struct</span> NetDeviceImpl *netDevice);</span><br><span class="line">    <span class="type">int32_t</span> (*add)(<span class="keyword">struct</span> NetDeviceImpl *netDevice);</span><br><span class="line">    <span class="type">int32_t</span> (*delete)(<span class="keyword">struct</span> NetDeviceImpl *netDevice);</span><br><span class="line">    <span class="type">int32_t</span> (*setStatus)(<span class="keyword">struct</span> NetDeviceImpl *netDevice, NetIfStatus status);</span><br><span class="line">    <span class="type">int32_t</span> (*setLinkStatus)(<span class="keyword">struct</span> NetDeviceImpl *netDevice, NetIfLinkStatus status);</span><br><span class="line">    <span class="type">int32_t</span> (*getLinkStatus)(<span class="keyword">struct</span> NetDeviceImpl *netDevice, NetIfLinkStatus *status);</span><br><span class="line">    <span class="type">int32_t</span> (*receive)(<span class="keyword">struct</span> NetDeviceImpl *netDevice, NetBuf *buff, ReceiveFlag flag);</span><br><span class="line">    <span class="type">int32_t</span> (*setIpAddr)(<span class="keyword">struct</span> NetDeviceImpl *netDevice, <span class="type">const</span> IpV4Addr *ipAddr, <span class="type">const</span> IpV4Addr *netMask,</span><br><span class="line">        <span class="type">const</span> IpV4Addr *gw);</span><br><span class="line">    <span class="type">int32_t</span> (*dhcpsStart)(<span class="keyword">struct</span> NetDeviceImpl *netDevice, <span class="type">char</span> *ip, <span class="type">uint16_t</span> ipNum);</span><br><span class="line">    <span class="type">int32_t</span> (*dhcpsStop)(<span class="keyword">struct</span> NetDeviceImpl *netDevice);</span><br><span class="line">    <span class="type">int32_t</span> (*dhcpStart)(<span class="keyword">struct</span> NetDeviceImpl *netDevice);</span><br><span class="line">    <span class="type">int32_t</span> (*dhcpStop)(<span class="keyword">struct</span> NetDeviceImpl *netDevice);</span><br><span class="line">    <span class="type">int32_t</span> (*dhcpIsBound)(<span class="keyword">struct</span> NetDeviceImpl *netDevice);</span><br><span class="line">    <span class="type">int32_t</span> (*changeMacAddr)(<span class="keyword">struct</span> NetDeviceImpl *netDevice);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">NetDeviceImplOp</span> <span class="title">g_liteNdImplOps</span> =</span> &#123;</span><br><span class="line">    .init = LiteNetDevInit,</span><br><span class="line">    .deInit = LiteNetDevDeInit,</span><br><span class="line">    .add = LiteNetDevAdd,</span><br><span class="line">    .delete = LiteNetDevDelete,</span><br><span class="line">    .setStatus = LiteNetDevSetStatus,</span><br><span class="line">    .setLinkStatus = LiteNetDevSetLinkStatus,</span><br><span class="line">    .getLinkStatus = LiteNetDevGetLinkStatus,</span><br><span class="line">    .receive = LiteNetDevReceive,</span><br><span class="line">    .setIpAddr = LiteNetSetIpAddr,</span><br><span class="line">    .dhcpsStart = LiteNetDhcpsStart,</span><br><span class="line">    .dhcpsStop = LiteNetDhcpsStop,</span><br><span class="line">    .dhcpStart = LiteNetDhcpStart,</span><br><span class="line">    .dhcpStop = LiteNetDhcpStop,</span><br><span class="line">    .dhcpIsBound = LiteNetDhcpIsBound,</span><br><span class="line">    .changeMacAddr = LiteNetChangeMacAddr,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h3 id="数据输入到lwip"><a href="#数据输入到lwip" class="headerlink" title="数据输入到lwip"></a>数据输入到lwip</h3><p>把网卡驱动程序接受到的数据传递给lwip协议栈</p>
<p>在数据链路层接受到以太网数据包后，调用 NetDeviceImplOp-&gt;receive()：</p>
<p>将netbuff类型的数据转换成lwip能处理的pbuf类型数据。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int32_t</span> <span class="title function_">LiteNetDevReceive</span><span class="params">(<span class="keyword">struct</span> NetDeviceImpl *netDeviceImpl, <span class="keyword">struct</span> NetBuf *buff, ReceiveFlag flag)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">netif</span> *<span class="title">lwipNf</span> =</span> GetNetIfFromDevImpl(netDeviceImpl);</span><br><span class="line">    ProcessingResult ret = LiteNetDevDataFilter(netDeviceImpl, buff);</span><br><span class="line">    <span class="keyword">if</span> (ret == PROCESSING_CONTINUE) &#123;</span><br><span class="line">        <span class="keyword">return</span> LiteNetDevDataReceive(netDeviceImpl, buff);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret == PROCESSING_COMPLETE) &#123;</span><br><span class="line">        <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> HDF_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int32_t</span> <span class="title function_">LiteNetDevDataReceive</span><span class="params">(<span class="keyword">struct</span> NetDeviceImpl *netDeviceImpl, <span class="keyword">struct</span> NetBuf *buff)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">netif</span> *<span class="title">lwipNf</span> =</span> GetNetIfFromDevImpl(netDeviceImpl);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pbuf</span> *<span class="title">pBuff</span> =</span> ConverNetBufToPBuf(buff);</span><br><span class="line"></span><br><span class="line">    driverif_input(lwipNf, pBuff);</span><br><span class="line">    NetBufFree(buff);</span><br><span class="line">    <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后调用driverif_input将数据传递给lwip协议线程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This function should be called by network driver to pass the input packet to LwIP.</span></span><br><span class="line"><span class="comment"> * Before calling this API, driver has to keep the packet in pbuf structure. Driver has to</span></span><br><span class="line"><span class="comment"> * call pbuf_alloc() with type as PBUF_RAM to create pbuf structure. Then driver</span></span><br><span class="line"><span class="comment"> * has to pass the pbuf structure to this API. This will add the pbuf into the TCPIP thread.</span></span><br><span class="line"><span class="comment"> * Once this packet is processed by TCPIP thread, pbuf will be freed. Driver is not required to</span></span><br><span class="line"><span class="comment"> * free the pbuf.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param netif the lwip network interface structure for this driverif</span></span><br><span class="line"><span class="comment"> * @param p packet in pbuf structure format</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">driverif_input</span><span class="params">(<span class="keyword">struct</span> netif *netif, <span class="keyword">struct</span> pbuf *p)</span></span><br></pre></td></tr></table></figure>

<p>回溯：LiteNetDevReceive()的调用需要跟踪到NetDeviceImplOp，NetDeviceImplOp需要跟踪到NetDeviceImpl</p>
<p>而GetImplByNetDevice()可以获取到NetDeviceImpl，所以追踪GetImplByNetDevice()，可以找到函数NetIfRxImpl</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int32_t</span> <span class="title function_">NetIfRxImpl</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> NetDevice *netDevice, NetBuf *buff, ReceiveFlag flag)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">NetDeviceImpl</span> *<span class="title">ndImpl</span> =</span> GetImplByNetDevice(netDevice);</span><br><span class="line">    ProcessingResult ret = PROCESSING_CONTINUE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* to do driver special process */</span></span><br><span class="line">    <span class="keyword">if</span> (netDevice-&gt;netDeviceIf != <span class="literal">NULL</span> &amp;&amp; netDevice-&gt;netDeviceIf-&gt;specialEtherTypeProcess != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ret = netDevice-&gt;netDeviceIf-&gt;specialEtherTypeProcess(netDevice, buff);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Sent to TCP/IP Stack. */</span></span><br><span class="line">    <span class="keyword">if</span> (ret == PROCESSING_CONTINUE) &#123;</span><br><span class="line">        <span class="comment">//call LiteNetDevReceive()</span></span><br><span class="line">        <span class="keyword">return</span> ndImpl-&gt;interFace-&gt;receive(ndImpl, buff, flag);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret == PROCESSING_COMPLETE) &#123;</span><br><span class="line">        HDF_LOGI(<span class="string">&quot;NetIfRxImpl specialEtherType Process not need TCP/IP stack!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        HDF_LOGE(<span class="string">&quot;%s: NetIfRxImpl specialEtherType Process error&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span> HDF_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Transfers the input data packets from the network side to a protocol stack.</span></span><br><span class="line"><span class="type">int32_t</span> <span class="title function_">NetIfRx</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> NetDevice *netDevice, NetBuf *buff)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> NetIfRxImpl(netDevice, buff, IN_INTERRUPT);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Transfers data packets from the network side to a protocol stack in an interrupt processing thread.</span></span><br><span class="line"><span class="type">int32_t</span> <span class="title function_">NetIfRxNi</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> NetDevice *netDevice, NetBuf *buff)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> NetIfRxImpl(netDevice, buff, NO_IN_INTERRUPT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>hcc_to_hmac_control_event_dispatch-&gt;hcc_hmac_rx_event_handle-&gt;hmac_from_dmac_rx_data_handle-&gt;g_ast_hmac_wlan_drx_event_sub_table[DMAC_WLAN_DRX_EVENT_SUB_TYPE_RX_AP].func &#x3D; hmac_rx_process_data_ap;</p>
<p>hmac_rx_process_data_ap()-&gt;hmac_rx_process_data_ap_tcp_ack_opt()-&gt;hmac_rx_lan_frame_classify()-&gt;hmac_rx_msdu_frame_classify()-&gt;hmac_rx_transmit_msdu_to_lan()-&gt;oal_netif_rx_ni()-&gt;NetIfRx()-&gt;NetIfRxImpl()-&gt;GetImplByNetDevice()-&gt;NetDeviceImpl()-&gt;&gt;LiteNetDevReceive()</p>
<h4 id="flow-control-调用链"><a href="#flow-control-调用链" class="headerlink" title="flow control 调用链"></a>flow control 调用链</h4><p>fcm-&gt;op-&gt;rxDataPacket(q, fcm-&gt;fcmPriv, rxPriorityId);</p>
<p>.rxDataPacket &#x3D; hcc_host_proc_rx_queue_impl</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">hi_s32 <span class="title function_">hcc_host_proc_rx_queue_impl</span><span class="params">(oal_netbuf_head_stru *head, <span class="type">void</span> *handler, <span class="type">int32_t</span> type)</span></span><br><span class="line">&#123;</span><br><span class="line">    hcc_handler_stru *hcc_handler = (hcc_handler_stru *)handler;</span><br><span class="line">    hi_s32 count = <span class="number">0</span>;</span><br><span class="line">    hi_s32 pre_ret = HI_SUCCESS;</span><br><span class="line">    hi_u8 *pre_context = HI_NULL;</span><br><span class="line">    oal_netbuf_head_stru *netbuf_head = HI_NULL;</span><br><span class="line">    oal_netbuf_stru *netbuf = HI_NULL;</span><br><span class="line">    hcc_header_stru *hcc_hdr = HI_NULL;</span><br><span class="line">    hcc_netbuf_stru hcc_netbuf;</span><br><span class="line">    hcc_rx_action_stru *rx_action = HI_NULL;</span><br><span class="line">    netbuf_head = head;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        netbuf = oal_netbuf_delist(netbuf_head);</span><br><span class="line">        <span class="keyword">if</span> (netbuf == HI_NULL) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        hcc_hdr = (hcc_header_stru *)oal_netbuf_data(netbuf);</span><br><span class="line">        <span class="keyword">if</span> (hcc_host_check_header_vaild(hcc_hdr) != HI_TRUE) &#123;</span><br><span class="line">            oal_print_hex_dump((hi_u8 *)hcc_hdr, HCC_HDR_TOTAL_LEN, <span class="number">16</span>, <span class="string">&quot;invalid hcc header: &quot;</span>); <span class="comment">/* 16进制 */</span></span><br><span class="line">            oam_error_log0(<span class="number">0</span>, <span class="number">0</span>, <span class="string">&quot;hcc_host_send_rx_queue:: invalid hcc_header&quot;</span>);</span><br><span class="line">            count++;</span><br><span class="line">            oal_netbuf_free(netbuf);</span><br><span class="line">            <span class="keyword">return</span> count;</span><br><span class="line">        &#125;</span><br><span class="line">        rx_action = &amp;hcc_handler-&gt;hcc_transer_info.rx_action_info.action[hcc_hdr-&gt;main_type];</span><br><span class="line">        pre_ret = HI_SUCCESS;</span><br><span class="line">        <span class="keyword">if</span> (rx_action-&gt;pre_do != HI_NULL) &#123;</span><br><span class="line">            hcc_netbuf.pst_netbuf = netbuf;</span><br><span class="line">            hcc_netbuf.len = (hi_s32)oal_netbuf_len(netbuf);</span><br><span class="line">            pre_ret = rx_action-&gt;pre_do(hcc_hdr-&gt;sub_type, &amp;hcc_netbuf, &amp;pre_context);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (pre_ret == HI_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hcc_host_rx(hcc_handler, netbuf) == HI_SUCCESS) &#123;</span><br><span class="line">                <span class="keyword">if</span> (rx_action-&gt;post_do != HI_NULL) &#123;</span><br><span class="line">                    hcc_netbuf.pst_netbuf = netbuf;</span><br><span class="line">                    hcc_netbuf.len = (hi_s32)oal_netbuf_len(netbuf);</span><br><span class="line">                    rx_action-&gt;post_do(hcc_hdr-&gt;sub_type, &amp;hcc_netbuf, pre_context);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    oam_error_log2(<span class="number">0</span>, <span class="number">0</span>, <span class="string">&quot;hcc_host_send_rx_queue:: post_do is null, hcc_main_type[%d], sub_type[%d]&quot;</span>,</span><br><span class="line">                        hcc_hdr-&gt;main_type, hcc_hdr-&gt;sub_type);</span><br><span class="line">                    oal_print_hex_dump((hi_u8 *)hcc_hdr, HCC_HDR_TOTAL_LEN, <span class="number">32</span>, <span class="string">&quot;hcc invalid header: &quot;</span>); <span class="comment">/* len 32 */</span></span><br><span class="line">                    oal_print_hex_dump(oal_netbuf_data(netbuf), (hi_s32)oal_netbuf_len(netbuf), <span class="number">32</span>,</span><br><span class="line">                        <span class="string">&quot;hcc invalid header(payload): &quot;</span>); <span class="comment">/* 32 进制 */</span></span><br><span class="line">                    oal_netbuf_free(netbuf);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                oal_netbuf_free(netbuf);</span><br><span class="line">            &#125;</span><br><span class="line">            hcc_handler-&gt;hcc_transer_info.hcc_queues[HCC_RX].queues[type].total_pkts++;</span><br><span class="line">            count++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* keep the netbuf in list and skip the loop */</span></span><br><span class="line">            oal_netbuf_addlist(netbuf_head, netbuf);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="lwip数据输出到网卡"><a href="#lwip数据输出到网卡" class="headerlink" title="lwip数据输出到网卡"></a>lwip数据输出到网卡</h3><p>首先介绍如何创建一个lwip下的抽象的网卡设备netif</p>
<p>调用 NetDeviceImplOp-&gt;add()来创建一个新的netif，并给这个netif设置mac地址，netif的发送函数、设置mac地址函数，并添加到lwip协议栈中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int32_t</span> <span class="title function_">LiteNetDevAdd</span><span class="params">(<span class="keyword">struct</span> NetDeviceImpl *netDeviceImpl)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">NetDeviceAdapterLite</span> *<span class="title">liteNdPri</span> =</span> (<span class="keyword">struct</span> NetDeviceAdapterLite *)netDeviceImpl-&gt;osPrivate;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">NetDevice</span> *<span class="title">lwipNd</span> =</span> netDeviceImpl-&gt;netDevice;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">netif</span> *<span class="title">lwipNf</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    lwipNf = CreateLwipNetIf(netDeviceImpl, lwipNd);</span><br><span class="line">    <span class="type">ip4_addr_t</span> gw, ipaddr, netmask;</span><br><span class="line">    IP4_ADDR(&amp;gw, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    IP4_ADDR(&amp;ipaddr, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    IP4_ADDR(&amp;netmask, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ((ret = netifapi_netif_add(lwipNf, &amp;ipaddr, &amp;netmask, &amp;gw)) != ERR_OK) &#123;</span><br><span class="line">        HDF_LOGE(<span class="string">&quot;%s : netifapi_netif_add fail!,ret=%d&quot;</span>, __func__, ret);</span><br><span class="line">        DestroyLwipNetIf(lwipNf);</span><br><span class="line">        <span class="keyword">return</span> HDF_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* copy MAC ADDR TO LWIP */</span></span><br><span class="line">    <span class="keyword">if</span> (memcpy_s(lwipNf-&gt;hwaddr, NETIF_MAX_HWADDR_LEN, lwipNd-&gt;macAddr, MAC_ADDR_SIZE) != EOK) &#123;</span><br><span class="line">        <span class="keyword">return</span> HDF_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    liteNdPri-&gt;lwipNetif = lwipNf;</span><br><span class="line">    IpV6SpecialProc(lwipNd, lwipNf);</span><br><span class="line">    <span class="comment">/* set netif default status */</span></span><br><span class="line">    netifapi_netif_set_default(lwipNf);</span><br><span class="line">    netif_set_link_callback(lwipNf, LiteNetifLinkChangeCallback);</span><br><span class="line">    HDF_LOGI(<span class="string">&quot;%s success!!&quot;</span>, __func__);</span><br><span class="line">    <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> netif *<span class="title function_">CreateLwipNetIf</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> NetDeviceImpl *netDeviceImpl, <span class="type">const</span> <span class="keyword">struct</span> NetDevice *netDev)</span></span><br><span class="line">&#123;</span><br><span class="line">    lwipNf = (<span class="keyword">struct</span> netif *)OsalMemCalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> netif));</span><br><span class="line">    (<span class="type">void</span>)memset_s(lwipNf, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> netif), <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> netif));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* register netif to lwip */</span></span><br><span class="line">    lwipNf-&gt;state = (<span class="type">void</span> *)netDeviceImpl;</span><br><span class="line">    lwipNf-&gt;drv_send = LwipSend;</span><br><span class="line">    lwipNf-&gt;drv_set_hwaddr = LwipSetHwaddr;</span><br><span class="line">    lwipNf-&gt;link_layer_type = netDev-&gt;LinkLayerType;</span><br><span class="line">    lwipNf-&gt;hwaddr_len = MAC_ADDR_SIZE;</span><br><span class="line">    lwipNf-&gt;drv_config = LwipDrvConfig;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> lwipNf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>把lwip协议栈的数据传递给网卡驱动程序发送；</p>
<p>将lwip的pbuf类型数据转换成网卡驱动使用的netbuf类型数据。调用网卡的接口函数xmit将数据发送</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">LwipSend</span><span class="params">(<span class="keyword">struct</span> netif *netif, <span class="keyword">struct</span> pbuf *lwipBuf)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">NetDeviceImpl</span> *<span class="title">ndImpl</span> =</span> (<span class="keyword">struct</span> NetDeviceImpl *)netif-&gt;state;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">NetDevice</span> *<span class="title">netDev</span> =</span> ndImpl-&gt;netDevice;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">NetDeviceInterFace</span> *<span class="title">netDevIf</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">NetBuf</span> *<span class="title">netBuff</span> =</span> ConverPbuffToNetBuf(netDev, lwipBuf);</span><br><span class="line">	netDevIf-&gt;xmit(netDev, netBuff);</span><br><span class="line">    netDevIf = netDev-&gt;netDeviceIf;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>xmit &#x3D; hmac_bridge_vap_xmit(),hmac_bridge_vap_xmit()通过下面这一系列的函数调用，最终把netbuf传递给flowcontrol module的队列中缓存，然后唤醒线程进行发送。</p>
<p> hmac_bridge_vap_xmit()-&gt;hmac_tx_lan_to_wlan-&gt;hmac_tx_lan_to_wlan_no_tcp_opt_to_dmac()-&gt;hcc_hmac_tx_data_event()-&gt;hcc_host_tx_data_adapt_pre_do()-&gt;hcc_host_tx_data_adapt()-&gt;hcc_tx_netbuf_normal()-&gt;hcc_host_tx(),hcc_host_tx会调用flow_control</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* hcc sdio host tx */</span></span><br><span class="line">hi_u32 <span class="title function_">hcc_host_tx</span><span class="params">(hcc_handler_stru *hcc_handler, oal_netbuf_stru *netbuf, <span class="type">const</span> hcc_transfer_param *param)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">FlowControlModule</span> *<span class="title">fcm</span> =</span> HI_NULL;</span><br><span class="line">    <span class="comment">/* 1. build hcc header */</span></span><br><span class="line">    err_code = hcc_hmac_tx_hcc_hdr_init(netbuf, param);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2. init hcc cb ctrl */</span></span><br><span class="line">    hcc_cb = (hcc_tx_cb_stru *)oal_netbuf_cb(netbuf);</span><br><span class="line">    hcc_cb-&gt;destroy = hcc_tx_netbuf_destroy;</span><br><span class="line">    hcc_cb-&gt;magic = HCC_TX_WAKELOCK_MAGIC;</span><br><span class="line">    <span class="keyword">if</span> (param-&gt;queue_id == DATA_LO_QUEUE) &#123;</span><br><span class="line">        dmac_tx_ctl_stru *dmac_tx_ctrl = HI_NULL;</span><br><span class="line">        hi_u8 *hcc_hdr = (hi_u8 *)oal_netbuf_data(netbuf);</span><br><span class="line">        dmac_tx_ctrl = (dmac_tx_ctl_stru *)(hcc_hdr + HCC_HDR_LEN + <span class="keyword">sizeof</span>(frw_hcc_extend_hdr_stru));</span><br><span class="line">        <span class="keyword">if</span> (dmac_tx_ctrl != HI_NULL &amp;&amp;</span><br><span class="line">            dmac_tx_ctrl-&gt;is_vipframe != HI_TRUE &amp;&amp; dmac_tx_ctrl-&gt;high_prio_sch != HI_TRUE &amp;&amp;</span><br><span class="line">            hcc_list_overflow()) &#123;</span><br><span class="line">            <span class="comment">/* 非关键帧 */</span></span><br><span class="line">            oal_netbuf_free(netbuf);</span><br><span class="line">            <span class="keyword">return</span> HI_SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dmac_tx_ctrl != HI_NULL &amp;&amp;</span><br><span class="line">            (dmac_tx_ctrl-&gt;is_vipframe == HI_TRUE || dmac_tx_ctrl-&gt;high_prio_sch == HI_TRUE)) &#123;</span><br><span class="line">            is_vipframe = HI_TRUE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_vipframe &amp;&amp; hcc_discard_key_frame()) &#123;</span><br><span class="line">            oal_netbuf_free(netbuf);</span><br><span class="line">            <span class="keyword">return</span> HI_SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//get flowcontrolmodule</span></span><br><span class="line">    fcm = GetFlowControlModule();</span><br><span class="line">    <span class="keyword">if</span> (fcm != <span class="literal">NULL</span> &amp;&amp; fcm-&gt;op != <span class="literal">NULL</span> &amp;&amp; fcm-&gt;op-&gt;getTxQueueId != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        para.queueType = param-&gt;queue_id;</span><br><span class="line">        para.isVip = is_vipframe;</span><br><span class="line">        FlowControlQueueID id = fcm-&gt;op-&gt;getTxQueueId((<span class="type">void</span> *)(&amp;para));</span><br><span class="line">        <span class="comment">//send netbuf to fcm</span></span><br><span class="line">        fcm-&gt;interface-&gt;sendBuffToFCM(fcm, netbuf, id, FLOW_TX);</span><br><span class="line">        <span class="comment">//call txthread to send netbuf</span></span><br><span class="line">        fcm-&gt;interface-&gt;schedFCM(fcm, FLOW_TX);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> HI_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>flow control提供给外部的接口：</p>
<ul>
<li>sendBuffToFCM：发送数据到flowcontrol</li>
<li>schedFCM：调度线程（即让发送&#x2F;接受开始运行）</li>
</ul>
<h3 id="创建netdev"><a href="#创建netdev" class="headerlink" title="创建netdev"></a>创建netdev</h3><p>在bearpi_micro&#x2F;drivers&#x2F;framework&#x2F;model&#x2F;network&#x2F;common&#x2F;netdevice&#x2F;netdevice.c 中定义了netdevice</p>
<p>该函数会创建netdev对象，netdeviceimpl对象，以及netif对象等。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> NetDevice *<span class="title function_">NetDeviceInit</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *ifName, <span class="type">uint32_t</span> len, NetLinkType type, NetIfCategory ifCategory)</span></span><br><span class="line">&#123;</span><br><span class="line">    netDevice = (NetDevice *)OsalMemCalloc(<span class="keyword">sizeof</span>(NetDevice));</span><br><span class="line">	<span class="comment">//复制名称，名称一般是wlan0,wlan1,eth0,eth1</span></span><br><span class="line">    <span class="keyword">if</span> (strcpy_s(netDevice-&gt;name, IFNAMSIZ, ifName) != EOK) &#123;</span><br><span class="line">        HDF_LOGE(<span class="string">&quot;%s fail: strcpy_s fail!&quot;</span>, __func__);</span><br><span class="line">        OsalMemFree(netDevice);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    netDevice-&gt;netifCateg = ifCategory;</span><br><span class="line">    <span class="comment">//实例化 ndImpl</span></span><br><span class="line">    ndImpl = InitNetDeviceImpl(netDevice, ifCategory);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (FindAvailableTable(&amp;index)) &#123;</span><br><span class="line">        AddNetDeviceImplToTable(index, ndImpl);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        DeInitNetDeviceImpl(ndImpl);</span><br><span class="line">        HDF_LOGE(<span class="string">&quot;%s fail: Not extra table.&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* INIT OSPrivate */</span></span><br><span class="line">    ret = HDF_FAILURE;</span><br><span class="line">    <span class="keyword">if</span> (ndImpl-&gt;interFace != <span class="literal">NULL</span> &amp;&amp; ndImpl-&gt;interFace-&gt;init != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">//调用g_liteNdImplOps-&gt;init() 也就是LiteNetDevInit()</span></span><br><span class="line">        ret = ndImpl-&gt;interFace-&gt;init(ndImpl);</span><br><span class="line">    &#125;</span><br><span class="line">	netDevice-&gt;LinkLayerType = type;</span><br><span class="line">    <span class="keyword">return</span> netDevice;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> NetDeviceImpl *<span class="title function_">InitNetDeviceImpl</span><span class="params">(NetDevice *nd, NetIfCategory ifCategory)</span></span><br><span class="line">&#123;</span><br><span class="line">    ndImpl = (<span class="keyword">struct</span> NetDeviceImpl *)OsalMemCalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> NetDeviceImpl));</span><br><span class="line"></span><br><span class="line">    ndImpl-&gt;netDevice = nd;</span><br><span class="line">    <span class="comment">//注册ndImpl，就是 ndImpl-&gt;interFace = &amp;g_liteNdImplOps;</span></span><br><span class="line">    <span class="keyword">if</span> (RegisterNetDeviceImpl(ndImpl) != HDF_SUCCESS) &#123;</span><br><span class="line">        ndImpl = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ndImpl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/05/31/killer-blog/OpenHarmony/tmp/netdev/" data-id="cmbcy7ri2003vt8mt1q778bvf" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-killer-blog/OpenHarmony/softbus_lite" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/05/31/killer-blog/OpenHarmony/softbus_lite/" class="article-date">
  <time class="dt-published" datetime="2025-05-31T02:36:45.831Z" itemprop="datePublished">2025-05-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>@[toc]</p>
<h2 id="软总线"><a href="#软总线" class="headerlink" title="软总线"></a>软总线</h2><p>本文简单介绍softbus_lite的部分实现。代码来自openharmony 3.0 foundation&#x2F;commucation&#x2F;softbus_lite。</p>
<p>softbus_lite是L0和L1设备所采用的软总线的实现，相比于标准设备的dsoftbus，功能有所减少。例如softbus_lite只实现被动接收Session连接的功能，无法主动发起session连接以及发现服务。</p>
<p>softbus_lite更多的应用场景是作为边缘设备，通过在局域网内发布服务，等待标准设备的订阅。</p>
<h2 id="一、会话传输"><a href="#一、会话传输" class="headerlink" title="一、会话传输"></a>一、会话传输</h2><p>L0,L1系统属于lite系统，无法主动打开session，只能创建session server，然后等待远程设备来打开会话。在会话回调函数中，可获取会话id。通过session id可用来发送和接收数据。</p>
<h3 id="1-1、CreateSessionServer"><a href="#1-1、CreateSessionServer" class="headerlink" title="1.1、CreateSessionServer"></a>1.1、CreateSessionServer</h3><p>CreateSessionServer：session server的作用只是用来管理listenerMap，即监听的功能，回调函数的执行。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ISessionListener</span> &#123;</span></span><br><span class="line">	<span class="comment">//当会话被打开时回调，sessionId表示本地会话id，也就是tcp连接的句柄，发送和接收数据时会使用到</span></span><br><span class="line">    <span class="type">int</span> (*onSessionOpened)(<span class="type">int</span> sessionId);</span><br><span class="line">    <span class="type">void</span> (*onSessionClosed)(<span class="type">int</span> sessionId);</span><br><span class="line">	<span class="comment">//接受到会话的数据</span></span><br><span class="line">    <span class="type">void</span> (*onBytesReceived)(<span class="type">int</span> sessionId, <span class="type">const</span> <span class="type">void</span> *data, <span class="type">unsigned</span> <span class="type">int</span> dataLen);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建g_sessionMgr，保存参数信息到全局数组</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">CreateSessionServer</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* moduleName, <span class="type">const</span> <span class="type">char</span>* sessionName, <span class="keyword">struct</span> ISessionListener *listener)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret = CreateSessionServerInner(moduleName, sessionName, listener);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//将listener保存到全局数组</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">CreateSessionServerInner</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* moduleName, <span class="type">const</span> <span class="type">char</span>* sessionName, <span class="keyword">struct</span> ISessionListener *listener)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//创建g_sessionMgr</span></span><br><span class="line">    <span class="keyword">if</span> (g_sessionMgr == <span class="literal">NULL</span> &amp;&amp; InitGSessionMgr() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> TRANS_FAILED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//在serverListenerMap中找一个空位置</span></span><br><span class="line">    <span class="type">int</span> findIndex = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX_SESSION_SERVER_NUM; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (g_sessionMgr-&gt;serverListenerMap[i] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            findIndex = i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (findIndex &gt;= <span class="number">0</span> &amp;&amp; findIndex &lt; MAX_SESSION_SERVER_NUM) &#123;</span><br><span class="line">        g_sessionMgr-&gt;serverListenerMap[findIndex] = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(SessionListenerMap));</span><br><span class="line">        <span class="comment">//把参数信息保存到数组</span></span><br><span class="line">        SessionListenerMap *listenerMap = g_sessionMgr-&gt;serverListenerMap[findIndex];</span><br><span class="line">        <span class="keyword">if</span> (strncpy_s(listenerMap-&gt;sessionName, NAME_LENGTH, sessionName, <span class="built_in">strlen</span>(sessionName)) ||</span><br><span class="line">            strncpy_s(listenerMap-&gt;moduleName, NAME_LENGTH, moduleName, <span class="built_in">strlen</span>(moduleName))) &#123;</span><br><span class="line">            <span class="built_in">free</span>(listenerMap);</span><br><span class="line">            listenerMap = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">return</span> TRANS_FAILED;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//把回调函数保存到全局数组</span></span><br><span class="line">        listenerMap-&gt;listener = listener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2、SendBytes"><a href="#1-2、SendBytes" class="headerlink" title="1.2、SendBytes"></a>1.2、SendBytes</h3><p>向会话对端发送字节数据，实际上是调用socket接口 进行发送。</p>
<p>sessionfd就是通过回调函数获取到的sessionid，其实就是tcp端口的句柄。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">SendBytes</span><span class="params">(<span class="type">int</span> sessionfd, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *buf, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//获取session</span></span><br><span class="line">    TcpSession *session = GetSessionById(sessionfd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//打包数据到cipherBuf</span></span><br><span class="line">    <span class="type">char</span> *cipherBuf = (<span class="type">char</span> *)TransPackBytes(session, buf, size, &amp;cipherLen);</span><br><span class="line">    <span class="type">int32_t</span> bytes = <span class="number">0</span>;</span><br><span class="line">    fd_set writefds;</span><br><span class="line">    FD_ZERO(&amp;writefds);</span><br><span class="line">    FD_SET(sessionfd, &amp;writefds);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">msTimeout</span>;</span></span><br><span class="line">    <span class="comment">//设置超时时间</span></span><br><span class="line">    msTimeout.tv_sec = DEFAULT_TIMEOUT / ONE_SEC;</span><br><span class="line">    msTimeout.tv_usec = (DEFAULT_TIMEOUT % ONE_SEC) * ONE_SEC;</span><br><span class="line">    <span class="comment">//阻塞等待socket就绪</span></span><br><span class="line">    <span class="type">int</span> err = select(sessionfd + <span class="number">1</span>, <span class="literal">NULL</span>, &amp;writefds, <span class="literal">NULL</span>, &amp;msTimeout);</span><br><span class="line">	<span class="comment">//使用socket发送数据</span></span><br><span class="line">    <span class="keyword">while</span> (FD_ISSET(sessionfd, &amp;writefds) &amp;&amp; bytes &lt; (<span class="type">int32_t</span>)cipherLen &amp;&amp; (sessionfd) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        errno = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int32_t</span> rc = send(sessionfd, cipherBuf + bytes, cipherLen - bytes, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> ((rc == <span class="number">-1</span>) &amp;&amp; (errno == EAGAIN)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rc &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bytes == <span class="number">0</span>) &#123;</span><br><span class="line">                bytes = <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        bytes += rc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(cipherBuf);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="二、设备发现"><a href="#二、设备发现" class="headerlink" title="二、设备发现"></a>二、设备发现</h2><p>用户使用发现功能来自动发现周围的OpenHarmony设备时，需要保证发现端设备与被发现端设备在同一个局域网内，并且互相能收到对方以下流程的报文。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">（<span class="number">1</span>）发现端设备，发起discover请求后，使用coap协议在局域网内发送广播。</span><br><span class="line">（<span class="number">2</span>）被发现端设备使用PublishService接口发布服务，接收端收到广播后，发送coap协议单播给发现端。</span><br><span class="line">（<span class="number">3</span>）发现端设备收到报文会更新设备信息。    </span><br></pre></td></tr></table></figure>

<p>设备发现的最终目的就是发现局域网内的设备，更新周围的设备id。</p>
<p>目前L0、L1系统，也就是lite系统，不支持作为发现端。只能作为被发现端。通过使用PublishService接口发布服务，就能被标准设备发现。</p>
<p>发现服务的工作原理是这样的：</p>
<ul>
<li><p>首先由本地A设备,远程B设备。A设备调用PublishService发布服务，会创建一个udp服务器，监听一个广播端口。</p>
</li>
<li><p>B设备调用StartDiscovery开始发现设备，会创建一个udp客户端，向局域网广播。（B是L2设备）</p>
</li>
<li><p>A收到B的广播消息后，创建一个udp客户端，给B发送响应消息，响应消息中包含A的设备信息。</p>
</li>
<li><p>B收到响应后，会执行回调函数，函数参数就是A的设备信息。</p>
</li>
<li><p>B接下来可对A进行会话连接等。</p>
</li>
</ul>
<p>下面的结构体表示服务提供的设备信息：这个信息会一直传递到对端设备</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief 发送给对端的本地设备信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">PublishInfo</span> &#123;</span></span><br><span class="line">    <span class="comment">//服务id，如何确定？</span></span><br><span class="line">    <span class="type">int</span> publishId;</span><br><span class="line">    <span class="comment">//L0,L1设备只能是DISCOVER_MODE_PASSIVE 被动发现</span></span><br><span class="line">    <span class="type">int</span> mode;</span><br><span class="line">    <span class="comment">//协议：COAP协议</span></span><br><span class="line">    ExchangeMedium medium;</span><br><span class="line">    <span class="comment">//报文发送频率</span></span><br><span class="line">    ExchangeFreq freq;</span><br><span class="line">    <span class="comment">/** 服务发布的能力. 见下文 */</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *capability;</span><br><span class="line">    <span class="comment">/** 服务的数据。见下文 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *capabilityData;</span><br><span class="line">    <span class="comment">/** Maximum length of the capability data for service publishing (2 bytes) */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> dataLen;</span><br><span class="line">&#125; PublishInfo;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief 服务的能力枚举，具体是什么意思？</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    <span class="comment">/** MeeTime */</span></span><br><span class="line">    HICALL_CAPABILITY_BITMAP = <span class="number">0</span>,</span><br><span class="line">    <span class="comment">/** Video reverse connection in the smart domain */</span></span><br><span class="line">    PROFILE_CAPABILITY_BITMAP = <span class="number">1</span>,</span><br><span class="line">    <span class="comment">/** Gallery in Vision */</span></span><br><span class="line">    HOMEVISIONPIC_CAPABILITY_BITMAP = <span class="number">2</span>,</span><br><span class="line">    <span class="comment">/** cast+ */</span></span><br><span class="line">    CASTPLUS_CAPABILITY_BITMAP,</span><br><span class="line">    <span class="comment">/** Input method in Vision */</span></span><br><span class="line">    AA_CAPABILITY_BITMAP,</span><br><span class="line">    <span class="comment">/** Device virtualization tool package */</span></span><br><span class="line">    DVKIT_CAPABILITY_BITMAP,</span><br><span class="line">    <span class="comment">/** Distributed middleware */</span></span><br><span class="line">    DDMP_CAPABILITY_BITMAP</span><br><span class="line">&#125; DataBitMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//将服务的能力和字符串绑定</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> CapabilityMap g_capabilityMap[] = &#123;</span><br><span class="line">    &#123;HICALL_CAPABILITY_BITMAP, (<span class="type">char</span> *)<span class="string">&quot;hicall&quot;</span>&#125;,</span><br><span class="line">    &#123;PROFILE_CAPABILITY_BITMAP, (<span class="type">char</span> *)<span class="string">&quot;profile&quot;</span>&#125;,</span><br><span class="line">    &#123;CASTPLUS_CAPABILITY_BITMAP, (<span class="type">char</span> *)<span class="string">&quot;castPlus&quot;</span>&#125;,</span><br><span class="line">    &#123;HOMEVISIONPIC_CAPABILITY_BITMAP, (<span class="type">char</span> *)<span class="string">&quot;homevisionPic&quot;</span>&#125;,</span><br><span class="line">    &#123;AA_CAPABILITY_BITMAP, (<span class="type">char</span> *)<span class="string">&quot;aaCapability&quot;</span>&#125;,</span><br><span class="line">    &#123;DVKIT_CAPABILITY_BITMAP, (<span class="type">char</span> *)<span class="string">&quot;dvKit&quot;</span>&#125;,</span><br><span class="line">    &#123;DDMP_CAPABILITY_BITMAP, (<span class="type">char</span> *)<span class="string">&quot;ddmpCapability&quot;</span>&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>





<h3 id="2-1、发布服务"><a href="#2-1、发布服务" class="headerlink" title="2.1、发布服务"></a>2.1、发布服务</h3><p>即设备在局域网内发布上述的服务，这些服务就能被发现和调用。其本质就是将PublishInfo保存到全局变量中，并创建coap server监听端口，等待服务被发现和调用。当收到发现报文时，将PublishInfo里的信息通过coap报文，发送给发现者。</p>
<p>PublishService用于发布服务，代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">PublishService</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *moduleName, <span class="type">const</span> <span class="keyword">struct</span> PublishInfo *info, <span class="type">const</span> <span class="keyword">struct</span> IPublishCallback *cb)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//检查是否有软总线权限</span></span><br><span class="line">    <span class="keyword">if</span> (SoftBusCheckPermission(SOFTBUS_PERMISSION) != <span class="number">0</span> || info == <span class="literal">NULL</span> || cb == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ERROR_INVALID;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//初始化全局服务</span></span><br><span class="line">    <span class="keyword">if</span> (InitService() != ERROR_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">return</span> ERROR_FAIL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//初始化module</span></span><br><span class="line">    PublishModule *findModule = AddPublishModule(moduleName, info);</span><br><span class="line">    <span class="comment">//设置全局变量</span></span><br><span class="line">    <span class="keyword">if</span> (info-&gt;capability == <span class="literal">NULL</span> || info-&gt;capabilityData == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        (<span class="type">void</span>)CoapRegisterDefualtService();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ret = DoRegistService(info-&gt;medium);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行用户回调函数</span></span><br><span class="line">    <span class="keyword">if</span> (ret != ERROR_SUCCESS) &#123;</span><br><span class="line">        PublishCallback(info-&gt;publishId, PUBLISH_FAIL_REASON_UNKNOWN, findModule, cb);</span><br><span class="line">        <span class="keyword">return</span> ERROR_FAIL;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//call back</span></span><br><span class="line">        PublishCallback(info-&gt;publishId, ERROR_SUCCESS, findModule, cb);</span><br><span class="line">        <span class="keyword">return</span> ERROR_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>初始化全局服务，是主要的初始化代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化服务：初始化设备信息ip地址、注册wifi回调函数、coap初始化。在连接到wifi后，启动soft bus、注册设备信息到softbus</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">InitService</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//初始化 g_deviceInfo、g_publishModule、g_capabilityData、g_wifiCallback等全局变量</span></span><br><span class="line">    InitCommonManager();</span><br><span class="line"></span><br><span class="line">    g_publishModule = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(PublishModule) * MAX_MODULE_COUNT);</span><br><span class="line">    g_capabilityData = <span class="built_in">calloc</span>(<span class="number">1</span>, MAX_SERVICE_DATA_LEN);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注册wifi事件回调函数，具体见下文</span></span><br><span class="line">    RegisterWifiCallback(WifiEventTrigger);</span><br><span class="line">    <span class="comment">//初始化coap服务器，处理coap报文逻辑</span></span><br><span class="line">    <span class="type">int</span> ret = CoapInit();</span><br><span class="line">    <span class="comment">//给wifi队列写入消息，本质是使能WifiEventTrigger()函数</span></span><br><span class="line">    CoapWriteMsgQueue(UPDATE_IP_EVENT);</span><br><span class="line">    <span class="comment">//设置设备信息</span></span><br><span class="line">    ret = CoapRegisterDeviceInfo();</span><br><span class="line">    <span class="keyword">return</span> ERROR_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在整个发现服务流程中，以下全局变量经常使用到，有必要简单的了解下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//全局模块 对应一个上层的应用</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> package[MAX_PACKAGE_NAME];	<span class="comment">//上层应用packagename</span></span><br><span class="line">    <span class="type">int</span> publishId;					</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> medium;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> capabilityBitmap;</span><br><span class="line">    <span class="type">char</span> *capabilityData;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> dataLength;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> used;</span><br><span class="line">&#125; PublishModule;</span><br><span class="line">g_publishModule;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *g_capabilityData = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//设备信息</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">DeviceInfo</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> deviceName[MAX_DEV_NAME_LEN];</span><br><span class="line">    <span class="type">char</span> deviceId[MAX_DEV_ID_LEN];</span><br><span class="line">    <span class="type">char</span> deviceIp[MAX_DEV_IP_LEN];</span><br><span class="line">    <span class="type">char</span> version[MAX_DEV_VERSION_LEN];</span><br><span class="line">    <span class="type">char</span> softwareVersion[MAX_SOFTWARE_VERSION_LEN];	<span class="comment">//软件版本</span></span><br><span class="line">    <span class="type">char</span> networkName[MAX_DEV_NETWORK_LEN];</span><br><span class="line">    <span class="type">int</span> deviceType;</span><br><span class="line">    <span class="type">int</span> devicePort;</span><br><span class="line">    NetworkState networkState;</span><br><span class="line">    <span class="type">int</span> isAccountTrusted;</span><br><span class="line">&#125; DeviceInfo;</span><br><span class="line">g_deviceInfo;</span><br></pre></td></tr></table></figure>

<h4 id="2-1-1、wifi事件"><a href="#2-1-1、wifi事件" class="headerlink" title="2.1.1、wifi事件"></a>2.1.1、wifi事件</h4><p>WifiEventTrigger()是一个回调函数，他的执行环境是线程CoapWifiEventThread（待会解释）。当连接到wifi后，CoapWifiEventThread就会调用WifiEventTrigger()，其参数para&#x3D;1，表示连接到wifi。表示网络已连接，那么就可用开始软总线。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//WIFI事件回调 state=1:UPDATE_IP_EVENT</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">WifiEventTrigger</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> para)</span></span><br><span class="line">&#123;</span><br><span class="line">    DeviceInfo *localDev = GetCommonDeviceInfo();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//para=state=1 连接上wifi</span></span><br><span class="line">    <span class="keyword">if</span> (para) &#123;</span><br><span class="line">        <span class="comment">//获取ip</span></span><br><span class="line">        <span class="type">char</span> wifiIp[MAX_DEV_IP_LEN] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        CoapGetIp(wifiIp, MAX_DEV_IP_LEN, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(wifiIp, <span class="string">&quot;0.0.0.0&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ret = memcpy_s(localDev-&gt;deviceIp, <span class="keyword">sizeof</span>(localDev-&gt;deviceIp), wifiIp, <span class="keyword">sizeof</span>(wifiIp));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//清除ip，断开网络连接</span></span><br><span class="line">        ret = memset_s(localDev-&gt;deviceIp, <span class="keyword">sizeof</span>(localDev-&gt;deviceIp), <span class="number">0</span>, <span class="keyword">sizeof</span>(localDev-&gt;deviceIp));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//开启软总线</span></span><br><span class="line">    <span class="keyword">if</span> (BusManager(para) != ERROR_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//初始化本地设备信息</span></span><br><span class="line">    <span class="keyword">if</span> (CoapRegisterDeviceInfo() != ERROR_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//注册capablity 和 g_capabilityData 到nstackx </span></span><br><span class="line">    <span class="keyword">if</span> (DoRegistService(COAP) != ERROR_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-1-2、coap服务器"><a href="#2-1-2、coap服务器" class="headerlink" title="2.1.2、coap服务器"></a>2.1.2、coap服务器</h4><p>coapInit()最终是调用CoapInitDiscovery() 来建立coap协议所需的资源：</p>
<ul>
<li>udp server：用于监听coap报文</li>
<li>wifi消息队列：缓存wifi状态消息</li>
<li>CoapWifiEventThread：处理wifi消息队列</li>
<li>CreateCoapListenThread：处理coap报文交互逻辑</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化coap协议所需资源</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">CoapInitDiscovery</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//建立udp server 监听5684端口（coap协议默认端口）</span></span><br><span class="line">    <span class="type">int</span> ret = CoapInitSocket();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建wifi消息队列</span></span><br><span class="line">    ret = CoapInitWifiEvent();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建 CoapWifiEventThread 线程</span></span><br><span class="line">    <span class="keyword">if</span> (CreateMsgQueThread() != NSTACKX_EOK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NSTACKX_EFAILED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建CoapReadHandle 线程</span></span><br><span class="line">    <span class="keyword">return</span> CreateCoapListenThread();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CoapWifiEventThread线程：其本质内容就是执行wifi事件回调函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//处理wifi队列的消息</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">CoapWifiEventThread</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> uwParam1, <span class="type">unsigned</span> <span class="type">int</span> uwParam2, <span class="type">unsigned</span> <span class="type">int</span> uwParam3, <span class="type">unsigned</span> <span class="type">int</span> uwParam4)</span></span><br><span class="line">&#123;</span><br><span class="line">    g_wifiTaskStart = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (g_wifiTaskStart) &#123;</span><br><span class="line">        <span class="comment">//读取队列消息的消息： handler（WifiEventTrigger）</span></span><br><span class="line">        ret = ReadMsgQue(g_wifiQueueId, &amp;handle, &amp;readSize);</span><br><span class="line">        <span class="keyword">if</span> ((ret == <span class="number">0</span>) &amp;&amp; (readSize == <span class="keyword">sizeof</span>(AddressEventHandler))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (handle.handler == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//执行回调函数（WifiEventTrigger）</span></span><br><span class="line">            handle.handler(handle.state);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CoapReadHandle：读取udp server接收的数据，并处理数据。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">CoapReadHandle</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> uwParam1, <span class="type">unsigned</span> <span class="type">int</span> uwParam2, <span class="type">unsigned</span> <span class="type">int</span> uwParam3, <span class="type">unsigned</span> <span class="type">int</span> uwParam4)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//获取之间创建的udp server</span></span><br><span class="line">    <span class="type">int</span> serverFd = GetCoapServerSocket();</span><br><span class="line">    <span class="keyword">while</span> (g_terminalFlag) &#123;</span><br><span class="line">        FD_ZERO(&amp;readSet);</span><br><span class="line">        FD_SET(serverFd, &amp;readSet);</span><br><span class="line">        <span class="comment">//读取udp server接收的数据</span></span><br><span class="line">        ret = select(serverFd + <span class="number">1</span>, &amp;readSet, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (FD_ISSET(serverFd, &amp;readSet)) &#123;</span><br><span class="line">                <span class="comment">//处理接收数据</span></span><br><span class="line">                HandleReadEvent(serverFd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            SOFTBUS_PRINT(<span class="string">&quot;[DISCOVERY]ret:%d,error:%d\n&quot;</span>, ret, errno);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>处理udp server数据的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//处理udp数据报事件</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">HandleReadEvent</span><span class="params">(<span class="type">int</span> fd)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> socketFd = fd;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *recvBuffer = <span class="built_in">calloc</span>(<span class="number">1</span>, COAP_MAX_PDU_SIZE + <span class="number">1</span>);</span><br><span class="line">    <span class="type">ssize_t</span> nRead;</span><br><span class="line">    <span class="comment">//读取coap报文</span></span><br><span class="line">    nRead = CoapSocketRecv(socketFd, recvBuffer, COAP_MAX_PDU_SIZE);</span><br><span class="line">	</span><br><span class="line">    COAP_Packet decodePacket;</span><br><span class="line">    (<span class="type">void</span>)memset_s(&amp;decodePacket, <span class="keyword">sizeof</span>(COAP_Packet), <span class="number">0</span>, <span class="keyword">sizeof</span>(COAP_Packet));</span><br><span class="line">    decodePacket.protocol = COAP_UDP;</span><br><span class="line">    <span class="comment">//解析coap报文的数据，封装成decodePacket</span></span><br><span class="line">    COAP_SoftBusDecode(&amp;decodePacket, recvBuffer, nRead);</span><br><span class="line">    <span class="comment">//响应远程发现者</span></span><br><span class="line">    PostServiceDiscover(&amp;decodePacket);</span><br><span class="line">    <span class="built_in">free</span>(recvBuffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>响应的内容是什么？具体来看PostServiceDiscover()：</p>
<p>从对端发来的coap报文中，可解析出对端的ip地址和url，然后将本地设备信息和对端地址组成coap报文，发送给对端</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//给远程设备发送响应</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">PostServiceDiscover</span><span class="params">(<span class="type">const</span> COAP_Packet *pkt)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *remoteUrl = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//从pkt中，可获取对端设备的ip等信息，封装成deviceinfo</span></span><br><span class="line">    DeviceInfo deviceInfo;</span><br><span class="line"></span><br><span class="line">    (<span class="type">void</span>)memset_s(&amp;deviceInfo, <span class="keyword">sizeof</span>(deviceInfo), <span class="number">0</span>, <span class="keyword">sizeof</span>(deviceInfo));</span><br><span class="line">    <span class="comment">//解析pkt-&gt;payload.buffer数据到deviceInfo</span></span><br><span class="line">    <span class="keyword">if</span> (GetServiceDiscoverInfo(pkt-&gt;payload.buffer, pkt-&gt;payload.len, &amp;deviceInfo, &amp;remoteUrl) != NSTACKX_EOK) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取对端的ip地址</span></span><br><span class="line">    <span class="type">char</span> wifiIpAddr[NSTACKX_MAX_IP_STRING_LEN];</span><br><span class="line">    (<span class="type">void</span>)memset_s(wifiIpAddr, <span class="keyword">sizeof</span>(wifiIpAddr), <span class="number">0</span>, <span class="keyword">sizeof</span>(wifiIpAddr));</span><br><span class="line">    (<span class="type">void</span>)inet_ntop(AF_INET, &amp;deviceInfo.netChannelInfo.wifiApInfo.ip, wifiIpAddr, <span class="keyword">sizeof</span>(wifiIpAddr));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (remoteUrl != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">//利用deviceinfo，发送coap报文给对端</span></span><br><span class="line">        CoapResponseService(pkt, remoteUrl, wifiIpAddr);</span><br><span class="line">        <span class="built_in">free</span>(remoteUrl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//发送CoapRequest到remoteIp</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">CoapResponseService</span><span class="params">(<span class="type">const</span> COAP_Packet *pkt, <span class="type">const</span> <span class="type">char</span>* remoteUrl, <span class="type">const</span> <span class="type">char</span>* remoteIp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="comment">//初始化CoapRequest</span></span><br><span class="line">    CoapRequest coapRequest;</span><br><span class="line">    coapRequest.remoteUrl = remoteUrl;  <span class="comment">//资源地址</span></span><br><span class="line">    coapRequest.remoteIp = remoteIp;    <span class="comment">//ip地址</span></span><br><span class="line">    <span class="comment">//payload包含了本地设备的信息</span></span><br><span class="line">    <span class="type">char</span> *payload = PrepareServiceDiscover();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//以下就是构建coapRequest</span></span><br><span class="line">    COAP_ReadWriteBuffer sndPktBuff = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    sndPktBuff.readWriteBuf = <span class="built_in">calloc</span>(<span class="number">1</span>, COAP_MAX_PDU_SIZE);</span><br><span class="line">    sndPktBuff.size = COAP_MAX_PDU_SIZE;</span><br><span class="line">    sndPktBuff.len = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//根据pkt和ip构建coap报文sndPktBuff</span></span><br><span class="line">    ret = BuildSendPkt(pkt, remoteIp, payload, &amp;sndPktBuff);</span><br><span class="line">    <span class="built_in">free</span>(payload);</span><br><span class="line">    coapRequest.data = sndPktBuff.readWriteBuf;</span><br><span class="line">    coapRequest.dataLength = sndPktBuff.len;</span><br><span class="line">    <span class="comment">//创建udp客户端并发送coap报文</span></span><br><span class="line">    ret = CoapSendRequest(&amp;coapRequest);</span><br><span class="line">    <span class="built_in">free</span>(sndPktBuff.readWriteBuf);</span><br><span class="line">    sndPktBuff.readWriteBuf = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>payload的内容就是设备信息，其json格式如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;deviceId&quot;</span>:[device ID, <span class="built_in">string</span>],</span><br><span class="line">  <span class="string">&quot;deviceName&quot;</span>:[device name, <span class="built_in">string</span>],</span><br><span class="line">  <span class="string">&quot;type&quot;</span>: [device type, number],</span><br><span class="line">  <span class="string">&quot;version&quot;</span>:[hicom version, <span class="built_in">string</span>],</span><br><span class="line">  <span class="string">&quot;wlanIp&quot;</span>:[WLAN IP address, <span class="built_in">string</span>],</span><br><span class="line">  <span class="string">&quot;capabilityBitmap&quot;</span>:[bitmap, bitmap, bitmap, ...]</span><br><span class="line">  <span class="string">&quot;coapUri&quot;</span>:[coap uri <span class="keyword">for</span> discover, <span class="built_in">string</span>]   &lt;-- optional. When present, means it<span class="string">&#x27;s broadcast request.</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>对端在收到这个消息后，就可以会触发回调函数：该函数在dsoftbus中定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> (*OnDeviceFound)(<span class="type">const</span> DeviceInfo *device);</span><br></pre></td></tr></table></figure>

<p>该函数的参数device中就包含了payload中的信息，这样对端就了解了局域网内有什么设备。</p>
<h3 id="2-2、软总线"><a href="#2-2、软总线" class="headerlink" title="2.2、软总线"></a>2.2、软总线</h3><p>上一节的WifiEventTrigger()中，在连接到wifi后，会启动软总线，创建软总线运行所需的资源：</p>
<ul>
<li>回调函数OnConnectEvent：初始化认证相关的结构体</li>
<li>回调函数OnDataEvent：认证数据的处理逻辑（详）</li>
<li>WaitProcess线程：读取g_listenFd，执行回调函数，处理软总线的事务</li>
<li>SelectSessionLoop线程：处理tcp session的事务</li>
<li>AuthManager：设备认证事务</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">StartBus</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//设置软总线的回调函数</span></span><br><span class="line">    g_baseLister.onConnectEvent = OnConnectEvent;</span><br><span class="line">    g_baseLister.onDataEvent = OnDataEvent;</span><br><span class="line">    <span class="comment">//创建 tcp server、WaitProcess线程 用于执行回调函数</span></span><br><span class="line">    <span class="type">int</span> authPort = StartListener(&amp;g_baseLister, info-&gt;deviceIp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建tcp server、SelectSessionLoop线程、用于实现session的回调</span></span><br><span class="line">    <span class="type">int</span> sessionPort = StartSession(info-&gt;deviceIp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存两个tcp server的端口</span></span><br><span class="line">    AuthMngInit(authPort, sessionPort);</span><br><span class="line">    g_busStartFlag = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="2-2-1、SelectSessionLoop"><a href="#2-2-1、SelectSessionLoop" class="headerlink" title="2.2.1、SelectSessionLoop"></a>2.2.1、SelectSessionLoop</h4><p>SelectSessionLoop线程：监听所有session的数据，并处理这些数据。</p>
<p>session是一个建立在tcp传输上的概念，创建一个session的过程如下：</p>
<p>首先A创建一个tcp server，监听连接。B与A建立TCP连接，能够正常传输TCP数据。接着发送特定的TCP数据，建立session连接。所以这里涉及到了两个连接，一个是tcp层的，一个session层的连接。tcp 层的连接建立完成后可以初始化session结构体，其实现在ProcessConnection().Session层的连接在ProcessSesssionData()中完成。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">SelectSessionLoop</span><span class="params">(TcpSessionMgr *tsm)</span></span><br><span class="line">&#123;</span><br><span class="line">    tsm-&gt;isSelectLoopRunning = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        fd_set readfds;	<span class="comment">//用于读取数据</span></span><br><span class="line">        fd_set exceptfds;</span><br><span class="line">        <span class="comment">//等待readfds的消息</span></span><br><span class="line">        <span class="type">int</span> ret = select(maxFd + <span class="number">1</span>, &amp;readfds, <span class="literal">NULL</span>, &amp;exceptfds, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="comment">//处理数据</span></span><br><span class="line">            ProcessData(tsm, &amp;readfds);</span><br><span class="line">    &#125;</span><br><span class="line">    tsm-&gt;isSelectLoopRunning = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理session数据</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ProcessData</span><span class="params">(TcpSessionMgr *tsm, fd_set *rfds)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//listenFd的消息，则表示需要创建tcp session连接</span></span><br><span class="line">    <span class="keyword">if</span> (FD_ISSET(tsm-&gt;listenFd, rfds)) &#123;</span><br><span class="line">        ProcessConnection(tsm);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//否则，是tcp session数据</span></span><br><span class="line">    ProcessSesssionData(tsm, rfds);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ProcessConnection：完成tcp连接，并初始化session结构体，方便下一阶段建立session使用。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ProcessConnection</span><span class="params">(TcpSessionMgr *tsm)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//建立tcp 连接</span></span><br><span class="line">    <span class="type">int</span> cfd = accept(tsm-&gt;listenFd, (<span class="keyword">struct</span> sockaddr *)&amp;addr, &amp;addrLen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建tcp session</span></span><br><span class="line">    TcpSession *session = CreateTcpSession();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//把authConn的deivceid复制到session</span></span><br><span class="line">    AuthConn* authConn = GetOnLineAuthConnByIp(inet_ntoa(addr.sin_addr));</span><br><span class="line">    <span class="keyword">if</span> (authConn != <span class="literal">NULL</span> &amp;&amp; strncpy_s(session-&gt;deviceId, MAX_DEV_ID_LEN, authConn-&gt;deviceId,</span><br><span class="line">        <span class="built_in">strlen</span>(authConn-&gt;deviceId)) != <span class="number">0</span>) &#123;</span><br><span class="line">        SOFTBUS_PRINT(<span class="string">&quot;[TRANS] Error on copy deviceId of session.&quot;</span>);</span><br><span class="line">        <span class="built_in">free</span>(session);</span><br><span class="line">        CloseSession(cfd);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//把tcp连接添加session</span></span><br><span class="line">    session-&gt;fd = cfd;</span><br><span class="line">    <span class="comment">//把session给sessionmgr管理</span></span><br><span class="line">    <span class="type">int</span> result = AddSession(tsm, session);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ProcessSesssionData：初始化完成session后，接收到session数据。有两种session数据类型，一种是请求建立session，一种是正常的session数据。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ProcessSesssionData</span><span class="params">(<span class="type">const</span> TcpSessionMgr *tsm, <span class="type">const</span> fd_set *rfds)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//遍历所有的tcp session，找到fd对应的session</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX_SESSION_SUM_NUM; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tsm-&gt;sessionMap_[i] != <span class="literal">NULL</span> &amp;&amp; tsm-&gt;sessionMap_[i]-&gt;fd != <span class="number">-1</span> &amp;&amp;</span><br><span class="line">            FD_ISSET(tsm-&gt;sessionMap_[i]-&gt;fd, rfds) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//处理对应session数据</span></span><br><span class="line">            <span class="keyword">if</span> (!OnProcessDataAvailable(tsm-&gt;sessionMap_[i])) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//处理tcp session的数据</span></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">OnProcessDataAvailable</span><span class="params">(TcpSession *session)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//name是softbus_Lite_unknown 说明是对方发起session连接请求</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(session-&gt;sessionName, <span class="string">&quot;softbus_Lite_unknown&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//处理session连接请求，响应请求，执行回调函数onSessionOpened</span></span><br><span class="line">        <span class="type">bool</span> isSuccess = HandleRequestMsg(session);</span><br><span class="line">        <span class="keyword">if</span> (!isSuccess) &#123;</span><br><span class="line">            CloseSession(session-&gt;fd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> isSuccess;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//已经建立了session 正常接收数据</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span>* buf = <span class="built_in">calloc</span>(<span class="number">1</span>, RECIVED_BUFF_SIZE);</span><br><span class="line"></span><br><span class="line">        SessionListenerMap *sessionListener = GetSessionListenerByName(session-&gt;sessionName,</span><br><span class="line">            <span class="built_in">strlen</span>(session-&gt;sessionName));</span><br><span class="line">        <span class="keyword">if</span> (sessionListener != <span class="literal">NULL</span> &amp;&amp; sessionListener-&gt;listener != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">//读取session数据</span></span><br><span class="line">            <span class="type">int</span> recvLen = TcpSessionRecv(session, (<span class="type">char</span> *)buf, RECIVED_BUFF_SIZE, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//执行session的回调函数，处理 接收数据</span></span><br><span class="line">            sessionListener-&gt;listener-&gt;onBytesReceived(session-&gt;fd, buf, recvLen);</span><br><span class="line">            <span class="built_in">free</span>(buf);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">free</span>(buf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-2-2、WaitProcess"><a href="#2-2-2、WaitProcess" class="headerlink" title="2.2.2、WaitProcess"></a>2.2.2、WaitProcess</h4><p>WaitProcess线程，他的任务是监听g_listenFd，并处理软总线上的回调函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//等待建立socket，并回调成功建立</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">WaitProcess</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="comment">//等待g_listenFd 的数据</span></span><br><span class="line">        <span class="type">int</span> ret = select(g_maxFd + <span class="number">1</span>, &amp;readSet, <span class="literal">NULL</span>, &amp;readSet, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret &gt; <span class="number">0</span>) &#123; </span><br><span class="line">            <span class="comment">//处理g_listenFd的数据</span></span><br><span class="line">            <span class="keyword">if</span> (!ProcessAuthData(g_listenFd, &amp;readSet)) &#123;</span><br><span class="line">                StopListener();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理softbus数据 建立socket 回调g_baseLister</span></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">ProcessAuthData</span><span class="params">(<span class="type">int</span> listenFd, <span class="type">const</span> fd_set *readSet)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//listenFd是否在readSet，即listenFd是否有数据</span></span><br><span class="line">    <span class="keyword">if</span> (FD_ISSET(listenFd, readSet)) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addrClient</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">socklen_t</span> addrLen = <span class="keyword">sizeof</span>(addrClient);</span><br><span class="line">        <span class="comment">//建立tcp连接</span></span><br><span class="line">        g_dataFd = accept(listenFd, (<span class="keyword">struct</span> sockaddr *)(&amp;addrClient), &amp;addrLen);</span><br><span class="line">        <span class="comment">//更新g_dataFd</span></span><br><span class="line">        RefreshMaxFd(g_dataFd);</span><br><span class="line">        <span class="comment">//执行回调函数： 连接成功 OnConnectEvent</span></span><br><span class="line">        <span class="keyword">if</span> (g_callback-&gt;onConnectEvent(g_dataFd, inet_ntoa(addrClient.sin_addr)) != <span class="number">0</span>) &#123;</span><br><span class="line">            CloseAuthSessionFd(g_dataFd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//执行回调函数：数据接收 OnDataEvent</span></span><br><span class="line">    <span class="keyword">if</span> (g_dataFd &gt; <span class="number">0</span> &amp;&amp; FD_ISSET(g_dataFd, readSet)) &#123;</span><br><span class="line">        g_callback-&gt;onDataEvent(g_dataFd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-2-3、OnConnectEvent"><a href="#2-2-3、OnConnectEvent" class="headerlink" title="2.2.3、OnConnectEvent"></a>2.2.3、OnConnectEvent</h4><p>重要的结构体，负责认证的连接</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">AuthConn</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="type">char</span> authId[MAX_AUTH_ID_LEN];	<span class="comment">//？</span></span><br><span class="line">    <span class="type">char</span> deviceId[MAX_DEV_ID_LEN];</span><br><span class="line">    <span class="type">char</span> deviceIp[MAX_DEV_IP_LEN];</span><br><span class="line">    <span class="type">int</span> busVersion;</span><br><span class="line">    <span class="type">int</span> authPort;					<span class="comment">//软总线上的认证tcp端口</span></span><br><span class="line">    <span class="type">int</span> sessionPort;				<span class="comment">//软总线上的session端口</span></span><br><span class="line">    <span class="type">int</span> authState;					</span><br><span class="line">    <span class="type">int</span> onlineState;</span><br><span class="line">    DataBuffer db;</span><br><span class="line">&#125; AuthConn;</span><br></pre></td></tr></table></figure>



<p>软总线在收到连接事件后，回调OnDataEvent()，设置aconn对象的ip和fd。aconn会在OnDataEvent()中大放异彩</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将fd、ip赋值给对应的AuthConn</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ProcessConnectEvent</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">char</span> *ip)</span></span><br><span class="line">&#123;</span><br><span class="line">    SOFTBUS_PRINT(<span class="string">&quot;[AUTH] ProcessConnectEvent fd = %d\n&quot;</span>, fd);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span> || ip == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取 aconn,若不为NULL，说明已经认证过了</span></span><br><span class="line">    AuthConn *aconn = FindAuthConnByFd(fd);</span><br><span class="line">    <span class="keyword">if</span> (aconn != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        CloseConn(aconn);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//还未认证，设置aconn</span></span><br><span class="line">    aconn = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(AuthConn));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//复制ip、fd给aconn</span></span><br><span class="line">    <span class="type">int</span> ret = strcpy_s(aconn-&gt;deviceIp, <span class="keyword">sizeof</span>(aconn-&gt;deviceIp), ip);</span><br><span class="line">    </span><br><span class="line">    aconn-&gt;fd = fd;</span><br><span class="line">    <span class="comment">//把 aconn 添加到 g_fdMap 数组</span></span><br><span class="line">    ret = AddAuthConnToList(aconn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-4、OnDataEvent"><a href="#2-2-4、OnDataEvent" class="headerlink" title="2.2.4、OnDataEvent"></a>2.2.4、OnDataEvent</h4><p>当软总线建立与设备的authconn后就可进行认证，具体的方式是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//从tcp端口读取数据包，并解析</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ProcessDataEvent</span><span class="params">(<span class="type">int</span> fd)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//获取authconn</span></span><br><span class="line">    AuthConn *conn = FindAuthConnByFd(fd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//申请buf</span></span><br><span class="line">    <span class="keyword">if</span> (conn-&gt;db.buf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        conn-&gt;db.buf = (<span class="type">char</span> *)<span class="built_in">malloc</span>(DEFAULT_BUF_SIZE);</span><br><span class="line">        (<span class="type">void</span>)memset_s(conn-&gt;db.buf, DEFAULT_BUF_SIZE, <span class="number">0</span>, DEFAULT_BUF_SIZE);</span><br><span class="line">        conn-&gt;db.size = DEFAULT_BUF_SIZE;</span><br><span class="line">        conn-&gt;db.used = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DataBuffer *db = &amp;conn-&gt;db;</span><br><span class="line">    <span class="type">char</span> *buf = db-&gt;buf;</span><br><span class="line">    <span class="type">int</span> used = db-&gt;used;</span><br><span class="line">    <span class="type">int</span> size = db-&gt;size;</span><br><span class="line">    <span class="comment">//接收认证数据到buf</span></span><br><span class="line">    <span class="type">int</span> rc = AuthConnRecv(fd, buf, used, size - used, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    used += rc;</span><br><span class="line">    <span class="comment">//解析tcp包头，处理包内信息</span></span><br><span class="line">    <span class="type">int</span> processed = ProcessPackets(conn, buf, size, used);</span><br><span class="line"></span><br><span class="line">    db-&gt;used = used;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ProcessPackets：根据module参数对软总线的数据分支处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//解析tcp包头，处理包内信息</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ProcessPackets</span><span class="params">(AuthConn *conn, <span class="type">const</span> <span class="type">char</span> *buf, <span class="type">int</span> size, <span class="type">int</span> used)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> processed = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (processed + PACKET_HEAD_SIZE &lt; used) &#123;</span><br><span class="line">        <span class="comment">//将buf首部数据转换成packet</span></span><br><span class="line">        Packet *pkt = ParsePacketHead(buf, processed, used - processed, size);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//有效数据长度</span></span><br><span class="line">        <span class="type">int</span> len = pkt-&gt;dataLen;</span><br><span class="line">        <span class="comment">//处理了buf的首部数据 </span></span><br><span class="line">        processed += PACKET_HEAD_SIZE;</span><br><span class="line">        <span class="comment">//处理payload数据</span></span><br><span class="line">        OnDataReceived(conn, pkt, buf + processed);</span><br><span class="line">        processed += len;</span><br><span class="line">        <span class="built_in">free</span>(pkt);</span><br><span class="line">        pkt = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> processed;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//分支处理对端发来的认证数据</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">OnDataReceived</span><span class="params">(AuthConn *conn, <span class="type">const</span> Packet *pkt, <span class="type">const</span> <span class="type">char</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//module == MODULE_AUTH_SDK</span></span><br><span class="line">    <span class="keyword">if</span> ((pkt-&gt;module &gt; MODULE_HICHAIN) &amp;&amp; (pkt-&gt;module &lt;= MODULE_AUTH_SDK)) &#123;</span><br><span class="line">        <span class="comment">//建立AuthSession，处理认证逻辑</span></span><br><span class="line">        AuthInterfaceOnDataReceived(conn, pkt-&gt;module, pkt-&gt;seq, data, pkt-&gt;dataLen);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cJSON *msg = DecryptMessage(pkt-&gt;module, data, pkt-&gt;dataLen);</span><br><span class="line">    <span class="comment">//建立连接或完成认证</span></span><br><span class="line">    OnModuleMessageReceived(conn, pkt-&gt;module, pkt-&gt;flags, pkt-&gt;seq, msg);</span><br><span class="line">    cJSON_Delete(msg);</span><br><span class="line">    msg = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="AuthInterfaceOnDataReceived"><a href="#AuthInterfaceOnDataReceived" class="headerlink" title="AuthInterfaceOnDataReceived"></a>AuthInterfaceOnDataReceived</h5><p>完成设备认证，其过程是：对端设备发送数据给本地的安全子系统的设备认证模块，设备认证模块负责处理数据，判断是否通过认证。</p>
<p>这里数据传输的方式就是使用 就是session</p>
<p>module的定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MODULE_NONE 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODULE_TRUST_ENGINE 1    <span class="comment">//可信类型，直接进行数据传输</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODULE_HICHAIN 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODULE_AUTH_SDK 3    <span class="comment">//加密数据类型</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODULE_HICHAIN_SYNC 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODULE_CONNECTION 5	<span class="comment">//进行ip及设备认证</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODULE_SESSION 6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODULE_SMART_COMM 7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODULE_AUTH_CHANNEL 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODULE_AUTH_MSG 9</span></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//建立认证session，处理认证逻辑</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">AuthInterfaceOnDataReceived</span><span class="params">(<span class="type">const</span> AuthConn *conn, <span class="type">int</span> module, <span class="type">long</span> <span class="type">long</span> seqId, <span class="type">const</span> <span class="type">char</span> *data, <span class="type">int</span> dataLen)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//创建authsession数组，authsession是一个会话，负责认证逻辑</span></span><br><span class="line">    <span class="keyword">if</span> (AuthSessionMapInit() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//初始化指定auth session</span></span><br><span class="line">    AuthSession *auth = AuthGetAuthSessionBySeqId(seqId);</span><br><span class="line">    <span class="keyword">if</span> (auth == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">//获取失败，将conn添加到g_authSessionMap</span></span><br><span class="line">        auth = AuthGetNewAuthSession(conn, seqId, g_authSessionId);</span><br><span class="line">        ++g_authSessionId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//对不同模组使用不同认证方式</span></span><br><span class="line">    <span class="keyword">switch</span> (module) &#123;</span><br><span class="line">        <span class="keyword">case</span> MODULE_AUTH_SDK:</span><br><span class="line">            <span class="comment">//使用hichain处理auth数据</span></span><br><span class="line">            AuthProcessReceivedData(auth-&gt;sessionId, data, dataLen);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用安全子系统的设备认证模块，来完成对端设备的数据的认证</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">AuthProcessReceivedData</span><span class="params">(<span class="type">uint32_t</span> sessionId, <span class="type">const</span> <span class="type">char</span> *data, <span class="type">int</span> dataLen)</span></span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (g_hcHandle == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">//初始化hichain，hichain是设备认证模块要使用的对象</span></span><br><span class="line">        <span class="keyword">if</span> (AuthInitHiChain(sessionId) != <span class="number">0</span>) &#123;</span><br><span class="line">            AuthDelAuthSessionBySessionId(sessionId);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uint8_buff</span> <span class="title">request</span> =</span> &#123;(<span class="type">uint8_t</span> *)data, dataLen, dataLen&#125;;</span><br><span class="line">    <span class="comment">//把数据传递给安全认证子系统，处理的结果会通过回调函数反馈</span></span><br><span class="line">    <span class="keyword">if</span> (receive_data(g_hcHandle, &amp;request) != HC_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="OnModuleMessageReceived"><a href="#OnModuleMessageReceived" class="headerlink" title="OnModuleMessageReceived"></a>OnModuleMessageReceived</h5><p>处理可信设备</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//处理module消息</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">OnModuleMessageReceived</span><span class="params">(AuthConn *conn, <span class="type">int</span> module, <span class="type">int</span> flags, <span class="type">long</span> <span class="type">long</span> seq, <span class="type">const</span> cJSON *msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (module) &#123;</span><br><span class="line">        <span class="comment">//可信类型，能直接进行数据传输</span></span><br><span class="line">        <span class="keyword">case</span> MODULE_TRUST_ENGINE: &#123;</span><br><span class="line">            <span class="keyword">if</span> (((<span class="type">unsigned</span> <span class="type">int</span>)flags &amp; FLAG_REPLY) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//通过发送本地deviceid 使通道建立？</span></span><br><span class="line">                OnMsgOpenChannelReq(conn, seq, msg);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//连接类型，需要进行ip及设备认证</span></span><br><span class="line">        <span class="keyword">case</span> MODULE_CONNECTION: &#123;</span><br><span class="line">            OnMessageReceived(conn, seq, msg);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//验证设备的ip或deviceid</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">OnMessageReceived</span><span class="params">(AuthConn *conn, <span class="type">long</span> <span class="type">long</span> seq, <span class="type">const</span> cJSON *msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    cJSON *codeJson = cJSON_GetObjectItem(msg, <span class="string">&quot;CODE&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> code = codeJson-&gt;valueint;</span><br><span class="line">    <span class="comment">//回复对端</span></span><br><span class="line">    <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">        <span class="keyword">case</span> CODE_VERIIFY_IP: &#123;</span><br><span class="line">            OnVerifyIp(conn, seq, msg);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> CODE_VERIFY_DEVID: &#123;</span><br><span class="line">            OnVerifyDeviceId(conn, seq, msg);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="问题待解决"><a href="#问题待解决" class="headerlink" title="问题待解决"></a>问题待解决</h2><h4 id="hichain的认证过程"><a href="#hichain的认证过程" class="headerlink" title="hichain的认证过程"></a>hichain的认证过程</h4><p>hichain的认证目前没有找到文档，只能通过源码，猜测以下内容：初始化hichain所需要的对象，软总线作为一个媒介，在hichain和对端设备之间传递数据。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化hichain</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">AuthInitHiChain</span><span class="params">(<span class="type">uint32_t</span> sessionId)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">session_identity</span> <span class="title">serverIdentity</span> =</span> &#123;</span><br><span class="line">        sessionId,</span><br><span class="line">        &#123;AUTH_DEFAULT_ID_LEN, AUTH_DEFAULT_ID&#125;,</span><br><span class="line">        &#123;AUTH_DEFAULT_ID_LEN, AUTH_DEFAULT_ID&#125;,</span><br><span class="line">        <span class="number">0</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//定义设备认证回调函数，会在安全子系统中得到执行 </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hc_call_back</span> <span class="title">hiChainCallback</span> =</span> &#123;</span><br><span class="line">        AuthOnTransmit,         <span class="comment">//发送hichain的数据</span></span><br><span class="line">        AuthGetProtocolParams,  <span class="comment">//获取会话id</span></span><br><span class="line">        AuthSetSessionKey,      <span class="comment">//保存hc_session_key</span></span><br><span class="line">        AuthSetServiceResult,   <span class="comment">//认证结果回调</span></span><br><span class="line">        AuthConfirmReceiveRequest</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//获取hichain，HC_ACCESSORY表示本地是附属设备，收超级终端控制</span></span><br><span class="line">    g_hcHandle = get_instance(&amp;serverIdentity, HC_ACCESSORY, &amp;hiChainCallback);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="tcp-server-连接过程"><a href="#tcp-server-连接过程" class="headerlink" title="tcp server 连接过程"></a>tcp server 连接过程</h4><p>OnModuleMessageReceived()函数处理的是什么逻辑？</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/05/31/killer-blog/OpenHarmony/softbus_lite/" data-id="cmbcy7rhp002pt8mt9z4d77kt" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-killer-blog/OpenHarmony/purple_pi_build" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/05/31/killer-blog/OpenHarmony/purple_pi_build/" class="article-date">
  <time class="dt-published" datetime="2025-05-31T02:36:45.830Z" itemprop="datePublished">2025-05-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="鸿蒙purple-pi-编译手册"><a href="#鸿蒙purple-pi-编译手册" class="headerlink" title="鸿蒙purple pi 编译手册"></a>鸿蒙purple pi 编译手册</h1><p>本文根据官网的手册整理而来</p>
<h2 id="零、下载代码"><a href="#零、下载代码" class="headerlink" title="零、下载代码"></a>零、下载代码</h2><p>安装编译所需工具:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install aptitude</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> aptitude install -y binutils binutils-dev git git-lfs gnupg flex bison gperf build-essential zip curl zlib1g-dev gcc-multilib g++-multilib gcc-arm-linux-gnueabi x11proto-core-dev libx11-dev lib32z1-dev ccache libgl1-mesa-dev libxml2-utils xsltproc unzip m4 bc gnutls-bin python3.8 python3-pip ruby genext2fs device-tree-compiler make libffi-dev e2fsprogs pkg-config perl openssl libssl-dev libelf-dev libdwarf-dev u-boot-tools mtd-utils cpio doxygen liblz4-tool openjdk-8-jre gcc g++ texinfo dosfstools mtools default-jre default-jdk libncurses5 apt-utils wget scons tar rsync git-core libxml2-dev lib32z-dev grsync xxd libglib2.0-dev libpixman-1-dev kmod jfsutils reiserfsprogs xfsprogs squashfs-tools git-lfs</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> apt-get install -y pcmciautils quota ppp libtinfo-dev libtinfo5 libncurses5-dev libncursesw5 libstdc++6 vim ssh locales gcc-arm-linux-gnueabi</span><br></pre></td></tr></table></figure>

<p>下载代码，将代码放到windows共享文件夹下，ubuntu 去挂载：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">prx@ubuntu2004:<span class="built_in">sudo</span> mount -t cifs -o username=prx,password=123456 //172.21.240.1/share /mnt/</span><br><span class="line">prx@ubuntu2004:~/purple_pi$ <span class="built_in">ls</span> /mnt</span><br><span class="line">ido_purple_pi_oh_ohos3.2_sdk.tgz</span><br></pre></td></tr></table></figure>

<p>我们需要将&#x2F;mnt下的ido_purple_pi_oh_ohos3.2_sdk.tgz 复制到ubuntu中，这是因为windows下的文件系统无法进行软链接，会使后面编译出错。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># copy the ido_purple_pi_oh_ohos3.2_sdk.tgz</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> /mnt/ido_purple_pi_oh_ohos3.2_sdk.tgz ~/purple_pi</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查md5</span></span><br><span class="line"><span class="built_in">cd</span> ~/purple_pi</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">md5sum</span> ido_purple_pi_oh_ohos3.2_sdk.tgz</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> tar zxvf ido_purple_pi_oh_ohos3.2_sdk.tgz -C ~/purple_pi</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压完成后只有一个.git文件夹，使用下面命令将文件复原</span></span><br><span class="line"><span class="built_in">sudo</span> git reset --hard</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复原完成</span></span><br><span class="line">prx@ubuntu2004:~/purple_pi$ <span class="built_in">ls</span></span><br><span class="line">applications  base   build.py  commonlibrary  device  drivers     ido_purple_pi_oh_ohos3.2_sdk.tgz  kernel     napi_generator  productdefine  <span class="built_in">test</span>         tools_previewer</span><br><span class="line">arkcompiler   build  build.sh  developtools   docs    foundation  interface                         mkboot.sh  prebuilts       qemu-run       third_party  vendor</span><br></pre></td></tr></table></figure>



<h2 id="一、编译整个openharmony-工程"><a href="#一、编译整个openharmony-工程" class="headerlink" title="一、编译整个openharmony 工程"></a>一、编译整个openharmony 工程</h2><p>编译openharmony系统：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译64bit系统</span></span><br><span class="line">./build.sh --product-name purple_pi_oh --ccache</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译32bit系统</span></span><br><span class="line">./build.sh --product-name purple_pi_oh --ccache --target-cpu arm</span><br></pre></td></tr></table></figure>

<p>生成文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./out/purple_pi_oh/packages/phone/images/</span><br></pre></td></tr></table></figure>



<h2 id="二、编译内核"><a href="#二、编译内核" class="headerlink" title="二、编译内核"></a>二、编译内核</h2><h3 id="第一种方法："><a href="#第一种方法：" class="headerlink" title="第一种方法："></a>第一种方法：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> out/kernel -rf</span><br><span class="line">./build.sh --product-name purple_pi_oh --build-target kernel --ccache</span><br></pre></td></tr></table></figure>

<p>build log:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br></pre></td><td class="code"><pre><span class="line">prx@ubuntu:~/purple_pi$ <span class="built_in">sudo</span> ./build.sh --product-name purple_pi_oh --build-target kernel --ccache</span><br><span class="line">[<span class="built_in">sudo</span>] password <span class="keyword">for</span> prx: </span><br><span class="line">++++++++++++++++++++++++++++++++++++++++</span><br><span class="line"> Your system shell isn<span class="string">&#x27;t bash, we recommend you to use bash, because some commands may not be supported in other shells, such as pushd and shopt are not supported in dash. </span></span><br><span class="line"><span class="string"> You can follow these tips to modify the system shell to bash on Ubuntu: </span></span><br><span class="line"><span class="string"> [1]:Open the Terminal tool and execute the following command: sudo dpkg-reconfigure dash </span></span><br><span class="line"><span class="string"> [2]:Enter the password and select &lt;no&gt;  </span></span><br><span class="line"><span class="string">++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="string">2023-06-18 09:06:20</span></span><br><span class="line"><span class="string">--product-name purple_pi_oh --build-target kernel --ccache</span></span><br><span class="line"><span class="string">[OHOS INFO] Set cache size limit to 100.0 GB</span></span><br><span class="line"><span class="string">[OHOS INFO] root_out_dir=//out/purple_pi_oh</span></span><br><span class="line"><span class="string">[OHOS INFO] root_build_dir=//out/purple_pi_oh</span></span><br><span class="line"><span class="string">[OHOS INFO] root_gen_dir=//out/purple_pi_oh/gen</span></span><br><span class="line"><span class="string">[OHOS INFO] current_toolchain=//build/toolchain/ohos:ohos_clang_arm64</span></span><br><span class="line"><span class="string">[OHOS INFO] host_toolchain=//build/toolchain/linux:clang_x64</span></span><br><span class="line"><span class="string">[OHOS INFO] </span></span><br><span class="line"><span class="string">[OHOS INFO] args: Namespace(platforms_config_file=&#x27;</span>/home/prx/purple_pi/out/preloader/purple_pi_oh/platforms.build<span class="string">&#x27;, subsystem_config_file=&#x27;</span>/home/prx/purple_pi/out/preloader/purple_pi_oh/subsystem_config.json<span class="string">&#x27;, example_subsystem_file=None, exclusion_modules_config_file=&#x27;</span>/home/prx/purple_pi/out/preloader/purple_pi_oh/exclusion_modules.json<span class="string">&#x27;, source_root_dir=&#x27;</span>/home/prx/purple_pi/<span class="string">&#x27;, gn_root_out_dir=&#x27;</span>/home/prx/purple_pi/out/purple_pi_oh<span class="string">&#x27;, build_platform_name=&#x27;</span>phone<span class="string">&#x27;, build_xts=False, load_test_config=True, target_os=&#x27;</span>ohos<span class="string">&#x27;, target_cpu=&#x27;</span>arm64<span class="string">&#x27;, os_level=&#x27;</span>standard<span class="string">&#x27;, ignore_api_check=[&#x27;</span>xts<span class="string">&#x27;, &#x27;</span>common<span class="string">&#x27;, &#x27;</span>developertest<span class="string">&#x27;], scalable_build=False)</span></span><br><span class="line"><span class="string">[OHOS INFO] </span></span><br><span class="line"><span class="string">[OHOS INFO] build configs generation is complete.</span></span><br><span class="line"><span class="string">[OHOS INFO] [&#123;</span></span><br><span class="line"><span class="string">[OHOS INFO]   config = &#123;</span></span><br><span class="line"><span class="string">[OHOS INFO]   accessibility_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   ace_enable_gpu = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   ace_engine_feature_enable_accessibility = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   ace_engine_feature_enable_web = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   advance_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   ark_engine = &#123;</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_defines = [&quot;USE_ARK_ENGINE&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_name = &quot;ark&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_path = &quot;jsi&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO] &#125;</span></span><br><span class="line"><span class="string">[OHOS INFO]   build_container_scope_lib = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   cflags_cc = [&quot;-Wno-thread-safety-attributes&quot;, &quot;-Wno-thread-safety-analysis&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   check_graphic_ext_file_args = [&quot;--filename&quot;, &quot;/home/prx/purple_pi/foundation/graphic/graphic_2d_ext/ohcore/build/config.gni&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   check_graphic_ext_file_script = &quot;//build/ohos/file_exists.py&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO]   connect_server_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   defines = [&quot;OHOS_PLATFORM&quot;, &quot;OHOS_STANDARD_SYSTEM&quot;, &quot;IMAGE_SUPPORTED&quot;, &quot;VIDEO_SUPPORTED&quot;, &quot;WEB_SUPPORTED&quot;, &quot;ABILITY_COMPONENT_SUPPORTED&quot;, &quot;GPU_DISABLED&quot;, &quot;FORM_SUPPORTED&quot;, &quot;REMOTE_WINDOW_SUPPORTED&quot;, &quot;XCOMPONENT_SUPPORTED&quot;, &quot;PLUGIN_COMPONENT_SUPPORTED&quot;, &quot;PIXEL_MAP_SUPPORTED&quot;, &quot;ENABLE_ROSEN_BACKEND&quot;, &quot;ENABLE_STANDARD_INPUT&quot;, &quot;MULTIPLE_WINDOW_SUPPORTED&quot;, &quot;HIDDEN_SYMBOL&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   disable_gpu = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   enable_ability_component = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   enable_image_compression = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   enable_rosen_backend = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   enable_standard_input = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   enable_system_clipboard = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   form_components_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   gpu_defines = [&quot;ACE_ENABLE_GL&quot;, &quot;RS_ENABLE_GL&quot;, &quot;RS_DISABLE_EGLIMAGE&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   graphic_2d_ext_configs = &#123; &#125;</span></span><br><span class="line"><span class="string">[OHOS INFO]   graphic_2d_root = &quot;//foundation/graphic/graphic_2d&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO]   graphic_standard_feature_ace_enable_gpu = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   graphic_standard_feature_bootanimation_enable = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   graphic_standard_feature_color_gamut_enable = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   graphic_standard_feature_enable_afbc = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   graphic_standard_feature_freemem_enable = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   graphic_standard_feature_rs_enable_eglimage = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   graphic_standard_feature_rs_enable_uni_render = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   graphic_standard_feature_wuji_enable = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   hdc_register_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   image_components_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   is_experiment_build = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   js_engines = [&#123;</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_defines = [&quot;USE_ARK_ENGINE&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_name = &quot;ark&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_path = &quot;jsi&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO] &#125;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   js_pa_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   libace_target = &quot;//foundation/arkui/ace_engine/build:libace&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO]   libgl = [&quot;//foundation/graphic/graphic_2d/frameworks/opengl_wrapper:EGL&quot;, &quot;//foundation/graphic/graphic_2d/frameworks/opengl_wrapper:GLESv3&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   multiple_window_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   ohos_standard_fontmgr = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   pa_engine_path = &quot;adapter/ohos/entrance/pa_engine&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO]   pixel_map_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   platform_deps = [&quot;//foundation/arkui/ace_engine/adapter/ohos/entrance:ace_ohos_standard_entrance&quot;, &quot;//foundation/arkui/ace_engine/adapter/ohos/osal:ace_osal_ohos&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   plugin_components_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   preview_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   remote_window_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   rich_components_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   rs_enable_eglimage = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   rs_enable_gpu = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   sk_use_hilog = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   surface_enable_gpu = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   use_build_in_js_engine = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   use_curl_download = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   use_external_icu = &quot;shared&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO]   video_components_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   web_components_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   xcomponent_components_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO] &#125;</span></span><br><span class="line"><span class="string">[OHOS INFO]   name = &quot;ohos&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO] &#125;, &#123;</span></span><br><span class="line"><span class="string">[OHOS INFO]   config = &#123;</span></span><br><span class="line"><span class="string">[OHOS INFO]   accessibility_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   advance_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   ark_engine = &#123;</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_defines = [&quot;USE_ARK_ENGINE&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_name = &quot;ark&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_path = &quot;jsi&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO] &#125;</span></span><br><span class="line"><span class="string">[OHOS INFO]   build_for_preview = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   cflags_cc = [&quot;-std=c++17&quot;, &quot;-DWINVER=0x0601&quot;, &quot;-Wno-inconsistent-dllimport&quot;, &quot;-Wno-macro-redefined&quot;, &quot;-Wno-missing-braces&quot;, &quot;-Wno-thread-safety-attributes&quot;, &quot;-Wno-thread-safety-analysis&quot;, &quot;-Wno-ignored-attributes&quot;, &quot;-Wno-unknown-pragmas&quot;, &quot;-Wno-used-but-marked-unused&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   connect_server_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   defines = [&quot;PREVIEW&quot;, &quot;ENABLE_ROSEN_BACKEND&quot;, &quot;WINDOWS_PLATFORM&quot;, &quot;_USE_MATH_DEFINES&quot;, &quot;NOGDI&quot;, &quot;UNICODE&quot;, &quot;U_CHARSET_IS_UTF8=1&quot;, &quot;SK_BUILD_FOR_WIN&quot;, &quot;SK_BUILD_FONT_MGR_FOR_PREVIEW_WIN&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   enable_ability_component = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   enable_rosen_backend = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   enable_standard_input = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   enable_system_clipboard = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   form_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   image_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   js_engines = [&#123;</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_defines = [&quot;USE_ARK_ENGINE&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_name = &quot;ark&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_path = &quot;jsi&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO] &#125;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   js_pa_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   libace_target = &quot;//foundation/arkui/ace_engine/adapter/preview/build:libace_engine_windows&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO]   ohos_standard_fontmgr = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   platform_deps = [&quot;//foundation/arkui/ace_engine/adapter/preview/entrance:ace_preview_entrance_windows&quot;, &quot;//foundation/arkui/ace_engine/adapter/preview/external:preview_external_source_windows&quot;, &quot;//foundation/arkui/ace_engine/adapter/preview/inspector:ace_inspector_windows&quot;, &quot;//foundation/arkui/ace_engine/adapter/preview/osal:ace_osal_windows&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   plugin_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   preview_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   remote_window_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   rich_components_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   use_build_in_js_engine = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   use_curl_download = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   video_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   web_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   xcomponent_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO] &#125;</span></span><br><span class="line"><span class="string">[OHOS INFO]   name = &quot;windows&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO] &#125;, &#123;</span></span><br><span class="line"><span class="string">[OHOS INFO]   config = &#123;</span></span><br><span class="line"><span class="string">[OHOS INFO]   accessibility_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   advance_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   ark_engine = &#123;</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_defines = [&quot;USE_ARK_ENGINE&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_name = &quot;ark&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_path = &quot;jsi&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO] &#125;</span></span><br><span class="line"><span class="string">[OHOS INFO]   build_for_preview = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   cflags_cc = [&quot;-std=c++17&quot;, &quot;-Wno-thread-safety-attributes&quot;, &quot;-Wno-thread-safety-analysis&quot;, &quot;-Wno-ignored-attributes&quot;, &quot;-Wno-unknown-pragmas&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   connect_server_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   defines = [&quot;PREVIEW&quot;, &quot;ENABLE_ROSEN_BACKEND&quot;, &quot;MAC_PLATFORM&quot;, &quot;UNICODE&quot;, &quot;SK_BUILD_FONT_MGR_FOR_PREVIEW_MAC&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   enable_ability_component = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   enable_rosen_backend = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   enable_standard_input = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   enable_system_clipboard = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   form_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   image_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   js_engines = [&#123;</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_defines = [&quot;USE_ARK_ENGINE&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_name = &quot;ark&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_path = &quot;jsi&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO] &#125;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   js_pa_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   libace_target = &quot;//foundation/arkui/ace_engine/adapter/preview/build:libace_engine_mac&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO]   ohos_standard_fontmgr = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   platform_deps = [&quot;//foundation/arkui/ace_engine/adapter/preview/entrance:ace_preview_entrance_mac&quot;, &quot;//foundation/arkui/ace_engine/adapter/preview/external:preview_external_source_mac&quot;, &quot;//foundation/arkui/ace_engine/adapter/preview/inspector:ace_inspector_mac&quot;, &quot;//foundation/arkui/ace_engine/adapter/preview/osal:ace_osal_mac&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   plugin_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   preview_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   remote_window_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   rich_components_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   use_build_in_js_engine = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   use_curl_download = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   video_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   web_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   xcomponent_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO] &#125;</span></span><br><span class="line"><span class="string">[OHOS INFO]   name = &quot;mac&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO] &#125;, &#123;</span></span><br><span class="line"><span class="string">[OHOS INFO]   config = &#123;</span></span><br><span class="line"><span class="string">[OHOS INFO]   accessibility_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   advance_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   ark_engine = &#123;</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_defines = [&quot;USE_ARK_ENGINE&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_name = &quot;ark&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_path = &quot;jsi&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO] &#125;</span></span><br><span class="line"><span class="string">[OHOS INFO]   build_for_preview = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   cflags_cc = [&quot;-std=c++17&quot;, &quot;-Wno-thread-safety-attributes&quot;, &quot;-Wno-thread-safety-analysis&quot;, &quot;-Wno-ignored-attributes&quot;, &quot;-Wno-unknown-pragmas&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   connect_server_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   defines = [&quot;PREVIEW&quot;, &quot;ENABLE_ROSEN_BACKEND&quot;, &quot;LINUX_PLATFORM&quot;, &quot;UNICODE&quot;, &quot;GPU_DISABLED&quot;, &quot;SK_BUILD_FONT_MGR_FOR_PREVIEW_LINUX&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   enable_ability_component = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   enable_rosen_backend = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   enable_standard_input = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   enable_system_clipboard = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   form_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   image_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   js_engines = [&#123;</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_defines = [&quot;USE_ARK_ENGINE&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_name = &quot;ark&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO]   engine_path = &quot;jsi&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO] &#125;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   js_pa_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   libace_target = &quot;//foundation/arkui/ace_engine/adapter/preview/build:libace_engine_linux&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO]   ohos_standard_fontmgr = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   platform_deps = [&quot;//foundation/arkui/ace_engine/adapter/preview/entrance:ace_preview_entrance_linux&quot;, &quot;//foundation/arkui/ace_engine/adapter/preview/external:preview_external_source_linux&quot;, &quot;//foundation/arkui/ace_engine/adapter/preview/inspector:ace_inspector_linux&quot;, &quot;//foundation/arkui/ace_engine/adapter/preview/osal:ace_osal_linux&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO]   plugin_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   preview_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   remote_window_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   rich_components_support = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   use_build_in_js_engine = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   use_curl_download = true</span></span><br><span class="line"><span class="string">[OHOS INFO]   video_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   web_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO]   xcomponent_components_support = false</span></span><br><span class="line"><span class="string">[OHOS INFO] &#125;</span></span><br><span class="line"><span class="string">[OHOS INFO]   name = &quot;linux&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO] &#125;]</span></span><br><span class="line"><span class="string">[OHOS INFO] Could not find oem hook</span></span><br><span class="line"><span class="string">[OHOS INFO] out_dir:/home/prx/purple_pi/out/purple_pi_oh/gen/base/hiviewdfx/hiview</span></span><br><span class="line"><span class="string">[OHOS INFO] </span></span><br><span class="line"><span class="string">[OHOS INFO] </span></span><br><span class="line"><span class="string">[OHOS INFO] bundle_framework_graphics = true</span></span><br><span class="line"><span class="string">[OHOS INFO] bundle_framework_free_install = true</span></span><br><span class="line"><span class="string">[OHOS INFO] bundle_framework_default_app = true</span></span><br><span class="line"><span class="string">[OHOS INFO] bundle_framework_launcher = true</span></span><br><span class="line"><span class="string">[OHOS INFO] bundle_framework_sandbox_app = true</span></span><br><span class="line"><span class="string">[OHOS INFO] bundle_framework_quick_fix = true</span></span><br><span class="line"><span class="string">[OHOS INFO] bundle_framework_app_control = true</span></span><br><span class="line"><span class="string">[OHOS INFO] distributed_bundle_framework = true</span></span><br><span class="line"><span class="string">[OHOS INFO] ability_runtime_enable = true</span></span><br><span class="line"><span class="string">[OHOS INFO] account_enable = true</span></span><br><span class="line"><span class="string">[OHOS INFO] configpolicy_enable = true</span></span><br><span class="line"><span class="string">[OHOS INFO] device_manager_enable = true</span></span><br><span class="line"><span class="string">[OHOS INFO] global_resmgr_enable = true</span></span><br><span class="line"><span class="string">[OHOS INFO] hicollie_enable = true</span></span><br><span class="line"><span class="string">[OHOS INFO] support_jsapi = true</span></span><br><span class="line"><span class="string">[OHOS INFO] hisysevent_enable = true</span></span><br><span class="line"><span class="string">[OHOS INFO] bms_rdb_enable = true</span></span><br><span class="line"><span class="string">[OHOS INFO] hisysevent_usage = true</span></span><br><span class="line"><span class="string">[OHOS INFO] has_hisysevent_part = true</span></span><br><span class="line"><span class="string">[OHOS INFO] [&quot;--haptobin&quot;, &quot;../../developtools/packing_tool/adapter/ohos&quot;, &quot;--haptobinOutput&quot;, &quot;obj/developtools/packing_tool/jar/haptobin_tool.jar&quot;, &quot;--unpackOutput&quot;, &quot;obj/developtools/packing_tool/jar/app_unpacking_tool.jar&quot;, &quot;--packOutput&quot;, &quot;obj/developtools/packing_tool/jar/app_packing_tool.jar&quot;, &quot;--outpath&quot;, &quot;obj/developtools/packing_tool/jar&quot;, &quot;--toolchain&quot;, &quot;//build/toolchain/ohos:ohos_clang_arm64&quot;, &quot;--compileTarget&quot;, &quot;image&quot;]</span></span><br><span class="line"><span class="string">[OHOS INFO] window_manager_feature_subscribe_motion = false</span></span><br><span class="line"><span class="string">[OHOS INFO] soc_perf_enable:  true</span></span><br><span class="line"><span class="string">[OHOS INFO] imf_enable:  true</span></span><br><span class="line"><span class="string">[OHOS INFO] input_feature_combination_key = true</span></span><br><span class="line"><span class="string">[OHOS INFO] input_feature_pointer_drawing = true</span></span><br><span class="line"><span class="string">[OHOS INFO] input_feature_monitor = true</span></span><br><span class="line"><span class="string">[OHOS INFO] input_feature_interceptor = true</span></span><br><span class="line"><span class="string">[OHOS INFO] input_feature_keyboard = true</span></span><br><span class="line"><span class="string">[OHOS INFO] input_feature_mouse = true</span></span><br><span class="line"><span class="string">[OHOS INFO] input_feature_joystick = true</span></span><br><span class="line"><span class="string">[OHOS INFO] input_feature_touchscreen = true</span></span><br><span class="line"><span class="string">[OHOS INFO] input_feature_input_device = true</span></span><br><span class="line"><span class="string">[OHOS INFO] input_feature_input_cooperation = false</span></span><br><span class="line"><span class="string">[OHOS INFO] defines _ARM64_</span></span><br><span class="line"><span class="string">[OHOS INFO] purple_pi_oh_group in</span></span><br><span class="line"><span class="string">[OHOS INFO] accessibility_enable =  true</span></span><br><span class="line"><span class="string">[OHOS INFO] default_toolchain =  //build/toolchain/ohos:ohos_clang_arm64</span></span><br><span class="line"><span class="string">[OHOS INFO] current_toolchain =  //build/toolchain/ohos:ohos_clang_arm64</span></span><br><span class="line"><span class="string">[OHOS INFO] host_toolchain =  //build/toolchain/linux:clang_x64</span></span><br><span class="line"><span class="string">[OHOS INFO] root_out_dir =  //out/purple_pi_oh</span></span><br><span class="line"><span class="string">[OHOS INFO] root_output_dir_proto =  out/purple_pi_oh/clang_x64</span></span><br><span class="line"><span class="string">[OHOS INFO] histreamer plugin: ffmpeg_adapter = true</span></span><br><span class="line"><span class="string">[OHOS INFO] histreamer plugin: wav_demuxer = false</span></span><br><span class="line"><span class="string">[OHOS INFO] histreamer plugin: hdi_adapter = false</span></span><br><span class="line"><span class="string">[OHOS INFO] histreamer plugin: file_source = true</span></span><br><span class="line"><span class="string">[OHOS INFO] histreamer plugin: file_fd_source = true</span></span><br><span class="line"><span class="string">[OHOS INFO] histreamer plugin: std_stream_source = true</span></span><br><span class="line"><span class="string">[OHOS INFO] histreamer plugin: http_source = true</span></span><br><span class="line"><span class="string">[OHOS INFO] histreamer plugin: stream_source = false</span></span><br><span class="line"><span class="string">[OHOS INFO] histreamer plugin: audio_server_sink = true</span></span><br><span class="line"><span class="string">[OHOS INFO] histreamer plugin:lite_aac_decoder = false</span></span><br><span class="line"><span class="string">[OHOS INFO] histreamer plugin:std_video_surface_sink = true</span></span><br><span class="line"><span class="string">[OHOS INFO] histreamer plugin:std_video_capture = false</span></span><br><span class="line"><span class="string">[OHOS INFO] &#123; &#125;</span></span><br><span class="line"><span class="string">[OHOS INFO] WARNING at the command-line &quot;--args&quot;:1:356: Build argument has no effect.</span></span><br><span class="line"><span class="string">[OHOS INFO] ohos_build_compiler_specified=&quot;clang&quot; ohos_build_compiler_dir=&quot;//prebuilts/clang/ohos/linux-x86_64/llvm&quot; product_path=&quot;/home/prx/purple_pi/vendor/industio/purple_pi_oh&quot; product_name=&quot;purple_pi_oh&quot; device_name=&quot;purple_pi_oh&quot; target_cpu=&quot;arm64&quot; is_standard_system=true device_path=&quot;/home/prx/purple_pi/device/board/industio/purple_pi_oh&quot; device_config_path=&quot;/home/prx/purple_pi/device/board/industio/purple_pi_oh&quot; product_config_path=&quot;/home/prx/purple_pi/vendor/industio/purple_pi_oh&quot; ace_engine_feature_enable_accessibility=true ace_engine_feature_enable_web=true enable_ohos_startup_init_feature_ab_partition=true enable_ohos_startup_init_feature_loader=true dsoftbus_feature_conn_p2p=true dsoftbus_feature_disc_ble=true dsoftbus_feature_conn_br=true dsoftbus_feature_conn_ble=true dsoftbus_feature_trans_udp_stream=true graphic_standard_feature_ace_enable_gpu=true input_feature_combination_key=true input_feature_pointer_drawing=true input_feature_interceptor=true input_feature_monitor=true input_feature_keyboard=true input_feature_mouse=true input_feature_touchscreen=true input_feature_input_device=true wpa_supplicant_driver_nl80211=true drivers_peripheral_input_feature_model=true drivers_peripheral_sensor_feature_model=true drivers_peripheral_audio_full_test_suite=true drivers_peripheral_audio_alsa_lib=false drivers_peripheral_light_feature_model=true drivers_peripheral_vibrator_feature_model=true ohos_build_type=&quot;debug&quot; ohos_build_time=&quot;1687129580661&quot; ohos_build_datetime=&quot;2023-06-18 09:06:20&quot; ohos_build_enable_ccache=true build_variant=&quot;root&quot; device_type=&quot;default&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO]                                                                                                                                                                                                                                                                                                                                                                    ^-------------------------------------------------------</span></span><br><span class="line"><span class="string">[OHOS INFO] The variable &quot;device_config_path&quot; was set as a build argument</span></span><br><span class="line"><span class="string">[OHOS INFO] but never appeared in a declare_args() block in any buildfile.</span></span><br><span class="line"><span class="string">[OHOS INFO] </span></span><br><span class="line"><span class="string">[OHOS INFO] To view all possible args, run &quot;gn args --list &lt;out_dir&gt;&quot;</span></span><br><span class="line"><span class="string">[OHOS INFO] </span></span><br><span class="line"><span class="string">[OHOS INFO] The build continued as if that argument was unspecified.</span></span><br><span class="line"><span class="string">[OHOS INFO] </span></span><br><span class="line"><span class="string">[OHOS INFO] Done. Made 32853 targets from 6113 files in 167536ms</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[OHOS INFO] [1/2] ACTION //device/board/industio/purple_pi_oh/kernel:kernel(//build/toolchain/ohos:ohos_clang_arm64)</span></span><br><span class="line"><span class="string">[OHOS INFO] [2/2] STAMP obj/device/board/industio/purple_pi_oh/kernel/kernel.stamp</span></span><br><span class="line"><span class="string">[OHOS INFO] tar: Removing leading `/&#x27;</span> from member names</span><br><span class="line">[OHOS INFO] /home/prx/purple_pi/out/purple_pi_oh/packages/phone/images/</span><br><span class="line">[OHOS INFO] /home/prx/purple_pi/out/purple_pi_oh/packages/phone/images/sys_prod.img</span><br><span class="line">[OHOS INFO] /home/prx/purple_pi/out/purple_pi_oh/packages/phone/images/parameter.txt</span><br><span class="line">[OHOS INFO] /home/prx/purple_pi/out/purple_pi_oh/packages/phone/images/system.img</span><br><span class="line">[OHOS INFO] /home/prx/purple_pi/out/purple_pi_oh/packages/phone/images/config.cfg</span><br><span class="line">[OHOS INFO] /home/prx/purple_pi/out/purple_pi_oh/packages/phone/images/chip_prod.img</span><br><span class="line">[OHOS INFO] /home/prx/purple_pi/out/purple_pi_oh/packages/phone/images/uboot.img</span><br><span class="line">[OHOS INFO] /home/prx/purple_pi/out/purple_pi_oh/packages/phone/images/resource.img</span><br><span class="line">[OHOS INFO] /home/prx/purple_pi/out/purple_pi_oh/packages/phone/images/MiniLoaderAll.bin</span><br><span class="line">[OHOS INFO] /home/prx/purple_pi/out/purple_pi_oh/packages/phone/images/vendor.img</span><br><span class="line">[OHOS INFO] /home/prx/purple_pi/out/purple_pi_oh/packages/phone/images/userdata.img</span><br><span class="line">[OHOS INFO] /home/prx/purple_pi/out/purple_pi_oh/packages/phone/images/updater.img</span><br><span class="line">[OHOS INFO] /home/prx/purple_pi/out/purple_pi_oh/packages/phone/images/ramdisk.img</span><br><span class="line">[OHOS INFO] /home/prx/purple_pi/out/purple_pi_oh/packages/phone/images/boot_linux.img</span><br><span class="line">[OHOS INFO] part_name: ability_base                                actual_size: 764.9KB                              This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: ability_runtime                             actual_size: 13897.7KB                            This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: ability_tools                               actual_size: 0.0KB       standard_size: 100KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: access_token                                actual_size: 1535.33KB   standard_size: 2048KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: accessibility                               actual_size: 2190.2KB    standard_size: 2000KB     <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: ace_engine                                  actual_size: 27453.55KB  standard_size: 25600KB    <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: app_file_service                            actual_size: 232.08KB                             This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: appspawn                                    actual_size: 0.0KB                                This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: appverify                                   actual_size: 269.24KB    standard_size: 5000kb     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: arkXtest                                    actual_size: 140.41KB    standard_size: 500KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: background_task_mgr                         actual_size: 1441.22KB   standard_size: 2048KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: battery_manager                             actual_size: 282.07KB    standard_size: 1024KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: battery_statistics                          actual_size: 493.85KB    standard_size: 1024KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: bluetooth                                   actual_size: 12462.18KB                           This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: bundle_framework                            actual_size: 7286.07KB   standard_size: 4000KB     <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: bundle_tool                                 actual_size: 0.0KB       standard_size: 100KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: bytrace                                     actual_size: 12.0KB      standard_size: 114KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: c_utils                                     actual_size: 393.28KB                             This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: call_manager                                actual_size: 1850.19KB   standard_size: 1.6MB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: cellular_call                               actual_size: 979.02KB    standard_size: 1MB        <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: cellular_data                               actual_size: 984.0KB     standard_size: 750KB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: certificate_manager                         actual_size: 483.34KB    standard_size: 5000KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: common_event_service                        actual_size: 1272.28KB   standard_size: 2000KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: config_policy                               actual_size: 40.08KB                              This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: contactsdata_hap                            actual_size: 1032.45KB   standard_size: 400KB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: core_service                                actual_size: 3394.81KB   standard_size: 2MB        <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: crypto_framework                            actual_size: 344.95KB    standard_size: 1024KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: data_object                                 actual_size: 398.48KB                             This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: data_share                                  actual_size: 815.59KB                             This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: data_storage                                actual_size: 287.17KB    standard_size: 200KB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: dataclassification                          actual_size: 15.12KB     standard_size: 50KB       <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: datamgr_service                             actual_size: 1373.26KB                            This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: device_attest                               actual_size: 326.7KB     standard_size: 3072KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: device_auth                                 actual_size: 252.36KB    standard_size: 500KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: device_info_manager                         actual_size: 548.73KB                             This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: device_manager                              actual_size: 1612.7KB    standard_size: 2M         <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: device_security_level                       actual_size: 233.55KB    standard_size: 200KB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: device_status                               actual_size: 383.68KB    standard_size: 2048KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: device_usage_statistics                     actual_size: 1251.04KB   standard_size: 11264KB    <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: dfs_service                                 actual_size: 284.46KB                             This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: dhcp                                        actual_size: 152.32KB                             This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: display_manager                             actual_size: 345.02KB    standard_size: 1024KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: distributed_bundle_framework                actual_size: 347.35KB    standard_size: 100KB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: distributed_camera                          actual_size: 1945.16KB   standard_size: 2000k      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: distributed_hardware_fwk                    actual_size: 939.23KB    standard_size: 128K       <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: distributed_notification_service            actual_size: 4303.98KB   standard_size: 3000KB     <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: distributed_screen                          actual_size: 1365.23KB   standard_size: 2000k      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: dmsfwk                                      actual_size: 1353.79KB                            This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_audio                     actual_size: 197.58KB    standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_battery                   actual_size: 229.92KB    standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_camera                    actual_size: 612.81KB    standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_display                   actual_size: 33.16KB     standard_size: 700KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_distributed_camera        actual_size: 266.91KB    standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_face_auth                 actual_size: 290.95KB    standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_fingerprint_auth          actual_size: 258.19KB    standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_input                     actual_size: 285.89KB    standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_light                     actual_size: 123.25KB    standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_location_agnss            actual_size: 190.64KB    standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_location_geofence         actual_size: 169.64KB    standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_location_gnss             actual_size: 243.84KB    standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_memorytracker             actual_size: 98.17KB     standard_size: 45KB       <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_motion                    actual_size: 165.3KB     standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_nnrt                      actual_size: 401.81KB    standard_size: 150KB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_partitionslot             actual_size: 102.67KB    standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_pin_auth                  actual_size: 252.08KB    standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_power                     actual_size: 169.39KB    standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_ril                       actual_size: 1483.74KB   standard_size: 700KB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_sensor                    actual_size: 202.06KB    standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_thermal                   actual_size: 177.31KB    standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_usb                       actual_size: 352.55KB    standard_size: 820KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_user_auth                 actual_size: 277.8KB     standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_vibrator                  actual_size: 139.14KB    standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_interface_wlan                      actual_size: 201.84KB    standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_audio                    actual_size: 961.45KB    standard_size: 1035KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_battery                  actual_size: 125.46KB    standard_size: 600KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_bluetooth                actual_size: 1153.03KB   standard_size: 615KB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_camera                   actual_size: 1507.98KB   standard_size: 2440KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_codec                    actual_size: 323.02KB    standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_display                  actual_size: 515.91KB    standard_size: 1260KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_distributed_camera       actual_size: 385.64KB    standard_size: 2440KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_face_auth                actual_size: 51.71KB     standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_fingerprint_auth         actual_size: 38.2KB      standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_input                    actual_size: 89.51KB     standard_size: 630KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_light                    actual_size: 35.51KB     standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_location_agnss           actual_size: 31.59KB     standard_size: 1000KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_location_geofence        actual_size: 23.3KB      standard_size: 1000KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_location_gnss            actual_size: 37.84KB     standard_size: 1000KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_memorytracker            actual_size: 22.39KB     standard_size: 45KB       <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_motion                   actual_size: 0.0KB       standard_size: 650KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_partitionslot            actual_size: 47.98KB     standard_size: 600KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_pin_auth                 actual_size: 113.54KB    standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_power                    actual_size: 34.16KB     standard_size: 981KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_ril                      actual_size: 79.0KB      standard_size: 700KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_sensor                   actual_size: 65.95KB     standard_size: 650KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_thermal                  actual_size: 257.56KB    standard_size: 610KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_usb                      actual_size: 444.95KB    standard_size: 820KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_user_auth                actual_size: 150.58KB    standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_vibrator                 actual_size: 36.34KB     standard_size: 675KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: drivers_peripheral_wlan                     actual_size: 107.41KB    standard_size: 660KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: dsoftbus                                    actual_size: 3506.18KB   standard_size: 967KB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: e2fsprogs                                   actual_size: 0.0KB                                This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: enterprise_device_management                actual_size: 690.0KB                              This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: ets_frontend                                actual_size: 0.0KB                                This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: ets_runtime                                 actual_size: 4130.89KB                            This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: ets_utils                                   actual_size: 1401.46KB                            This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: eventhandler                                actual_size: 154.43KB    standard_size: 500KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: face_auth                                   actual_size: 200.41KB    standard_size: 1000KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: faultloggerd                                actual_size: 790.48KB    standard_size: 1024KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: file_api                                    actual_size: 1667.67KB                            This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: form_fwk                                    actual_size: 2538.05KB                            This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: frame_aware_sched                           actual_size: 129.64KB    standard_size: 2048KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: graphic_chipsetsdk                          actual_size: 0.0KB       standard_size: 10000KB    <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: graphic_standard                            actual_size: 5881.1KB    standard_size: 10000KB    <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: hdc                                         actual_size: 0.0KB       standard_size: 1725KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: hdf_core                                    actual_size: 516.59KB    standard_size: 735KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: hiappevent_js                               actual_size: 146.8KB                              This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: hiappevent_native                           actual_size: 212.51KB                             This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: hichecker_js                                actual_size: 13.03KB                              This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: hichecker_native                            actual_size: 14.7KB                               This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: hicollie_native                             actual_size: 91.7KB                               This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: hidumper                                    actual_size: 582.15KB                             This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: hilog_native                                actual_size: 390.47KB    standard_size: 188KB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: hilog_service                               actual_size: 0.0KB       standard_size: 460KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: hiperf                                      actual_size: 72.52KB     standard_size: 188KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: hisysevent_native                           actual_size: 370.96KB                             This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: hitrace_native                              actual_size: 83.88KB                              This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: hiview                                      actual_size: 572.15KB                             This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: hiviewdfx_hilog_native                      actual_size: 0.0KB       standard_size: 188KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: huks                                        actual_size: 5808.09KB   standard_size: 5000KB     <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: i18n                                        actual_size: 658.3KB                              This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: idl_tool                                    actual_size: 0.0KB                                This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: imf                                         actual_size: 1184.45KB   standard_size: 300KB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: init                                        actual_size: 795.05KB                             This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: input                                       actual_size: 2810.78KB   standard_size: 5120KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: ipc                                         actual_size: 549.3KB     standard_size: 500KB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: ipc_js                                      actual_size: 260.93KB    standard_size: 500KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: kv_store                                    actual_size: 3332.33KB                            This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: location                                    actual_size: 1480.08KB                            This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: media_library                               actual_size: 5942.88KB   standard_size: 4068KB     <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: memmgr                                      actual_size: 655.31KB                             This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: memory_utils                                actual_size: 37.99KB                              This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: mindspore                                   actual_size: 8411.89KB                            This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: miscdevice                                  actual_size: 348.12KB    standard_size: 1024KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: multimedia_audio_framework                  actual_size: 3843.28KB                            This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: multimedia_av_session                       actual_size: 1598.09KB   standard_size: 10000KB    <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: multimedia_camera_framework                 actual_size: 1366.98KB                            This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: multimedia_histreamer                       actual_size: 6207.17KB   standard_size: 622KB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: multimedia_image_framework                  actual_size: 1624.58KB   standard_size: 10000KB    <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: multimedia_player_framework                 actual_size: 10177.52KB  standard_size: 10000KB    <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: musl                                        actual_size: 0.0KB                                This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: napi                                        actual_size: 395.83KB    standard_size: 5120KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: netmanager_base                             actual_size: 2512.23KB   standard_size: 4.5MB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: netmanager_ext                              actual_size: 1407.76KB   standard_size: 250KB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: netstack                                    actual_size: 2643.96KB   standard_size: 3MB        <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: neural_network_runtime                      actual_size: 859.22KB    standard_size: 1024KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: os_account                                  actual_size: 3441.46KB   standard_size: 4096KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: packing_tool                                actual_size: 0.0KB                                This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: pasteboard                                  actual_size: 798.46KB    standard_size: 300KB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: pin_auth                                    actual_size: 253.69KB    standard_size: 6200KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: power_manager                               actual_size: 823.9KB     standard_size: 1024KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: preferences                                 actual_size: 366.2KB                              This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: profiler                                    actual_size: 9637.76KB   standard_size: 188KB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: relational_store                            actual_size: 1281.89KB                            This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: request                                     actual_size: 898.32KB    standard_size: 300KB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: resource_management                         actual_size: 473.38KB                             This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: resource_schedule_service                   actual_size: 818.27KB    standard_size: 2048KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: ril_adapter                                 actual_size: 504.68KB    standard_size: 700KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: runtime_core                                actual_size: 0.0KB                                This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: safwk                                       actual_size: 106.82KB    standard_size: 200KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: samgr                                       actual_size: 149.15KB    standard_size: 300KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: screenlock_mgr                              actual_size: 275.01KB    standard_size: 300KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: selinux                                     actual_size: 2646.7KB    standard_size: 3072KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: sensor                                      actual_size: 541.17KB    standard_size: 2048KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: settings_standard                           actual_size: 125.82KB                             This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: sms_mms                                     actual_size: 1685.71KB   standard_size: 1.2MB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: soc_perf                                    actual_size: 200.24KB    standard_size: 2048KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: start                                       actual_size: 0.0KB                                This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: startup_l2                                  actual_size: 265.9KB                              This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: state_registry                              actual_size: 402.78KB    standard_size: 550KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: storage_service                             actual_size: 674.0KB                              This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: sys_installer                               actual_size: 4898.25KB                            This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: syscap_codec                                actual_size: 357.88KB                             This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: systemres                                   actual_size: 0.0KB                                This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: thermal_manager                             actual_size: 872.7KB     standard_size: 1024KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: time_service                                actual_size: 700.05KB    standard_size: 300KB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: timezone                                    actual_size: 0.0KB                                This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: toolchain                                   actual_size: 475.41KB                             This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: update_service                              actual_size: 4149.41KB                            This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: updater                                     actual_size: 3247.2KB                             This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: usb_manager                                 actual_size: 652.83KB    standard_size: 128k       <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: user_auth_framework                         actual_size: 1209.93KB   standard_size: 3924KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: user_file_service                           actual_size: 726.37KB                             This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: wallpaper_mgr                               actual_size: 693.02KB    standard_size: 60MB       <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: webview                                     actual_size: 552.48KB    standard_size: ~85MB      <span class="string">&#x27;rom&#x27;</span> out of standard</span><br><span class="line">[OHOS INFO] part_name: wifi                                        actual_size: 4140.77KB                            This part does not <span class="built_in">set</span> standard <span class="string">&#x27;rom&#x27;</span> size</span><br><span class="line">[OHOS INFO] part_name: window_manager                              actual_size: 4111.8KB    standard_size: 8000KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: work_scheduler                              actual_size: 834.32KB    standard_size: 2048KB     <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] part_name: wukong                                      actual_size: 0.0KB       standard_size: 100KB      <span class="string">&#x27;rom&#x27;</span> conform to the rules</span><br><span class="line">[OHOS INFO] ---------------------------------------------</span><br><span class="line">[OHOS INFO] ccache summary:</span><br><span class="line">[OHOS INFO] cache hit (direct)  : 0</span><br><span class="line">[OHOS INFO] cache hit (preprocessed)  : 0</span><br><span class="line">[OHOS INFO] cache miss  : 0</span><br><span class="line">[OHOS INFO] hit rate:  0.00% </span><br><span class="line">[OHOS INFO] mis rate: 0.00% </span><br><span class="line">[OHOS INFO] ---------------------------------------------</span><br><span class="line">[OHOS INFO] c targets overlap rate statistics</span><br><span class="line">[OHOS INFO] subsystem           files NO.       percentage      builds NO.      percentage      overlap rate</span><br><span class="line">[OHOS INFO] securec                  117        0.5%         195        0.8%    1.67</span><br><span class="line">[OHOS INFO] arkcompiler              826        3.6%        1220        4.9%    1.48</span><br><span class="line">[OHOS INFO] third_party             8122        35.6%       9905        39.5%   1.22</span><br><span class="line">[OHOS INFO] thirdparty              8122        35.6%       9905        39.5%   1.22</span><br><span class="line">[OHOS INFO] developtools             361        1.6%         417        1.7%    1.16</span><br><span class="line">[OHOS INFO] updater                  183        0.8%         204        0.8%    1.11</span><br><span class="line">[OHOS INFO] aafwk                    709        3.1%         709        2.8%    1.00</span><br><span class="line">[OHOS INFO] ability                  709        3.1%         709        2.8%    1.00</span><br><span class="line">[OHOS INFO] account                  150        0.7%         150        0.6%    1.00</span><br><span class="line">[OHOS INFO] ai                        72        0.3%          72        0.3%    1.00</span><br><span class="line">[OHOS INFO] applications              44        0.2%          44        0.2%    1.00</span><br><span class="line">[OHOS INFO] arkXtest                  22        0.1%          22        0.1%    1.00</span><br><span class="line">[OHOS INFO] arkui                   2284        10.0%       2284        9.1%    1.00</span><br><span class="line">[OHOS INFO] barrierfree               84        0.4%          84        0.3%    1.00</span><br><span class="line">[OHOS INFO] bundlemanager            259        1.1%         259        1.0%    1.00</span><br><span class="line">[OHOS INFO] commonlibrary            141        0.6%         141        0.6%    1.00</span><br><span class="line">[OHOS INFO] communication           1591        7.0%        1591        6.3%    1.00</span><br><span class="line">[OHOS INFO] customization             56        0.2%          56        0.2%    1.00</span><br><span class="line">[OHOS INFO] deviceprofile             40        0.2%          40        0.2%    1.00</span><br><span class="line">[OHOS INFO] distributeddatamgr       596        2.6%         596        2.4%    1.00</span><br><span class="line">[OHOS INFO] distributedhardware      257        1.1%         257        1.0%    1.00</span><br><span class="line">[OHOS INFO] filemanagement           260        1.1%         260        1.0%    1.00</span><br><span class="line">[OHOS INFO] global                    39        0.2%          39        0.2%    1.00</span><br><span class="line">[OHOS INFO] graphic                  494        2.2%         494        2.0%    1.00</span><br><span class="line">[OHOS INFO] hdf                      793        3.5%         793        3.2%    1.00</span><br><span class="line">[OHOS INFO] hiviewdfx                418        1.8%         418        1.7%    1.00</span><br><span class="line">[OHOS INFO] inputmethod               70        0.3%          70        0.3%    1.00</span><br><span class="line">[OHOS INFO] location                  64        0.3%          64        0.3%    1.00</span><br><span class="line">[OHOS INFO] msdp                      20        0.1%          20        0.1%    1.00</span><br><span class="line">[OHOS INFO] multimedia               717        3.1%         717        2.9%    1.00</span><br><span class="line">[OHOS INFO] multimodalinput          107        0.5%         107        0.4%    1.00</span><br><span class="line">[OHOS INFO] notification             216        0.9%         216        0.9%    1.00</span><br><span class="line">[OHOS INFO] powermgr                 180        0.8%         180        0.7%    1.00</span><br><span class="line">[OHOS INFO] request                   52        0.2%          52        0.2%    1.00</span><br><span class="line">[OHOS INFO] resourceschedule         255        1.1%         255        1.0%    1.00</span><br><span class="line">[OHOS INFO] security                 562        2.5%         562        2.2%    1.00</span><br><span class="line">[OHOS INFO] sensors                   60        0.3%          60        0.2%    1.00</span><br><span class="line">[OHOS INFO] startup                  187        0.8%         187        0.7%    1.00</span><br><span class="line">[OHOS INFO] systemabilitymgr          22        0.1%          22        0.1%    1.00</span><br><span class="line">[OHOS INFO] telephony                395        1.7%         395        1.6%    1.00</span><br><span class="line">[OHOS INFO] <span class="built_in">test</span>                      99        0.4%          99        0.4%    1.00</span><br><span class="line">[OHOS INFO] theme                     56        0.2%          56        0.2%    1.00</span><br><span class="line">[OHOS INFO] <span class="keyword">time</span>                      42        0.2%          42        0.2%    1.00</span><br><span class="line">[OHOS INFO] usb                       28        0.1%          28        0.1%    1.00</span><br><span class="line">[OHOS INFO] useriam                  109        0.5%         109        0.4%    1.00</span><br><span class="line">[OHOS INFO] web                       42        0.2%          42        0.2%    1.00</span><br><span class="line">[OHOS INFO] window                   136        0.6%         136        0.5%    1.00</span><br><span class="line">[OHOS INFO] wpa_supplicant-2.9       175        0.8%         175        0.7%    1.00</span><br><span class="line">[OHOS INFO] wukong                    43        0.2%          43        0.2%    1.00</span><br><span class="line">[OHOS INFO] xts                       34        0.1%          34        0.1%    1.00</span><br><span class="line">[OHOS INFO] </span><br><span class="line">[OHOS INFO] c overall build overlap rate: 1.10</span><br><span class="line">[OHOS INFO] </span><br><span class="line">[OHOS INFO] </span><br><span class="line">[OHOS INFO] purple_pi_oh build success</span><br><span class="line">[OHOS INFO] cost <span class="keyword">time</span>: 0:08:40</span><br><span class="line">=====build  successful=====</span><br><span class="line">2023-06-18 09:15:00</span><br><span class="line">++++++++++++++++++++++++++++++++++++++++</span><br></pre></td></tr></table></figure>



<h3 id="第二种方法："><a href="#第二种方法：" class="headerlink" title="第二种方法："></a>第二种方法：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mkboot.sh HDMI</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/05/31/killer-blog/OpenHarmony/purple_pi_build/" data-id="cmbcy7rhp002qt8mt9u3tg41i" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/11/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><a class="page-number" href="/page/14/">14</a><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/13/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">June 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">May 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/pwm/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/uart/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/worklife/2025%E6%B1%82%E8%81%8C%E5%87%86%E5%A4%87/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/other/tools/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/i2c_LSM303AGR/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>