<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-killer-blog/cJSON/2.create_json" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/06/01/killer-blog/cJSON/2.create_json/" class="article-date">
  <time class="dt-published" datetime="2025-06-01T00:24:26.651Z" itemprop="datePublished">2025-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>@[toc]</p>
<blockquote>
<p>cJSON系列：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44821644/article/details/110395913">零基础学习cJSON 源码详解与应用（一）如何学习cJSON</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44821644/article/details/110406265">零基础学习cJSON 源码详解与应用（二）创建json数据</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44821644/article/details/110475966">零基础学习cJSON 源码详解与应用 （三）cJSON_Print()；打印json
</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44821644/article/details/110481533">零基础学习cJSON 源码详解与应用 （四）cJSON_Parse()；解析json字符串</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44821644/article/details/110499109">零基础学习cJSON 源码详解与应用 （五）修改，复制，比较cjson</a></li>
</ul>
</blockquote>
<blockquote>
<p>上一篇我们已经介绍了cjson结构体 <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44821644/article/details/110395913">（一）如何学习cJSON</a>，这节就介绍简单的创建json数据并分析源码。</p>
</blockquote>
<h2 id="一，创建一个简单的json"><a href="#一，创建一个简单的json" class="headerlink" title="一，创建一个简单的json"></a>一，创建一个简单的json</h2><p>例如创建一个如下的json：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;years&quot;</span>: <span class="number">22</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;fool&quot;</span>,</span><br><span class="line">    <span class="string">&quot;man&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;adult&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;money&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;season&quot;</span>: [<span class="string">&quot;spring&quot;</span>, <span class="string">&quot;summer&quot;</span>, <span class="string">&quot;fall&quot;</span>,<span class="string">&quot;winter&quot;</span>],</span><br><span class="line">    <span class="string">&quot;child&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;girlfriend&quot;</span>: <span class="string">&quot;june&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>首先分析这个json，确定它的所有item类型，其中比较需要注意的是child这个item是一个嵌套子json，所以它的类型应该是object</strong>，从item的类型入手，先创建所有的item，再把item添加到root节点上。代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *str_arry[<span class="number">3</span>] = </span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;spring&quot;</span>,</span><br><span class="line">    <span class="string">&quot;summer&quot;</span>,</span><br><span class="line">    <span class="string">&quot;fall&quot;</span>,</span><br><span class="line">    <span class="string">&quot;winter&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//创建不同类型的item</span></span><br><span class="line">cJSON *root = cJSON_CreateObject();</span><br><span class="line">cJSON *years = cJSON_CreateNumber(<span class="number">22</span>);</span><br><span class="line">cJSON *name = cJSON_CreateString(<span class="string">&quot;fool&quot;</span>);</span><br><span class="line">cJSON *man = cJSON_CreateTrue();</span><br><span class="line">cJSON *adult = cJSON_CreateFalse();</span><br><span class="line">cJSON *money = cJSON_CreateNull();</span><br><span class="line">cJSON *season = cJSON_CreateStringArray(str_arry, <span class="number">3</span>);</span><br><span class="line">cJSON *child = cJSON_CreateObject();</span><br><span class="line">cJSON *girlfriend = cJSON_CreateString(<span class="string">&quot;june&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//将item添加到父节点下</span></span><br><span class="line">cJSON_AddItemToObject(root, <span class="string">&quot;years&quot;</span>, years);</span><br><span class="line">cJSON_AddItemToObject(root, <span class="string">&quot;name&quot;</span>, name);</span><br><span class="line">cJSON_AddItemToObject(root, <span class="string">&quot;man&quot;</span>, man);</span><br><span class="line">cJSON_AddItemToObject(root, <span class="string">&quot;adult&quot;</span>, adult);</span><br><span class="line">cJSON_AddItemToObject(root, <span class="string">&quot;money&quot;</span>, money);</span><br><span class="line">cJSON_AddItemToObject(root, <span class="string">&quot;season&quot;</span>, season);</span><br><span class="line">cJSON_AddItemToObject(child, <span class="string">&quot;girlfriend&quot;</span>, girlfriend);</span><br><span class="line">cJSON_AddItemToObject(root, <span class="string">&quot;child&quot;</span>, child);</span><br><span class="line"></span><br><span class="line"><span class="comment">//将所有json结构体输出成字符串</span></span><br><span class="line"><span class="type">char</span> *json=cJSON_Print(root);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,json);</span><br><span class="line"></span><br><span class="line"><span class="comment">//! 一定要记得用完擦屁股</span></span><br><span class="line">cJSON_Delete(root);</span><br></pre></td></tr></table></figure>
<p>这里需要注意的是由于cjson是使用动态内存分配的，当cjson用完后，<code>切记！切记！切记！一定用要用cJSON_Delete释放内存</code>。</p>
<p>打印结果如下：</p>
<p><img src="/2025/05/30/hello-world/cJSON/2.create_json/5.png" alt="在这里插入图片描述"></p>
<h2 id="二，源码详解"><a href="#二，源码详解" class="headerlink" title="二，源码详解"></a>二，源码详解</h2><blockquote>
<p>1, CJSON_PUBLIC(cJSON *) cJSON_CreateObject(void);</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建一个空的json，赋予obj类型</span></span><br><span class="line">CJSON_PUBLIC(cJSON *) cJSON_CreateObject(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    cJSON *item = cJSON_New_Item(&amp;global_hooks);</span><br><span class="line">    <span class="keyword">if</span> (item)</span><br><span class="line">    &#123;</span><br><span class="line">        item-&gt;type = cJSON_Object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数调用的是cJSON_New_Item()，传入参数&amp;global_hooks是全局变量，该变量是有三个函数指针分别指向<code>free(),malloc(),realloc()</code>，用来操作内存的。<br>cJSON_New_Item()以动态内存分配的形式，申请了一块内存并将内存初始化。返回指向该内存的指针。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//动态内存分配一个cjson并设为0</span></span><br><span class="line"><span class="type">static</span> cJSON *<span class="title function_">cJSON_New_Item</span><span class="params">(<span class="type">const</span> internal_hooks * <span class="type">const</span> hooks)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    cJSON* node = (cJSON*)hooks-&gt;allocate(<span class="keyword">sizeof</span>(cJSON));</span><br><span class="line">    <span class="keyword">if</span> (node)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(node, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(cJSON));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>2, CJSON_PUBLIC(cJSON *) cJSON_CreateString(const char *string);</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建字符串值为string的json，string值可被cjson_delete删除</span></span><br><span class="line">CJSON_PUBLIC(cJSON *) cJSON_CreateString(<span class="type">const</span> <span class="type">char</span> *<span class="built_in">string</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//创建空cjson</span></span><br><span class="line">    cJSON *item = cJSON_New_Item(&amp;global_hooks);</span><br><span class="line">    <span class="keyword">if</span>(item)</span><br><span class="line">    &#123;</span><br><span class="line">        item-&gt;type = cJSON_String;</span><br><span class="line">        <span class="comment">//将string内容复制给valuestring</span></span><br><span class="line">        item-&gt;valuestring = (<span class="type">char</span>*)cJSON_strdup((<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>*)<span class="built_in">string</span>, &amp;global_hooks);</span><br><span class="line">        <span class="keyword">if</span>(!item-&gt;valuestring)</span><br><span class="line">        &#123;</span><br><span class="line">            cJSON_Delete(item);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>cJSON_strdup()也是后续会经常使用的函数，作用是复制字符串。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//开辟一块新内存，并将string复制到内存中，并返回指向内存的指针</span></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span>* <span class="title function_">cJSON_strdup</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* <span class="built_in">string</span>, <span class="type">const</span> internal_hooks * <span class="type">const</span> hooks)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> length = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *copy = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">string</span> == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//计算所需内存的长度</span></span><br><span class="line">    length = <span class="built_in">strlen</span>((<span class="type">const</span> <span class="type">char</span>*)<span class="built_in">string</span>) + <span class="keyword">sizeof</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="comment">//申请内存</span></span><br><span class="line">    copy = (<span class="type">unsigned</span> <span class="type">char</span>*)hooks-&gt;allocate(length);</span><br><span class="line">    <span class="keyword">if</span> (copy == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(copy, <span class="built_in">string</span>, length);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> copy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>3，CJSON_PUBLIC(cJSON *) cJSON_CreateStringArray(const char **strings, int count);</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 创建字符串型数组的json</span></span><br><span class="line"><span class="comment"> * strings：字符串数组</span></span><br><span class="line"><span class="comment"> * count：数组长度</span></span><br><span class="line"><span class="comment"> * 返回：数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CJSON_PUBLIC(cJSON *) cJSON_CreateStringArray(<span class="type">const</span> <span class="type">char</span> **strings, <span class="type">int</span> count)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> i = <span class="number">0</span>;</span><br><span class="line">    cJSON *n = <span class="literal">NULL</span>;    <span class="comment">//next</span></span><br><span class="line">    cJSON *p = <span class="literal">NULL</span>;    <span class="comment">//prev</span></span><br><span class="line">    cJSON *a = <span class="literal">NULL</span>;    <span class="comment">//arry</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((count &lt; <span class="number">0</span>) || (strings == <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建数组</span></span><br><span class="line">    a = cJSON_CreateArray();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; a &amp;&amp; (i &lt; (<span class="type">size_t</span>)count); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//创建string类型cjson</span></span><br><span class="line">        n = cJSON_CreateString(strings[i]);</span><br><span class="line">        <span class="keyword">if</span>(!n)</span><br><span class="line">        &#123;</span><br><span class="line">            cJSON_Delete(a);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!i)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//如果是数组第一个，则将n复制给数组cjson的子节点</span></span><br><span class="line">            a-&gt;child = n;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//将n插入p之后（链表操作）</span></span><br><span class="line">            suffix_object(p,n);</span><br><span class="line">        &#125;</span><br><span class="line">        p = n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>4，CJSON_PUBLIC(void) cJSON_AddItemToObject(cJSON *object, const char *string, cJSON *item);</p>
<p>cJSON_AddItemToObject()是调用了<code>add_item_to_object()</code></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 将item以键string添加到obj下</span></span><br><span class="line"><span class="comment"> * note：item可以是任何类型的cjson</span></span><br><span class="line"><span class="comment"> * constant_key:指示string是否是外部定义的常量数据</span></span><br><span class="line"><span class="comment"> * 成功：返回 true</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> cJSON_bool <span class="title function_">add_item_to_object</span><span class="params">(cJSON * <span class="type">const</span> object, <span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> <span class="built_in">string</span>, cJSON * <span class="type">const</span> item, <span class="type">const</span> internal_hooks * <span class="type">const</span> hooks, <span class="type">const</span> cJSON_bool constant_key)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *new_key = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> new_type = cJSON_Invalid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((object == <span class="literal">NULL</span>) || (<span class="built_in">string</span> == <span class="literal">NULL</span>) || (item == <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断key是否是常量数据，若是则不需要重新复制字符串</span></span><br><span class="line">    <span class="keyword">if</span> (constant_key)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//直接取指针，cjson_delete不会删除key</span></span><br><span class="line">        new_key = (<span class="type">char</span>*)cast_away_const(<span class="built_in">string</span>);</span><br><span class="line">        <span class="comment">//cjson类型设置为常量字符串</span></span><br><span class="line">        new_type = item-&gt;type | cJSON_StringIsConst;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//复制string</span></span><br><span class="line">        new_key = (<span class="type">char</span>*)cJSON_strdup((<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>*)<span class="built_in">string</span>, hooks);</span><br><span class="line">        <span class="keyword">if</span> (new_key == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//修改cjson类型</span></span><br><span class="line">        new_type = item-&gt;type &amp; ~cJSON_StringIsConst;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(item-&gt;type &amp; cJSON_StringIsConst) &amp;&amp; (item-&gt;<span class="built_in">string</span> != <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//如果string是常量且不为空则释放内存</span></span><br><span class="line">        hooks-&gt;deallocate(item-&gt;<span class="built_in">string</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//将key赋值给cjson的键</span></span><br><span class="line">    item-&gt;<span class="built_in">string</span> = new_key;</span><br><span class="line">    item-&gt;type = new_type;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//最后把item添加到obj</span></span><br><span class="line">    <span class="keyword">return</span> add_item_to_array(object, item);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在最后调用了add_item_to_array();</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 添加item到数组最后</span></span><br><span class="line"><span class="comment"> * 成功返回 true</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> cJSON_bool <span class="title function_">add_item_to_array</span><span class="params">(cJSON *<span class="built_in">array</span>, cJSON *item)</span></span><br><span class="line">&#123;</span><br><span class="line">    cJSON *child = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((item == <span class="literal">NULL</span>) || (<span class="built_in">array</span> == <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//child是数组的第一个成员</span></span><br><span class="line">    child = <span class="built_in">array</span>-&gt;child;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果数组为空，则item赋予第一个成员child</span></span><br><span class="line">    <span class="keyword">if</span> (child == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* list is empty, start new one */</span></span><br><span class="line">        <span class="built_in">array</span>-&gt;child = item;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* append to the end */</span></span><br><span class="line">        <span class="comment">//遍历数组，并在数组最后插入item</span></span><br><span class="line">        <span class="keyword">while</span> (child-&gt;next)</span><br><span class="line">        &#123;</span><br><span class="line">            child = child-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        suffix_object(child, item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<blockquote>
<p>5，CJSON_PUBLIC(void) cJSON_Delete(cJSON *c);</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 将item所在链表的及其子节点的所有cjson释放</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CJSON_PUBLIC(<span class="type">void</span>) cJSON_Delete(cJSON *item)</span><br><span class="line">&#123;</span><br><span class="line">    cJSON *next = <span class="literal">NULL</span>; <span class="comment">//指向当前cjson的下一个</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (item != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//由json结构体的定义可知，json结构体自身，string和valuestring是由动态内存分配获得，需要释放这三部分内存</span></span><br><span class="line">        next = item-&gt;next;</span><br><span class="line">        <span class="comment">//如果cjson不是参考外部数据且不为空，则递归调用delete，删除cjson的子节点</span></span><br><span class="line">        <span class="keyword">if</span> (!(item-&gt;type &amp; cJSON_IsReference) &amp;&amp; (item-&gt;child != <span class="literal">NULL</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//释放嵌套的json结构体</span></span><br><span class="line">            cJSON_Delete(item-&gt;child);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果cjson不是参考外部数据，则valuestring以及string是由cJSON动态内存分配的，需要释放内存</span></span><br><span class="line">        <span class="keyword">if</span> (!(item-&gt;type &amp; cJSON_IsReference) &amp;&amp; (item-&gt;valuestring != <span class="literal">NULL</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            global_hooks.deallocate(item-&gt;valuestring);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!(item-&gt;type &amp; cJSON_StringIsConst) &amp;&amp; (item-&gt;<span class="built_in">string</span> != <span class="literal">NULL</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            global_hooks.deallocate(item-&gt;<span class="built_in">string</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//释放当前的cjson</span></span><br><span class="line">        global_hooks.deallocate(item);</span><br><span class="line">        <span class="comment">//准备释放链表中的下一个cjson</span></span><br><span class="line">        item = next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>deallocate();可类比free();<br><strong>这里需要注意的是释放内存时，要判断cjson结构体的string,valuesstring是否是常量。</strong></p>
<p><strong>当string,valuesstring是动态内存分配时，才能使用deallocate()释放，否则可能出现内存错误。具体原因见下一节</strong></p>
<h2 id="三-注意-const，reference"><a href="#三-注意-const，reference" class="headerlink" title="三 注意 const，reference"></a>三 注意 const，reference</h2><p>上面的代码中你会发现有些函数中会出现<code>const</code>,<code>reference</code>，<strong>这是cjson允许使用外部定义的变量来作为cjson结构体的成员。这种情况下的字符串需要用const修饰，结构体用reference修饰。</strong></p>
<p>以<code>cJSON_CreateString()</code>为例，在为<code>valuestring</code>赋值时，使用的是动态内存分配的形式申请一块内存，传入参数string复制到内存，在这之后，参数string如何变化对该item的valuestring是没有影响的。</p>
<p>作为对比，以<code>cJSON_CreateStringReference()</code>为例：<br>在这个函数中，系统不为<code>valuestring</code>分配内存，而只是把它指向<code>string</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 创建一个string类型的item，其valuestring指向传入参数string，外部定义的string发生变化会影响item的valuestring</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CJSON_PUBLIC(cJSON *) cJSON_CreateStringReference(<span class="type">const</span> <span class="type">char</span> *<span class="built_in">string</span>)</span><br><span class="line">&#123;</span><br><span class="line">    cJSON *item = cJSON_New_Item(&amp;global_hooks);</span><br><span class="line">    <span class="keyword">if</span> (item != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        item-&gt;type = cJSON_String | cJSON_IsReference;</span><br><span class="line">        item-&gt;valuestring = (<span class="type">char</span>*)cast_away_const(<span class="built_in">string</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>这么做的目的一个方面是可以节约内存，但在使用时需注意参考变量的值不要轻易修改，其他reference类的函数一样，只是参考的变量不同。</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CJSON_PUBLIC(cJSON *) cJSON_CreateObjectReference(<span class="type">const</span> cJSON *child);</span><br><span class="line"></span><br><span class="line">CJSON_PUBLIC(cJSON *) cJSON_CreateArrayReference(<span class="type">const</span> cJSON *child);</span><br><span class="line"></span><br><span class="line">CJSON_PUBLIC(<span class="type">void</span>) cJSON_AddItemToObjectCS(cJSON *object, <span class="type">const</span> <span class="type">char</span> *<span class="built_in">string</span>, cJSON *item);</span><br><span class="line">CJSON_PUBLIC(<span class="type">void</span>) cJSON_AddItemReferenceToArray(cJSON *<span class="built_in">array</span>, cJSON *item);</span><br><span class="line">CJSON_PUBLIC(<span class="type">void</span>) cJSON_AddItemReferenceToObject(cJSON *object, <span class="type">const</span> <span class="type">char</span> *<span class="built_in">string</span>, cJSON *item);</span><br></pre></td></tr></table></figure>
<p><strong>由此造成：当删除一个item时，需要判断其指针是否是外部定义的变量，以此来决定是否使用内存释放函数。</strong></p>
<h2 id="四-更简单的创建cjson"><a href="#四-更简单的创建cjson" class="headerlink" title="四 更简单的创建cjson"></a>四 更简单的创建cjson</h2><p>当你熟悉了cjson对json的创建思路后，可用以下更加快的方式创建cjson：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cJSON_AddNullToObject(root, <span class="string">&quot;money&quot;</span>);</span><br><span class="line">cJSON_AddTrueToObject(root, <span class="string">&quot;man&quot;</span>);</span><br><span class="line">cJSON_AddFalseToObject(root, <span class="string">&quot;adult&quot;</span>);</span><br><span class="line">cJSON_AddNumberToObject(root, <span class="string">&quot;years&quot;</span>, <span class="number">22</span>);</span><br><span class="line">cJSON_AddStringToObject(root, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;fool&quot;</span>);</span><br><span class="line"></span><br><span class="line">cJSON *season = cJSON_CreateStringArray(str_arry, <span class="number">3</span>);</span><br><span class="line">cJSON_AddItemToObject(root, <span class="string">&quot;season&quot;</span>, season);</span><br><span class="line"></span><br><span class="line">cJSON *child = cJSON_AddObjectToObject(root, <span class="string">&quot;child&quot;</span>);</span><br><span class="line">cJSON_AddStringToObject(child, <span class="string">&quot;girlfriend&quot;</span>, <span class="string">&quot;june&quot;</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>CJSON_PUBLIC(cJSON*) cJSON_AddStringToObject(cJSON * const object, const char * const name, const char * const string);</p>
</blockquote>
<p>可见这个函数本质上是调用了前面提到的<code>cJSON_CreateString();</code>与<code>add_item_to_object();</code>就是两步并作一步走。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 添加string类型cjson到obj</span></span><br><span class="line"><span class="comment"> * name ：键</span></span><br><span class="line"><span class="comment"> * string：值</span></span><br><span class="line"><span class="comment"> * 成功返回：string类cjson</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CJSON_PUBLIC(cJSON*) cJSON_AddStringToObject(cJSON * <span class="type">const</span> object, <span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> name, <span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> <span class="built_in">string</span>)</span><br><span class="line">&#123;</span><br><span class="line">    cJSON *string_item = cJSON_CreateString(<span class="built_in">string</span>);</span><br><span class="line">    <span class="keyword">if</span> (add_item_to_object(object, name, string_item, &amp;global_hooks, <span class="literal">false</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> string_item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cJSON_Delete(string_item);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>熟悉完json的创建，对json与cjson结构体的对应关系有了更深的掌握，下一章将解析cJSON_Print();输出json。<br><img src="/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDgyMTY0NA==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/06/01/killer-blog/cJSON/2.create_json/" data-id="cmbcy7rhr002vt8mte3ptajhk" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-killer-blog/cJSON/1.how_to_study_cjson" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/06/01/killer-blog/cJSON/1.how_to_study_cjson/" class="article-date">
  <time class="dt-published" datetime="2025-06-01T00:24:26.651Z" itemprop="datePublished">2025-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>@[toc]</p>
<blockquote>
<p>cJSON系列：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44821644/article/details/110395913">零基础学习cJSON 源码详解与应用（一）如何学习cJSON</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44821644/article/details/110406265">零基础学习cJSON 源码详解与应用（二）创建json数据</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44821644/article/details/110475966">零基础学习cJSON 源码详解与应用 （三）cJSON_Print()；打印json
</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44821644/article/details/110481533">零基础学习cJSON 源码详解与应用 （四）cJSON_Parse()；解析json字符串</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44821644/article/details/110499109">零基础学习cJSON 源码详解与应用 （五）修改，复制，比较cjson</a></li>
</ul>
</blockquote>
<h2 id="一，什么是json"><a href="#一，什么是json" class="headerlink" title="一，什么是json"></a>一，什么是json</h2><p><strong>JSON(JavaScript Object Notation) 是一种轻量级的数据交换格式。 易于人阅读和编写。同时也易于机器解析和生成。</strong><br>在程序之间进行数据交换过程中，特别是在互联网的轻量数据通信中json格式数据广泛应用。<br>以下是一个简单的json数据的例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;years&quot;</span>: <span class="number">22</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;fool&quot;</span>,</span><br><span class="line">    <span class="string">&quot;man&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;adult&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;season&quot;</span>: [<span class="string">&quot;spring&quot;</span>, <span class="string">&quot;summer&quot;</span>, <span class="string">&quot;fall&quot;</span>,<span class="string">&quot;winter&quot;</span>],</span><br><span class="line">    <span class="string">&quot;money&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;child&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;girlfriend&quot;</span>: <span class="string">&quot;june&quot;</span>,</span><br><span class="line">        <span class="string">&quot;boyfriend&quot;</span> : null</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>上述例子表明json是以“键-值”对的形式保存数据，每一个键值对可以称为一个item，一个json类型的数据可以有多个item，item数据类型包括：整型，字符串，布尔值，null，数组，以及json。</strong></p>
<blockquote>
<p>冒号左边的字符串是键，右边则是值。键必须是字符串，而值可有多种数据类型。在读取，写入，修改，删除数据时，都是根据键来对值进行操作。</p>
</blockquote>
<h2 id="二，应用场景示例"><a href="#二，应用场景示例" class="headerlink" title="二，应用场景示例"></a>二，应用场景示例</h2><p>当需要从互联网获取天气数据时，可向<a target="_blank" rel="noopener" href="https://www.showapi.com/apiGateway/view/9/4">查询天气接口</a>发起请求，注意它的返回数据格式就是json<br><img src="/2025/05/30/hello-world/cJSON/1.how_to_study_cjson/1.png" alt="在这里插入图片描述"><br>点击进入API测试工具，点击模拟调用接口，右侧的窗口就会返回以json格式的天气数据。<br><img src="/2025/05/30/hello-world/cJSON/1.how_to_study_cjson/2.png" alt="在这里插入图片描述"></p>
<h2 id="三，学习cjson的关键"><a href="#三，学习cjson的关键" class="headerlink" title="三，学习cjson的关键"></a>三，学习cjson的关键</h2><p>cjson就是用来处理json格式数据的一个库。cjson是使用c语言编写的，它十分轻量级，可用在内存有限的嵌入式设备中，来处理与互联网的交互数据。</p>
<p>cjson的github地址：<a target="_blank" rel="noopener" href="https://github.com/DaveGamble/cJSON">https://github.com/DaveGamble/cJSON</a>；cjson的代码主要在<code>cJSON.c</code>和<code>cJSON_Utils.c</code>这两个文件中，其中最主要功能的是由<code>cJSON.c</code>实现。</p>
<p>它实现了对json数据的基本操作，如：生成json数据，解析json数据，对json的增删改读等。</p>
<p><strong>因为json的所有操作都是以cjson结构体为对象的，所以学习cjson的关键在于掌握cjson结构体与json格式数据的对应关系，理解了这一点，对于源码的逻辑就会有更加清晰的认识。</strong></p>
<p>cjson结构体的定义以及类型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* cJSON Types: */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> cJSON_Invalid (0)   <span class="comment">//非法类型</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> cJSON_False  (1 &lt;&lt; 0) </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> cJSON_True   (1 &lt;&lt; 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> cJSON_NULL   (1 &lt;&lt; 2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> cJSON_Number (1 &lt;&lt; 3)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> cJSON_String (1 &lt;&lt; 4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> cJSON_Array  (1 &lt;&lt; 5) <span class="comment">//数组类型</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> cJSON_Object (1 &lt;&lt; 6) <span class="comment">//json类型</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> cJSON_Raw    (1 &lt;&lt; 7) <span class="comment">/* raw json */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> cJSON_IsReference 256 <span class="comment">//cjson是否参考外部另一个cjson</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> cJSON_StringIsConst 512 <span class="comment">//字符串是否是常量</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* The cJSON structure: */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">cJSON</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cJSON</span> *<span class="title">next</span>;</span>		<span class="comment">//链表中的下一个cjson</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cJSON</span> *<span class="title">prev</span>;</span>		<span class="comment">//链表中的上一个cjson</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cJSON</span> *<span class="title">child</span>;</span>  <span class="comment">//指向下一层的cjson(object或数组)</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> type;   <span class="comment">//json类型</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *valuestring;  <span class="comment">//存放字符串</span></span><br><span class="line">    <span class="type">int</span> valueint;   <span class="comment">//存放整型值</span></span><br><span class="line">    <span class="comment">/* The item&#x27;s number, if type==cJSON_Number */</span></span><br><span class="line">    <span class="type">double</span> valuedouble; <span class="comment">//存放双精度数据</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *<span class="built_in">string</span>;   <span class="comment">//键key</span></span><br><span class="line">&#125; cJSON;</span><br></pre></td></tr></table></figure>
<p><strong>cjson与json的具体对应关系如下：一个cjson结构体可以看作一个item，也就是一个”键-值”对(eg:”years”: 22)，当item的类型为object时，表示这个item是一个json数据，这个json数据下可以有若干个item，以此实现嵌套。请认真理解下图的关系。</strong><br><img src="/2025/05/30/hello-world/cJSON/1.how_to_study_cjson/3.png" alt="在这里插入图片描述"></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>随着物联网的越来越热闹，嵌入式设备中应对数据交换的情况也越复杂，具备对json数据的处理能力是一个嵌入式物联网设备的必须能力要求。</p>
<p><strong>在下一篇我将介绍如何简单的使用cjson创建json数据。</strong></p>
<p>linux下安装cjson<br>参考博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/woay2008/article/details/94367652">https://blog.csdn.net/woay2008/article/details/94367652</a><br><img src="/2025/05/30/hello-world/cJSON/1.how_to_study_cjson/4.png" alt="在这里插入图片描述"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/06/01/killer-blog/cJSON/1.how_to_study_cjson/" data-id="cmbcy7rhs002yt8mtcoeyhu6v" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-killer-blog/Web/MySQL_setup" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/06/01/killer-blog/Web/MySQL_setup/" class="article-date">
  <time class="dt-published" datetime="2025-06-01T00:24:26.650Z" itemprop="datePublished">2025-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>@[toc]</p>
<blockquote>
<p>本文分为安装及使用两大模块，安装有Windows系统和Linux系统，Linux系统为在阿里云esc服务器上的安装；</p>
</blockquote>
<h2 id="一，MySQL安装"><a href="#一，MySQL安装" class="headerlink" title="一，MySQL安装"></a>一，MySQL安装</h2><p><em><strong>widows版：</strong></em><br>1，下载<br><a target="_blank" rel="noopener" href="https://dev.mysql.com/downloads/mysql/5.7.html">点我下载MySQL</a>选择合适的版本下载，我选的是zip安装方式。如果下载比较慢，可以复制下载地址然后用迅雷打开下载；<br>2，安装配置<br>下载完成后解压到自定义的文件夹，然后需要对系统环境变量进行配置；<br>打开环境变量设置，在环境变量中添加如下：</p>
<blockquote>
<p>变量名：MYSQL_HOME<br>变量值：（你的MySQL安装路径）</p>
</blockquote>
<p>如图<br><img src="/2025/05/30/hello-world/Web/MySQL_setup/20200314225232536.png" alt="在这里插入图片描述"><br><strong>在path中添加如下：</strong></p>
<blockquote>
<p>把D:\Database\mysql-5.7.29-winx64换成你自己的安装路径<br><img src="/2025/05/30/hello-world/Web/MySQL_setup/20200314230037859.png" alt="在这里插入图片描述"></p>
</blockquote>
<p>3，启动<br>	<strong>以管理员身份打开命令行</strong>，cd到安装路径的bin目录下<br>	执行以下命令在安装目录下生成data目录：</p>
<blockquote>
<p>mysqld –initialize-insecure –user&#x3D;mysql</p>
</blockquote>
<p>执行以下命令 启动mysql服务</p>
<blockquote>
<p>net start mysql</p>
</blockquote>
<p>如果报错服务名无效 就执行命令：</p>
<blockquote>
<p>mysqld -install</p>
</blockquote>
<p><strong>记住，一定要以管理员身份打开命令行！</strong><br>4，登录MySQL,执行命令:</p>
<blockquote>
<p>mysql -u root -p</p>
</blockquote>
<p>因为是第一次登录，所以不用输入密码，直接回车进入;<br>修改用户密码：</p>
<blockquote>
<p>mysql&gt; update mysql.user set authentication_string&#x3D;password(“123456”)<br>where user&#x3D;”root”;   #password(“123456”),此处引号中的内容是密码，自己可以随便设置</p>
</blockquote>
<p><strong>注意要记得执行命令</strong>：flush privileges; <strong>来使修改生效</strong>。输入quit;退出。</p>
<h2 id="二，远程Linux安装"><a href="#二，远程Linux安装" class="headerlink" title="二，远程Linux安装"></a>二，远程Linux安装</h2><p>基本上参考这篇博客就可以了：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/WYA1993/article/details/88890883">centos7安装MySQL</a><br>最后注意如果你是阿里云服务器，要记得添加3306安全组规则</p>
<h2 id="三，MySQL的基本操作"><a href="#三，MySQL的基本操作" class="headerlink" title="三，MySQL的基本操作"></a>三，MySQL的基本操作</h2><p>这些都是最基本的操作，建议大家保存成文本文件，需要的时候在里面修改然后复制粘贴到命令行，比较方便。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">创建数据库myapp</span><br><span class="line">create database myapp;</span><br><span class="line"></span><br><span class="line">选择数据库myapp</span><br><span class="line">mysql&gt; use myapp;</span><br><span class="line"></span><br><span class="line">创建表格：</span><br><span class="line">CREATE TABLE IF NOT EXISTS `myapp_user`(</span><br><span class="line">   `num` INT UNSIGNED AUTO_INCREMENT,</span><br><span class="line">   `name` VARCHAR(100) NOT NULL,</span><br><span class="line">   `sex` VARCHAR(100) NOT NULL,</span><br><span class="line">   `age` INT NOT NULL,</span><br><span class="line">   `<span class="built_in">id</span>` VARCHAR(100) NOT NULL,</span><br><span class="line">   `password` VARCHAR(100) NOT NULL,</span><br><span class="line">   `emailadress` VARCHAR(100) NOT NULL,</span><br><span class="line">   PRIMARY KEY ( `num` )</span><br><span class="line">)ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">创建用户（%表示任何ip段都可访问）</span><br><span class="line">CREATE USER <span class="string">&#x27;user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="string">&#x27;password&#x27;</span>;</span><br><span class="line">CREATE USER <span class="string">&#x27;user&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED BY <span class="string">&#x27;password&#x27;</span>;</span><br><span class="line"></span><br><span class="line">赋予用户权限</span><br><span class="line">GRANT ALL PRIVILEGES ON myapp.* TO <span class="string">&#x27;user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line">插入数据到表格</span><br><span class="line">INSERT INTO myapp_user(name,sex,age,<span class="built_in">id</span>,password,emailadress)VALUES(<span class="string">&quot;姓名&quot;</span>,<span class="string">&quot;男&quot;</span>,20,<span class="string">&quot;2018161122&quot;</span>,<span class="string">&quot;123456789abc&quot;</span>,<span class="string">&quot;12234567@qq.com&quot;</span>);</span><br><span class="line"></span><br><span class="line">查询数据</span><br><span class="line"><span class="keyword">select</span> * from tablename;</span><br><span class="line"><span class="keyword">select</span> name,<span class="built_in">id</span> from tablename <span class="built_in">where</span> <span class="built_in">id</span>=1;</span><br><span class="line"></span><br><span class="line">更新数据</span><br><span class="line">UPDATE table_name SET field1=new-value1, field2=new-value2;</span><br><span class="line"></span><br><span class="line">删除数据</span><br><span class="line">DELETE FROM tablename WHERE <span class="built_in">id</span>=1;</span><br></pre></td></tr></table></figure>

<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44821644/article/details/100624170">MySQL数据库添加用户，授予权限需要注意的问题</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/heboxiang/p/11611102.html">Windows安装MySQL</a><br><a target="_blank" rel="noopener" href="https://www.runoob.com/mysql/mysql-insert-query.html">菜鸟教程MySQL基操</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43277501/article/details/103777395">MySQL5.7创建新用户</a><br><img src="/2025/05/30/hello-world/Web/MySQL_setup/20200614084936916.png" alt="在这里插入图片描述"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/06/01/killer-blog/Web/MySQL_setup/" data-id="cmbcy7rhf0024t8mta5dngl4u" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-killer-blog/Web/open_vpn" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/06/01/killer-blog/Web/open_vpn/" class="article-date">
  <time class="dt-published" datetime="2025-06-01T00:24:26.650Z" itemprop="datePublished">2025-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>@[toc]</p>
<h1 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h1><h2 id="1、vpn概念"><a href="#1、vpn概念" class="headerlink" title="1、vpn概念"></a>1、vpn概念</h2><p>vpn即虚拟专有网络。是一种对局域网的模拟。</p>
<p>将互联网上网络主机使用加密的隧道连接成一个私网，私网内的主机之间通信具有加密性，私网中的主机会获得一个在该私网中的虚拟ip地址，通过该虚拟ip地址就能与私网内的主机安全通信。</p>
<h2 id="2、vpn应用场景"><a href="#2、vpn应用场景" class="headerlink" title="2、vpn应用场景"></a>2、vpn应用场景</h2><p>vpn经常用于员工远程访问公司内网，公司内网中有服务器，只有在内网中的主机能够访问该服务器，出差的员工想通过远程访问服务器，就需要将笔记本电脑与公司服务器组成一个私网，由于这个私网是跨越在互联网之上的，所以使用vpn来组织私网。任何员工只要接入该vpn，就能远程访问公司服务器。</p>
<h2 id="3、openvpn概述"><a href="#3、openvpn概述" class="headerlink" title="3、openvpn概述"></a>3、openvpn概述</h2><p>openvpn2.x是使用OpenSSL实现虚拟专用网络的软件，因此他具备了OpenSSL提供的所有安全服务（身份认证，数据加密，数据完整性校验），并可以运行在不同主流的操作系统中。</p>
<p>openvpn 工作于 服务器&#x2F;客户端 模式，服务器的作用类似于局域网内的网关，负责在各个客户端之间转发数据消息。</p>
<h2 id="4、openvpn工作原理"><a href="#4、openvpn工作原理" class="headerlink" title="4、openvpn工作原理"></a>4、openvpn工作原理</h2><p>openvpn进程运行在用户空间，负责对数据进行加密封装&#x2F;解密解封等，不需要修改系统内核，通过在系统中创建的一个虚拟网卡，字符驱动程序来与系统内核进行通信。</p>
<p>虚拟网卡是openvpn实现功能的一个重要设备，用户空间的openvpn进程通过字符驱动来与虚拟网卡通信，虚拟网卡则通过路由转发与操作系统的协议栈通信。虚拟网卡在此作为openvpn进程与系统协议栈通信的媒介。</p>
<p>如图是Openvpn通信原理图：<br><img src="/2025/05/30/hello-world/Web/open_vpn/5b3cd956bcc4485ebeec7d07a54eef78.png"></p>
<p>每个步骤的详细内容：</p>
<pre><code> 由客户端APP发送数据为例
</code></pre>
<ol>
<li>APP发送目的地址为虚拟ip的UDP&#x2F;TCP 报文到socket接口</li>
<li>socket将报文传递到ip层</li>
<li>ip层将数据转发到虚拟网卡</li>
<li>虚拟网卡将报文传递给设备驱动</li>
<li>Openvpn进程对报文加密，生成数字签名，并将原始报文封装到一个新的UDP&#x2F;TCP报文中。远程IP即服务器公网IP，端口号默认1194</li>
<li>Openvpn将新报文通过socket发送</li>
<li>socket将新报文传递到ip层路由</li>
<li>ip层将新报文转发到物理网卡</li>
<li>物理网卡将新报文发送到服务器网卡<br>以下是服务器主机：</li>
<li>物理网卡将新报文传递到ip层</li>
<li>ip层将新报文传递给socket</li>
<li>socket根据端口号（1194）将新报文传递给Openvpn进程</li>
<li>Openvpn进程使用密钥对数据进行解密，校验，提取原始报文，并写入设备驱动</li>
<li>设备驱动将原始报文传递给虚拟网卡</li>
<li>虚拟网卡将原始报文发送到ip层</li>
<li>ip层将原始报文传递给socket</li>
<li>socket根据原始报文中的端口号，传递给对应的APP</li>
</ol>
<h2 id="5、虚拟网卡"><a href="#5、虚拟网卡" class="headerlink" title="5、虚拟网卡"></a>5、虚拟网卡</h2><p>用户程序通过字符设备驱动向虚拟网卡读取&#x2F;写入数据，虚拟网卡调用网卡驱动将数据读取&#x2F;写入tcp&#x2F;ip协议栈中。虚拟网和物理网卡一样，拥有自己的ip地址和网关。</p>
<p>openvpn的虚拟网卡支持tun和tap两种模式</p>
<ul>
<li>tun：一个虚拟的点对点的ip连接，通过字符设备驱动读取到的数据为ip数据包</li>
<li>tap：一个以太网适配器，通过字符设备驱动读取到的数据包含物理帧头，该模式可以传输以太网帧。</li>
</ul>
<p><img src="/2025/05/30/hello-world/Web/open_vpn/eb64e6b7781846c4b6554d6d426e7721.png" alt="在这里插入图片描述"></p>
<h2 id="6、虚拟地址"><a href="#6、虚拟地址" class="headerlink" title="6、虚拟地址"></a>6、虚拟地址</h2><p>openvpn服务端配置一个虚拟的ip池，如10.8.0.0&#x2F;24，每一个连接的客户端都会被分配一个虚拟的ip地址，服务端成为客户端在虚拟网络10.8.0.0&#x2F;24上的网关，这样客户端与服务端就构成了一个星型的网络。</p>
<p>客户端在虚拟网络10.8.0.0&#x2F;24上的通信都需要经过服务端来进行路由转发。可通过修改子网掩码，使ip地址池可用ip增加。</p>
<p>openvpn为了兼容tap-win32，windows系统，会为每一个客户端分配四个ip地址；故当使用10.8.0.0&#x2F;24网段时，虽然有256个可用的ip地址，但由于每个vpn占用4个ip地址，故仅能同时给64个vpn分配ip；</p>
<p>若在vpn中不存在windows系统，则可修改ip的分配方式。每个vpn只占用一个ip，可为客户端提供：10.8.0.2-→10.8.0.253的连续ip地址。</p>
<p>在server配置文件中，加入命令，开启此功能</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">topology subnet</span><br></pre></td></tr></table></figure>



<h1 id="二、安装openvpn"><a href="#二、安装openvpn" class="headerlink" title="二、安装openvpn"></a>二、安装openvpn</h1><p>硬件环境：虚拟机 Ubuntu18</p>
<p>软件环境：openvpn</p>
<h2 id="1、安装openvpn"><a href="#1、安装openvpn" class="headerlink" title="1、安装openvpn"></a>1、安装openvpn</h2><p>在Ubuntu命令行中执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install openvpn</span><br></pre></td></tr></table></figure>



<p>完成openvpn的安装，安装完成的openvpn可执行程序在 &#x2F;usr&#x2F;sbin&#x2F;openvpn，程序工作目录在&#x2F;etc&#x2F;openvpn</p>
<h2 id="2、安装easy-rsa"><a href="#2、安装easy-rsa" class="headerlink" title="2、安装easy-rsa"></a>2、安装easy-rsa</h2><p>证书的生成需要使用easy-rsa。从github中下载easy-rsa2.0：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/OpenVPN/easy-rsa-old/archive/refs/heads/master.zip</span><br></pre></td></tr></table></figure>





<p>解压文件到目录&#x2F;etc&#x2F;openvpn下</p>
<h1 id="三、配置证书"><a href="#三、配置证书" class="headerlink" title="三、配置证书"></a>三、配置证书</h1><p>证书的生成是用easy-rsa来实现的。</p>
<h2 id="1、CA证书"><a href="#1、CA证书" class="headerlink" title="1、CA证书"></a>1、CA证书</h2><p>OpenVPN支持双向认证。客户端和服务端的证书需要有ca机构签名。ca机构用ca证书给其他证书签名，ca证书是根本的。</p>
<p>修改&#x2F;etc&#x2F;openvpn&#x2F;easy-rsa&#x2F;vars文件里的 KEY_COUNTRY, KEY_PROVINCE, KEY_CITY, KEY_ORG, and KEY_EMAIL参数 并将当前目录下的openssl-1.0.0.cnf 重命名为openssl.cnf 并执行下列命令生成CA文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">. ./vars ./clean-all ./build-ca</span><br></pre></td></tr></table></figure>


<p>输入相应的参数：</p>
<p><img src="/2025/05/30/hello-world/Web/open_vpn/0569abb14cc84a6abb8e1ba440c34ec5.png"></p>
<h2 id="2、服务端证书和私钥"><a href="#2、服务端证书和私钥" class="headerlink" title="2、服务端证书和私钥"></a>2、服务端证书和私钥</h2><p>执行 .&#x2F;build-key-server server 签发服务端证书和私钥：</p>
<p><img src="/2025/05/30/hello-world/Web/open_vpn/aec06cc7442940c1b9bfb367580efb64.png"></p>
<h2 id="3、客户端证书和私钥"><a href="#3、客户端证书和私钥" class="headerlink" title="3、客户端证书和私钥"></a>3、客户端证书和私钥</h2><p>生成3个客户端证书密钥：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./build-key client_1 ./build-key client_2 ./build-key client_3</span><br></pre></td></tr></table></figure>

<p>下图提示是否对证书进行签名，输入y确认签名，即可生成可使用的客户端证书</p>
<p><img src="/2025/05/30/hello-world/Web/open_vpn/4804d95d7de64ebf9d377eb1a8138901.png" alt="在这里插入图片描述"></p>
<h2 id="4、Diffie-Hellman-参数文件"><a href="#4、Diffie-Hellman-参数文件" class="headerlink" title="4、Diffie Hellman 参数文件"></a>4、Diffie Hellman 参数文件</h2><p>diffie hellman参数文件用于在安全的情况下，协商密钥，执行以下语句生成</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./build-dh</span><br></pre></td></tr></table></figure>



<h2 id="5、生成ta-key"><a href="#5、生成ta-key" class="headerlink" title="5、生成ta.key"></a>5、生成ta.key</h2><p>使用tls-auth加密udp数据包，需要一个共享密钥来校验SSL握手报文，执行以下命令生成该密钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openvpn --genkey --secret ta.key</span><br></pre></td></tr></table></figure>





<p>至此，所需的证书和密钥就生成完毕了。生成的证书文件放在keys文件夹下。如图</p>
<p>将client1.crt,client.key,ca.crt,ta.key通过安全的途径复制到客户端1主机中。</p>
<p><img src="/2025/05/30/hello-world/Web/open_vpn/04ae536c65134e6281237b2cf9cbf4a4.png" alt="在这里插入图片描述"></p>
<h1 id="四、配置openvpn"><a href="#四、配置openvpn" class="headerlink" title="四、配置openvpn"></a>四、配置openvpn</h1><p>openvpn的配置信息主要是由配置文件中的命令来设置的，可从github中下载实例配置文件client.conf，server.conf</p>
<p><strong><a target="_blank" rel="noopener" href="https://github.com/OpenVPN/openvpn">https://github.com/OpenVPN/openvpn</a></strong></p>
<h2 id="1、桥接或路由"><a href="#1、桥接或路由" class="headerlink" title="1、桥接或路由"></a>1、桥接或路由</h2><p>一般的vpn都会选择工作在路由模式，只需要经过简单的设置就能实现vpn的功能。路由模式下，客户端之间处于同一虚拟私网中，接受发送的数据包都是ip数据包；虚拟网卡使用tun</p>
<p>openvpn还支持桥接模式，该模式下，接入vpn的客户端之间不仅处于同一局域网中，还处于同一以太网中，此时的客户端接收发送的数据包是以太网数据包。该模式下配置较复杂。虚拟网卡使用tap</p>
<h2 id="2、确定虚拟子网"><a href="#2、确定虚拟子网" class="headerlink" title="2、确定虚拟子网"></a>2、确定虚拟子网</h2><p>确定虚拟网络的网段地址，需要注意子网的网段最好不要与客户端或服务端本地的网段重叠，局域网网段如下图，推荐使用10.8.0.0&#x2F;24网段。</p>
<p><img src="/2025/05/30/hello-world/Web/open_vpn/a88b059a22ee40a09dd92e29293ac30f.png" alt="在这里插入图片描述"></p>
<h2 id="3、快速搭建vpn"><a href="#3、快速搭建vpn" class="headerlink" title="3、快速搭建vpn"></a>3、快速搭建vpn</h2><p>为了快速建立一个vpn，只需要修改服务端和客户端配置文件中的以下几项：</p>
<h3 id="server"><a href="#server" class="headerlink" title="server"></a>server</h3><p>在server.conf中修改ca证书，server证书和私钥，dh的路径如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ca /etc/openvpn/easy-rsa-old/2.0/keys/ca.crt </span><br><span class="line">cert  /etc/openvpn/easy-rsa-old/2.0/keys/server.crt </span><br><span class="line">key  /etc/openvpn/easy-rsa-old/2.0/keys/server.key    </span><br><span class="line">dh  /etc/openvpn/easy-rsa-old/2.0/keys/dh2048.pem</span><br></pre></td></tr></table></figure>



<p>确定VPN的虚拟网段，服务端主机的VPN ip为10.8.0.1</p>
<p>修改ta.key证书的地址 在服务端需要设置参数为0</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server 10.8.0.0 255.255.255.0  tls-auth /etc/openvpn/ta.key 0 </span><br></pre></td></tr></table></figure>

<h3 id="client"><a href="#client" class="headerlink" title="client"></a>client</h3><p>类似于服务端，在client.conf修改ca证书，server证书和密钥，dh路径如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ca /etc/openvpn/easy-rsa-old/2.0/keys/ca.crt </span><br><span class="line">cert  /etc/openvpn/easy-rsa-old/2.0/keys/server.crt </span><br><span class="line">key  /etc/openvpn/easy-rsa-old/2.0/keys/server.key</span><br></pre></td></tr></table></figure>



<p>修改ta.key证书的地址 在客户端需要设置参数为1，指定remote 中的服务端的公网ip地址：（例如服务端的公网ip为192.168.3.1）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tls-auth /etc/openvpn/ta.key 1  remote 192.168.3.1 1194</span><br></pre></td></tr></table></figure>



<p>至此，配置文件编写完成。</p>
<h1 id="五、启动openvpn"><a href="#五、启动openvpn" class="headerlink" title="五、启动openvpn"></a>五、启动openvpn</h1><h2 id="1、启动openvpn-server"><a href="#1、启动openvpn-server" class="headerlink" title="1、启动openvpn server"></a>1、启动openvpn server</h2><p>在server.conf 目录下执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openvpn server.conf</span><br></pre></td></tr></table></figure>


<p>打印信息如下：表示server建立成功</p>
<p><img src="/2025/05/30/hello-world/Web/open_vpn/3ed89d4c4d5148d7b67a139eff9d7ea4.png" alt="在这里插入图片描述"></p>
<h2 id="2、启动openvpn-client"><a href="#2、启动openvpn-client" class="headerlink" title="2、启动openvpn client"></a>2、启动openvpn client</h2><p>在server.conf 目录下执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openvpn client.conf</span><br></pre></td></tr></table></figure>

<p>客户端验证成功，打印信息如下：</p>
<p><img src="/2025/05/30/hello-world/Web/open_vpn/85cb14a5b8ac451fb4ef09ada068eacf.png" alt="在这里插入图片描述"></p>
<p><img src="/2025/05/30/hello-world/Web/open_vpn/ebe8beafc83e4698a1d9c198ea335432.png" alt="在这里插入图片描述"></p>
<h2 id="3、server-和-client-在vpn中互ping"><a href="#3、server-和-client-在vpn中互ping" class="headerlink" title="3、server 和 client 在vpn中互ping"></a>3、server 和 client 在vpn中互ping</h2><p>从上面可知client在vpn中的ip为10.8.0.14，在server中启动新的命令行，ping 10.8.0.14 成功收到反馈</p>
<p>在客户端机器中ping 10.8.0.1 服务端主机，成功反馈。</p>
<p><img src="/2025/05/30/hello-world/Web/open_vpn/37c027247ed642f09e418da9684d0119.png" alt="在这里插入图片描述"></p>
<p><img src="/2025/05/30/hello-world/Web/open_vpn/1b80a6bb204846c083a5a6a91a1c0e75.png" alt="在这里插入图片描述"></p>
<h1 id="六、其他配置"><a href="#六、其他配置" class="headerlink" title="六、其他配置"></a>六、其他配置</h1><h2 id="1、设置开机自动启动"><a href="#1、设置开机自动启动" class="headerlink" title="1、设置开机自动启动"></a>1、设置开机自动启动</h2><p>要开启此功能，必须使用rpm或deb包安装openvpn，用这种方式安装openvpn会生成一个初始化脚本，该脚本会扫面&#x2F;etc&#x2F;openvpn&#x2F;下的所有.conf文件，并启动对应的vpn进程。</p>
<h2 id="2、控制openvpn进程的方式"><a href="#2、控制openvpn进程的方式" class="headerlink" title="2、控制openvpn进程的方式"></a>2、控制openvpn进程的方式</h2><h3 id="a、使用信号量"><a href="#a、使用信号量" class="headerlink" title="a、使用信号量"></a>a、使用信号量</h3><p>使用writepid命令将openvpn经常的pid写入一个文件中，用户程序就能根据pid发送信号量来控制openvpn进程。</p>
<h3 id="b、在运行中修改配置文件"><a href="#b、在运行中修改配置文件" class="headerlink" title="b、在运行中修改配置文件"></a>b、在运行中修改配置文件</h3><p>openvpn支持在进程运行时修改部分配置文件：</p>
<ul>
<li>client-config-dir – 命令指出客户端配置文件的路径，每次客户端连接时，openvpn会扫描该目录并找对应的配置文件。在openvpn运行时，修改该目录的配置文件，旧的客户端连接不会被影响，若要更新某个特定的客户端连接，就要让客户端先断开再重新连接。</li>
<li>crl-verify – 指定一个证书撤销文件，用于撤销客户端的证书，修改他不会影响已经建立连接的客户端。</li>
</ul>
<h3 id="c、输出日志文件"><a href="#c、输出日志文件" class="headerlink" title="c、输出日志文件"></a>c、输出日志文件</h3><p>openvpn server中一行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">status openvpn-status.log</span><br></pre></td></tr></table></figure>


<p>表示vpn每一分钟会将已连接的客户端列表打印到文件openvpn-status.log中。</p>
<h3 id="d、用户管理接口"><a href="#d、用户管理接口" class="headerlink" title="d、用户管理接口"></a>d、用户管理接口</h3><p>openvpn提供一个强大的管理接口来管理openvpn客户端或服务端进程。</p>
<p>openvpn通过监听一个ip和端口上的tcp连接来开启该接口，开发者通过一个telnet来连接该接口，由于这个tcp连接过程是没有经过任何加密的，所以建议将监听建立在localhost或者在vpn网段，以增加安全性</p>
<p>在openvpn sever配置文件中使用命令：管理接口监听在本地7505端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">management localhost 7505  <span class="comment"># 若要支持vpn客户端连接上管理接口后输入密码认证，则需要添加命令 --management-client-auth</span></span><br></pre></td></tr></table></figure>


<p>该接口支持的命令文档：<a target="_blank" rel="noopener" href="https://openvpn.net/community-resources/management-interface/">https://openvpn.net/community-resources/management-interface/</a></p>
<p>常用命令：</p>
<ul>
<li>bytecount -n：当n&gt;0，管理接口每隔n秒打印带宽使用情况。n&#x3D;0关闭功能</li>
<li>exit&#x2F;quit：推出会话</li>
<li>killer：杀死一个client对象，命令后面跟着客户端的ip地址和端口，或common name</li>
<li>log：开启或关闭日志输出</li>
<li>pid：显示vpn进程pid</li>
<li>status：显示已连接 的客户端列表</li>
</ul>
<h2 id="3、扩展服务端的子网"><a href="#3、扩展服务端的子网" class="headerlink" title="3、扩展服务端的子网"></a>3、扩展服务端的子网</h2><p>场景：客户端除了与服务端本身通信外，还希望与服务端所在子网的主机通信。假设服务端所在的子网为192.168.137.0&#x2F;24，vpn虚拟子网为10.8.0.0&#x2F;24.</p>
<p>client发送数据，到达server，再由server将数据包在子网192.168.137.0&#x2F;24内转发到App_server主机。</p>
<p>App_server以正常方式处理该数据包，发送到路由器，路由器根据路由表（需要设置）转发到达openvpn server，openvpn server对数据包进行检查并重新封装，通过vpn隧道发送到client。</p>
<p>note：在网关路由中添加一条路由规则，将目的ip为10.8.0.0&#x2F;24的数据路由到openvpn server。</p>
<p><img src="/2025/05/30/hello-world/Web/open_vpn/a8670adb212046d8a94436f8ca770b70.png" alt="在这里插入图片描述"></p>
<h2 id="4、扩展客户端的子网"><a href="#4、扩展客户端的子网" class="headerlink" title="4、扩展客户端的子网"></a>4、扩展客户端的子网</h2><p>类似的，假设客户端client2是一个网关，其子网为192.168.137.0&#x2F;24，vpn网络为10.8.0.0&#x2F;24，客户端子网中的主机要与服务端或服务端所在子网的主机通信。</p>
<p>首先确保192.168.137.0&#x2F;24没有与接入vpn的其他网络网段冲突。</p>
<p>在server的配置文件中指定客户端配置文件的路径：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client-config-dir ccd</span><br></pre></td></tr></table></figure>



<p>在ccd路径下创建client2文件，输入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iroute 192.168.137.0 255.255.255.0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个操作告诉vpn server ：发往192.168.137.0&#x2F;24的数据包 需要转发到client2.</p>
<p>在server.conf中添加命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route 192.168.137.0 255.255.255.0</span><br></pre></td></tr></table></figure>




<p>这个操作告诉虚拟网卡将 发往192.168.137.0&#x2F;24的数据包 传递给openvpn进程，由openvpn对数据包重新封装发送到client_2。</p>
<p><strong>同时在server 网关中添加路由规则，路由192.168.137.0&#x2F;24的数据包到server</strong></p>
<p><img src="/2025/05/30/hello-world/Web/open_vpn/0d85ce44ce454c139f58fbc2e85c55c7.png" alt="在这里插入图片描述"></p>
<p>若想要192.168.137.0&#x2F;24子网内的主机能与vpn中其他客户端通信，则在server.conf中添加：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client-to-client push <span class="string">&quot;route 192.168.137.0 255.255.255.0&quot;</span></span><br></pre></td></tr></table></figure>


<p>这个命令向所有客户端广播192.168.137.0&#x2F;24这个子网，表示该子网连接到vpn网络中。</p>
<h2 id="5、推送DNS服务器地址"><a href="#5、推送DNS服务器地址" class="headerlink" title="5、推送DNS服务器地址"></a>5、推送DNS服务器地址</h2><p>openvpn server 能给所有客户端推送DHCP选项，比如DNS服务器的地址。</p>
<p>假设DNS服务器的地址是10.8.0.3 ，在server.conf中添加：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">push <span class="string">&quot;dhcp-option DNS 10.8.0.3&quot;</span></span><br></pre></td></tr></table></figure>

<p>当客户端运行在linux系统中，需要设置脚本来将server 推送的dns保存到配置文件&#x2F;etc&#x2F;resolv.conf 中。</p>
<p>在客户端主机上创建&#x2F;etc&#x2F;openvpn&#x2F;client.up脚本文件，该文件内容可由仓库例程&#x2F;contrib&#x2F;pull-resolv-conf&#x2F;client.up参考。然后给与脚本执行权限：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> a+x /etc/openvpn/client.up</span><br></pre></td></tr></table></figure>



<p>在客户端配置文件client.conf中添加该脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">up /etc/openvpn/client.up</span><br></pre></td></tr></table></figure>

<p>当客户端连接到服务端时，会收到服务端推送的选项，openvpn client进程会将这些选项保存在环境变量foreign_option_{n}中，然后在客户端执行&#x2F;etc&#x2F;openvpn&#x2F;client.up脚本，脚本会提取环境变量foreign_option_{n}并在&#x2F;etc&#x2F;resolv.conf中添加：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nameserver 10.8.0.3</span><br></pre></td></tr></table></figure>

<p>流程图如下：</p>
<p><img src="/2025/05/30/hello-world/Web/open_vpn/7073bccd8311428f82cebf554571576d.png" alt="在这里插入图片描述"></p>
<h2 id="6、客户端访问控制"><a href="#6、客户端访问控制" class="headerlink" title="6、客户端访问控制"></a>6、客户端访问控制</h2><p>应用场景：限制客户端A只能与vpn server通信，而不能跟其他客户端B,C,D通信。而超级客户端Y则能跟任何vpn内主机通信。</p>
<p>分为两个部分：</p>
<p>a，区分客户端。</p>
<p>b，设置服务端的防火墙规则。</p>
<h3 id="a、区分客户端"><a href="#a、区分客户端" class="headerlink" title="a、区分客户端"></a>a、区分客户端</h3><p>假设超级客户端的虚拟ip网段为10.8.2.0&#x2F;24，其他客户端的虚拟ip为10.8.0.0&#x2F;24网段。</p>
<p>在server.conf中设置vpn的虚拟ip网段为10.8.0.0&#x2F;24，并支持路由到10.8.2.0&#x2F;24</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server 10.8.0.0 255.255.255.0 <span class="comment"># server接受来自10.8.2.0/24的数据包 route 10.8.2.0 255.255.255.0</span></span><br></pre></td></tr></table></figure>

<p>修改ccd目录下的客户端配置文件，给特定的超级客户端分配特定的ip地址:</p>
<p>ip地址的设置有一定的要求，具体见文档<a target="_blank" rel="noopener" href="https://openvpn.net/community-resources/how-to/">https://openvpn.net/community-resources/how-to/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># determining-whether-to-use-a-routed-or-bridged-vpn </span></span><br><span class="line">ifconfig-push 10.8.2.1 10.8.2.2</span><br></pre></td></tr></table></figure>

<p>超级客户端连接上vpn后，其虚拟ip地址是10.8.2.1.其他客户端的虚拟ip为10.8.0.0&#x2F;24网段。</p>
<h3 id="b、设置防火墙"><a href="#b、设置防火墙" class="headerlink" title="b、设置防火墙"></a>b、设置防火墙</h3><p>设置openvpn server所在机器的防火墙的转发规则，使普通客户端的报文只能输入到server，超级客户端的报文能正常转发给普通客户端。</p>
<p>首先修改server.conf中虚拟网卡的编号为dev tun0，以便在防火墙规则中引用他</p>
<p>修改linux防火墙规则</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 仅允许其他客户端访问server 10.8.0.1(源地址是10.8.0.0/24,目的地址不是10.8.0.1的数据包，会被防火墙丢弃) </span></span><br><span class="line">iptables -A FORWARD -i tun0 -s 10.8.0.0/24 -d !10.8.0.1 -j DROP  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许超级客户端访问10.8.0.0/24所有主机(源地址是10.8.0.0/24,目的地址是10.8.0.0/24的数据包，会被转发) </span></span><br><span class="line">iptables -A FORWARD -i tun0 -s 10.8.2.1 -d 10.8.0.0/24 -j ACCEPT</span><br></pre></td></tr></table></figure>

<h2 id="7、通过http代理连接openvpn"><a href="#7、通过http代理连接openvpn" class="headerlink" title="7、通过http代理连接openvpn"></a>7、通过http代理连接openvpn</h2><p>由于http代理使用tcp协议，所以在客户端和服务端的配置文件中都需要将proto命令设置为tcp。</p>
<p>openvpn支持三个代理认证方式：</p>
<ul>
<li>无代理认证</li>
<li>用户名&#x2F;密码代理认证</li>
<li>NTLM代理认证</li>
</ul>
<p>在客户端配置文件中添加代理服务器的地址及认证方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在命令行输入用户名密码 </span></span><br><span class="line">http-proxy 192.168.4.1 1080 stdin basic</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在passfile文件存放用户名/密码 </span></span><br><span class="line">http-proxy 192.168.4.1 1080 passfile</span><br></pre></td></tr></table></figure>






<h2 id="8、负载均衡"><a href="#8、负载均衡" class="headerlink" title="8、负载均衡"></a>8、负载均衡</h2><p>负载均衡是在高并发的情况下，将请求合理的分配到不同的服务器进程中。这就要求运行多个openvpn server进程，无论是在一个主机上还是在多个不同主机上。</p>
<h3 id="a、客户端配置"><a href="#a、客户端配置" class="headerlink" title="a、客户端配置"></a>a、客户端配置</h3><p>客户端只需要在remote指令中指出多个服务器的地址和端口即可。</p>
<h3 id="b、服务端"><a href="#b、服务端" class="headerlink" title="b、服务端"></a>b、服务端</h3><p>当多个服务端运行在同一台机器时，使用同一份配置文件，只需要修改端口号。</p>
<p>当多个服务端运行在不同机器时，要确保每个机器上有相同的客户端证书和认证方式。</p>
<p>多个openvpn服务器必须各自拥有唯一的虚拟ip地址。</p>
<h2 id="9、撤销客户端证书"><a href="#9、撤销客户端证书" class="headerlink" title="9、撤销客户端证书"></a>9、撤销客户端证书</h2><p>撤销客户端证书意味着客户端不能使用该证书完成客户端认证。</p>
<p>首先，在easy-rsa路径下，执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">. ./vars ./revoke-full client</span><br></pre></td></tr></table></figure>

<p>该命令会在keys目录下生成一个crl.pem文件，需要将该文件放到openvpn server可访问的路径，并在server配置文件中加入命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crl-verify crl.pem</span><br></pre></td></tr></table></figure>

<p>当有新的连接进入vpn时，所有客户端会与该文件比较，匹配的客户端将会被强制断开连接。</p>
<h2 id="10、使用脚本和环境变量二次开发"><a href="#10、使用脚本和环境变量二次开发" class="headerlink" title="10、使用脚本和环境变量二次开发"></a>10、使用脚本和环境变量二次开发</h2><h3 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h3><p>openvpn支持用户自定义脚本，以在openvpn运行过程中执行脚本。在openvpn配置文件中加入以下命令以注册脚本，当相应条件满足时，openvpn就会执行对应脚本。</p>
<ul>
<li>up：在TCP&#x2F;UDP套接字绑定后并打开tun之后执行、</li>
<li>tls-verify：有一个不信任的远程对端时执行</li>
<li>ipchange：在连接后或服务器ip发生改变后执行</li>
<li>client-connect：在服务器端，一个客户端认证后执行</li>
<li>route-up：在连接完成后执行</li>
<li>client-disconnect：客户端断开连接后执行</li>
<li>down：tcp&#x2F;udp，tun&#x2F;tap关闭后执行</li>
<li>learn-address：ipv4地址或mac地址被添加到openvpn server路由表时执行</li>
<li>auth-user-pass-verify：客户端连接并还未认证时执行</li>
</ul>
<h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h3><p>openvpn运行过程会设置环境变量，传递给脚本使用。环境变量一旦被设置，会一直保持直到被覆盖或重启。环境变量是以一个客户端为对象的，每个客户端都有各自独立的环境变量。</p>
<h2 id="11、全局vpn"><a href="#11、全局vpn" class="headerlink" title="11、全局vpn"></a>11、全局vpn</h2><p>若想让客户端的所有ip报文都通过vpn通道传输，则可以在客户端中设置命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">push <span class="string">&quot;redirect-gateway def1&quot;</span></span><br></pre></td></tr></table></figure>

<p>客户端会将所有ip报文发送到服务端，服务端需要把报文转发到互联网，可使用NAT或http代理：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用防火墙对源地址为10.8.0.0/24的报文转发到eth0网口 </span></span><br><span class="line">iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE</span><br></pre></td></tr></table></figure>

<p>客户端发送的DNS请求也会经过服务端，服务端需要接受请求，并把DNS服务器的地址推送给客户端，来替换他们原本的DNS服务器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">push <span class="string">&quot;dhcp-option DNS 10.8.0.1&quot;</span></span><br></pre></td></tr></table></figure>

<p>注意：客户端需要周期性与DHCP服务器通信以获取ip地址，redirect-gateway命令可能使客户端长度无法与DHCP正常通信而丢失ip</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/06/01/killer-blog/Web/open_vpn/" data-id="cmbcy7rhf0025t8mtdeebgr6z" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-killer-blog/Web/EMQX_rule_engine" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/06/01/killer-blog/Web/EMQX_rule_engine/" class="article-date">
  <time class="dt-published" datetime="2025-06-01T00:24:26.649Z" itemprop="datePublished">2025-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/emqx/p/11401071.html">参考文章</a></p>
<h2 id="本篇博客是基于EMQX企业版，企业版自带持久化数据到MySQL等数据库的插件，实现存贮数据比较方便，但考虑到企业版价格相对贵（特别是对学生党而言），所以我写了另一篇关于使用EMQX免费开源版的同样实现保存消息到MySQL的博客EMQX-webhook保存消息到MySQL"><a href="#本篇博客是基于EMQX企业版，企业版自带持久化数据到MySQL等数据库的插件，实现存贮数据比较方便，但考虑到企业版价格相对贵（特别是对学生党而言），所以我写了另一篇关于使用EMQX免费开源版的同样实现保存消息到MySQL的博客EMQX-webhook保存消息到MySQL" class="headerlink" title="本篇博客是基于EMQX企业版，企业版自带持久化数据到MySQL等数据库的插件，实现存贮数据比较方便，但考虑到企业版价格相对贵（特别是对学生党而言），所以我写了另一篇关于使用EMQX免费开源版的同样实现保存消息到MySQL的博客EMQX webhook保存消息到MySQL"></a>本篇博客是基于EMQX企业版，企业版自带持久化数据到MySQL等数据库的插件，实现存贮数据比较方便，但考虑到企业版价格相对贵（特别是对学生党而言），所以我写了另一篇关于使用EMQX免费开源版的同样实现保存消息到MySQL的博客<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44821644/article/details/101388095">EMQX webhook保存消息到MySQL</a></h2><p>首先在MySQL数据库创建对应的数据库，表格。<br><img src="/2025/05/30/hello-world/Web/EMQX_rule_engine/20190907112910227.png" alt="创建mqtt数据库"><br><img src="/2025/05/30/hello-world/Web/EMQX_rule_engine/20190907113708957.png" alt="创建表格"><br>然后进入emqx服务器的控制台，就是dashboard，进入资源，创建资源<br><img src="/2025/05/30/hello-world/Web/EMQX_rule_engine/20190907113951944.png" alt="创建资源"><br>连接成功后，到规则里去创建新规则,过滤出我们需要的temp温度数据,规则sql的意思是从负载payload中把键msg的值赋值给将要发送的json数据的temperature对应的值中<br><img src="/2025/05/30/hello-world/Web/EMQX_rule_engine/20190907114757234.png" alt="在这里插入图片描述"><br>接下来是触发动作，也就是把数据存入表格sensor里对应的位置，把temperature的值写入sensor表中对应的temp项，<em><strong>注意下图中的<code>sensor</code>的标点是&#96; ,也就是键盘esc键下面那个键，注意不要看成 ‘</strong></em> ，否则会新建出错<br><img src="/2025/05/30/hello-world/Web/EMQX_rule_engine/2019090711544254.png" alt="在这里插入图片描述"><br>点击确认后就可以测试了，启动websocket，先连接上emqx服务器，订阅temp主题，再向temp主题发送{‘msg’:’26摄氏度’}的消息。<br><img src="/2025/05/30/hello-world/Web/EMQX_rule_engine/20190907115951446.png" alt="在这里插入图片描述"><br>然后在规则里我们可以看到该规则已经被命中一次，也触发相应的动作，详细的信息：<br><img src="/2025/05/30/hello-world/Web/EMQX_rule_engine/20190907120130487.png" alt="在这里插入图片描述"><br>究竟有木有保存到数据库中，耳听为虚眼见为实，我们还是要到数据库去看一看的。<br><img src="/2025/05/30/hello-world/Web/EMQX_rule_engine/20190907120334573.png" alt="在这里插入图片描述"><br>可以看到我们的数据库里确实保存了刚刚发送的消息26摄氏度，大功告成！</p>
<h2 id="更新数据到数据库前面的操作和保存的操作基本一致，只在添加动作这个地方有点不一样"><a href="#更新数据到数据库前面的操作和保存的操作基本一致，只在添加动作这个地方有点不一样" class="headerlink" title="更新数据到数据库前面的操作和保存的操作基本一致，只在添加动作这个地方有点不一样"></a>更新数据到数据库前面的操作和保存的操作基本一致，只在添加动作这个地方有点不一样</h2><p>如官网所示，<em><strong>注意语法  &#96;</strong></em><br><img src="/2025/05/30/hello-world/Web/EMQX_rule_engine/2019091923424834.png" alt="在这里插入图片描述"><br><img src="/2025/05/30/hello-world/Web/EMQX_rule_engine/20200614085029323.png" alt="在这里插入图片描述"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/06/01/killer-blog/Web/EMQX_rule_engine/" data-id="cmbcy7rhe0021t8mt7mnva8fp" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-killer-blog/Web/EMQX_webhook_route_msg" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/06/01/killer-blog/Web/EMQX_webhook_route_msg/" class="article-date">
  <time class="dt-published" datetime="2025-06-01T00:24:26.649Z" itemprop="datePublished">2025-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>@[toc]</p>
<p>修改记录</p>
<ul>
<li>2021.5.19 修改文章格式，在第三节添加了服务器的压缩文件 myweb.war. 添加项目仓库。</li>
</ul>
<h2 id="一，前言"><a href="#一，前言" class="headerlink" title="一，前言"></a>一，前言</h2><blockquote>
<p>之前写过一篇关于EMQX数据持久化到MySQL数据库，但由于这个功能需要EMQX企业版才能实现，而企业版的费用对于我这种学生党而言实在难以负担。于是，我在EMQX官方发现另一种方法也可以实现保存数据。<a target="_blank" rel="noopener" href="https://docs.emqx.io/tutorial/v3/cn/rule_engine/example.html">官网对于webhook的示例</a></p>
</blockquote>
<blockquote>
<p>预备知识：<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/breka/articles/9791664.html">http协议与格式</a><br>web服务器：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42857603/article/details/82857443">web项目基本结构</a><br>java语言<br>tomcat的安装：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/yocichen/p/10478431.html">window系统安装tomcat</a>，<a target="_blank" rel="noopener" href="https://www.cnblogs.com/xdp-gacl/p/4097608.html">linux系统安装tomcat</a><br>开发环境：<a target="_blank" rel="noopener" href="https://www.eclipse.org/downloads/">eclipse官网下载</a></p>
</blockquote>
<p><strong>思路：设备的数据上传到emqx服务器，我们需要一个web服务器来接收EMQX服务器post过来数据，然后再将数据保存到数据库。</strong><br><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20191124225507345.png"></p>
<h2 id="二，搭建基于tomcat的web服务器"><a href="#二，搭建基于tomcat的web服务器" class="headerlink" title="二，搭建基于tomcat的web服务器"></a>二，搭建基于tomcat的web服务器</h2><p>首先在主机安装tomcat和java jdk，这是搭建web服务器必须的环境。</p>
<p>具体的安装方法网上很多，找到适合自己的。这里只介绍搭建web服务器。</p>
<p><strong>已经搭建好环境的同学请跳过此步骤</strong></p>
<p>假设你已经完成以上的环境部署，还需要安装开发环境<code>eclipse</code>，再安装程序中选择安装eclipse ee，这是专门为web开发而设计的开发软件。</p>
<p>项目仓库地址：<a target="_blank" rel="noopener" href="https://gitee.com/killerp/emqx-web">https://gitee.com/killerp/emqx-web</a></p>
<blockquote>
<p><strong>打开eclipse，新建工程，选择Dynamic Web Project</strong></p>
<p><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/2019092521434592.png" alt="在这里插入图片描述"><br><strong>给项目取个名称，target runtime选择你主机安装的tomcat的版本，如果你是在云主机安装tomcat，建议在本地电脑也安装同一版本的tomcat，方便调试</strong></p>
<p><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925214452499.png" alt="在这里插入图片描述"><br><strong>接下来就一路next，最后这个页面记得勾选generate</strong></p>
</blockquote>
<p><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925214728645.png" alt="在这里插入图片描述"><br><strong>web.xml是配置web服务器的文件，java resources是放java文件的</strong><br><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925214939528.png" alt="在这里插入图片描述"><br>在下图lib文件夹下添加需要用到的库文件，然后把库文件真正导入项目<br>库文件百度网盘：</p>
<p><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1mK4Yyp6_DqBjxiW-pr0BhA">jsonobjectjar.zip下载</a> 提取码：l3rh</p>
<p><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1XPcJdrnDlmyXkKP5psF95Q">mysql-connector-java-5.1.28.jar下载</a> 提取码：nq3d </p>
<p><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925215235282.png" alt="在这里插入图片描述"></p>
<blockquote>
<p><strong>右击项目，选择properties，选择java build path ，点击add jars 找到你的项目lib里的库文件，全部添加进去，最后apply and close，导入库文件完成！</strong></p>
<p><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925215443641.png" alt="在这里插入图片描述"><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925215550210.png" alt="在这里插入图片描述"><br><strong>接下来编写一个Java 类，myhttpservlet，它继承自HttpServlet ，用来接收EMQX post过来的数据；</strong></p>
</blockquote>
<blockquote>
<p><strong>HttpServlet 是一个实现http协议的最重要的java类可以参考这篇博客 <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41007534/article/details/99696559">httpservlet详解</a></strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> myweb;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.Reader;</span><br><span class="line"><span class="keyword">import</span> java.io.StringWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.Writer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.http.fileupload.IOUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mysql.jdbc.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.oracle.webservices.internal.api.message.ContentType;</span><br><span class="line"><span class="keyword">import</span> com.sun.xml.internal.bind.CycleRecoverable.Context;</span><br><span class="line"><span class="keyword">import</span> com.sun.xml.internal.ws.wsdl.writer.document.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> net.sf.json.JSONArray;</span><br><span class="line"><span class="keyword">import</span> net.sf.json.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FirstServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">	<span class="comment">//用来读取post过来的json的缓存区的数据长度</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">BUFFER_SIZE</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">8</span>;</span><br><span class="line">	<span class="comment">//一些emqx post过来的数据</span></span><br><span class="line">	<span class="keyword">private</span> String app_id,device_id,remark,time,state,type;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 不知道是什么，反正是必须的</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//用来处理get消息</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">		<span class="comment">//doPost(request,response);</span></span><br><span class="line">		<span class="comment">//get请求用来获取数据库的数据</span></span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">		<span class="comment">//用来处理post消息</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">		<span class="comment">//获取post过来的输入流</span></span><br><span class="line">		InputStream in=request.getInputStream();</span><br><span class="line">		<span class="comment">//创建一个缓存读取器来暂时存贮输入流里的数据</span></span><br><span class="line">		<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(in));</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//body是json字符串，要解析字符串，拿到对应的值插入数据库</span></span><br><span class="line">		<span class="comment">//读取缓存读取器里的body数据并转为字符串格式，这里的body数据为json字符串格式</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> read(reader);</span><br><span class="line">		<span class="comment">//从json字符串里获取json对象</span></span><br><span class="line">		JSONObject J=JSONObject.fromObject(body);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//通过键值对的形式，获取json里的值并赋值给变量</span></span><br><span class="line">			app_id= J.getString(<span class="string">&quot;app_id&quot;</span>);</span><br><span class="line">		    </span><br><span class="line">			device_id=J.getString(<span class="string">&quot;device_id&quot;</span>);</span><br><span class="line">			time=J.getString(<span class="string">&quot;mytime&quot;</span>);</span><br><span class="line">			state=J.getString(<span class="string">&quot;state&quot;</span>);</span><br><span class="line">			type=J.getString(<span class="string">&quot;device_type&quot;</span>);</span><br><span class="line">			remark=J.getString(<span class="string">&quot;remark&quot;</span>);</span><br><span class="line">			</span><br><span class="line">		<span class="comment">//把变量的值保存到数据库</span></span><br><span class="line">		DBUutil.update(app_id,device_id,remark,time,state,type);</span><br><span class="line">		</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">read</span><span class="params">(Reader reader)</span> <span class="keyword">throws</span> IOException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">StringWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>();</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            write(reader, writer);</span><br><span class="line">            <span class="keyword">return</span> writer.getBuffer().toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span>&#123; writer.close(); &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">write</span><span class="params">(Reader reader, Writer writer)</span> <span class="keyword">throws</span> IOException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> write(reader, writer, BUFFER_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//把缓存器的json数据写入缓存区</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">write</span><span class="params">(Reader reader, Writer writer, <span class="type">int</span> bufferSize)</span> <span class="keyword">throws</span> IOException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> read;</span><br><span class="line">        <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">char</span>[] buf = <span class="keyword">new</span> <span class="title class_">char</span>[BUFFER_SIZE];</span><br><span class="line">        <span class="keyword">while</span>( ( read = reader.read(buf) ) != -<span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            writer.write(buf, <span class="number">0</span>, read);</span><br><span class="line">            total += read;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> total;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>再新建一个java 类，dbutil，这个类的作用是对数据库进行操作，这里只写了对数据库进行插入数据的操作，其他操作如更新，删除，查询都可实现</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> myweb;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mysql.jdbc.Connection;</span><br><span class="line"><span class="keyword">import</span> com.mysql.jdbc.log.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DBUutil</span> &#123;</span><br><span class="line">	<span class="keyword">static</span> List&lt;ESP8266&gt; ESPlist=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();<span class="comment">//����豸������</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ESP8266 Device=<span class="keyword">new</span> <span class="title class_">ESP8266</span>();<span class="comment">//��ʼ������</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">driver</span> <span class="operator">=</span> <span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>;<span class="comment">// MySql驱动</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> <span class="string">&quot;app&quot;</span>;<span class="comment">// MySQL的用户名和密码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">//连接数据库的方法</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Connection <span class="title function_">getConn</span><span class="params">(String dbName)</span>&#123;</span><br><span class="line">        Connection connection;</span><br><span class="line">         connection = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Class.forName(driver);<span class="comment">//加载驱动，需要驱动才能对数据库进行操作</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> <span class="string">&quot;118.31.20.121&quot;</span>;<span class="comment">//数据库的ip地址ַ</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//连接数据库，驱动+ip地址+端口号+用户名+密码，端口号默认是3306</span></span><br><span class="line">            connection = (Connection) DriverManager.getConnection(<span class="string">&quot;jdbc:mysql://&quot;</span> + ip + <span class="string">&quot;:3306/&quot;</span> + dbName,</span><br><span class="line">                    user, password);</span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        </span><br><span class="line">        &#125;</span><br><span class="line">        	<span class="comment">//返回一个connection对象</span></span><br><span class="line">        <span class="keyword">return</span> connection;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//这个是添加设备到数据库，不用看</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  <span class="keyword">void</span> <span class="title function_">bind_id</span><span class="params">(String app_id,String device_id)</span>&#123;</span><br><span class="line">    	</span><br><span class="line">             Connection connection=getConn(<span class="string">&quot;MQTTDATA&quot;</span>);</span><br><span class="line">        String sql=<span class="string">&quot;INSERT INTO user_bind_devices (app_id,device_id) VALUES (?,?)&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (connection!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                PreparedStatement ps=connection.prepareStatement(sql);</span><br><span class="line">                <span class="keyword">if</span> (ps!=<span class="literal">null</span>)&#123;</span><br><span class="line">                    ps.setString(<span class="number">1</span>,app_id);</span><br><span class="line">                    ps.setString(<span class="number">2</span>,device_id);</span><br><span class="line">                    <span class="comment">//执行语句,注意！！！如果你的SQL 语句是诸如update,insert的更新语句，应该用statement的execute()方法</span></span><br><span class="line">                    <span class="comment">// select用的是statement的executeQuery()</span></span><br><span class="line">                    ps.execute();</span><br><span class="line">                    </span><br><span class="line">                    connection.close();</span><br><span class="line">                    ps.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//这个是把数据保存到MQTTDATA库的 current表格</span></span><br><span class="line">    <span class="comment">//我需要插入app_id，device_id。。。。。。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(String app_id,String device_id,String remark,String time,String state,String device_type)</span> &#123;</span><br><span class="line">    	<span class="comment">//先跟MySQL数据库里的MQTTDATA库建立连接</span></span><br><span class="line">    	Connection connection=getConn(<span class="string">&quot;MQTTDATA&quot;</span>);</span><br><span class="line">    	<span class="comment">//定义一个语句，这个语句的功能是对current表格的app_id,device_id,remark,mytime,state,device_type列分别插入我们的参数的值</span></span><br><span class="line">    	<span class="comment">//这里的？可以看成一个傀儡，用ps.setString()方法可以将？替换成我们的参数的值</span></span><br><span class="line">    	String sql=<span class="string">&quot;INSERT INTO current (app_id,device_id,remark,mytime,state,device_type) VALUES (?,?,?,?,?,?)&quot;</span>;</span><br><span class="line">    	<span class="keyword">if</span>	(connection!=<span class="literal">null</span>) &#123;</span><br><span class="line">    		<span class="keyword">try</span> &#123;</span><br><span class="line">    			<span class="comment">//准备我们的mysql操作语句</span></span><br><span class="line">				PreparedStatement ps=connection.prepareStatement(sql);</span><br><span class="line">				<span class="comment">//把第一个？替换成参数里的app_id,第二个？替换成device_id........</span></span><br><span class="line">				<span class="keyword">if</span>(ps!=<span class="literal">null</span>) &#123;</span><br><span class="line">					ps.setString(<span class="number">1</span>, app_id);</span><br><span class="line">					ps.setString(<span class="number">2</span>, device_id);</span><br><span class="line">					ps.setString(<span class="number">3</span>, remark);</span><br><span class="line">					ps.setString(<span class="number">4</span>, time);</span><br><span class="line">					ps.setString(<span class="number">5</span>, state);</span><br><span class="line">					ps.setString(<span class="number">6</span>, device_type);</span><br><span class="line">					ps.execute();</span><br><span class="line">					connection.close();</span><br><span class="line">					ps.close();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>前面说了web.xml是web服务器的配置文件，这里我们需要在web.xml里对myhttpservlet进行配置</strong></p>
<p>在web.xml添加<servlet>内容如下: (这里需要注意一下，<servlet-name>app</servlet-name>，名称可以随便取，主要是为了程序员方便查找。)</p>
<p>&lt; servlet-class &gt;myweb.myhttpservlet&lt;&#x2F; servlet-class &gt; 前面是你的项目名称   .后面是我们刚刚写的myhttpservlet类。</p>
<p>&lt; servlet-mapping &gt;是把名称为app的httpservlet类映射到url的一个路径，<url-pattern>&#x2F;first</url-pattern>的意思就是当你在浏览器输入: </p>
<blockquote>
<p><strong>http:&#x2F;&#x2F;你的web服务器ip地址:端口号&#x2F;first   就会执行myhttpservlet类里的内容。</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;web-app xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> xmlns=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span> xsi:schemaLocation=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&quot;</span> id=<span class="string">&quot;WebApp_ID&quot;</span> version=<span class="string">&quot;3.1&quot;</span>&gt;</span><br><span class="line">  &lt;display-name&gt;myweb1&lt;/display-name&gt;</span><br><span class="line">  &lt;welcome-file-list&gt;</span><br><span class="line">    &lt;welcome-file&gt;index.html&lt;/welcome-file&gt;</span><br><span class="line">    &lt;welcome-file&gt;index.htm&lt;/welcome-file&gt;</span><br><span class="line">    &lt;welcome-file&gt;index.jsp&lt;/welcome-file&gt;</span><br><span class="line">    &lt;welcome-file&gt;<span class="keyword">default</span>.html&lt;/welcome-file&gt;</span><br><span class="line">    &lt;welcome-file&gt;<span class="keyword">default</span>.htm&lt;/welcome-file&gt;</span><br><span class="line">    &lt;welcome-file&gt;<span class="keyword">default</span>.jsp&lt;/welcome-file&gt;</span><br><span class="line">  &lt;/welcome-file-list&gt;</span><br><span class="line">  &lt;servlet&gt;</span><br><span class="line">        &lt;servlet-name&gt;app&lt;/servlet-name&gt;</span><br><span class="line">        &lt;servlet-class&gt;myweb.myhttpservlet&lt;/servlet-class&gt;</span><br><span class="line">&lt;/servlet&gt;</span><br><span class="line">	</span><br><span class="line">&lt;servlet-mapping&gt;</span><br><span class="line">        &lt;servlet-name&gt;app&lt;/servlet-name&gt;</span><br><span class="line">        &lt;url-pattern&gt;/first&lt;/url-pattern&gt;</span><br><span class="line">&lt;/servlet-mapping&gt;</span><br><span class="line">&lt;/web-app&gt;</span><br></pre></td></tr></table></figure>

<h2 id="三，部署web服务器到主机上"><a href="#三，部署web服务器到主机上" class="headerlink" title="三，部署web服务器到主机上"></a>三，部署web服务器到主机上</h2><p><strong>至此，我们一个简陋的web服务器差不多搭建好了，这时候我们就需要把web程序部署到主机的tomcat上。</strong></p>
<p>本地部署：右击项目，选择export &gt; war file browse保存到你想保存的位置，系统会生成一个.war文件，我们把这个文件放进 apache-tomcat-8.5.45(你的tomcat文件夹)下的webapps文件夹下。</p>
<p><strong>压缩文件已上传百度云，仅供参考</strong><br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1Klr_gDvmyFwwtqq3zUowww">https://pan.baidu.com/s/1Klr_gDvmyFwwtqq3zUowww</a><br>提取码：spf3 </p>
<p><strong>远程云主机部署：用xftp将war文件放入同样的路径下，然后重新启动tomcat。</strong></p>
<p>tomcat在运行时会自动解压war文件生成web程序并开始执行<br><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925223226631.png" alt="在这里插入图片描述"><br><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925223348324.png" alt="在这里插入图片描述"></p>
<h2 id="四，配置EMQX服务器"><a href="#四，配置EMQX服务器" class="headerlink" title="四，配置EMQX服务器"></a>四，配置EMQX服务器</h2><p><strong>配置的目的：让 EMQX 服务器post数据 给web服务器；</strong></p>
<h3 id="4-1-设置规则引擎"><a href="#4-1-设置规则引擎" class="headerlink" title="4.1 设置规则引擎"></a>4.1 设置规则引擎</h3><p><strong>登录emqx远程控制台，在规则引擎新建规则，规则引擎会对mqtt消息进行筛选，具体的筛选规则由我们来定义，下图是一些规则示例</strong><br><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925223940966.png" alt="在这里插入图片描述"><br>以下图的例子分析：</p>
<p><code>SELECT</code> 下方的语句含义是 ：<strong>在mqtt消息的数据段（payload）中提取出remark，app_id，device_id变量的值 复制 到本地的remark，app_id，device_id变量中。</strong></p>
<p><code>WHERE</code> 语句表示 从发往主题为<code>csdn</code>的mqtt消息中筛选。</p>
<p>随后我们用post把数据发送给web服务器时，数据的格式设置为<strong>json格式{“remark”:”杀手”,”app_id”:”37264726374”}</strong><br><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925224223760.png" alt="在这里插入图片描述"></p>
<h3 id="4-2-测试规则引擎"><a href="#4-2-测试规则引擎" class="headerlink" title="4.2 测试规则引擎"></a>4.2 测试规则引擎</h3><p>我们还可以进行在线测试，测试输出的json数据是不是我们需要的内容。</p>
<p><strong>下图配置mqtt消息：topic设置为csdn，payload字段设置变量及其取值。</strong><br><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925230352836.png" alt="在这里插入图片描述"></p>
<p><strong>点击测试，输出如图的json数据：</strong><br><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925230438153.png" alt="在这里插入图片描述"></p>
<h3 id="4-3-设置响应动作"><a href="#4-3-设置响应动作" class="headerlink" title="4.3 设置响应动作"></a>4.3 设置响应动作</h3><p><strong>当规则引擎筛选出指定的mqtt消息并提取出json数据后，还需要将数据post到我们的web服务器，这需要设置响应动作来完成这最后一步。</strong></p>
<blockquote>
<p>点击添加，动作选择发送数据到web服务,点击新建资源</p>
<p><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925230623970.png" alt="在这里插入图片描述"><br>在资源管理中设置 请求url 为web服务器地址，端口号（tomcat默认端口为8888，这里我改成8090），加上前面我们web.xml里设置的&#x2F;first ; http请求就会发送到我们的web程序。</p>
</blockquote>
<p><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925230844728.png" alt="在这里插入图片描述"><br>最后，我们需要进行测试，进入websocket，连接，发布消息到指定主题<br><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20190925231413679.png" alt="在这里插入图片描述"><br>然后到你的数据库查看是否存贮到数据。</p>
<p>有疑问的同学可以留言评论。<br><img src="/2025/05/30/hello-world/Web/EMQX_webhook_route_msg/20200614084955388.png" alt="在这里插入图片描述"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/06/01/killer-blog/Web/EMQX_webhook_route_msg/" data-id="cmbcy7rhe0022t8mt2pl89rzr" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-killer-blog/Web/Java_web_server_connect_mySQL" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/06/01/killer-blog/Web/Java_web_server_connect_mySQL/" class="article-date">
  <time class="dt-published" datetime="2025-06-01T00:24:26.649Z" itemprop="datePublished">2025-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>@[toc]</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>经过前面的环境部署，今天我们终于可以来连接数据库了。参考我之前的文章。这篇文章把前面两章连接起来，做一个小总结，并做一个可以保存用户登录数据的网站，代码主要解释对数据库的部分。</p>
</blockquote>
<p>   先前的开发环境安装：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44821644/article/details/104532635">centos7从零搭建java web服务器</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44821644/article/details/104870282">MySQL从零安装配置</a></p>
<h2 id="一，建立工程"><a href="#一，建立工程" class="headerlink" title="一，建立工程"></a>一，建立工程</h2><p>1，在eclipse新建动态web工程，具体过程已经有很多人写过了，我就简单说明一下。</p>
<blockquote>
<p><strong>打开eclipse-&gt;file-&gt;new-&gt;dynamic web subject</strong></p>
</blockquote>
<p>tomcat版本选你安装的版本，方便以后调试，web module 版本我用2.5，跟3.0差不多。3.0少了web.xml的配置文件等。一路next下去就行了<br><img src="/2025/05/30/hello-world/Web/Java_web_server_connect_mySQL/20200315221726831.png" alt="在这里插入图片描述"></p>
<h2 id="二，导入jar包"><a href="#二，导入jar包" class="headerlink" title="二，导入jar包"></a>二，导入jar包</h2><blockquote>
<p>连接MySQL需要导入MySQL相关的jar包，另外我还加入log包，对于开发非常有帮助，可以在控制台打印数据，方便debug。jar包就放下图示目录，另外还需要在项目右击-&gt;properties-&gt;java built path-&gt;libraries里添加我们刚刚添加的jar包，这样jar包才算真正导入；</p>
</blockquote>
<p><strong>jar包下载连接：</strong><br>链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/143RT1qygtKIimCRmLdpAbw">https://pan.baidu.com/s/143RT1qygtKIimCRmLdpAbw</a> 提取码: vd22</p>
<p><img src="/2025/05/30/hello-world/Web/Java_web_server_connect_mySQL/20200315222317751.png" alt="在这里插入图片描述"><br><strong>点击add jars 选择刚刚加入的jar包添加进去就行了</strong><br><img src="/2025/05/30/hello-world/Web/Java_web_server_connect_mySQL/20200315222633679.png" alt="在这里插入图片描述"><br>*</p>
<h2 id="三，编写DataBase类实现连接数据库与操作数据库"><a href="#三，编写DataBase类实现连接数据库与操作数据库" class="headerlink" title="三，编写DataBase类实现连接数据库与操作数据库"></a>三，编写DataBase类实现连接数据库与操作数据库</h2><blockquote>
<p>以下代码需要自己先了解SQL语句，MySQL基本命令。代码实现了连接数据库，对数据库的某表格进行添加，读取，更新操作。对应的应用是添加用户，读取用户登录信息，更新密码。</p>
</blockquote>
<p><strong>注意数据保存到MySQL数据库出现中文乱码的问题，要在前端，后台，连接串，MySQL都设置相同的编码方式，比如我选择的是utf8</strong><br>在MySQL命令中输入show variables like “%char%”;查看当前的编码，如图，都是utf8就没问题，需要修改的话可以<a target="_blank" rel="noopener" href="https://www.cnblogs.com/wsk312138147/p/9469285.html">查看修改办法</a><br><img src="/2025/05/30/hello-world/Web/Java_web_server_connect_mySQL/20200316135712311.png" alt="在这里插入图片描述"></p>
<p>DataBase.java代码，主要实现对数据库连接和增改查操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> myapp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mysql.jdbc.Connection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataBase</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> String driver=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>;<span class="comment">//MySQL驱动</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> <span class="string">&quot;prx&quot;</span>;<span class="comment">// MySQL的用户名和密码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;5812870-Prx&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">ip_adress</span> <span class="operator">=</span> <span class="string">&quot;192.168.x.x&quot;</span>;<span class="comment">//主机ip地址</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 说明：与数据库建立连接</span></span><br><span class="line"><span class="comment">     * 参数：数据库名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Connection <span class="title function_">getConn</span><span class="params">(String DatabaseName)</span> <span class="keyword">throws</span> SQLException</span><br><span class="line">    &#123;</span><br><span class="line">    	<span class="comment">//设置MySQL的连接串编码为UTF-8，避免中文乱码问题</span></span><br><span class="line">    	String url=<span class="string">&quot;jdbc:mysql://localhost:3306/&quot;</span>+DatabaseName+<span class="string">&quot;?characterEncoding=UTF-8&quot;</span>;</span><br><span class="line">    	System.out.println(<span class="string">&quot;the url is :&quot;</span>+url);</span><br><span class="line">    	Connection connection=<span class="literal">null</span>;</span><br><span class="line">    	<span class="keyword">try</span> &#123;</span><br><span class="line">			Class.forName(driver);<span class="comment">//加载MySQL驱动程序</span></span><br><span class="line">			<span class="comment">//连接数据库 驱动+ip地址+端口号+用户名+密码，端口号默认是3306</span></span><br><span class="line">			connection=(Connection) DriverManager.getConnection(<span class="string">&quot;jdbc:mysql://&quot;</span> + ip_adress + <span class="string">&quot;:3306/&quot;</span> + DatabaseName,</span><br><span class="line">                    user, password);</span><br><span class="line">			connection.setEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">			</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">			<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">    	<span class="comment">//返回connection对象</span></span><br><span class="line">		<span class="keyword">return</span> connection;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 添加新用户</span></span><br><span class="line"><span class="comment">     * String name,String sex,string age,String id,String password,String emailadress</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">adduser</span><span class="params">(String name,String sex,String age,String id,String password,String emailadress)</span> <span class="keyword">throws</span> SQLException</span><br><span class="line">    &#123;</span><br><span class="line">    	String Database=<span class="string">&quot;myapp&quot;</span>;</span><br><span class="line">    	String sql=<span class="string">&quot;INSERT INTO myapp_user (name,sex,age,id,password,emailadress) VALUES (?,?,?,?,?,?)&quot;</span>;</span><br><span class="line">    	Connection connection=getConn(Database);</span><br><span class="line">    	<span class="keyword">if</span> (connection!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                PreparedStatement ps=connection.prepareStatement(sql);</span><br><span class="line">                <span class="keyword">if</span> (ps!=<span class="literal">null</span>)&#123;</span><br><span class="line">                	</span><br><span class="line">                    ps.setString(<span class="number">1</span>,name);</span><br><span class="line">                    ps.setString(<span class="number">2</span>,sex);</span><br><span class="line">                    ps.setString(<span class="number">3</span>,age);</span><br><span class="line">                    ps.setString(<span class="number">4</span>,id);</span><br><span class="line">                    ps.setString(<span class="number">5</span>,password);</span><br><span class="line">                    ps.setString(<span class="number">6</span>,emailadress);</span><br><span class="line">                    <span class="comment">//执行语句,注意！！！如果你的SQL 语句是诸如update,insert的更新语句，应该用statement的execute()方法</span></span><br><span class="line">                    <span class="comment">// select用的是statement的executeQuery()</span></span><br><span class="line">                    ps.execute();</span><br><span class="line">                    </span><br><span class="line">                    connection.close();</span><br><span class="line">                    ps.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">updatepassword</span><span class="params">(String id,String newpassword)</span> <span class="keyword">throws</span> SQLException</span><br><span class="line">    &#123;</span><br><span class="line">    	String Database=<span class="string">&quot;myapp&quot;</span>;</span><br><span class="line">    	String sql=<span class="string">&quot;UPDATE myapp_user SET password=? where id=?&quot;</span>;</span><br><span class="line">    	Connection connection=getConn(Database);</span><br><span class="line">    	<span class="keyword">if</span> (connection!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                PreparedStatement ps=connection.prepareStatement(sql);</span><br><span class="line">                <span class="keyword">if</span> (ps!=<span class="literal">null</span>)&#123;</span><br><span class="line">                    ps.setString(<span class="number">1</span>,newpassword);</span><br><span class="line">                    ps.setString(<span class="number">2</span>,id);</span><br><span class="line">                  </span><br><span class="line">                    <span class="comment">//执行语句,注意！！！如果你的SQL 语句是诸如update,insert的更新语句，应该用statement的execute()方法</span></span><br><span class="line">                    <span class="comment">// select用的是statement的executeQuery()</span></span><br><span class="line">                    ps.execute();</span><br><span class="line">                    </span><br><span class="line">                    connection.close();</span><br><span class="line">                    ps.close();</span><br><span class="line">                	&#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 读取指定的值</span></span><br><span class="line"><span class="comment">     * 输入id 键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">sele_userinfo</span><span class="params">(String id,String key)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    	<span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    	String Database=<span class="string">&quot;myapp&quot;</span>;</span><br><span class="line">    	String sql=<span class="string">&quot;SELECT &quot;</span>+key+<span class="string">&quot; FROM myapp_user WHERE id=?&quot;</span>;</span><br><span class="line">    	</span><br><span class="line">    	Connection connection=getConn(Database);</span><br><span class="line">    	<span class="keyword">if</span> (connection!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                PreparedStatement ps=connection.prepareStatement(sql);</span><br><span class="line">                <span class="keyword">if</span> (ps!=<span class="literal">null</span>)&#123;</span><br><span class="line">                    ps.setString(<span class="number">1</span>,id);</span><br><span class="line">                    ResultSet rs=ps.executeQuery();</span><br><span class="line">                    <span class="keyword">if</span>(rs!=<span class="literal">null</span>) &#123;</span><br><span class="line">                    	<span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span>rs.getMetaData().getColumnCount();</span><br><span class="line">                        <span class="keyword">while</span>   (rs.next())&#123;</span><br><span class="line">                            <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span> ;i&lt;=count;i++)&#123;</span><br><span class="line">                                String field=rs.getMetaData().getColumnName(i);     </span><br><span class="line">                                    value=rs.getString(field);</span><br><span class="line">                                    System.out.println(<span class="string">&quot;the database value is:&quot;</span>+value); </span><br><span class="line">                            	&#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    </span><br><span class="line">                	&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 检查id&#x27;是否存在</span></span><br><span class="line"><span class="comment">     * 传入id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">hasId</span><span class="params">(String id)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    	String Database=<span class="string">&quot;myapp&quot;</span>;</span><br><span class="line">    	String value;</span><br><span class="line">    	String sql=<span class="string">&quot;select id from myapp_user&quot;</span>;</span><br><span class="line">    	 System.out.println(<span class="string">&quot;the input id is :&quot;</span>+id);</span><br><span class="line">    	Connection connection=getConn(Database);</span><br><span class="line">    	<span class="keyword">if</span> (connection!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                PreparedStatement ps=connection.prepareStatement(sql);</span><br><span class="line">                <span class="keyword">if</span> (ps!=<span class="literal">null</span>)&#123;</span><br><span class="line">                   </span><br><span class="line">                    ResultSet rs=ps.executeQuery();</span><br><span class="line">                    <span class="keyword">if</span>(rs!=<span class="literal">null</span>) &#123;</span><br><span class="line">                    	<span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span>rs.getMetaData().getColumnCount();</span><br><span class="line">                        <span class="keyword">while</span>   (rs.next())&#123;</span><br><span class="line">                            <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span> ;i&lt;=count;i++)&#123;</span><br><span class="line">                                String field=rs.getMetaData().getColumnName(i);     </span><br><span class="line">                                value=rs.getString(field);</span><br><span class="line">                                </span><br><span class="line">                                System.out.println(<span class="string">&quot;the database id is:&quot;</span>+value); </span><br><span class="line">                        </span><br><span class="line">                                <span class="keyword">if</span>(value.equals(id))</span><br><span class="line">                                &#123;                            </span><br><span class="line">                                	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                	 </span><br><span class="line">                            	&#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    </span><br><span class="line">                	&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                e.printStackTrace();               </span><br><span class="line">            &#125;   </span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="四，效果图"><a href="#四，效果图" class="headerlink" title="四，效果图"></a>四，效果图</h2><p>登录页面<br><img src="/2025/05/30/hello-world/Web/Java_web_server_connect_mySQL/20200315224129223.png" alt="登录页面"><br>注册<br><img src="/2025/05/30/hello-world/Web/Java_web_server_connect_mySQL/20200315224506599.png" alt="在这里插入图片描述"><br><img src="/2025/05/30/hello-world/Web/Java_web_server_connect_mySQL/20200316133829869.png" alt="在这里插入图片描述"><br>在终端查看数据库，数据保存成功<br><img src="/2025/05/30/hello-world/Web/Java_web_server_connect_mySQL/20200316134746480.png" alt="在这里插入图片描述"><br>登录成功！<br><img src="/2025/05/30/hello-world/Web/Java_web_server_connect_mySQL/20200316134831617.png" alt="在这里插入图片描述"><br><strong>整个工程文件下载：</strong><br><strong>链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1jq4LoetVdoksjjjGQeb4MA">https://pan.baidu.com/s/1jq4LoetVdoksjjjGQeb4MA</a> 提取码: 33xw 复制这段内容后打开百度网盘手机App，操作更方便哦</strong><br>2020.3.16</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35892775/article/details/83003283">Eclipse创建java Web项目工程</a><br><img src="/2025/05/30/hello-world/Web/Java_web_server_connect_mySQL/2020061408491195.png" alt="在这里插入图片描述"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/06/01/killer-blog/Web/Java_web_server_connect_mySQL/" data-id="cmbcy7rhf0023t8mtedov7txe" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-killer-blog/STM32/stm32_MS5611" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/06/01/killer-blog/STM32/stm32_MS5611/" class="article-date">
  <time class="dt-published" datetime="2025-06-01T00:24:26.648Z" itemprop="datePublished">2025-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>@[toc]</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><strong>这篇博客将介绍使用stm32的IIC库函数开发MS5611气压计，获取气压数据和温度数据，并对数据进行补偿。过程将结合芯片手册与代码。</strong><br>手册下载地址：<a target="_blank" rel="noopener" href="https://wws.lanzous.com/iZDAvf6joyd">https://wws.lanzous.com/iZDAvf6joyd</a><br>代码仓库地址：<a target="_blank" rel="noopener" href="https://gitee.com/killerp/MS5611">https://gitee.com/killerp/MS5611</a></p>
<h4 id="通信接口：IIC"><a href="#通信接口：IIC" class="headerlink" title="通信接口：IIC"></a>通信接口：IIC</h4><p>使用IIC接口进行数据读取。<br>当PS脚接高电平时，7和8引脚复用为IIC模式，否则为SPI模式；<br><img src="/2025/05/30/hello-world/STM32/stm32_MS5611/20200801003256676.png" alt="在这里插入图片描述">由上图，CSB接地，则CSB非就是1了。所以MS5611的地址就是0xEE;<br><img src="/2025/05/30/hello-world/STM32/stm32_MS5611/20200801003521916.png" alt="在这里插入图片描述"></p>
<h2 id="一，MS5611的5种命令"><a href="#一，MS5611的5种命令" class="headerlink" title="一，MS5611的5种命令"></a>一，MS5611的5种命令</h2><p>MS5611仅有5种基础命令：</p>
<h4 id="RESET-重启芯片"><a href="#RESET-重启芯片" class="headerlink" title="RESET : 重启芯片"></a>RESET : 重启芯片</h4><p>在读取PROM数据之前必须REST芯片，也就是在初始化的时候reset一下：<br>reset命令固定是0x1E;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 重启ms5611</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MS5611_Rest</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	I2C_WriteByte(I2C1,MS5611_SLAVE_ADDR,MS5611_CMD_REST);</span><br><span class="line">	delay_ms(<span class="number">4</span>);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="READ-PROM："><a href="#READ-PROM：" class="headerlink" title="READ PROM："></a>READ PROM：</h4><p><strong>读取PROM内存的数据，PROM存放8个16位数据，第一个16位数据包含工厂数据，第二到第七个数据用于补偿气压和温度。2-7的具体含义见图：</strong><br><img src="/2025/05/30/hello-world/STM32/stm32_MS5611/20200801001418430.png" alt="在这里插入图片描述"><strong>最后一个数据是CRC校验数据</strong></p>
<h4 id="D1-D2-CONVERSION"><a href="#D1-D2-CONVERSION" class="headerlink" title="D1,D2 CONVERSION"></a>D1,D2 CONVERSION</h4><p><strong>因为传感器获得的气压数据，温度数据是模拟量，需要进行模数转换。D1,D2分别对应气压和温度的模数转换精度。支持从256到4096的转换精度，精度越大，转换时间越长，具体对应关系见图：</strong><br><img src="/2025/05/30/hello-world/STM32/stm32_MS5611/20200801001750606.png" alt="在这里插入图片描述"></p>
<h4 id="READ-ADC-RESULT："><a href="#READ-ADC-RESULT：" class="headerlink" title="READ ADC RESULT："></a>READ ADC RESULT：</h4><p><strong>读取气压和温度模数转换后的数据，就是我们需要的数据。每次读取必须先进行模数转换后，延时一个转换时间后再发送此命令。</strong></p>
<h2 id="二，实现代码"><a href="#二，实现代码" class="headerlink" title="二，实现代码"></a>二，实现代码</h2><h4 id="1-初始化-："><a href="#1-初始化-：" class="headerlink" title="1 初始化 ："></a>1 初始化 ：</h4><p><strong>需要重启芯片，然后读取保存PROM内8个数据，等会补偿数据时会用到</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">*  读取prom的内容</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">MS5611_init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	ms5611_init();</span><br><span class="line">	Ms5611_Rest();</span><br><span class="line">	I2C_ReadBytes(I2C1,MS5611_SLAVE_ADDR,MS5611_PROM_READ_0,<span class="number">2</span>,(<span class="type">unsigned</span> <span class="type">char</span> *)(ms5611_handle-&gt;reserve),MSB);</span><br><span class="line">	I2C_ReadBytes(I2C1,MS5611_SLAVE_ADDR,MS5611_PROM_READ_1,<span class="number">2</span>,(<span class="type">unsigned</span> <span class="type">char</span> *)(ms5611_handle-&gt;C),MSB);</span><br><span class="line">	I2C_ReadBytes(I2C1,MS5611_SLAVE_ADDR,MS5611_PROM_READ_2,<span class="number">2</span>,(<span class="type">unsigned</span> <span class="type">char</span> *)((ms5611_handle-&gt;C)+<span class="number">1</span>),MSB);</span><br><span class="line">	I2C_ReadBytes(I2C1,MS5611_SLAVE_ADDR,MS5611_PROM_READ_3,<span class="number">2</span>,(<span class="type">unsigned</span> <span class="type">char</span> *)((ms5611_handle-&gt;C)+<span class="number">2</span>),MSB);</span><br><span class="line">	I2C_ReadBytes(I2C1,MS5611_SLAVE_ADDR,MS5611_PROM_READ_4,<span class="number">2</span>,(<span class="type">unsigned</span> <span class="type">char</span> *)((ms5611_handle-&gt;C)+<span class="number">3</span>),MSB);</span><br><span class="line">	I2C_ReadBytes(I2C1,MS5611_SLAVE_ADDR,MS5611_PROM_READ_5,<span class="number">2</span>,(<span class="type">unsigned</span> <span class="type">char</span> *)((ms5611_handle-&gt;C)+<span class="number">4</span>),MSB);</span><br><span class="line">	I2C_ReadBytes(I2C1,MS5611_SLAVE_ADDR,MS5611_PROM_READ_6,<span class="number">2</span>,(<span class="type">unsigned</span> <span class="type">char</span> *)((ms5611_handle-&gt;C)+<span class="number">5</span>),MSB);</span><br><span class="line">	I2C_ReadBytes(I2C1,MS5611_SLAVE_ADDR,MS5611_PROM_READ_7,<span class="number">2</span>,(<span class="type">unsigned</span> <span class="type">char</span> *)(ms5611_handle-&gt;CRC),MSB);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2，读取数据"><a href="#2，读取数据" class="headerlink" title="2，读取数据"></a>2，读取数据</h4><p><strong>以读取温度数据为例，先发送转换命令，等待转换时间，再去读取3个字节的温度数据</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 读取温度 转换精度4096</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">MS5611_read_temp</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	I2C_WriteByte(I2C1,MS5611_SLAVE_ADDR,MS5611_CMD_CONVERT_D2_4096);<span class="comment">//发送转换命令</span></span><br><span class="line">	delay_ms(<span class="number">9</span>);<span class="comment">//等待转换完成</span></span><br><span class="line">	I2C_ReadBytes(I2C1,MS5611_SLAVE_ADDR,MS6511_ADC_READ,<span class="number">3</span>,(<span class="type">unsigned</span> <span class="type">char</span> *)((ms5611_handle-&gt;D)+<span class="number">1</span>),MSB);<span class="comment">//读取三个字节的温度</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3，补偿温度数据"><a href="#3，补偿温度数据" class="headerlink" title="3，补偿温度数据"></a>3，补偿温度数据</h4><p>计算公式来自手册，主要是为了求出P（温度补偿压力）：<br><img src="/2025/05/30/hello-world/STM32/stm32_MS5611/20200801002538713.png" alt="在这里插入图片描述"><br><strong>当温度过低时，计算过程就多了T2,OFF2等步骤：</strong><br><img src="/2025/05/30/hello-world/STM32/stm32_MS5611/20200801002723755.png" alt="在这里插入图片描述"><br><strong>代码上基本跟着手册的公式来，这里不考虑温度低于-15°的情况</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 修正气压和温度</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">MS5611_calculate</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">signed</span> <span class="type">long</span> <span class="type">long</span> dT = <span class="number">0</span>,TEMP = <span class="number">0</span>,T2 = <span class="number">0</span>,OFF = <span class="number">0</span>,OFF2 = <span class="number">0</span>,SENS2 = <span class="number">0</span>,SENS = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	dT = ms5611_handle-&gt;D[<span class="number">1</span>] - ((<span class="type">signed</span> <span class="type">long</span> <span class="type">long</span>) (ms5611_handle-&gt;C[<span class="number">4</span>])&lt;&lt;<span class="number">8</span>);</span><br><span class="line">	TEMP = <span class="number">2000</span> + ((<span class="type">signed</span> <span class="type">long</span> <span class="type">long</span>) (dT*(ms5611_handle-&gt;C[<span class="number">5</span>]))&gt;&gt;<span class="number">23</span>);</span><br><span class="line">	<span class="comment">//低于20°时：</span></span><br><span class="line">	<span class="keyword">if</span>(TEMP &lt; <span class="number">2000</span> &amp;&amp; TEMP &gt; <span class="number">-1500</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		T2 = ( dT*dT )&gt;&gt;<span class="number">31</span>;</span><br><span class="line">		OFF2 = <span class="number">5</span> * (TEMP - <span class="number">2000</span>) * (TEMP - <span class="number">2000</span>) / <span class="number">2</span>;</span><br><span class="line">		SENS2 = <span class="number">5</span> * (TEMP - <span class="number">2000</span>) * (TEMP - <span class="number">2000</span>) / <span class="number">4</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	OFF = (((<span class="type">int64_t</span>)(ms5611_handle-&gt;C[<span class="number">1</span>])) &lt;&lt; <span class="number">16</span>) + (((ms5611_handle-&gt;C[<span class="number">3</span>]) * dT) &gt;&gt; <span class="number">7</span>);</span><br><span class="line">	SENS = (((<span class="type">int64_t</span>)(ms5611_handle-&gt;C[<span class="number">0</span>])) &lt;&lt; <span class="number">15</span>) + (((ms5611_handle-&gt;C[<span class="number">2</span>]) * dT) &gt;&gt; <span class="number">8</span>);</span><br><span class="line">	</span><br><span class="line">	ms5611_handle-&gt;dT = dT;</span><br><span class="line">	ms5611_handle-&gt;OFF -= OFF2;</span><br><span class="line">	ms5611_handle-&gt;TEMP -= T2;</span><br><span class="line">	ms5611_handle-&gt;SENS -= SENS2;</span><br><span class="line">	ms5611_handle-&gt;P = ((((ms5611_handle-&gt;D[<span class="number">0</span>]) * (ms5611_handle-&gt;SENS))&gt;&gt;<span class="number">21</span>) - (ms5611_handle-&gt;OFF))&gt;&gt;<span class="number">15</span>;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/06/01/killer-blog/STM32/stm32_MS5611/" data-id="cmbcy7rha001mt8mta0ejanyy" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-killer-blog/STM32/stm32_MPU6050_Mahony" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/06/01/killer-blog/STM32/stm32_MPU6050_Mahony/" class="article-date">
  <time class="dt-published" datetime="2025-06-01T00:24:26.648Z" itemprop="datePublished">2025-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>@[toc]<br><strong>项目地址</strong>：<a target="_blank" rel="noopener" href="https://gitee.com/killerp/mpu6050_-mahony">https://gitee.com/killerp/mpu6050_-mahony</a></p>
<h2 id="1，理论分析"><a href="#1，理论分析" class="headerlink" title="1，理论分析"></a>1，理论分析</h2><h3 id="1-1-MPU6050"><a href="#1-1-MPU6050" class="headerlink" title="1.1 MPU6050"></a>1.1 MPU6050</h3><p>MPU6050是一个集成了陀螺仪和加速度计的传感器，它能输出在直角坐标系下的x，y，z轴的角速度和加速度数据。</p>
<p>陀螺仪输出的格式为：绕x轴的旋转角速度，绕y轴的角速度，绕z轴的角速度（分别称为roll角速度，pitch角速度和yaw角速度）。</p>
<p>加速度计输出的格式为：x轴的加速度，y轴的加速度，z轴的加速度。</p>
<p>另外还需要关注传感器的其他参数如：</p>
<ul>
<li>陀螺仪的量程：eg.+-2000dps</li>
<li>加速度计的量程：eg.2g</li>
<li>adc转换精度为16bit</li>
<li>传感器采样率4-1000hz：eg.1000hz</li>
</ul>
<p>我们从MPU6050那就得到了陀螺仪数据gx,gy,gz，加速度数据az,ay,az</p>
<p>螺仪转换精度<strong>2^16&#x3D;65536,65536&#x2F;{2000-(-2000)}&#x3D;16.4,实际1°等于adc值16.4</strong></p>
<p>采样率就是数据的更新率，也就是我们每次读取数据的频率。</p>
<h3 id="1-2-Mahony算法原理"><a href="#1-2-Mahony算法原理" class="headerlink" title="1.2 Mahony算法原理"></a>1.2 Mahony算法原理</h3><p>参考另一篇文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44821644/article/details/108542178">基于Manony滤波算法的姿态解算</a></p>
<h2 id="2，代码实现"><a href="#2，代码实现" class="headerlink" title="2，代码实现"></a>2，代码实现</h2><h3 id="1-1-MPU6050初始化及数据读取"><a href="#1-1-MPU6050初始化及数据读取" class="headerlink" title="1.1 MPU6050初始化及数据读取"></a>1.1 MPU6050初始化及数据读取</h3><p><strong>该部分代码参考了正点原子的MPU6050例程；主要修改以下初始化代码</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* MPU6050模块:绕x轴为roll，绕y轴为pitch，绕z轴为yaw</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">MPU_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123; </span><br><span class="line">	<span class="type">uint8_t</span> res;</span><br><span class="line">	IIC_Init();	<span class="comment">//初始化IIC总线</span></span><br><span class="line">	MPU_Write_Byte(MPU_PWR_MGMT1_REG,<span class="number">0X80</span>);	<span class="comment">//复位MPU6050	</span></span><br><span class="line">	<span class="comment">//等待复位完成</span></span><br><span class="line">  	delay_ms(<span class="number">100</span>);</span><br><span class="line">	MPU_Write_Byte(MPU_PWR_MGMT1_REG,<span class="number">0X00</span>);	<span class="comment">//唤醒MPU6050</span></span><br><span class="line">	MPU_Set_Gyro_Fsr(<span class="number">3</span>);	<span class="comment">//陀螺仪量程+-2000		</span></span><br><span class="line">	MPU_Set_Accel_Fsr(<span class="number">0</span>);	<span class="comment">//加速度计量程+-2g				</span></span><br><span class="line">	MPU_Set_Rate(<span class="number">1000</span>);		<span class="comment">//1khz采样率				</span></span><br><span class="line">	MPU_Write_Byte(MPU_INT_EN_REG,<span class="number">0X00</span>);	<span class="comment">//关闭中断</span></span><br><span class="line">	MPU_Write_Byte(MPU_USER_CTRL_REG,<span class="number">0X00</span>);	<span class="comment">//关闭IIC主模式</span></span><br><span class="line">	MPU_Write_Byte(MPU_FIFO_EN_REG,<span class="number">0X00</span>);	<span class="comment">//关闭FIFO</span></span><br><span class="line">	MPU_Write_Byte(MPU_INTBP_CFG_REG,<span class="number">0X80</span>);	<span class="comment">//关闭INT</span></span><br><span class="line">	res=MPU_Read_Byte(MPU_DEVICE_ID_REG);	<span class="comment">//读取设备id，AD0引脚接地 故id应该为0x68</span></span><br><span class="line">	<span class="keyword">if</span>(res==MPU_ADDR)</span><br><span class="line">	&#123;</span><br><span class="line">		MPU_Write_Byte(MPU_PWR_MGMT1_REG,<span class="number">0X01</span>);	<span class="comment">//设置x轴为时钟</span></span><br><span class="line">		MPU_Write_Byte(MPU_PWR_MGMT2_REG,<span class="number">0X00</span>);	<span class="comment">//开启陀螺仪加速度计</span></span><br><span class="line">		MPU_Set_Rate(<span class="number">1000</span>);						</span><br><span class="line"> 	&#125;<span class="keyword">else</span> <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>重新编写一个读取mpu6050数据的函数。使我们读取的数据是经过平均滤波的数据。</strong></p>
<p>使用6个FIFO队列对数据(gx,gy,gz,ax,ay,az)进行缓存，每次读取一次数据，就将数据入队，并计算队列的平均值，对原始数据进行平滑滤波。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> Buf_SIZE  10	<span class="comment">//队列长度，越大，平滑性越高</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int16_t</span>  MPU6500_FIFO[<span class="number">6</span>][Buf_SIZE];	<span class="comment">//6个FIFO队列；0-2：陀螺仪数据；3-5：加速度计数据	</span></span><br><span class="line"></span><br><span class="line"><span class="type">int16_t</span> lastAx,lastAy,lastAz,lastGx,lastGy,lastGz;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> Wr_Index = <span class="number">0</span>;	<span class="comment">//当前FIFO的写入下标</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//将val入队</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">MPU6500_NewVal</span><span class="params">(<span class="type">int16_t</span>* buf,<span class="type">int16_t</span> val)</span> &#123;</span><br><span class="line">  	buf[Wr_Index] = val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//计算FIFO中的平均值</span></span><br><span class="line"><span class="type">static</span> <span class="type">int16_t</span> <span class="title function_">MPU6500_GetAvg</span><span class="params">(<span class="type">int16_t</span>* buf)</span></span><br><span class="line">&#123;</span><br><span class="line">  	<span class="type">int</span> i;</span><br><span class="line">	<span class="type">int32_t</span>	sum = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;Buf_SIZE;i++)</span><br><span class="line">		sum += buf[i];</span><br><span class="line">	sum = sum / Buf_SIZE;</span><br><span class="line">	<span class="keyword">return</span> (<span class="type">int16_t</span>)sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取经过滤波的陀螺仪，加速度数据</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MPU6500_readGyro_Acc</span><span class="params">(<span class="type">int16_t</span> *gyro,<span class="type">int16_t</span> *acc)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">static</span> <span class="type">short</span> buf[<span class="number">6</span>];	<span class="comment">//缓存原始数据：0-2：陀螺仪数据；3-5：加速度计数据	</span></span><br><span class="line">	<span class="type">static</span> <span class="type">int16_t</span> gx,gy,gz;</span><br><span class="line">	<span class="type">static</span> <span class="type">int16_t</span> ax,ay,az;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//正点原子的库函数，读取传感器原始数据</span></span><br><span class="line">	MPU_Get_Gyroscope(&amp;buf[<span class="number">0</span>],&amp;buf[<span class="number">1</span>],&amp;buf[<span class="number">2</span>]);	</span><br><span class="line">	MPU_Get_Accelerometer(&amp;buf[<span class="number">3</span>],&amp;buf[<span class="number">4</span>],&amp;buf[<span class="number">5</span>]);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//将原始数据入队</span></span><br><span class="line">	MPU6500_NewVal(&amp;MPU6500_FIFO[<span class="number">0</span>][<span class="number">0</span>],buf[<span class="number">0</span>]);</span><br><span class="line">	MPU6500_NewVal(&amp;MPU6500_FIFO[<span class="number">1</span>][<span class="number">0</span>],buf[<span class="number">1</span>]);</span><br><span class="line">	MPU6500_NewVal(&amp;MPU6500_FIFO[<span class="number">2</span>][<span class="number">0</span>],buf[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">	MPU6500_NewVal(&amp;MPU6500_FIFO[<span class="number">3</span>][<span class="number">0</span>],buf[<span class="number">3</span>]);</span><br><span class="line">	MPU6500_NewVal(&amp;MPU6500_FIFO[<span class="number">4</span>][<span class="number">0</span>],buf[<span class="number">4</span>]);</span><br><span class="line">	MPU6500_NewVal(&amp;MPU6500_FIFO[<span class="number">5</span>][<span class="number">0</span>],buf[<span class="number">5</span>]);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//更新FIFO入口指针</span></span><br><span class="line">	Wr_Index = (Wr_Index + <span class="number">1</span>) % Buf_SIZE;	</span><br><span class="line"></span><br><span class="line">	<span class="comment">//计算队列平均值</span></span><br><span class="line">	gx =  MPU6500_GetAvg(&amp;MPU6500_FIFO[<span class="number">4</span>][<span class="number">0</span>]);</span><br><span class="line">	gy =  MPU6500_GetAvg(&amp;MPU6500_FIFO[<span class="number">5</span>][<span class="number">0</span>]);</span><br><span class="line">	gz =  MPU6500_GetAvg(&amp;MPU6500_FIFO[<span class="number">6</span>][<span class="number">0</span>]);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//陀螺仪数据要减去偏移量</span></span><br><span class="line">	gyro[<span class="number">0</span>] = gx - imu.Roll_offset;	<span class="comment">//gyro</span></span><br><span class="line">	gyro[<span class="number">1</span>] = gy - imu.Pitch_offset;</span><br><span class="line">	gyro[<span class="number">2</span>] = gz - imu.Yaw_offset;</span><br><span class="line">		</span><br><span class="line"></span><br><span class="line">	ax = 	MPU6500_GetAvg(&amp;MPU6500_FIFO[<span class="number">0</span>][<span class="number">0</span>]);</span><br><span class="line">	ay = 	MPU6500_GetAvg(&amp;MPU6500_FIFO[<span class="number">1</span>][<span class="number">0</span>]);</span><br><span class="line">	az = 	MPU6500_GetAvg(&amp;MPU6500_FIFO[<span class="number">2</span>][<span class="number">0</span>]);</span><br><span class="line">				</span><br><span class="line">	acc[<span class="number">0</span>] = ax; <span class="comment">//acc</span></span><br><span class="line">	acc[<span class="number">1</span>] = ay;</span><br><span class="line">	acc[<span class="number">2</span>] = az;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-Mahony算法c语言实现"><a href="#1-2-Mahony算法c语言实现" class="headerlink" title="1.2 Mahony算法c语言实现"></a>1.2 Mahony算法c语言实现</h3><p>首先将陀螺仪的数据转换成角度，这里封装成一个函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//读取经过滤波的角速度，加速度</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_IMU_Values</span><span class="params">(<span class="type">float</span> *values)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int16_t</span> gyro[<span class="number">3</span>],acc[<span class="number">3</span>];</span><br><span class="line">	</span><br><span class="line">	MPU6500_readGyro_Acc(&amp;gyro[<span class="number">0</span>],&amp;acc[<span class="number">0</span>]);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		values[i]=((<span class="type">float</span>) gyro[i])/<span class="number">16.4f</span>;	<span class="comment">//这里结合理论分析思考</span></span><br><span class="line">		</span><br><span class="line">		values[<span class="number">3</span>+i]=(<span class="type">float</span>) acc[i];</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>然后编写函数实现计算姿态角的功能，使用四元数计算姿态角的公式在理论分析中推导：</strong></p>
<p><strong>其中α为绕x轴旋转角即roll，β为绕y轴旋转角即pitch，γ为绕z轴旋转角即yaw。a,b,c,d即q0,q1,q2,q3.</strong></p>
<p><img src="/2025/05/30/hello-world/STM32/stm32_MPU6050_Mahony/20210516164833222.png" alt="在这里插入图片描述"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//arcsin函数</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">safe_asin</span><span class="params">(<span class="type">float</span> v)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (isnan(v)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0.0f</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (v &gt;= <span class="number">1.0f</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> PI/<span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (v &lt;= <span class="number">-1.0f</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> -PI/<span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">asin</span>(v);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//周期性的更新姿态角。</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_angle</span><span class="params">(<span class="type">void</span> )</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">static</span> <span class="type">float</span> q[<span class="number">4</span>];	<span class="comment">//四元数</span></span><br><span class="line">	<span class="type">float</span> getValue[<span class="number">6</span>];	<span class="comment">//缓存读取的传感器数据</span></span><br><span class="line">	get_IMU_Values(getValue);	<span class="comment">//读取滤波后的传感器数据	</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//Mahony算法更新四元数</span></span><br><span class="line">	MahonyAHRSupdateIMU(getValue[<span class="number">0</span>] * PI/<span class="number">180</span>, getValue[<span class="number">1</span>] * PI/<span class="number">180</span>, getValue[<span class="number">2</span>] * PI/<span class="number">180</span>, getValue[<span class="number">3</span>], getValue[<span class="number">4</span>], getValue[<span class="number">5</span>]);			</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//到此，用读取的数据更新了 q0,q1,q2,q3是定义在Mahony.c的全局变量，保存当前四元数的值</span></span><br><span class="line">	q[<span class="number">0</span>] = q0;</span><br><span class="line">	q[<span class="number">1</span>] = q1;</span><br><span class="line">	q[<span class="number">2</span>] = q2;</span><br><span class="line">	q[<span class="number">3</span>] = q3;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//更新全局变量IMU的属性</span></span><br><span class="line">	imu.ax = getValue[<span class="number">3</span>];</span><br><span class="line">	imu.ay = getValue[<span class="number">4</span>];</span><br><span class="line">	imu.az = getValue[<span class="number">5</span>];</span><br><span class="line"></span><br><span class="line">	imu.Pitch_v = getValue[<span class="number">0</span>];</span><br><span class="line">	imu.Roll_v = getValue[<span class="number">1</span>];</span><br><span class="line">	imu.Yaw_v = getValue[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">	<span class="comment">//通过四元数计算当前姿态角</span></span><br><span class="line">	imu.Roll = (<span class="built_in">atan2</span>(<span class="number">2.0f</span>*(q[<span class="number">0</span>]*q[<span class="number">1</span>] + q[<span class="number">2</span>]*q[<span class="number">3</span>]),<span class="number">1</span> - <span class="number">2.0f</span>*(q[<span class="number">1</span>]*q[<span class="number">1</span>] + q[<span class="number">2</span>]*q[<span class="number">2</span>])))* <span class="number">180</span>/PI;	</span><br><span class="line">	imu.Pitch = -safe_asin(<span class="number">2.0f</span>*(q[<span class="number">0</span>]*q[<span class="number">2</span>] - q[<span class="number">1</span>]*q[<span class="number">3</span>]))* <span class="number">180</span>/PI;</span><br><span class="line">	imu.Yaw = -<span class="built_in">atan2</span>(<span class="number">2</span> * q1 * q2 + <span class="number">2</span> * q0 * q3, <span class="number">-2</span> * q2*q2 - <span class="number">2</span> * q3 * q3 + <span class="number">1</span>)* <span class="number">180</span>/PI; <span class="comment">// yaw</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>代码中MahonyAHRSupdateIMU()函数实现的就是四元数的更新算法。</strong></p>
<p><em>逻辑上，首先用加速度计校准陀螺仪，方式是通过计算当前四元数姿态下的重力分量，与加速度计的重力分量作叉积，得到误差。<br>对误差作P(比例)和I(积分)运算后加到陀螺仪角速度上。最终由角速度计算新的四元数。</em></p>
<p><strong>使用到的公式有：</strong></p>
<p><strong>四元数重力分量计算：</strong></p>
<p>四元数旋转矩阵的转置表示：从地理坐标系转换到机体坐标系的旋转。重力向量设为[0,0,1]，与四元数旋转矩阵的转置矩阵相乘，表示机体坐标系下的重力分量。</p>
<p><img src="/2025/05/30/hello-world/STM32/stm32_MPU6050_Mahony/20210517203510626.jpg" alt="在这里插入图片描述"></p>
<p>所以由四元数得到的机体坐标系下的重力向量为：<br><img src="/2025/05/30/hello-world/STM32/stm32_MPU6050_Mahony/20210516234611509.jpg" alt="在这里插入图片描述"><br><strong>由于加速度计测的是在机体坐标系下的重力向量，故将两个向量作叉积，即可得到他们之间的误差。</strong></p>
<p><img src="/2025/05/30/hello-world/STM32/stm32_MPU6050_Mahony/2021051623534746.jpg" alt="在这里插入图片描述"></p>
<p><strong>四元数更新方程：</strong></p>
<p><img src="/2025/05/30/hello-world/STM32/stm32_MPU6050_Mahony/2021051618002479.jpg" alt="在这里插入图片描述"></p>
<p><strong>代码中的 sampleFreq 即执行姿态解算的频率，这里用定时器，以500HZ的频率调用get_angle();</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">MahonyAHRSupdateIMU</span><span class="params">(<span class="type">float</span> gx, <span class="type">float</span> gy, <span class="type">float</span> gz, <span class="type">float</span> ax, <span class="type">float</span> ay, <span class="type">float</span> az)</span> &#123;</span><br><span class="line">	<span class="type">float</span> recipNorm;	</span><br><span class="line">	<span class="type">float</span> halfvx, halfvy, halfvz;	<span class="comment">//1/2 重力分量</span></span><br><span class="line">	<span class="type">float</span> halfex, halfey, halfez;	<span class="comment">//1/2 重力误差</span></span><br><span class="line">	<span class="type">float</span> qa, qb, qc;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//加速度数据有效时才进行校准</span></span><br><span class="line">	<span class="keyword">if</span>(!((ax == <span class="number">0.0f</span>) &amp;&amp; (ay == <span class="number">0.0f</span>) &amp;&amp; (az == <span class="number">0.0f</span>))) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//对加速度数据归一化</span></span><br><span class="line">		recipNorm = invSqrt(ax * ax + ay * ay + az * az);</span><br><span class="line">		ax *= recipNorm;</span><br><span class="line">		ay *= recipNorm;</span><br><span class="line">		az *= recipNorm;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 由四元数计算重力分量</span></span><br><span class="line">		halfvx = q1 * q3 - q0 * q2;</span><br><span class="line">		halfvy = q0 * q1 + q2 * q3;</span><br><span class="line">		halfvz = q0 * q0 - <span class="number">0.5f</span> + q3 * q3;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 将四元数重力分量 与 加速度计重力分量 作叉积 得到误差</span></span><br><span class="line">		halfex = (ay * halfvz - az * halfvy);</span><br><span class="line">		halfey = (az * halfvx - ax * halfvz);</span><br><span class="line">		halfez = (ax * halfvy - ay * halfvx);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 使用积分？</span></span><br><span class="line">		<span class="keyword">if</span>(twoKi &gt; <span class="number">0.0f</span>) &#123;</span><br><span class="line">			<span class="comment">//对误差作积分</span></span><br><span class="line">			integralFBx += twoKi * halfex * (<span class="number">1.0f</span> / sampleFreq);	<span class="comment">// integral error scaled by Ki</span></span><br><span class="line">			integralFBy += twoKi * halfey * (<span class="number">1.0f</span> / sampleFreq);</span><br><span class="line">			integralFBz += twoKi * halfez * (<span class="number">1.0f</span> / sampleFreq);</span><br><span class="line">			<span class="comment">//反馈到角速度</span></span><br><span class="line">			gx += integralFBx;	<span class="comment">// apply integral feedback</span></span><br><span class="line">			gy += integralFBy;</span><br><span class="line">			gz += integralFBz;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			integralFBx = <span class="number">0.0f</span>;	<span class="comment">// prevent integral windup</span></span><br><span class="line">			integralFBy = <span class="number">0.0f</span>;</span><br><span class="line">			integralFBz = <span class="number">0.0f</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 对误差作比例运算并反馈</span></span><br><span class="line">		gx += twoKp * halfex;</span><br><span class="line">		gy += twoKp * halfey;</span><br><span class="line">		gz += twoKp * halfez;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 计算1/2 dt</span></span><br><span class="line">	gx *= (<span class="number">0.5f</span> * (<span class="number">1.0f</span> / sampleFreq));		<span class="comment">// pre-multiply common factors</span></span><br><span class="line">	gy *= (<span class="number">0.5f</span> * (<span class="number">1.0f</span> / sampleFreq));</span><br><span class="line">	gz *= (<span class="number">0.5f</span> * (<span class="number">1.0f</span> / sampleFreq));</span><br><span class="line">	qa = q0;</span><br><span class="line">	qb = q1;</span><br><span class="line">	qc = q2;</span><br><span class="line">	<span class="comment">// 更新四元数</span></span><br><span class="line">	q0 += (-qb * gx - qc * gy - q3 * gz);</span><br><span class="line">	q1 += (qa * gx + qc * gz - q3 * gy);</span><br><span class="line">	q2 += (qa * gy - qb * gz + q3 * gx);</span><br><span class="line">	q3 += (qa * gz + qb * gy - qc * gx);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 四元数归一化</span></span><br><span class="line">	recipNorm = invSqrt(q0 * q0 + q1 * q1 + q2 * q2 + q3 * q3);</span><br><span class="line">	q0 *= recipNorm;</span><br><span class="line">	q1 *= recipNorm;</span><br><span class="line">	q2 *= recipNorm;</span><br><span class="line">	q3 *= recipNorm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h3 id="1-3-将代码移植到你的工程"><a href="#1-3-将代码移植到你的工程" class="headerlink" title="1.3 将代码移植到你的工程"></a>1.3 将代码移植到你的工程</h3><p>项目地址：<a target="_blank" rel="noopener" href="https://gitee.com/killerp/mpu6050_-mahony">https://gitee.com/killerp/mpu6050_-mahony</a></p>
<p><strong>若是使用stm32的软件iic，则需要在myiic.h中修改IO引脚。</strong></p>
<p><strong>若使用其他的芯片，则需要完成myiic.h中所有函数及延时函数的实现。</strong></p>
<p><strong>注意修改Mahony.h中的sampleFreq为定时器回调函数执行的频率。</strong></p>
<h2 id="3，补充"><a href="#3，补充" class="headerlink" title="3，补充"></a>3，补充</h2><p><strong>由于加速度计对水平方向的旋转无能为力，故用此程序得到的yaw角数据会一直漂移，无法得到校准；通常的解决方法是增加一个磁场传感器，来获得一个准确的水平方向角来校准陀螺仪的漂移。MPU6050支持扩展一个IIC接口到磁场传感器，可通过配置MPU6050的IIC MASTER 来读取磁场传感器的数据。</strong></p>
<p>在Mahony中提供了包含磁场数据的融合函数：</p>
<blockquote>
<p>void MahonyAHRSupdate(float gx, float gy, float gz, float ax, float ay, float az, float mx, float my, float mz);</p>
</blockquote>
<p><img src="/2025/05/30/hello-world/STM32/stm32_MPU6050_Mahony/20210516235902902.png" alt="在这里插入图片描述"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/06/01/killer-blog/STM32/stm32_MPU6050_Mahony/" data-id="cmbcy7rha001nt8mthl9pbcya" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-killer-blog/STM32/Stabilizer" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/06/01/killer-blog/STM32/Stabilizer/" class="article-date">
  <time class="dt-published" datetime="2025-06-01T00:24:26.647Z" itemprop="datePublished">2025-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="二轴自稳云台"><a href="#二轴自稳云台" class="headerlink" title="二轴自稳云台"></a>二轴自稳云台</h2><p>项目地址：<a target="_blank" rel="noopener" href="https://gitee.com/killerp/yuntai">https://gitee.com/killerp/yuntai</a></p>
<h3 id="项目演示"><a href="#项目演示" class="headerlink" title="项目演示"></a>项目演示</h3><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1FA411V7a8/">基于stm32舵机云台_哔哩哔哩_bilibili</a></p>
<h3 id="整体框架"><a href="#整体框架" class="headerlink" title="整体框架"></a>整体框架</h3><p>如图是整个项目的整体框架，理解该工程可以从两个数据流入手，如图所示的绿色，红色直线，分别表示测量姿态值，目标姿态值的传递。</p>
<p>下面以这两直线为线索介绍该系统。</p>
<p>涉及硬件：</p>
<ul>
<li>STM32f106：串口、iic、定时器</li>
<li>MPU6050</li>
<li>HC06</li>
<li>舵机：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1105877">机器人基础：舵机及转向控制原理 - 云+社区 - 腾讯云 (tencent.com)</a></li>
</ul>
<p><img src="/2025/05/30/hello-world/STM32/Stabilizer/yuntai-1645630489915.png" alt="yuntai"></p>
<h3 id="测量姿态值"><a href="#测量姿态值" class="headerlink" title="测量姿态值"></a>测量姿态值</h3><h4 id="MPU6050"><a href="#MPU6050" class="headerlink" title="MPU6050"></a>MPU6050</h4><p>测量姿态的产生源是来自于MPU6050惯性传感器，该传感器的输出包括：三轴角速度、三轴加速度。</p>
<p>这6个数据在TIM2的中断回调函数中被读取，并使用Mahony滤波算法，姿态解算算法对其进行计算，最终得到较为符合真实情况的三个姿态角。</p>
<p>该部分内容可参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44821644/article/details/116893943">stm32 MPU6050 姿态解算 Mahony互补滤波算法_杀手的博客-CSDN博客</a></p>
<p>姿态角数据再输出到autoControl_task，作为其输入变量。</p>
<h4 id="数据上报"><a href="#数据上报" class="headerlink" title="数据上报"></a>数据上报</h4><p>经过计算得到的姿态角度数据，可通过 ble_report_task 任务的打包，通过串口发送给HC06蓝牙模块，蓝牙模块再把数据传输到手机app中，由app进行数据解析。</p>
<p>app的使用可参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44821644/article/details/116948460">蓝牙调试器 接收处理 hc-05蓝牙上传数据_杀手的博客-CSDN博客</a></p>
<h3 id="控制数据"><a href="#控制数据" class="headerlink" title="控制数据"></a>控制数据</h3><p>控制数据包括：系统运行模式，目标姿态值等。其产生的源头是手机app，如何使用app由上一节说明。</p>
<p>控制数据在app中被打包，经过蓝牙模块，到达uart1，触发串口接收中断，在中断中对数据进行解析。当order_task 得到执行时，会切换系统运行模式，并会将期望目标姿态角度传递给 autoControl_task 。</p>
<h3 id="PID控制算法"><a href="#PID控制算法" class="headerlink" title="PID控制算法"></a>PID控制算法</h3><p>在开启了自稳模式后，自稳控制算法就会生效，具体的实现就是在 autoControl_task 函数中。该函数接收了测量的姿态值，目标姿态角度，这个算法的目标就是减少 测量的姿态角度 与 目标姿态角度 的误差。</p>
<p>为了达到该效果，他将两个输入经过PID运算器处理，计算得到一个舵机应该转动到的角度，并将该角度换算成对应的pwm占空比，输出到舵机。</p>
<p>其中pwm信号由定时器产生。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/06/01/killer-blog/STM32/Stabilizer/" data-id="cmbcy7rh9001lt8mt94uedeu6" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/5/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">June 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">May 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/pwm/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/uart/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/worklife/2025%E6%B1%82%E8%81%8C%E5%87%86%E5%A4%87/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/other/tools/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/06/01/killer-blog/sifive/i2c_LSM303AGR/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>